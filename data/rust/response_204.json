[{"tags": ["generics", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1544058618, "post_id": 53642333, "comment_id": 94145546, "body": "You are attempting to lie to the compiler. <code>create&lt;S&gt;()</code> means that the caller of <code>create</code> can pick whatever concrete type for <code>S</code> that they&#39;d like, but your function is only capable of returning a specific concrete type."}, {"owner": {"reputation": 11, "user_id": 3939588, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fe93fd385c660afa2637f4172e71f7f9?s=128&d=identicon&r=PG", "display_name": "knutaf", "link": "https://stackoverflow.com/users/3939588/knutaf"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1544067958, "post_id": 53642333, "comment_id": 94147548, "body": "Thank you, your explanation makes sense to me. I tried searching for this but somehow didn&#39;t find any of the things you linked. I was &quot;abusing&quot; generics to avoid writing an ugly-looking type (like <code>std::iter::Cycle&lt;std::slice::Iter&lt;&#39;v, i32&gt;&gt;</code>). Are there shortcuts to avoid having to actually type that out? I haven&#39;t found any so far."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1544069125, "post_id": 53642333, "comment_id": 94147811, "body": "That&#39;s what the latter two duplicates are pointing you to, especially <a href=\"https://stackoverflow.com/questions/27535289/what-is-the-correct-way-to-return-an-iterator-or-any-other-trait\">What is the correct way to return an Iterator (or any other trait)</a>. TL;DR: <code>-&gt; impl Iterator&lt;Item = i32&gt;</code> (or whatever)."}, {"owner": {"reputation": 11, "user_id": 3939588, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fe93fd385c660afa2637f4172e71f7f9?s=128&d=identicon&r=PG", "display_name": "knutaf", "link": "https://stackoverflow.com/users/3939588/knutaf"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1544076551, "post_id": 53642333, "comment_id": 94149627, "body": "You&#39;re right. I over-reduced my question. Rather than return it from a function, if I want to store it in a struct, I found that <code>Box&lt;Iterator&lt;Item = &amp;&#39;v u32&gt; + &#39;v&gt;</code> works, but impl Trait isn&#39;t allowed in that position, and I don&#39;t know if some other syntax exists to solve it."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1544081149, "post_id": 53642333, "comment_id": 94151276, "body": "You can always make your struct generic like <code>S&lt;&#39;v, T: Iterator&lt;Item = &amp;&#39;v u32&gt; + &#39;v&gt;</code>, or if you don&#39;t want to use a generic and need to use the type in several places, you can shorten it with a type alias: <code>type MyType = std::iter::Cycle&lt;std::slice::Iter&lt;&#39;v, i32&gt;&gt;;</code> and then simply use <code>MyType</code> everywhere."}], "owner": {"reputation": 11, "user_id": 3939588, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fe93fd385c660afa2637f4172e71f7f9?s=128&d=identicon&r=PG", "display_name": "knutaf", "link": "https://stackoverflow.com/users/3939588/knutaf"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 315, "favorite_count": 0, "closed_date": 1544058458, "answer_count": 0, "score": 1, "last_activity_date": 1544058557, "creation_date": 1544052206, "last_edit_date": 1544058411, "question_id": 53642333, "link": "https://stackoverflow.com/questions/53642333/rust-e0308-cannot-deduce-type", "closed_reason": "Duplicate", "title": "rust E0308 cannot deduce type", "body": "<p>I am trying to create an iterator that wraps another iterator with a given associated type and does some additional work. I'm using generic types because it's not pretty to write out the concrete type of the wrapped iterator. I've reduced the error to the following code.</p>\n\n<pre><code>trait Trait {\n    fn doit(&amp;self);\n}\n\nstruct S1 {}\nimpl Trait for S1 {\n    fn doit(&amp;self) {}\n}\n\nfn create_s1() -&gt; S1 {\n    S1 {}\n}\n\nfn create&lt;S&gt;() -&gt; S\nwhere\n    S: Trait,\n{\n    create_s1()\n}\n\nfn main() {\n    let s = create::&lt;S1&gt;();\n}\n</code></pre>\n\n<p>The error I get is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:18:5\n   |\n14 | fn create&lt;S&gt;() -&gt; S\n   |                   - expected `S` because of return type\n...\n18 |     create_s1()\n   |     ^^^^^^^^^^^ expected type parameter, found struct `S1`\n   |\n   = note: expected type `S`\n              found type `S1`\n</code></pre>\n\n<p>It seems clear to me that <code>create_s1()</code> returns type <code>S1</code> and that type <code>S1</code> implements <code>Trait</code>. Why can't the compiler figure out the type of <code>S</code>?</p>\n\n<p>I'm using rustc 1.32.0-nightly (b3af09205 2018-12-04)</p>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1544023896, "post_id": 53635535, "comment_id": 94130987, "body": "Is there a <code>rust-toolchain</code> file in the directory?"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1544086938, "post_id": 53635535, "comment_id": 94154000, "body": "Oh; is that a new feature? Didn&#39;t even knew this was a thing."}], "answers": [{"tags": [], "owner": {"reputation": 1540, "user_id": 2606171, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/F4ncy.png?s=128&g=1", "display_name": "belst", "link": "https://stackoverflow.com/users/2606171/belst"}, "is_accepted": true, "score": 3, "last_activity_date": 1544024057, "last_edit_date": 1544024057, "creation_date": 1544023996, "answer_id": 53635710, "question_id": 53635535, "link": "https://stackoverflow.com/questions/53635535/how-can-i-prevent-cargo-from-automatically-trying-to-download-a-newer-version-of/53635710#53635710", "title": "How can I prevent Cargo from automatically trying to download a newer version of the compiler?", "body": "<p>You can specify the used toolchain version for a specific directory by using <code>rustup override</code>. For example:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>rustup override set 1.28.0\n</code></pre>\n"}], "owner": {"reputation": 251, "user_id": 4102371, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/4a6421fb297d401d6be5dac233b5d66d?s=128&d=identicon&r=PG&f=1", "display_name": "Sleik", "link": "https://stackoverflow.com/users/4102371/sleik"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 201, "favorite_count": 0, "accepted_answer_id": 53635710, "answer_count": 1, "score": 2, "last_activity_date": 1544024668, "creation_date": 1544023446, "last_edit_date": 1544024668, "question_id": 53635535, "link": "https://stackoverflow.com/questions/53635535/how-can-i-prevent-cargo-from-automatically-trying-to-download-a-newer-version-of", "title": "How can I prevent Cargo from automatically trying to download a newer version of the compiler?", "body": "<p>I need to compile an older version of Parity which only compiles with version 1.28 of the Rust compiler. To install the older version, I did this:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>rustup.sh -y --default-toolchain 1.28.0\n</code></pre>\n\n<p>This seems to work:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>root@2afa3b8dc256:/build# cargo --version\ncargo 1.28.0 (96a2c7d16 2018-07-13)\nroot@2afa3b8dc256:/build# rustc --version\nrustc 1.28.0 (9634041f0 2018-07-30)\n</code></pre>\n\n<p>When I try to compile the project, it immediately tries to download a new version of the compiler:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>root@2afa3b8dc256:/parity# cargo build --all\ninfo: syncing channel updates for 'stable-x86_64-unknown-linux-gnu'\n320.1 KiB / 320.1 KiB (100 %) 271.0 KiB/s ETA:   0 s                \ninfo: latest update on 2018-11-08, rust version 1.30.1 (1433507eb 2018-11-07)\ninfo: downloading component 'rustc'\n</code></pre>\n\n<p>How can I prevent Cargo from doing that?</p>\n"}, {"tags": ["sockets", "unix", "rust"], "answers": [{"comments": [{"owner": {"reputation": 1185, "user_id": 1727286, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/Ko2Sa.jpg?s=128&g=1", "display_name": "goral", "link": "https://stackoverflow.com/users/1727286/goral"}, "edited": false, "score": 2, "creation_date": 1544023414, "post_id": 53635438, "comment_id": 94130695, "body": "That is the worst answer I could think of - my Rust code was fine and I lost half of the day trying to fix it."}, {"owner": {"reputation": 1185, "user_id": 1727286, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/Ko2Sa.jpg?s=128&g=1", "display_name": "goral", "link": "https://stackoverflow.com/users/1727286/goral"}, "edited": false, "score": 1, "creation_date": 1544023595, "post_id": 53635438, "comment_id": 94130800, "body": "It worked when I called it like: <code>nc -q 0 -U &#47;tmp&#47;socket</code> ."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 3, "last_activity_date": 1544023658, "last_edit_date": 1544023658, "creation_date": 1544023173, "answer_id": 53635438, "question_id": 53634911, "link": "https://stackoverflow.com/questions/53634911/why-does-sending-d-with-netcat-not-trigger-an-eof-when-reading-from-a-unix-sock/53635438#53635438", "title": "Why does sending ^D with netcat not trigger an EOF when reading from a Unix socket?", "body": "<blockquote>\n  <p>I send some data and end it with <kbd>^D</kbd> which should be an EOF</p>\n</blockquote>\n\n<p>It is, to the input of <code>nc</code>. That doesn't mean that the socket itself is closed:</p>\n\n<blockquote>\n  <p>When netcat is faced with an EOF on its standard input, it may or may\n  not close the sending part of its TCP connection, depending on which\n  version of netcat it is.</p>\n  \n  <ul>\n  <li><a href=\"http://billauer.co.il/blog/2018/07/netcat-nc-stop-quit-disconnect/\" rel=\"nofollow noreferrer\">Solved: netcat (nc) doesn\u2019t terminate at end of transmission</a></li>\n  </ul>\n</blockquote>\n\n\n\n<blockquote>\n  <p><strong>ctrl+d which sends an EOF on netcat's stdin</strong>: netcat noticed the EOF. It will send no further data through the socket. However, it\n  continues running and reading from the socket in case the server has\n  more data to send.</p>\n  \n  <ul>\n  <li><a href=\"https://stackoverflow.com/questions/10981790/unix-epoll-catch-ctrld-and-ctrlc-in-server\">Unix : Epoll, catch ctrl+d and ctrl+c in server</a></li>\n  </ul>\n</blockquote>\n\n<p>For what it's worth, I cannot reproduce your problem on macOS 10.14.1  with the system-supplied <code>nc</code>.</p>\n\n<p>You might be able to use the <code>-q</code> or <code>-w</code> options for your version of <code>nc</code>:</p>\n\n<blockquote>\n  <p>Assuming that after sending EOF connection will stay idle, you can use <code>-w timeout</code> option, which works for <code>timeout</code> being equal to zero</p>\n  \n  <ul>\n  <li><a href=\"https://unix.stackexchange.com/questions/189454/netcat-doesnt-terminate-when-stdin-closes\">netcat doesn't terminate when stdin closes</a></li>\n  </ul>\n</blockquote>\n\n<p>You could also try being non-interactive:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ echo 'hello' | nc -U socket\nhello\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/50818660/155423\">read_to_end method never returns for UnixStream</a></li>\n<li><a href=\"https://stackoverflow.com/q/30552187/155423\">Reading from a TcpStream with Read::read_to_string hangs until the connection is closed by the remote end</a></li>\n</ul>\n"}], "owner": {"reputation": 1185, "user_id": 1727286, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/Ko2Sa.jpg?s=128&g=1", "display_name": "goral", "link": "https://stackoverflow.com/users/1727286/goral"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3159, "favorite_count": 0, "accepted_answer_id": 53635438, "answer_count": 1, "score": 2, "last_activity_date": 1544023658, "creation_date": 1544021366, "last_edit_date": 1544022898, "question_id": 53634911, "link": "https://stackoverflow.com/questions/53634911/why-does-sending-d-with-netcat-not-trigger-an-eof-when-reading-from-a-unix-sock", "title": "Why does sending ^D with netcat not trigger an EOF when reading from a Unix socket?", "body": "<p>I am trying to write a server that will read from a Unix socket:</p>\n\n<pre><code>use std::io::prelude::*;\nuse std::os::unix::net::{UnixListener, UnixStream};\n\nfn main() {\n    let socket_name = \"socket\";\n\n    let listener = match UnixListener::bind(&amp;socket_name) {\n        Err(err) =&gt; panic!(\"Failed to bind to socket: {}.\", err),\n        Ok(stream) =&gt; stream,\n    };\n\n    for mut stream in listener.incoming() {\n        match stream {\n            Ok(ref mut stream) =&gt; {\n                let msg = read(stream);\n                stream.write_all(msg.as_bytes()).expect(\"Echo\");\n            }\n            Err(err) =&gt; panic!(\"Error occured when listening from the stream. {}\", err),\n        }\n    }\n\n    fn read(stream: &amp;mut UnixStream) -&gt; String {\n        let mut s = String::new();\n        stream.read_to_string(&amp;mut s).unwrap();\n        s\n    }\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=e76888a4ba6885f89467229021ca7ca2\" rel=\"nofollow noreferrer\">playground</a>)</p>\n\n<p>On the client side I use <code>nc</code>: <code>nc -U socket</code>. I send some data and end it with <kbd>^D</kbd> which should be an EOF. The docs for <code>read_to_string</code> say:</p>\n\n<blockquote>\n  <p>Read all bytes until EOF in this source, appending them to buf</p>\n</blockquote>\n\n<p>Expected behavior:\nAfter sending <kbd>^D</kbd> on the client side the server responds with echo</p>\n\n<p>Observed behavior:\nServer doesn't recognize that EOF was sent and blocks. Only when the client breaks the connection the server prints the message and <code>panic</code>s with the broken pipeline.</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 4, "last_activity_date": 1544018622, "last_edit_date": 1544018622, "creation_date": 1544011005, "answer_id": 53631786, "question_id": 53631539, "link": "https://stackoverflow.com/questions/53631539/why-is-ref-mut-on-a-for-loop-binding-not-the-same-as-mut-on-the-variable-be/53631786#53631786", "title": "Why is `ref mut` on a for loop binding not the same as `&amp;mut` on the variable being looped over?", "body": "<p>What you quote from the book is a rule for normal assignments such as those by <code>let</code>. For example:</p>\n\n<pre><code>let x = &amp;42;\nlet ref x = 42;\n</code></pre>\n\n<p>But the name binding in a <code>for</code> loop is a bit different:</p>\n\n<ul>\n<li>The value to be looped around is converted into an iterator (<code>&lt;v1 as IntoIterator&gt;::into_iter()</code>) Lets call the result of that <code>it</code>.</li>\n<li>Then the <code>it.next()</code> is called repeatedly:\n\n<ul>\n<li>If it returns <code>Some(_)</code> then the value of that is bound to your variable. Just as if you wrote <code>let Some(ref mut i) = it.next()</code> or <code>let Some(mut i) = it.next()</code>. Here is where the <code>ref</code> matters.</li>\n<li>If it returns <code>None</code> the loop ends.</li>\n</ul></li>\n</ul>\n\n<p>So in the <code>for</code> loop case, the <code>ref</code> and the <code>&amp;</code> are not equivalent.</p>\n\n<p>When you use the <code>&amp;</code> at the right side of a loop, it does not change the binding of the variable directly; you just change the type of the object iterated. Then, all comes down to the implementation of <code>IntoIterator</code> for <code>Vec&lt;_&gt;</code> vs that for <code>&amp;Vec&lt;_&gt;</code>.</p>\n\n<ul>\n<li>If you iterate <code>Vec&lt;T&gt;</code>, it takes ownership of the vector and the iteration returns the values themselves. So <code>for i in v1</code> consumes the vector and the <code>i</code> has the type of the contained values <code>T</code>.</li>\n<li>If you iterate <code>&amp;Vec&lt;T&gt;</code>, it borrows the vector and the iteration return pointers to the contained values <code>&amp;T</code>, so in <code>for i in &amp;v1</code> the type of <code>i</code> is actually a pointer to the values. The same effect can be got with <code>for i in v1.iter()</code>.</li>\n<li>If you iterate <code>&amp;mut Vec&lt;T&gt;</code>, is just like the previous one but mutable, so the iteration returns values of type <code>&amp;mut T</code>.</li>\n</ul>\n\n<p>The conclusion is that using <code>ref</code> in a <code>for</code> loop is not probably so useful.</p>\n"}], "owner": {"reputation": 1344, "user_id": 488487, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/bcbfe1e18a2c6402d5db14520279b04b?s=128&d=identicon&r=PG", "display_name": "wliao", "link": "https://stackoverflow.com/users/488487/wliao"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 414, "favorite_count": 0, "accepted_answer_id": 53631786, "answer_count": 1, "score": 1, "last_activity_date": 1544018775, "creation_date": 1544010237, "last_edit_date": 1544018775, "question_id": 53631539, "link": "https://stackoverflow.com/questions/53631539/why-is-ref-mut-on-a-for-loop-binding-not-the-same-as-mut-on-the-variable-be", "title": "Why is `ref mut` on a for loop binding not the same as `&amp;mut` on the variable being looped over?", "body": "<p>In <a href=\"https://doc.rust-lang.org/rust-by-example/scope/borrow/ref.html\" rel=\"nofollow noreferrer\">Rust by Example</a>, it says:</p>\n\n<blockquote>\n  <p>A <code>ref</code> borrow on the left side of an assignment is equivalent to an <code>&amp;</code> borrow on the right side.</p>\n</blockquote>\n\n<p>I thought these two <code>for</code> loops would be equivalent:</p>\n\n<p>Compiles successfully:</p>\n\n<pre><code>let mut v2 = vec![1, 2, 3];\nfor i in &amp;mut v2 {\n    *i = *i + 1;\n}\nprintln!(\"{:?}\", v2);\n</code></pre>\n\n<p>Does not compile:</p>\n\n<pre><code>let mut v1 = vec![1, 2, 3];\nfor ref mut i in v1 {\n    *i = *i + 1;\n}\nprintln!(\"{:?}\", v1);\n</code></pre>\n\n<p>It seems <code>v</code> is moved:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0382]: use of moved value: `v1`\n --&gt; src/main.rs:6:22\n  |\n3 |     for ref mut i in v1 {\n  |                      -- value moved here\n...\n6 |     println!(\"{:?}\", v1);\n  |                      ^^ value used here after move\n  |\n  = note: move occurs because `v1` has type `std::vec::Vec&lt;i32&gt;`, which does not implement the `Copy` trait\n</code></pre>\n"}, {"tags": ["rust", "traits", "callable"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1543998866, "post_id": 53627979, "comment_id": 94115949, "body": "Afaik you can&#39;t have a reference to a function like that. You can say, that a function should live as long as <code>&#39;a</code> with <code>fn foo&lt;&#39;a, T: Fn() + &#39;a&gt;(t: T) { t() }</code>"}], "answers": [{"tags": [], "owner": {"reputation": 466742, "user_id": 224671, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/c90de868a7e95d75bdfd6a906dfedac7?s=128&d=identicon&r=PG", "display_name": "kennytm", "link": "https://stackoverflow.com/users/224671/kennytm"}, "is_accepted": false, "score": 3, "last_activity_date": 1544007155, "last_edit_date": 1544007155, "creation_date": 1544006263, "answer_id": 53630355, "question_id": 53627979, "link": "https://stackoverflow.com/questions/53627979/why-is-a-reference-to-a-type-that-implements-fn-not-recognized-as-a-callable/53630355#53630355", "title": "Why is a reference to a type that implements Fn not recognized as a callable?", "body": "<p>This is perhaps a bug (e.g. it works if you replace the <code>&amp;'a T</code> by <code>(&amp;'a T,)</code>). Nevertheless, you can call the function like this:</p>\n\n<pre><code>fn test_ref_input_as_fntrait&lt;'a, T&gt;(t: &amp;'a T)\nwhere\n    &amp;'a T: Fn(),\n{\n    (&amp;t)();\n}\n</code></pre>\n\n<p>but since <code>T: Fn()</code> automatically implies <code>&amp;T: Fn()</code>, it is easier and more idiomatic to just write like your last example.</p>\n\n<pre><code>fn test_ref_input_as_fntrait&lt;F: Fn()&gt;(t: F) {\n    t();\n}\n\nfn main() {\n    test_ref_input_as_fntrait(&amp;|| println!(\"it's okay!\"));\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "is_accepted": true, "score": 4, "last_activity_date": 1544018370, "last_edit_date": 1544018370, "creation_date": 1544016470, "answer_id": 53633445, "question_id": 53627979, "link": "https://stackoverflow.com/questions/53627979/why-is-a-reference-to-a-type-that-implements-fn-not-recognized-as-a-callable/53633445#53633445", "title": "Why is a reference to a type that implements Fn not recognized as a callable?", "body": "<p>There is an <a href=\"https://github.com/rust-lang/rust/issues/42736\" rel=\"nofollow noreferrer\">open issue (#42736)</a> about this. However, the <a href=\"https://doc.rust-lang.org/std/ops/trait.Fn.html\" rel=\"nofollow noreferrer\">docs for <code>Fn</code></a> state:</p>\n\n<blockquote>\n  <p>for any type <code>F</code> that implements <code>Fn</code>, <code>&amp;F</code> implements <code>Fn</code>, too.</p>\n</blockquote>\n\n<p>This means that the following works: </p>\n\n<pre><code>fn test_ref_input_as_fntrait&lt;'a, T&gt;(t: &amp;'a T)\nwhere\n    T: Fn(),\n{\n    t();\n}\n</code></pre>\n"}], "owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 338, "favorite_count": 0, "accepted_answer_id": 53633445, "answer_count": 2, "score": 2, "last_activity_date": 1544018370, "creation_date": 1543998250, "last_edit_date": 1544018240, "question_id": 53627979, "link": "https://stackoverflow.com/questions/53627979/why-is-a-reference-to-a-type-that-implements-fn-not-recognized-as-a-callable", "title": "Why is a reference to a type that implements Fn not recognized as a callable?", "body": "<p>Even if <code>&amp;T</code> is defined as implementing the <code>Fn</code> trait, the compiler rejects it when invoking it is as a callable:</p>\n\n<pre><code>trait Trait {\n    fn act(self);\n}\n\n//passes\nfn test_ref_input_as_trait&lt;'a, T&gt;(t: &amp;'a T)\nwhere\n    &amp;'a T: Trait,\n{\n    t.act();\n}\n\n//fails\nfn test_ref_input_as_fntrait&lt;'a, T&gt;(t: &amp;'a T)\nwhere\n    &amp;'a T: Fn(),\n{\n    t();\n}\n\n//passes\nfn test_input_as_fntrait&lt;T&gt;(t: T)\nwhere\n    T: Fn(),\n{\n    t();\n}\n</code></pre>\n\n<p>The compiler rejects the definition of the second function with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0618]: expected function, found `&amp;'a T`\n  --&gt; src/lib.rs:18:5\n   |\n14 | fn test_ref_input_as_fntrait&lt;'a, T&gt;(t: &amp;'a T)\n   |                                     - `&amp;'a T` defined here\n...\n18 |     t();\n   |     ^^^ not a function\n</code></pre>\n\n<p>With nightly (1.32), the error message is replaced with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0618]: expected function, found `&amp;'a T`\n  --&gt; src/lib.rs:18:5\n   |\n14 | fn test_ref_input_as_fntrait&lt;'a, T&gt;(t: &amp;'a T)\n   |                                     - `&amp;'a T` defined here\n...\n18 |     t();\n   |     ^--\n   |     |\n   |     call expression requires function\n</code></pre>\n\n<p>Maybe I'm missing something, but why is the compiler accepting the definition but not allowing it to be invoked? Is it a syntactical shortcoming from my side that leads it to understand something else?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 11623, "user_id": 1223781, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/4v6YK.png?s=128&g=1", "display_name": "Tim Vermeulen", "link": "https://stackoverflow.com/users/1223781/tim-vermeulen"}, "edited": false, "score": 0, "creation_date": 1544016689, "post_id": 53625153, "comment_id": 94126348, "body": "You&#39;re applying <code>?</code> to the result of <code>nth</code>, which is different from using it <i>inside</i> it. You&#39;re calling <code>nth</code>, not implementing it. <code>main</code> is the function you&#39;re writing it in, which doesn&#39;t return <code>Option</code>."}], "answers": [{"comments": [{"owner": {"reputation": 1339, "user_id": 682485, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/ea1e106f2d083f0624c0c4f48ae1c18b?s=128&d=identicon&r=PG", "display_name": "Malice", "link": "https://stackoverflow.com/users/682485/malice"}, "edited": false, "score": 0, "creation_date": 1543988834, "post_id": 53625259, "comment_id": 94111755, "body": "I thought there was a way to return Result from <code>main</code> ?"}, {"owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "edited": false, "score": 0, "creation_date": 1544053318, "post_id": 53625259, "comment_id": 94144253, "body": "A better reference for returning Result from main is <a href=\"https://rust-lang-nursery.github.io/edition-guide/rust-2018/error-handling-and-panics/question-mark-in-main-and-tests.html\" rel=\"nofollow noreferrer\">rust-lang-nursery.github.io/edition-guide/rust-2018/&hellip;</a>"}], "tags": [], "owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "is_accepted": false, "score": 1, "last_activity_date": 1544018002, "last_edit_date": 1544018002, "creation_date": 1543984623, "answer_id": 53625259, "question_id": 53625153, "link": "https://stackoverflow.com/questions/53625153/why-cant-i-use-the-operator-in-my-main-function-on-a-function-that-returns-an/53625259#53625259", "title": "Why can&#39;t I use the ? operator in my main function on a function that returns an Option?", "body": "<p>The <code>?</code> operator will cause the function containing it to return <code>None</code> if the value the <code>?</code> is applied to is <code>None</code>.</p>\n\n<p>This means you can write</p>\n\n<pre><code>fn not_main() -&gt; Option&lt;()&gt; {\n    println!(\"{}\", std::env::args().nth(3)?);\n    Ok(())\n}\n</code></pre>\n\n<p>since <code>nth</code> returns an <code>Option&lt;Item&gt;</code> and <code>not_main</code> returns an <code>Option&lt;()&gt;</code>. </p>\n\n<p>However, your <code>main</code> does not return an <code>Option</code>, hence <code>?</code> can't work inside it.</p>\n\n<p>How you work around this will depend on what you want to do in the case of a missing argument. The most brutal solution is to <code>unwrap</code> instead - which will cause your code to panic.</p>\n\n<pre><code>fn main() {\n    println!(\"{}\", env::args().nth(3).unwrap())\n}\n</code></pre>\n\n<p>An alternative is to match and handle the missing case</p>\n\n<pre><code>fn main() {\n    match std::env::args().nth(3) {\n        Some(ref v) =&gt; println!(\"{}\", v),\n        None =&gt; println!(\"Missing argument\"),\n    }\n}\n</code></pre>\n\n<p>Since <code>Option</code> supports <code>Debug</code> you could print the debug version - which will output <code>None</code>, or <code>Some(\"arg3\")</code>.</p>\n\n<pre><code>fn main() {\n    println!(\"{:?}\", std::env::args().nth(3));\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 4, "last_activity_date": 1544018893, "last_edit_date": 1544018893, "creation_date": 1544010561, "answer_id": 53631633, "question_id": 53625153, "link": "https://stackoverflow.com/questions/53625153/why-cant-i-use-the-operator-in-my-main-function-on-a-function-that-returns-an/53631633#53631633", "title": "Why can&#39;t I use the ? operator in my main function on a function that returns an Option?", "body": "<p>The return type of <code>main</code> must implement <a href=\"https://doc.rust-lang.org/std/process/trait.Termination.html\" rel=\"nofollow noreferrer\"><code>std::process::Termination</code></a>(currently it's an unstable trait). If you look at the end of the documentation, you will see:</p>\n\n<pre><code>impl Termination for !\nimpl Termination for ()\nimpl Termination for ExitCode\nimpl&lt;E: Debug&gt; Termination for Result&lt;!, E&gt;\nimpl&lt;E: Debug&gt; Termination for Result&lt;(), E&gt;\n</code></pre>\n\n<p>If you want to return an <code>Option</code> you must implement the trait on it. This is not practical <a href=\"https://stackoverflow.com/q/25413201/155423\">because you can't implement a trait on foreign type</a>, so the best solution is to convert <code>Option&lt;T&gt;</code> to <code>Result&lt;T, E&gt;</code>:</p>\n\n<pre><code>use std::env;\n\nfn main() -&gt; Result&lt;(), Box&lt;std::error::Error&gt;&gt; {\n    println!(\"{}\", env::args().nth(3).ok_or(\"Missing argument\")?);\n    Ok(())\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/30555477/why-do-try-and-not-compile-when-used-in-a-function-that-doesnt-return-opti\">Why do try!() and ? not compile when used in a function that doesn&#39;t return Option or Result?</a></li>\n</ul>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user10747445"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2371, "favorite_count": 0, "answer_count": 2, "score": 4, "last_activity_date": 1544018893, "creation_date": 1543983812, "last_edit_date": 1544018519, "question_id": 53625153, "link": "https://stackoverflow.com/questions/53625153/why-cant-i-use-the-operator-in-my-main-function-on-a-function-that-returns-an", "title": "Why can&#39;t I use the ? operator in my main function on a function that returns an Option?", "body": "<p>Using this file:</p>\n\n<pre><code>use std::env;\n\nfn main() {\n    println!(\"{}\", env::args().nth(3)?);\n}\n</code></pre>\n\n<p>I get this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the `?` operator can only be used in a function that returns `Result` or `Option` (or another type that implements `std::ops::Try`)\n --&gt; src/main.rs:4:20\n  |\n4 |     println!(\"{}\", env::args().nth(3)?);\n  |                    ^^^^^^^^^^^^^^^^^^^ cannot use the `?` operator in a function that returns `()`\n  |\n  = help: the trait `std::ops::Try` is not implemented for `()`\n  = note: required by `std::ops::Try::from_error`\n</code></pre>\n\n<p>However this is confusing because <a href=\"http://doc.rust-lang.org/std/iter/trait.Iterator.html#method.nth\" rel=\"nofollow noreferrer\"><code>nth</code> does return <code>Option</code></a>:</p>\n\n<pre><code>fn nth(&amp;mut self, n: usize) -&gt; Option&lt;Self::Item&gt;\n</code></pre>\n\n<p>Am I misunderstanding the documentation or is this a bug?</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 2482, "user_id": 1129436, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/09511512293a4e31936309f2c6aee08e?s=128&d=identicon&r=PG", "display_name": "River Tam", "link": "https://stackoverflow.com/users/1129436/river-tam"}, "edited": false, "score": 0, "creation_date": 1543982086, "post_id": 53624935, "comment_id": 94109959, "body": "It occurs to me that, while this fixes the code, it doesn&#39;t really explain to me why <code>Mutex&lt;ActuallyUnsendable&gt;</code> wouldn&#39;t be <code>Send</code>. I&#39;d be interested to hear an answer that also explains this."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1544000393, "post_id": 53624935, "comment_id": 94116671, "body": "That second part is answered <a href=\"https://stackoverflow.com/q/52866447/1233251\">here</a>. <code>Mutex</code> does not automatically make something safe to use in a multi-threaded environment."}], "tags": [], "owner": {"reputation": 2482, "user_id": 1129436, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/09511512293a4e31936309f2c6aee08e?s=128&d=identicon&r=PG", "display_name": "River Tam", "link": "https://stackoverflow.com/users/1129436/river-tam"}, "is_accepted": true, "score": 0, "last_activity_date": 1543982019, "creation_date": 1543982019, "answer_id": 53624935, "question_id": 53624912, "link": "https://stackoverflow.com/questions/53624912/share-a-struct-with-protected-non-send-through-threads/53624935#53624935", "title": "Share a struct with protected non-Send through threads", "body": "<p>Figured it out very shortly after I asked (though I'd been thinking about it for a day).</p>\n\n<p><code>Fn</code> is just a trait, which itself does not add <code>Send</code>. However, closures are also <code>Send</code>, so I need to replace <code>Mutex&lt;Fn(i64)&gt;</code> with <code>Mutex&lt;Fn(i64) + Send&gt;</code>. This reveals other problems, but solves the original one.</p>\n"}], "owner": {"reputation": 2482, "user_id": 1129436, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/09511512293a4e31936309f2c6aee08e?s=128&d=identicon&r=PG", "display_name": "River Tam", "link": "https://stackoverflow.com/users/1129436/river-tam"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 625, "favorite_count": 0, "closed_date": 1544017649, "accepted_answer_id": 53624935, "answer_count": 1, "score": 2, "last_activity_date": 1543982019, "creation_date": 1543981816, "question_id": 53624912, "link": "https://stackoverflow.com/questions/53624912/share-a-struct-with-protected-non-send-through-threads", "closed_reason": "Duplicate", "title": "Share a struct with protected non-Send through threads", "body": "<p>I'd like to share a struct with an <code>Arc&lt;Mutex&lt;Fn(i64)&gt;&gt;</code> through a thread. I've minimally reproduced the problem below:</p>\n\n<pre><code>use std::sync::{Arc, Mutex};\n\nstruct NonSendable {\n    problematic: Arc&lt;Mutex&lt;Fn(i64)&gt;&gt;,\n}\n\nfn main() {\n    let bad = NonSendable {\n        problematic: Arc::new(Mutex::new(|i| println!(\"{}\", i))),\n    };\n\n    std::thread::spawn(|| {\n        for i in 0..10 {\n            let f = bad.problematic.lock().unwrap();\n            f(i);\n        }\n    });\n}\n</code></pre>\n\n<p>However, this errors on compilation.</p>\n\n<pre><code>error[E0277]: `(dyn std::ops::Fn(i64) + 'static)` cannot be sent between threads safely\n  --&gt; src/main.rs:13:5\n   |\n13 |     std::thread::spawn(|| {\n   |     ^^^^^^^^^^^^^^^^^^ `(dyn std::ops::Fn(i64) + 'static)` cannot be sent between threads safely\n   |\n   = help: the trait `std::marker::Send` is not implemented for `(dyn std::ops::Fn(i64) + 'static)`\n   = note: required because of the requirements on the impl of `std::marker::Send` for `std::sync::Mutex&lt;(dyn std::ops::Fn(i64) + 'static)\n&gt;`\n   = note: required because of the requirements on the impl of `std::marker::Sync` for `std::sync::Arc&lt;std::sync::Mutex&lt;(dyn std::ops::Fn(\ni64) + 'static)&gt;&gt;`\n   = note: required because it appears within the type `NonSendable`\n   = note: required because of the requirements on the impl of `std::marker::Send` for `&amp;NonSendable`\n   = note: required because it appears within the type `[closure@src/main.rs:13:24: 18:6 bad:&amp;NonSendable]`\n   = note: required by `std::thread::spawn`\n\nerror: aborting due to previous error\n</code></pre>\n\n<p>I guess I might understand why a <code>Fn</code> isn't <code>Send</code> or <code>Sync</code>, but should a <code>Mutex</code> not cover that issue? I've also tried to <code>Box</code> the <code>Fn</code> and use <code>FnMut</code> instead.</p>\n\n<p>The end goal here is to have a <code>Vec</code> of closures that can be accessed and modified in one thread while read in another thread, so I think I need multiple non-<code>mut</code> references (or maybe an <code>Arc</code>) to coexist in different threads with an <code>Arc&lt;Mutex&lt;Vec&lt;Fn&gt;&gt;&gt;</code> or similar as a member, but if I can't get the above to work I'll have to use a different strategy.</p>\n"}, {"tags": ["rust", "rust-rocket"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1544374084, "post_id": 53620318, "comment_id": 94244336, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/53620318/edit\">edit</a> your question to include it. We cannot tell what modules, etc. are present in the code (such as <code>schema</code>) If these aren&#39;t required to reproduce the problem, <i>remove them</i>; if they are required, provide them, minimized as much as possible. Try to produce something that reproduces your error in a brand new Cargo project with the <b>minimal</b> amount of code needed. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}], "answers": [{"tags": [], "owner": {"reputation": 171, "user_id": 4527149, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/856fd73864b4464722ebe2a10f2d6c79?s=128&d=identicon&r=PG&f=1", "display_name": "CdVr", "link": "https://stackoverflow.com/users/4527149/cdvr"}, "is_accepted": false, "score": 2, "last_activity_date": 1544391721, "last_edit_date": 1544391721, "creation_date": 1544375098, "answer_id": 53694640, "question_id": 53620318, "link": "https://stackoverflow.com/questions/53620318/the-specified-procedure-could-not-be-found-os-error-127-pluginrocket-co/53694640#53694640", "title": "The specified procedure could not be found. (os error 127) - #![plugin(rocket_codegen)]", "body": "<p>My <strong>Cargo.toml</strong> has</p>\n\n<pre><code>rocket = { git = \"https://github.com/SergioBenitez/Rocket\" }\nrocket_codegen = { git = \"https://github.com/SergioBenitez/Rocket\" }\n</code></pre>\n\n<p>which will pull the latest version. For me, it fetched Rocket 0.4.0. Since Rocket 0.4, <strong>rocket_codegen</strong> should not be a direct dependency.</p>\n\n<p>Simply remove it:</p>\n\n<p><strong>Cargo.toml</strong></p>\n\n<pre><code>[dependencies]\nrocket = \"0.4\"\n</code></pre>\n\n<p><strong>main.rs</strong></p>\n\n<pre><code>#![feature(proc_macro_hygiene, decl_macro)]\n#[macro_use] extern crate rocket;\n</code></pre>\n\n<p>Please check the change log in the news section of the <a href=\"https://rocket.rs/v0.4/news/2018-12-08-version-0.4/\" rel=\"nofollow noreferrer\">Rocket Documentation</a>.</p>\n"}], "owner": {"reputation": 171, "user_id": 4527149, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/856fd73864b4464722ebe2a10f2d6c79?s=128&d=identicon&r=PG&f=1", "display_name": "CdVr", "link": "https://stackoverflow.com/users/4527149/cdvr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 645, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1544391721, "creation_date": 1543952565, "last_edit_date": 1544387711, "question_id": 53620318, "link": "https://stackoverflow.com/questions/53620318/the-specified-procedure-could-not-be-found-os-error-127-pluginrocket-co", "title": "The specified procedure could not be found. (os error 127) - #![plugin(rocket_codegen)]", "body": "<p>I am a newbie with Rust programming and I am building Rust + Diesel + Rocket framework.</p>\n\n<p>When I run the command <code>cargo check</code> or <code>cargo run</code>, the following error occurs:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>The specified procedure could not be found. (os error 127)\n--&gt; src\\main.rs:2:11\n|\n2 | #![plugin(rocket_codegen)]\n</code></pre>\n\n<p>OS: Windows 10</p>\n\n<p>cargo.toml</p>\n\n<pre><code>[package]\nname = \"rest_in_rust\"\nversion = \"0.1.0\"\nauthors = [\"venka\"]\n\n[dependencies]\ndiesel = { version = \"1.0.0\", features = [\"postgres\"]}\ndotenv = \"0.9.0\"\nr2d2 = \"0.8.3\"\nserde = \"1.0.80\"\nserde_derive = \"1.0.80\"\nserde_json = \"1.0.33\"\n\nrocket = {  git = \"https://github.com/SergioBenitez/Rocket\" }\nrocket_codegen = {  git = \"https://github.com/SergioBenitez/Rocket\" }\nrocket_contrib = {  git = \"https://github.com/SergioBenitez/Rocket\", default-features = false, features = [\"json\"] }\n</code></pre>\n\n<p>Rust Version: rustc 1.32.0-nightly (0c999ed13 2018-12-03)</p>\n\n<p>main.rs file (the 2nd line throws me this error) any clue?</p>\n\n<pre><code> #![feature(plugin, custom_derive, const_fn, decl_macro)]\n #![plugin(rocket_codegen)]\n\n #[macro_use]\n extern crate diesel;\n extern crate dotenv;\n extern crate r2d2;\n extern crate rocket;\n extern crate rocket_contrib;\n #[macro_use]\n extern crate serde_derive;\n #[macro_use]\n extern crate serde_json;\n\n use dotenv::dotenv;\n use std::env;\n use diesel::prelude::*;\n use diesel::pg::PgConnection;\n\n mod schema;\n mod models;\n mod db;\n mod static_file;\n</code></pre>\n"}, {"tags": ["rust", "rust-macros"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1543950483, "post_id": 53619695, "comment_id": 94100006, "body": "Why not just evaluate <code>max</code> <i>outside</i> of the <code>quote</code> macro call and only put the resulting value inside?"}, {"owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543950848, "post_id": 53619695, "comment_id": 94100169, "body": "Unfortunately the constants in that case are commonly associated constants from interfaces, so I don&#39;t have direct access to the value - what I have are expressions that will be evaluated by the compiler as constants. In order to work out the values, I&#39;d have to implement an evaluator that can extract the value, recursively in some cases, which is infeasible."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1543950891, "post_id": 53619695, "comment_id": 94100191, "body": "<i>a huge chain of <code>if</code>s</i> \u2014 <code>if</code> is not currently allowed in constant expressions either; is that what you meant?"}, {"owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543950934, "post_id": 53619695, "comment_id": 94100215, "body": "yes that was what I meant - if that&#39;s not allowed I&#39;m completely out of ideas..."}, {"owner": {"reputation": 22583, "user_id": 1103681, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/rMUo3.png?s=128&g=1", "display_name": "oli_obk", "link": "https://stackoverflow.com/users/1103681/oli-obk"}, "edited": false, "score": 2, "creation_date": 1543951239, "post_id": 53619695, "comment_id": 94100364, "body": "You can use <code>[a, b][(a &lt; b) as usize]</code> to compute the maximum of two values at compile-time. I&#39;m gonna leave it to the reader to work from that snippet to a general solution for more elements."}, {"owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "reply_to_user": {"reputation": 22583, "user_id": 1103681, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/rMUo3.png?s=128&g=1", "display_name": "oli_obk", "link": "https://stackoverflow.com/users/1103681/oli-obk"}, "edited": false, "score": 0, "creation_date": 1543951340, "post_id": 53619695, "comment_id": 94100411, "body": "@oli_obk that might just work - a very neat trick - will try it and see. Thank you!"}, {"owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "reply_to_user": {"reputation": 22583, "user_id": 1103681, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/rMUo3.png?s=128&g=1", "display_name": "oli_obk", "link": "https://stackoverflow.com/users/1103681/oli-obk"}, "edited": false, "score": 0, "creation_date": 1544016337, "post_id": 53619695, "comment_id": 94126114, "body": "@oli_obk that works perfectly. If you write it as an answer I&#39;ll mark as accepted."}, {"owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "edited": false, "score": 0, "creation_date": 1544016741, "post_id": 53619695, "comment_id": 94126375, "body": "For reference, I ended up using<code>len.iter().fold(quote!(0), |max_val, expr| { quote!([#max_val, #expr][(#max_val &lt; #expr) as usize]) })</code> The generated rust is pretty horrific, but it compiles away to a single beautiful constant :)"}], "answers": [{"tags": [], "owner": {"reputation": 22583, "user_id": 1103681, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/rMUo3.png?s=128&g=1", "display_name": "oli_obk", "link": "https://stackoverflow.com/users/1103681/oli-obk"}, "is_accepted": true, "score": 8, "last_activity_date": 1553093551, "last_edit_date": 1553093551, "creation_date": 1544083209, "answer_id": 53646925, "question_id": 53619695, "link": "https://stackoverflow.com/questions/53619695/calculating-maximum-value-of-a-set-of-constant-expressions-at-compile-time/53646925#53646925", "title": "Calculating maximum value of a set of constant expressions at compile time", "body": "<p>While constant evaluation does not support <code>if</code> or other control flow, there is a way to select values depending on binary conditions:</p>\n\n<pre><code>[a, b][(a &lt; b) as usize]\n</code></pre>\n\n<p>What this does is</p>\n\n<ul>\n<li>create an array of the two elements you want to choose between</li>\n<li>create an arbitrary boolean expression</li>\n<li>cast said expresison to a <code>usize</code></li>\n<li>use that value to index into the array created above</li>\n</ul>\n\n<p>The first element is chosen if the condition is <code>false</code>, the second element is chosen if the condition is <code>true</code>.</p>\n\n<p>While this scheme can theoretically be extended to arbitrary length arrays by computing indices via mathematical operations on multiple casted <code>bool</code>s, it seems simpler to just go the functional way and nest the above expression:</p>\n\n<pre><code>const fn max(a: usize, b: usize) -&gt; usize {\n    [a, b][(a &lt; b) as usize]\n}\n\nconst MAX: usize = max(max(max(5, 6), 42), 3);\n</code></pre>\n\n<p>Starting with Rust 1.31, <code>const fn</code> is usable on the stable compiler.</p>\n"}], "owner": {"reputation": 1045, "user_id": 1600476, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cE94p.png?s=128&g=1", "display_name": "Richard Matheson", "link": "https://stackoverflow.com/users/1600476/richard-matheson"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 539, "favorite_count": 0, "accepted_answer_id": 53646925, "answer_count": 1, "score": 4, "last_activity_date": 1553093551, "creation_date": 1543949883, "last_edit_date": 1543950815, "question_id": 53619695, "link": "https://stackoverflow.com/questions/53619695/calculating-maximum-value-of-a-set-of-constant-expressions-at-compile-time", "title": "Calculating maximum value of a set of constant expressions at compile time", "body": "<p>I'm trying to calculate the maximum value of a set of constants at compile time inside a Rust procedural macro (a derive macro).</p>\n\n<p>The macro looks something like:</p>\n\n<pre><code>fn get_max_len() -&gt; TokenStream {\n    // Each TokenStream represents a constant expression\n    let len: Vec&lt;TokenStream&gt; = get_constant_lengths();\n\n    quote! {\n      // #(#len),* gets expanded to #len[0], #len[1], #len[2]...\n      const LEN: usize = std::cmp::max(#(#len),*);\n    }\n}\n</code></pre>\n\n<p>The problem is that <code>std::cmp::max</code> is a function and hence can't be used inside a constant expression (at least until <code>const fn</code> is stabilized - I want to keep to stable Rust if at all possible).</p>\n\n<p>How can I calculate the max of a set of constants at compile-time?</p>\n\n<p>I might be able to write a <code>max!</code> macro that basically constructs a huge chain of <code>if</code>s recursively, but I'm hoping there is a cleaner solution out there.</p>\n"}, {"tags": ["generics", "rust", "traits", "lifetime"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543949012, "post_id": 53619367, "comment_id": 94099324, "body": "You need to use higher-ranked trait bounds. See <a href=\"https://stackoverflow.com/q/35592750/155423\">How does for&lt;&gt; syntax differ from a regular lifetime bound?</a>. Concretely: <code>B: for&lt;&#39;b&gt; From&lt;&amp;&#39;b BlockTemplate&lt;T&gt;&gt;,</code>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543949061, "post_id": 53619367, "comment_id": 94099348, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/44343166/155423\">How do I write the lifetimes for references in a type constraint when one of them is a local reference?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/53619367/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1, "user_id": 10745025, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/89649b7167b473d1a7cbe69d5a763ecd?s=128&d=identicon&r=PG&f=1", "display_name": "barto", "link": "https://stackoverflow.com/users/10745025/barto"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1543949650, "post_id": 53619367, "comment_id": 94099623, "body": "@Shepmaster Thansk for the answer. You are correct, please mark this question as already answered."}], "owner": {"reputation": 1, "user_id": 10745025, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/89649b7167b473d1a7cbe69d5a763ecd?s=128&d=identicon&r=PG&f=1", "display_name": "barto", "link": "https://stackoverflow.com/users/10745025/barto"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 224, "favorite_count": 0, "closed_date": 1543949714, "answer_count": 0, "score": 0, "last_activity_date": 1543949721, "creation_date": 1543948317, "last_edit_date": 1543948794, "question_id": 53619367, "link": "https://stackoverflow.com/questions/53619367/lifetime-of-reference-outlives-borrowed-content-when-using-from-trait-bound", "closed_reason": "Duplicate", "title": "Lifetime of reference outlives borrowed content when using From trait bound", "body": "<p>I have the following code:</p>\n\n<pre><code>pub trait BlockFactory&lt;B, T&gt; {\n    fn build_block(template: &amp;BlockTemplate&lt;T&gt;, nonce: u32, previous_nonce: u32) -&gt; B;\n}\n\npub struct BlockTemplate&lt;T&gt; {\n    number: u32,\n    previous_hash: String,\n    transactions: Vec&lt;T&gt;,\n}\n\nimpl&lt;T&gt; BlockTemplate&lt;T&gt; {\n    pub fn new(number: u32, previous_hash: String, transactions: Vec&lt;T&gt;) -&gt; BlockTemplate&lt;T&gt; {\n        BlockTemplate {\n            number,\n            previous_hash,\n            transactions,\n        }\n    }\n}\n\npub struct DefaultBlockFactory {}\n\nimpl&lt;'a, B, T&gt; BlockFactory&lt;B, T&gt; for DefaultBlockFactory\nwhere\n    B: From&lt;&amp;'a BlockTemplate&lt;T&gt;&gt;,\n    T: 'a,\n{\n    fn build_block(template: &amp;BlockTemplate&lt;T&gt;, nonce: u32, previous_nonce: u32) -&gt; B {\n        B::from(template)\n    }\n}\n</code></pre>\n\n<p>Implementors of <code>BlockFactory</code> are supposed to take a reference to <code>BlockTemplate</code> and return a <code>Block</code> based on it.  </p>\n\n<p>The default implementation should work for any type of <code>B</code> and any type of <code>T</code>, assuming that <code>B</code> can be built from <code>BlockTemplate&lt;T&gt;</code>.</p>\n\n<p>When I try to compile it, I get the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0312]: lifetime of reference outlives lifetime of borrowed content...\n  --&gt; src/lib.rs:29:17\n   |\n29 |         B::from(template)\n   |                 ^^^^^^^^\n   |\nnote: ...the reference is valid for the lifetime 'a as defined on the impl at 23:6...\n  --&gt; src/lib.rs:23:6\n   |\n23 | impl&lt;'a, B, T&gt; BlockFactory&lt;B, T&gt; for DefaultBlockFactory\n   |      ^^\nnote: ...but the borrowed content is only valid for the anonymous lifetime #1 defined on the method body at 28:5\n  --&gt; src/lib.rs:28:5\n   |\n28 | /     fn build_block(template: &amp;BlockTemplate&lt;T&gt;, nonce: u32, previous_nonce: u32) -&gt; B {\n29 | |         B::from(template)\n30 | |     }\n   | |_____^\n</code></pre>\n\n<p>When I specify the lifetime <code>'a</code> for <code>template</code> in <code>build_block</code> method:</p>\n\n<pre><code>pub trait BlockFactory&lt;'a, B, T&gt; {\n    fn build_block(template: &amp;'a BlockTemplate&lt;T&gt;, nonce: u32, previous_nonce: u32) -&gt; B;\n}\n\n// clip\n\nimpl&lt;'a, B, T&gt; BlockFactory&lt;'a, B, T&gt; for DefaultBlockFactory\nwhere\n    B: From&lt;&amp;'a BlockTemplate&lt;T&gt;&gt;,\n    T: 'a,\n{\n    fn build_block(template: &amp;'a BlockTemplate&lt;T&gt;, nonce: u32, previous_nonce: u32) -&gt; B {\n        B::from(template)\n    }\n}\n\nfn example_build&lt;'b, B, T&gt;(template: BlockTemplate&lt;T&gt;)\nwhere\n    B: From&lt;&amp;'b BlockTemplate&lt;T&gt;&gt;,\n    T: 'b,\n{\n    let block: B = DefaultBlockFactory::build_block(&amp;template, 0, 0);\n}\n</code></pre>\n\n<p>I get a compiler error when calling it</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `template` does not live long enough\n  --&gt; src/lib.rs:28:54\n   |\n28 |     let block: B = DefaultBlockFactory::build_block(&amp;template, 0, 0);\n   |                                                      ^^^^^^^^ borrowed value does not live long enough\n29 | }\n   | - borrowed value only lives until here\n   |\nnote: borrowed value must be valid for the lifetime 'b as defined on the function body at 23:18...\n  --&gt; src/lib.rs:23:18\n   |\n23 | fn example_build&lt;'b, B, T&gt;(template: BlockTemplate&lt;T&gt;)\n   |                  ^^\n</code></pre>\n\n<p>It seems that, for some reason, <code>'a</code> is inferred as <code>'static</code>, but I have no idea why.</p>\n"}, {"tags": ["rust", "verbatim-string"], "answers": [{"tags": [], "owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "is_accepted": false, "score": 3, "last_activity_date": 1543927989, "creation_date": 1543927989, "answer_id": 53613473, "question_id": 53613318, "link": "https://stackoverflow.com/questions/53613318/c-like-verbatim-string-in-rust/53613473#53613473", "title": "C# like verbatim string in Rust?", "body": "<p>I guess <a href=\"https://doc.rust-lang.org/1.7.0/reference.html#raw-string-literals\" rel=\"nofollow noreferrer\">raw string literals</a> you are looking for ? </p>\n\n<pre><code> let raw_string_literal = r#\" line1 \\n still line 1\"#;\n println!(\"{}\", raw_string_literal);\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 5323, "user_id": 4636721, "user_type": "registered", "accept_rate": 78, "profile_image": "https://i.stack.imgur.com/6NGhx.jpg?s=128&g=1", "display_name": "Mary Perret", "link": "https://stackoverflow.com/users/4636721/mary-perret"}, "edited": false, "score": 0, "creation_date": 1543928708, "post_id": 53613581, "comment_id": 94087952, "body": "Aw too bad I thought adding some new lines at some point. But fair enough will play with the Rust rules. Thanks for your answer!"}, {"owner": {"reputation": 1101, "user_id": 8715470, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Dlyj0.jpg?s=128&g=1", "display_name": "Zarenor", "link": "https://stackoverflow.com/users/8715470/zarenor"}, "edited": false, "score": 0, "creation_date": 1543928875, "post_id": 53613581, "comment_id": 94088048, "body": "To be clear: It will look really odd, but you can include the newline character in the raw literal.. If you read the link I provided, some more explanation is provided."}], "tags": [], "owner": {"reputation": 1101, "user_id": 8715470, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Dlyj0.jpg?s=128&g=1", "display_name": "Zarenor", "link": "https://stackoverflow.com/users/8715470/zarenor"}, "is_accepted": true, "score": 7, "last_activity_date": 1543928446, "creation_date": 1543928446, "answer_id": 53613581, "question_id": 53613318, "link": "https://stackoverflow.com/questions/53613318/c-like-verbatim-string-in-rust/53613581#53613581", "title": "C# like verbatim string in Rust?", "body": "<p><a href=\"https://doc.rust-lang.org/rust-by-example/std/str.html#literals-and-escapes\" rel=\"noreferrer\">This</a> is surprisingly difficult to find.</p>\n\n<p>In rust, raw string literals are surrounded by <code>r\"\"</code>, and add <code>#</code> if you need to use quotes.\nFor your example, \n<br/><code>r#\"This is a string and here \"I am between quotes without making a fuss\"\"#</code> \n<br/>should work. (Double-quoting will produce doubled quotes in the string.)</p>\n\n<p>If you need something with the <code>#</code> symbol, you can do something like \n<br/><code>r###\"This string can have ## in as many places as I like ##, but never three in a row ##\"###</code></p>\n\n<p>However, in rust raw strings, escapes are disallowed. You cannot use <code>\\n</code>, for example. You can, however include any UTF-8 character you want.</p>\n"}], "owner": {"reputation": 5323, "user_id": 4636721, "user_type": "registered", "accept_rate": 78, "profile_image": "https://i.stack.imgur.com/6NGhx.jpg?s=128&g=1", "display_name": "Mary Perret", "link": "https://stackoverflow.com/users/4636721/mary-perret"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 294, "favorite_count": 1, "closed_date": 1543936011, "accepted_answer_id": 53613581, "answer_count": 2, "score": 4, "last_activity_date": 1543928446, "creation_date": 1543927479, "question_id": 53613318, "link": "https://stackoverflow.com/questions/53613318/c-like-verbatim-string-in-rust", "closed_reason": "Duplicate", "title": "C# like verbatim string in Rust?", "body": "<p>I am looking for a verbatim strings in Rust (like in C# with <code>@\"This is a string and here \"\"I am between quotes without making a fuss\"\"\"</code>).</p>\n\n<p>Is there something similar?</p>\n"}, {"tags": ["rust", "ffi"], "answers": [{"tags": [], "owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "is_accepted": true, "score": 7, "last_activity_date": 1543937538, "last_edit_date": 1543937538, "creation_date": 1543921974, "answer_id": 53611676, "question_id": 53611161, "link": "https://stackoverflow.com/questions/53611161/how-do-i-expose-a-compile-time-generated-static-c-string-through-ffi/53611676#53611676", "title": "How do I expose a compile time generated static C string through FFI?", "body": "<p>By ensuring that the static string slice is compatible with a C-style string (as in, it ends with the null terminator byte <code>\\0</code>), we can safely fetch a pointer to the beginning of the slice and pass that across the boundary.</p>\n\n<pre><code>pub static VERSION: &amp;str = concat!(env!(\"VERGEN_SEMVER\"), \"\\0\");\n\n#[no_mangle]\npub extern \"C\" fn get_version() -&gt; *const c_char {\n    VER.as_ptr() as *const c_char\n}\n</code></pre>\n\n<p>Here's an example in the <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=28d9b5e2145d033c241559f483c12843\" rel=\"noreferrer\">Playground</a>, where I used the package's version as the environment variable to fetch and called the function in Rust.</p>\n"}], "owner": {"reputation": 3351, "user_id": 1175813, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d347e8e2db656b5ab68b0248f0fd2111?s=128&d=identicon&r=PG", "display_name": "Michael Mauderer", "link": "https://stackoverflow.com/users/1175813/michael-mauderer"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 488, "favorite_count": 0, "accepted_answer_id": 53611676, "answer_count": 1, "score": 3, "last_activity_date": 1543937538, "creation_date": 1543920285, "last_edit_date": 1543937517, "question_id": 53611161, "link": "https://stackoverflow.com/questions/53611161/how-do-i-expose-a-compile-time-generated-static-c-string-through-ffi", "title": "How do I expose a compile time generated static C string through FFI?", "body": "<p>I am trying to embed a version number into a library. Ideally, this should be a static C string that can be read and doesn't need any additional allocation for reading the version number.</p>\n\n<p>On the Rust side, I am using <code>vergen</code> to generate the versioning information like this:</p>\n\n<pre><code>pub static VERSION: &amp;str = env!(\"VERGEN_SEMVER\");\n</code></pre>\n\n<p>and I would like to end up with something like</p>\n\n<pre><code>#[no_mangle]\npub static VERSION_C: *const u8 = ... ;\n</code></pre>\n\n<p>There seems to be a way to achieve this using <a href=\"https://stackoverflow.com/questions/29563785/how-do-i-create-static-c-strings\">string literals</a>, but I haven't found a way to do this with compile time strings. Creating a new <code>CString</code> seems to be beyond the current capabilities of static variables and tends to end with an <a href=\"https://doc.rust-lang.org/1.2.0/error-index.html#E0015\" rel=\"nofollow noreferrer\">error E0015</a>. </p>\n\n<p>A function returning the pointer like this would be acceptable, as long as it does not allocate new memory.</p>\n\n<pre><code>#[no_mangle]\npub extern \"C\" fn get_version() -&gt; *const u8 {\n    // ...\n}\n</code></pre>\n\n<p>The final type of the variable (or return type of the function) doesn't have to be based on <code>u8</code>, but should be translatable through <code>cbindgen</code>. If some other FFI type is more appropriate, using that is perfectly fine.</p>\n"}, {"tags": ["string", "rust", "text-files"], "comments": [{"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1543918003, "post_id": 53610291, "comment_id": 94081935, "body": "Why the <code>unwrap()</code>?"}, {"owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "reply_to_user": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1543918121, "post_id": 53610291, "comment_id": 94082015, "body": "@ljedrz updated w/o unwrap"}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1543918170, "post_id": 53610291, "comment_id": 94082052, "body": "Ah, I forgot it iterated over <code>Result</code>s; I&#39;ll answer shortly."}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1543919079, "post_id": 53610493, "comment_id": 94082605, "body": "With the trait <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#impl-FromIterator%3CResult%3CA%2C%20E%3E%3E\" rel=\"nofollow noreferrer\"><code>FromIterator</code></a>, and By the way <code>String</code> is inferred."}, {"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1543926074, "post_id": 53610493, "comment_id": 94086459, "body": "<code>let result: Result&lt;Vec&lt;_&gt;,_&gt; = reader.lines().collect();</code> this might also be used to if you want to use matcher instead of unwrap. You can still pass expected type as an argument though but imho i would prefer this, looks more clean to me."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543938518, "post_id": 53610493, "comment_id": 94093901, "body": "Or <code>let lines = reader.lines().collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap();</code>"}], "tags": [], "owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "is_accepted": false, "score": 5, "last_activity_date": 1543919245, "last_edit_date": 1543919245, "creation_date": 1543918289, "answer_id": 53610493, "question_id": 53610291, "link": "https://stackoverflow.com/questions/53610291/why-cant-i-collect-the-lines-iterator-into-a-vector-of-strings/53610493#53610493", "title": "Why can&#39;t I collect the Lines iterator into a vector of Strings?", "body": "<p>Since you want to collect straight into a <code>Vec&lt;String&gt;</code> while the <code>Lines</code> iterator is over <code>Result&lt;String, std::io::Error&gt;</code>, you need to help the type inference a little bit:</p>\n\n<pre><code>let lines: Vec&lt;String&gt; = reader.lines().collect::&lt;Result&lt;_, _&gt;&gt;().unwrap();\n</code></pre>\n\n<p>or even just:</p>\n\n<pre><code>let lines: Vec&lt;_&gt; = reader.lines().collect::&lt;Result&lt;_, _&gt;&gt;().unwrap();\n</code></pre>\n\n<p>This way the compiler knows that there is an intermediate step with a <code>Result&lt;Vec&lt;String&gt;, io::Error&gt;</code>. I think this case could be improved in the future, but for now the type inference is not able to deduce this.</p>\n"}], "owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2402, "favorite_count": 2, "answer_count": 1, "score": 5, "last_activity_date": 1543938471, "creation_date": 1543917693, "last_edit_date": 1543938471, "question_id": 53610291, "link": "https://stackoverflow.com/questions/53610291/why-cant-i-collect-the-lines-iterator-into-a-vector-of-strings", "title": "Why can&#39;t I collect the Lines iterator into a vector of Strings?", "body": "<p>I'm trying to read the lines of a text file into a vector of <code>String</code>s so I can continually loop over them and write each line to a channel for testing, but the compiler complains about <code>collect</code>:</p>\n\n<pre><code>use std::fs::File;\nuse std::io::BufRead;\nuse std::io::BufReader;\nuse std::path::Path;\n\nfn main() {\n    let file = File::open(Path::new(\"file\")).unwrap();\n    let reader = BufReader::new(&amp;file);\n    let _: Vec&lt;String&gt; = reader.lines().collect().unwrap();\n}\n</code></pre>\n\n<p>The compiler complains:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0282]: type annotations needed\n --&gt; src/main.rs:9:30\n  |\n9 |     let lines: Vec&lt;String&gt; = reader.lines().collect().unwrap();\n  |                              ^^^^^^^^^^^^^^^^^^^^^^^^ cannot infer type for `B`\n  |\n  = note: type must be known at this point\n</code></pre>\n\n<p>Without the <code>.unwrap()</code>, compiler says:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: a collection of type `std::vec::Vec&lt;std::string::String&gt;` cannot be built from an iterator over elements of type `std::result::Result&lt;std::string::String, std::io::Error&gt;`\n --&gt; src/main.rs:9:45\n  |\n9 |     let lines: Vec&lt;String&gt; = reader.lines().collect();\n  |                                             ^^^^^^^ a collection of type `std::vec::Vec&lt;std::string::String&gt;` cannot be built from `std::iter::Iterator&lt;Item=std::result::Result&lt;std::string::String, std::io::Error&gt;&gt;`\n  |\n  = help: the trait `std::iter::FromIterator&lt;std::result::Result&lt;std::string::String, std::io::Error&gt;&gt;` is not implemented for `std::vec::Vec&lt;std::string::String&gt;`\n</code></pre>\n\n<p>How do I tell Rust the correct type?</p>\n"}, {"tags": ["syntax", "rust", "range"], "answers": [{"tags": [], "owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "is_accepted": true, "score": 11, "last_activity_date": 1543917626, "creation_date": 1543917626, "answer_id": 53610257, "question_id": 53610214, "link": "https://stackoverflow.com/questions/53610214/what-is-the-difference-between-and/53610257#53610257", "title": "What is the difference between .. and ...?", "body": "<p>While ranges with <a href=\"https://doc.rust-lang.org/std/ops/struct.Range.html\" rel=\"noreferrer\">double dots</a> don't include the end bound, triple dots were used for inclusive ranges, i.e. <code>(0...2)</code> would contain <code>2</code> as well. This is now obsolete; use <a href=\"https://doc.rust-lang.org/std/ops/struct.RangeInclusive.html\" rel=\"noreferrer\"><code>..=</code></a> for this purpose instead.</p>\n"}], "owner": {"reputation": 269, "user_id": 9025957, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/7v7wS.png?s=128&g=1", "display_name": "typo", "link": "https://stackoverflow.com/users/9025957/typo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 595, "favorite_count": 0, "accepted_answer_id": 53610257, "answer_count": 1, "score": 6, "last_activity_date": 1543917781, "creation_date": 1543917526, "last_edit_date": 1543917781, "question_id": 53610214, "link": "https://stackoverflow.com/questions/53610214/what-is-the-difference-between-and", "title": "What is the difference between .. and ...?", "body": "<p>The title is pretty much self-explanatory: When should one use the double-dots <code>..</code> and when the triple-dots <code>...</code>? Both are used to indicate a range.</p>\n"}, {"tags": ["hashmap", "rust", "function-pointers"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1543916449, "post_id": 53609576, "comment_id": 94080893, "body": "Each named function is still a separate type. In this case, you can explicitly cast them to a function pointer: <code>(&quot;A&quot;, foo as fn(i32) -&gt; i32)</code> and so on."}, {"owner": {"reputation": 7542, "user_id": 1866775, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/4K99R.jpg?s=128&g=1", "display_name": "Tobias Hermann", "link": "https://stackoverflow.com/users/1866775/tobias-hermann"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1543917020, "post_id": 53609576, "comment_id": 94081266, "body": "@E_net4iskindandwelcoming <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=6d949dd762b004e0f97f102849230eac\" rel=\"nofollow noreferrer\">Works perfectory</a>, thanks. If you make your comment to an answer, I&#39;ll accept it."}], "owner": {"reputation": 7542, "user_id": 1866775, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/4K99R.jpg?s=128&g=1", "display_name": "Tobias Hermann", "link": "https://stackoverflow.com/users/1866775/tobias-hermann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 42, "favorite_count": 0, "closed_date": 1543919338, "answer_count": 0, "score": 1, "last_activity_date": 1543916260, "creation_date": 1543915663, "last_edit_date": 1543916260, "question_id": 53609576, "link": "https://stackoverflow.com/questions/53609576/how-do-i-create-a-hashmap-with-functions-as-values", "closed_reason": "Duplicate", "title": "How do I create a HashMap with functions as values?", "body": "<p>Give two functions:</p>\n\n<pre><code>fn foo(x: i32) -&gt; i32 {\n    return x + 1;\n}\n\nfn bar(x: i32) -&gt; i32 {\n    return x + 2;\n}\n</code></pre>\n\n<p>I can create a vector from them and iterate it like <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=9ccae81da921135ab001b0f61c5a16eb\" rel=\"nofollow noreferrer\">so</a>:</p>\n\n<pre><code>let function_vec: Vec&lt;fn(i32) -&gt; i32&gt; = [foo, bar].to_vec();\nfor function in function_vec {\n    let result = function(42);\n    println!(\"{:?}\", result);\n}\n</code></pre>\n\n<p>But when putting them as values into a dictionary, I'm doing something wrong:</p>\n\n<pre><code>let function_dict: HashMap&lt;&amp;str, fn(i32) -&gt; i32&gt; = [\n        (\"A\", foo),\n        (\"B\", bar)\n    ].iter().cloned().collect();\nfor (name, function) in function_dict {\n    let result = function(42);\n    println!(\"{}: {:?}\", name, result);\n}\n</code></pre>\n\n<p>It <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=b0985f2ca3b149538088e9c4512d472e\" rel=\"nofollow noreferrer\">fails</a> with:</p>\n\n<pre><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:14:19\n   |\n14 |             (\"B\", bar)\n   |                   ^^^ expected fn item, found a different fn item\n   |\n   = note: expected type `fn(i32) -&gt; i32 {foo}`\n              found type `fn(i32) -&gt; i32 {bar}`\n\nerror[E0277]: a collection of type `std::collections::HashMap&lt;&amp;str, fn(i32) -&gt; i32&gt;` cannot be built from an iterator over elements of type `(&amp;str, fn(i32) -&gt; i32 {foo})`\n  --&gt; src/main.rs:15:27\n   |\n15 |         ].iter().cloned().collect();\n   |                           ^^^^^^^ a collection of type `std::collections::HashMap&lt;&amp;str, fn(i32) -&gt; i32&gt;` cannot be built from `std::iter::Iterator&lt;Item=(&amp;str, fn(i32) -&gt; i32 {foo})&gt;`\n   |\n   = help: the trait `std::iter::FromIterator&lt;(&amp;str, fn(i32) -&gt; i32 {foo})&gt;` is not implemented for `std::collections::HashMap&lt;&amp;str, fn(i32) -&gt; i32&gt;`\n</code></pre>\n\n<p>What does the error mean? Why is the type <code>fn(i32) -&gt; i32 {foo}</code> and not just <code>fn(i32) -&gt; i32</code>?</p>\n"}, {"tags": ["rust", "iterator", "borrow-checker"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543865818, "post_id": 53600363, "comment_id": 94063741, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/50394209/155423\">How can I create an efficient iterator of chars from stdin with Rust?</a> and/or <a href=\"https://stackoverflow.com/q/47193584/155423\">Is there an owned version of String::chars?</a> / <a href=\"https://stackoverflow.com/q/43952104/155423\">How can I store a Chars iterator in the same struct as the String it is iterating on?</a>, just replace <code>chars</code> with appropriate logic."}], "answers": [{"comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543914844, "post_id": 53606081, "comment_id": 94079837, "body": "<code>std::string::String::split_whitespace</code> is a bit misleading, since <code>split_whitespace()</code> is in fact an inherent method on the primitive <code>str</code> type. The <code>&amp;String</code> is converted to <code>&amp;str</code> by a deref coercion."}], "tags": [], "owner": {"reputation": 22505, "user_id": 1411457, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/XqssD.png?s=128&g=1", "display_name": "harmic", "link": "https://stackoverflow.com/users/1411457/harmic"}, "is_accepted": true, "score": 1, "last_activity_date": 1543935427, "last_edit_date": 1543935427, "creation_date": 1543900471, "answer_id": 53606081, "question_id": 53600363, "link": "https://stackoverflow.com/questions/53600363/creating-word-iterator-from-line-iterator/53606081#53606081", "title": "Creating word iterator from line iterator", "body": "<p>In your example code, <code>lines</code> is an iterator over the lines read in from the reader you have obtained from <code>stdin</code>. As you say, it returns <code>String</code> instances, but you are not storing them anywhere.</p>\n\n<p><code>std::string::String::split_whitespace</code> is defined like this:</p>\n\n<pre><code>pub fn split_whitespace(&amp;self) -&gt; SplitWhitespace\n</code></pre>\n\n<p>So, it takes a reference to a string - it does not consume the string. It returns an iterator that yields string slices <code>&amp;str</code> - which reference portions of the string, but don't own it. </p>\n\n<p>In fact as soon as the closure you have passed to <code>flat_map</code> is done with it, no-one owns it, so it is dropped. That would leave the <code>&amp;str</code> yielded by <code>words</code> dangling, thus the error.</p>\n\n<p>One solution is to collect the lines into a vector, like this:</p>\n\n<pre><code>let lines: Vec&lt;String&gt; = stdin.lock().lines().map(|l| l.unwrap()).collect();\n\nlet words = lines.iter().flat_map(|l| l.split_whitespace());\n</code></pre>\n\n<p>The <code>String</code> instances are kept in the <code>Vec&lt;String&gt;</code>, which can live on so that the <code>&amp;str</code> yielded by <code>words</code> have something to refer to.</p>\n\n<p>If there were a lot of lines, and you did not want to keep them all in memory, you might prefer to do it a line at a time:</p>\n\n<pre><code>let lines = stdin.lock().lines().map(|l| l.unwrap());\n\nlet words = lines.flat_map(|l| {\n    l.split_whitespace()\n        .map(|s| s.to_owned())\n        .collect::&lt;Vec&lt;String&gt;&gt;()\n        .into_iter()\n});\n</code></pre>\n\n<p>Here the words of each line are collected into a <code>Vec</code>, a line at a time. The trade-off is less overall memory consumption, against the overhead of constructing a <code>Vec&lt;String&gt;</code> for each line, and copy each word into it.</p>\n\n<p>You might have been hoping for a zero-copy implementation, which consumed the <code>Strings</code> that <code>lines</code> produces. I think that would be possible to create, by creating a <code>split_whitespace()</code> function that takes ownership of the <code>String</code> and returns an iterator that owns the string.</p>\n"}], "owner": {"reputation": 63, "user_id": 10387080, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dbf1ecaf4f13feae25390e131dfc4466?s=128&d=identicon&r=PG&f=1", "display_name": "user10387080", "link": "https://stackoverflow.com/users/10387080/user10387080"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 301, "favorite_count": 0, "accepted_answer_id": 53606081, "answer_count": 1, "score": 0, "last_activity_date": 1543935427, "creation_date": 1543864436, "last_edit_date": 1543865678, "question_id": 53600363, "link": "https://stackoverflow.com/questions/53600363/creating-word-iterator-from-line-iterator", "title": "Creating word iterator from line iterator", "body": "<p>I have a string iterator <code>lines</code> that I get from stdin with</p>\n\n<pre><code>use std::io::{self, BufRead};\n\nlet mut stdin = io::stdin();\nlet lines = stdin.lock().lines().map(|l| l.unwrap());\n</code></pre>\n\n<p>The <code>lines</code> iterator yields values of type <code>String</code>, not <code>&amp;str</code>. I want to create an iterator that iterates over the input words instead of lines. It seems like this should be doable but my naive attempt does not work:</p>\n\n<pre><code>let words = lines.flat_map(|l| l.split_whitespace());\n</code></pre>\n\n<p>The compiler tells me that <code>l</code> is being dropped while still borrowed, which makes sense:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `l` does not live long enough\n --&gt; src/lib.rs:6:36\n  |\n6 |     let words = lines.flat_map(|l| l.split_whitespace());\n  |                                    ^                  - `l` dropped here while still borrowed\n  |                                    |\n  |                                    borrowed value does not live long enough\n7 | }\n  | - borrowed value needs to live until here\n</code></pre>\n\n<p>Is there some other clean way that accomplishes this?</p>\n"}, {"tags": ["sql", "rust", "rust-diesel"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1543851853, "creation_date": 1543851853, "answer_id": 53597142, "question_id": 53596947, "link": "https://stackoverflow.com/questions/53596947/how-do-i-create-a-custom-diesel-query-using-sql-functions-with-user-provided-inp/53597142#53597142", "title": "How do I create a custom Diesel query using SQL functions with user-provided inputs?", "body": "<p><a href=\"https://docs.rs/diesel/1.3.3/diesel/?search=function\" rel=\"nofollow noreferrer\">Searching the Diesel documentation for <code>function</code></a> leads directly to the <a href=\"https://docs.rs/diesel/1.3.3/diesel/macro.sql_function.html\" rel=\"nofollow noreferrer\"><code>sql_function</code></a> macro:</p>\n\n<blockquote>\n  <p>Diesel only provides support for a very small number of SQL functions. This macro enables you to add additional functions from the SQL standard, as well as any custom functions your application might have.</p>\n</blockquote>\n"}, {"tags": [], "owner": {"reputation": 301, "user_id": 7692787, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/BHZtQ.jpg?s=128&g=1", "display_name": "ludeed", "link": "https://stackoverflow.com/users/7692787/ludeed"}, "is_accepted": false, "score": 7, "last_activity_date": 1543954140, "last_edit_date": 1543954140, "creation_date": 1543871726, "answer_id": 53601989, "question_id": 53596947, "link": "https://stackoverflow.com/questions/53596947/how-do-i-create-a-custom-diesel-query-using-sql-functions-with-user-provided-inp/53601989#53601989", "title": "How do I create a custom Diesel query using SQL functions with user-provided inputs?", "body": "<p>This was the solution I ended up with:</p>\n\n<pre><code>pub fn get_near(lat: f32, lng: f32, conn: &amp;PgConnection) -&gt; Vec&lt;Places&gt; {\n    diesel::sql_query(\"SELECT * FROM places WHERE earth_box(ll_to_earth($1,$2), 20) @&gt; ll_to_earth(places.lat, places.lng)\")\n        .bind::&lt;diesel::sql_types::Float, _&gt;(lat)\n        .bind::&lt;diesel::sql_types::Float, _&gt;(lng)\n        .load(conn)\n        .expect(\"An error has occured\")\n}\n</code></pre>\n"}], "owner": {"reputation": 301, "user_id": 7692787, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/BHZtQ.jpg?s=128&g=1", "display_name": "ludeed", "link": "https://stackoverflow.com/users/7692787/ludeed"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1129, "favorite_count": 0, "answer_count": 2, "score": 3, "last_activity_date": 1543954140, "creation_date": 1543851285, "last_edit_date": 1543854091, "question_id": 53596947, "link": "https://stackoverflow.com/questions/53596947/how-do-i-create-a-custom-diesel-query-using-sql-functions-with-user-provided-inp", "title": "How do I create a custom Diesel query using SQL functions with user-provided inputs?", "body": "<p>I want to perform a query that uses custom SQL functions of PostGIS bundles. For instance, I can run the subsequent query with psql:</p>\n\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT * FROM places \nWHERE earth_box(ll_to_earth(40.6333125,-8.659492), 20)\n@&gt; ll_to_earth(places.lat, places.lng);\n</code></pre>\n\n<p><code>ll_to_earth</code> and <code>earth_box</code> are PostGIS functions. How can I make this query with Diesel with those values of <code>lat</code> and <code>lng</code> as input?</p>\n\n<p>I browsed the documentation but I can't wrap my head around it.</p>\n"}, {"tags": ["rust", "dbus", "networkmanager"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1543856106, "post_id": 53596315, "comment_id": 94059166, "body": "FWIW, that program runs OK on my machine, with NetworkManager v1.14.5-dev. I would actually consider upgrading NetworkManager on the target device."}, {"owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1544708261, "post_id": 53596315, "comment_id": 94377825, "body": "I updated network-manager on RPi 3B+ to 1.14.4, which is the latest I could find on Raspbian backports, but getting the same error."}], "owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 108, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1543849370, "creation_date": 1543849023, "last_edit_date": 1543849370, "question_id": 53596315, "link": "https://stackoverflow.com/questions/53596315/network-manager-throws-d-bus-failure-variant-type-does-not-match-match-variant", "title": "network-manager throws D-Bus failure: Variant type does not match match: Variant(Iter(UInt32))", "body": "<p>When I attempt to enumerate WiFi connections over dbus using the <a href=\"https://crates.io/crates/network-manager\" rel=\"nofollow noreferrer\">network-manager crate</a> in Rust, compiled and running on a Raspberry Pi 3B+ with Raspbian Stretch 9.4 and network-manager v1.6.2, <code>NetworkManager::get_connections</code> throws <code>D-Bus failure: Variant type does not match match: Variant(Iter(UInt32))</code>.</p>\n\n<p><code>nmcli</code> works fine via the command line, so I suspect an incompatibility between the network-manager version and dbus, so I tried upgrading to the latest <code>dbus=\"0.5.4\"</code> and `network-manager=\"0.11.2\" crates by cloning the repos manually, but same error. Perhaps I need to downgrade some of these components?</p>\n\n<p>Here is the entirety of my code:</p>\n\n<pre><code>extern crate network_manager;\n\nuse network_manager::{\n    AccessPoint, AccessPointCredentials, Connection, ConnectionState, Connectivity, Device,\n    DeviceType, NetworkManager, Security, ServiceState,\n};\n\nfn main() {\n    let manager = NetworkManager::new();\n    let connections = manager.get_connections().unwrap();\n}\n</code></pre>\n"}, {"tags": ["performance", "sorting", "vector", "rust", "partial-sort"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1543847167, "post_id": 53595750, "comment_id": 94053918, "body": "The standard library does not offer such functionality. Maybe a <a href=\"https://crates.io/search?q=partial%20sort\" rel=\"nofollow noreferrer\">crate</a> can solve your problem or <a href=\"https://doc.rust-lang.org/std/collections/struct.BinaryHeap.html\" rel=\"nofollow noreferrer\">BinaryHeap</a> which is always sorted?"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 3, "creation_date": 1543851404, "post_id": 53595750, "comment_id": 94056504, "body": "Using <code>BinaryHeap</code> from the standard library, it is pretty easy to implement this yourself. Basically, if you want to find the <code>k</code> smallest values from your vector, start by creating a heap from the first <code>k</code> values in your vector. Then iterate over the rest of the vector, and in each step add the current element to the heap and then remove the greatest element from the heap using <code>pop()</code>. Once you reached the end of the heap, use the <code>into_sorted_vec()</code> method to get the <code>k</code> smallest elements in sorted order."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1543851457, "post_id": 53595750, "comment_id": 94056546, "body": "@hellow I wouldn&#39;t call a binary heap &quot;always sorted&quot;."}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 1, "creation_date": 1543852408, "post_id": 53595750, "comment_id": 94057101, "body": "You could also keep track of the N biggest elements while populating the vector; it should be pretty simple as long as the populating code is contained in a single spot. You could also consider crafting a custom object containing the vector and a list of N biggest elements that automatically updates that list when it&#39;s populated (using a custom method)."}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543856819, "post_id": 53598332, "comment_id": 94059510, "body": "It looks like the crate might actually have the partially-sorted vector internally; I wonder if it would be &quot;trivial&quot; to expose that directly."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1543868382, "post_id": 53598332, "comment_id": 94064943, "body": "@Shepmaster Yes, it is trivial but lazysort use a stack to save its state, it&#39;s not necessary when you don&#39;t use an iterator."}], "tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 7, "last_activity_date": 1543868570, "last_edit_date": 1543868570, "creation_date": 1543856185, "answer_id": 53598332, "question_id": 53595750, "link": "https://stackoverflow.com/questions/53595750/how-do-i-partially-sort-a-vec-or-slice/53598332#53598332", "title": "How do I partially sort a Vec or slice?", "body": "<p>The standard library doesn't contain this functionality, but it looks like the <a href=\"https://crates.io/crates/lazysort\" rel=\"nofollow noreferrer\"><code>lazysort</code></a> crate is exactly what you need:</p>\n\n<blockquote>\n  <p>So what's the point of lazy sorting? As per the linked blog post, they're useful when you do not need or intend to need every value; for example you may only need the first 1,000 ordered values from a larger set.</p>\n</blockquote>\n\n<pre><code>#![feature(test)]\n\nextern crate lazysort;\nextern crate rand;\nextern crate test;\n\nuse std::cmp::Ordering;\n\ntrait SortLazy&lt;T&gt; {\n    fn sort_lazy&lt;F&gt;(&amp;mut self, cmp: F, n: usize)\n    where\n        F: Fn(&amp;T, &amp;T) -&gt; Ordering;\n    unsafe fn sort_lazy_fast&lt;F&gt;(&amp;mut self, cmp: F, n: usize)\n    where\n        F: Fn(&amp;T, &amp;T) -&gt; Ordering;\n}\n\nimpl&lt;T&gt; SortLazy&lt;T&gt; for [T] {\n    fn sort_lazy&lt;F&gt;(&amp;mut self, cmp: F, n: usize)\n    where\n        F: Fn(&amp;T, &amp;T) -&gt; Ordering,\n    {\n        fn sort_lazy&lt;F, T&gt;(data: &amp;mut [T], accu: &amp;mut usize, cmp: &amp;F, n: usize)\n        where\n            F: Fn(&amp;T, &amp;T) -&gt; Ordering,\n        {\n            if !data.is_empty() &amp;&amp; *accu &lt; n {\n                let mut pivot = 1;\n                let mut lower = 0;\n                let mut upper = data.len();\n                while pivot &lt; upper {\n                    match cmp(&amp;data[pivot], &amp;data[lower]) {\n                        Ordering::Less =&gt; {\n                            data.swap(pivot, lower);\n                            lower += 1;\n                            pivot += 1;\n                        }\n                        Ordering::Greater =&gt; {\n                            upper -= 1;\n                            data.swap(pivot, upper);\n                        }\n                        Ordering::Equal =&gt; pivot += 1,\n                    }\n                }\n                sort_lazy(&amp;mut data[..lower], accu, cmp, n);\n                sort_lazy(&amp;mut data[upper..], accu, cmp, n);\n            } else {\n                *accu += 1;\n            }\n        }\n        sort_lazy(self, &amp;mut 0, &amp;cmp, n);\n    }\n\n    unsafe fn sort_lazy_fast&lt;F&gt;(&amp;mut self, cmp: F, n: usize)\n    where\n        F: Fn(&amp;T, &amp;T) -&gt; Ordering,\n    {\n        fn sort_lazy&lt;F, T&gt;(data: &amp;mut [T], accu: &amp;mut usize, cmp: &amp;F, n: usize)\n        where\n            F: Fn(&amp;T, &amp;T) -&gt; Ordering,\n        {\n            if !data.is_empty() &amp;&amp; *accu &lt; n {\n                unsafe {\n                    use std::mem::swap;\n                    let mut pivot = 1;\n                    let mut lower = 0;\n                    let mut upper = data.len();\n                    while pivot &lt; upper {\n                        match cmp(data.get_unchecked(pivot), data.get_unchecked(lower)) {\n                            Ordering::Less =&gt; {\n                                swap(\n                                    &amp;mut *(data.get_unchecked_mut(pivot) as *mut T),\n                                    &amp;mut *(data.get_unchecked_mut(lower) as *mut T),\n                                );\n                                lower += 1;\n                                pivot += 1;\n                            }\n                            Ordering::Greater =&gt; {\n                                upper -= 1;\n                                swap(\n                                    &amp;mut *(data.get_unchecked_mut(pivot) as *mut T),\n                                    &amp;mut *(data.get_unchecked_mut(upper) as *mut T),\n                                );\n                            }\n                            Ordering::Equal =&gt; pivot += 1,\n                        }\n                    }\n                    sort_lazy(&amp;mut data[..lower], accu, cmp, n);\n                    sort_lazy(&amp;mut data[upper..], accu, cmp, n);\n                }\n            } else {\n                *accu += 1;\n            }\n        }\n        sort_lazy(self, &amp;mut 0, &amp;cmp, n);\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use test::Bencher;\n\n    use lazysort::Sorted;\n    use std::collections::BinaryHeap;\n    use SortLazy;\n\n    use rand::{thread_rng, Rng};\n\n    const SIZE_VEC: usize = 100_000;\n    const N: usize = 42;\n\n    #[bench]\n    fn sort(b: &amp;mut Bencher) {\n        b.iter(|| {\n            let mut rng = thread_rng();\n            let mut v: Vec&lt;i32&gt; = std::iter::repeat_with(|| rng.gen())\n                .take(SIZE_VEC)\n                .collect();\n            v.sort_unstable();\n        })\n    }\n\n    #[bench]\n    fn lazysort(b: &amp;mut Bencher) {\n        b.iter(|| {\n            let mut rng = thread_rng();\n            let v: Vec&lt;i32&gt; = std::iter::repeat_with(|| rng.gen())\n                .take(SIZE_VEC)\n                .collect();\n            let _: Vec&lt;_&gt; = v.iter().sorted().take(N).collect();\n        })\n    }\n\n    #[bench]\n    fn lazysort_in_place(b: &amp;mut Bencher) {\n        b.iter(|| {\n            let mut rng = thread_rng();\n            let mut v: Vec&lt;i32&gt; = std::iter::repeat_with(|| rng.gen())\n                .take(SIZE_VEC)\n                .collect();\n            v.sort_lazy(i32::cmp, N);\n        })\n    }\n\n    #[bench]\n    fn lazysort_in_place_fast(b: &amp;mut Bencher) {\n        b.iter(|| {\n            let mut rng = thread_rng();\n            let mut v: Vec&lt;i32&gt; = std::iter::repeat_with(|| rng.gen())\n                .take(SIZE_VEC)\n                .collect();\n            unsafe { v.sort_lazy_fast(i32::cmp, N) };\n        })\n    }\n\n    #[bench]\n    fn binaryheap(b: &amp;mut Bencher) {\n        b.iter(|| {\n            let mut rng = thread_rng();\n            let v: Vec&lt;i32&gt; = std::iter::repeat_with(|| rng.gen())\n                .take(SIZE_VEC)\n                .collect();\n\n            let mut iter = v.iter();\n            let mut heap: BinaryHeap&lt;_&gt; = iter.by_ref().take(N).collect();\n            for i in iter {\n                heap.push(i);\n                heap.pop();\n            }\n            let _ = heap.into_sorted_vec();\n        })\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>running 5 tests\ntest tests::binaryheap             ... bench:   3,283,938 ns/iter (+/- 413,805)\ntest tests::lazysort               ... bench:   1,669,229 ns/iter (+/- 505,528)\ntest tests::lazysort_in_place      ... bench:   1,781,007 ns/iter (+/- 443,472)\ntest tests::lazysort_in_place_fast ... bench:   1,652,103 ns/iter (+/- 691,847)\ntest tests::sort                   ... bench:   5,600,513 ns/iter (+/- 711,927)\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 5 measured; 0 filtered out\n</code></pre>\n\n<p>This code allows us to see that <code>lazysort</code> is faster than the solution with <code>BinaryHeap</code>. We can also see that <code>BinaryHeap</code> solution gets worse when <code>N</code> increases.</p>\n\n<p>The problem with <code>lazysort</code> is that it creates a second <code>Vec&lt;_&gt;</code>. A \"better\" solution would be to implement the partial sort in-place. I provided an example of such an implementation.</p>\n\n<p>Keep in mind that all these solutions come with overhead. When <code>N</code> is about <code>SIZE_VEC / 3</code>, the classic <code>sort</code> wins.</p>\n\n<p>You could submit an RFC/issue to ask about adding this feature to the standard library.</p>\n"}], "owner": {"reputation": 7542, "user_id": 1866775, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/4K99R.jpg?s=128&g=1", "display_name": "Tobias Hermann", "link": "https://stackoverflow.com/users/1866775/tobias-hermann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 979, "favorite_count": 0, "accepted_answer_id": 53598332, "answer_count": 1, "score": 6, "last_activity_date": 1543868570, "creation_date": 1543847056, "last_edit_date": 1543848009, "question_id": 53595750, "link": "https://stackoverflow.com/questions/53595750/how-do-i-partially-sort-a-vec-or-slice", "title": "How do I partially sort a Vec or slice?", "body": "<p>I need to get the top N items from a <code>Vec</code> which is quite large in production. Currently I do it like this inefficient way:</p>\n\n<pre><code>let mut v = vec![6, 4, 3, 7, 2, 1, 5];\nv.sort_unstable();\nv = v[0..3].to_vec();\n</code></pre>\n\n<p>In C++, I'd use <a href=\"https://en.cppreference.com/w/cpp/algorithm/partial_sort\" rel=\"noreferrer\"><code>std::partial_sort</code></a>, but I can't find an equivalent in the <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html\" rel=\"noreferrer\">Rust docs</a>.</p>\n\n<p>Am I just overlooking it, or does it not exist (yet)?</p>\n"}, {"tags": ["rust", "generic-programming"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543847365, "post_id": 53595542, "comment_id": 94054004, "body": "This feature is also known as <i>higher kinded types</i>, and Rust does not have it yet. Moreover, in Rust you can only access methods and associated types on generic type parameters that are provided by the trait bounds, in contrast to C++. There is no trait to describe a generic map in the Rust standard library, so you will have to define your own trait and use an assoicated type for the key type."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543847460, "post_id": 53595542, "comment_id": 94054054, "body": "Take a look at iterator in Rust."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1543848117, "post_id": 53595542, "comment_id": 94054438, "body": "You can probably abstract the map type with something like <code>M: Index&lt;K, Output=HashSet&lt;K&gt;&gt;</code> but I don&#39;t think there&#39;s an equivalent for abstracting the set type."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1543848328, "post_id": 53595542, "comment_id": 94054568, "body": "Although you can probably write your own trait to abstract between <code>HashSet</code> and <code>BTreeSet</code>\u2026"}, {"owner": {"reputation": 43, "user_id": 10739302, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/578bd4012e3d05f886bcf7752f1caab2?s=128&d=identicon&r=PG&f=1", "display_name": "user10739302", "link": "https://stackoverflow.com/users/10739302/user10739302"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543849438, "post_id": 53595542, "comment_id": 94055313, "body": "@SvenMarnach So I need to write <code>trait GenericSet&lt;K&gt;</code> and <code>trait GenericMap&lt;K, V&gt;</code>, then <code>impl&lt;K&gt; GenericSet&lt;K&gt; for HashSet&lt;K&gt;</code>, etc. That makes sense, thanks."}], "answers": [{"tags": [], "owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "is_accepted": false, "score": 3, "last_activity_date": 1543849669, "last_edit_date": 1543849669, "creation_date": 1543849643, "answer_id": 53596462, "question_id": 53595542, "link": "https://stackoverflow.com/questions/53595542/how-do-i-express-generic-map-and-set-containers-in-rust/53596462#53596462", "title": "How do I express generic map and set containers in Rust?", "body": "<blockquote>\n  <p>What is Rust's solution for a generic container?</p>\n</blockquote>\n\n<p>The ideal solution for generic containers is not available <em>yet</em>. This would be covered by a feature currently in the implementation phase, <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1598-generic_associated_types.md\" rel=\"nofollow noreferrer\">generic associated types (GATs)</a>.</p>\n\n<p>For the time being, there are ways to make your routines generic for certain use cases. In particular, it is common for a function to receiving an arbitrary sequence of data through a value that implements <code>IntoIterator</code>:</p>\n\n<pre><code>fn my_number_process&lt;I&gt;(stream: I) -&gt; f32\nwhere\n    I: IntoIterator&lt;Item = f32&gt;,\n{\n    stream.into_iter().map(|x| x * 2. + 5.).sum().unwrap_or(0.)\n}\n</code></pre>\n\n<p>For dictionary-like containers, the <a href=\"https://doc.rust-lang.org/std/ops/trait.Index.html\" rel=\"nofollow noreferrer\"><code>Index</code></a> and <a href=\"https://doc.rust-lang.org/std/ops/trait.IndexMut.html\" rel=\"nofollow noreferrer\"><code>IndexMut</code></a> traits expose the specific functionality of obtaining a reference to a value in the receiver by a key with a known type. The methods in both cases return <code>&amp;Self::Output</code>, leaving no room for recoverable errors or other kinds of outputs.\nAs an alternative, you can create a new trait that suits the purpose while attempting to overcome the lack of higher-kinded types. In particular, the trait below cannot be implemented for a plain <code>HashMap</code>:</p>\n\n<pre><code>trait IMap&lt;K&gt; {\n    type Value;\n\n    fn get&lt;B: Borrow&lt;K&gt;&gt;(&amp;self, key: B) -&gt; Option&lt;Self::Value&gt;;\n}\n</code></pre>\n\n<p>This is because we cannot specify <code>Value</code> as a <code>&amp;'a V</code> where <code>'a</code> is a lifetime that would be instantiated as the lifetime of <code>self</code>. However, it can be implemented for a reference to <code>HashMap</code>:</p>\n\n<pre><code>impl&lt;'a, K, V&gt; IMap&lt;K&gt; for &amp;'a HashMap&lt;K, V&gt;\nwhere\n    K: Eq,\n    K: Hash,\n{\n    type Value = &amp;'a V;\n\n    fn get&lt;B: Borrow&lt;K&gt;&gt;(&amp;self, key: B) -&gt; Option&lt;Self::Value&gt; {\n        HashMap::get(self, key.borrow())\n    }\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=561e51ab9f0d7b06f67632c7fb6521bc\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p>A similar reasoning can be employed to a generic <code>Set</code> container.</p>\n"}, {"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 1, "last_activity_date": 1543849663, "creation_date": 1543849663, "answer_id": 53596465, "question_id": 53595542, "link": "https://stackoverflow.com/questions/53595542/how-do-i-express-generic-map-and-set-containers-in-rust/53596465#53596465", "title": "How do I express generic map and set containers in Rust?", "body": "<p>This is the closest I could come:</p>\n\n<pre><code>use std::collections::*;\nuse std::hash::Hash;\nuse std::ops::Index;\n\ntrait Set&lt;K&gt; {\n    fn does_contain(&amp;self, value: &amp;K) -&gt; bool;\n}\nimpl&lt;K: Eq + Hash&gt; Set&lt;K&gt; for HashSet&lt;K&gt; {\n    fn does_contain(&amp;self, value: &amp;K) -&gt; bool {\n        self.contains (value)\n    }\n}\nimpl&lt;K: Eq + Ord&gt; Set&lt;K&gt; for BTreeSet&lt;K&gt; {\n    fn does_contain(&amp;self, value: &amp;K) -&gt; bool {\n        self.contains (value)\n    }\n}\n\nfn topological_sort&lt;K, S: Set&lt;K&gt;, M: Index&lt;K, Output=S&gt;&gt; (depmp: &amp;M) -&gt; Option&lt;Vec&lt;K&gt;&gt; {\n    unimplemented!()\n}\n</code></pre>\n\n<p>It uses <a href=\"https://doc.rust-lang.org/stable/std/ops/trait.Index.html\" rel=\"nofollow noreferrer\"><code>std::ops::Index</code></a> to abstract over the map type and a custom <code>Set</code> trait to abstract over the set type.</p>\n"}], "owner": {"reputation": 43, "user_id": 10739302, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/578bd4012e3d05f886bcf7752f1caab2?s=128&d=identicon&r=PG&f=1", "display_name": "user10739302", "link": "https://stackoverflow.com/users/10739302/user10739302"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1336, "favorite_count": 1, "accepted_answer_id": 53596465, "answer_count": 2, "score": 2, "last_activity_date": 1543849669, "creation_date": 1543846212, "last_edit_date": 1543849662, "question_id": 53595542, "link": "https://stackoverflow.com/questions/53595542/how-do-i-express-generic-map-and-set-containers-in-rust", "title": "How do I express generic map and set containers in Rust?", "body": "<p>I'm learning Rust coming from a C++ background and I'm writing a topological sort.</p>\n\n<p>The input is a dependency map with type <code>Map&lt;Key, Set&lt;Key&gt;&gt;</code>, where every node (key) is mapped to its dependency (a set of keys). <code>Map</code> and <code>Set</code> can be any <code>Map</code> and <code>Set</code> implementation. The output is a vector with sorted topological order.</p>\n\n<p>In C++, I would use a \"template template parameter\" for both <code>Map</code> and <code>Set</code>:</p>\n\n<pre class=\"lang-cpp prettyprint-override\"><code>template&lt;\n    class K,\n    template&lt;class...&gt; class Map,\n    template&lt;class...&gt; class Set\n&gt;\nstd::vector&lt;K&gt;\ntopological_sort(Map&lt;K, Set&lt;K&gt;&gt; const &amp;depmap);\n</code></pre>\n\n<p>This function can apply to <code>map&lt;Key, set&lt;Key&gt;&gt;</code> or <code>unordered_map&lt;Key, set&lt;Key&gt;&gt;</code> or <code>map&lt;Key, unordered_set&lt;Key&gt;&gt;</code>, etc.</p>\n\n<p>In Rust, it seems there is no \"template template parameter\". I can write the following:</p>\n\n<pre><code>fn topological_sort&lt;K: Eq + Ord + Hash + Clone&gt;(depmp: &amp;BTreeMap&lt;K, HashSet&lt;K&gt;&gt;) -&gt; Option&lt;Vec&lt;K&gt;&gt; {\n}\n</code></pre>\n\n<p>But then the code isn't generic in terms of the container choice, since it won't work for <code>HashMap&lt;K, HashSet&lt;K&gt;&gt;</code>, etc.</p>\n\n<p>I tried the hypothetical syntax:</p>\n\n<pre><code>fn topological_sort&lt;Map, Set, K: Eq + Ord + Hash + Clone&gt;(depmp: &amp;Map::&lt;K, Set::&lt;K&gt;&gt;) -&gt; Option&lt;Vec&lt;K&gt;&gt;\n</code></pre>\n\n<p>This does not work. What is Rust's solution for a generic container?</p>\n"}, {"tags": ["rust", "serial-port"], "comments": [{"owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "edited": false, "score": 0, "creation_date": 1543852140, "post_id": 53594577, "comment_id": 94056948, "body": "Can those voting to close and downvoting my question elaborate why a legitimate question, which now has a good answer describing the Rust-specific implementation is not appropriate for SO? As a result of asking, we&#39;ve learned there is no close method and you need to get the port out of scope to close it."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1543853675, "post_id": 53594577, "comment_id": 94057828, "body": "There doesn&#39;t seem to be any good answers; nothing is upvoted or accepted."}], "answers": [{"comments": [{"owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "edited": false, "score": 0, "creation_date": 1543843350, "post_id": 53594738, "comment_id": 94051900, "body": "I tried using <code>std::mem::drop(port); break;</code> in the loop I&#39;m trying to exit (that uses it), but I get &quot;value used here after move&quot;."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "reply_to_user": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "edited": false, "score": 0, "creation_date": 1543843481, "post_id": 53594738, "comment_id": 94051988, "body": "When you drop the value, you will give up ownership, you can&#39;t use it afterwards (just what the error says)."}, {"owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "edited": false, "score": 0, "creation_date": 1543843616, "post_id": 53594738, "comment_id": 94052085, "body": "I&#39;m not using it afterwards and I don&#39;t want to use it afterwards. Is there a way to do this in an &quot;unsafe&quot; way and exit the loop? I&#39;m time-constrained and I need to force the ref to be closed."}], "tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": false, "score": 1, "last_activity_date": 1543848347, "last_edit_date": 1543848347, "creation_date": 1543843195, "answer_id": 53594738, "question_id": 53594577, "link": "https://stackoverflow.com/questions/53594577/how-to-close-a-serial-port-in-rust-using-serialport-crate/53594738#53594738", "title": "How to close a serial port in Rust using serialport crate?", "body": "<p>The trait <a href=\"https://docs.rs/serialport/3.1.0/serialport/trait.SerialPort.html\" rel=\"nofollow noreferrer\"><code>Serialport</code></a> itself does not offer such functionality<sup>1</sup>.</p>\n\n<p>However the only implementor is <a href=\"https://docs.rs/serialport/3.1.0/serialport/posix/struct.TTYPort.html\" rel=\"nofollow noreferrer\"><code>TTYPort</code></a> and its doc states:</p>\n\n<blockquote>\n  <p>The port will be closed when the value is dropped.</p>\n</blockquote>\n\n<p>If you look at the <a href=\"https://docs.rs/serialport/3.1.0/src/serialport/posix/tty.rs.html#341\" rel=\"nofollow noreferrer\"><code>drop</code> implementation</a>, you can verify this behavior.</p>\n\n<p>So, you can either use <a href=\"https://doc.rust-lang.org/std/mem/fn.drop.html\" rel=\"nofollow noreferrer\"><code>std::mem::drop</code></a> directly or when the value goes out of scope the <code>Drop</code> implementation will be called (see <a href=\"https://doc.rust-lang.org/book/second-edition/ch15-03-drop.html\" rel=\"nofollow noreferrer\">the book</a> about this chapter.).</p>\n\n<hr>\n\n<p><sup>1</sup> I would suggest opening a issue on the GitHub repository and request the functionality.</p>\n"}], "owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 336, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1543852310, "creation_date": 1543842717, "last_edit_date": 1543852310, "question_id": 53594577, "link": "https://stackoverflow.com/questions/53594577/how-to-close-a-serial-port-in-rust-using-serialport-crate", "title": "How to close a serial port in Rust using serialport crate?", "body": "<p>How do I close a serial port that I've opened? I can't see any hint about how to do this in the <a href=\"https://docs.rs/serialport/3.1.0/serialport/\" rel=\"nofollow noreferrer\">docs for serialport</a>. </p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 13, "user_id": 10737660, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-GONN4TD_M9g/AAAAAAAAAAI/AAAAAAAAAAA/AGDgw-gShqYeE1Mt-3a6zCX2RKw_pxKsZg/mo/photo.jpg?sz=128", "display_name": "nova rusta", "link": "https://stackoverflow.com/users/10737660/nova-rusta"}, "edited": false, "score": 0, "creation_date": 1543829083, "post_id": 53590346, "comment_id": 94044518, "body": "I was aware of the first suggestion I had ruled that out because it was not explicit enough and if I changed the enum then it would still compile without giving further warning (Sorry I forgot I had considered that).  The second is definitely the one I prefer, I do wish I could keep the assignment to the match arms it feels like a more natural way of describing it, still better then a clone. But the compiler making sure each case is covered is what makes it better then the first for me"}], "tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": true, "score": 2, "last_activity_date": 1543850499, "last_edit_date": 1543850499, "creation_date": 1543827473, "answer_id": 53590346, "question_id": 53589524, "link": "https://stackoverflow.com/questions/53589524/how-do-i-use-match-to-modify-a-mutable-variable-in-a-way-that-is-guaranteed-to-b/53590346#53590346", "title": "How do I use match to modify a mutable variable in a way that is guaranteed to be non-exhaustive and not require clone?", "body": "<p>If you want to pass a value unchanged, just capture the match with a variable and pass that back, e.g.</p>\n\n<pre><code>fn foo(a: u32) -&gt; u32 {\n    match a {\n        0 =&gt; 1,\n        1 =&gt; 2,\n        e =&gt; e,\n    }\n}\n</code></pre>\n\n<p>In your case, I would move the variable assignment into the match arms</p>\n\n<pre><code>for x in things.iter_mut() {\n    match x {\n        Bar::Nothing =&gt; *x = Bar::AlsoNothing,\n        Bar::AlsoNothing =&gt; *x = Bar::SomeStuff(Stuff { num: 3, thing: true }),\n        _ =&gt; {},\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 13, "user_id": 10737660, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-GONN4TD_M9g/AAAAAAAAAAI/AAAAAAAAAAA/AGDgw-gShqYeE1Mt-3a6zCX2RKw_pxKsZg/mo/photo.jpg?sz=128", "display_name": "nova rusta", "link": "https://stackoverflow.com/users/10737660/nova-rusta"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 105, "favorite_count": 0, "accepted_answer_id": 53590346, "answer_count": 1, "score": 1, "last_activity_date": 1543850499, "creation_date": 1543823475, "last_edit_date": 1543850444, "question_id": 53589524, "link": "https://stackoverflow.com/questions/53589524/how-do-i-use-match-to-modify-a-mutable-variable-in-a-way-that-is-guaranteed-to-b", "title": "How do I use match to modify a mutable variable in a way that is guaranteed to be non-exhaustive and not require clone?", "body": "<p>When using a <code>match</code> to modify a mutable variable, I haven't found a way to use <code>match</code> in a way that is guaranteed to be non-exhaustive and not requiring <code>clone</code>.</p>\n\n<pre><code>struct Stuff {\n    num: u32,\n    thing: bool,\n}\n\nenum Bar {\n    Nothing,\n    SomeStuff(Stuff),\n    AlsoNothing,\n}\n\nfn main() {\n    let mut things = vec![Bar::SomeStuff(Stuff {\n        num: 2,\n        thing: false,\n    })];\n\n    for x in things.iter_mut() {\n        *x = match *x {\n            Bar::Nothing =&gt; Bar::AlsoNothing,\n            Bar::AlsoNothing =&gt; Bar::SomeStuff(Stuff {\n                num: 3,\n                thing: true,\n            }),\n            Bar::SomeStuff(thing) =&gt; panic!(\"not sure\"),\n        }\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of borrowed content\n  --&gt; src/main.rs:19:20\n   |\n19 |         *x = match *x {\n   |                    ^^ cannot move out of borrowed content\n...\n25 |             Bar::SomeStuff(thing) =&gt; panic!(\"not sure\"),\n   |                            ----- hint: to prevent move, use `ref thing` or `ref mut thing`\n</code></pre>\n\n<p>My intent is to write <code>Bar::SomeStuff(thing) =&gt; Bar::SomeStuff(thing)</code> and effectively leave it unchanged, but I cannot move through with a borrow or a reference.</p>\n\n<p><code>Bar::SomeStuff(thing.clone())</code> could work, but copying a big struct could be very expensive.</p>\n\n<p>Removing the <code>*x =</code> and changing to <code>()</code> could also work, but I am only returning a <code>Bar</code> enum so having the compiler check the return type is something I hope to keep.</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": true, "score": 26, "last_activity_date": 1602138403, "last_edit_date": 1602138403, "creation_date": 1543823068, "answer_id": 53589431, "question_id": 53588819, "link": "https://stackoverflow.com/questions/53588819/how-to-restrict-the-construction-of-struct/53589431#53589431", "title": "How to restrict the construction of struct?", "body": "<p>No, you cannot create that struct from member initialization and therefore your question is already the answer.</p>\n<p>This is because members are by default private and cannot be used directly. Only the immediate module and its submodules can access private fields, functions, ... (see <a href=\"https://doc.rust-lang.org/1.30.0/book/2018-edition/ch07-02-controlling-visibility-with-pub.html#privacy-rules\" rel=\"noreferrer\">the book about visibility</a>).</p>\n<pre><code>mod foo {\n    pub struct Person {\n        name: String,\n        age: u8,\n    }\n\n    impl Person {\n        pub fn new(age: u8, name: String) -&gt; Person {\n            if age &lt; 18 {\n                panic!(&quot;Can not create instance&quot;);\n            }\n            Person { age, name }\n        }\n    }\n}\n\nuse foo::Person; // imagine foo is an external crate\n\nfn main() {\n    let p = Person {\n        name: String::from(&quot;Peter&quot;),\n        age: 8,\n    };\n}\n</code></pre>\n<pre class=\"lang-none prettyprint-override\"><code>error[E0451]: field `name` of struct `Foo::Person` is private\nerror[E0451]: field `age` of struct `Foo::Person` is private\n</code></pre>\n<p>On the other hand, if you want to make it possible to create an instance by member initialization, use the <code>pub</code> keyword in front of all members.</p>\n<pre><code>pub struct Person {\n    pub name: String,\n    pub age: u8,\n}\n</code></pre>\n<p>Sometimes it's useful to let the user of your crate access the members directly, but you want to restrict the creation of an instance to your &quot;constructors&quot;. Just add a private field.</p>\n<pre><code>pub struct Person {\n    pub name: String,\n    pub age: u8,\n    _private: ()\n}\n</code></pre>\n<p>Because you cannot access <code>_private</code>, you cannot create an instance of <code>Person</code> directly.</p>\n<p>Also the <code>_private</code> field prevents creating a struct via the <a href=\"https://doc.rust-lang.org/1.45.0/book/ch05-01-defining-structs.html#creating-instances-from-other-instances-with-struct-update-syntax\" rel=\"noreferrer\">update syntax</a>, so this fails:</p>\n<pre><code>/// same code from above\n\nfn main() {\n    let p = Person::new(8, String::from(&quot;Peter&quot;));\n    let p2 = Person { age: 10, ..p };\n}\n</code></pre>\n<pre class=\"lang-none prettyprint-override\"><code>error[E0451]: field `_private` of struct `foo::Person` is private\n  --&gt; src/main.rs:27:34\n   |\n27 |     let p2 = Person { age: 10, ..p };\n   |                                  ^ field `_private` is private\n</code></pre>\n"}], "owner": {"reputation": 8658, "user_id": 6760995, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/90da0ebdca4b4b5e3f10c326b9b63ea0?s=128&d=identicon&r=PG&f=1", "display_name": "McGrady", "link": "https://stackoverflow.com/users/6760995/mcgrady"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1557, "favorite_count": 2, "accepted_answer_id": 53589431, "answer_count": 1, "score": 14, "last_activity_date": 1602138403, "creation_date": 1543819931, "last_edit_date": 1543822992, "question_id": 53588819, "link": "https://stackoverflow.com/questions/53588819/how-to-restrict-the-construction-of-struct", "title": "How to restrict the construction of struct?", "body": "<p>Is it possible to forbid creating an instances directly from member initialization?</p>\n\n<p>e.g.</p>\n\n<pre><code>pub struct Person {\n    name: String,\n    age: u8,\n}\n\nimpl Person {\n    pub fn new(age: u8, name: String) -&gt; Person {\n        if age &lt; 18 {\n            panic!(\"Can not create instance\");\n        }\n        Person { age, name }\n    }\n}\n</code></pre>\n\n<p>I can still use <code>Person {age: 6, name:String::from(\"mike\")}</code> to create instance. Is there anyway to avoid this?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1543924746, "post_id": 53587933, "comment_id": 94085724, "body": "I will blindly suggest to try updating xcode."}], "answers": [{"tags": [], "owner": {"reputation": 3209, "user_id": 5794048, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Egkox.jpg?s=128&g=1", "display_name": "Murphy", "link": "https://stackoverflow.com/users/5794048/murphy"}, "is_accepted": false, "score": 0, "last_activity_date": 1558554696, "last_edit_date": 1558554696, "creation_date": 1558554335, "answer_id": 56263930, "question_id": 53587933, "link": "https://stackoverflow.com/questions/53587933/how-do-i-fix-the-error-couldnt-load-codegen-backend-on-macos/56263930#56263930", "title": "How do I fix the error &quot;couldn&#39;t load codegen backend&quot; on macOS?", "body": "<p>I've experienced the same problem on a Gentoo system on x86. For some reason, the codegen libs have been installed to</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>/usr/lib/rust-1.34.2/rust-1.34.2/rustlib/i686-unknown-linux-gnu/codegen-backends\n</code></pre>\n\n<p>Note the repeated <code>rust-1.34.2</code> directory.</p>\n\n<p>My solution was to symlink the dir from the expected place; you must do this with <code>root</code> privileges:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code># cd /usr/lib/rust-1.34.2/rustlib/i686-unknown-linux-gnu/\n# ln -s ../../rust-1.34.2/rustlib/i686-unknown-linux-gnu/codegen-backends .\n</code></pre>\n\n<p>You may have to repeat that when a new version of Rust is installed.</p>\n"}], "owner": {"reputation": 11, "user_id": 1694940, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/0ALvt.jpg?s=128&g=1", "display_name": "Mountain King", "link": "https://stackoverflow.com/users/1694940/mountain-king"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 327, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558554750, "creation_date": 1543814789, "last_edit_date": 1558554750, "question_id": 53587933, "link": "https://stackoverflow.com/questions/53587933/how-do-i-fix-the-error-couldnt-load-codegen-backend-on-macos", "title": "How do I fix the error &quot;couldn&#39;t load codegen backend&quot; on macOS?", "body": "<p>main.rs:</p>\n\n<pre><code>fn main() {\n    println!(\"Hello world!\");\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ rustc main.rs:\nerror: couldn't load codegen backend \"/usr/local/lib/rustlib/i686-apple-darwin/codegen-backends/librustc_codegen_llvm-llvm.dylib\": \"dlsym(RTLD_DEFAULT, CFURLConnectionCreateWithProperties): symbol not found\"\n</code></pre>\n\n<p>I'm using macOS 10.11.6 with Rust 1.30.1 installed via rustup. gcc is <code>Apple LLVM version 8.0.0 (clang-800.0.42.1)</code>.</p>\n"}, {"tags": ["rust", "atomic"], "answers": [{"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 1, "last_activity_date": 1543826544, "creation_date": 1543826544, "answer_id": 53590148, "question_id": 53587866, "link": "https://stackoverflow.com/questions/53587866/what-is-the-difference-between-this-atomic-rust-code-and-its-non-atomic-coun/53590148#53590148", "title": "What is the difference between this &quot;atomic&quot; Rust code and its &quot;non-atomic&quot; counterpart?", "body": "<p>In the non-atomic case, this line:</p>\n\n<pre><code>self.layer2[p2].store(self.layer2[p2].load(Relaxed) | id.mask(SHIFT2), Relaxed);\n</code></pre>\n\n<p>is more or less equivalent to:</p>\n\n<pre><code>let tmp1 = self.layer2[p2];\nlet tmp2 = tmp1 | id.mask(SHIFT2);\nself.layer2[p2] = tmp2;\n</code></pre>\n\n<p>so another thread could change <code>self.layer2[p2]</code> between the moment it is read into <code>tmp1</code> and the moment <code>tmp2</code> is stored into it. So if another thread tries to set another bit at the same time, there is a risk that the following sequence occurs:</p>\n\n<ul>\n<li>thread 1 reads an empty mask,</li>\n<li>thread 2 reads an empty mask,</li>\n<li>thread 1 sets bit 1 of the mask and writes it,</li>\n<li>thread 2 sets bit 2 of the mask and writes it, thus overwriting the value set by thread 1,</li>\n<li>in the end only bit 2 is set!</li>\n</ul>\n\n<p>The same goes for <code>self.layer3</code>.</p>\n\n<p>In the atomic case, the use of <code>fetch_or</code> guarantees that the whole read-modify-write cycle is atomic.</p>\n\n<p>In both cases, since the ordering is relaxed, the writes to <code>layer2</code> and <code>layer3</code> may seem to occur in any order as seen from other threads.</p>\n\n<p>The comment inside <code>add_atomic</code> is meant avoid an issue when two threads try to add the same bit. Assume that <code>add_atomic</code> was written like this:</p>\n\n<pre><code>pub fn add_atomic(&amp;self, id: Index) -&gt; bool {\n    let (_, p1, p2) = offsets(id);\n\n    if self.layer1[p1].add(id) {\n        return true;\n    }\n\n    self.layer2[p2].fetch_or(id.mask(SHIFT2), Ordering::Relaxed);\n    self.layer3.fetch_or(id.mask(SHIFT3), Ordering::Relaxed);\n    false\n}\n</code></pre>\n\n<p>Then you risk the following sequence:</p>\n\n<ul>\n<li>thread 1 sets bit 1 in <code>layer1</code> and sees that it wasn't set beforehand,</li>\n<li>thread 2 tries to set bit 1 in <code>layer1</code> and sees that thread 1 already set it, so thread 2 returns from <code>add_atomic</code>,</li>\n<li>thread 2 executes another operation that requires reading <code>layer3</code>, <em>but <code>layer3</code> has not been updated yet, so thread 2 gets a wrong value!</em></li>\n<li>thread 1 updates <code>layer3</code>, but it is too late.</li>\n</ul>\n\n<p>This is why the <code>add_atomic</code> case ensures that <code>layer2</code> and <code>layer3</code> are set properly in all threads even if it looked like the bit was already set beforehand.</p>\n"}], "owner": {"reputation": 2581, "user_id": 1234443, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/9f4a7a9822caa42024e8e76b36e26964?s=128&d=identicon&r=PG", "display_name": "jchitel", "link": "https://stackoverflow.com/users/1234443/jchitel"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 330, "favorite_count": 1, "answer_count": 1, "score": 4, "last_activity_date": 1543826544, "creation_date": 1543814326, "question_id": 53587866, "link": "https://stackoverflow.com/questions/53587866/what-is-the-difference-between-this-atomic-rust-code-and-its-non-atomic-coun", "title": "What is the difference between this &quot;atomic&quot; Rust code and its &quot;non-atomic&quot; counterpart?", "body": "<p>I'm fairly new to Rust. I graduated with a Computer Engineering degree 4 years ago, and I remember discussing (and understanding) atomic operations in my Operating Systems course. However, since graduating, I've been working primarily in high-level languages where I haven't had to care about low-level stuff like atomics. Now that I'm getting into Rust, I'm struggling to remember how a lot of this stuff works.</p>\n\n<p>I'm currently trying to understand the source code for the <a href=\"https://github.com/slide-rs/hibitset\" rel=\"nofollow noreferrer\">hibitset</a> library, specifically <a href=\"https://github.com/slide-rs/hibitset/blob/master/src/atomic.rs\" rel=\"nofollow noreferrer\">atomic.rs</a>.</p>\n\n<p>This module specifies an <code>AtomicBitSet</code> type which corresponds to the <code>BitSet</code> type from lib.rs, but using atomic values and operations. From my understanding, an \"atomic operation\" is an operation that is guaranteed to not be interrupted by another thread; any \"load\" or \"store\" on the same value will have to wait for the operation to finish before proceeding. Following from this definition, an \"atomic value\" is a value whose operations are fully atomic. <code>AtomicBitSet</code> uses <code>AtomicUsize</code>, which is a <code>usize</code> wrapper where all methods are fully atomic. However, <code>AtomicBitSet</code> specifies several operations that seem to not be atomic (<code>add</code> and <code>remove</code>), and there is one atomic operation: <code>add_atomic</code>. Looking at <code>add</code> vs <code>add_atomic</code>, I can't really tell what the difference is.</p>\n\n<p>Here is <code>add</code> (verbatim):</p>\n\n<pre><code>/// Adds `id` to the `BitSet`. Returns `true` if the value was\n/// already in the set.\n#[inline]\npub fn add(&amp;mut self, id: Index) -&gt; bool {\n    use std::sync::atomic::Ordering::Relaxed;\n\n    let (_, p1, p2) = offsets(id);\n    if self.layer1[p1].add(id) {\n        return true;\n    }\n\n    self.layer2[p2].store(self.layer2[p2].load(Relaxed) | id.mask(SHIFT2), Relaxed);\n    self.layer3\n        .store(self.layer3.load(Relaxed) | id.mask(SHIFT3), Relaxed);\n    false\n}\n</code></pre>\n\n<p>This method calls <code>load()</code> and <code>store()</code> directly. I'm assuming that the fact that it's using <code>Ordering::Relaxed</code> is what makes this method non-atomic, because another thread doing the same thing to a different index might clobber this operation.</p>\n\n<p>Here is <code>add_atomic</code> (verbatim):</p>\n\n<pre><code>/// Adds `id` to the `AtomicBitSet`. Returns `true` if the value was\n/// already in the set.\n///\n/// Because we cannot safely extend an AtomicBitSet without unique ownership\n/// this will panic if the Index is out of range.\n#[inline]\npub fn add_atomic(&amp;self, id: Index) -&gt; bool {\n    let (_, p1, p2) = offsets(id);\n\n    // While it is tempting to check of the bit was set and exit here if it\n    // was, this can result in a data race. If this thread and another\n    // thread both set the same bit it is possible for the second thread\n    // to exit before l3 was set. Resulting in the iterator to be in an\n    // incorrect state. The window is small, but it exists.\n    let set = self.layer1[p1].add(id);\n    self.layer2[p2].fetch_or(id.mask(SHIFT2), Ordering::Relaxed);\n    self.layer3.fetch_or(id.mask(SHIFT3), Ordering::Relaxed);\n    set\n}\n</code></pre>\n\n<p>This method uses <code>fetch_or</code> instead of calling <code>load</code> and <code>store</code> directly, which I'm assuming is what makes this method atomic.</p>\n\n<p>But why does the usage of <code>Ordering::Relaxed</code> still allow this to be considered atomic? I realize that the individual \"or\" operations are atomic, but the full method could be run at the same time as another thread. Wouldn't that have an impact?</p>\n\n<p>Moreover, why would a type like this expose non-atomic methods? Is it just for performance? That seems confusing to me. If I were to pick an <code>AtomicBitSet</code> over a <code>BitSet</code> because it's going to be used by more than one thread, I'd probably want to only use atomic operations on it. If I didn't I wouldn't be using it. Right?</p>\n\n<p>I'd also love an explanation of the comment inside <code>add_atomic</code>. As-is it does not make sense to me. Doesn't the non-atomic version still have to care about that? It seems like the two methods are doing effectively the same thing, just with different levels of atomicity.</p>\n\n<p>I'd really just love some help wrapping my head around atomics. I <em>think</em> I  understand ordering after reading <a href=\"https://en.cppreference.com/w/cpp/atomic/memory_order\" rel=\"nofollow noreferrer\">this</a> and <a href=\"http://gcc.gnu.org/wiki/Atomic/GCCMM/AtomicSync\" rel=\"nofollow noreferrer\">this</a>, but both are still using concepts that I don't understand. When they talk about one thread \"seeing\" something from another, what does that mean exactly? When it's said that sequentially-consistent operations have the same order \"across all threads\" what does that even mean? Does the processor change the instruction order differently for different threads?</p>\n"}, {"tags": ["mongodb", "rust"], "answers": [{"comments": [{"owner": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "edited": false, "score": 0, "creation_date": 1543807639, "post_id": 53587069, "comment_id": 94037449, "body": "is <code>mongodb::oid::ObjectId::with_string(&amp;&quot;&quot;).unwrap()</code> works too ?"}, {"owner": {"reputation": 3796, "user_id": 8612835, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/sPwm6.jpg?s=128&g=1", "display_name": "Sachin Shah", "link": "https://stackoverflow.com/users/8612835/sachin-shah"}, "reply_to_user": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "edited": false, "score": 0, "creation_date": 1543807756, "post_id": 53587069, "comment_id": 94037479, "body": "@RejoLojey Sorry I don&#39;t know much in <code>rust</code>. I just help to by giving relevant links which may help you. I just suggest to try and error."}, {"owner": {"reputation": 3796, "user_id": 8612835, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/sPwm6.jpg?s=128&g=1", "display_name": "Sachin Shah", "link": "https://stackoverflow.com/users/8612835/sachin-shah"}, "reply_to_user": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "edited": false, "score": 0, "creation_date": 1543807807, "post_id": 53587069, "comment_id": 94037495, "body": "@RejoLojey Please check link, It may clear your queries."}, {"owner": {"reputation": 3796, "user_id": 8612835, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/sPwm6.jpg?s=128&g=1", "display_name": "Sachin Shah", "link": "https://stackoverflow.com/users/8612835/sachin-shah"}, "reply_to_user": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "edited": false, "score": 0, "creation_date": 1543808107, "post_id": 53587069, "comment_id": 94037577, "body": "@RejoLojey welcome, You may accept the answer or give upvote. It will be appreciated."}], "tags": [], "owner": {"reputation": 3796, "user_id": 8612835, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/sPwm6.jpg?s=128&g=1", "display_name": "Sachin Shah", "link": "https://stackoverflow.com/users/8612835/sachin-shah"}, "is_accepted": false, "score": 0, "last_activity_date": 1543807549, "creation_date": 1543807549, "answer_id": 53587069, "question_id": 53587026, "link": "https://stackoverflow.com/questions/53587026/generate-objectid-in-rust-mongo/53587069#53587069", "title": "generate ObjectId in rust mongo", "body": "<p>Try this way </p>\n\n<pre><code>let mongo_id = str.get_object_id(\"_id\").unwrap();\nlet mongo_id_hex = mongo_id.to_hex();\n</code></pre>\n\n<p>For more info please check this <a href=\"https://stackoverflow.com/questions/35070853/how-to-convert-the-rust-mongo-drivers-bson-type-to-objectid\">link</a></p>\n"}, {"tags": [], "owner": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "is_accepted": false, "score": 0, "last_activity_date": 1543808010, "creation_date": 1543808010, "answer_id": 53587116, "question_id": 53587026, "link": "https://stackoverflow.com/questions/53587026/generate-objectid-in-rust-mongo/53587116#53587116", "title": "generate ObjectId in rust mongo", "body": "<p>Generate ObjectId Object from string :</p>\n\n<pre><code>mongodb::oid::ObjectId::with_string(&amp;\"\").unwrap() // change &amp;\"\" with var or static value\n</code></pre>\n\n<p>References : </p>\n\n<ol>\n<li><a href=\"https://docs.rs/mongodb/0.3.12/mongodb/?search=object\" rel=\"nofollow noreferrer\">https://docs.rs/mongodb/0.3.12/mongodb/?search=object</a></li>\n<li><a href=\"https://docs.rs/mongodb/0.3.12/mongodb/oid/struct.ObjectId.html#method.with_string\" rel=\"nofollow noreferrer\">https://docs.rs/mongodb/0.3.12/mongodb/oid/struct.ObjectId.html#method.with_string</a></li>\n</ol>\n"}], "owner": {"reputation": 11, "user_id": 10735781, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/de6a686323af0c479ac281a156efab98?s=128&d=identicon&r=PG&f=1", "display_name": "Rejo Lojey", "link": "https://stackoverflow.com/users/10735781/rejo-lojey"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 640, "favorite_count": 0, "answer_count": 2, "score": 1, "last_activity_date": 1543808010, "creation_date": 1543807192, "question_id": 53587026, "link": "https://stackoverflow.com/questions/53587026/generate-objectid-in-rust-mongo", "title": "generate ObjectId in rust mongo", "body": "<p>i'm trying to convert String _id to a ObjectId object, what i'm already try :</p>\n\n<pre><code> use mongodb::{Bson, bson, doc};\n Bson::ObjectId(str) // failed to resolve\n bson::Bson::String // undeclared /&amp; private\n</code></pre>\n\n<p>library : <a href=\"https://github.com/mongodb-labs/mongo-rust-driver-prototype\" rel=\"nofollow noreferrer\">mongo-rust-driver-prototype</a></p>\n"}, {"tags": ["rust", "language-lawyer"], "comments": [{"owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "edited": false, "score": 0, "creation_date": 1543813709, "post_id": 53586321, "comment_id": 94038735, "body": "Strange! only pulling the <code>body.lock()</code> out, also gives the same error."}, {"owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "edited": false, "score": 0, "creation_date": 1543814250, "post_id": 53586321, "comment_id": 94038868, "body": "Seems like it wants the <code>MutexGuard</code> to live longer than the<code>Mutex</code> (<code>MutexGuard</code> borrows <code>Mutex</code> ). Not sure why!"}], "answers": [{"comments": [{"owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "edited": false, "score": 0, "creation_date": 1543824820, "post_id": 53588866, "comment_id": 94042633, "body": "Thanks! Cross-checking with <code>nll</code> always escapes me!"}], "tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 2, "last_activity_date": 1543820173, "creation_date": 1543820173, "answer_id": 53588866, "question_id": 53586321, "link": "https://stackoverflow.com/questions/53586321/why-do-i-get-does-not-live-long-enough-in-a-return-value/53588866#53588866", "title": "Why do I get &quot;does not live long enough&quot; in a return value?", "body": "<p>Using <code>#![feature(nll)]</code> this give a precise error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>   |\n19 |         resp: body.lock().unwrap().clone(),\n   |               ^^^^----------------\n   |               |\n   |               borrowed value does not live long enough\n   |               a temporary with access to the borrow is created here ...\n20 |     }\n21 | }\n   | -\n   | |\n   | `body` dropped here while still borrowed\n   | ... and the borrow might be used here, when that temporary is dropped and runs the `Drop`\n   | code for type `std::sync::MutexGuard`\n   |\n   = note: The temporary is part of an expression at the end of a block. Consider forcing\n   this temporary to be dropped sooner, before the block's local variables are dropped.\n   For example, you could save the expression's value in a new local variable `x` and then make\n   `x` be the expression at the end of the block.\n</code></pre>\n\n<p>Quite long BTW ;) It's because the temporary is drop after body, you could also do this:</p>\n\n<pre><code>pub fn get3() -&gt; Response {\n    let body = Mutex::new(\"a\".to_string());\n    let resp = body.lock().unwrap().clone();\n    Response {\n        resp,\n    }\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "edited": false, "score": 2, "creation_date": 1543892425, "post_id": 53592497, "comment_id": 94072368, "body": "This suggests that an alternate solution is to use <code>return Response { resp: body.lock().unwrap().clone() };</code>, (note the final <code>;</code> means this the return is not the tail of the block anymore). And indeed this compiles OK."}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 4, "last_activity_date": 1543835093, "creation_date": 1543835093, "answer_id": 53592497, "question_id": 53586321, "link": "https://stackoverflow.com/questions/53586321/why-do-i-get-does-not-live-long-enough-in-a-return-value/53592497#53592497", "title": "Why do I get &quot;does not live long enough&quot; in a return value?", "body": "<p>As pointed out in Stargateur's answer, the reason for this is the lifetime of temporaries. While Rust does not have a full specification yet, the language reference still is quite good and at least gives a hint to understand the behaviour. Here is the relevant part from the <a href=\"https://doc.rust-lang.org/reference/expressions.html#temporary-lifetimes\" rel=\"nofollow noreferrer\">section about temporary lifetimes</a>:</p>\n\n<blockquote>\n  <p>[T]he lifetime of temporary values is typically</p>\n  \n  <ul>\n  <li>the innermost enclosing statement; the tail expression of a block is considered part of the statement that encloses the block, or</li>\n  <li>the condition expression or the loop conditional expression if the temporary is created in the condition expression of an <code>if</code> or in the loop conditional expression of a <code>while</code> expression.</li>\n  </ul>\n</blockquote>\n\n<p>The innermost enclosing statement of <code>body.lock().unwrap()</code> in the second version of your function is the return expression. The spec above states that this expression is \"considered part of the statement that encloses the block\", which doesn't really exist in this case, but it still gives the right idea: All variables local to the function body are dropped <em>before</em> any temporaries in the return expression is dropped, so <code>body</code> is dropped before the MutexGuard that borrows <code>body</code>. The fix you found makes sure the temporary is dropped before <code>body</code>, since local variables are dropped roughly in reverse order of their creation.</p>\n"}], "owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 697, "favorite_count": 1, "accepted_answer_id": 53592497, "answer_count": 2, "score": 9, "last_activity_date": 1543849100, "creation_date": 1543800428, "last_edit_date": 1543849100, "question_id": 53586321, "link": "https://stackoverflow.com/questions/53586321/why-do-i-get-does-not-live-long-enough-in-a-return-value", "title": "Why do I get &quot;does not live long enough&quot; in a return value?", "body": "<p>In examining <a href=\"https://stackoverflow.com/questions/53585774/how-do-i-box-arc-and-mutexed-variables-in-rust\">How do I box Arc and Mutexed variables?</a>, I ran into an issue where code that looks OK is generating a \"does not live long enough\" error while constructing a return value from a <code>Mutex</code>. Simply pulling the <code>lock().unwrap()</code> access out of the return object removes the error - but I'd like to understand why Rust is complaining about a lifetime issue in this case.</p>\n\n<p>I was able to cut the code down to a very simple reproducer: The first function compiles OK, the second generates the error message, and they're almost identical.</p>\n\n<pre><code>use std::sync::Mutex;\n\npub struct Response {\n    resp: String,\n}\n\npub fn get() -&gt; Response {\n    let body = Mutex::new(\"a\".to_string());\n    let x: std::sync::MutexGuard&lt;_&gt; = body.lock().unwrap();\n    Response { resp: x.clone() }\n}\n\npub fn get2() -&gt; Response {\n    let body = Mutex::new(\"a\".to_string());\n    Response {\n        resp: body.lock().unwrap().clone(),\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `body` does not live long enough\n  --&gt; src/lib.rs:16:15\n   |\n16 |         resp: body.lock().unwrap().clone(),\n   |               ^^^^ borrowed value does not live long enough\n17 |     }\n18 | }\n   | - `body` dropped here while still borrowed\n   |\n   = note: values in a scope are dropped in the opposite order they are created\n</code></pre>\n"}, {"tags": ["multithreading", "rust", "mutex", "reference-counting"], "answers": [{"comments": [{"owner": {"reputation": 2384, "user_id": 3553432, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/fb2106952e54afdb0d370799f988ba25?s=128&d=identicon&r=PG", "display_name": "nikoss", "link": "https://stackoverflow.com/users/3553432/nikoss"}, "edited": false, "score": 0, "creation_date": 1543800185, "post_id": 53586212, "comment_id": 94036002, "body": "That deffinetely solves it but i dont understand since they are cloned what does it have to do with the lifetime of the tmp variable"}, {"owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "reply_to_user": {"reputation": 2384, "user_id": 3553432, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/fb2106952e54afdb0d370799f988ba25?s=128&d=identicon&r=PG", "display_name": "nikoss", "link": "https://stackoverflow.com/users/3553432/nikoss"}, "edited": false, "score": 1, "creation_date": 1543800525, "post_id": 53586212, "comment_id": 94036075, "body": "I&#39;m not 100% sure, I&#39;ve asked for a fuller explaination on a much reduced case here: <a href=\"https://stackoverflow.com/questions/53586321/value-does-not-live-long-enough-in-return-value\" title=\"value does not live long enough in return value\">stackoverflow.com/questions/53586321/&hellip;</a>."}], "tags": [], "owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "is_accepted": true, "score": 1, "last_activity_date": 1543892616, "last_edit_date": 1543892616, "creation_date": 1543799233, "answer_id": 53586212, "question_id": 53585774, "link": "https://stackoverflow.com/questions/53585774/how-do-i-box-arc-and-mutexed-variables/53586212#53586212", "title": "How do I box Arc and Mutexed variables?", "body": "<p>The key error seems to be this one:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `body` does not live long enough\n  --&gt; src/lib.rs:85:15\n   |\n85 |         resp: body.lock().unwrap().clone(),\n   |               ^^^^ borrowed value does not live long enough\n...\n89 | }\n   | - `body` dropped here while still borrowed\n   |\n   = note: values in a scope are dropped in the opposite order they are created\n</code></pre>\n\n<p>The same for the headers object.</p>\n\n<p>I was able to get a simplified reproducer of this by stubbing out a lot of your code:</p>\n\n<pre><code>use std::sync::{Arc, Mutex};\n\npub struct Response {\n    resp: String,\n    headers: Vec&lt;String&gt;,\n}\n\npub fn get(addr: &amp;str) -&gt; std::io::Result&lt;Box&lt;Response&gt;&gt; {\n    let headers: Vec&lt;String&gt; = Vec::with_capacity(10);\n    let headers = Arc::new(Mutex::new(headers));\n    let body = Arc::new(Mutex::new(String::with_capacity(1024)));\n    Ok(Box::new(Response {\n        resp: body.lock().unwrap().clone(),\n        headers: headers.lock().unwrap().clone(),\n    }))\n}\n</code></pre>\n\n<p>I think this has to do with the lifetimes of the temporary variables constructed in the final <code>Ok(Box::new(...))</code> return values. </p>\n\n<p>I was able to get it to compile by pulling the lock/unwrap outside.</p>\n\n<pre><code>let body = body.lock().unwrap();\nlet headers = headers.lock().unwrap();\nOk(Box::new(Response {\n    resp: body.clone(),\n    headers: headers.clone(),\n}))\n</code></pre>\n\n<hr>\n\n<p>From the fuller explaination given in <a href=\"https://stackoverflow.com/questions/53586321/value-does-not-live-long-enough-in-return-value\">Why do I get &quot;does not live long enough&quot; in a return value?</a> I've found that you can write this as</p>\n\n<pre><code>return Ok(Box::new(Response {\n    resp: body.lock().unwrap().clone(),\n    headers: headers.lock().unwrap().clone(),\n}));\n</code></pre>\n\n<p>i.e. adding an explicit <code>return</code> and a trailing semicolon. Though I have a feeling clippy might say that its bad style. </p>\n"}], "owner": {"reputation": 2384, "user_id": 3553432, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/fb2106952e54afdb0d370799f988ba25?s=128&d=identicon&r=PG", "display_name": "nikoss", "link": "https://stackoverflow.com/users/3553432/nikoss"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 106, "favorite_count": 0, "accepted_answer_id": 53586212, "answer_count": 1, "score": -1, "last_activity_date": 1603219677, "creation_date": 1543794697, "last_edit_date": 1603219677, "question_id": 53585774, "link": "https://stackoverflow.com/questions/53585774/how-do-i-box-arc-and-mutexed-variables", "title": "How do I box Arc and Mutexed variables?", "body": "<p>The following code gets some variables in closures and returns a struct containing that data.</p>\n\n<p>I can't return the struct with that data even when I box the struct and clone the variables; they are impossible to take out of this scope. I thought about using a callback closure but I don't really want to do that. Is there any way to take those out without having a callback? </p>\n\n<pre><code>pub fn get(addr: &amp;str) -&gt; std::io::Result&lt;Box&lt;Response&gt;&gt; {\n    use std::sync::{Arc, Mutex};\n    let mut crl = curl::easy::Easy::new();\n    crl.url(format!(\"{}{}\", API_ADDR, addr).as_str()).unwrap();\n\n    // extract headers\n    let headers: Vec&lt;String&gt; = Vec::with_capacity(10);\n    let headers = Arc::new(Mutex::new(headers));\n    {\n        let headers = headers.clone();\n        crl.header_function(move |h| {\n            let mut headers = headers.lock().unwrap();\n            (*headers).push(String::from_utf8_lossy(h).into_owned());\n            true\n        })\n        .unwrap();\n    }\n\n    // extract body\n    let body = Arc::new(Mutex::new(String::with_capacity(1024)));\n    {\n        let body = body.clone();\n        crl.write_function(move |b| {\n            let mut body = body.lock().unwrap();\n            body.push_str(std::str::from_utf8(b).unwrap());\n            Ok(b.len())\n        })\n        .unwrap();\n    }\n    crl.perform().unwrap();\n    Ok(Box::new(Response {\n        resp: body.lock().unwrap().clone(),\n        headers: headers.lock().unwrap().clone(),\n    }))\n}\n</code></pre>\n"}, {"tags": ["casting", "rust"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1543791136, "post_id": 53585299, "comment_id": 94034220, "body": "You will find other issues in that function even after fixing that one: in order to write data to <code>buffer</code>, it needs to be a mutable slice: <code>&amp;mut [u8]</code>."}], "answers": [{"tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 4, "last_activity_date": 1543791390, "creation_date": 1543791390, "answer_id": 53585414, "question_id": 53585299, "link": "https://stackoverflow.com/questions/53585299/how-do-i-write-a-u32-in-a-u8/53585414#53585414", "title": "How do I write a u32 in a &amp;[u8]?", "body": "<p>Use the <code>byteorder</code> crate:</p>\n\n<pre><code>extern crate byteorder; // 1.2.7\n\nuse byteorder::ByteOrder;\n\nfn put_pixel(x: u16, y: u16, color: u32, width: u16, height: u16, buffer: &amp;mut [u8]) {\n    let index = 0; // I'll calculate the right index later.\n\n    byteorder::NativeEndian::write_u32(&amp;mut buffer[index..index+4], color);\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=138df482e041fb1e215e7549d34e9d73\" rel=\"nofollow noreferrer\">Link to playground.</a></p>\n"}, {"tags": [], "owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "is_accepted": false, "score": 5, "last_activity_date": 1543836632, "last_edit_date": 1543836632, "creation_date": 1543791540, "answer_id": 53585437, "question_id": 53585299, "link": "https://stackoverflow.com/questions/53585299/how-do-i-write-a-u32-in-a-u8/53585437#53585437", "title": "How do I write a u32 in a &amp;[u8]?", "body": "<blockquote>\n  <p>Sounds logical, but I don't know how to \"cast\" the pixel into the array.</p>\n</blockquote>\n\n<p>It is not safe to convert a reference of <code>u8</code> into a reference of <code>u32</code>. And if the compiler let you assign a value of type <code>u32</code> into a <code>u8</code>, it have likely not have worked as you intended, since the value would have to be truncated into a single component so that it would fit in a single slice element. </p>\n\n<p>With that said, it is common to use <a href=\"https://docs.rs/byteorder/1.2.7/byteorder/\" rel=\"nofollow noreferrer\"><code>byteorder</code></a> for reading and writing such types from/to slices or other streams of binary data.</p>\n\n<pre><code>use byteorder::{LittleEndian, WriteBytesExt};\n\nfn put_pixel(x: u16, y: u16, color: u32, width: u16, height: u16, buffer: &amp;mut [u8]) {\n    let index = unimplemented!();\n    buffer[index..].write_u32::&lt;LittleEndian&gt;(color).unwrap();\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 1119, "user_id": 9406420, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4afd4d026590218c0aff8389c0ec7334?s=128&d=identicon&r=PG", "display_name": "Ritwik", "link": "https://stackoverflow.com/users/9406420/ritwik"}, "is_accepted": false, "score": 0, "last_activity_date": 1597510078, "creation_date": 1597510078, "answer_id": 63428533, "question_id": 53585299, "link": "https://stackoverflow.com/questions/53585299/how-do-i-write-a-u32-in-a-u8/63428533#63428533", "title": "How do I write a u32 in a &amp;[u8]?", "body": "<p>Source - <a href=\"https://users.rust-lang.org/t/how-to-serialize-a-u32-into-byte-array/986/5\" rel=\"nofollow noreferrer\">https://users.rust-lang.org/t/how-to-serialize-a-u32-into-byte-array/986/5</a></p>\n<pre class=\"lang-rust prettyprint-override\"><code>fn u32_to_u8_array(x: u32) -&gt; [u8; 4] {\n  let b1: u8 = ((x &gt;&gt; 24) &amp; 0xff) as u8;\n  let b2: u8 = ((x &gt;&gt; 16) &amp; 0xff) as u8;\n  let b3: u8 = ((x &gt;&gt; 8) &amp; 0xff) as u8;\n  let b4: u8 = (x &amp; 0xff) as u8;\n  \n  [b1, b2, b3, b4]\n}\n</code></pre>\n"}], "owner": {"reputation": 427, "user_id": 3520890, "user_type": "registered", "accept_rate": 0, "profile_image": "https://graph.facebook.com/1167498460/picture?type=large", "display_name": "Werem", "link": "https://stackoverflow.com/users/3520890/werem"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1171, "favorite_count": 0, "accepted_answer_id": 53585414, "answer_count": 3, "score": 2, "last_activity_date": 1597510078, "creation_date": 1543790420, "last_edit_date": 1543791038, "question_id": 53585299, "link": "https://stackoverflow.com/questions/53585299/how-do-i-write-a-u32-in-a-u8", "title": "How do I write a u32 in a &amp;[u8]?", "body": "<p>I'm trying to render an image. I wrote a <code>put_pixel</code> function to write a RGBA pixel into an array that represents the image. </p>\n\n<p>The image is one dimensional array that holds <code>i8</code> values(every byte is a component of the color). I'd like to write the color in a single step.</p>\n\n<pre><code>fn put_pixel(x: u16, y: u16, color: u32, width: u16, height: u16, buffer: &amp;[u8]) {\n    let index = 0; // I'll calculate the right index later.\n    buffer[index] as u32 = color; // I want to write the color here.\n}\n</code></pre>\n\n<p>So, this gave me an error saying that</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>45 |     buffer[index] = color;\n   |                     ^^^^^ expected u8, found u32\n</code></pre>\n\n<p>Sounds logical, but I don't know how to \"cast\" the pixel into the array.</p>\n"}, {"tags": ["error-handling", "rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543787720, "post_id": 53584631, "comment_id": 94033434, "body": "Rust follow semver, breaking change would imply that Rust up the major version so if you really found a regression it&#39;s a bug. If you can create an <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and specify both Rust version that show the regression, summit an issue, I didn&#39;t find any one about your case currently open."}, {"owner": {"reputation": 36166, "user_id": 393701, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/250889c646cd2a916920d9252f7c6f42?s=128&d=identicon&r=PG", "display_name": "SirDarius", "link": "https://stackoverflow.com/users/393701/sirdarius"}, "edited": false, "score": 2, "creation_date": 1543788534, "post_id": 53584631, "comment_id": 94033653, "body": "What <code>Result</code> type are you using here? <code>std::result::Result&lt;T, E&gt;</code> has always expected two types arguments, while <code>std::io::Result&lt;T&gt;</code> for example only needs one."}, {"owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "edited": false, "score": 1, "creation_date": 1543807639, "post_id": 53584631, "comment_id": 94037447, "body": "And what is the <code>Err</code> type you&#39;re feeding into this <code>Result</code> in the last case?"}, {"owner": {"reputation": 13606, "user_id": 527702, "user_type": "registered", "accept_rate": 63, "profile_image": "https://i.stack.imgur.com/LrH0d.jpg?s=128&g=1", "display_name": "hippietrail", "link": "https://stackoverflow.com/users/527702/hippietrail"}, "edited": false, "score": 0, "creation_date": 1606555807, "post_id": 53584631, "comment_id": 114998944, "body": "I just hit this in the Rust Cookbook&#39;s Directory Traversal example: <a href=\"https://rust-lang-nursery.github.io/rust-cookbook/file/dir.html\" rel=\"nofollow noreferrer\">rust-lang-nursery.github.io/rust-cookbook/file/dir.html</a>"}], "answers": [{"tags": [], "owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "is_accepted": true, "score": 28, "last_activity_date": 1610821668, "last_edit_date": 1610821668, "creation_date": 1543789868, "answer_id": 53585236, "question_id": 53584631, "link": "https://stackoverflow.com/questions/53584631/fn-foo-result-throws-expected-2-type-arguments/53585236#53585236", "title": "fn foo() -&gt; Result&lt;()&gt; throws &quot;expected 2 type arguments&quot;", "body": "<p>The definition of <code>Result</code> is, and has always been, the following:</p>\n<pre><code>pub enum Result&lt;T, E&gt; {\n    Ok(T),\n    Err(E),\n}\n</code></pre>\n<p>This definition is even presented in <a href=\"https://doc.rust-lang.org/stable/book/ch09-02-recoverable-errors-with-result.html\" rel=\"nofollow noreferrer\">the Rust Programming language</a>, to show how simple it is. As a generic sum type of an <em>OK</em> outcome and an <em>error</em> outcome, it always expects two type parameters, and the compiler will complain if it cannot infer them, or the list of type arguments does not have the expected length.</p>\n<p>On the other hand, one may find many libraries and respective docs showing a <code>Result</code> with a single type argument, as in <code>Result&lt;()&gt;</code>. What gives?</p>\n<p>It's still no magic. By convention, libraries create type <em>aliases</em> for result types at the level of a crate or module. This works pretty well because it is common for those to produce errors of the same, locally created type.</p>\n<pre><code>pub type Result&lt;T&gt; = Result&lt;T, Error&gt;;\n</code></pre>\n<p>Or alternatively, a definition which can still purport as the original result type.</p>\n<pre><code>pub type Result&lt;T, E = Error&gt; = Result&lt;T, E&gt;;\n</code></pre>\n<p>This pattern is so common that some error helper crates such as <a href=\"https://docs.rs/error-chain/0.12.0/error_chain/\" rel=\"nofollow noreferrer\"><code>error-chain</code></a>, will automatically create a result alias type for each error declared.\nAs such, if you are using a library that may or may not use <code>error-chain</code>, you are expected to assume that mentions of <code>Result&lt;T&gt;</code> are local type aliases to a domain-specific <code>Result&lt;T, Error&gt;</code>. In case of doubt, clicking on that type in the generated documentation pages will direct you to the concrete definition (in this case, the alias).</p>\n"}, {"tags": [], "owner": {"reputation": 8207, "user_id": 561624, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/994fe06ee0ece4ba833936e1e8f6dd7d?s=128&d=identicon&r=PG", "display_name": "E-rich", "link": "https://stackoverflow.com/users/561624/e-rich"}, "is_accepted": false, "score": 7, "last_activity_date": 1556497112, "creation_date": 1556497112, "answer_id": 55895676, "question_id": 53584631, "link": "https://stackoverflow.com/questions/53584631/fn-foo-result-throws-expected-2-type-arguments/55895676#55895676", "title": "fn foo() -&gt; Result&lt;()&gt; throws &quot;expected 2 type arguments&quot;", "body": "<p>From <a href=\"https://doc.rust-lang.org/stable/book/\" rel=\"noreferrer\">The Rust Programming Language</a> section <a href=\"https://doc.rust-lang.org/stable/book/ch09-02-recoverable-errors-with-result.html#the--operator-can-only-be-used-in-functions-that-return-result\" rel=\"noreferrer\">The ? Operator Can Only Be Used in Functions That Return Result</a></p>\n\n<pre><code>use std::error::Error;\nuse std::fs::File;\n\nfn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {\n    let f = File::open(\"hello.txt\")?;\n\n    Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 24901, "user_id": 198927, "user_type": "registered", "accept_rate": 55, "profile_image": "https://i.stack.imgur.com/eExki.jpg?s=128&g=1", "display_name": "Petrus Theron", "link": "https://stackoverflow.com/users/198927/petrus-theron"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 7823, "favorite_count": 6, "accepted_answer_id": 53585236, "answer_count": 2, "score": 15, "last_activity_date": 1610821668, "creation_date": 1543784854, "last_edit_date": 1586271291, "question_id": 53584631, "link": "https://stackoverflow.com/questions/53584631/fn-foo-result-throws-expected-2-type-arguments", "title": "fn foo() -&gt; Result&lt;()&gt; throws &quot;expected 2 type arguments&quot;", "body": "<p>Why isn't <code>Result&lt;()&gt;</code> allowed when compiling this bit of Rust code? Is it a breaking change between Rust editions?</p>\n\n<pre><code>fn run() -&gt; Result&lt;()&gt; {\n    let (tx, rx) = channel();\n\n    thread::spawn(move || {\n        do_things_with_tx(&amp;exit_tx);\n    });\n\n    match exit_rx.recv() {\n        Ok(result) =&gt; if let Err(reason) = result {\n            return Err(reason);\n        },\n        Err(e) =&gt; {\n            return Err(e.into());\n        },\n    }\n\n    Ok(())\n}\n</code></pre>\n\n<p>The compiler says:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0107]: wrong number of type arguments: expected 2, found 1\n    --&gt; src/main.rs:1000:18\n     |\n1000 | fn run_wifi() -&gt; Result&lt;()&gt; {\n     |                  ^^^^^^^^^^ expected 2 type arguments\n</code></pre>\n\n<p>When I tweak the return type to <code>Result&lt;(), Err&gt;</code>, it says: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0107]: wrong number of type arguments: expected 2, found 0\n    --&gt; src/main.rs:1000:29\n     |\n1000 | fn run() -&gt; Result&lt;(), Err&gt; {\n     |                        ^^^ expected 2 type arguments\n</code></pre>\n\n<p>This is from the <a href=\"https://github.com/balena-io/wifi-connect\" rel=\"noreferrer\">wifi-connect project</a>. </p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 36141, "user_id": 4354477, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/SuxtS.gif?s=128&g=1", "display_name": "ForceBru", "link": "https://stackoverflow.com/users/4354477/forcebru"}, "edited": false, "score": 0, "creation_date": 1543775613, "post_id": 53583332, "comment_id": 94030071, "body": "&quot;this isn&#39;t working&quot; is not a problem description. Are you getting errors? Which ones? Are you getting unexpected output? Which one did you expect?"}, {"owner": {"reputation": 3743, "user_id": 10630900, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/ece5V.png?s=128&g=1", "display_name": "Minn", "link": "https://stackoverflow.com/users/10630900/minn"}, "edited": false, "score": 1, "creation_date": 1543776137, "post_id": 53583332, "comment_id": 94030229, "body": "try <code>input.trim().as_ref()</code> to get rid of the tailing newline"}, {"owner": {"reputation": 23, "user_id": 7089860, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e4203fe6ff09ab7df58fcd3c539742db?s=128&d=identicon&r=PG&f=1", "display_name": "noob", "link": "https://stackoverflow.com/users/7089860/noob"}, "edited": false, "score": 0, "creation_date": 1543778457, "post_id": 53583332, "comment_id": 94030926, "body": "Yes, my problem is unexpected output. this code not working as i wanted. Always giving me &quot;Somethings wrong&quot;"}], "answers": [{"comments": [{"owner": {"reputation": 23, "user_id": 7089860, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e4203fe6ff09ab7df58fcd3c539742db?s=128&d=identicon&r=PG&f=1", "display_name": "noob", "link": "https://stackoverflow.com/users/7089860/noob"}, "edited": false, "score": 1, "creation_date": 1543830891, "post_id": 53583435, "comment_id": 94045453, "body": "Thanks sir. This is solving my problem."}], "tags": [], "owner": {"reputation": 36141, "user_id": 4354477, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/SuxtS.gif?s=128&g=1", "display_name": "ForceBru", "link": "https://stackoverflow.com/users/4354477/forcebru"}, "is_accepted": true, "score": 3, "last_activity_date": 1543777586, "last_edit_date": 1543777586, "creation_date": 1543776213, "answer_id": 53583435, "question_id": 53583332, "link": "https://stackoverflow.com/questions/53583332/why-does-a-string-read-from-stdin-never-match-the-strings-i-compare-it-to/53583435#53583435", "title": "Why does a string read from stdin never match the strings I compare it to?", "body": "<p>This doesn't match <code>\"test\"</code> even if (it looks like) you enter <code>\"test\"</code> because you're also inputting a new line by hitting Enter, so <code>input</code> will actually contain <code>\"test\\n\"</code>.</p>\n\n<p>You can solve this by removing the trailing newline using <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.trim_end\" rel=\"nofollow noreferrer\"><code>trim_end</code></a>:</p>\n\n<pre><code>match input.trim_end() {\n    \"test\" =&gt; println!(\"Great!\"),\n    _ =&gt; println!(\"Too bad\")\n}\n</code></pre>\n\n<p>This won't modify the original string, though.</p>\n"}], "owner": {"reputation": 23, "user_id": 7089860, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e4203fe6ff09ab7df58fcd3c539742db?s=128&d=identicon&r=PG&f=1", "display_name": "noob", "link": "https://stackoverflow.com/users/7089860/noob"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 250, "favorite_count": 0, "closed_date": 1543850658, "accepted_answer_id": 53583435, "answer_count": 1, "score": 0, "last_activity_date": 1543779220, "creation_date": 1543775511, "last_edit_date": 1543779220, "question_id": 53583332, "link": "https://stackoverflow.com/questions/53583332/why-does-a-string-read-from-stdin-never-match-the-strings-i-compare-it-to", "closed_reason": "Duplicate", "title": "Why does a string read from stdin never match the strings I compare it to?", "body": "<p>I am trying to <code>match</code> on a user-supplied string with this code:</p>\n\n<pre><code>use std::io;\n\nfn main() {\n    let mut input = String::new();\n\n    io::stdin().read_line(&amp;mut input).expect(\"Failed to read line.\");\n\n    match input.as_ref(){\n        \"test\" =&gt; println!(\"That was test\"),\n        _ =&gt; print!(\"Something's wrong\"),\n    }\n}\n</code></pre>\n\n<p>However, this code always prints \"Something's wrong\", even when I enter \"test\". How can I make this work as intended?</p>\n"}, {"tags": ["string", "rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543755230, "post_id": 53580258, "comment_id": 94024239, "body": "AFAIK, That depend of what is the real type of <code>S</code>, your function itself is zero cost, but his the user call you with <code>Vec&lt;dyn Into&lt;String&gt;&gt;</code> or similar well obviously this have a cost but not your function that the user who choice that."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543755523, "post_id": 53580258, "comment_id": 94024308, "body": "@Stargateur &quot;Zero-cost abstraction&quot; in Rust is usually meant in the sense that the abstraction has no overhead over a fully manual implementation. The first implementation performs optimally for all of <code>String</code>, <code>&amp;str</code> and <code>&amp;dyn Into&lt;String&gt;</code> \u2013 implementing separate constructors for these cases would not improve performance. The second implementation, on the other hand, does not perform optimally for <code>String</code>, since it unnecessarily copies the vector."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543755643, "post_id": 53580258, "comment_id": 94024349, "body": "@Stargateur Also note that <code>Vec&lt;dyn Into&lt;String&gt;&gt;</code> is not a valid type."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543755793, "post_id": 53580258, "comment_id": 94024392, "body": "@Lichtbringer You probably could implement this with unsafe code, but it would be tricky and involved, so my suggestion would be to only accept <code>String</code> in the <code>new()</code> constructor, and provide a separate constructor for the generic case."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543756677, "post_id": 53580258, "comment_id": 94024642, "body": "@SvenMarnach I don&#39;t agree, Rust compiler should see that <code>middle_names</code> is a noop. But optimisation is not sure. But I wasn&#39;t talking about the vector but just about the type inside. <code>middle_names</code> is not in the first implementation so the creation of the vector is not the sujet. So I didn&#39;t take it in account."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543761364, "post_id": 53580258, "comment_id": 94025841, "body": "@Stargateur My interpretation of the question is that it is exactly about that overhead for allocating a new vector and copying the entries, but I&#39;ll let the OP clarify."}, {"owner": {"reputation": 9509, "user_id": 257568, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6c736aafc7e3bfcf9f924d09bde3aa99?s=128&d=identicon&r=PG", "display_name": "ArtemGr", "link": "https://stackoverflow.com/users/257568/artemgr"}, "edited": false, "score": 0, "creation_date": 1543766168, "post_id": 53580258, "comment_id": 94027261, "body": "How about reserving some middle name space in the <code>Person</code> with, say, <code>middle_names: SmallVec&lt;[String; 1]&gt;</code>?"}, {"owner": {"user_type": "does_not_exist", "display_name": "user7677469"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543772149, "post_id": 53580258, "comment_id": 94029018, "body": "@SvenMarnach your interpretation aligns with my intent ;) so, yes: I would like to avoid the allocation and copying over if I already know that my <code>Vec&lt;S&gt;</code> is indeed a <code>Vec&lt;String&gt;</code>"}], "answers": [{"tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": false, "score": 2, "last_activity_date": 1543778316, "last_edit_date": 1543778316, "creation_date": 1543776813, "answer_id": 53583505, "question_id": 53580258, "link": "https://stackoverflow.com/questions/53580258/using-intostring-on-interfaces-zero-cost-for-vecintostring/53583505#53583505", "title": "Using Into&lt;String&gt; on interfaces - zero cost for Vec&lt;Into&lt;String&gt;&gt;?", "body": "<p>Here are a few solutions I can think of.</p>\n\n<h3>Implement two different constructors</h3>\n\n<p>You could implement two separate constructors \u2013 one for <code>S = String</code> and one for <code>S: Into&lt;String&gt;</code>. People will have to use different names for the two cases if they care about optimization.</p>\n\n<h3>Ignore the problem</h3>\n\n<p>I don't know about your actual use case, but this doesn't look like something that is likely to become a performance bottleneck for your application, so you could simply accept the tiny overhead. The string data itself won't be copied, only the metadata (a pointer, a length and a capacity), so the overhead is rather small.</p>\n\n<h3>Use specialization</h3>\n\n<p>Rust nightly partly support <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1210-impl-specialization.md\" rel=\"nofollow noreferrer\">specialization of traits</a>, so you can implement traits for overlapping sets of types. This allows you to implement a <code>IntoStringVec</code> trait with a specialization for <code>String</code> that does nothing</p>\n\n<pre><code>#![feature(specialization)]\n\ntrait IntoStringVec: Sized {\n    fn into_string_vec(v: Vec&lt;Self&gt;) -&gt; Vec&lt;String&gt;;\n}\n\nimpl IntoStringVec for String {\n    fn into_string_vec(v: Vec&lt;String&gt;) -&gt; Vec&lt;String&gt; {\n        v\n    }\n}\n\nimpl&lt;T: Into&lt;String&gt;&gt; IntoStringVec for T {\n    default fn into_string_vec(v: Vec&lt;Self&gt;) -&gt; Vec&lt;String&gt; {\n        v.into_iter().map(Into::into).collect()\n    }\n}\n</code></pre>\n\n<p>This solution requires to use Rust nightly.</p>\n\n<h3>Use unsafe code for an in-place conversion</h3>\n\n<p>You can implement an in-place conversion of the vector for the case that <code>size_of::&lt;S&gt;() == size_of::&lt;String&gt;()</code> and <code>align_of::&lt;S&gt;() &gt;= align_of::&lt;String&gt;()</code>. Doing this manually is a bit tricky to get right, so I'd recommend finding some crate that implements this, e.g. the <a href=\"https://docs.rs/map_in_place/0.1.0/map_in_place/\" rel=\"nofollow noreferrer\">map_in_place crate</a>.</p>\n\n<hr>\n\n<p>I would personally ignore the issue until it becomes an actual problem, and if it does, go with the first soltuion.</p>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user7677469"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 118, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1543778316, "creation_date": 1543754054, "last_edit_date": 1543755404, "question_id": 53580258, "link": "https://stackoverflow.com/questions/53580258/using-intostring-on-interfaces-zero-cost-for-vecintostring", "title": "Using Into&lt;String&gt; on interfaces - zero cost for Vec&lt;Into&lt;String&gt;&gt;?", "body": "<p>I am using <code>Into&lt;String&gt;</code> as a parameter type to allow creating <code>Person</code>s with e.g. <code>str</code> as well as an owned <code>String</code></p>\n\n<pre><code>pub struct Person {\n    pub first_name: String,\n    pub last_name: String,\n}\n\nimpl Person {\n    pub fn new&lt;S&gt;(first_name: S, last_name: S) -&gt; Self\n    where S: Into&lt;String&gt;\n    {\n        Self {\n           first_name: first_name.into(),\n           last_name: last_name.into(),\n        }\n    }\n}\n</code></pre>\n\n<p>As far as a I know, due to monomorphism, this is zero cost at runtime.</p>\n\n<p>Now, I am sure, this this is not zero cost:</p>\n\n<pre><code>pub struct Person {\n    pub first_name: String,\n    pub middle_names: Vec&lt;String&gt;,\n    pub last_name: String,\n}\n\nimpl Person {\n    pub fn new&lt;S&gt;(first_name: S, middle_names: Vec&lt;S&gt;, last_name: S) -&gt; Self\n    where S: Into&lt;String&gt;\n    {\n        let middle_names: Vec&lt;String&gt; = middle_names.into_iter().map(|s| s.into()).collect();\n\n        Self {\n            first_name: first_name.into(),\n            middle_names,\n            last_name: last_name.into(),\n        }\n    }\n}\n</code></pre>\n\n<p>I wonder if I can somehow make this going \"zero cost\". The <code>Vec</code> means that the data is on the heap, but maybe I can replace the <code>Vec</code> with some other useful data-structure or even a slice.</p>\n\n<p>Any ideas?</p>\n"}, {"tags": ["macros", "rust"], "answers": [{"comments": [{"owner": {"reputation": 7483, "user_id": 247482, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/da56018fec1036eb1e02305d09a0bce8?s=128&d=identicon&r=PG", "display_name": "flying sheep", "link": "https://stackoverflow.com/users/247482/flying-sheep"}, "edited": false, "score": 0, "creation_date": 1543823759, "post_id": 53582890, "comment_id": 94042235, "body": "Thank you very much! Specifically the <code>ty</code> remark probably saved me write some time debugging! I wish there was a more elegant and less repetitive way, but apparently that will only come with macros 2.0 which afaik will allow macros in meta item position."}], "tags": [], "owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "is_accepted": true, "score": 4, "last_activity_date": 1543772327, "creation_date": 1543772327, "answer_id": 53582890, "question_id": 53580165, "link": "https://stackoverflow.com/questions/53580165/is-it-possible-to-let-a-macro-expand-to-a-struct-field/53582890#53582890", "title": "Is it possible to let a macro expand to a struct field?", "body": "<p>Indeed, macro invocations are not valid in the middle of a struct definition. However, we can use metavariables there. The trick is to <a href=\"https://danielkeep.github.io/tlborm/book/pat-incremental-tt-munchers.html\" rel=\"nofollow noreferrer\">parse the parameters incrementally</a>, building the tokens for the field definitions along the way, and when there's no more input to process, emit a struct definition with the field definitions coming from a metavariable.</p>\n\n<p>As a first step, let's see what a macro that doesn't handle field types specifically looks like:</p>\n\n<pre><code>macro_rules! impl_extra {\n    ( @ $name:ident { } -&gt; ($($result:tt)*) ) =&gt; (\n        #[derive(Default, Debug, Serialize)]\n        pub struct $name {\n            $($result)*\n        }\n    );\n\n    ( @ $name:ident { $param:ident : $type:ty, $($rest:tt)* } -&gt; ($($result:tt)*) ) =&gt; (\n        impl_extra!(@ $name { $($rest)* } -&gt; (\n            $($result)*\n            pub $param : $type,\n        ));\n    );\n\n    ( $name:ident { $( $param:ident : $type:ty ),* $(,)* } ) =&gt; (\n        impl_extra!(@ $name { $($param : $type,)* } -&gt; ());\n    );\n}\n</code></pre>\n\n<p>The only thing this macro does is add <code>pub</code> on each field and define a <code>pub struct</code> with a <code>#[derive]</code> attribute. The first rule handles the terminal case, i.e. when there are no more fields to process. The second rule handles the recursive case, and the third rule handles the macro's \"public\" syntax and transforms it into the \"processing\" syntax.</p>\n\n<p>Note that I'm using an <code>@</code> as the initial token for internal rules to distinguish them from \"public\" rules. If this macro is not meant to be exported to other crates, then you could also move the internal rules to a different macro. If the macro is exported though, then the separate macro for the internal rules might have to be exported too.</p>\n\n<p>Now, let's handle the various field types:</p>\n\n<pre><code>macro_rules! impl_extra {\n    ( @ $name:ident { } -&gt; ($($result:tt)*) ) =&gt; (\n        #[derive(Default, Debug, Serialize)]\n        pub struct $name {\n            $($result)*\n        }\n    );\n\n    ( @ $name:ident { $param:ident : Option&lt;$type:ty&gt;, $($rest:tt)* } -&gt; ($($result:tt)*) ) =&gt; (\n        impl_extra!(@ $name { $($rest)* } -&gt; (\n            $($result)*\n            #[serde(skip_serializing_if = \"Option::is_none\")]\n            pub $param : Option&lt;$type&gt;,\n        ));\n    );\n\n    ( @ $name:ident { $param:ident : Vec&lt;$type:ty&gt;, $($rest:tt)* } -&gt; ($($result:tt)*) ) =&gt; (\n        impl_extra!(@ $name { $($rest)* } -&gt; (\n            $($result)*\n            #[serde(skip_serializing_if = \"Vec::is_empty\")]\n            pub $param : Vec&lt;$type&gt;,\n        ));\n    );\n\n    ( @ $name:ident { $param:ident : bool, $($rest:tt)* } -&gt; ($($result:tt)*) ) =&gt; (\n        impl_extra!(@ $name { $($rest)* } -&gt; (\n            $($result)*\n            #[serde(skip_serializing_if = \"bool::not\")]\n            pub $param : bool,\n        ));\n    );\n\n    ( $name:ident { $( $param:ident : $($type:tt)* ),* $(,)* } ) =&gt; (\n        impl_extra!(@ $name { $($param : $($type)*,)* } -&gt; ());\n    );\n}\n</code></pre>\n\n<p>Note that there's a difference in the last rule: instead of matching on a <code>ty</code>, we now match on a sequence of <code>tt</code>. That's because once the macro has parsed a <code>ty</code>, it can't be broken down, so when we make a recursive macro call, a <code>ty</code> cannot possibly match something like <code>Option&lt;$type:ty&gt;</code>.</p>\n"}], "owner": {"reputation": 7483, "user_id": 247482, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/da56018fec1036eb1e02305d09a0bce8?s=128&d=identicon&r=PG", "display_name": "flying sheep", "link": "https://stackoverflow.com/users/247482/flying-sheep"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1027, "favorite_count": 2, "accepted_answer_id": 53582890, "answer_count": 1, "score": 3, "last_activity_date": 1543772327, "creation_date": 1543753199, "question_id": 53580165, "link": "https://stackoverflow.com/questions/53580165/is-it-possible-to-let-a-macro-expand-to-a-struct-field", "title": "Is it possible to let a macro expand to a struct field?", "body": "<p>I would like to do the following, but macros in that position don\u2019t seem to work (I get <code>error: expected `:`, found `!`</code>. How can I pattern-match individual struct members and attach attributes to them based on the match?</p>\n\n<pre><code>use serde_derive::Serialize;\n\nmacro_rules! optional_param {\n    ($name:ident : Option&lt;$type:ty&gt;) =&gt; { #[serde(skip_serializing_if = \"Option::is_none\")] pub $name: Option&lt;$ty&gt; };\n    ($name:ident : Vec   &lt;$type:ty&gt;) =&gt; { #[serde(skip_serializing_if = \"Vec::is_empty\"  )] pub $name: Vec   &lt;$ty&gt; };\n    ($name:ident : bool            ) =&gt; { #[serde(skip_serializing_if = \"bool::not\"      )] pub $name: bool        };\n}\n\nmacro_rules! impl_extra {\n    ( $name:ident { $( $param:ident : $type:ty ),* $(,)* } ) =&gt; (\n        #[derive(Default,Debug,Serialize)]\n        pub struct $name {\n            $( optional_param!($param : $type), )*\n        }\n    );\n}\n\nimpl_extra!(MyStruct { member: Option&lt;String&gt; });\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=beta&amp;mode=debug&amp;edition=2018&amp;gist=7509fb64aa9723037cc43596cf02dbaf\" rel=\"nofollow noreferrer\">Link to the playground</a></p>\n"}, {"tags": ["rust", "thread-safety", "rayon", "interior-mutability"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543702258, "post_id": 53575183, "comment_id": 94015259, "body": "Literally in the beginning of README &quot;You may also enjoy <a href=\"http://smallcultfollowing.com/babysteps/blog/2015/12/18/rayon-data-parallelism-in-rust/\" rel=\"nofollow noreferrer\">this blog post</a> about Rayon, which gives more background and details about how it works&quot;"}, {"owner": {"reputation": 2438, "user_id": 185646, "user_type": "registered", "accept_rate": 96, "profile_image": "https://www.gravatar.com/avatar/01cc07930d88f6f16a6dbaa6590942f4?s=128&d=identicon&r=PG", "display_name": "skyde", "link": "https://stackoverflow.com/users/185646/skyde"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543705532, "post_id": 53575183, "comment_id": 94015955, "body": "All I could find is that it use Join which define the closure type as \u201cFnOnce() -&gt; R_A + Send\u201d but this does not explain why this type closure would not use any RefCell&lt;t&gt; internally!"}], "answers": [{"comments": [{"owner": {"reputation": 3480, "user_id": 2686821, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/5dd46afe4f5a75f2667569582b20ac9b?s=128&d=identicon&r=PG&f=1", "display_name": "soupybionics", "link": "https://stackoverflow.com/users/2686821/soupybionics"}, "edited": false, "score": 0, "creation_date": 1543745524, "post_id": 53578748, "comment_id": 94021964, "body": "Speaking of Sync/Send only, is there any type that is a <code>Sync</code> but not a <code>Send</code>?"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 3480, "user_id": 2686821, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/5dd46afe4f5a75f2667569582b20ac9b?s=128&d=identicon&r=PG&f=1", "display_name": "soupybionics", "link": "https://stackoverflow.com/users/2686821/soupybionics"}, "edited": false, "score": 1, "creation_date": 1543747018, "post_id": 53578748, "comment_id": 94022277, "body": "@soupybionics Of course you can define one, but there are also a few in the standard library, e.g. <code>MutexGuard</code>."}, {"owner": {"reputation": 3480, "user_id": 2686821, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/5dd46afe4f5a75f2667569582b20ac9b?s=128&d=identicon&r=PG&f=1", "display_name": "soupybionics", "link": "https://stackoverflow.com/users/2686821/soupybionics"}, "edited": false, "score": 0, "creation_date": 1543747979, "post_id": 53578748, "comment_id": 94022500, "body": "Thanks. Also if a type is <code>Sync</code> and <code>Copy</code>, there&#39;s no reason it can&#39;t be <code>Send</code>, right?"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 3480, "user_id": 2686821, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/5dd46afe4f5a75f2667569582b20ac9b?s=128&d=identicon&r=PG&f=1", "display_name": "soupybionics", "link": "https://stackoverflow.com/users/2686821/soupybionics"}, "edited": false, "score": 1, "creation_date": 1543752147, "post_id": 53578748, "comment_id": 94023524, "body": "@soupybionics I can&#39;t see a good use case for a type that is <code>Sync</code> and <code>Copy</code>, but not <code>Send</code>. It seems if you can share a reference and then copy the value, you should also be allowed to send the value directly, but sometimes there are sublteties that aren&#39;t immediately obvious, so I wouldn&#39;t take this as a proof there can&#39;t be such a type."}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 3, "last_activity_date": 1543740296, "creation_date": 1543740296, "answer_id": 53578748, "question_id": 53575183, "link": "https://stackoverflow.com/questions/53575183/how-does-rayon-prevent-the-use-of-refcellt-cellt-and-rct-between-threads/53578748#53578748", "title": "How does Rayon prevent the use of RefCell&lt;T&gt;, Cell&lt;T&gt; and Rc&lt;T&gt; between threads?", "body": "<p>You actually answered your question yourself \u2013 all closures that need to be shared between threads need to be <code>Sync</code>, and Rayon's API simply requires them to be <code>Sync</code> via trait bounds. See for example the <a href=\"https://docs.rs/rayon/1.0.3/rayon/iter/trait.ParallelIterator.html#method.map\" rel=\"nofollow noreferrer\">documentation of <code>ParallelIterator::map()</code></a>, which specifies the method as</p>\n\n<pre><code>fn map&lt;F, R&gt;(self, map_op: F) -&gt; Map&lt;Self, F&gt; where\n    F: Fn(Self::Item) -&gt; R + Sync + Send,\n    R: Send, \n</code></pre>\n\n<p>There isn't any deeper magic here \u2013 whenever Rayon uses a closure in a way that requires it to be <code>Sync</code>, e.g. by passing it on to a lower level API, Rayon restricts the corresponding parameter type with the <code>Sync</code> trait bound. This in turn makes sure  that everything stored inside the closure is <code>Sync</code>, so you can't store any <code>RefCell</code> in the closure.</p>\n\n<p>In cases like this, you can also ask the compiler for an explanation. As an example, if you try to compile this code</p>\n\n<pre><code>use std::cell::RefCell;\nuse rayon::prelude::*;\n\nfn main() {\n    let c = RefCell::new(5);\n    let _ = [1, 2, 3]\n        .par_iter()\n        .map(|i| i * *c.borrow())\n        .sum();\n}\n</code></pre>\n\n<p>you will get this error (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=deafacaaf19570feda7c00d4a019e757\" rel=\"nofollow noreferrer\">playground</a>)</p>\n\n<pre><code>error[E0277]: `std::cell::RefCell&lt;i32&gt;` cannot be shared between threads safely\n  --&gt; src/main.rs:10:10\n   |\n10 |         .map(|i| i * *c.borrow())\n   |          ^^^ `std::cell::RefCell&lt;i32&gt;` cannot be shared between threads safely\n   |\n   = help: within `[closure@src/main.rs:10:14: 10:33 c:&amp;std::cell::RefCell&lt;i32&gt;]`, the trait `std::marker::Sync` is not implemented for `std::cell::RefCell&lt;i32&gt;`\n   = note: required because it appears within the type `&amp;std::cell::RefCell&lt;i32&gt;`\n   = note: required because it appears within the type `[closure@src/main.rs:10:14: 10:33 c:&amp;std::cell::RefCell&lt;i32&gt;]`\n</code></pre>\n\n<p>While the compiler unfortunately does not directly mention the trait bound for the parameter of <code>map()</code>, it still points you to the relevant method, and explains that it expects the closure to be <code>Sync</code>, and the reason why it isn't.</p>\n"}], "owner": {"reputation": 2438, "user_id": 185646, "user_type": "registered", "accept_rate": 96, "profile_image": "https://www.gravatar.com/avatar/01cc07930d88f6f16a6dbaa6590942f4?s=128&d=identicon&r=PG", "display_name": "skyde", "link": "https://stackoverflow.com/users/185646/skyde"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 506, "favorite_count": 0, "accepted_answer_id": 53578748, "answer_count": 1, "score": 1, "last_activity_date": 1545156125, "creation_date": 1543699386, "last_edit_date": 1545156125, "question_id": 53575183, "link": "https://stackoverflow.com/questions/53575183/how-does-rayon-prevent-the-use-of-refcellt-cellt-and-rct-between-threads", "title": "How does Rayon prevent the use of RefCell&lt;T&gt;, Cell&lt;T&gt; and Rc&lt;T&gt; between threads?", "body": "<p>The Rayon documentation say it guarantees that using Rayon APIs will not introduce data races.</p>\n\n<p>How can the compiler know that the method called by the closures is not sharing mutable state, for example <code>RefCell&lt;T&gt;</code> and <code>Cell&lt;T&gt;</code>, or using structs that are not thread-safe, for example <code>Rc&lt;T&gt;</code>?</p>\n\n<p>I understand that <code>core::marker::Sync</code> marks types that are safe to share between threads but I don't understand how the Rayon type declarations and the compiler enforce it!</p>\n"}, {"tags": ["c", "rust", "ffi"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1543699852, "post_id": 53573575, "comment_id": 94014707, "body": "Your structure en Rust doesn&#39;t match the structure in C and this is totally UB also please produce an <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. And consider use bindgen."}, {"owner": {"reputation": 782, "user_id": 2505159, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e3ec39948aca0fe41ac29e3e9f8a2649?s=128&d=identicon&r=PG", "display_name": "Rich", "link": "https://stackoverflow.com/users/2505159/rich"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543775393, "post_id": 53573575, "comment_id": 94030005, "body": "It matches enough of the structure to make the point.  By dumping out the fields from the C program I can see that the integers and strings are fine, but the function pointers are bogus."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543777522, "post_id": 53573575, "comment_id": 94030650, "body": "There is no such thing that &quot;matches enough&quot; or &quot;but the function pointers are bogus&quot;, undefined behavior is undefined behavior. You can&#39;t assume this doesn&#39;t cause the bug. Do thing properly and then look if this is still bogus. Also I repeat myself please do an <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. For exemple try to make a new C lib with a structure with only one function and try it without the all mess of this API."}], "answers": [{"comments": [{"owner": {"reputation": 782, "user_id": 2505159, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e3ec39948aca0fe41ac29e3e9f8a2649?s=128&d=identicon&r=PG", "display_name": "Rich", "link": "https://stackoverflow.com/users/2505159/rich"}, "edited": false, "score": 0, "creation_date": 1544029359, "post_id": 53584741, "comment_id": 94134246, "body": "If I don&#39;t use the Option for longname etc, then how can I specify them as being NULL?"}, {"owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "reply_to_user": {"reputation": 782, "user_id": 2505159, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e3ec39948aca0fe41ac29e3e9f8a2649?s=128&d=identicon&r=PG", "display_name": "Rich", "link": "https://stackoverflow.com/users/2505159/rich"}, "edited": false, "score": 0, "creation_date": 1544174009, "post_id": 53584741, "comment_id": 94190505, "body": "By using <a href=\"https://doc.rust-lang.org/stable/std/ptr/fn.null.html\" rel=\"nofollow noreferrer\"><code>std::ptr::null</code></a> or <a href=\"https://doc.rust-lang.org/stable/std/ptr/fn.null_mut.html\" rel=\"nofollow noreferrer\"><code>std::ptr::null_mut</code></a>."}], "tags": [], "owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "is_accepted": false, "score": 1, "last_activity_date": 1543785728, "creation_date": 1543785728, "answer_id": 53584741, "question_id": 53573575, "link": "https://stackoverflow.com/questions/53573575/creating-a-rust-shared-library-that-returns-a-struct-of-function-pointers-to-c-m/53584741#53584741", "title": "Creating a rust shared library that returns a struct of function pointers to C main program", "body": "<p>You've probably learned at some point that a reference (<code>&amp;T</code>) wrapped in an <code>Option</code> (<code>Option&lt;&amp;T&gt;</code>) is optimized such that <code>None</code> is encoded as all zeroes, which is not valid for a reference, and <code>Option&lt;&amp;T&gt;</code> has the same size as <code>&amp;T</code>.</p>\n\n<p>However, all zeroes is a valid bit pattern for a raw pointer (<code>*const T</code> or <code>*mut T</code>): it represents the null pointer. As such, wrapping those in an <code>Option</code> is no different from wrapping, say, an <code>i32</code> in an <code>Option</code>: the <code>Option</code> type is larger so that it can store a discriminant.</p>\n\n<p>To fix your struct definition, you must not use <code>Option</code> to define <code>longname</code>, <code>version</code> and <code>description</code>.</p>\n"}], "owner": {"reputation": 782, "user_id": 2505159, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e3ec39948aca0fe41ac29e3e9f8a2649?s=128&d=identicon&r=PG", "display_name": "Rich", "link": "https://stackoverflow.com/users/2505159/rich"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 268, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1543785728, "creation_date": 1543687227, "last_edit_date": 1543776976, "question_id": 53573575, "link": "https://stackoverflow.com/questions/53573575/creating-a-rust-shared-library-that-returns-a-struct-of-function-pointers-to-c-m", "title": "Creating a rust shared library that returns a struct of function pointers to C main program", "body": "<p>I'm trying to make a Rust binding to nbdkit without much luck.  I need to make a <code>.so</code> file, which is easy.  The <code>.so</code> file must have a public function called <code>plugin_init</code>, also easy.  However this function must return a pointer to a C-compatible <code>struct</code> containing a mix of strings and function pointers (that the C main program will later call).</p>\n\n<p>The API is: <a href=\"https://github.com/libguestfs/nbdkit/blob/409ce4c9238a84ede6688423b20d5f706067834b/include/nbdkit-plugin.h#L53\" rel=\"nofollow noreferrer\">https://github.com/libguestfs/nbdkit/blob/409ce4c9238a84ede6688423b20d5f706067834b/include/nbdkit-plugin.h#L53</a></p>\n\n<p>I came up with:</p>\n\n<pre><code>#[repr(C)]\npub struct NBDKitPlugin {\n    _struct_size: uint64_t,\n    _api_version: c_int,\n    _thread_model: c_int,\n\n    name: *const c_char,\n    longname: Option&lt;*const c_char&gt;,\n    version: Option&lt;*const c_char&gt;,\n    description: Option&lt;*const c_char&gt;,\n\n    load: Option&lt;extern fn ()&gt;,\n    unload: Option&lt;extern fn ()&gt;,\n\n    config: Option&lt;extern fn ()&gt;, // XXX\n    config_complete: Option&lt;extern fn () -&gt; c_int&gt;,\n    config_help: Option&lt;*const c_char&gt;,\n\n    open: extern fn (c_int) -&gt; *mut c_void,\n    close: Option&lt;extern fn (*mut c_void)&gt;,\n}\n</code></pre>\n\n<p>and a <code>plugin_init</code> function:</p>\n\n<pre><code>extern fn hello_load () {\n    println! (\"hello this is the load method\");\n}\n\nstruct MyHandle {\n}\n\nextern fn hello_open (readonly: c_int) -&gt; *mut c_void {\n    println! (\"hello, this is the open method\");\n    let mut h = MyHandle {};\n    let vp: *mut c_void = &amp;mut h as *mut _ as *mut c_void;\n    return vp;\n}\n\n#[no_mangle]\npub extern fn plugin_init () -&gt; *const NBDKitPlugin {\n    println! (\"hello from the plugin\");\n\n    let plugin = Box::new (NBDKitPlugin {\n        _struct_size: mem::size_of::&lt;NBDKitPlugin&gt;() as uint64_t,\n        _api_version: 2,\n        _thread_model: 3,\n        name: CString::new(\"hello\").unwrap().into_raw(),\n        longname: None,\n        version: None,\n        description: None,\n        load: Some (hello_load),\n        unload: None,\n        config: None,\n        config_complete: None,\n        config_help: Some (CString::new(\"my config_help here\").unwrap().into_raw()),\n        open: hello_open,\n        close: None,\n    });\n\n    return Box::into_raw(plugin);\n}\n</code></pre>\n\n<p>Apart from leaking memory, this partially works.  The integers and strings are seen from C OK.  However the function pointers don't work at all.  They are completely bogus and seem to occupy more space than a raw pointer so I suppose that I'm exposing a \"fat\" Rust pointer.</p>\n\n<p>There seems very little documentation on this topic that I can find.  Help.</p>\n"}, {"tags": ["string", "rust", "uppercase"], "comments": [{"owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543671151, "post_id": 53570839, "comment_id": 94007001, "body": "no, I&#39;m asking for a How, not a Why. These are rather diferent questions, and the answer involving using a crate requires building its <a href=\"https://crates.io/crates/inflector/reverse_dependencies\" rel=\"nofollow noreferrer\">26 dependancies</a>. adding that many dependancies is not a quick copy paste snippet of code."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543671237, "post_id": 53570839, "comment_id": 94007020, "body": "The answer of Shep that yourself quote answer both how and why."}, {"owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543671542, "post_id": 53570839, "comment_id": 94007108, "body": "Ah, yes. I see it now. TBH i didn&#39;t consider it would be working code, given that he states it isn&#39;t code he&#39;d use/write and it was what it <i>looked</i> like, and he&#39;d rather use crates.io. Time to edit."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1543675475, "post_id": 53570839, "comment_id": 94008182, "body": "I&#39;ve <a href=\"https://stackoverflow.com/a/53571882/3650362\">added an answer</a> to the other question that may suit your use case."}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1543668920, "post_id": 53570840, "comment_id": 94006474, "body": "Sorry, but this answer is plenty wrong you assume the &quot;letter&quot; is only one bytes, remember that String in Rust are UTF-8 String, convert the first character is not as trivial as you think."}, {"owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543669043, "post_id": 53570840, "comment_id": 94006501, "body": "See my latest edit, also, it is meant to be &#39;quick&#39;. ;)"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1543669502, "post_id": 53570840, "comment_id": 94006626, "body": "Well, In your implementation you create twice a string, that not what I would call quick also quick doesn&#39;t mean wrong and for finish I think that the answer you add is a the answer to this question."}, {"owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543670475, "post_id": 53570840, "comment_id": 94006863, "body": "by <i>quick</i>, I mean speed of writing quick. quick doesn&#39;t meen wrong <i>or</i> right.  My use for this is to capitalise the first word in a Lorem Ipsum sentance.  It&#39;s intended to replace Javascript&#39;s <code>sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);</code>. It&#39;s good enough for it&#39;s job."}, {"owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543672016, "post_id": 53570840, "comment_id": 94007232, "body": "It&#39;s now <i>correct</i>."}, {"owner": {"reputation": 63855, "user_id": 124486, "user_type": "registered", "accept_rate": 46, "profile_image": "https://www.gravatar.com/avatar/605442f85418d858e2ce1e1aea2092bb?s=128&d=identicon&r=PG", "display_name": "Evan Carroll", "link": "https://stackoverflow.com/users/124486/evan-carroll"}, "edited": false, "score": 0, "creation_date": 1592068038, "post_id": 53570840, "comment_id": 110294524, "body": "You don&#39;t have to call <code>.collect::&lt;String&gt;()</code> you can just call <code>.to_string()</code>"}], "tags": [], "owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "is_accepted": true, "score": 0, "last_activity_date": 1574625409, "last_edit_date": 1574625409, "creation_date": 1543667845, "answer_id": 53570840, "question_id": 53570839, "link": "https://stackoverflow.com/questions/53570839/quick-function-to-convert-a-strings-first-letter-to-uppercase/53570840#53570840", "title": "Quick function to convert a String&#39;s first letter to uppercase?", "body": "<p>If you want a function used as so:<br>\n<code>let newfoo = first_letter_to_uppper_case(\"foobar\".to_string())</code><br>\nTry use the following:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n  println!(\"{}\", first_letter_to_uppper_case(\"foobar\".to_string()));\n}\n\nfn first_letter_to_uppper_case (s1: String) -&gt; String {\n  let mut c = s1.chars();\n  match c.next() {\n    None =&gt; String::new(),\n    Some(f) =&gt; f.to_uppercase().collect::&lt;String&gt;() + c.as_str(),\n  }\n}\n</code></pre>\n\n<p>If you want it as a function implimented on the string type, like <code>let newfoo = \"foobar\".to_string().first_letter_to_uppper_case()</code>, try:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait FirstLetterToUppperCase {\n  fn first_letter_to_uppper_case(self) -&gt; String;\n}\n\nimpl FirstLetterToUppperCase for String {\n  fn first_letter_to_uppper_case(self) -&gt; String {\n    let mut c = self.chars();\n    match c.next() {\n      None =&gt; String::new(),\n      Some(f) =&gt; f.to_uppercase().collect::&lt;String&gt;() + c.as_str(),\n    }\n  }\n}\n\nfn main() {\n  println!(\"{}\", \"foobar\".to_string().first_letter_to_uppper_case());\n}\n</code></pre>\n\n<p>However, these functions do not deal with non-ascii characters very well. For more information, see <a href=\"https://stackoverflow.com/a/38406885/9761034\">this answer.</a></p>\n"}], "owner": {"reputation": 884, "user_id": 9761034, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-tmCRdMuF26I/AAAAAAAAAAI/AAAAAAAAALk/-UqHQR1Lj-E/photo.jpg?sz=128", "display_name": "Joel Ellis", "link": "https://stackoverflow.com/users/9761034/joel-ellis"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1096, "favorite_count": 1, "closed_date": 1543682753, "accepted_answer_id": 53570840, "answer_count": 1, "score": 2, "last_activity_date": 1574625409, "creation_date": 1543667845, "last_edit_date": 1574625169, "question_id": 53570839, "link": "https://stackoverflow.com/questions/53570839/quick-function-to-convert-a-strings-first-letter-to-uppercase", "closed_reason": "Duplicate", "title": "Quick function to convert a String&#39;s first letter to uppercase?", "body": "<p>Does anyone know a function that changes the first letter of a <code>String</code> to the uppercase equivalent?\nIdealy, it would be used as so:</p>\n\n<p><code>let newfoo = first_letter_to_uppper_case(\"foobar\".to_string())</code>, or<br>\n<code>let newfoo = \"foobar\".to_string().first_letter_to_uppper_case()</code>.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543666373, "post_id": 53570563, "comment_id": 94005853, "body": "See <a href=\"https://github.com/nox/rust-rfcs/blob/master/text/0599-default-object-bound.md\" rel=\"nofollow noreferrer\">RFC 599</a> for your side question."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543667030, "post_id": 53570563, "comment_id": 94005988, "body": "<code>text.map_err(From::from)</code> or <code>text.map_err(|e| From::from(Box::new(e)))</code> don&#39;t ask I never fully understood. <a href=\"https://doc.rust-lang.org/nightly/std/boxed/struct.Box.html#impl-From%3CE%3E\" rel=\"nofollow noreferrer\">doc.rust-lang.org/nightly/std/boxed/&hellip;</a>"}], "answers": [{"comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543667767, "post_id": 53570789, "comment_id": 94006173, "body": "Rust <i>does</i> coerce <code>Result&lt;T, Box&lt;Err&gt;&gt;</code> to <code>Result&lt;T, Box&lt;dyn Error&gt;&gt;</code>. Just try it; it&#39;s a standard unsized coercion. The reason for the error is more subtle \u2013 it&#39;s basically a shortcoming of the type inference algorithm."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543667843, "post_id": 53570789, "comment_id": 94006195, "body": "Here is a playground link demonstrating the coercion: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=e05e9eb050992c85d3e25357cfa6ad60\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1543668106, "post_id": 53570789, "comment_id": 94006272, "body": "@SvenMarnach No, it doesn&#39;t.  That code does not demonstrate what you think it demonstrates.  You&#39;ve made exactly the same mistake as the OP: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=596a741dba6562cdf942f19bef978233\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543668395, "post_id": 53570789, "comment_id": 94006347, "body": "You are right \u2013 the coercion in my code is only for the box, and <code>Result</code> does not implement <code>CoerceUnsized</code>."}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543750702, "post_id": 53570789, "comment_id": 94023146, "body": "@Thomas: <code>CoerceUnsized</code>.  <code>Box&lt;T&gt;</code> \u2192 <code>Box&lt;dyn Trait&gt;</code> is more akin (though still not the same) as <code>SomeObject</code> \u2192 <code>Interface</code>.  You can&#39;t do <code>Vec&lt;T&gt;</code> \u2192 <code>Vec&lt;dyn Trait&gt;</code> because that doesn&#39;t make sense.  <code>Box&lt;T&gt;</code> \u2192 <code>Box&lt;dyn Trait&gt;</code> does, so you can."}, {"owner": {"reputation": 149903, "user_id": 14637, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/1904e7096278a10f1dfb3fdc0ceb53cc?s=128&d=identicon&r=PG", "display_name": "Thomas", "link": "https://stackoverflow.com/users/14637/thomas"}, "edited": false, "score": 1, "creation_date": 1543750840, "post_id": 53570789, "comment_id": 94023183, "body": "Thanks, great answer. I was wondering when exactly Rust will and won&#39;t do such coercions, and found <a href=\"https://doc.rust-lang.org/nomicon/coercions.html\" rel=\"nofollow noreferrer\">doc.rust-lang.org/nomicon/coercions.html</a> which has the full details. The answer to my original question follows from the fact that passing <code>Box::new</code> as a function does not create a coercion site."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 149903, "user_id": 14637, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/1904e7096278a10f1dfb3fdc0ceb53cc?s=128&d=identicon&r=PG", "display_name": "Thomas", "link": "https://stackoverflow.com/users/14637/thomas"}, "edited": false, "score": 0, "creation_date": 1543752476, "post_id": 53570789, "comment_id": 94023596, "body": "@Thomas This page actually doesn&#39;t have all the details, unfortunately. There is a <a href=\"https://doc.rust-lang.org/reference/type-coercions.html\" rel=\"nofollow noreferrer\">slightly more complete version in the language reference</a>, but it&#39;s still lacking special cases. For example it does not mention that enum variant constructors in a coercion site propagate the coercion to their arguments, which is why I thought my example linked above demonstrates that unsized coercions for <code>Result</code> are performed. There are also subtleties to how the return type of the closure you pass to <code>map_err()</code> is inferred."}], "tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": true, "score": 3, "last_activity_date": 1543667489, "creation_date": 1543667489, "answer_id": 53570789, "question_id": 53570563, "link": "https://stackoverflow.com/questions/53570563/why-does-a-plain-match-expression-compile-while-a-map-err-call-doesnt/53570789#53570789", "title": "Why does a plain match expression compile, while a map_err call doesn&#39;t?", "body": "<p><code>Box::new</code> does one thing, and one thing only: takes a <code>reqwest::Error</code> and puts it inside a <code>Box&lt;reqwest::Error&gt;</code>.</p>\n\n<p>The <em>expression</em> <code>Box::new(e)</code> is doing <em>two</em> things: calls <code>Box::new</code> which takes a <code>reqwest::Error</code> and puts it inside a <code>Box&lt;reqwest::Error&gt;</code>, <strong>and then</strong> it coerces the <code>Box&lt;reqwest::Error&gt;</code> into a <code>Box&lt;dyn Error&gt;</code>.</p>\n\n<p>Coercing types is something Rust generally tries to avoid.  <code>Box&lt;T&gt;</code> \u2192 <code>Box&lt;dyn Trait&gt;</code> (and other similar, direct pointer\u2192pointer coercions) is an exception.  In particular, Rust <em>will not</em> coerce <code>Result&lt;T, Box&lt;Err&gt;&gt;</code> to <code>Result&lt;T, Box&lt;dyn Error&gt;&gt;</code>.</p>\n\n<p>As for your aside: because <code>dyn Trait</code> always requires an associated lifetime.  When you put <code>dyn Trait</code> inside a box, it is implicitly assumed to be <code>'static</code>.  When you have <code>&amp;'a dyn Trait</code>, it's assumed to be <code>'a</code>.</p>\n"}], "owner": {"reputation": 149903, "user_id": 14637, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/1904e7096278a10f1dfb3fdc0ceb53cc?s=128&d=identicon&r=PG", "display_name": "Thomas", "link": "https://stackoverflow.com/users/14637/thomas"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 114, "favorite_count": 0, "accepted_answer_id": 53570789, "answer_count": 1, "score": 1, "last_activity_date": 1543667489, "creation_date": 1543665718, "question_id": 53570563, "link": "https://stackoverflow.com/questions/53570563/why-does-a-plain-match-expression-compile-while-a-map-err-call-doesnt", "title": "Why does a plain match expression compile, while a map_err call doesn&#39;t?", "body": "<p>Using rustc 1.30.1 and reqwest 0.9.5.</p>\n\n<p>I have a function that calls several other functions, which may return different types of errors, in particular <code>std::io::Error</code> and <code>reqwest::Error</code>.</p>\n\n<p>To propagate these to the caller, the simplest solution seems to be to put them in a <code>Box</code>, which conveniently implements the <code>From&lt;Error&gt;</code> trait as well as the <code>Error</code> trait itself. Like this:</p>\n\n<pre><code>fn fetch_input() -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {\n    ...\n    let session_cookie = load_session_cookie()?; // Returns Result&lt;String, io::Error&gt;\n    let text: Result&lt;String, reqwest::Error&gt; = ...;\n    text.map_err(Box::new) // Compile error on this line\n}\n</code></pre>\n\n<p>However, that code doesn't compile:</p>\n\n<pre><code>error[E0308]: mismatched types                                                               \n  --&gt; src/main.rs:26:5                                                                       \n   |                                                                                         \n16 | fn fetch_input() -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {                 \n   |                     ------------------------------ expected `std::result::Result&lt;std::string::String, std::boxed::Box&lt;(dyn std::error::Error + 'static)&gt;&gt;` because of return type\n...                                                                                          \n26 |     text.map_err(Box::new)                                                              \n   |     ^^^^^^^^^^^^^^^^^^^^^^ expected trait std::error::Error, found struct `reqwest::Error`\n   |                                                                                         \n   = note: expected type `std::result::Result&lt;_, std::boxed::Box&lt;(dyn std::error::Error + 'static)&gt;&gt;`\n              found type `std::result::Result&lt;_, std::boxed::Box&lt;reqwest::Error&gt;&gt;`           \n</code></pre>\n\n<p>If I replace the <code>map_err</code> call by a plain old <code>match</code> expression, all is fine:</p>\n\n<pre><code>    match text {\n        Ok(t) =&gt; Ok(t),\n        Err(e) =&gt; Err(Box::new(e)),\n    }\n</code></pre>\n\n<p>Note that this is identical to the body of the <code>map_err</code> implementation in the standard library. So why doesn't my <code>map_err</code> call pass the type checker? Needless to say, <a href=\"https://docs.rs/reqwest/0.9.5/reqwest/struct.Error.html#impl-Error\" rel=\"nofollow noreferrer\"><code>reqwest::Error</code> does implement the <code>std::error::Error</code> trait</a>.</p>\n\n<p>I also wonder where the <code>'static</code> lifetime in the error message is coming from. If it turns out to be unrelated, I might open a different question for it.</p>\n"}, {"tags": ["rust", "arithmetic-expressions"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1543651242, "post_id": 53568885, "comment_id": 94002894, "body": "I don&#39;t know if either you are very bad at math or if you wrongly deduce the value of <code>std::u64::MAX</code> aka <code>18_446_744_073_709_551_615u64</code> ~= <code>10^20</code> but <code>4_400_202_385_408 * 34_359_738_368</code> == <code>151_189_802_728_868_380_934_144</code> ~= <code>10^24</code> and this is quite bigger ;)"}], "answers": [{"comments": [{"owner": {"reputation": 230, "user_id": 10566115, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/0xjWM.jpg?s=128&g=1", "display_name": "Nihar Karve", "link": "https://stackoverflow.com/users/10566115/nihar-karve"}, "edited": false, "score": 0, "creation_date": 1543651741, "post_id": 53568938, "comment_id": 94002976, "body": "std::u64::MAX is 18,446,744,073,709,551,615 (~ 1.8 &#215; 10^19), while the result of the multiplication is 288,300,744,895,889,408 (~ 2.8 &#215; 10^17)"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 230, "user_id": 10566115, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/0xjWM.jpg?s=128&g=1", "display_name": "Nihar Karve", "link": "https://stackoverflow.com/users/10566115/nihar-karve"}, "edited": false, "score": 0, "creation_date": 1543651916, "post_id": 53568938, "comment_id": 94002998, "body": "@DiehardTheTryhard No this is wrong how do you calcul the result ? This is the result when you wrap the multiplication, see <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=3fad2dc6eba287b8b6c1c95b6cf4c8af\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>."}, {"owner": {"reputation": 230, "user_id": 10566115, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/0xjWM.jpg?s=128&g=1", "display_name": "Nihar Karve", "link": "https://stackoverflow.com/users/10566115/nihar-karve"}, "edited": false, "score": 0, "creation_date": 1543653324, "post_id": 53568938, "comment_id": 94003200, "body": "Ah, now I see. Also, I was using a programmer&#39;s calculator, which wraps the result. I will use wrapping_mul in this case"}], "tags": [], "owner": {"reputation": 6020, "user_id": 4052193, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6062c93ce987aa90ac59d06e758f03b6?s=128&d=identicon&r=PG&f=1", "display_name": "Columbo", "link": "https://stackoverflow.com/users/4052193/columbo"}, "is_accepted": true, "score": 1, "last_activity_date": 1543651233, "creation_date": 1543651233, "answer_id": 53568938, "question_id": 53568885, "link": "https://stackoverflow.com/questions/53568885/unsigned-integer-overflow-in-rust/53568938#53568938", "title": "Unsigned integer overflow in Rust", "body": "<blockquote>\n  <p>despite the fact that the result of the multiplication is within std::u64::MAX</p>\n</blockquote>\n\n<p>Pretty sure it's not.</p>\n\n<p>Converting to hex, you're doing 0x40080800800 * 0x800000000. They're both individually well over a u32 MAX, so when you multiply them together they're well over a u64 max.</p>\n"}], "owner": {"reputation": 230, "user_id": 10566115, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/0xjWM.jpg?s=128&g=1", "display_name": "Nihar Karve", "link": "https://stackoverflow.com/users/10566115/nihar-karve"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1004, "favorite_count": 0, "accepted_answer_id": 53568938, "answer_count": 1, "score": 0, "last_activity_date": 1543651233, "creation_date": 1543650751, "question_id": 53568885, "link": "https://stackoverflow.com/questions/53568885/unsigned-integer-overflow-in-rust", "title": "Unsigned integer overflow in Rust", "body": "<p>I am a beginner to Rust. In the code:</p>\n\n<p><code>println!(\"{}\", 4400202385408u64 * 34359738368u64);</code></p>\n\n<p>The rust compiler gives me the following error:</p>\n\n<pre><code>error: attempt to multiply with overflow \n</code></pre>\n\n<p>despite the fact that the result of the multiplication is within <code>std::u64::MAX</code></p>\n\n<p>Can someone point me to what is happening?</p>\n"}, {"tags": ["rust", "traits", "lifetime"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543627201, "post_id": 53566761, "comment_id": 93999572, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=1ba05e0f6d41b1cd837ae972b11d9c7e\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>, but it&#39;s unclear what you try to do."}, {"owner": {"reputation": 2858, "user_id": 4070218, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/VNOHi.gif?s=128&g=1", "display_name": "jonny", "link": "https://stackoverflow.com/users/4070218/jonny"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543627748, "post_id": 53566761, "comment_id": 93999654, "body": "@Stargateur I&#39;ve never seen the <code>where for</code> syntax before, where&#39;s that documented?"}, {"owner": {"reputation": 7716, "user_id": 4639273, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ae38603d40c633012992337a32330fa0?s=128&d=identicon&r=PG", "display_name": "SCappella", "link": "https://stackoverflow.com/users/4639273/scappella"}, "edited": false, "score": 1, "creation_date": 1543628082, "post_id": 53566761, "comment_id": 93999709, "body": "@jonny That&#39;s a higher ranked trait bound. See <a href=\"https://doc.rust-lang.org/nomicon/hrtb.html\" rel=\"nofollow noreferrer\">doc.rust-lang.org/nomicon/hrtb.html</a>"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1543628287, "post_id": 53566761, "comment_id": 93999746, "body": "@jonny or <a href=\"https://doc.rust-lang.org/reference/trait-bounds.html#higher-ranked-trait-bounds\" rel=\"nofollow noreferrer\">doc.rust-lang.org/reference/&hellip;</a>, this is not well documented unfortunately. This kind of feature are very advanced and rust try to improve it with GATs. It&#39;s a broad topic."}], "answers": [{"tags": [], "owner": {"reputation": 2858, "user_id": 4070218, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/VNOHi.gif?s=128&g=1", "display_name": "jonny", "link": "https://stackoverflow.com/users/4070218/jonny"}, "is_accepted": true, "score": 1, "last_activity_date": 1543678763, "creation_date": 1543678763, "answer_id": 53572382, "question_id": 53566761, "link": "https://stackoverflow.com/questions/53566761/how-to-define-lifetimes-on-a-fn-trait-bound-returning-references/53572382#53572382", "title": "How to define lifetimes on a Fn trait bound returning references?", "body": "<p>As per @Stargateur's comment, the solution was to add a <a href=\"https://doc.rust-lang.org/nomicon/hrtb.html\" rel=\"nofollow noreferrer\">Higher-Ranked Trait Bound</a> to the <code>Fn</code> trait declaration. The <code>where for</code> clause is a piece of syntax completely specific to this use case.</p>\n\n<p>Normal lifetime bounds don't work, because we don't know what lifetimes will be applied to the function's arguments until call time. </p>\n\n<p>So we go from this:</p>\n\n<pre><code>struct Rule&lt;F&gt; where F: Fn(&amp;mut Compiler, &amp;[Token]) -&gt; &amp;Token {\n    func: F\n}\n</code></pre>\n\n<p>To this:</p>\n\n<pre><code>struct Rule&lt;F&gt; where for&lt;'a&gt; F: Fn(&amp;mut Compiler, &amp;'a[Token]) -&gt; &amp;'a Token {\n    func: F\n}\n</code></pre>\n\n<p>Which dictates that the trait bounds applied to function <code>F</code> must satisfy all potential lifetimes of <code>'a</code> <em>at call time</em>. Magic!</p>\n"}], "owner": {"reputation": 2858, "user_id": 4070218, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/VNOHi.gif?s=128&g=1", "display_name": "jonny", "link": "https://stackoverflow.com/users/4070218/jonny"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 229, "favorite_count": 0, "accepted_answer_id": 53572382, "answer_count": 1, "score": 1, "last_activity_date": 1543678847, "creation_date": 1543625020, "last_edit_date": 1543678847, "question_id": 53566761, "link": "https://stackoverflow.com/questions/53566761/how-to-define-lifetimes-on-a-fn-trait-bound-returning-references", "title": "How to define lifetimes on a Fn trait bound returning references?", "body": "<p>I'm trying to create a struct with a field, generic over <code>F</code> where <code>F</code> implements something like: <code>Fn(&amp;mut Compiler, &amp;[Token]) -&gt; &amp;Token</code>. The only issue is, I'm not sure how I define lifetimes on the <code>Fn</code> trait which satisfy the constraint that the returned <code>&amp;Token</code> references data in the <code>&amp;[Token]</code> slice supplied as an argument. Everything I've tried has thrown cryptic errors thus far. </p>\n\n<p>Here is an MVCE which demonstrates the code (without any lifetimes):</p>\n\n<pre><code>struct Compiler;\n#[derive(Debug)]\nstruct Token(usize);\n\nimpl Compiler {\n    // missing lifetime paramters here\n    fn meth(&amp;mut self, tokens: &amp;[Token]) -&gt; &amp;Token {\n        tokens.get(0).unwrap()\n    }\n}\n\n// missing lifetime paramters here    \nstruct Rule&lt;F&gt; where F: Fn(&amp;mut Compiler, &amp;[Token]) -&gt; &amp;Token {\n    func: F\n}\n\nfn main() {\n    let mut c = Compiler;\n    let tokens = vec![Token(0), Token(1), Token(2)];\n    let r = Rule { func: Compiler::meth };\n    (r.func)(&amp;mut c, &amp;tokens);\n}\n</code></pre>\n\n<p>Naturally this fails to compile with the error:</p>\n\n<pre><code>   Compiling playground v0.0.1 (/playground)\nerror[E0106]: missing lifetime specifier\n  --&gt; src/main.rs:11:56\n   |\n11 | struct Rule&lt;F&gt; where F: Fn(&amp;mut Compiler, &amp;[Token]) -&gt; &amp;Token {\n   |                                                        ^ expected lifetime parameter\n   |\n   = help: this function's return type contains a borrowed value, but the signature does not say whether it is borrowed from argument 1 or argument 2\n</code></pre>\n\n<p>I've attempted to add lifetimes specifiers here and there, moving things around but nothing seems to work. I would really appreciate any insight into the issue. Thanks!</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 588, "user_id": 645494, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/bm5ET.png?s=128&g=1", "display_name": "Chris Swierczewski", "link": "https://stackoverflow.com/users/645494/chris-swierczewski"}, "edited": false, "score": 1, "creation_date": 1543626252, "post_id": 53566242, "comment_id": 93999407, "body": "I like the Zero trait approach, even though it is verbose. I\u2019ll also check out the num package to see what that\u2019s all about. Waiting for another possible answer before I give you the \u201cAnswered Question\u201d. :)"}], "tags": [], "owner": {"reputation": 46, "user_id": 10102239, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-IzN_uuGrVBI/AAAAAAAAAAI/AAAAAAAAAAA/AAnnY7r4m8I8DacpBwkxAzU5NlkFbc6eSQ/mo/photo.jpg?sz=128", "display_name": "Jade", "link": "https://stackoverflow.com/users/10102239/jade"}, "is_accepted": true, "score": 3, "last_activity_date": 1543620338, "creation_date": 1543620338, "answer_id": 53566242, "question_id": 53565970, "link": "https://stackoverflow.com/questions/53565970/setting-the-type-of-a-struct-constructor-in-rust/53566242#53566242", "title": "Setting the Type of a Struct Constructor in Rust", "body": "<p>You probably want to use the <a href=\"https://crates.io/crates/num\" rel=\"nofollow noreferrer\">num</a> crate, which adds traits for situations like this.</p>\n\n<p>Something like:</p>\n\n<pre><code>extern crate num;\nuse num::Zero;\n\nimpl&lt;T&gt; Matrix&lt;T&gt; {\n    pub fn zero(nrows: usize, ncols: usize) -&gt; Matrix&lt;T&gt;\n    where T : Clone + Zero\n    {\n        let data: Vec&lt;T&gt; = vec![T::zero(); nrows*ncols];\n        Matrix::new(data, nrows, ncols)\n    }\n}\n</code></pre>\n\n<p>would probably work, because it defines your matrix type as bounded by types that implement the <code>num::Zero</code> trait. This is implemented over all integer and floating-point primitives, and can be implemented for custom types as well.</p>\n\n<p>If you don't want to import the <code>num</code> crate, you can define this trait manually like below, though it will require you to implement it for primitives yourself.</p>\n\n<pre><code>trait Zero {\n    fn zero() -&gt; Self;\n}\nimpl Zero for f32 {\n    fn zero() -&gt; Self {\n        0.0\n    }\n}\n...\n</code></pre>\n"}], "owner": {"reputation": 588, "user_id": 645494, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/bm5ET.png?s=128&g=1", "display_name": "Chris Swierczewski", "link": "https://stackoverflow.com/users/645494/chris-swierczewski"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 651, "favorite_count": 0, "accepted_answer_id": 53566242, "answer_count": 1, "score": 1, "last_activity_date": 1543620338, "creation_date": 1543618290, "question_id": 53565970, "link": "https://stackoverflow.com/questions/53565970/setting-the-type-of-a-struct-constructor-in-rust", "title": "Setting the Type of a Struct Constructor in Rust", "body": "<p>I have a matrix data type in Rust that supports a generic element data type.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct Matrix&lt;T&gt; {\n    data: Vec&lt;T&gt;,  // row-major storage\n    nrows: usize,\n    ncols: usize,\n}\n</code></pre>\n\n<p>I would like to create a family of different matrix constructors such as <code>zero</code> and <code>eye</code> which output the zero matrix and the identity matrix, respectively. A standard <code>Matrix::new()</code> constructor is straightforward:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;T&gt; Matrix&lt;T&gt; {\n    pub fn new(data: Vec&lt;T&gt;, nrows: usize, ncols: usize) -&gt; Matrix&lt;T&gt; {\n        assert!(data.len() == nrows*ncols);\n\n        Matrix { data: data, nrows: nrows, ncols: ncols }\n    }\n}\n</code></pre>\n\n<p>The underlying type <code>T</code> is inferred from the type of the initializing vector. However, when I try to write a <code>Matrix::zero()</code> constructor I run into issues figuring out how to infer the type since the only parameters I want to pass is the size.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;T&gt; Matrix&lt;T&gt; {\n    pub fn zero(nrows: usize, ncols: usize) -&gt; Matrix&lt;T&gt;\n    where T : Clone\n    {\n        let data: Vec&lt;T&gt; = vec![0; nrows*ncols];\n        Matrix::new(data, nrows, ncols)\n    }\n}\n</code></pre>\n\n<p>Trying to compile this results in the error message:</p>\n\n<pre><code>error[E0308]: mismatched types                                                                                                                \n  --&gt; src/tools.rs:39:33                                                                                                                      \n   |                                                                                                                                          \n39 |         let data: Vec&lt;T&gt; = vec![0; nrows*ncols];                                                                                         \n   |                                 ^ expected type parameter, found integral variable                                                       \n   |                                                                                                                                          \n   = note: expected type `T`                                                                                                                  \n              found type `{integer}`     \n</code></pre>\n\n<p>I tried <code>0 as T</code> and <code>T::from(0)</code> and those don't resolve the issue. (To be honest, I don't yet understand why.) One possible solution is to change the function definition to <code>zero(_value: T, nrows: usize, ncols: usize)</code> and construct the data vector via <code>vec![_value; ...]</code> but that seems odd.</p>\n\n<p>Whatever the solution my end goal is to be able to simply write,</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let a: Matrix&lt;f32&gt; = Matrix::zero(nrows, ncols);\n// ... or ...\nlet b = Matrix&lt;f32&gt;::zero(nrows, ncols);\n// ... or ...\nlet c = Matrix::zero&lt;f32&gt;(nrows, ncols);\n// ... or something else?\n</code></pre>\n"}, {"tags": ["optimization", "rust", "user-input"], "comments": [{"owner": {"reputation": 6137, "user_id": 847382, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/b73e2fff665c33621c8a4347cf8074be?s=128&d=identicon&r=PG", "display_name": "PitaJ", "link": "https://stackoverflow.com/users/847382/pitaj"}, "edited": false, "score": 3, "creation_date": 1543612653, "post_id": 53564895, "comment_id": 93995875, "body": "<a href=\"https://codereview.stackexchange.com\">codereview.stackexchange.com</a> is a better place for questions like this."}], "answers": [{"tags": [], "owner": {"reputation": 30359, "user_id": 255688, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/74b63650ed07d745fd9accf52e4d286b?s=128&d=identicon&r=PG", "display_name": "phimuemue", "link": "https://stackoverflow.com/users/255688/phimuemue"}, "is_accepted": false, "score": 0, "last_activity_date": 1543653870, "creation_date": 1543653870, "answer_id": 53569156, "question_id": 53564895, "link": "https://stackoverflow.com/questions/53564895/how-can-i-improve-this-code-prompt-user-input-rust/53569156#53569156", "title": "How can I improve this code? Prompt user input [Rust]", "body": "<p>Just some hints:</p>\n\n<ul>\n<li><p>I think I would return something related to <a href=\"https://doc.rust-lang.org/std/net/enum.IpAddr.html\" rel=\"nofollow noreferrer\"><code>std::net::IpAddr</code></a> instead of <code>String</code> (if there's a type for your needs, I would use it).</p></li>\n<li><p><a href=\"https://doc.rust-lang.org/std/net/enum.IpAddr.html\" rel=\"nofollow noreferrer\"><code>std::net::IpAddr</code></a> implements <a href=\"https://doc.rust-lang.org/std/net/enum.IpAddr.html#impl-FromStr\" rel=\"nofollow noreferrer\"><code>FromStr</code></a>, so you can use <code>input_text.parse()</code> and obtain a <code>Result&lt;IpAddr, Err&gt;</code> (since the conversion from string may fail).</p></li>\n<li><p>I would use <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.trim\" rel=\"nofollow noreferrer\"><code>trim</code></a> to get rid of spaces.</p></li>\n<li><p>I would use <code>is_empty</code> to test if the string is empty. - Or even cover this case by just using <code>parse</code>.</p></li>\n<li><p>There are (at least) two places that may fail: <code>read_line</code> and <code>parse</code>, so I would think about returning an <code>Option&lt;IpAddr&gt;</code> or even <code>Result&lt;IpAddr, ErrorType&gt;</code> for an appropriate <code>ErrorType</code>.</p></li>\n</ul>\n"}], "owner": {"reputation": 51, "user_id": 7273992, "user_type": "registered", "profile_image": "https://graph.facebook.com/1163824203667568/picture?type=large", "display_name": "Paul Mikulskis", "link": "https://stackoverflow.com/users/7273992/paul-mikulskis"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 120, "favorite_count": 0, "answer_count": 1, "score": -1, "last_activity_date": 1543653870, "creation_date": 1543611920, "question_id": 53564895, "link": "https://stackoverflow.com/questions/53564895/how-can-i-improve-this-code-prompt-user-input-rust", "title": "How can I improve this code? Prompt user input [Rust]", "body": "<p>I am learning Rust by just coding right after the first 4 chapters of The Book.  Getting started I am still getting used to how borrowing and sharing work and how we can take advantage of them in code.  </p>\n\n<p>This snippet of code is supposed to prompt user for an IP address, and if enter is pressed, then to return the loopback address.  It works fine, but I am curious to know how this could be improved in any ways, because I definitely know it can.  Thank you!</p>\n\n<pre><code>fn prompt_host() -&gt; String {\n   let mut input_text = String::new();\n   println!(\" input host IP, press enter for loopback:\");\n   io::stdin()\n     .read_line(&amp;mut input_text)\n     .expect(\" ERROR: failed to read from stdin\");\n   let len = input_text.len();\n   input_text.truncate(len - 1);\n   if input_text == \"\" {\n      return String::from(\"127.0.0.1\");\n   }\n   return input_text as String;\n}\n</code></pre>\n"}, {"tags": ["javascript", "rust", "webassembly", "mandelbrot"], "comments": [{"owner": {"reputation": 105043, "user_id": 5260024, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XxSHe.jpg?s=128&g=1", "display_name": "Jonas Wilms", "link": "https://stackoverflow.com/users/5260024/jonas-wilms"}, "edited": false, "score": 1, "creation_date": 1543606310, "post_id": 53563718, "comment_id": 93993224, "body": "The JavaScript engines were optimized since more than 10 Years, the WASM engines are just a year old."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 105043, "user_id": 5260024, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XxSHe.jpg?s=128&g=1", "display_name": "Jonas Wilms", "link": "https://stackoverflow.com/users/5260024/jonas-wilms"}, "edited": false, "score": 1, "creation_date": 1543606531, "post_id": 53563718, "comment_id": 93993330, "body": "@JonasWilms The whole point of Wasm is that it is meant to run a lot faster than JavaScript. This is from the first few sentences of the <a href=\"https://en.wikipedia.org/wiki/WebAssembly\" rel=\"nofollow noreferrer\">Wikipedia article</a>: &quot;[Wasm] is meant to enable executing code nearly as quickly as running native machine code. It was envisioned to complement JavaScript to speed up performance-critical parts of web applications and later on to enable web development in languages other than JavaScript.&quot;"}, {"owner": {"reputation": 105043, "user_id": 5260024, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XxSHe.jpg?s=128&g=1", "display_name": "Jonas Wilms", "link": "https://stackoverflow.com/users/5260024/jonas-wilms"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543606755, "post_id": 53563718, "comment_id": 93993438, "body": "@sven just because it could be faster doesn&#39;t mean that it necessarily run faster in practice. V8 compiles heavily used functions in JS down to bytecode (if it is able to deduce the types and resolve references statically), not sure how far the WASM development is yet."}, {"owner": {"reputation": 1778, "user_id": 5698740, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/faee64fe3fa6b806a89f84492ba6c431?s=128&d=identicon&r=PG&f=1", "display_name": "clmno", "link": "https://stackoverflow.com/users/5698740/clmno"}, "edited": false, "score": 0, "creation_date": 1543606989, "post_id": 53563718, "comment_id": 93993538, "body": "Possible <a href=\"https://stackoverflow.com/questions/48173979/why-is-webassembly-function-almost-300-time-slower-than-same-js-function\">duplicate</a>. What Daniel did was a &#39;micro benchmark&#39;. A lot more optimizations are needed."}, {"owner": {"reputation": 446, "user_id": 3755582, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e3619716eddda8c3b1e0ad30c5f8b05?s=128&d=identicon&r=PG", "display_name": "alexcrichton", "link": "https://stackoverflow.com/users/3755582/alexcrichton"}, "edited": false, "score": 3, "creation_date": 1543608906, "post_id": 53563718, "comment_id": 93994405, "body": "@daniel-ramos can you provide some instructions of how to build the source code? I&#39;m getting an error about trying to build it and that makes it difficult to try to reproduce the measurements!  Otherwise one problem I can see so far is that you&#39;re not using <code>cargo build --release</code> (note how you&#39;re running <code>wasm-bindgen</code> over the <code>debug</code> folder). The Rust and WebAssembly book has a <a href=\"https://rustwasm.github.io/book/game-of-life/time-profiling.html\" rel=\"nofollow noreferrer\">great section</a> on time profiling if you&#39;re interested as well!"}, {"owner": {"reputation": 1379, "user_id": 4660706, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/10203622681675852/picture?type=large", "display_name": "Daniel Ramos", "link": "https://stackoverflow.com/users/4660706/daniel-ramos"}, "reply_to_user": {"reputation": 446, "user_id": 3755582, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e3619716eddda8c3b1e0ad30c5f8b05?s=128&d=identicon&r=PG", "display_name": "alexcrichton", "link": "https://stackoverflow.com/users/3755582/alexcrichton"}, "edited": false, "score": 0, "creation_date": 1543611200, "post_id": 53563718, "comment_id": 93995314, "body": "@alexcrichton It should be as easy as an <code>npm start</code>, and in order to build a <code>make</code> should be enough. I&#39;ll try the <code>--release</code> option!"}, {"owner": {"reputation": 1379, "user_id": 4660706, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/10203622681675852/picture?type=large", "display_name": "Daniel Ramos", "link": "https://stackoverflow.com/users/4660706/daniel-ramos"}, "reply_to_user": {"reputation": 446, "user_id": 3755582, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e3619716eddda8c3b1e0ad30c5f8b05?s=128&d=identicon&r=PG", "display_name": "alexcrichton", "link": "https://stackoverflow.com/users/3755582/alexcrichton"}, "edited": false, "score": 0, "creation_date": 1543612436, "post_id": 53563718, "comment_id": 93995794, "body": "@alexcrichton Thanks you a lot!!! The <code>--realease</code>"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 105043, "user_id": 5260024, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XxSHe.jpg?s=128&g=1", "display_name": "Jonas Wilms", "link": "https://stackoverflow.com/users/5260024/jonas-wilms"}, "edited": false, "score": 2, "creation_date": 1543617646, "post_id": 53563718, "comment_id": 93997584, "body": "@JonasWilms Basically the main point of Wasm is that it actually <i>does</i> run faster in practice. Much of it runs at near-native speed, and even the best optimised JavaScript JIT won&#39;t be able to compete with it.  I recommend reading <a href=\"https://hacks.mozilla.org/2017/02/what-makes-webassembly-fast/\" rel=\"nofollow noreferrer\">this nice article by Lin Clark</a> as an introduction."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1543837149, "post_id": 53563718, "comment_id": 94048625, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/25255736/why-is-my-rust-program-slower-than-the-equivalent-java-program\">Why is my Rust program slower than the equivalent Java program?</a>"}, {"owner": {"reputation": 1379, "user_id": 4660706, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/10203622681675852/picture?type=large", "display_name": "Daniel Ramos", "link": "https://stackoverflow.com/users/4660706/daniel-ramos"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1544443439, "post_id": 53563718, "comment_id": 94265122, "body": "Yes @hellow, it&#39;s duplicated"}], "answers": [{"tags": [], "owner": {"reputation": 1379, "user_id": 4660706, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/10203622681675852/picture?type=large", "display_name": "Daniel Ramos", "link": "https://stackoverflow.com/users/4660706/daniel-ramos"}, "is_accepted": false, "score": 3, "last_activity_date": 1543690805, "creation_date": 1543690805, "answer_id": 53574087, "question_id": 53563718, "link": "https://stackoverflow.com/questions/53563718/why-webassembly-is-so-slow/53574087#53574087", "title": "Why WebAssembly is so slow?", "body": "<p>Remember to use the <code>--release</code> flag when building.</p>\n"}], "owner": {"reputation": 1379, "user_id": 4660706, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/10203622681675852/picture?type=large", "display_name": "Daniel Ramos", "link": "https://stackoverflow.com/users/4660706/daniel-ramos"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 858, "favorite_count": 0, "closed_date": 1543846748, "answer_count": 1, "score": -3, "last_activity_date": 1543690805, "creation_date": 1543606079, "question_id": 53563718, "link": "https://stackoverflow.com/questions/53563718/why-webassembly-is-so-slow", "closed_reason": "Not suitable for this site", "title": "Why WebAssembly is so slow?", "body": "<p>I'm implementing a Mandelbrot Set visualization using Rust with WebAssmbly, where my goal is to make it using multi-threading.</p>\n\n<p>I've implemented the Mandelbrot Set both in Javascript (using Typescript) and in Rust single-threaded so far. I've made some benchmarks and the Rust implementation is about x17 time slower, and I'm completely lost here, I don't know why I'm getting this bad performance.</p>\n\n<p>Here is the repo, at <code>master</code> the implementation that uses Rust, and in <code>js-implementation</code> the one with Rust.</p>\n\n<p><a href=\"https://github.com/DanielRamosAcosta/mandlerbot-set-webassembly\" rel=\"nofollow noreferrer\">https://github.com/DanielRamosAcosta/mandlerbot-set-webassembly</a></p>\n\n<p>Thanks in advance.</p>\n"}, {"tags": ["arrays", "rust", "iterator"], "answers": [{"comments": [{"owner": {"reputation": 29866, "user_id": 930450, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/se3CE.png?s=128&g=1", "display_name": "Ixx", "link": "https://stackoverflow.com/users/930450/ixx"}, "edited": false, "score": 0, "creation_date": 1615016900, "post_id": 53562362, "comment_id": 117566115, "body": "Can you get an array back, instead of converting to <code>Vec</code>?"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 6, "last_activity_date": 1595322626, "last_edit_date": 1595322626, "creation_date": 1543599664, "answer_id": 53562362, "question_id": 53561870, "link": "https://stackoverflow.com/questions/53561870/how-to-map-an-array-reference-in-rust/53562362#53562362", "title": "How to map an array reference in Rust", "body": "<p>The type <code>&amp;[T]</code> doesn't have a <code>map</code> method. If you look at the error message, it is telling you that a method called <code>map</code> exists but it won't work for <code>&amp;mut &amp;[u8]</code> or <code>&amp;mut [u8]</code> because those types do not implement <code>Iterator</code>.  Arrays and other collections usually have a method, or set of methods, for creating an iterator. For a slice or an array, you have the choice of either <code>iter()</code> (iterating over references) or <code>into_iter()</code> (iterating over moved values and consuming the source collection).</p>\n<p>Usually, you'll also want to collect the values into some other collection:</p>\n<pre><code>let res: Vec&lt;u8&gt; = buffer\n    .iter()\n    .map(|x| 0xff)\n    .collect();\n</code></pre>\n"}], "owner": {"reputation": 427, "user_id": 3520890, "user_type": "registered", "accept_rate": 0, "profile_image": "https://graph.facebook.com/1167498460/picture?type=large", "display_name": "Werem", "link": "https://stackoverflow.com/users/3520890/werem"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3112, "favorite_count": 0, "accepted_answer_id": 53562362, "answer_count": 1, "score": 2, "last_activity_date": 1595322626, "creation_date": 1543597272, "last_edit_date": 1546955673, "question_id": 53561870, "link": "https://stackoverflow.com/questions/53561870/how-to-map-an-array-reference-in-rust", "title": "How to map an array reference in Rust", "body": "<p>I have this array</p>\n\n<pre><code>let buffer: &amp;[u8] = &amp;[0; 40000];\n</code></pre>\n\n<p>But when I want to map it like this:</p>\n\n<pre><code>*buffer.map( |x| 0xff);\n</code></pre>\n\n<p>I have the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0599]: no method named `map` found for type `&amp;[u8]` in the current scope   \n     --&gt; src/bin/save_png.rs:12:13\n    | \n 12 |     *buffer.map( |x| 0xff); //.map(|x| 0xff);\n    |             ^^^\n    |\n    = note: the method `map` exists but the following trait bounds were not satisfied:\n            `&amp;mut &amp;[u8] : std::iter::Iterator`\n            `&amp;mut [u8] : std::iter::Iterator`\n</code></pre>\n\n<p>I tried several ways to do the elements mutable but I can't get the right syntax. Anyone have experience? I'm trying to work with a png image buffer.</p>\n"}, {"tags": ["rust", "rust-tokio"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543581189, "post_id": 53557609, "comment_id": 93980592, "body": "Can you please provide the sourcecode that provokes the error? I&#39;m not sure what to do to reproduce your error"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543581279, "post_id": 53557609, "comment_id": 93980637, "body": "Btw, you are propably looking for <code>sender.clone().send(x)</code>"}, {"owner": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543585561, "post_id": 53557609, "comment_id": 93982906, "body": "See edits for example. I&#39;m not sure <code>sender.clone().send(x)</code> is what I want, as I don&#39;t want to add capacity to my channel."}], "answers": [{"comments": [{"owner": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "edited": false, "score": 0, "creation_date": 1543589319, "post_id": 53559333, "comment_id": 93984926, "body": "This does work, however I&#39;d like to avoid cloning the sender if possible - if the channel is full, the event loop should block and switch to processing the already sent messages. With this code, I get all the <code>Adding channel</code> and <code>Sending _</code>, and then all the <code>Receiving _</code> printed, they should be interleaved."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "edited": false, "score": 0, "creation_date": 1543628908, "post_id": 53559333, "comment_id": 93999826, "body": "@kai Unfortunately this is beyond my knowledge, also you are not allowed to block in a <code>for_each()</code> of a stream."}, {"owner": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "edited": false, "score": 0, "creation_date": 1543654147, "post_id": 53559333, "comment_id": 94003351, "body": "OK, I&#39;ll keep at it for a few more days and accept this answer if I can&#39;t figure anything out. Thanks!"}], "tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 1, "last_activity_date": 1543588461, "last_edit_date": 1543588461, "creation_date": 1543587710, "answer_id": 53559333, "question_id": 53557609, "link": "https://stackoverflow.com/questions/53557609/send-to-each-futuressyncmpscsender-in-array/53559333#53559333", "title": "Send to each futures::sync::mpsc::Sender in array", "body": "<p>AFAIK, You have two main problems, <code>send()</code> take the ownership of <code>Sender</code> so you have to clone somewhere if you want reuse it later and also it returns a future that you have to process somehow.</p>\n\n<p>There are different ways to fix these problems, here one:</p>\n\n<pre><code>extern crate futures;\nextern crate tokio;\n\nuse futures::sync::mpsc;\nuse futures::Future;\nuse futures::{stream, Sink, Stream};\n\nfn main() {\n    let values = vec![1i8, 2, 0, 1, 2, 3, 0, 1, 2, 3, -1]; // remove cast syntax\n    let mut senders = vec![]; // remove annotations\n    let stream = stream::iter_ok(values).for_each(move |v| { // move senders\n        match v {\n            0 =&gt; {\n                println!(\"Adding channel\");\n                let (sender, receiver) = mpsc::channel(1);\n                senders.push(sender);\n                tokio::spawn(receiver.for_each(|v| {\n                    println!(\"Received {}\", v);\n                    Ok(())\n                }));\n            }\n            -1 =&gt; {\n                println!(\"Closing channels\");\n                senders.clear();\n            }\n            x =&gt; {\n                for sender in senders.iter() {\n                    let send = sender\n                        .clone() // clone sender\n                        .send(x)\n                        .map(move |_| println!(\"Sending {}\", x))\n                        .map_err(|e| eprintln!(\"error = {:?}\", e));\n                    tokio::spawn(send); // spawn the task\n                }\n            }\n        }\n        Ok(())\n    });\n\n    tokio::run(stream);\n    println!(\"Done!\");\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "is_accepted": true, "score": 0, "last_activity_date": 1544564352, "last_edit_date": 1544564352, "creation_date": 1544473956, "answer_id": 53713211, "question_id": 53557609, "link": "https://stackoverflow.com/questions/53557609/send-to-each-futuressyncmpscsender-in-array/53713211#53713211", "title": "Send to each futures::sync::mpsc::Sender in array", "body": "<p>I think I've worked it out - the trick is to pass <code>senders</code> in and keep passing it down the chain of futures. This doesn't handle the <code>-1</code> to clear senders but the extension is straightforward.</p>\n\n<pre><code>extern crate tokio;\nuse tokio::runtime::current_thread;\n\nextern crate futures;\nuse futures::{stream, Stream, Sink, Future, IntoFuture};\nuse futures::sync::mpsc;\nuse futures::future::Either;\n\nfn main() {\n    let values = vec![0, 1, 0, 2, 3];\n    let stream = stream::iter_ok::&lt;Vec&lt;i8&gt;, mpsc::SendError&lt;i8&gt;&gt;(values)\n        .fold(Vec::new(), |mut senders, v| {\n            match v {\n                0 =&gt; {\n                    println!(\"Adding channel\");\n                    let (sender, receiver) = mpsc::channel(0);\n                    senders.push(sender);\n                    let idx = senders.len();\n                    current_thread::spawn(receiver.for_each(move |v| {\n                        println!(\"Received {} in channel {}\", v, idx);\n                        Ok(())\n                    }));\n                    Either::A(Ok(senders).into_future())\n                },\n                value =&gt; {\n                    println!(\"Sending {}...\", value);\n                    Either::B(stream::iter_ok(senders).and_then(move |tx| {\n                        tx.send(value)\n                    }).collect().map(move |senders| {\n                        println!(\"Sent {}.\", value);\n                        senders\n                    }))\n                },\n            }\n        }).map(drop);\n\n    current_thread::block_on_all(stream)\n        .expect(\"Failed to run stream\");\n    println!(\"Done!\");\n}\n</code></pre>\n\n<p>This outputs:</p>\n\n<pre><code>Adding channel\nSending 1...\nReceived 1 in channel 1\nSent 1.\nAdding channel\nSending 2...\nReceived 2 in channel 1\nReceived 2 in channel 2\nSent 2.\nSending 3...\nReceived 3 in channel 1\nReceived 3 in channel 2\nSent 3.\nDone!\n</code></pre>\n"}], "owner": {"reputation": 1774, "user_id": 844614, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/2d23e5966afffe052801e20b0a558c1a?s=128&d=identicon&r=PG&f=1", "display_name": "kai", "link": "https://stackoverflow.com/users/844614/kai"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 770, "favorite_count": 0, "accepted_answer_id": 53713211, "answer_count": 2, "score": 1, "last_activity_date": 1544564352, "creation_date": 1543580828, "last_edit_date": 1543663857, "question_id": 53557609, "link": "https://stackoverflow.com/questions/53557609/send-to-each-futuressyncmpscsender-in-array", "title": "Send to each futures::sync::mpsc::Sender in array", "body": "<p>I have a dynamic collection of <code>futures::sync::mpsc::Sender</code>, and I would like to send a message to each of them for every incoming connection.</p>\n\n<p>I have it working with <code>UnboundedSender</code>, because I can just do that (see below) but <code>Sender</code> consumes itself, so I need to remove and reinsert it into the <code>Vec</code> after sending. How can I do this? If the <code>Sender</code> blocks, it should not send more messages, but instead switch to handling the incoming connections on the receiver.</p>\n\n<p>The <code>UnboundedSender</code> implementation is below, my failed attempt at doing it otherwise is commented out inline (just replace the preceeding line with the commented out one).</p>\n\n<h1>UnboundedSender (works)</h1>\n\n<pre><code>extern crate tokio;\nuse tokio::runtime::current_thread;\n\nextern crate futures;\nuse futures::{stream, Stream, Sink};\nuse futures::sync::mpsc;\n\nfn main() {\n    let values = vec![1 as i8, 2, 0, 1, 2, 3, 0, 1, 2, 3, -1];\n    let mut senders = Vec::&lt;mpsc::UnboundedSender&lt;i8&gt;&gt;::new();\n    let stream = stream::iter_ok::&lt;_, ()&gt;(values)\n        .for_each(|v| {\n            match v {\n                0 =&gt; {\n                    println!(\"Adding channel\");\n                    let (sender, receiver) = mpsc::unbounded();\n                    senders.push(sender);\n                    current_thread::spawn(receiver.for_each(|v| {\n                        println!(\"Received {}\", v);\n                        Ok(())\n                    }))\n\n                },\n                -1 =&gt; {\n                    println!(\"Closing channels\");\n                    senders.clear();\n                },\n                x =&gt; {\n                    for sender in senders.iter() {\n                        println!(\"Sending {}\", x);\n                        sender.unbounded_send(x).unwrap();\n                    }\n                },\n            }\n            Ok(())\n        });\n\n    current_thread::block_on_all(stream)\n        .expect(\"Failed to run stream\");\n    println!(\"Done!\");\n}\n</code></pre>\n\n<h1>Sender (doesn't work)</h1>\n\n<pre><code>extern crate tokio;\nuse tokio::runtime::current_thread;\n\nextern crate futures;\nuse futures::{stream, Stream, Sink};\nuse futures::sync::mpsc;\n\nfn main() {\n    let values = vec![1 as i8, 2, 0, 1, 2, 3, 0, 1, 2, 3, -1];\n    let mut senders = Vec::&lt;mpsc::Sender&lt;i8&gt;&gt;::new();\n    let stream = stream::iter_ok::&lt;_, ()&gt;(values)\n        .for_each(|v| {\n            match v {\n                0 =&gt; {\n                    println!(\"Adding channel\");\n                    let (sender, receiver) = mpsc::channel(1);\n                    senders.push(sender);\n                    current_thread::spawn(receiver.for_each(|v| {\n                        println!(\"Received {}\", v);\n                        Ok(())\n                    }))\n\n                },\n                -1 =&gt; {\n                    println!(\"Closing channels\");\n                    senders.clear();\n                },\n                x =&gt; {\n                    for sender in senders.iter() {\n                        println!(\"Sending {}\", x);\n                        sender.send(x);\n                        //^error[E0507]: cannot move out of borrowed content\n                    }\n                },\n            }\n            Ok(())\n        });\n\n    current_thread::block_on_all(stream)\n        .expect(\"Failed to run stream\");\n    println!(\"Done!\");\n}\n</code></pre>\n"}, {"tags": ["rust", "qemu", "redox-os"], "answers": [{"tags": [], "owner": {"reputation": 59, "user_id": 1836947, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/52e7b3fecc2913826eacb7652e73286b?s=128&d=identicon&r=PG", "display_name": "RebelAlliance", "link": "https://stackoverflow.com/users/1836947/rebelalliance"}, "is_accepted": false, "score": 1, "last_activity_date": 1543575849, "creation_date": 1543575849, "answer_id": 53556269, "question_id": 53556268, "link": "https://stackoverflow.com/questions/53556268/how-do-i-run-the-precompiled-image-of-rust-based-redox-os-on-windows10-64-bit-un/53556269#53556269", "title": "How do I run the precompiled image of Rust-based Redox OS on Windows10 64-bit under QEMU emulator?", "body": "<ol>\n<li>Download the Redox OS ISO drive image that will have the compiled OS image that QEMU will later execute.  Please obtain the latest release of the .ISO file from <a href=\"https://gitlab.redox-os.org/redox-os/redox/tags\" rel=\"nofollow noreferrer\">here</a> (click on download link for the latest release).</li>\n<li>Mount the ISO image using a an <a href=\"https://www.elby.ch/en/products/vcd.html\" rel=\"nofollow noreferrer\">image mounter</a> that will be able to show the ISO image as a drive attached to the system allowing file access.</li>\n<li>Copy LIVEDISK.gz file to your hard drive and extract the livedisk.bin file within.  This is the Redox bootable image via an emulator, in this case QEMU.\n<a href=\"https://i.stack.imgur.com/e6SR9.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/e6SR9.png\" alt=\"enter image description here\"></a></li>\n<li>Install latest version of precompiled QEMU images for Windows from <a href=\"https://qemu.weilnetz.de/w64/\" rel=\"nofollow noreferrer\">here</a>.</li>\n<li>Read this interesting <a href=\"https://tw.saowen.com/a/5e934b2c3d6bba0765c4f87b6a9eeed7ee807fee157b0ab98590881b8905817a\" rel=\"nofollow noreferrer\">blog tutorial</a> here and install HAXM for Genuine Intel CPUs.</li>\n<li>Execute QEMU from a DOS box using the following command (Fix to specify your proper directories):</li>\n</ol>\n\n<hr>\n\n<pre><code>C:\\Program Files\\qemu&gt;qemu-system-x86_64 -serial mon:stdio -d cpu_reset -d guest_errors -smp 4 -m 1024 -s -machine q35 -device ich9-intel-hda -device hda-duplex -net nic,model=e1000 -net user -device nec-usb-xhci,id=xhci -device usb-tablet,bus=xhci.0 -cpu qemu64 -drive file=C:\\Users\\redox\\Documents\\GitHub\\redox\\livedisk.bin,format=raw -accel hax\n</code></pre>\n\n<ol start=\"7\">\n<li>Follow instructions <a href=\"https://doc.redox-os.org/book/getting_started/try_vm.html\" rel=\"nofollow noreferrer\">here</a> to log into the Redox OS.  Enjoy!\n<a href=\"https://i.stack.imgur.com/lrUVy.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/lrUVy.png\" alt=\"enter image description here\"></a></li>\n</ol>\n\n<p>Notes: my mouse movement is super bad to the point of unusability.  Perhaps some massaging of the QEMU input device?  Not sure.  Any tips welcome :)</p>\n\n<p>TIP: Install source with directions <a href=\"https://doc.redox-os.org/book/getting_started/installing_the_toolchain.html\" rel=\"nofollow noreferrer\">here</a>.</p>\n"}], "owner": {"reputation": 59, "user_id": 1836947, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/52e7b3fecc2913826eacb7652e73286b?s=128&d=identicon&r=PG", "display_name": "RebelAlliance", "link": "https://stackoverflow.com/users/1836947/rebelalliance"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 939, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1543577686, "creation_date": 1543575849, "last_edit_date": 1543577686, "question_id": 53556268, "link": "https://stackoverflow.com/questions/53556268/how-do-i-run-the-precompiled-image-of-rust-based-redox-os-on-windows10-64-bit-un", "title": "How do I run the precompiled image of Rust-based Redox OS on Windows10 64-bit under QEMU emulator?", "body": "<p>How do I run the precompiled image of Rust-based Redox OS on Windows10 64-bit with the QEMU emulator?</p>\n"}, {"tags": ["data-structures", "linked-list", "rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543571670, "post_id": 53554862, "comment_id": 93975583, "body": "Not an exact duplicate but highly (!!!) related! <a href=\"https://stackoverflow.com/questions/41653148/singly-linked-list-in-rust\" title=\"singly linked list in rust\">stackoverflow.com/questions/41653148/singly-linked-list-in-r&zwnj;&#8203;ust</a>"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543571793, "post_id": 53554862, "comment_id": 93975655, "body": "Btw, you cannot modify <code>current_node</code> in that context, because it is currently borrowed, so this approach won&#39;t work."}, {"owner": {"reputation": 187, "user_id": 6742624, "user_type": "registered", "accept_rate": 82, "profile_image": "https://i.stack.imgur.com/5FTD2.jpg?s=128&g=1", "display_name": "YjyJeff", "link": "https://stackoverflow.com/users/6742624/yjyjeff"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543572367, "post_id": 53554862, "comment_id": 93975954, "body": "@hellow Thanks. I realized this problem and read the link you attached. However I still do not know how to fix it 0.0"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1543573238, "post_id": 53554862, "comment_id": 93976425, "body": "I hope you also read the provided link in the answer <a href=\"http://cglab.ca/~abeinges/blah/too-many-lists/book/third.html\" rel=\"nofollow noreferrer\">cglab.ca/~abeinges/blah/too-many-lists/book/third.html</a> This it <b>the</b> ultimate reference for linked lists in rust."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 4, "last_activity_date": 1543582689, "last_edit_date": 1543582689, "creation_date": 1543580215, "answer_id": 53557440, "question_id": 53554862, "link": "https://stackoverflow.com/questions/53554862/delete-a-node-in-singly-linked-list-in-rust/53557440#53557440", "title": "Delete a node in singly linked list in Rust", "body": "<p>There isn't really code that can go in that space to fix it; you'll need to make some bigger changes.</p>\n\n<p>One of the problems is that you have mutably borrowed the current node in <code>current_node</code>, but then need to mutate it while that reference still exists.</p>\n\n<p>Making use of non-lexical lifetimes in Edition 2018, you can do:</p>\n\n<pre><code>impl LinkedList {\n    fn remove(&amp;mut self, v: usize) -&gt; Option&lt;usize&gt; {\n        let mut current = &amp;mut self.head;\n        loop {\n            match current {\n                None =&gt; return None,\n                Some(node) if node.v == v =&gt; {\n                    *current = node.next.take();\n                    return Some(v);\n                },\n                Some(node) =&gt; {\n                    current = &amp;mut node.next;\n                }\n            }\n        }\n    }\n}\n</code></pre>\n\n<p>Somehow, using the match guard <code>if node.v == v</code> to make two match arms, instead of using an <code>if</code> condition inside one match arm, lets the borrower checker deduce that this is safe. I'm not sure why the <code>if</code> statement inside the match arm isn't allowed - there are some of the <a href=\"https://chat.stackoverflow.com/transcript/message/44710851#44710851\">opinion that this could be a bug</a>.</p>\n"}, {"tags": [], "owner": {"reputation": 304, "user_id": 2391947, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/tJfjd.jpg?s=128&g=1", "display_name": "Ari Firmanto", "link": "https://stackoverflow.com/users/2391947/ari-firmanto"}, "is_accepted": false, "score": 0, "last_activity_date": 1610678315, "creation_date": 1610678315, "answer_id": 65729724, "question_id": 53554862, "link": "https://stackoverflow.com/questions/53554862/delete-a-node-in-singly-linked-list-in-rust/65729724#65729724", "title": "Delete a node in singly linked list in Rust", "body": "<p>inspire by above answer, my solution is:</p>\n<pre><code>fn removeKFromList(mut head: ListNode&lt;i32&gt;, k: i32) -&gt; ListNode&lt;i32&gt; {\n  if head.is_none() {\n        return None;\n  }\n\n  let mut current = &amp;mut head;\n  loop {\n      match current {\n          None =&gt; break,\n          Some(node) if node.value == k =&gt; {\n              *current = node.next.take();\n          },\n          Some(node) =&gt; {\n              current = &amp;mut node.next;\n          }\n      }\n  }\n  return head;\n}\n</code></pre>\n"}], "owner": {"reputation": 187, "user_id": 6742624, "user_type": "registered", "accept_rate": 82, "profile_image": "https://i.stack.imgur.com/5FTD2.jpg?s=128&g=1", "display_name": "YjyJeff", "link": "https://stackoverflow.com/users/6742624/yjyjeff"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 645, "favorite_count": 0, "accepted_answer_id": 53557440, "answer_count": 2, "score": 6, "last_activity_date": 1610678315, "creation_date": 1543570790, "last_edit_date": 1546955699, "question_id": 53554862, "link": "https://stackoverflow.com/questions/53554862/delete-a-node-in-singly-linked-list-in-rust", "title": "Delete a node in singly linked list in Rust", "body": "<p>I am new to Rust and want to write linked list in Rust to have fun. I am confused about how to delete a node in the linked list. Here is my simple code. </p>\n\n<pre><code>#[derive(Debug)]\nstruct Node{\n    v: usize,\n    next: Option&lt;Box&lt;Node&gt;&gt;,\n}\n\nstruct LinkedList {\n    head: Option&lt;Box&lt;Node&gt;&gt;,\n}\n\nimpl LinkedList {\n    fn remove(&amp;mut self, v: usize) -&gt; Option&lt;usize&gt; {\n        let mut current_node: &amp;mut Option&lt;Box&lt;Node&gt;&gt; = &amp;mut self.head;\n        loop {\n           match current_node {\n                None =&gt; break,\n                Some(node) =&gt; {\n                    if node.v == v {\n                        // current_node = what? \n                        // ???????????????\n                        break;\n                    } else {\n                        current_node = &amp;mut node.next;\n                    }\n                },\n            };\n        }\n\n        match current_node.take().map(|x| *x) {\n            Some(node) =&gt; {\n                *current_node = node.next;\n                return Some(node.v)\n            },\n            None =&gt; None,\n        }\n    }\n}\n</code></pre>\n\n<p>And here is the rust <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=7e38a9006fb166fb10ba30cc0cda0b94\" rel=\"nofollow noreferrer\">playground</a>. I am using the nightly version and <code>edition = 2018</code>. In the loop, I try to find the node whose next node contains the value that I search for. However, I am confused about what to write in the ?? position.</p>\n"}, {"tags": ["asynchronous", "rust", "future"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 3, "creation_date": 1543553768, "post_id": 53551385, "comment_id": 93968796, "body": "please work on a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, you have too many useless code that make your question unclear Also error output doesn&#39;t match both snippet, and by the way it&#39;s unclear what snipped cause you trouble."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 2, "creation_date": 1543563553, "post_id": 53551385, "comment_id": 93971907, "body": "You probably want to use <a href=\"https://docs.rs/futures/0.1.25/futures/future/enum.Either.html\" rel=\"nofollow noreferrer\"><code>future::Either</code></a> to unify the two future types."}, {"owner": {"reputation": 1447, "user_id": 105428, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/f460da40d1da766a325518c473e0f8eb?s=128&d=identicon&r=PG", "display_name": "Liam", "link": "https://stackoverflow.com/users/105428/liam"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1543589648, "post_id": 53551385, "comment_id": 93985133, "body": "Thank you @Jmb that is exactly what I was looking for."}], "owner": {"reputation": 1447, "user_id": 105428, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/f460da40d1da766a325518c473e0f8eb?s=128&d=identicon&r=PG", "display_name": "Liam", "link": "https://stackoverflow.com/users/105428/liam"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 471, "favorite_count": 0, "closed_date": 1554592532, "answer_count": 0, "score": 1, "last_activity_date": 1543553080, "creation_date": 1543553080, "question_id": 53551385, "link": "https://stackoverflow.com/questions/53551385/how-to-return-early-from-a-rust-function-that-returns-a-future", "closed_reason": "Duplicate", "title": "How to return early from a Rust function that returns a future?", "body": "<p>I have a Rust function that takes an input URL, fetches some JSON, and returns a <code>Future</code> with the parsed output. Here is the function:</p>\n\n<pre><code>pub fn get&lt;Output&gt;(node: &amp;str, path: &amp;str) -&gt; impl Future&lt;Item = Output, Error = crate::Error&gt;\nwhere\n    Output: for&lt;'a&gt; Deserialize&lt;'a&gt;,\n{\n    let mut opts = RequestInit::new();\n    opts.method(\"GET\");\n    opts.mode(RequestMode::Cors);\n\n    let mut url = node.to_owned();\n    url.push_str(path);\n    let request = Request::new_with_str_and_init(url.as_str(), &amp;opts).unwrap();\n\n    let window = web_sys::window().unwrap();\n    let request_promise = window.fetch_with_request(&amp;request);\n\n    JsFuture::from(request_promise)\n        .and_then(|resp_value| {\n            assert!(resp_value.is_instance_of::&lt;Response&gt;());\n            let resp = resp_value.dyn_into::&lt;Response&gt;().unwrap();\n            resp.json()\n        })\n        .and_then(|json_value: Promise| {\n            JsFuture::from(json_value)\n        })\n        .and_then(|json| {\n            let out = json.into_serde::&lt;Output&gt;().unwrap();\n            future::ok(out)\n        })\n        .map_err(crate::Error::JsError)\n}\n</code></pre>\n\n<p>I would like to replace the <code>.unwrap()</code> calls to early return proper errors so that this function won't panic. Here is a similar function that I tried this with:</p>\n\n<pre><code>pub fn post&lt;Output, Params&gt;(\n    node: &amp;str,\n    path: &amp;str,\n    params: Params,\n) -&gt; impl Future&lt;Item = Output, Error = crate::Error&gt;\nwhere\n    Output: for&lt;'a&gt; Deserialize&lt;'a&gt;,\n    Params: Serialize,\n{\n    let mut opts = RequestInit::new();\n    opts.method(\"POST\");\n    opts.mode(RequestMode::Cors);\n\n    match ::serde_json::to_string(&amp;params) {\n        Ok(s) =&gt; opts.body(Some(&amp;JsValue::from_str(s.as_str()))),\n        Err(error) =&gt; return future::err(Error::BadRequestJson(error)),\n    };\n\n    let mut url = node.to_owned();\n    url.push_str(path);\n    let request = match Request::new_with_str_and_init(url.as_str(), &amp;opts) {\n        Ok(r) =&gt; r,\n        Err(_) =&gt; return future::err(Error::BadRequest),\n    };\n\n    let window = web_sys::window().unwrap();\n    let request_promise = window.fetch_with_request(&amp;request);\n\n    JsFuture::from(request_promise)\n        .and_then(|resp_value| {\n            assert!(resp_value.is_instance_of::&lt;Response&gt;());\n            let resp = resp_value.dyn_into::&lt;Response&gt;().unwrap();\n            resp.json()\n        })\n        .and_then(|json_value: Promise| {\n            JsFuture::from(json_value)\n        })\n        .and_then(|json| {\n            let info = json.into_serde::&lt;Output&gt;().unwrap();\n            future::ok(info)\n        })\n        .map_err(crate::Error::JsError)\n}\n</code></pre>\n\n<p>However the Rust compiler doesn't like this because two different types are being returned:</p>\n\n<pre><code>error[E0308]: mismatched types\n\n   |\n75 | /     JsFuture::from(request_promise)\n76 | |         .and_then(|resp_value| {\n77 | |             // `resp_value` is a `Response` object.\n78 | |             assert!(resp_value.is_instance_of::&lt;Response&gt;());\n...  |\n92 | |         })\n93 | |         .map_err(crate::Error::JsError)\n   | |_______________________________________^ expected struct `futures::future::result_::FutureResult`, found struct `futures::future::map_err::MapErr`\n   |\n   = note: expected type `futures::future::result_::FutureResult&lt;Output, error::Error&gt;`\n              found type `futures::future::map_err::MapErr&lt;futures::future::and_then::AndThen&lt;futures::future::and_then::AndThen&lt;futures::future::and_then::AndThen&lt;wasm\n_bindgen_futures::JsFuture, std::result::Result&lt;js_sys::Promise, wasm_bindgen::JsValue&gt;, \n</code></pre>\n\n<p>So is it possible to early return from this function without changing the return type? I know I could change the return type to a <code>Result</code> but that seems unnecessarily verbose.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 92118, "user_id": 1217358, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d2aafb97833979e3668c61d36e697bfc?s=128&d=identicon&r=PG", "display_name": "Warren Weckesser", "link": "https://stackoverflow.com/users/1217358/warren-weckesser"}, "edited": false, "score": 2, "creation_date": 1543517940, "post_id": 53545792, "comment_id": 93958251, "body": "From the link to the docs that you gave: &quot;This function has the same error semantics as <code>read_until</code> and will also return an error if the read bytes are not valid UTF-8.&quot;"}, {"owner": {"reputation": 839, "user_id": 2558618, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/fbf0e7355e62c38090274ac45535f001?s=128&d=identicon&r=PG", "display_name": "Unsolved Cypher", "link": "https://stackoverflow.com/users/2558618/unsolved-cypher"}, "reply_to_user": {"reputation": 92118, "user_id": 1217358, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d2aafb97833979e3668c61d36e697bfc?s=128&d=identicon&r=PG", "display_name": "Warren Weckesser", "link": "https://stackoverflow.com/users/1217358/warren-weckesser"}, "edited": false, "score": 0, "creation_date": 1543517992, "post_id": 53545792, "comment_id": 93958272, "body": "@WarrenWeckesser thank you, I missed that. Are there any alternative to read the bytes otherwise?"}, {"owner": {"reputation": 95188, "user_id": 440119, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/5ec9ca2a92a94a5470396073129d79e7?s=128&d=identicon&r=PG", "display_name": "Benjamin Lindley", "link": "https://stackoverflow.com/users/440119/benjamin-lindley"}, "edited": false, "score": 2, "creation_date": 1543518634, "post_id": 53545792, "comment_id": 93958554, "body": "@UnsolvedCypher: Do you have non-text data that is delimited by newline characters? That seems strange, but if that&#39;s really the case, then your alternative is the function mentioned in Warren&#39;s comment. <code>read_until</code>."}], "answers": [{"comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543522141, "post_id": 53546477, "comment_id": 93960170, "body": "I don&#39;t really see any advantage of this approach over using <code>read_until()</code> as suggested in the comments. For stdin, the approach in this answer may be OK, since stdin is always buffered in Rust. Don&#39;t try this with an unbuffered file, though \u2013 it will result in a system call for every single byte you read, so you will get abysmal performance."}, {"owner": {"reputation": 839, "user_id": 2558618, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/fbf0e7355e62c38090274ac45535f001?s=128&d=identicon&r=PG", "display_name": "Unsolved Cypher", "link": "https://stackoverflow.com/users/2558618/unsolved-cypher"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1543529497, "post_id": 53546477, "comment_id": 93963305, "body": "@SvenMarnach this may just be my inexperience in Rust, but I couldn&#39;t figure out how to call read_until() on stdin, all of the examples I found were for reading from files or other buffers."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1543531007, "post_id": 53546477, "comment_id": 93963867, "body": "You need to <code>lock()</code> stdin first. The resulting <code>StdinLock</code> object implements <code>BufRead</code>, and <code>read_until()</code> is a method of that trait."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1543531139, "post_id": 53546477, "comment_id": 93963918, "body": "See also the <a href=\"https://doc.rust-lang.org/nightly/std/io/fn.stdin.html\" rel=\"nofollow noreferrer\">second example on the documentation of <code>stdin</code></a>."}], "tags": [], "owner": {"reputation": 839, "user_id": 2558618, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/fbf0e7355e62c38090274ac45535f001?s=128&d=identicon&r=PG", "display_name": "Unsolved Cypher", "link": "https://stackoverflow.com/users/2558618/unsolved-cypher"}, "is_accepted": true, "score": 4, "last_activity_date": 1543520773, "creation_date": 1543520773, "answer_id": 53546477, "question_id": 53545792, "link": "https://stackoverflow.com/questions/53545792/reading-raw-bytes-from-standard-input-in-rust/53546477#53546477", "title": "Reading raw bytes from standard input in Rust", "body": "<p>It turns out that <a href=\"https://doc.rust-lang.org/std/io/struct.Stdin.html\" rel=\"nofollow noreferrer\">Stdin</a> implements the <a href=\"https://doc.rust-lang.org/std/io/trait.Read.html\" rel=\"nofollow noreferrer\">Read</a> trait, so I was able to use the <a href=\"https://doc.rust-lang.org/std/io/trait.Read.html#method.bytes\" rel=\"nofollow noreferrer\">bytes</a> method:</p>\n\n<pre><code>for i in io::stdin().bytes() {\n    println!(\"read byte {}\", i.unwrap());\n}\n</code></pre>\n\n<p>And this loop can be broken out of by checking each byte until it's the desired byte.</p>\n"}], "owner": {"reputation": 839, "user_id": 2558618, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/fbf0e7355e62c38090274ac45535f001?s=128&d=identicon&r=PG", "display_name": "Unsolved Cypher", "link": "https://stackoverflow.com/users/2558618/unsolved-cypher"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2056, "favorite_count": 0, "accepted_answer_id": 53546477, "answer_count": 1, "score": 6, "last_activity_date": 1543520773, "creation_date": 1543517725, "last_edit_date": 1543518078, "question_id": 53545792, "link": "https://stackoverflow.com/questions/53545792/reading-raw-bytes-from-standard-input-in-rust", "title": "Reading raw bytes from standard input in Rust", "body": "<p>I am trying to read in bytes from standard input in Rust. The code below works perfectly for lines consisting of regular characters, but for raw bytes that don't have associated characters (such as <code>0xe0</code>), this causes the program to panic. The <a href=\"https://doc.rust-lang.org/std/io/trait.BufRead.html#method.read_line\" rel=\"noreferrer\">documentation</a> says that it will terminate at the newline character, but doesn't mention any issues with non-character bytes. </p>\n\n<p>EDIT: I actually missed that it does say that all bytes must be UTF-8 encoded- is there another function I can use to do this?</p>\n\n<pre><code>    let mut input = String::new();\n    io::stdin().read_line(&amp;mut input)\n        .ok()\n        .expect(\"Couldn't read line\");   \n</code></pre>\n"}, {"tags": ["rust", "libc", "rust-cargo"], "answers": [{"tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": false, "score": 1, "last_activity_date": 1543524043, "creation_date": 1543524043, "answer_id": 53547228, "question_id": 53545506, "link": "https://stackoverflow.com/questions/53545506/does-rust-libc-crate-inhibit-the-compilation-of-custom-panic-handler/53547228#53547228", "title": "Does Rust libc crate inhibit the compilation of custom panic handler?", "body": "<p>You are running into a bug in Cargo.</p>\n\n<p>Features are a bit subtle. They can be enabled by any transitive dependency, which is expected behaviour. However, they can even be enabled by transitive <em>build</em> dependencies, which is a <a href=\"https://github.com/rust-lang/cargo/issues/5730\" rel=\"nofollow noreferrer\">bug</a>.</p>\n"}], "owner": {"reputation": 13, "user_id": 8022994, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/75040079da23baa70c82f69492eece0a?s=128&d=identicon&r=PG&f=1", "display_name": "JAlbers", "link": "https://stackoverflow.com/users/8022994/jalbers"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 495, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1543524043, "creation_date": 1543516543, "question_id": 53545506, "link": "https://stackoverflow.com/questions/53545506/does-rust-libc-crate-inhibit-the-compilation-of-custom-panic-handler", "title": "Does Rust libc crate inhibit the compilation of custom panic handler?", "body": "<p>So we are currently trying to compile some Rust code that we can then link to some C code. To do this we are using Bindgen to generate an FFI, and then we will use it to call some C functions from Rust.</p>\n\n<p>However, we must first have the crate \"libc\" as a dependency in the Cargo.toml file of the project. The project we are currently working on demands that we use the crate wide !#[no_std] attribute, as we don't want the entire stdlib of Rust. We only need the core. The <a href=\"https://crates.io/crates/libc\" rel=\"nofollow noreferrer\">libc crate</a> says we can \"request\" it not be linked to the standard library by putting some options in the Cargo.toml file, namely:</p>\n\n<pre><code>[dependencies]\nlibc = { version = \"0.2\", default-features = false }\n</code></pre>\n\n<p>This is all fine and dandy, but when we try to compile we get the following error message. </p>\n\n<pre><code>Ubuntu:~/nautilus/src/rust/example# cargo build\n   Compiling example v0.0.0 (/home/me/nautilus/src/rust/example)\nerror[E0152]: duplicate lang item found: `panic_impl`.\n  --&gt; src/lib.rs:33:1\n   |\n33 | / pub fn nk_rust_panic(_info: &amp;PanicInfo) -&gt; !\n34 | | {\n35 | |    // should call nk_panic here...\n36 | |    loop { }\n37 | | } \n   | |_^\n   |\n   = note: first defined in crate `std`.\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0152`.\nerror: Could not compile `example`.\n\nTo learn more, run the command again with --verbose.\n</code></pre>\n\n<p>E0152 is the following </p>\n\n<pre><code>A lang item was redefined.\n\nErroneous code example:\n\n```\n#![feature(lang_items)]\n\n#[lang = \"arc\"]\nstruct Foo; // error: duplicate lang item found: `arc`\n```\n\nLang items are already implemented in the standard library. Unless you are\nwriting a free-standing application (e.g. a kernel), you do not need to provide\nthem yourself.\n\nYou can build a free-standing crate by adding `#![no_std]` to the crate\nattributes:\n\n```\n#![no_std]\n```\n</code></pre>\n\n<p>Our lib.rs file has #![no_std] already in it, but it appears that since libc would normally link against stdlib, that maybe Rust thinks that we cannot have a custom panic handler if we are using libc. </p>\n\n<p>The problem relieves itself when we remove libc from the Cargo.toml file, and remove the <code>extern crate lib</code> from lib.rs.</p>\n\n<p>lib.rs</p>\n\n<pre><code>// no stdlib\n#![no_std]\n\n// Give us this feature to override?\n#![feature(start)]\n\n#![feature(lang_items)]\n\n// avoid buildins - we want it to use our library\n#![no_builtins]\n\n// The following cruft is here to handle Rust-&gt;OS dependencies\n// currently only one:  Rust needs to know how to panic\nuse core::panic::PanicInfo;\n\nextern crate libc;\n#[panic_handler]\n#[no_mangle]\npub fn nk_rust_panic(_info: &amp;PanicInfo) -&gt; !\n{\n   // should call nk_panic here... (panic handler of OS)\n   loop { }\n}\n</code></pre>\n\n<p>Cargo.toml</p>\n\n<pre><code>[package]\nname = \"example\"  # this is for core-kernel\nversion = \"0.0.0\"\n\n\n[lib]\ncrate-type = [\"staticlib\"]\n\n[dependencies]\nlibc = { version = \"0.2\", default-features = false }\n\n[build-dependencies]\nbindgen = \"0.42.2\"\n\n[profile.dev]\npanic = \"abort\"    # no stack unwind on rust panic\n\n[profile.release]\npanic = \"abort\"    # no stuck unwind on rust panic\n</code></pre>\n\n<p>So, in sum, does using libc as a dependency make us unable to use our own custom panic handler? Are there any wonky compiler flags we can pass directly to rustc to eliminate this problem? </p>\n\n<p>Compiler is 1.32.0-nightly \nLibc version is libc v0.2.44  </p>\n"}, {"tags": ["random", "rust", "statistics", "bit-manipulation"], "comments": [{"owner": {"reputation": 45685, "user_id": 69809, "user_type": "registered", "accept_rate": 96, "profile_image": "https://i.stack.imgur.com/yCVF0.jpg?s=128&g=1", "display_name": "Groo", "link": "https://stackoverflow.com/users/69809/groo"}, "edited": false, "score": 0, "creation_date": 1543497941, "post_id": 53539998, "comment_id": 93947150, "body": "If you can get only the <a href=\"http://graphics.stanford.edu/~seander/bithacks.html#CountBitsSetNaive\" rel=\"nofollow noreferrer\">number of set bits efficiently</a>, then you wouldn&#39;t have to creating a list of indices."}, {"owner": {"reputation": 4126, "user_id": 1319312, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/9424462776476a417ddfba4bc3cd77c7?s=128&d=identicon&r=PG", "display_name": "N. McA.", "link": "https://stackoverflow.com/users/1319312/n-mca"}, "reply_to_user": {"reputation": 45685, "user_id": 69809, "user_type": "registered", "accept_rate": 96, "profile_image": "https://i.stack.imgur.com/yCVF0.jpg?s=128&g=1", "display_name": "Groo", "link": "https://stackoverflow.com/users/69809/groo"}, "edited": false, "score": 0, "creation_date": 1543498052, "post_id": 53539998, "comment_id": 93947213, "body": "Yep, getting the number of set bits is cheaper - but I still need to set the bit in the final mask, so I need the indexes?"}, {"owner": {"reputation": 45685, "user_id": 69809, "user_type": "registered", "accept_rate": 96, "profile_image": "https://i.stack.imgur.com/yCVF0.jpg?s=128&g=1", "display_name": "Groo", "link": "https://stackoverflow.com/users/69809/groo"}, "edited": false, "score": 0, "creation_date": 1543498319, "post_id": 53539998, "comment_id": 93947367, "body": "Random function should just tell you to flip the ith bit, so you don&#39;t actually need to keep track of the list, but I believe you will still have to iterate through the bits. However, isn&#39;t the <code>rand()</code> function the real bottleneck here?"}, {"owner": {"reputation": 4126, "user_id": 1319312, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/9424462776476a417ddfba4bc3cd77c7?s=128&d=identicon&r=PG", "display_name": "N. McA.", "link": "https://stackoverflow.com/users/1319312/n-mca"}, "edited": false, "score": 0, "creation_date": 1543498629, "post_id": 53539998, "comment_id": 93947558, "body": "Don&#39;t have the profile in front of me, but yes rand() is the majority of the bottleneck. Irrc the rest of the current code is deeply sub-optimal though, and I think it might be possible to do something clever."}, {"owner": {"reputation": 45685, "user_id": 69809, "user_type": "registered", "accept_rate": 96, "profile_image": "https://i.stack.imgur.com/yCVF0.jpg?s=128&g=1", "display_name": "Groo", "link": "https://stackoverflow.com/users/69809/groo"}, "edited": false, "score": 1, "creation_date": 1543499334, "post_id": 53539998, "comment_id": 93947979, "body": "Perhaps you can state the actual problem if you believe it can be optimized. Right now I would say these optimizations would give you less than 1% improvements in speed (although profiling would give you exact values)."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1543500475, "post_id": 53539998, "comment_id": 93948661, "body": "What does this question have to do with Rust? The code example looks like python."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 3, "creation_date": 1543501601, "post_id": 53539998, "comment_id": 93949272, "body": "@hellow I assume the OP wants an answer in Rust and the Pythonish pseudocode is only meant to be illustrative."}], "answers": [{"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1543503134, "post_id": 53541399, "comment_id": 93950236, "body": "How did you come up with <code>mask &amp;= mask - 1</code>? Have you seen something similar before or did it just come to you? I always forget that you can do clever bit tricks with arithmetic operators too"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1543503483, "post_id": 53541399, "comment_id": 93950446, "body": "@trentcl I&#39;ve seen that before, a long time ago, but I can&#39;t remember where I picked it up. It&#39;s useful surprisingly often. :)"}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 4, "last_activity_date": 1543511027, "last_edit_date": 1543511027, "creation_date": 1543502184, "answer_id": 53541399, "question_id": 53539998, "link": "https://stackoverflow.com/questions/53539998/uniform-random-bit-from-a-mask/53541399#53541399", "title": "Uniform random bit from a mask", "body": "<p>The details how to optimize this depend on several factors you did not specify \u2013 the target architecture, the expected number of set bits in the mask, the language you want to use, the requirements on the randomness and many more. Without knowing further details, it's hard to give a useful answer, but I'll give a few hints that may prove useful anyway.</p>\n\n<p>Most modern architectures have an instruction to count the number of set bits in an integer, generally called \"popcount\", and this instruction is exposed in most low-level languages. In Rust, you can use the <a href=\"https://doc.rust-lang.org/nightly/std/primitive.u64.html#method.count_ones\" rel=\"nofollow noreferrer\"><code>count_ones()</code> method</a>. This gives you the total number <code>k</code> of bits to select from.</p>\n\n<p>You can then generate a random number <code>i</code> between <code>0</code> and <code>k - 1</code> (inclusive). The next step is to select the <code>i</code>th set bit in <code>mask</code>. An efficient approach to do so is this loop (Rust code):</p>\n\n<pre><code>for _ in 0..i {\n    mask &amp;= mask - 1;\n}\nlet new_mask = 1 &lt;&lt; mask.trailing_zeros();\n</code></pre>\n\n<p>The loop clears the least significant set bit in each iteration. Since <code>i &lt; k</code>, we know that <code>mask</code> can't be zero after the loop. The last line generates a new mask from the least significant bit of <code>mask</code> that is still set.</p>\n\n<p>On common architectures, it is likely that the bottleneck will be the random number generator. If you are using Rust's <code>rand</code> crate, you can use <a href=\"https://docs.rs/rand/0.6.1/rand/rngs/struct.SmallRng.html\" rel=\"nofollow noreferrer\"><code>SmallRng</code></a> for improved performance, at the cost of being cryptographically insecure, which may not be relevant for your use case.</p>\n"}], "owner": {"reputation": 4126, "user_id": 1319312, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/9424462776476a417ddfba4bc3cd77c7?s=128&d=identicon&r=PG", "display_name": "N. McA.", "link": "https://stackoverflow.com/users/1319312/n-mca"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 183, "favorite_count": 0, "accepted_answer_id": 53541399, "answer_count": 1, "score": 0, "last_activity_date": 1543511027, "creation_date": 1543497638, "last_edit_date": 1543507243, "question_id": 53539998, "link": "https://stackoverflow.com/questions/53539998/uniform-random-bit-from-a-mask", "title": "Uniform random bit from a mask", "body": "<p>Suppose I have a 64 bit unsigned integer (u64) <code>mask</code>, with one or more bits set.</p>\n\n<p>I want to select one of the set bits uniformly at random from <code>m</code> to give a new mask <code>x</code> such that <code>x &amp; mask</code> has one bit set. Some pseudocode that does this might be:</p>\n\n<pre><code>def uniform_random_bit_from_mask(mask):\n  assert mask &gt; 0\n  set_indices = get_set_indices(mask)\n  random_index = uniform_random_choice(set_indices)\n  new_mask = set_bit(random_index, 0)\n  return new_mask\n</code></pre>\n\n<p>However I need to do this as fast as possible (code similar to the above in a low-level language is slowing a hot loop). Does anyone have a more efficient scheme?</p>\n"}, {"tags": ["android", "kotlin", "dart", "rust", "flutter"], "comments": [{"owner": {"reputation": 26154, "user_id": 5436257, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/iGuaK.jpg?s=128&g=1", "display_name": "Joe Clay", "link": "https://stackoverflow.com/users/5436257/joe-clay"}, "edited": false, "score": 0, "creation_date": 1543495297, "post_id": 53532964, "comment_id": 93945694, "body": "Cross-linking to the associated Rust Users thread: <a href=\"https://users.rust-lang.org/t/rust-flutter-for-mobile-applications/22725/4\" rel=\"nofollow noreferrer\">users.rust-lang.org/t/rust-flutter-for-mobile-applications/&hellip;</a>"}, {"owner": {"reputation": 4583, "user_id": 6668797, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/FgETn.jpg?s=128&g=1", "display_name": "TWL", "link": "https://stackoverflow.com/users/6668797/twl"}, "edited": false, "score": 0, "creation_date": 1573258554, "post_id": 53532964, "comment_id": 103836332, "body": "you&#39;re going to have to be more specific with what you mean by <i>performance</i>, but for general testing, see <a href=\"https://stackoverflow.com/a/58772479/6668797\">stackoverflow.com/a/58772479/6668797</a>, or for ui-performance testing, see <a href=\"https://flutter.dev/docs/perf/rendering/ui-performance\" rel=\"nofollow noreferrer\">flutter.dev/docs/perf/rendering/ui-performance</a>"}], "answers": [{"tags": [], "owner": {"reputation": 15416, "user_id": 2441637, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/Z8fpp.jpg?s=128&g=1", "display_name": "Hasan A Yousef", "link": "https://stackoverflow.com/users/2441637/hasan-a-yousef"}, "is_accepted": true, "score": 1, "last_activity_date": 1576924183, "creation_date": 1576924183, "answer_id": 59435393, "question_id": 53532964, "link": "https://stackoverflow.com/questions/53532964/integrating-rust-flutter-kotlin-for-mobile-applications/59435393#59435393", "title": "Integrating Rust + Flutter + Kotlin for Mobile Applications", "body": "<p>With the introduction of <a href=\"https://dart.dev/guides/libraries/c-interop\" rel=\"nofollow noreferrer\">ffi</a> in Dart, things became more smoother now, with a better performance as the interction now is Dart/Rust directly, without a need for Dart/Kotlin/Rust or Dart/Swift/Rust cycle, below a simple example:</p>\n\n<p>First <code>src/lib.rs</code></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub extern fn rust_fn(x: i32) -&gt; i32 {   \n    println!(\"Hello from rust\\nI'll return: {}\", x.pow(2));\n    x.pow(2)\n }\n</code></pre>\n\n<p>and <code>Cargo.toml</code></p>\n\n<pre><code>[package]\nname = \"Double_in_Rost\"\nversion = \"0.1.0\"\nauthors = [\"Hasan Yousef\"]\nedition = \"2018\"\n\n[lib]\nname = \"rust_lib\"\ncrate-type = [\"dylib\"] # could be `staticlib` as well\n\n[dependencies]\n</code></pre>\n\n<p>Running <code>cargo build --release</code> will generate <code>target\\release\\rust_lib.dll</code> copy/paste it into Dart application root directory</p>\n\n<p>Write Dart code as below:</p>\n\n<pre class=\"lang-dart prettyprint-override\"><code>import 'dart:ffi';\nimport 'dart:io' show Platform;\n\n// FFI signature of the hello_world C function\ntypedef ffi_func = Int32 Function(Int32 x);  //pub extern fn rust_fn(x: i32) -&gt; i32\n// Dart type definition for calling the C foreign function\ntypedef dart_func = int Function(int x);\n\nvoid main() {\n  // Open the dynamic library\n  var path = './rust_lib.so';\n  if (Platform.isMacOS) path = './rust_lib.dylib';\n  if (Platform.isWindows) path = 'rust_lib.dll';\n  final dylib = DynamicLibrary.open(path);\n  // Look up the Rust/C function\n  final my_func =\n      dylib.lookup&lt;NativeFunction&lt;ffi_func&gt;&gt;('rust_fn').asFunction&lt;dart_func&gt;();\n  print('Double of 3 is ${my_func(3)}');\n}\n</code></pre>\n\n<p><a href=\"https://i.stack.imgur.com/q6I08.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/q6I08.png\" alt=\"enter image description here\"></a></p>\n"}], "owner": {"reputation": 15416, "user_id": 2441637, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/Z8fpp.jpg?s=128&g=1", "display_name": "Hasan A Yousef", "link": "https://stackoverflow.com/users/2441637/hasan-a-yousef"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1127, "favorite_count": 1, "accepted_answer_id": 59435393, "answer_count": 1, "score": 8, "last_activity_date": 1576924183, "creation_date": 1543472516, "last_edit_date": 1543475956, "question_id": 53532964, "link": "https://stackoverflow.com/questions/53532964/integrating-rust-flutter-kotlin-for-mobile-applications", "title": "Integrating Rust + Flutter + Kotlin for Mobile Applications", "body": "<p>As next week will have importat launch for Rust 2018 and Flutter 1.0, I thought to build an app using Rust for the business logic and Flutter for the user interface, that can run at both Android and iOS, I built one and tested it at Android and it is working fine.</p>\n\n<p>I just wonder how to measure the performance and compare it with native Android/iOS app.</p>\n\n<p>The app flow is:</p>\n\n<ol>\n<li>Main is in Flutter, that is calling native function through <a href=\"https://flutter.io/docs/development/platform-integration/platform-channels\" rel=\"noreferrer\">platform_channel</a></li>\n<li>The native function is calling rust library through <a href=\"https://developer.android.com/training/articles/perf-jni#kotlin\" rel=\"noreferrer\">JNI</a> (JNI wrapper is required to be call the rust library)</li>\n</ol>\n\n<p>The structure is as below:</p>\n\n<p><a href=\"https://i.stack.imgur.com/DYu6r.jpg\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/DYu6r.jpg\" alt=\"enter image description here\"></a> </p>\n\n<p>The code used is:</p>\n\n<p><code>main.dart</code>:</p>\n\n<pre><code>import 'dart:async';\nimport 'package:flutter/material.dart';\nimport 'package:flutter/services.dart';\n\nvoid main() =&gt; runApp(MyApp());\n\nclass MyApp extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return MaterialApp(\n      title: 'Flutter Demo',\n      theme: ThemeData(\n        primarySwatch: Colors.blue,\n      ),\n      home: MyHomePage(title: 'Flutter Demo Home Page'),\n    );\n  }\n}\n\nclass MyHomePage extends StatefulWidget {\n  MyHomePage({Key key, this.title}) : super(key: key);\n\n  final String title;\n\n  @override\n  _MyHomePageState createState() =&gt; _MyHomePageState();\n}\n\nclass _MyHomePageState extends State&lt;MyHomePage&gt; {\n  static const platform = const MethodChannel('samples.flutter.io/battery');\n\n  String _batteryLevel = 'Unknown battery level.';\n\n  Future&lt;void&gt; _getBatteryLevel() async {\n    String batteryLevel;\n    try {\n      final String hello = await platform.invokeMethod('getText');\n      final int result = await platform.invokeMethod('getBatteryLevel');\n\n      batteryLevel = '$hello Battery level at $result %.';\n    } on PlatformException catch (e) {\n      batteryLevel = \"Failed to get battery level: '${e.message}'.\";\n    }\n\n    setState(() {\n      _batteryLevel = batteryLevel;\n    });\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Material(\n      child: Center(\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n          children: [\n            RaisedButton(\n              child: Text('Get Battery Level'),\n              onPressed: _getBatteryLevel,\n            ),\n            Text(_batteryLevel),\n          ],\n        ),\n      ),\n    );\n  }\n}\n</code></pre>\n\n<p><code>JNI wrapper - RustGreetings.kt</code></p>\n\n<pre><code>package com.mozilla.greetings\n\nclass RustGreetings {\n    companion object {\n        init {\n            System.loadLibrary(\"greetings\")\n        }\n    }\n\n    private external fun greeting(pattern: String): String\n\n    fun sayHello(to: String): String = greeting(to)\n}\n</code></pre>\n\n<p>And the Main Android activity is:</p>\n\n<pre><code>package com.example.batterylevel\n\nimport android.os.Bundle\nimport io.flutter.app.FlutterActivity\nimport io.flutter.plugins.GeneratedPluginRegistrant\nimport io.flutter.plugin.common.MethodChannel\n\nimport android.content.Context\nimport android.content.ContextWrapper\nimport android.content.Intent\nimport android.content.IntentFilter\nimport android.os.BatteryManager\nimport android.os.Build.VERSION\nimport android.os.Build.VERSION_CODES\n\nimport lib.Library\nimport com.mozilla.greetings.RustGreetings\n\nclass MainActivity: FlutterActivity() {\n  private val CHANNEL = \"samples.flutter.io/battery\"\n\n  override fun onCreate(savedInstanceState: Bundle?) {\n    super.onCreate(savedInstanceState)\n    GeneratedPluginRegistrant.registerWith(this)\n\n    MethodChannel(flutterView, CHANNEL).setMethodCallHandler { call, result -&gt;\n      if (call.method == \"getText\") {\n        result.success(getText())\n      } else if (call.method == \"getBatteryLevel\") {\n       // result.success(getText())\n        val batteryLevel = getBatteryLevel()\n\n        if (batteryLevel != -1) {\n          result.success(batteryLevel)\n        } else {\n          result.error(\"UNAVAILABLE\", \"Battery level not available.\", null)\n        }\n      }\n      else {\n\n        result.notImplemented()\n      }\n    }\n  }\n\n  private fun getBatteryLevel(): Int {\n    val batteryLevel: Int\n    if (VERSION.SDK_INT &gt;= VERSION_CODES.LOLLIPOP) {\n      val batteryManager = getSystemService(Context.BATTERY_SERVICE) as BatteryManager\n      batteryLevel = batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_CAPACITY)\n    } else {\n      val intent = ContextWrapper(applicationContext).registerReceiver(null, IntentFilter(Intent.ACTION_BATTERY_CHANGED))\n      batteryLevel = intent!!.getIntExtra(BatteryManager.EXTRA_LEVEL, -1) * 100 / intent.getIntExtra(BatteryManager.EXTRA_SCALE, -1)\n    }\n    return batteryLevel\n  }\n\n  private fun getText(): String {\n    val x = Library().someLibraryMethod()\n    val g = RustGreetings()\n    val r = g.sayHello(\"My $x Rust\")\n    return r\n  }\n}\n</code></pre>\n\n<p>In the Android <code>gradle.build</code> I just added the below, as I'm interested to check also the impact of adding kotlin JVM library and getting it interacted with the Rust library within the mobile application:</p>\n\n<pre><code>dependencies {\n    implementation(files(\"src/main/libs/lib.jar\"))\n}\n</code></pre>\n\n<p>My question is:\nHow can check the performance and impact of each process when it is executed or called by another process</p>\n"}, {"tags": ["rust", "parameter-passing", "command-line-interface", "clap"], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 5, "last_activity_date": 1543483068, "last_edit_date": 1592644375, "creation_date": 1543468317, "answer_id": 53532256, "question_id": 53530920, "link": "https://stackoverflow.com/questions/53530920/how-do-i-change-the-names-of-the-values-in-a-clap-argument-that-takes-multiple-v/53532256#53532256", "title": "How do I change the names of the values in a clap argument that takes multiple values?", "body": "<p>A quick look at the documentation gives us <a href=\"https://docs.rs/clap/2.32.0/clap/struct.Arg.html#method.value_names\" rel=\"nofollow noreferrer\"><code>value_names()</code></a>:</p>\n<blockquote>\n<p>Specify multiple names for values of option arguments. These names are cosmetic only, used for help and usage strings only. The names are not used to access arguments. The values of the arguments are accessed in numeric order (i.e. if you specify two names one and two one will be the first matched value, two will be the second).</p>\n<p>NOTE: This implicitly sets <code>Arg::number_of_values</code> if the number of value names is greater than one. I.e. be aware that the number of &quot;names&quot; you set for the values, will be the exact number of values required to satisfy this argument</p>\n<p>NOTE: implicitly sets <code>Arg::takes_value(true)</code></p>\n</blockquote>\n<pre><code>.arg(\n    clap::Arg::with_name(&quot;position&quot;)\n        .help(&quot;The position for yada yada yada&quot;)\n        .long(&quot;position&quot;)\n        .short(&quot;p&quot;)\n        .value_names(&amp;[&quot;x&quot;, &quot;y&quot;])\n        .validator(|p| match p.parse::&lt;usize&gt;() {\n            Err(_) =&gt; Err(String::from(&quot;Error string&quot;)),\n            Ok(_) =&gt; Ok(()),\n        }\n    )\n)\n</code></pre>\n"}], "owner": {"reputation": 9936, "user_id": 6525260, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-DdsW6uGdpjg/AAAAAAAAAAI/AAAAAAAAAAw/srXxxqCzyW0/photo.jpg?sz=128", "display_name": "Arnav Borborah", "link": "https://stackoverflow.com/users/6525260/arnav-borborah"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 416, "favorite_count": 0, "accepted_answer_id": 53532256, "answer_count": 1, "score": 4, "last_activity_date": 1543483068, "creation_date": 1543458014, "question_id": 53530920, "link": "https://stackoverflow.com/questions/53530920/how-do-i-change-the-names-of-the-values-in-a-clap-argument-that-takes-multiple-v", "title": "How do I change the names of the values in a clap argument that takes multiple values?", "body": "<p>As part of my CLI tool, I have a <code>clap::Arg</code> that takes multiple values, representing an <code>(x, y)</code> coordinate. I want the use the be able to pass in the value as <code>-p/--position 1 0</code></p>\n\n<pre><code>.arg(\n    clap::Arg::with_name(\"position\")\n        .help(\"The position for yada yada yada\")\n        .long(\"position\")\n        .short(\"p\")\n        .number_of_values(2)\n        .validator(|p| match p.parse::&lt;usize&gt;() {\n            Err(_) =&gt; Err(String::from(\"Error string\")),\n            Ok(_) =&gt; Ok(()),\n        }\n    )\n)\n</code></pre>\n\n<p>While this works for the interface I want, this creates a somewhat confusing help message:</p>\n\n<pre><code>... Help text ...\n\nOPTIONS:\n    ... other options ...\n    -p, --position &lt;position&gt; &lt;position&gt;    The position for yada yada yada\n</code></pre>\n\n<p>What bothers me here is the <code>-p, --position &lt;position&gt; &lt;position&gt;</code>, which seems to indicate that <em>two</em> positions are being passed to the argument. Is there any way I can replace the <code>&lt;position&gt; &lt;position&gt;</code> with strings of my choice? (My goal is to get something like <code>-p, --position &lt;x&gt; &lt;y&gt;</code> in the help message.)</p>\n"}, {"tags": ["struct", "types", "rust"], "comments": [{"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 3, "creation_date": 1543455108, "post_id": 53530339, "comment_id": 93929575, "body": "I don&#39;t think you&#39;ve made it clear enough what you mean by merge. What if the keys collide? Does each key exist in all three, or just one at a time?"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543455498, "post_id": 53530339, "comment_id": 93929662, "body": "That not clear please precise what you want."}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1543455469, "post_id": 53530445, "comment_id": 93929657, "body": "or a structure."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1543476977, "post_id": 53530445, "comment_id": 93935501, "body": "or an enum if each key can only have a single type, or a tuple of <code>Option</code>s if some keys may be missing"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1543485304, "post_id": 53530445, "comment_id": 93939928, "body": "I&#39;ll put more effort into the answer as soon as the op make the question more clear."}], "tags": [], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "is_accepted": false, "score": 0, "last_activity_date": 1543453960, "creation_date": 1543453960, "answer_id": 53530445, "question_id": 53530339, "link": "https://stackoverflow.com/questions/53530339/how-can-i-merge-the-fields-from-different-hashmaps-into-one/53530445#53530445", "title": "How can I merge the fields from different HashMaps into one?", "body": "<p>You may use a tuple:</p>\n\n<pre><code>pub struct Resource {\n    name: String,\n    info: HashMap&lt;String, (i32, f32, String)&gt;,\n}\n</code></pre>\n\n<p>See it in action at the <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=ccb71c53e061ada9570ab0fa433a2a82\" rel=\"nofollow noreferrer\">playground</a>.</p>\n"}], "owner": {"reputation": 49, "user_id": 2812542, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5aacbf26053e6dc041f56bc6c10f41b6?s=128&d=identicon&r=PG&f=1", "display_name": "Gunshin", "link": "https://stackoverflow.com/users/2812542/gunshin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 322, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1543454886, "creation_date": 1543453146, "last_edit_date": 1543454886, "question_id": 53530339, "link": "https://stackoverflow.com/questions/53530339/how-can-i-merge-the-fields-from-different-hashmaps-into-one", "title": "How can I merge the fields from different HashMaps into one?", "body": "<p>I have the following struct:</p>\n\n<pre><code>pub struct Resource {\n    name: String,\n    info: HashMap&lt;String, i32&gt;,\n    info_float: HashMap&lt;String, f32&gt;,\n    info_string: HashMap&lt;String, String&gt;,\n}\n</code></pre>\n\n<p>Is there a way to merge the 3 <code>HashMap</code>s with separate values into a single <code>HashMap</code>?</p>\n"}]