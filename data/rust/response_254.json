[{"tags": ["logging", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574287177, "post_id": 58964020, "comment_id": 104183134, "body": "It looks like your question might be answered by the answers of <a href=\"https://stackoverflow.com/q/34538397/155423\">Is it possible to change the log level for an application at compile time?</a>. If not, please <b><a href=\"https://stackoverflow.com/posts/58964020/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1595, "user_id": 3833068, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6a2a668bce4cd485078f912cbda24f2a?s=128&d=identicon&r=PG", "display_name": "Ameo", "link": "https://stackoverflow.com/users/3833068/ameo"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574292285, "post_id": 58964020, "comment_id": 104184974, "body": "@shepmaster how do you always find these duplicates? I spent a good 10 minutes googling to even find the official docs for this feature. Do you have some secret or am I just bad at googling?"}, {"owner": {"reputation": 1595, "user_id": 3833068, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6a2a668bce4cd485078f912cbda24f2a?s=128&d=identicon&r=PG", "display_name": "Ameo", "link": "https://stackoverflow.com/users/3833068/ameo"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574292335, "post_id": 58964020, "comment_id": 104184994, "body": "Oh, you wrote the answer..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574295738, "post_id": 58964020, "comment_id": 104185784, "body": "In the hope that wasn&#39;t a rhetorical question, I have a Firefox bookmark that turns <code>r foo</code> into <code>https:&#47;&#47;www.google.com&#47;search?q=site:stackoverflow.com rust foo</code>. In this case, <code>foo</code> was <code>log feature</code>. While there are some answers that I remember, it&#39;s not every one, not even my own."}], "answers": [{"tags": [], "owner": {"reputation": 1595, "user_id": 3833068, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6a2a668bce4cd485078f912cbda24f2a?s=128&d=identicon&r=PG", "display_name": "Ameo", "link": "https://stackoverflow.com/users/3833068/ameo"}, "is_accepted": false, "score": 5, "last_activity_date": 1574287051, "creation_date": 1574287051, "answer_id": 58964021, "question_id": 58964020, "link": "https://stackoverflow.com/questions/58964020/is-there-a-way-to-statically-disable-rust-logging-in-production-builds-of-my-app/58964021#58964021", "title": "Is there a way to statically disable Rust logging in production builds of my application?", "body": "<p>Yes; the <code>log</code> crate provides <a href=\"https://docs.rs/log/0.4.8/log/#compile-time-filters\" rel=\"noreferrer\">features flags</a> that allow logging to be statically disabled at compile time up to a certain level.</p>\n\n<p>If you want to completely disable all logging in release builds but keep normal logging in debug builds, change your entry in <code>Cargo.toml</code> to include the <code>release_max_level_off</code> feature like this:</p>\n\n<pre><code>log = { version = \"0.4\", features = [\"release_max_level_off\"] }\n</code></pre>\n\n<p>This will cause all calls to logging functions to be eliminated from the resulting binary, taking any related formatting code with it via dead code elimination.</p>\n"}], "owner": {"reputation": 1595, "user_id": 3833068, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/6a2a668bce4cd485078f912cbda24f2a?s=128&d=identicon&r=PG", "display_name": "Ameo", "link": "https://stackoverflow.com/users/3833068/ameo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 674, "favorite_count": 0, "closed_date": 1574295626, "answer_count": 1, "score": 3, "last_activity_date": 1574287051, "creation_date": 1574287051, "question_id": 58964020, "link": "https://stackoverflow.com/questions/58964020/is-there-a-way-to-statically-disable-rust-logging-in-production-builds-of-my-app", "closed_reason": "Duplicate", "title": "Is there a way to statically disable Rust logging in production builds of my application?", "body": "<p>I have a WebAssembly module written in Rust that performs logging for debug purposes via the <code>log</code> crate during development.  I notice that, even when I don't configure a logger, the formatting and calls to internal <code>log</code> functions remain in the generated WebAssembly module.  This wastes bytes since the output of those functions will never be used/displayed.</p>\n\n<p>Is there any way to statically disable logging without having to remove the log macro calls in the code?  Additionally, is there a way to only disable this in release builds?</p>\n"}, {"tags": ["error-handling", "rust", "match"], "comments": [{"owner": {"reputation": 428, "user_id": 7343786, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-MhMp4LR2GVc/AAAAAAAAAAI/AAAAAAAAAFQ/Ry3ux41tyCo/photo.jpg?sz=128", "display_name": "Harrison Mc", "link": "https://stackoverflow.com/users/7343786/harrison-mc"}, "edited": false, "score": 0, "creation_date": 1574286024, "post_id": 58963302, "comment_id": 104182654, "body": "It looks like you would like to use the <code>?</code> operator but can&#39;t because of how your code is set up. I just took your code and modified it slightly by breaking it apart into two functions: <code>get_config</code> and <code>try_get_config</code>. The <code>try_get_config</code> function returns a <code>Result&lt;Config, String&gt;</code>. The <code>get_config</code> calls that, logs the message and returns the default if an error, or returns the config if successful. Now you can use <code>?</code> in <code>try_get_config</code>, along with some <code>map_err</code> calls to turn the other errors into <code>String</code>s."}, {"owner": {"reputation": 21, "user_id": 8194924, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e06690d83f6c1eaf666ed3b3b333faf1?s=128&d=identicon&r=PG&f=1", "display_name": "Ghosty141", "link": "https://stackoverflow.com/users/8194924/ghosty141"}, "reply_to_user": {"reputation": 428, "user_id": 7343786, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-MhMp4LR2GVc/AAAAAAAAAAI/AAAAAAAAAFQ/Ry3ux41tyCo/photo.jpg?sz=128", "display_name": "Harrison Mc", "link": "https://stackoverflow.com/users/7343786/harrison-mc"}, "edited": false, "score": 0, "creation_date": 1574324816, "post_id": 58963302, "comment_id": 104194482, "body": "@HarrisonMc I found a pretty nice solution using the threads linked above. I created a macro that &quot;wraps&quot; the function in a match."}, {"owner": {"reputation": 428, "user_id": 7343786, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-MhMp4LR2GVc/AAAAAAAAAAI/AAAAAAAAAFQ/Ry3ux41tyCo/photo.jpg?sz=128", "display_name": "Harrison Mc", "link": "https://stackoverflow.com/users/7343786/harrison-mc"}, "edited": false, "score": 0, "creation_date": 1574354299, "post_id": 58963302, "comment_id": 104212404, "body": "Glad you got it working. I try to avoid macros if there are other options, but if you found a good solution then that&#39;s great :-)"}], "owner": {"reputation": 21, "user_id": 8194924, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e06690d83f6c1eaf666ed3b3b333faf1?s=128&d=identicon&r=PG&f=1", "display_name": "Ghosty141", "link": "https://stackoverflow.com/users/8194924/ghosty141"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 107, "favorite_count": 0, "closed_date": 1574283880, "answer_count": 0, "score": 1, "last_activity_date": 1574324965, "creation_date": 1574283648, "last_edit_date": 1574324965, "question_id": 58963302, "link": "https://stackoverflow.com/questions/58963302/how-to-chain-functions-that-return-a-result-and-return-if-any-of-them-fail", "closed_reason": "Duplicate", "title": "How to chain functions that return a result and return if any of them fail?", "body": "<p>Is there any way to express the following code in a more concise manner?  The function should only continue if the result is <code>Ok()</code>, else it should return a default object. The code I came up with looks kind of unidiomatic, so I wondered if there is a better and more concise way. </p>\n\n<pre><code>fn get_config() -&gt; Config {\n    let cfg = match get_config_file_path() { // can return a (custom) PathError\n        Ok(c) =&gt; c,\n        Err(e) =&gt; {\n            error(&amp;*format!(\n                \"{} -&gt; Using default configuration\",\n                e.description\n            ));\n            return Config::default();\n        }\n    };\n    let cfg_str = match fs::read_to_string(&amp;cfg) { // io::Error\n        Ok(c) =&gt; c,\n        Err(_) =&gt; {\n            error(\"Failed to read config file\");\n            return Config::default();\n        }\n    };\n    toml::from_str(&amp;*cfg_str).unwrap_or_else(|_| { // toml::de::Error\n        error(\"Failed to parse config file\");\n        Config::default()\n    })\n}\n</code></pre>\n\n<p>Edit: My solution:</p>\n\n<p>I created the following macro:</p>\n\n<pre><code>macro_rules! unwrap_or_return {\n    ( $e:expr, $c:expr) =&gt; {\n        match $e {\n            Ok(x) =&gt; x,\n            Err(_) =&gt; return $c,\n        }\n    };\n}\n\nfn get_config() -&gt; Config {\n    let cfg = unwrap_or_return!(get_config_file_path(), {\n        error(\"Failed to get path to configuration file\");\n        Config::default()\n    });\n    let cfg_str = unwrap_or_return!(fs::read_to_string(&amp;cfg), {\n        error(\"Failed to read config file\");\n        Config::default()\n    });\n    toml::from_str(&amp;*cfg_str).unwrap_or_else(|_| {\n        error(\"Failed to parse config file\");\n        Config::default()\n    })\n}\n</code></pre>\n"}, {"tags": ["rust", "async-await", "rust-tokio"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1574272235, "post_id": 58960366, "comment_id": 104176212, "body": "have you test with something more robust than browser ? like curl ?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574272251, "post_id": 58960366, "comment_id": 104176217, "body": "What do you believe your <code>loop</code> to be doing? Why is there any reading at all in this example? Does the problem continue to manifest if you don&#39;t read? Ideally, you&#39;d produce a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> to narrow down the problem. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MRE tips</a> you can use to reduce your original code for posting here. Thanks!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574272738, "post_id": 58960366, "comment_id": 104176482, "body": "Your code works fine and serves requests in parallel: <code>for i in $(seq 10) ; do time curl -vvvvvv http:&#47;&#47;127.0.0.1:8080 &amp;; done</code> ... each response takes ~5 seconds."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574273671, "post_id": 58960366, "comment_id": 104176966, "body": "It looks like your question might be answered by the answers of <a href=\"https://stackoverflow.com/q/27513994/155423\">Chrome stalls when making multiple requests to same resource?</a>. If not, please <b><a href=\"https://stackoverflow.com/posts/58960366/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 5994, "user_id": 5710637, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/TAM5l.jpg?s=128&g=1", "display_name": "fafl", "link": "https://stackoverflow.com/users/5710637/fafl"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574274261, "post_id": 58960366, "comment_id": 104177260, "body": "@Shepmaster ah, so it was Chrome! I\u2019ve been going crazy over here. Thank you for finding this! If you make this an answer then I will accept it."}], "owner": {"reputation": 5994, "user_id": 5710637, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/TAM5l.jpg?s=128&g=1", "display_name": "fafl", "link": "https://stackoverflow.com/users/5710637/fafl"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 55, "favorite_count": 0, "closed_date": 1574276094, "answer_count": 0, "score": 0, "last_activity_date": 1574329126, "creation_date": 1574271713, "last_edit_date": 1574329126, "question_id": 58960366, "link": "https://stackoverflow.com/questions/58960366/why-does-a-tokio-0-2-0-alpha-server-with-async-await-not-serve-requests-in-paral", "closed_reason": "Duplicate", "title": "Why does a Tokio 0.2.0-alpha server with async-await not serve requests in parallel?", "body": "<p>I'm trying to write a small webserver that returns delayed responses using the Tokio library. I've been reading the documentation of the 0.2.0-alpha.6 release and <a href=\"https://github.com/tokio-rs/tokio/tree/d4fec2c5d628b180226f6ab3005aa3e5845f1929#example\" rel=\"nofollow noreferrer\">the current example of an echo server</a>.</p>\n\n<p>I modified it like this:</p>\n\n<pre><code>use std::net::SocketAddr;\nuse std::time::Duration;\nuse tokio::net::TcpListener;\nuse tokio::prelude::*;\nuse tokio::timer::delay_for;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {\n    let addr = \"127.0.0.1:8080\".parse::&lt;SocketAddr&gt;()?;\n    let mut listener = TcpListener::bind(&amp;addr).await?;\n\n    loop {\n        let (mut socket, _) = listener.accept().await?;\n\n        tokio::spawn(async move {    \n            delay_for(Duration::from_millis(5000)).await;\n\n            if let Err(e) = socket\n                .write_all(b\"HTTP/1.1 200 OK\\r\\n\\r\\nyay\\r\\n\\r\\n\")\n                .await\n            {\n                println!(\"failed to write to socket; err = {:?}\", e);\n            }\n        });\n    }\n}\n</code></pre>\n\n<p>This code waits for 5 seconds before returning \"yay\" with status code 200. When I open a couple of tabs in the browser and refresh them all at once, I would expect them all to complete at roughly the same time. But in reality, the tabs complete their requests sequentially.</p>\n\n<p>What can I do to make these requests run in parallel?</p>\n"}, {"tags": ["rust", "multiprocessing", "rust-cargo"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1574271763, "post_id": 58959984, "comment_id": 104175973, "body": "&quot;By default, stdin, stdout and stderr are inherited from the parent.&quot; so B wait sleep process to close/write something on its stdout."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574273169, "post_id": 58959984, "comment_id": 104176697, "body": "Your question is unclear for me, on one end you use <code>output</code> and on the other hand you don&#39;t use the output of A program. Why do you use output so ? Why not just use spawn in B like A ?"}, {"owner": {"reputation": 9, "user_id": 9973504, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-Ixb2j2LDQLU/AAAAAAAAAAI/AAAAAAAAAAA/AB6qoq3YP5Y4Skou6nTd4z3JlvogKDelGg/mo/photo.jpg?sz=128", "display_name": "Urban Avsec", "link": "https://stackoverflow.com/users/9973504/urban-avsec"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574348759, "post_id": 58959984, "comment_id": 104209028, "body": "@Stargateur, this just might be it. Didn&#39;t consider inheritance of Stdio&#39;s. This was just an example. I have encountered this problem in the integration testing of a CLI of a daemon I am writing. In particular CLI&#39;s <code>start</code> method.  The test creates a blocking <code>Command</code> that executes the CLI binary which behind the scenes spawns the daemon if it&#39;s not running already. Problem was that due to above mentioned problem, Command never returned, and test failed by timeout."}], "answers": [{"tags": [], "owner": {"reputation": 9, "user_id": 9973504, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-Ixb2j2LDQLU/AAAAAAAAAAI/AAAAAAAAAAA/AB6qoq3YP5Y4Skou6nTd4z3JlvogKDelGg/mo/photo.jpg?sz=128", "display_name": "Urban Avsec", "link": "https://stackoverflow.com/users/9973504/urban-avsec"}, "is_accepted": false, "score": 0, "last_activity_date": 1574415114, "last_edit_date": 1574415114, "creation_date": 1574349009, "answer_id": 58978034, "question_id": 58959984, "link": "https://stackoverflow.com/questions/58959984/why-would-commandoutput-block-for-longer-than-the-subprocess-that-it-spawned/58978034#58978034", "title": "Why would Command::output block for longer than the subprocess that it spawned?", "body": "<p>So taking into the account the comment of @Stargateur, I have made a small change and it made it work. All commands pipe or set to null Stdout, Stdin, Stderr, . Such as </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    std::process::Command::new(\"sleep)\n      .arg(\"8\")\n      .stdout(Stdio::piped())\n      .stdin(Stdio::null())\n      .stderr(Stdio::null())\n      .spawn()\n      .unwrap();\n}\n</code></pre>\n\n<p>This fixes the blocking.</p>\n\n<h3>EDIT</h3>\n\n<p>The use of /bin/bash didn't work after some exploration. The subcommand was never triggered. But piping of Stdout, Stdin and Stderr worked. </p>\n"}], "owner": {"reputation": 9, "user_id": 9973504, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-Ixb2j2LDQLU/AAAAAAAAAAI/AAAAAAAAAAA/AB6qoq3YP5Y4Skou6nTd4z3JlvogKDelGg/mo/photo.jpg?sz=128", "display_name": "Urban Avsec", "link": "https://stackoverflow.com/users/9973504/urban-avsec"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 49, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1574415114, "creation_date": 1574270246, "last_edit_date": 1574357374, "question_id": 58959984, "link": "https://stackoverflow.com/questions/58959984/why-would-commandoutput-block-for-longer-than-the-subprocess-that-it-spawned", "title": "Why would Command::output block for longer than the subprocess that it spawned?", "body": "<p>I have program A which spawns a long running process using <a href=\"https://doc.rust-lang.org/std/process/struct.Command.html#method.spawn\" rel=\"nofollow noreferrer\"><code>Command::spawn</code></a> and returns:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    std::process::Command::new(\"sleep\").arg(\"8\").spawn().unwrap();\n}\n</code></pre>\n\n<p>At the same time, program B calls program A and waits for output:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    std::process::Command::new(\"target/debug/programA\").output().unwrap();\n}\n</code></pre>\n\n<h3>Expected Behavior</h3>\n\n<p>Running <code>cargo run</code> in the directory for program B returns in a few microseconds, almost the same time it takes to run program A on its own.</p>\n\n<h3>Observed Behavior</h3>\n\n<p>Program A takes about 200 microseconds on it's own while program B blocks for 8 seconds. </p>\n\n<h3>What to do?</h3>\n\n<p>I have created <a href=\"https://github.com/Sythanis/Test-Recursive-Process\" rel=\"nofollow noreferrer\">a small project</a> that shows this behavior. I have also tried to use other crates such as <code>subprocess</code> or <code>tokio::net::process</code> in an asynchronous context but all behave the same. This is the first time I have come across this behavior and I cannot find any documentation how to get around it.</p>\n"}, {"tags": ["rust", "serde", "rust-diesel"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574265347, "post_id": 58958454, "comment_id": 104172305, "body": "It looks like your question might be answered by the answers of <a href=\"https://stackoverflow.com/q/39383809/155423\">How to transform fields during serialization using Serde?</a>. If not, please <b><a href=\"https://stackoverflow.com/posts/58958454/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 511, "user_id": 8339179, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/sAYyz.png?s=128&g=1", "display_name": "Biskit1943", "link": "https://stackoverflow.com/users/8339179/biskit1943"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574265900, "post_id": 58958454, "comment_id": 104172646, "body": "Alright @Shepmaster the other question gives me the basics to implement is by myself. Thank you, this Question can be marked as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574266158, "post_id": 58958454, "comment_id": 104172800, "body": "That&#39;s great your question was answered! Depending on your surrounding program, you may want to think if there are more SQL-efficient ways to get all the data you want in fewer queries (perhaps just one...). It&#39;s not always possible, though."}], "owner": {"reputation": 511, "user_id": 8339179, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/sAYyz.png?s=128&g=1", "display_name": "Biskit1943", "link": "https://stackoverflow.com/users/8339179/biskit1943"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 24, "favorite_count": 0, "closed_date": 1574266055, "answer_count": 0, "score": 0, "last_activity_date": 1574266051, "creation_date": 1574265218, "last_edit_date": 1574266051, "question_id": 58958454, "link": "https://stackoverflow.com/questions/58958454/how-to-join-to-another-table-when-serializing-a-diesel-type", "closed_reason": "Duplicate", "title": "How to join to another table when serializing a Diesel type?", "body": "<p>I'm trying to implement a serializer for my struct:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Queryable, Debug, Clone, Serialize, Deserialize)]\nstruct One {\n    two_id: i32,\n}\n\n#[derive(Queryable, Debug, Clone, Serialize, Deserialize)]\nstruct Two {\n    id: i32,\n}\n</code></pre>\n\n<p>I'd like to get struct <code>One</code> from the database with diesel and print it with serde. I found the <a href=\"https://serde.rs/field-attrs.html#serialize_with\" rel=\"nofollow noreferrer\"><code>serialize_with</code></a> attribute which can be applied to <code>two_id</code>. How would I implement such a method with the given interface: <code>fn&lt;'de, D&gt;(D) -&gt; Result&lt;T, D::Error&gt; where D: Deserializer&lt;'de&gt;</code> to invoke <code>json!(get_two_from_db())</code> on my queried object?</p>\n\n<p>I'd like to be able to call <code>json!(one)</code> and automatically get the joined objects.</p>\n"}, {"tags": ["enums", "rust", "macros", "ffi", "rust-bindgen"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574261100, "post_id": 58956792, "comment_id": 104169508, "body": "Manually modifying the output of bindgen is allowed?"}, {"owner": {"reputation": 2715, "user_id": 232024, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6225abdd74d5b5cfff9fc5cb82186e0b?s=128&d=identicon&r=PG", "display_name": "Roman Dmitrienko", "link": "https://stackoverflow.com/users/232024/roman-dmitrienko"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574261718, "post_id": 58956792, "comment_id": 104169896, "body": "@Shepmaster I&#39;m using the bindgen library with build.rs. Modifying the output manually would not be feasible, I believe."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574262089, "post_id": 58956792, "comment_id": 104170157, "body": "If you cannot modify the output of bindgen, and bindgen doesn&#39;t give you the hooks you need, you appear to have no solution. See also <a href=\"https://stackoverflow.com/q/53364002/155423\">How do I apply a macro attribute to a function defined in a separate module?</a>"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 2, "creation_date": 1574264347, "post_id": 58956792, "comment_id": 104171660, "body": "You can generate another source code from your <code>build.rs</code>, by scanning either the <code>.h</code> or the <code>bindgen</code> output to find the enum variants and outputting your <code>StatusCode</code> and <code>ErrorCode</code> enums."}, {"owner": {"reputation": 2715, "user_id": 232024, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6225abdd74d5b5cfff9fc5cb82186e0b?s=128&d=identicon&r=PG", "display_name": "Roman Dmitrienko", "link": "https://stackoverflow.com/users/232024/roman-dmitrienko"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1574329781, "post_id": 58956792, "comment_id": 104197454, "body": "@Jmb Thanks! I&#39;ll have to do that, apparently. Looks like I severely misunderstood the nature of the Rust macros :)"}], "owner": {"reputation": 2715, "user_id": 232024, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6225abdd74d5b5cfff9fc5cb82186e0b?s=128&d=identicon&r=PG", "display_name": "Roman Dmitrienko", "link": "https://stackoverflow.com/users/232024/roman-dmitrienko"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 133, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1574262043, "creation_date": 1574260448, "last_edit_date": 1574262043, "question_id": 58956792, "link": "https://stackoverflow.com/questions/58956792/using-rust-macros-to-transform-and-split-a-c-style-enum-generated-by-bindgen", "title": "Using Rust macros to transform and split a C-style enum generated by bindgen", "body": "<p>I am making Rust bindings for an existing proprietary C library. The library defines a fairly large enum containing possible status <em>and</em> error codes, i.e.:</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>enum RET_CODE\n{\n    STA_OK = 0,\n    STA_SOME_CONDITION,\n    STA_ANOTHER_CONDITION,\n    /* ... more status codes ... */\n\n    ERR_INTERNAL,\n    ERR_SYSTEM,\n    ERR_INPUT_OUTPUT,\n    /* ... more than 100 other error codes ... */\n};\n</code></pre>\n\n<p>Library functions return these <code>RET_CODE</code> values. Status codes start with <code>STA_</code> and do not mean a failure; they signal various conditions. Error codes start with <code>ERR_</code>.</p>\n\n<p>My idea is to split this enum into two Rust enums, <code>StatusCode</code> and <code>ErrorCode</code>, like that:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>enum StatusCode {\n    Ok = ffi::RET_CODE::STA_OK,\n    SomeCondition = ffi::RET_CODE::SOME_CONDITION,\n    AnotherCondition = ffi::RET_CODE::ANOTHER_CONDITION,\n    // ...\n}\n\nenum ErrorCode {\n    Internal = ffi::RET_CODE::ERR_INTERNAL,\n    System = ffi::RET_CODE::ERR_SYSTEM,\n    InputOutput = ffi::RET_CODE::ERR_INPUT_OUTPUT,\n    // ...\n}\n</code></pre>\n\n<p>Rust wrapper functions will then return <code>std::result::Result&lt;StatusCode, ErrorCode&gt;</code>. However, I do not want to define those Rust enums manually, since the status and error codes in the C library are subject to change, and it is quite likely that I will forget to update the Rust bindings. Modifying the C library is not an option.</p>\n\n<p>Is it possible to use Rust macros (or something else) to produce those Rust enums from the single C API enum? It would be great to rename the variants as well (i.e. <code>STA_SOME_CONDITION</code> would become <code>SomeCondition</code>), but this could apparently be handled by bindgen's <code>ParseCallbacks</code>.</p>\n"}, {"tags": ["rust", "embedded", "mutex", "cortex-m"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574251697, "post_id": 58953892, "comment_id": 104163720, "body": "This sounds like a case for <a href=\"https://docs.rs/once_cell/1.2.0/once_cell/\" rel=\"nofollow noreferrer\"><code>OnceCell</code></a> however I am not sure of the applicability to embedded environments."}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574252372, "post_id": 58953892, "comment_id": 104164129, "body": "OnceCell would indeed suffice, but I&#39;d need Sync enabled. It only has that with std enabled which makes it unusable in embedded"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1574253381, "post_id": 58953892, "comment_id": 104164745, "body": "Why <i>whitout unsafe Rust</i>? If you use it carefully, you can write a performant and safe code. You shouldn&#39;t exclude it as a matter of principle."}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "edited": false, "score": 0, "creation_date": 1574253513, "post_id": 58953892, "comment_id": 104164830, "body": "If a wrapper can be made that uses unsafe, that&#39;d be fine. I know Cells use unsafe as well. But what I don&#39;t want is to put unsafe { ... } every time I need to read the variable"}, {"owner": {"reputation": 4182, "user_id": 2992101, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7363e9ce46406af3326492e2f6cf40ca?s=128&d=identicon&r=PG", "display_name": "michalsrb", "link": "https://stackoverflow.com/users/2992101/michalsrb"}, "edited": false, "score": 1, "creation_date": 1574253857, "post_id": 58953892, "comment_id": 104165015, "body": "You can do it such that you need unsafe where you write the value, not where you read it."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 4182, "user_id": 2992101, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7363e9ce46406af3326492e2f6cf40ca?s=128&d=identicon&r=PG", "display_name": "michalsrb", "link": "https://stackoverflow.com/users/2992101/michalsrb"}, "edited": false, "score": 0, "creation_date": 1574254222, "post_id": 58953892, "comment_id": 104165223, "body": "As said by @michalsrb, you ensure that it is not read before being writen once (unsafe write) and then, you can read it whenever you want with safe code. Just be sure that you don&#39;t do anything UB when writing it as it&#39;s not totally trivial to do it correctly."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574259365, "post_id": 58953892, "comment_id": 104168409, "body": "Why not just make it a constant? Write it once using the constant and then always read from the constant. Zero problems."}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574259566, "post_id": 58953892, "comment_id": 104168556, "body": "@Shepmaster That is obviously the best way if it can be constant at compile time. In this case, however, it can not."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574259605, "post_id": 58953892, "comment_id": 104168590, "body": "Why not? It&#39;s not like you are going to read the clock speed from the user over the serial bus at device startup."}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "edited": false, "score": 0, "creation_date": 1574260905, "post_id": 58953892, "comment_id": 104169394, "body": "An example is waking up from deep sleep. Depending on the state of the hardware, it may be chosen to use a slower clock speed to conserve some energy. So at startup (or rather a wakeup where all the RAM is gone) a different clock speed may be selected every time."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1574261354, "post_id": 58953892, "comment_id": 104169676, "body": "@Geoxion: Wait a minute. If the clock speed can differ every time the programs wakes up, doesn&#39;t it mean that you need to set your values more than once?"}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "edited": false, "score": 1, "creation_date": 1574261592, "post_id": 58953892, "comment_id": 104169821, "body": "@MatthieuM.Only after a new bootup. Technically it&#39;s a wakeup, but all the RAM is gone so it&#39;s exactly like a bootup."}], "answers": [{"comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574261522, "post_id": 58955990, "comment_id": 104169770, "body": "Can your clock speed be represented by an integral, and does your platform support reading/writing values of such an integral atomically?"}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574261711, "post_id": 58955990, "comment_id": 104169891, "body": "The clock settings are stored in a struct. I guess it could be split up to separate atomic variables, but that would be inconvenient. But there are also more things I want to use this with other than clock settings which are set once and then read only."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574262306, "post_id": 58955990, "comment_id": 104170300, "body": "Sounds good; I&#39;ve tweaked the memory orderings are Relaxed is too lax, and could allow reading from the <code>UnsafeCell</code> before the write is actually completed -- especially on out-of-order CPUs. Hopefully they are still lowered down to the appropriate instructions on your chip."}, {"owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1574263315, "post_id": 58955990, "comment_id": 104170992, "body": "That seems better indeed. I believe atomics are fully supported on my architecture (Cortex M4). I updated the code with the ability to use non-copy types. You can get them with get_ref() and try_get_ref()."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1574264403, "post_id": 58955990, "comment_id": 104171697, "body": "Have you tried reducing the duplication by implementing every getter in terms of <code>try_get_ref</code>? <code>get_ref</code> would be <code>if let Some(r) = self.try_get_ref() { r } else { panic!(&quot;...&quot;) }</code>, <code>try_get</code> would be <code>self.try_get_ref().copied()</code> and <code>get</code> would be <code>*self.get_ref()</code>. Of course, you&#39;d need to just that inlining works properly... possibly sticking a <code>#[inline(always)]</code> on top of <code>try_get_ref</code>."}], "tags": [], "owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "is_accepted": true, "score": 4, "last_activity_date": 1574333359, "last_edit_date": 1574333359, "creation_date": 1574257995, "answer_id": 58955990, "question_id": 58953892, "link": "https://stackoverflow.com/questions/58953892/is-there-a-lightweight-alternative-for-a-mutex-in-embedded-rust-when-a-value-wil/58955990#58955990", "title": "Is there a lightweight alternative for a Mutex in embedded Rust when a value will be written once at startup and then only read?", "body": "<p>With the help of some of the comments, I came up with this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use core::cell::UnsafeCell;\nuse core::sync::atomic::{AtomicBool, Ordering};\n\n/// A cell that can be written to once. After that, the cell is readonly and will panic if written to again.\n/// Getting the value will panic if it has not already been set. Try 'try_get(_ref)' to see if it has already been set.\n///\n/// The cell can be used in embedded environments where a variable is initialized once, but later only written to.\n/// This can be used in interrupts as well as it implements Sync.\n///\n/// Usage:\n/// ```rust\n/// static MY_VAR: DynamicReadOnlyCell&lt;u32&gt; = DynamicReadOnlyCell::new();\n///\n/// fn main() {\n///     initialize();\n///     calculate();\n/// }\n///\n/// fn initialize() {\n///     // ...\n///     MY_VAR.set(42);\n///     // ...\n/// }\n///\n/// fn calculate() {\n///     let my_var = MY_VAR.get(); // Will be 42\n///     // ...\n/// }\n/// ```\npub struct DynamicReadOnlyCell&lt;T: Sized&gt; {\n    data: UnsafeCell&lt;Option&lt;T&gt;&gt;,\n    is_populated: AtomicBool,\n}\n\nimpl&lt;T: Sized&gt; DynamicReadOnlyCell&lt;T&gt; {\n    /// Creates a new unpopulated cell\n    pub const fn new() -&gt; Self {\n        DynamicReadOnlyCell {\n            data: UnsafeCell::new(None),\n            is_populated: AtomicBool::new(false),\n        }\n    }\n    /// Creates a new cell that is already populated\n    pub const fn from(data: T) -&gt; Self {\n        DynamicReadOnlyCell {\n            data: UnsafeCell::new(Some(data)),\n            is_populated: AtomicBool::new(true),\n        }\n    }\n\n    /// Populates the cell with data.\n    /// Panics if the cell is already populated.\n    pub fn set(&amp;self, data: T) {\n        cortex_m::interrupt::free(|_| {\n            if self.is_populated.load(Ordering::Acquire) {\n                panic!(\"Trying to set when the cell is already populated\");\n            }\n            unsafe {\n                *self.data.get() = Some(data);\n            }\n\n            self.is_populated.store(true, Ordering::Release);\n        });\n    }\n\n    /// Gets a reference to the data from the cell.\n    /// Panics if the cell is not yet populated.\n    #[inline(always)]\n    pub fn get_ref(&amp;self) -&gt; &amp;T {\n        if let Some(data) = self.try_get_ref() {\n            data\n        } else {\n            panic!(\"Trying to get when the cell hasn't been populated yet\");\n        }\n    }\n\n    /// Gets a reference to the data from the cell.\n    /// Returns Some(T) if the cell is populated.\n    /// Returns None if the cell is not populated.\n    #[inline(always)]\n    pub fn try_get_ref(&amp;self) -&gt; Option&lt;&amp;T&gt; {\n        if !self.is_populated.load(Ordering::Acquire) {\n            None\n        } else {\n            Some(unsafe { self.data.get().as_ref().unwrap().as_ref().unwrap() })\n        }\n    }\n}\n\nimpl&lt;T: Sized + Copy&gt; DynamicReadOnlyCell&lt;T&gt; {\n    /// Gets a copy of the data from the cell.\n    /// Panics if the cell is not yet populated.\n    #[inline(always)]\n    pub fn get(&amp;self) -&gt; T {\n        *self.get_ref()\n    }\n\n    /// Gets a copy of the data from the cell.\n    /// Returns Some(T) if the cell is populated.\n    /// Returns None if the cell is not populated.\n    #[inline(always)]\n    pub fn try_get(&amp;self) -&gt; Option&lt;T&gt; {\n        self.try_get_ref().cloned()\n    }\n}\n\nunsafe impl&lt;T: Sized&gt; Sync for DynamicReadOnlyCell&lt;T&gt; {}\n</code></pre>\n\n<p>I think this is safe due to the atomic check and the critical section in the set. If you spot anything wrong or dodgy, please let me know.</p>\n"}], "owner": {"reputation": 346, "user_id": 2287549, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/tqVx3.png?s=128&g=1", "display_name": "Geoxion", "link": "https://stackoverflow.com/users/2287549/geoxion"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 434, "favorite_count": 1, "accepted_answer_id": 58955990, "answer_count": 1, "score": 4, "last_activity_date": 1574333359, "creation_date": 1574251213, "last_edit_date": 1574262210, "question_id": 58953892, "link": "https://stackoverflow.com/questions/58953892/is-there-a-lightweight-alternative-for-a-mutex-in-embedded-rust-when-a-value-wil", "title": "Is there a lightweight alternative for a Mutex in embedded Rust when a value will be written once at startup and then only read?", "body": "<p>According to the <a href=\"https://docs.rust-embedded.org/book/concurrency/#mutexes\" rel=\"nofollow noreferrer\">Rust Embedded Book about concurrency</a>, one of the better ways to share some data between contexts is using mutexes with refcells. I understand how they work and why this is necessary. But there is a scenario where the overhead cost seems to much.</p>\n\n<p>The mutex of the cortex_m crate works in this way:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>cortex_m::interrupt::free(|cs| {\n    let my_value = my_mutex.borrow(cs).borrow();\n    // Do something with the value\n});\n</code></pre>\n\n<p>The mutex requires the <code>cs</code> (CriticalSection) token before it gives access. In a critical section, no interrupts can happen so we know we're the only ones that can change and read the value. This works well.</p>\n\n<p>The scenario I'm in now, however, has the variable be written to once for initialization (at runtime) and then always be treated as a read-only value. In my case it's the clock speed of the MCU. This cannot be a compile-time constant. An example why is waking up from deep sleep: depending on the state of the hardware, it may be chosen to use a slower clock speed to conserve some energy. So at startup (or rather a wakeup where all the RAM is gone) a different clock speed may be selected every time. </p>\n\n<p>If I simply want to read the value, it seems wasteful to go through the whole critical section setup. If this variable may be changed again, then, yes, it's necessary. But that's not the case here. It will only get read.</p>\n\n<p>Is there a better way of reading a shared variable with less overhead and without using unsafe Rust?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1574243865, "post_id": 58951421, "comment_id": 104159140, "body": "Are you sure you want mutable reference to <code>i64</code>s? You could create a new vector with numbers directly"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574243932, "post_id": 58951421, "comment_id": 104159179, "body": "What do you want to do with <code>v</code> afterwards? The solution somewhat depends on it."}, {"owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574244142, "post_id": 58951421, "comment_id": 104159297, "body": "Actually, I&#39;m implementing <code>Vec</code> of <code>struct</code>. But for making it easy, I&#39;m using <code>i64</code>. And I want to change fields of struct after applying the filter."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1574244170, "post_id": 58951421, "comment_id": 104159318, "body": "Why don&#39;t u use a <code>for</code>?"}, {"owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574244931, "post_id": 58951421, "comment_id": 104159804, "body": "Because I needed to know the array had elements or not. I needed two loop. Thank you very much for the answer. It&#39;s what I would like to know."}], "answers": [{"comments": [{"owner": {"reputation": 478, "user_id": 3491376, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/lh2OC.png?s=128&g=1", "display_name": "Deadooshka", "link": "https://stackoverflow.com/users/3491376/deadooshka"}, "edited": false, "score": 0, "creation_date": 1574252290, "post_id": 58951541, "comment_id": 104164090, "body": "<code>|&amp;&amp;mut val| val &lt; 2</code>"}, {"owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574302060, "post_id": 58951541, "comment_id": 104187299, "body": "I&#39;m not sure about which is better to use <code>|&amp;&amp;val|</code>, <code>|&amp;val|</code> or <code>|val|</code>. Could you leave your opinion here?"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 2, "last_activity_date": 1574246011, "last_edit_date": 1574246011, "creation_date": 1574244088, "answer_id": 58951541, "question_id": 58951421, "link": "https://stackoverflow.com/questions/58951421/how-to-get-mutable-slice-with-conditions-in-rust/58951541#58951541", "title": "How to get mutable slice with conditions in Rust", "body": "<p>You can write something like that. I agree that it's not really beautiful, but it works:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let mut v = vec![1_i64, 2, 3, 4, 5];\n    let s: Vec&lt;_&gt; = v.iter_mut().filter(|&amp;val| *val &lt; 2).collect();\n    let mut s = if s.len() == 0 {\n        v.iter_mut().filter(|&amp;val| *val &gt; 2).collect()\n    } else {\n        s\n    };\n\n    *s[0] = 0;\n    println!(\"{:?}\", v);\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574247694, "post_id": 58952389, "comment_id": 104161521, "body": "You should avoid cloning as long as you can."}, {"owner": {"reputation": 505, "user_id": 4823380, "user_type": "registered", "accept_rate": 71, "profile_image": "https://graph.facebook.com/10204449233615826/picture?type=large", "display_name": "Kartikeya Sharma", "link": "https://stackoverflow.com/users/4823380/kartikeya-sharma"}, "reply_to_user": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574250965, "post_id": 58952389, "comment_id": 104163330, "body": "@fx-kirin Not to counter but clone will loose the reference after the main .So why should we avoid using it .Can you please explain"}, {"owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "edited": false, "score": 0, "creation_date": 1574251268, "post_id": 58952389, "comment_id": 104163490, "body": "for memory efficiency."}], "tags": [], "owner": {"reputation": 505, "user_id": 4823380, "user_type": "registered", "accept_rate": 71, "profile_image": "https://graph.facebook.com/10204449233615826/picture?type=large", "display_name": "Kartikeya Sharma", "link": "https://stackoverflow.com/users/4823380/kartikeya-sharma"}, "is_accepted": false, "score": 0, "last_activity_date": 1593020180, "last_edit_date": 1593020180, "creation_date": 1574246516, "answer_id": 58952389, "question_id": 58951421, "link": "https://stackoverflow.com/questions/58951421/how-to-get-mutable-slice-with-conditions-in-rust/58952389#58952389", "title": "How to get mutable slice with conditions in Rust", "body": "<p>We can clone the reference like this:</p>\n<pre><code>fn main() {\n    let mut v: Vec&lt;i64&gt; = vec![1, 2, 3, 4, 5];\n    let mut t = v.clone();\n    let mut s: Vec&lt;&amp;mut i64&gt; = v.iter_mut().filter(|val| **val &lt; 2_i64).collect();\n    if s.len() == 0 {\n        s = t.iter_mut().filter(|val| **val &gt; 2_i64).collect();\n    }\n    *s[0] = 0;\n    println!(&quot;{:?}&quot;, v);\n}\n</code></pre>\n"}], "owner": {"reputation": 1676, "user_id": 1903430, "user_type": "registered", "accept_rate": 53, "profile_image": "https://i.stack.imgur.com/ZBVUf.png?s=128&g=1", "display_name": "fx-kirin", "link": "https://stackoverflow.com/users/1903430/fx-kirin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 168, "favorite_count": 0, "accepted_answer_id": 58951541, "answer_count": 2, "score": 3, "last_activity_date": 1593020180, "creation_date": 1574243747, "last_edit_date": 1574243918, "question_id": 58951421, "link": "https://stackoverflow.com/questions/58951421/how-to-get-mutable-slice-with-conditions-in-rust", "title": "How to get mutable slice with conditions in Rust", "body": "<p>I'd like to write something similar with following code in Rust.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let mut v: Vec&lt;i64&gt; = vec![1, 2, 3, 4, 5];\n    let mut s: Vec&lt;&amp;mut i64&gt; = v\n        .iter_mut()\n        .filter(|val| **val &lt; 2_i64)\n        .collect();\n    if s.len() == 0 {\n        s = v\n            .iter_mut()\n            .filter(|val| **val &gt; 2_i64)\n            .collect();\n    }\n    *s[0] = 0;\n    println!(\"{:?}\", v);\n}\n</code></pre>\n\n<p>It's obviously making borrowing reference twice. I know it causes an error, <code>E0384: cannot assign twice to immutable variable s cannot assign twice to immutable variable</code>. </p>\n\n<p>Could you tell me how to write this kind of work flow in Rust? I want to filter value and if it returns nothing, apply another filter and get <code>Vec</code> of borrowing reference.</p>\n\n<p>I tried to use shared reference. After filtered the <code>Vec</code>, I needed to convert shared reference to borrowing one, but it was not possible.</p>\n"}, {"tags": ["rust", "b-tree", "ordered-map", "ordered-set"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574242776, "post_id": 58951037, "comment_id": 104158500, "body": "Why not using a <a href=\"https://doc.rust-lang.org/std/collections/struct.BinaryHeap.html\" rel=\"nofollow noreferrer\"><code>BinaryHeap</code></a> instead, which has a <a href=\"https://doc.rust-lang.org/std/collections/struct.BinaryHeap.html#method.pop\" rel=\"nofollow noreferrer\"><code>pop()</code></a> method."}, {"owner": {"reputation": 1648, "user_id": 2535207, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a0db392082edc1a1fc6f6c927210c233?s=128&d=identicon&r=PG", "display_name": "Jeremy Cochoy", "link": "https://stackoverflow.com/users/2535207/jeremy-cochoy"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574243316, "post_id": 58951037, "comment_id": 104158803, "body": "@hellow Yes, and probably more suitable is <a href=\"https://doc.rust-lang.org/std/collections/struct.BinaryHeap.html#method.peek\" rel=\"nofollow noreferrer\"><code>peek</code></a> if you only need to read the value. But I am not sure you can also get the other extremal value.  In my personal case, I was using <code>BTreeMap</code>s and the order was used to search inside the collection."}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574251067, "post_id": 58951038, "comment_id": 104163388, "body": "Rust is not limited to std, <a href=\"https://crates.io/crates/min-max-heap\" rel=\"nofollow noreferrer\">crates.io/crates/min-max-heap</a>"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1574253985, "post_id": 58951038, "comment_id": 104165097, "body": "@Stargateur: Sure, but a heap is not a set/map, so while it may suits the OP needs, for this question it would not be suitable."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1574274842, "post_id": 58951038, "comment_id": 104177531, "body": "Of interest, I just came upon <a href=\"https://github.com/rust-lang/rust/pull/65637\" rel=\"nofollow noreferrer\">github.com/rust-lang/rust/pull/65637</a> in TWiR."}, {"owner": {"reputation": 1648, "user_id": 2535207, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a0db392082edc1a1fc6f6c927210c233?s=128&d=identicon&r=PG", "display_name": "Jeremy Cochoy", "link": "https://stackoverflow.com/users/2535207/jeremy-cochoy"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1574283316, "post_id": 58951038, "comment_id": 104181528, "body": "@MatthieuM. Thanks. If I understand this commit, there will be <code>first</code> and <code>last</code> for the ordered set, and <code>first_key_value</code> and <code>last_key_value</code> for the ordered maps. Since the merge is young, I guess we will have to wait a bit. (:"}, {"owner": {"reputation": 1648, "user_id": 2535207, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a0db392082edc1a1fc6f6c927210c233?s=128&d=identicon&r=PG", "display_name": "Jeremy Cochoy", "link": "https://stackoverflow.com/users/2535207/jeremy-cochoy"}, "edited": false, "score": 0, "creation_date": 1594046861, "post_id": 58951038, "comment_id": 110982036, "body": "In 2020, The performance issue may not be there anymore! :)"}], "tags": [], "owner": {"reputation": 1648, "user_id": 2535207, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a0db392082edc1a1fc6f6c927210c233?s=128&d=identicon&r=PG", "display_name": "Jeremy Cochoy", "link": "https://stackoverflow.com/users/2535207/jeremy-cochoy"}, "is_accepted": true, "score": 10, "last_activity_date": 1574259158, "last_edit_date": 1574259158, "creation_date": 1574242566, "answer_id": 58951038, "question_id": 58951037, "link": "https://stackoverflow.com/questions/58951037/how-to-get-the-maximum-and-minimum-value-of-an-ordered-set-ordered-map/58951038#58951038", "title": "How to get the maximum and minimum value of an ordered set / ordered map?", "body": "<p>There are no maximum or minimum member methods (inherent or from a trait) for this type.</p>\n\n<p>The best way to have access to this information in O(log(n)) is to directly use an iterator, as mentioned by the developer team in <a href=\"https://github.com/rust-lang/rust/issues/31690\" rel=\"noreferrer\">issue 31690 from GitHub</a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let map: BTreeSet&lt;V&gt; = ...;\nlet min = map.iter().next();\nlet max = map.iter().next_back();\n</code></pre>\n\n<hr>\n\n<p>You can get the maximum and minimum of a collection by using the <code>Iterator::max()</code> and <code>Iterator::min()</code> methods, but doing this with an ordered set will browse the whole collection, ignoring the information that we have from the order.</p>\n\n<pre><code>// This will be very slow\nmap.iter().max()\nmap.iter().min()\n</code></pre>\n\n<p><a href=\"https://github.com/rust-lang/rust/issues/59947\" rel=\"noreferrer\">Issue 59947 has a benchmark</a> showing the two alternatives for <code>BTreeMap</code>:</p>\n\n<blockquote>\n  <pre class=\"lang-none prettyprint-override\"><code>test bench_first ... bench:           9 ns/iter (+/- 0)\ntest bench_last  ... bench:           8 ns/iter (+/- 0)\ntest bench_max   ... bench:       3,603 ns/iter (+/- 536)\ntest bench_min   ... bench:       3,755 ns/iter (+/- 328)\n</code></pre>\n</blockquote>\n"}], "owner": {"reputation": 1648, "user_id": 2535207, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a0db392082edc1a1fc6f6c927210c233?s=128&d=identicon&r=PG", "display_name": "Jeremy Cochoy", "link": "https://stackoverflow.com/users/2535207/jeremy-cochoy"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 628, "favorite_count": 1, "accepted_answer_id": 58951038, "answer_count": 1, "score": 4, "last_activity_date": 1574259158, "creation_date": 1574242566, "last_edit_date": 1574259041, "question_id": 58951037, "link": "https://stackoverflow.com/questions/58951037/how-to-get-the-maximum-and-minimum-value-of-an-ordered-set-ordered-map", "title": "How to get the maximum and minimum value of an ordered set / ordered map?", "body": "<p>Rust's ordered set is a <a href=\"https://doc.rust-lang.org/std/collections/struct.BTreeSet.html\" rel=\"nofollow noreferrer\"><code>BTreeSet</code></a>:</p>\n\n<blockquote>\n  <pre class=\"lang-rust prettyprint-override\"><code>use std::collections::BTreeSet;\n\n// Type inference lets us omit an explicit type signature (which\n// would be `BTreeSet&lt;&amp;str&gt;` in this example).\nlet mut books = BTreeSet::new();\n\n// Add some books.\nbooks.insert(\"A Dance With Dragons\");\nbooks.insert(\"To Kill a Mockingbird\");\nbooks.insert(\"The Odyssey\");\nbooks.insert(\"The Great Gatsby\");\n</code></pre>\n</blockquote>\n\n<p>An ordered map is a <a href=\"https://doc.rust-lang.org/std/collections/struct.BTreeMap.html\" rel=\"nofollow noreferrer\"><code>BTreeMap</code></a>.</p>\n\n<p>Since the set and map are ordered, there should be a way to get the maximal and minimal element contained. How do you get them?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 529, "user_id": 7208627, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/601ef91c31fe9a352ab3feb4cef3b8c6?s=128&d=identicon&r=PG&f=1", "display_name": "Inc&#246;mplete", "link": "https://stackoverflow.com/users/7208627/inc%c3%b6mplete"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1574239218, "post_id": 58948512, "comment_id": 104156426, "body": "@Jmb now it doesn&#39;t ..."}, {"owner": {"reputation": 1148, "user_id": 11619101, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-Pgyla3H7sk4/AAAAAAAAAAI/AAAAAAAAABc/XQ20NuIAEmM/photo.jpg?sz=128", "display_name": "Yuri Kovalenko", "link": "https://stackoverflow.com/users/11619101/yuri-kovalenko"}, "edited": false, "score": 0, "creation_date": 1574239619, "post_id": 58948512, "comment_id": 104156615, "body": "Do you want a string representation of the expression value, or the expression itself? (1 * 2 * 3) should be <code>&quot;1 * 2 * 3&quot;</code> or <code>&quot;6&quot;</code>?"}, {"owner": {"reputation": 529, "user_id": 7208627, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/601ef91c31fe9a352ab3feb4cef3b8c6?s=128&d=identicon&r=PG&f=1", "display_name": "Inc&#246;mplete", "link": "https://stackoverflow.com/users/7208627/inc%c3%b6mplete"}, "reply_to_user": {"reputation": 1148, "user_id": 11619101, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-Pgyla3H7sk4/AAAAAAAAAAI/AAAAAAAAABc/XQ20NuIAEmM/photo.jpg?sz=128", "display_name": "Yuri Kovalenko", "link": "https://stackoverflow.com/users/11619101/yuri-kovalenko"}, "edited": false, "score": 0, "creation_date": 1574240224, "post_id": 58948512, "comment_id": 104156974, "body": "@YuriKovalenko <code>&quot;6&quot;</code>"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574241954, "post_id": 58948512, "comment_id": 104157994, "body": "You can&#39;t without a proc macro for example. You need at least a temporary variable which you can store the <code>String</code> in. The other solution would be to convert &quot;x&quot; into a string, by using <code>to_string</code> on it."}, {"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 1, "creation_date": 1574249260, "post_id": 58948512, "comment_id": 104162357, "body": "Is there a specific motivation for wanting to do this in one line? Knowing that might allow people to provide alternative approaches."}, {"owner": {"reputation": 117, "user_id": 2523386, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0c8675cbade98eed1e234c4055df5f40?s=128&d=identicon&r=PG", "display_name": "Dragonseel", "link": "https://stackoverflow.com/users/2523386/dragonseel"}, "edited": false, "score": 0, "creation_date": 1574249534, "post_id": 58948512, "comment_id": 104162530, "body": "Also, is there a specific reason you need it as a string-slice? Using <code>String</code> instead would make it work in one line by converting the <code>&quot;x&quot;</code> to a <code>String</code>"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574251581, "post_id": 58948512, "comment_id": 104163651, "body": "sometime compiler can but not this time."}], "owner": {"reputation": 529, "user_id": 7208627, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/601ef91c31fe9a352ab3feb4cef3b8c6?s=128&d=identicon&r=PG&f=1", "display_name": "Inc&#246;mplete", "link": "https://stackoverflow.com/users/7208627/inc%c3%b6mplete"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 80, "favorite_count": 0, "closed_date": 1574259484, "answer_count": 0, "score": 0, "last_activity_date": 1574251639, "creation_date": 1574233349, "last_edit_date": 1574251639, "question_id": 58948512, "link": "https://stackoverflow.com/questions/58948512/how-to-create-a-string-slice-from-arithmetic-in-one-line", "closed_reason": "Duplicate", "title": "How to create a string slice from arithmetic in one line?", "body": "<p>In rust, how to create a string slice <code>&amp;str</code>, from a arithmetic expression, say <code>1 * 2 * 3</code>, in one line?</p>\n\n<p>i.e. the following code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let a = vec![\"x\", &amp;(1 * 2 * 3).to_string()];\n    println!(\"{:?}\", a)\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7231fc0d03c8d40010ade793a87311fe\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p>produces the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0716]: temporary value dropped while borrowed\n --&gt; src/main.rs:4:24\n  |\n4 |     let a = vec![\"x\", &amp;(1 * 2 * 3).to_string()];\n  |                        ^^^^^^^^^^^^^^^^^^^^^^^ - temporary value is freed at the end of this statement\n  |                        |\n  |                        creates a temporary which is freed while still in use\n5 |     println!(\"{:?}\", &amp;a);\n  |                      -- borrow later used here\n  |\n  = note: consider using a `let` binding to create a longer lived value\n</code></pre>\n\n<p>But doing as the compiler suggests would require an extra statement:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let num = (1 * 2 * 3).to_string();\nlet a = vec![\"x\", &amp;num];\n</code></pre>\n\n<p>Is there a way to get rid of the <code>let num = \u2026</code> statement?</p>\n"}, {"tags": ["rust", "command", "command-line-interface", "rust-2018"], "comments": [{"owner": {"reputation": 9010, "user_id": 2588800, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/847da843d41921363502159c8b7e5549?s=128&d=identicon&r=PG", "display_name": "Svetlin Zarev", "link": "https://stackoverflow.com/users/2588800/svetlin-zarev"}, "edited": false, "score": 0, "creation_date": 1574236969, "post_id": 58948331, "comment_id": 104155423, "body": "just use piped stdin like you have already done for stdout. Then use the <code>Child</code> object returned by <code>spawn()</code> to obtain the child&#39;s stdin/out/err"}], "owner": {"reputation": 55, "user_id": 3481418, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jJFX0.jpg?s=128&g=1", "display_name": "Hve", "link": "https://stackoverflow.com/users/3481418/hve"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 176, "favorite_count": 1, "answer_count": 0, "score": 1, "last_activity_date": 1574232640, "creation_date": 1574232640, "question_id": 58948331, "link": "https://stackoverflow.com/questions/58948331/how-to-execute-a-command-which-ask-for-input-in-rust", "title": "How to execute a command which ask for input in Rust", "body": "<p>I am building a CLI using Rust-2018. It's a kind of wrapper around an old command.\nI need to call that command in my Rust program but the thing is that the command asks for input (password) to perform the task.</p>\n\n<p>Just like keytool when to need to generate a keypair and it prompts you to enter a password.</p>\n\n<p>I want the called program to perform all his flow and only know if the program ends successfully or not.</p>\n\n<p>This is what I have tried so far but it's not working as expected.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::process::{Command, Stdio};\n\nCommand::new(\"...)\n.args(&amp;[...]\n.stdout(Stdio::piped())\n.spawn()\n.expected(\"...)\n</code></pre>\n\n<p>Thanks for your help!</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574221135, "post_id": 58946151, "comment_id": 104150472, "body": "It&#39;s hard to answer your question because it doesn&#39;t include a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. We can&#39;t tell what things are present in the code, like <code>decide_winner</code> or <code>hand_one_score</code>. It would make it easier for us to help you if you try to reproduce your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> if possible, otherwise in a brand new Cargo project, then <a href=\"https://stackoverflow.com/posts/58946151/edit\">edit</a> your question to include the additional info. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MRE tips</a> you can use to reduce your original code for posting here. Thanks!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574221733, "post_id": 58946151, "comment_id": 104150604, "body": "There&#39;s a number of non-idiomatic aspects to this code. Once you have a working solution, I encourage you to seek out holistic review of your code on <a href=\"https://codereview.meta.stackexchange.com/questions/5777/a-guide-to-code-review-for-stack-overflow-users\">Code Review</a>."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 0, "last_activity_date": 1574222482, "creation_date": 1574222482, "answer_id": 58946471, "question_id": 58946151, "link": "https://stackoverflow.com/questions/58946151/calling-a-function-that-returns-an-array-of-string-literals-errors-with-cannot/58946471#58946471", "title": "Calling a function that returns an array of string literals errors with &quot;cannot return value referencing local variable&quot;", "body": "<p>Your example can be <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">reduced</a> to this:</p>\n\n<pre><code>fn parse_winning_hand(_: &amp;[i32]) -&gt; [&amp;str; 1] {\n    [\"0\"]\n}\n\nfn deal() -&gt; [&amp;'static str; 1] {\n    parse_winning_hand(&amp;vec![])\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0515]: cannot return value referencing temporary value\n --&gt; src/lib.rs:6:5\n  |\n6 |     parse_winning_hand(&amp;vec![])\n  |     ^^^^^^^^^^^^^^^^^^^^------^\n  |     |                   |\n  |     |                   temporary value created here\n  |     returns a value referencing data owned by the current function\n  |\n  = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n</code></pre>\n\n<p>This is because you have forgotten to specify the <code>'static</code> lifetime on the return type of <code>parse_winning_hand</code>:</p>\n\n<pre><code>fn parse_winning_hand(_: &amp;[i32]) -&gt; [&amp;'static str; 1]\n//                                    ^~~~~~~\n</code></pre>\n\n<p>Without the <code>'static</code>, <a href=\"https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html#lifetime-elision\" rel=\"nofollow noreferrer\"><em>lifetime elision</em></a> causes the function signature to tie the lifetime of the returned value to the lifetime of the input value:</p>\n\n<pre><code>fn parse_winning_hand&lt;'a&gt;(_: &amp;'a [i32]) -&gt; [&amp;'a str; 1]\n</code></pre>\n\n<p>This means that it's impossible for the returned value to outlive the <code>Vec</code> that is passed in.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/40325690/155423\">What is lifetime elision in very simple terms?</a></li>\n<li><a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a></li>\n</ul>\n"}], "owner": {"reputation": 171, "user_id": 2142581, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/09779537673c304f05c1a66240f6fd3f?s=128&d=identicon&r=PG", "display_name": "AFC", "link": "https://stackoverflow.com/users/2142581/afc"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 223, "favorite_count": 0, "accepted_answer_id": 58946471, "answer_count": 1, "score": 0, "last_activity_date": 1574222482, "creation_date": 1574220227, "last_edit_date": 1574221549, "question_id": 58946151, "link": "https://stackoverflow.com/questions/58946151/calling-a-function-that-returns-an-array-of-string-literals-errors-with-cannot", "title": "Calling a function that returns an array of string literals errors with &quot;cannot return value referencing local variable&quot;", "body": "<p>The goal of the <code>parse_winning_hand</code> function is to accept a vector of 5 <code>i32</code>s and then append the corresponding letter to the i'th index of <code>return_val</code> (from 0 to 5). <code>deal</code> is a driver function that calls <code>parse_winning_hand</code> at the end of its run:</p>\n\n<pre><code>fn parse_winning_hand(hand: &amp;Vec&lt;i32&gt;) -&gt; [&amp;str; 5] {\n    let mut temp_hand = hand.to_vec();\n    let mut return_val = [\"12\", \"12\", \"12\", \"12\", \"12\"];\n    for i in 0..5 {\n        let popped = temp_hand.pop().unwrap();\n        let mut suit = \"X\";\n        if popped &lt; 14 {\n            suit = \"C\";\n        } else if popped &lt; 27 {\n            suit = \"D\";\n        } else if popped &lt; 40 {\n            suit = \"H\";\n        } else {\n            suit = \"S\";\n        }\n        return_val[i] = suit;\n    }\n    return return_val;\n}\n\nfn deal(arr: &amp;[i32]) -&gt; [&amp;'static str; 5] {\n    // ...\n    let decided_winner = decide_winner(hand_one_score, hand_two_score);\n    if decided_winner == 1 {\n        let ret = parse_winning_hand(&amp;hand_one);\n        return ret;\n    } else {\n        let ret = parse_winning_hand(&amp;hand_two);\n        return ret;\n    }\n}\n</code></pre>\n\n<p>The error that I am getting during compilation is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0515]: cannot return value referencing local variable `hand_one`\n   --&gt; Poker.rs:276:10\n    |\n275 |         let ret = parse_winning_hand(&amp;hand_one);\n    |                                      --------- `hand_one` is borrowed here\n276 |         return ret;\n    |                ^^^ returns a value referencing data owned by the current function\n\nerror[E0515]: cannot return value referencing local variable `hand_two`\n   --&gt; Poker.rs:279:10\n    |\n278 |         let ret = parse_winning_hand(&amp;hand_two);\n    |                                      --------- `hand_two` is borrowed here\n279 |         return ret;\n    |                ^^^ returns a value referencing data owned by the current function\n</code></pre>\n\n<p>I have searched for solutions to this problem but either the solution wasn't applicable to my needs or I wasn't able to understand the posted solution due to my lack of knowledge. Why I am getting the error? How do I fix it?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 96489, "user_id": 788207, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/KQmlY.jpg?s=128&g=1", "display_name": "Vladimir Matveev", "link": "https://stackoverflow.com/users/788207/vladimir-matveev"}, "edited": false, "score": 0, "creation_date": 1574204202, "post_id": 58943851, "comment_id": 104146666, "body": "Refer to the Rust book: <a href=\"https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#stack-only-data-copy\" rel=\"nofollow noreferrer\">doc.rust-lang.org/book/&hellip;</a> Basically, you can&#39;t and shouldn&#39;t implement Copy for your types. <code>Copy</code> &lt;=&gt; bitwise copy, and it cannot work for non-<code>Copy</code> nested data."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574205189, "post_id": 58943851, "comment_id": 104146974, "body": "So you just need Clone feature add <code>#[derive(Clone)]</code> to your structure and use <code>.clone()</code> to &quot;copy&quot; your data"}, {"owner": {"reputation": 75, "user_id": 11535110, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8ddecb0a2956f90109dbc6e9e827cb2c?s=128&d=identicon&r=PG&f=1", "display_name": "Kied Llaentenn", "link": "https://stackoverflow.com/users/11535110/kied-llaentenn"}, "edited": false, "score": 0, "creation_date": 1574205229, "post_id": 58943851, "comment_id": 104146990, "body": "Oh well. The main reason I wanted to implement copy for this struct is because I&#39;m going to have to deref this struct in quite a few places, and that won&#39;t work if Copy isnt implemented."}, {"owner": {"reputation": 75, "user_id": 11535110, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8ddecb0a2956f90109dbc6e9e827cb2c?s=128&d=identicon&r=PG&f=1", "display_name": "Kied Llaentenn", "link": "https://stackoverflow.com/users/11535110/kied-llaentenn"}, "edited": false, "score": 0, "creation_date": 1574205276, "post_id": 58943851, "comment_id": 104147003, "body": "Is there a way to <i>close</i> a SO question without deleting it?"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1574208752, "post_id": 58943851, "comment_id": 104147902, "body": "There are several ways, actually, but it depends on your reputation and the reason for closure. I think this question is a candidate for marking as a duplicate of the question I linked; if that answers your question, you should be able to agree with the duplicate vote, which will close the question (since you are the author). Questions marked as duplicates are not deleted, but left as &quot;signposts&quot; to help future askers find the questions with the answers they need."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1574208899, "post_id": 58943851, "comment_id": 104147939, "body": "(If you need a certain amount of reputation to close-vote your own question, you might not see the option.)"}, {"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 2, "creation_date": 1574212451, "post_id": 58943851, "comment_id": 104148706, "body": "@KiedLlaentenn Copy isn&#39;t needed for <code>Deref</code>, perhaps there&#39;s something else tripping you up?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 1, "creation_date": 1574218537, "post_id": 58943851, "comment_id": 104149938, "body": "@loganfsmyth I assume that they mean they have a variable like <code>foo: &amp;Token</code> and want to do <code>*foo</code>, not actually implement <code>Deref</code> themselves. I agree that there&#39;s probably some better solution for the real problem."}, {"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574218925, "post_id": 58943851, "comment_id": 104150018, "body": "@Shepmaster Good call, that makes sense."}, {"owner": {"reputation": 75, "user_id": 11535110, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8ddecb0a2956f90109dbc6e9e827cb2c?s=128&d=identicon&r=PG&f=1", "display_name": "Kied Llaentenn", "link": "https://stackoverflow.com/users/11535110/kied-llaentenn"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574387699, "post_id": 58943851, "comment_id": 104225000, "body": "@Shepmaster yes, that&#39;s what I was trying to do :)"}], "owner": {"reputation": 75, "user_id": 11535110, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8ddecb0a2956f90109dbc6e9e827cb2c?s=128&d=identicon&r=PG&f=1", "display_name": "Kied Llaentenn", "link": "https://stackoverflow.com/users/11535110/kied-llaentenn"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 580, "favorite_count": 1, "closed_date": 1574213402, "answer_count": 0, "score": 1, "last_activity_date": 1574213446, "creation_date": 1574202805, "last_edit_date": 1574213446, "question_id": 58943851, "link": "https://stackoverflow.com/questions/58943851/how-do-i-manually-implement-the-copy-trait-for-struct-containing-string", "closed_reason": "Duplicate", "title": "How do I manually implement the Copy trait for struct containing String?", "body": "<p>I am attempting to implement the <code>Copy</code> trait for a struct that contains a <code>String</code>. However, I am having some trouble finding relevant documentation.</p>\n\n<p>Here's what I have:</p>\n\n<pre><code>pub struct Token {\n    pub token: String,\n    pub tok_type: AnotherStruct, // implements Copy/Clone already\n}\n\nimpl Copy for Token { }\n</code></pre>\n\n<p>which refuses to compile, stating that I cannot implement trait <code>Copy</code> for type <code>String</code>.</p>\n\n<p>I changed the <code>impl</code> to:</p>\n\n<pre><code>impl Copy for Token {\n    fn copy(&amp;self) -&gt; Token {\n        Token { token: self.token.clone(), tok_type: self.tok_type, }\n    }\n}\n</code></pre>\n\n<p>and get:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0407]: method `copy` is not a member of trait `Copy`\n  --&gt; src/types.rs:18:5\n   |\n18 | /     fn copy(&amp;self) -&gt; Token {\n19 | |         Token {\n20 | |             token: self.token.clone(),\n21 | |             tok_type: self.tok_type,\n22 | |         }\n23 | |     }\n   | |_____^ not a member of trait `Copy`\n\nerror[E0204]: the trait `Copy` may not be implemented for this type\n  --&gt; src/types.rs:17:6\n   |\n13 |     pub token: String,\n   |     ------------------ this field does not implement `Copy`\n...\n17 | impl Copy for Token {\n   |      ^^^^\n</code></pre>\n"}, {"tags": ["multithreading", "rust", "thread-local-storage"], "comments": [{"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574196726, "post_id": 58942482, "comment_id": 104143634, "body": "All Linux. If you look at the code you will see that there is a &quot;fast&quot; version and an &quot;os dependent&quot; version. So it is not at all clear that rust uses the OS version, and from the godbolt compiler explorer link I posted in the &quot;bad&quot; question it is clear that there is no call into an OS api at least at highest optimization level..."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574196814, "post_id": 58942482, "comment_id": 104143685, "body": "what make you think it will use more bytes that the real type ?"}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574196997, "post_id": 58942482, "comment_id": 104143757, "body": "There are tons of different ways to implement thread local storage. I just want to know the details so I know how much of a burden it is to users of the library."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574197877, "post_id": 58942482, "comment_id": 104144142, "body": "guess this kind of &quot;detail&quot; is compiler specific and are subject to change at anytime."}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574198146, "post_id": 58942482, "comment_id": 104144248, "body": "Rust is not java. The target audience of rust needs to know the details. A feature where the resource usage can change at any time is not typical for rust."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574199658, "post_id": 58942482, "comment_id": 104144929, "body": "No, this is wrong, even in C thread local variable are implemented behaviour. I can&#39;t explain the real difference between Rust and java in a comment."}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574202416, "post_id": 58942482, "comment_id": 104146096, "body": "What I meant is that in java you often get answers like: the runtime will take care of it, whereas in rust you usually know exactly e.g. how the bytes are layed out in memory. So fine, it can change at any time, but how is it <i>currently</i> implemented?"}, {"owner": {"reputation": 529, "user_id": 11877195, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0ed77976acc203f50e7699ba07061865?s=128&d=identicon&r=PG&f=1", "display_name": "Sahsahae", "link": "https://stackoverflow.com/users/11877195/sahsahae"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574345627, "post_id": 58942482, "comment_id": 104206929, "body": "@Stargateur good thing that we all are sane in here and only use one and only compiler, rustc...  Even then, it&#39;s not very relevant, because sizes won&#39;t ever change unless we are talking about very specific things, such as usize and &quot;hacky&quot; (I personally know none for anything) implementations of things for embedded programming."}], "owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 102, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1574241095, "creation_date": 1574196140, "last_edit_date": 1574241095, "question_id": 58942482, "link": "https://stackoverflow.com/questions/58942482/how-many-bytes-will-a-thread-local-variable-in-rust-use", "title": "How many bytes will a thread local variable in Rust use?", "body": "<p>I want to use a thread local variable of type <code>Option&lt;usize&gt;</code> in a Rust library. How many bytes will this use per thread for crates that have a dependency on my library? I'm interested in Rust 1.39 and targeting Linux for three processors: amd64, x86 and arm32.</p>\n"}, {"tags": ["multithreading", "rust", "thread-local", "thread-local-storage"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574194968, "post_id": 58942163, "comment_id": 104142853, "body": "Did you click through to the suggested reading of <a href=\"https://doc.rust-lang.org/std/thread/struct.LocalKey.html\" rel=\"nofollow noreferrer\"><code>LocalKey</code></a>? It states: <i>This key uses the fastest possible implementation available to it for the target platform</i> and <i>Initialization is dynamically performed on the first call to with within a thread, and values that implement Drop get destructed when a thread exits</i> which appear to answer both of your questions."}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574195074, "post_id": 58942163, "comment_id": 104142905, "body": "Yes, of course I read that. That tells me what it does and that it tries to be fast, but not <i>how</i> it works. E.g. it does not help me answer the question how many bytes per thread it will cost library users if I use a thread local in a library..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1574195497, "post_id": 58942163, "comment_id": 104143102, "body": "The current close vote is &quot;Too broad \u2014 Please edit the question to limit it to a specific problem with enough detail to identify an adequate answer&quot;. You have indeed asked a very broad question (&quot;how is something implemented&quot;) and have actually asked multiple questions (+ &quot;which is default&quot; + &quot;how do I choose&quot; + &quot;what are the implications&quot; + &quot;how much space does it take&quot;). Any answer that covered these topics to a thorough degree would be a chapter in a book, which is a pretty good sign that the question is overly broad."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574195569, "post_id": 58942163, "comment_id": 104143150, "body": "No idea about the title though; the only similar thing I&#39;ve seen personally is a warning that specific titles have historically been downvoted for being low-quality. As you&#39;ve seen, I was able to edit it (and I bet you could have too)."}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574195902, "post_id": 58942163, "comment_id": 104143298, "body": "If I ask a concrete question it probably will be closed because it can not be simply answered. But I will try it anyway. But in another question... Feel free to close this one..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574196057, "post_id": 58942163, "comment_id": 104143345, "body": "Of the ones I&#39;ve identified, &quot;what is the space overhead of using a thread local&quot; seems reasonable and answerable. However, because there are platform-specific details, it may indeed be very hard to answer, but should be on-topic. It would probably be good if you identified a base set of platforms you were interested in (e.g. 64-bit Mac/Linux/Windows)."}, {"owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574196208, "post_id": 58942163, "comment_id": 104143396, "body": "Let us <a href=\"https://chat.stackoverflow.com/rooms/202676/discussion-between-rudiger-klaehn-and-shepmaster\">continue this discussion in chat</a>."}, {"owner": {"reputation": 833, "user_id": 3297655, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/df1bc6c2cef925a8f52d36b3290958b9?s=128&d=identicon&r=PG&f=1", "display_name": "chabapok", "link": "https://stackoverflow.com/users/3297655/chabapok"}, "edited": false, "score": 1, "creation_date": 1574248658, "post_id": 58942163, "comment_id": 104162026, "body": "As far as i remember, rust threadlocals based on pthreads (for linux) library. So, the overhead same as pthreads. See manual for pthread_key_creatre() and others."}], "answers": [{"tags": [], "owner": {"reputation": 1963, "user_id": 168853, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/AFKqK.jpg?s=128&g=1", "display_name": "NikitaBaksalyar", "link": "https://stackoverflow.com/users/168853/nikitabaksalyar"}, "is_accepted": false, "score": 9, "last_activity_date": 1588954870, "last_edit_date": 1588954870, "creation_date": 1588947100, "answer_id": 61681112, "question_id": 58942163, "link": "https://stackoverflow.com/questions/58942163/how-do-the-thread-local-variables-in-the-rust-standard-library-work/61681112#61681112", "title": "How do the thread local variables in the Rust standard library work?", "body": "<p>The different configurations you see are related to <code>#[thread_local]</code>, a feature that is intended to replace the <code>thread_local!</code> macro to make the user code more straightforward, e.g.:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(thread_local)]\n\n#[thread_local]\npub static mut VAR: u64 = 42;\n</code></pre>\n\n<p>However, at the moment of writing, this feature is not fully implemented yet (you can find the tracking issue <a href=\"https://github.com/rust-lang/rust/issues/29594\" rel=\"nofollow noreferrer\">here</a>). It <em>is</em> used internally in the compiler code though, and that is the magic you see in the actual 'fast' <a href=\"https://github.com/rust-lang/rust/blob/a51e004e1bf7f9bba151dd9104a217c1ace6a0a2/src/libstd/thread/local.rs#L160-L166\" rel=\"nofollow noreferrer\">implementation in <code>std::thread::LocalKey</code></a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[thread_local]\n#[cfg(all(\n    target_thread_local,\n    not(all(target_arch = \"wasm32\", not(target_feature = \"atomics\"))),\n))]\nstatic __KEY: $crate::thread::__FastLocalKeyInner&lt;$t&gt; =\n    $crate::thread::__FastLocalKeyInner::new();\n</code></pre>\n\n<p>Notice the <code>#[thread_local]</code> attribute at the top. It is then translated down to LLVM IR, so the actual implementation of TLS (thread-local storage) is <a href=\"https://llvm.org/docs/LangRef.html#thread-local-storage-models\" rel=\"nofollow noreferrer\">carried by LLVM</a> and implements the <a href=\"http://people.redhat.com/drepper/tls.pdf\" rel=\"nofollow noreferrer\">ELF TLS models</a>. This is the default configuration.</p>\n\n<blockquote>\n  <p>how do I choose which one to use?</p>\n</blockquote>\n\n<p>You'll need to compile your own <code>rustc</code> version with the <code>target_thread_local</code> feature omitted. In that case, the <a href=\"https://github.com/rust-lang/rust/blob/a51e004e1bf7f9bba151dd9104a217c1ace6a0a2/src/libstd/thread/local.rs#L465\" rel=\"nofollow noreferrer\"><code>os</code> variant</a> of <code>std::thread::LocalKey</code> will be used, and then, depending on a platform, it can use <a href=\"https://github.com/rust-lang/rust/blob/a51e004e1bf7f9bba151dd9104a217c1ace6a0a2/src/libstd/sys/unix/thread_local.rs\" rel=\"nofollow noreferrer\">pthreads (Unix)</a>, or <a href=\"https://github.com/rust-lang/rust/blob/a51e004e1bf7f9bba151dd9104a217c1ace6a0a2/src/libstd/sys/windows/thread_local.rs\" rel=\"nofollow noreferrer\">Windows API</a>, or something else.</p>\n\n<p>WebAssembly is a special case: as it doesn't support threads, TLS will be translated down to simple static variables.</p>\n"}], "owner": {"reputation": 11890, "user_id": 2083327, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/jRF9x.jpg?s=128&g=1", "display_name": "R&#252;diger Klaehn", "link": "https://stackoverflow.com/users/2083327/r%c3%bcdiger-klaehn"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 653, "favorite_count": 1, "answer_count": 1, "score": 5, "last_activity_date": 1588954870, "creation_date": 1574194555, "last_edit_date": 1574196964, "question_id": 58942163, "link": "https://stackoverflow.com/questions/58942163/how-do-the-thread-local-variables-in-the-rust-standard-library-work", "title": "How do the thread local variables in the Rust standard library work?", "body": "<p>How do the <a href=\"https://doc.rust-lang.org/std/macro.thread_local.html\" rel=\"noreferrer\">thread local variables</a> in the Rust standard library work? I looked at <a href=\"https://github.com/rust-lang/rust/blob/618b01f9fa0a6b4e7e2ce5b3409abe104b80c4a8/src/libstd/thread/local.rs\" rel=\"noreferrer\">the code</a>, but got lost in indirection. It seems that there are different configurations for thread local storage, an OS dependent mode and a fast mode. Which one is the default, and how do I choose which one to use? In particular, what are the implications of using thread local storage in a crate for the user of the crate?</p>\n\n<p>Using thread local storage is simple enough, and the <a href=\"https://godbolt.org/z/MZDnX4\" rel=\"noreferrer\">generated assembly</a> looks really efficient, but I can not use the feature in a library without fully understanding the implications.</p>\n\n<p>I've also asked:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/58942482/155423\">How many bytes will a thread local variable in Rust use?</a></li>\n</ul>\n"}, {"tags": ["rust", "ethereum", "substrate", "parity-io", "evm"], "answers": [{"comments": [{"owner": {"reputation": 8871, "user_id": 1260906, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/aPM5A.png?s=128&g=1", "display_name": "Afr", "link": "https://stackoverflow.com/users/1260906/afr"}, "edited": false, "score": 1, "creation_date": 1574330000, "post_id": 58943352, "comment_id": 104197602, "body": "Ok, thanks. That answers my question. Coming up with a dynamic gas pricing would be a good next excercise."}], "tags": [], "owner": {"reputation": 989, "user_id": 4184410, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/cyvsh.jpg?s=128&g=1", "display_name": "JoshOrndorff", "link": "https://stackoverflow.com/users/4184410/joshorndorff"}, "is_accepted": true, "score": 2, "last_activity_date": 1579621612, "last_edit_date": 1579621612, "creation_date": 1574200220, "answer_id": 58943352, "question_id": 58942015, "link": "https://stackoverflow.com/questions/58942015/how-to-implement-the-evm-trait-for-a-substrate-runtime/58943352#58943352", "title": "How to implement the EVM Trait for a Substrate Runtime?", "body": "<p>Because pallet-evm doesn't provide default implementations for the types you need, you'll need to create them yourself.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use paint_evm::{FeeCalculator, ConvertAccountId};\nuse primitives::{U256, H160};\n\npub struct FixedGasPrice;\n\nimpl FeeCalculator for FixedGasPrice {\n    fn gas_price() -&gt; U256 {\n        // Gas price is always one token per gas.\n        1.into()\n    }\n}\n\npub struct TruncatedAccountId;\n\nimpl&lt;AccountId&gt; ConvertAccountId&lt;AccountId&gt; for TruncatedAccountId {\n    fn convert_account_id(account_id: &amp;AccountId) -&gt; H160 {\n        //TODO just truncate the fist several bits and return the resulting H160\n        // Or maybe hashing is easier to figure out\n        unimplemented!();\n    }\n}\n\nimpl paint_evm::Trait for Runtime {\n    type FeeCalculator = FixedGasPrice;\n    type ConvertAccountId = TruncatedAccountId;\n    type Currency = Balances;\n    type Event = Event;\n    type Precompiles = (); // We can use () here because paint_evm provides an\n                           // `impl Precompiles for ()``\n                           // block that always returns none (line 75)\n}\n</code></pre>\n\n<p>I look forward to improving this answer as I understand more myself.</p>\n"}], "owner": {"reputation": 8871, "user_id": 1260906, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/aPM5A.png?s=128&g=1", "display_name": "Afr", "link": "https://stackoverflow.com/users/1260906/afr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 194, "favorite_count": 0, "accepted_answer_id": 58943352, "answer_count": 1, "score": 2, "last_activity_date": 1579621612, "creation_date": 1574193918, "question_id": 58942015, "link": "https://stackoverflow.com/questions/58942015/how-to-implement-the-evm-trait-for-a-substrate-runtime", "title": "How to implement the EVM Trait for a Substrate Runtime?", "body": "<p>Following the <a href=\"https://substrate.dev/docs/en/next/tutorials/adding-a-module-to-your-runtime\" rel=\"nofollow noreferrer\">adding a module to your runtime</a>, I'm trying to implement the <a href=\"https://github.com/paritytech/substrate\" rel=\"nofollow noreferrer\">Parity Substrate</a> <code>paint-evm</code> trait for the <a href=\"https://github.com/dothereum/dothereum/tree/beta/runtime\" rel=\"nofollow noreferrer\">Dothereum Runtime</a>.</p>\n\n<p>The <a href=\"https://substrate.dev/rustdocs/master/srml_evm/trait.Trait.html\" rel=\"nofollow noreferrer\">EVM module trait</a> is defined as follows:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait Trait: Trait + Trait {\n    type FeeCalculator: FeeCalculator;\n    type ConvertAccountId: ConvertAccountId&lt;Self::AccountId&gt;;\n    type Currency: Currency&lt;Self::AccountId&gt;;\n    type Event: From&lt;Event&gt; + Into&lt;Self::Event&gt;;\n    type Precompiles: Precompiles;\n}\n</code></pre>\n\n<p>The <em>adding a module</em> tutorial here, however, is a bit vague and encourages one to:</p>\n\n<blockquote>\n  <p>\".. explore the source code of the [..] module if things don't make sense ..\"</p>\n</blockquote>\n\n<p>While the EVM module code doesn't seem too complex, I fail to understand how to implement the EVM trait for my runtime:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl evm::Trait for Runtime {\n    type FeeCalculator = ();\n    type ConvertAccountId = ();\n    type Currency = Balances; \n    type Event = Event;\n    type Precompiles = ();\n}\n</code></pre>\n\n<p>What types do <code>FeeCalculator</code> and <code>ConvertAccountId</code> expect here?</p>\n"}, {"tags": ["rust", "language-lawyer"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1574190348, "post_id": 58941122, "comment_id": 104140841, "body": "doc-comments can <a href=\"https://stackoverflow.com/q/33999341/155423\">be an attribute</a>."}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1574196174, "post_id": 58941122, "comment_id": 104143380, "body": "Doc comments can also use <code>&#47;*! *&#47;</code> or <code>&#47;** *&#47;</code>"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1574236605, "post_id": 58941122, "comment_id": 104155259, "body": "Doc comments are Markdown, which does require line breaks for some features (eg. paragraphs(!)), even with the <code>&#47;*! *&#47;</code> or <code>&#47;** *&#47;</code> or attribute syntax. Other than that, I believe everything could be written in one line."}, {"owner": {"reputation": 529, "user_id": 11877195, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0ed77976acc203f50e7699ba07061865?s=128&d=identicon&r=PG&f=1", "display_name": "Sahsahae", "link": "https://stackoverflow.com/users/11877195/sahsahae"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574345968, "post_id": 58941122, "comment_id": 104207212, "body": "@Shepmaster but attributes are applied to next item(?), <code>#[attrib] item;</code> is perfectly valid syntax, for example <code>fn main(){#[cfg(debug_assertions)] println!(&quot;dbg&quot;);}</code>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 529, "user_id": 11877195, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0ed77976acc203f50e7699ba07061865?s=128&d=identicon&r=PG&f=1", "display_name": "Sahsahae", "link": "https://stackoverflow.com/users/11877195/sahsahae"}, "edited": false, "score": 1, "creation_date": 1574346258, "post_id": 58941122, "comment_id": 104207420, "body": "@Sahsahae yes, that\u2019s my point. Because doc comments can be attributes, they don\u2019t require multiple lines. It\u2019s a refutal of that bullet point."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 2, "creation_date": 1574346308, "post_id": 58941122, "comment_id": 104207446, "body": "@Jmb if you write it as an attribute, can\u2019t you use <code>\\n</code> in the string literal?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574669343, "post_id": 58941122, "comment_id": 104299226, "body": "@Shepmaster good point, it should work with attributes"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1574669984, "post_id": 58941122, "comment_id": 104299480, "body": "Another thing I just thought of: in proc macros you can (on nightly) get the line number of a specific span. With that, you can artificially enforce a syntax that requires multiple lines. That&#39;s a unusual exception tho. I guess now someone just has to summarize it all and write an answer? ^_^"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574693038, "post_id": 58941122, "comment_id": 104311830, "body": "@LukasKalbertodt not really. The question is a <a href=\"https://en.wikipedia.org/wiki/Burden_of_proof_(philosophy)#Proving_a_negative\" rel=\"nofollow noreferrer\">&quot;prove a negative&quot;</a> which means it&#39;s hard to answer authoritatively."}], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 101, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1574190301, "creation_date": 1574190069, "last_edit_date": 1574190301, "question_id": 58941122, "link": "https://stackoverflow.com/questions/58941122/are-there-parts-of-the-rust-language-that-only-work-on-multiple-lines", "title": "Are there parts of the Rust language that only work on multiple lines?", "body": "<p>Is it possible to take <em>any</em> Rust code and make it work in only one line (without any line breaks)? In particular, it should work exactly like the \"normal\" multi line code: </p>\n\n<ul>\n<li>if it's an executable, the runtime behavior should be the same. </li>\n<li>if it's a library, the documentation and <code>.rlib</code> file should be the same.</li>\n</ul>\n\n<p>This is a purely theoretical question and I don't plan on actually writing my Rust code like this :P</p>\n\n<p>I know that most typical Rust code can be written in one line. Hello world is easy-peasy:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() { println!(\"Hello, world\"); }\n</code></pre>\n\n<p><strong>Are there any Rust constructs that <em>can't</em> be written in one line?</strong> I thought of a few candidates already:</p>\n\n<ul>\n<li><strong>Doc comments</strong>. I usually see them written as <code>///</code> or <code>//!</code> and they include everything until the end of the line.</li>\n<li><strong>Macros</strong>, especially procedural ones, can do some strange unexpected things. Maybe it is possible to construct macros that only work on multiple lines?</li>\n<li><strong>String literals</strong> can be written over multiple lines in which case they will include the linebreaks. I know that those line breaks can also be written as <code>\\n</code>, but maybe there is something about multi-line strings that does not work in a single line? Maybe something something about raw string literals?</li>\n<li>Maybe some planned future extensions of Rust?</li>\n<li>Probably many other things I didn't think of...</li>\n</ul>\n"}, {"tags": ["rust", "async-await", "nonblocking"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574178746, "post_id": 58937689, "comment_id": 104134542, "body": "just code directly in byte if you think like that, don&#39;t even need an assembler. This kind of question is bad by nature on SO."}, {"owner": {"reputation": 10789, "user_id": 668963, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/46cf01443d69ee2e3034de2d77ae1732?s=128&d=identicon&r=PG", "display_name": "neevek", "link": "https://stackoverflow.com/users/668963/neevek"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574178883, "post_id": 58937689, "comment_id": 104134622, "body": "@Shepmaster it is not the same question, I want to know if <code>async &#47; await</code> is still needed if I use non-blocking IO."}, {"owner": {"reputation": 10789, "user_id": 668963, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/46cf01443d69ee2e3034de2d77ae1732?s=128&d=identicon&r=PG", "display_name": "neevek", "link": "https://stackoverflow.com/users/668963/neevek"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574179168, "post_id": 58937689, "comment_id": 104134776, "body": "@Stargateur, If you think using Mio or libuv is like coding in byte, then this question is bad. The question is not about using low level techniques, it is that I want to know whether <code>async</code> is still necessary if I use non-blocking IO."}, {"owner": {"reputation": 10789, "user_id": 668963, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/46cf01443d69ee2e3034de2d77ae1732?s=128&d=identicon&r=PG", "display_name": "neevek", "link": "https://stackoverflow.com/users/668963/neevek"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574179698, "post_id": 58937689, "comment_id": 104135106, "body": "@Shepmaster, I am new to Rust, I may be wrong, that&#39;s why I post the question, and I hope someone can elaborate on the topic."}], "answers": [{"comments": [{"owner": {"reputation": 10789, "user_id": 668963, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/46cf01443d69ee2e3034de2d77ae1732?s=128&d=identicon&r=PG", "display_name": "neevek", "link": "https://stackoverflow.com/users/668963/neevek"}, "edited": false, "score": 0, "creation_date": 1574180603, "post_id": 58938400, "comment_id": 104135653, "body": "I was just trying to state my understanding, not to prove myself. Since the <code>async</code> / <code>await</code> APIs look neat, I was wondering if they can fit in non-blocking IO use cases. So a simple <b>Yes</b> or <b>No</b> will be much more useful than any metaphors."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1574188302, "last_edit_date": 1574188302, "creation_date": 1574179896, "answer_id": 58938400, "question_id": 58937689, "link": "https://stackoverflow.com/questions/58937689/why-do-i-need-async-await-if-i-already-have-non-blocking-io-like-epoll-kqueu/58938400#58938400", "title": "Why do I need async / await if I already have non-blocking IO like epoll / kqueue / IOCP?", "body": "<blockquote>\n  <p>If I use non-blocking IO like Mio or <em>unsafe</em> <code>epoll</code>, do I still need <code>async</code> / <code>await</code>?</p>\n</blockquote>\n\n<p><strong>No</strong>, <em>you</em> don't need <code>async</code> / <code>await</code>: you have code that does what you want, you are happy with it, and it doesn't use <code>async</code> / <code>await</code>. There's no apparent reason for you to change your code. You state this in multiple ways:</p>\n\n<blockquote>\n  <p>Mio works the way I understand</p>\n</blockquote>\n\n\n\n<blockquote>\n  <p>[Mio] is familiar to me.</p>\n</blockquote>\n\n\n\n<blockquote>\n  <p>I can easily use this kind of API </p>\n</blockquote>\n\n<p>The same style of question could be asked about functions. Functions aren't strictly needed because we could copy-paste code everywhere it's used. The code does what someone wants, someone is happy with it, and it doesn't make use of functions. There's no apparent reason for this developer to change their code.</p>\n\n<hr>\n\n<p><strong>Yes</strong> \u2014 in general, most Rust developers will use <code>async</code> / <code>await</code> when they are trying to write asynchronous code (and maybe even when they shouldn't). These keywords are mostly syntax sugar for creating a <a href=\"https://doc.rust-lang.org/std/future/trait.Future.html\" rel=\"nofollow noreferrer\">future</a>. Futures have existed in the Rust ecosystem for a long time before the special syntax was introduced, so even the syntax isn't required. However, it does make creating futures simpler.</p>\n\n<p>Futures are an abstraction of asynchronous work that are ultimately driven by an <em>executor</em>. One of the things that it's possible to put underneath the abstraction is an event-based IO library. The library notifies the executor that something has changed with one of the IO handles the library manages, which causes the executor to resume the future, which may realize that it's complete.</p>\n\n<p>Mio is used by some of the most common futures-related crates like <a href=\"https://crates.io/crates/tokio\" rel=\"nofollow noreferrer\">tokio</a> or <a href=\"https://crates.io/crates/async-std\" rel=\"nofollow noreferrer\">async-std</a>. The Mio documentation even suggests using it with futures:</p>\n\n<blockquote>\n  <p>This is a low level library, if you are looking for something easier to get started with, see Tokio.</p>\n</blockquote>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/52835725/155423\">What is the purpose of async/await in Rust?</a></li>\n</ul>\n"}], "owner": {"reputation": 10789, "user_id": 668963, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/46cf01443d69ee2e3034de2d77ae1732?s=128&d=identicon&r=PG", "display_name": "neevek", "link": "https://stackoverflow.com/users/668963/neevek"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 428, "favorite_count": 0, "accepted_answer_id": 58938400, "answer_count": 1, "score": 0, "last_activity_date": 1574213521, "creation_date": 1574177802, "last_edit_date": 1574213521, "question_id": 58937689, "link": "https://stackoverflow.com/questions/58937689/why-do-i-need-async-await-if-i-already-have-non-blocking-io-like-epoll-kqueu", "title": "Why do I need async / await if I already have non-blocking IO like epoll / kqueue / IOCP?", "body": "<p>I have experience with the non-blocking IO library <code>epoll</code> and its high level abstraction <code>libuv</code>, so when I started learning Rust, I looked for Rust equivalents and found Mio. Mio works the way I understand about non-blocking IO and is familiar to me. I can easily use this kind of API to build high performance server applications using several threads or even a single thread.</p>\n\n<p>Rust 1.39 brought the <code>async</code> / <code>await</code> syntax. I have read some articles and documentation on it and it feels like coroutines. I understand that <code>.await</code> can be used to yield CPU to do other things in the same thread, but there is no easy way to dynamically schedule code to run in that thread, it doesn't work in an evented way like <code>epoll</code>, with which I can register events in advance and get notified when those events happen. </p>\n\n<p>The example for <code>async</code> / <code>await</code> of opening and reading files doesn't make sense to me, because in that example after <code>.await</code> I have nothing to do but <strong>wait</strong> for the content to be available, so I am still blocking and not <em>async</em> at all.</p>\n\n<p>If I use non-blocking IO like Mio or <em>unsafe</em> <code>epoll</code>, do I still need <code>async</code> / <code>await</code>? If not, in what cases should I use <code>async</code> / <code>await</code>? </p>\n"}, {"tags": ["rust", "rust-macros", "rust-proc-macros"], "answers": [{"comments": [{"owner": {"reputation": 7630, "user_id": 709852, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/bf402f309d40d607a369395e32a984fc?s=128&d=identicon&r=PG", "display_name": "Henry Gomersall", "link": "https://stackoverflow.com/users/709852/henry-gomersall"}, "edited": false, "score": 0, "creation_date": 1574185583, "post_id": 58937864, "comment_id": 104138430, "body": "If the string is actually a string (say from a file) rather than a stream, you can do what you need using <code>syn::parse_str::&lt;syn::Ident&gt;(&quot;my_ident_str&quot;)?;</code>"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 6, "last_activity_date": 1574178706, "last_edit_date": 1574178706, "creation_date": 1574178267, "answer_id": 58937864, "question_id": 58937136, "link": "https://stackoverflow.com/questions/58937136/in-a-procedural-macro-how-can-i-check-if-a-string-is-a-valid-variable-name-and/58937864#58937864", "title": "In a procedural macro, how can I check if a string is a valid variable name and not a keyword?", "body": "<p>You can use <code>Ident::parse</code> from the <a href=\"https://crates.io/crates/syn\" rel=\"noreferrer\"><code>syn</code> crate</a>. It will fail if the input is a keyword:</p>\n\n<pre><code>use syn::{Ident, parse::Parse as _};\n\nlet ident = parse_stream.call(Ident::parse)?;\n</code></pre>\n\n<p>From the <a href=\"https://docs.rs/syn/1.0.8/syn/struct.Ident.html\" rel=\"noreferrer\">documentation</a>:</p>\n\n<blockquote>\n  <p>An identifier constructed with <code>Ident::new</code> is permitted to be a Rust keyword, though parsing one through its <code>Parse</code> implementation rejects Rust keywords.</p>\n</blockquote>\n"}], "owner": {"reputation": 7630, "user_id": 709852, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/bf402f309d40d607a369395e32a984fc?s=128&d=identicon&r=PG", "display_name": "Henry Gomersall", "link": "https://stackoverflow.com/users/709852/henry-gomersall"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 184, "favorite_count": 1, "accepted_answer_id": 58937864, "answer_count": 1, "score": 3, "last_activity_date": 1574187773, "creation_date": 1574176204, "last_edit_date": 1574187773, "question_id": 58937136, "link": "https://stackoverflow.com/questions/58937136/in-a-procedural-macro-how-can-i-check-if-a-string-is-a-valid-variable-name-and", "title": "In a procedural macro, how can I check if a string is a valid variable name and not a keyword?", "body": "<p>In a procedural macro, I wish to be able to check a string is a valid variable name and is not a keyword.</p>\n\n<p><code>proc_macro2::Ident</code> will panic if one tries to use an invalid variable name, but it will allow keywords which I do not want to be allowed. It would also be nicer to handle the error with a nice and useful error message before panicking.</p>\n\n<p>Is there some macro or function (in a crate or otherwise) that will check a string obeys the <a href=\"https://doc.rust-lang.org/beta/reference/identifiers.html\" rel=\"nofollow noreferrer\">rules about variable names</a>? I could probably do it with a regex, but dragons live in regexes.</p>\n\n<p>The use case for this is in handling user input strings, which may include garbage strings.</p>\n"}, {"tags": ["import", "rust"], "answers": [{"tags": [], "owner": {"reputation": 1608, "user_id": 1576254, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Jq33n.png?s=128&g=1", "display_name": "ikamen", "link": "https://stackoverflow.com/users/1576254/ikamen"}, "is_accepted": false, "score": 3, "last_activity_date": 1574176812, "last_edit_date": 1574176812, "creation_date": 1574172338, "answer_id": 58935891, "question_id": 58935890, "link": "https://stackoverflow.com/questions/58935890/how-to-import-from-a-file-in-a-subfolder-of-src/58935891#58935891", "title": "How to import from a file in a subfolder of src?", "body": "<p>Rust will recognize a subfolder of src as a module only if you add a <code>mod.rs</code> file to it. Add it to the sorting_algorithms folder:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>src\n  main.rs\n  sorting_algorithms\n    bubble.rs\n    mod.rs\n</code></pre>\n\n<p>The mod.rs file can expose a submodule of this folder: </p>\n\n<pre><code>pub mod bubble;\n</code></pre>\n\n<p>Assuming the function <code>bubble_sort</code> is declared public (<code>pub fn bubble_sort(...)</code>) you will be able to use it from main.rs:</p>\n\n<pre><code>mod sorting_algorithms;\npub use sorting_algorithms::bubble::bubble_sort;\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 99, "user_id": 3834585, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/466fbc00eeb00e3b65a90117ab2d1119?s=128&d=identicon&r=PG&f=1", "display_name": "Lucassith", "link": "https://stackoverflow.com/users/3834585/lucassith"}, "edited": false, "score": 0, "creation_date": 1588187735, "post_id": 58936090, "comment_id": 108807361, "body": "Using the second method... how do you import it to the main.rs?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 99, "user_id": 3834585, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/466fbc00eeb00e3b65a90117ab2d1119?s=128&d=identicon&r=PG&f=1", "display_name": "Lucassith", "link": "https://stackoverflow.com/users/3834585/lucassith"}, "edited": false, "score": 0, "creation_date": 1588188340, "post_id": 58936090, "comment_id": 108807654, "body": "@Lucassith There is no difference between the 3 methods: either you use the full name <code>sorting_algorithms::bubble::sort</code> or you import it in scope: <code>use sorting_algorithms::bubble::sort;</code> and then you can use <code>sort</code> directly."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 8, "last_activity_date": 1574178846, "last_edit_date": 1574178846, "creation_date": 1574172960, "answer_id": 58936090, "question_id": 58935890, "link": "https://stackoverflow.com/questions/58935890/how-to-import-from-a-file-in-a-subfolder-of-src/58936090#58936090", "title": "How to import from a file in a subfolder of src?", "body": "<p>The subfolder must be declared as a module. You can do that using 3 different ways:</p>\n\n<ul>\n<li><p>Inline: declare the <code>sorting_algorithms</code> module inside your <code>main.rs</code>:</p>\n\n<pre><code>// In main.rs:\n\nmod sorting_algorithms {\n    pub mod bubble;\n}\n</code></pre>\n\n<p>This is the simplest in my opinion.</p></li>\n<li><p>Put a <code>sorting_algorithms.rs</code> into the <code>src</code> folder, with the module declaration:</p>\n\n<pre><code>// In sorting_algorithms.rs:\n\npub mod bubble;\n</code></pre></li>\n<li><p>Put a <code>mod.rs</code> file with the above content into the subfolder. This is more or less deprecated.</p></li>\n</ul>\n"}], "owner": {"reputation": 1608, "user_id": 1576254, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Jq33n.png?s=128&g=1", "display_name": "ikamen", "link": "https://stackoverflow.com/users/1576254/ikamen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1236, "favorite_count": 0, "accepted_answer_id": 58936090, "answer_count": 2, "score": 5, "last_activity_date": 1574178846, "creation_date": 1574172338, "last_edit_date": 1574176666, "question_id": 58935890, "link": "https://stackoverflow.com/questions/58935890/how-to-import-from-a-file-in-a-subfolder-of-src", "title": "How to import from a file in a subfolder of src?", "body": "<p>I want to split my code into multiple subdirectories of src. Example:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>src\n  main.rs\n  sorting_algorithms\n    bubble.rs\n</code></pre>\n\n<p>bubble.rs contains a function <code>bubble_sort</code>; how do I import it to the main.rs?</p>\n"}, {"tags": ["rust", "compiler-construction"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574177409, "post_id": 58932599, "comment_id": 104133668, "body": "that what you get if you just copy past cpp code :p I never had 50 errors in rust"}, {"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574190974, "post_id": 58932599, "comment_id": 104141111, "body": "@Stargateur I believe my project is mid-size, with a couple of thousands LOC, so maybe that&#39;s why."}], "answers": [{"comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1574182897, "post_id": 58932778, "comment_id": 104137108, "body": "Also, it seems that point 1 is divided into 1a: match opening and closing delimiters <code>() {} []</code>) ; and 1b: parse."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 3, "creation_date": 1574186897, "post_id": 58932778, "comment_id": 104139086, "body": "@rodrigo The division is likely between lexing and  parsing. Usually a lexer/tokenizer will keep track of matching delimiters, but also will reject invalid tokens, like <code>0_foo</code>."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 6, "last_activity_date": 1574162308, "last_edit_date": 1574162308, "creation_date": 1574162091, "answer_id": 58932778, "question_id": 58932599, "link": "https://stackoverflow.com/questions/58932599/is-there-some-sort-of-sequence-in-which-the-compiler-operates/58932778#58932778", "title": "Is there some sort of sequence in which the compiler operates?", "body": "<p>Yes, there is an order:</p>\n\n<ol>\n<li>Syntax errors, from parsing the source code</li>\n<li>Non-lifetime type errors, from the type checker</li>\n<li>Lifetime errors, from the borrow checker</li>\n</ol>\n\n<p>The first two are common to most typed languages. You need to build some kind of model of the type relationships before checking them, which will fail fast if the syntax is incorrect. In Rust, a subsequent step is to verify that all borrows are valid, once the basic type check has passed.</p>\n\n<p>You can read more in the blog post, <a href=\"https://blog.rust-lang.org/2016/04/19/MIR.html\" rel=\"noreferrer\">Introducing MIR\n</a>.</p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 94, "favorite_count": 0, "accepted_answer_id": 58932778, "answer_count": 1, "score": 3, "last_activity_date": 1574162308, "creation_date": 1574161561, "last_edit_date": 1574161973, "question_id": 58932599, "link": "https://stackoverflow.com/questions/58932599/is-there-some-sort-of-sequence-in-which-the-compiler-operates", "title": "Is there some sort of sequence in which the compiler operates?", "body": "<p>I am rewriting a C++ program to Rust, and there is one thing that gives me an emotional rollercoaster. At first iteration it gives me, say 50 errors, then I solve them one by one, and just when I solve the last one, the compiler gives me 60 fresh errors, then I solve them and get another few tens of errors. </p>\n\n<p>The last (yet) set of errors seems to be generated exclusively by the borrow checker. So why does this happen? Are there some layers or stages of the compiling process, and if yes what are they?</p>\n\n<p>I want to know that, because I like predictability and dislike emotional rollercoasters (also I want to know when this adventure is going to end).</p>\n"}, {"tags": ["reference", "rust", "terminology"], "answers": [{"comments": [{"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "edited": false, "score": 0, "creation_date": 1574154535, "post_id": 58929277, "comment_id": 104120307, "body": "Thanks! That&#39;s almost exactly the answer I received in the Rust discord chat. The only difference, they called <code>exclusive</code> what you call <code>unique</code>. But these fairly are just synonyms. Also, thanks for the link to a great article!"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "edited": false, "score": 1, "creation_date": 1574253830, "post_id": 58929277, "comment_id": 104164999, "body": "@NurbolAlpysbayev: In the year prior to 1.0, there was actually an impetus to rename <code>&amp;mut</code> to <code>&amp;uniq</code> to emphasize that given the existence of internal mutability what mattered was shared vs unique/exclusive, and that immutable/mutable were misnomers. It was rejected because although pedantically correct, it seemed easier to teach immutable/mutable at the beginning, and people would just discover the actual nitty gritty reality if they stuck with the language. I guess it means you&#39;ve passed the beginner stage, congratz!"}, {"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 2, "creation_date": 1574281996, "post_id": 58929277, "comment_id": 104180926, "body": "@MatthieuM. Thank you for the insight, that was entertaining to read. I am glad that they&#39;ve made this decision, because <code>uniq</code> would make me, a beginner, cringed and confused. Oh and good to head that I am no longer a beginner, it feels like I&#39;ve passed some initiation procedure :D"}], "tags": [], "owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "is_accepted": true, "score": 6, "last_activity_date": 1574152085, "last_edit_date": 1574152085, "creation_date": 1574150900, "answer_id": 58929277, "question_id": 58929127, "link": "https://stackoverflow.com/questions/58929127/why-is-a-reference-called-shared/58929277#58929277", "title": "Why is a reference called &quot;shared&quot;?", "body": "<p>This is another way to distinguish mutable and immutable references.</p>\n\n<p>In Rust, there is a clear distinction: the data can be <em>either</em> sharable (even if they're not shared currently), <em>or</em> directly mutable, <strong>but not both at once</strong>. This is achieved by having two types of references:</p>\n\n<ul>\n<li><em>shared</em>, or <em>immutable</em> ones, which can be copied but cannot be used to directly mutate data;</li>\n<li><em>unique</em>, or <em>mutable</em> ones, which cannot be copied (and this is UB, if you do this somehow), but can be used to mutate the data.</li>\n</ul>\n\n<p>Note the \"directly mutable\" bit. Of course, it's <em>sometimes</em> possible to modify data through shared reference - if the data itself allows it; this is so-called <em>internal mutability</em>, based on multiple types like <code>Cell</code> or <code>Mutex</code>, which all internally use <code>UnsafeCell</code> - the only type explicitly allowed to be mutated behind shared reference.</p>\n\n<p>More info might be found here: <a href=\"https://limpet.net/mbrubeck/2019/02/07/rust-a-unique-perspective.html\" rel=\"noreferrer\">https://limpet.net/mbrubeck/2019/02/07/rust-a-unique-perspective.html</a></p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 117, "favorite_count": 0, "accepted_answer_id": 58929277, "answer_count": 1, "score": 3, "last_activity_date": 1574176101, "creation_date": 1574150312, "last_edit_date": 1574176101, "question_id": 58929127, "link": "https://stackoverflow.com/questions/58929127/why-is-a-reference-called-shared", "title": "Why is a reference called &quot;shared&quot;?", "body": "<p>This is my minimal reproducible code (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ef2911c44ac19810b1bba0d4b0bf856d\" rel=\"nofollow noreferrer\">playground</a>):</p>\n\n<pre><code>struct MyStruct {\n    my_string: String,\n}\n\nfn accepts_string(my_string: String) {\n    println!(\"my_string: {}\", my_string)\n}\n\nfn accepts_struct_reference(my_struct: &amp;MyStruct) {\n    accepts_string(my_struct.my_string);\n}\n\nfn main() {\n    let my_struct = MyStruct {\n        my_string: String::from(\"hi\"),\n    };\n    accepts_struct_reference(&amp;my_struct);\n}\n</code></pre>\n\n<p>which produces:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of `my_struct.my_string` which is behind a shared reference\n  --&gt; src/main.rs:10:20\n   |\n10 |     accepts_string(my_struct.my_string);\n   |                    ^^^^^^^^^^^^^^^^^^^ move occurs because `my_struct.my_string` has type `std::string::String`, which does not implement the `Copy` trait\n</code></pre>\n\n<p>I believe I understand why this error occurs: <code>accepts_string</code> tries to take the string away from the struct.</p>\n\n<p>Why is that reference called a <code>shared</code> reference? Shared with whom? Does that adjective mean that there are non-shared references? If yes, what do they look like?</p>\n"}, {"tags": ["rust", "rust-crates", "rust-piston"], "answers": [{"tags": [], "owner": {"reputation": 77, "user_id": 1774187, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/da9c819a8d18fce9dd47c35e7885eec6?s=128&d=identicon&r=PG&f=1", "display_name": "anvlkv", "link": "https://stackoverflow.com/users/1774187/anvlkv"}, "is_accepted": false, "score": 0, "last_activity_date": 1607629606, "creation_date": 1607629606, "answer_id": 65241307, "question_id": 58926592, "link": "https://stackoverflow.com/questions/58926592/how-to-create-a-fullscreen-window-using-piston/65241307#65241307", "title": "How to create a fullscreen window using piston?", "body": "<p>Seems you can do</p>\n<pre><code>    let mut window: Window = WindowSettings::new(&quot;spinning-square&quot;, [200, 200])\n        .graphics_api(opengl)\n        .exit_on_esc(true)\n        .fullscreen(true)\n        .build()\n        .unwrap();\n\n    let monitor_id = window.ctx.window().get_current_monitor();\n    let size = monitor_id.get_dimensions(); // this looks platform dependent\n</code></pre>\n<p>funnily I was looking for it for the exact same purpose &quot;the game of life&quot;</p>\n"}], "owner": {"reputation": 31, "user_id": 12388983, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/a-/AAuE7mDs5npAi9a69iUOgyN0GQtsgeAe-3t5-NosxOHwVw=k-s128", "display_name": "Jimmy Hypi", "link": "https://stackoverflow.com/users/12388983/jimmy-hypi"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 220, "favorite_count": 0, "answer_count": 1, "score": 3, "last_activity_date": 1607629606, "creation_date": 1574137153, "last_edit_date": 1574175913, "question_id": 58926592, "link": "https://stackoverflow.com/questions/58926592/how-to-create-a-fullscreen-window-using-piston", "title": "How to create a fullscreen window using piston?", "body": "<p>I was trying to create an application that opens a full-screen window using the piston crate. </p>\n\n<p>How can I retrieve the physical screen size in pixels programmatically? It seems an easy thing to do, but I was not able to figure that out. </p>\n\n<pre><code>extern crate piston;\nextern crate glutin_window;\nextern crate graphics;\nextern crate opengl_graphics;\n\nuse piston::window::WindowSettings;\nuse piston::event_loop::{Events, EventLoop, EventSettings};\nuse piston::input::RenderEvent;\nuse glutin_window::GlutinWindow;\nuse opengl_graphics::{OpenGL, GlGraphics};\n\nfn main() {\n     let opengl = OpenGL::V3_2;\n    // Is there any way to retrieve the screen size programmatically and not to hard code it?\n    let (screen_width, screen_height) = (1920, 1080);\n    let settings = WindowSettings::new(\"The Game Of Life\", [screen_width, screen_height])\n        .graphics_api(opengl)\n        .fullscreen(true)\n        .exit_on_esc(true);\n\n    let mut window: GlutinWindow = settings.build()\n        .expect(\"Could not create window\");\n\n    let mut events = Events::new(EventSettings::new().lazy(true));\n    let mut gl = GlGraphics::new(opengl);\n\n    while let Some(e) = events.next(&amp;mut window) {\n        if let Some(args) = e.render_args() {\n            gl.draw(args.viewport(), |c, g| {\n                use graphics::{clear};\n\n                clear([1.0; 4], g);\n                //DO STUFF HERE\n            });\n        }\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "iterator"], "comments": [{"owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "edited": false, "score": 0, "creation_date": 1574137562, "post_id": 58926347, "comment_id": 104114145, "body": "Looks like there is no better method, since you can&#39;t get the last char number without calling <code>count</code> (explicitly of implicitly)."}], "answers": [{"comments": [{"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "edited": false, "score": 0, "creation_date": 1574149080, "post_id": 58928624, "comment_id": 104117784, "body": "Thank you. Yep, I&#39;ve encountered an error that said <code>ExactSizeIterator</code> is not implemented or something when I tried <code>s.chars().enumerate().rev()</code>. Thanks for the explanation, it was entertaining and eyes-opening about the core reason!"}], "tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 5, "last_activity_date": 1574175814, "last_edit_date": 1574175814, "creation_date": 1574148256, "answer_id": 58928624, "question_id": 58926347, "link": "https://stackoverflow.com/questions/58926347/how-do-i-get-the-index-from-the-beginning-in-a-reversed-iterator-of-chars-of-a-s/58928624#58928624", "title": "How do I get the index from the beginning in a reversed iterator of chars of a string?", "body": "<p>This is complicated, as they say. If your string is ASCII only, you can do the obvious enumeration then reverse against a <code>String</code>'s byte iterator:</p>\n\n<pre><code>fn main() {\n    let s = String::from(\"hi\");\n\n    for (idx, ch) in s.bytes().enumerate().rev() {\n        println!(\"{} {}\", idx, ch as char);\n    }\n}\n</code></pre>\n\n<p>This doesn't work for Unicode strings in general because of what a <a href=\"https://doc.rust-lang.org/stable/std/char/index.html\" rel=\"nofollow noreferrer\"><code>char</code></a> in Rust stands for:</p>\n\n<blockquote>\n  <p>The <code>char</code> type represents a single character. More specifically, since 'character' isn't a well-defined concept in Unicode, char is a <a href=\"http://www.unicode.org/glossary/#unicode_scalar_value\" rel=\"nofollow noreferrer\">'Unicode scalar value'</a>, which is similar to, but not the same as, a <a href=\"http://www.unicode.org/glossary/#code_point\" rel=\"nofollow noreferrer\">'Unicode code point'</a>.</p>\n</blockquote>\n\n<p>This can be illustrated by the following:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let s = String::from(\"y\u0306\");\n\n    println!(\"{}\", s.len());\n    for (idx, ch) in s.bytes().enumerate() {\n        println!(\"{} {}\", idx, ch);\n    }\n\n    for (idx, ch) in s.chars().enumerate() {\n        println!(\"{} {}\", idx, ch);\n    }\n}\n</code></pre>\n\n<p>This weird looking string has length of 3, as in 3 <code>u8</code>s. At the same time it has 2 <code>char</code>s. So <code>ExactSizeIterator</code> can't be trivially implemented for <code>std::str::Chars</code>, but it can and does be implemented for <code>std::str::Bytes</code>. This is significant because to reverse a given iterator, it has to be <code>DoubleEndedIterator</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn rev(self) -&gt; Rev&lt;Self&gt;\nwhere\n    Self: DoubleEndedIterator,\n</code></pre>\n\n<p>But <code>DoubleEndedIterator</code> is only available for enumeration iterator if the underlying iterator is also <code>ExactSizeIterator</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;I&gt; DoubleEndedIterator for Enumerate&lt;I&gt;\nwhere\n    I: ExactSizeIterator + DoubleEndedIterator,\n</code></pre>\n\n<p>In conclusion, you can only do <code>s.bytes().enumerate().rev()</code>, but not <code>s.chars().enumerate().rev()</code>. If you absolutely have to index the enumerated char iterator of a <code>String</code> that way, you are on your own.</p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 83, "favorite_count": 0, "accepted_answer_id": 58928624, "answer_count": 1, "score": 4, "last_activity_date": 1574175814, "creation_date": 1574135312, "last_edit_date": 1574175715, "question_id": 58926347, "link": "https://stackoverflow.com/questions/58926347/how-do-i-get-the-index-from-the-beginning-in-a-reversed-iterator-of-chars-of-a-s", "title": "How do I get the index from the beginning in a reversed iterator of chars of a string?", "body": "<p>This code: </p>\n\n<pre><code>let s = String::from(\"hi\");\n\nfor (idx, ch) in s.chars().rev().enumerate() {\n    println!(\"{} {}\", idx, ch);\n}\n</code></pre>\n\n<p>prints</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>0 i\n1 h\n</code></pre>\n\n<p>but I want to know the real index, so that it would print:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>1 i\n0 h\n</code></pre>\n\n<p>What's the best way to do that? Currently I only think of first getting <code>.count()</code> and subtracting each <code>idx</code> from it, but maybe there's a better method that I overlooked.</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574175607, "post_id": 58926651, "comment_id": 104132506, "body": "Please search for existing questions with the answer you propose before answering. There&#39;s no need to duplicate this kind of common question and answer many times across Stack Overflow."}], "tags": [], "owner": {"reputation": 95188, "user_id": 440119, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/5ec9ca2a92a94a5470396073129d79e7?s=128&d=identicon&r=PG", "display_name": "Benjamin Lindley", "link": "https://stackoverflow.com/users/440119/benjamin-lindley"}, "is_accepted": false, "score": 1, "last_activity_date": 1574137697, "creation_date": 1574137697, "answer_id": 58926651, "question_id": 58926335, "link": "https://stackoverflow.com/questions/58926335/modify-multiple-elements-of-a-slice-collection-at-the-same-time/58926651#58926651", "title": "Modify multiple elements of a slice/collection at the same time", "body": "<p>You can use <a href=\"https://doc.rust-lang.org/stable/std/primitive.slice.html#method.split_at_mut\" rel=\"nofollow noreferrer\"><code>split_at_mut</code></a> to get two disjoint mutable partitions of a slice. So you could do this:</p>\n\n<pre><code>let (a,b) = foo.split_at_mut(i);\nlet a = a.last_mut().unwrap();\nlet b = b.first_mut().unwrap();\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574175605, "post_id": 58926690, "comment_id": 104132502, "body": "Please search for existing questions with the answer you propose before answering. There&#39;s no need to duplicate this kind of common question and answer many times across Stack Overflow."}], "tags": [], "owner": {"reputation": 7716, "user_id": 4639273, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ae38603d40c633012992337a32330fa0?s=128&d=identicon&r=PG", "display_name": "SCappella", "link": "https://stackoverflow.com/users/4639273/scappella"}, "is_accepted": true, "score": 2, "last_activity_date": 1574138041, "creation_date": 1574138041, "answer_id": 58926690, "question_id": 58926335, "link": "https://stackoverflow.com/questions/58926335/modify-multiple-elements-of-a-slice-collection-at-the-same-time/58926690#58926690", "title": "Modify multiple elements of a slice/collection at the same time", "body": "<p>In general, this kind of mutation of different parts of a single object at the same time requires <code>unsafe</code>. There really isn't a general way for the compiler to tell that you're really accessing <em>disjoint</em> parts of the object.</p>\n\n<p>However, in this case, there's a simple encapsulation that should work for your usage. The slice method <a href=\"https://doc.rust-lang.org/stable/std/primitive.slice.html#method.split_at_mut\" rel=\"nofollow noreferrer\"><code>split_at_mut</code></a> enables you to get mutable slices of two halves of a mutable slice.</p>\n\n<pre><code>let mut foo = vec![\n    vec![1, 2, 3],\n    vec![4, 5, 6],\n    vec![7, 8, 9],\n];\n\nfor i in 1..foo.len() {\n    //   ^^^  note the change\n    let (first_half, second_half) = foo.split_at_mut(i);\n\n    // now `first_half` is `foo[0..i]`\n    // `second_half` is `foo[i..]`\n    let a = first_half.last_mut().unwrap();\n    let b = second_half.first_mut().unwrap();\n\n    let val = 2; // Some computation based on contents of a &amp; b\n\n    a.push(val);\n    b.insert(0, val);\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4f4d96d2537de9e963a291da6a82f806\" rel=\"nofollow noreferrer\">(playground)</a></p>\n\n<p>You may be able to avoid this completely by holding off on the mutable borrow until you actually mutate the vectors.</p>\n\n<pre><code>let mut foo = vec![\n    vec![1, 2, 3],\n    vec![4, 5, 6],\n    vec![7, 8, 9],\n];\n\nfor i in 1..foo.len() {\n    // this could equally be written\n    // let a = &amp;foo[i - 1];\n    let a = foo.get(i - 1).unwrap();\n    let b = foo.get(i).unwrap();\n\n    // This probably doesn't need mutable access, right?\n    let val = 2; // Some computation based on contents of a &amp; b\n\n    // now borrow again, but this time mutate.\n    foo[i - 1].push(val);\n    foo[i].insert(0, val);\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d5d3444bbf995f975dfb7fcd553a0a32\" rel=\"nofollow noreferrer\">(playground)</a></p>\n"}], "owner": {"reputation": 48, "user_id": 6771942, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a25fc1f636fcab39ddc150ffae34b7c1?s=128&d=identicon&r=PG&f=1", "display_name": "avandesa", "link": "https://stackoverflow.com/users/6771942/avandesa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 47, "favorite_count": 0, "closed_date": 1574175535, "accepted_answer_id": 58926690, "answer_count": 2, "score": 0, "last_activity_date": 1574138041, "creation_date": 1574135221, "question_id": 58926335, "link": "https://stackoverflow.com/questions/58926335/modify-multiple-elements-of-a-slice-collection-at-the-same-time", "closed_reason": "Duplicate", "title": "Modify multiple elements of a slice/collection at the same time", "body": "<p>I have a <code>Vec&lt;Vec&lt;T&gt;&gt;</code> (I know it's not ideal; it's from a library). I want to look at pairs of <code>Vec</code>s in the outer vec and push to each of them, something like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut foo = vec![\n    vec![1, 2, 3],\n    vec![4, 5, 6],\n    vec![7, 8, 9],\n];\n\nfor i in foo.len() {\n    let a = foo.get_mut(i - 1).unwrap();\n    let b = foo.get_mut(i).unwrap(); // Does not work\n\n    let val = 2; // Some computation based on contents of a &amp; b\n\n    a.push(val);\n    b.insert(0, val);\n}\n</code></pre>\n\n<p>Of course, this fails to compile:</p>\n\n<pre><code>error[E0499]: cannot borrow `foo` as mutable more than once at a time\n  --&gt; foo.rs:6:17\n   |\n5  |         let a = foo.get_mut(i - 1).unwrap();\n   |                 --- first mutable borrow occurs here\n6  |         let b = foo.get_mut(i).unwrap(); // Does not work\n   |                 ^^^ second mutable borrow occurs here\n...\n10 |         a.push(val);\n   |         - first borrow later used here\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0499`.\n</code></pre>\n\n<p>It's a similar pattern to the <code>std::slice::window()</code> method, but as far as I can tell you can't get <em>any</em> mutable items in that.</p>\n\n<p>Is there a way to do this that makes the borrow checker happy?</p>\n"}, {"tags": ["rust", "macros"], "answers": [{"comments": [{"owner": {"reputation": 32098, "user_id": 124319, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/lVhrR.jpg?s=128&g=1", "display_name": "coredump", "link": "https://stackoverflow.com/users/124319/coredump"}, "edited": false, "score": 0, "creation_date": 1574155839, "post_id": 58930490, "comment_id": 104120994, "body": "The intermediate syntax tree might be bigger (not necessarily), but I am not sure there is a general way to know how that impacts the binary, given how compilers work. A macro that expresses list comprehensions might expands as an optimized loop, etc. I agree about staying away from macros when possible."}, {"owner": {"reputation": 4182, "user_id": 2992101, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7363e9ce46406af3326492e2f6cf40ca?s=128&d=identicon&r=PG", "display_name": "michalsrb", "link": "https://stackoverflow.com/users/2992101/michalsrb"}, "reply_to_user": {"reputation": 32098, "user_id": 124319, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/lVhrR.jpg?s=128&g=1", "display_name": "coredump", "link": "https://stackoverflow.com/users/124319/coredump"}, "edited": false, "score": 1, "creation_date": 1574156043, "post_id": 58930490, "comment_id": 104121104, "body": "True, I have modified the answer to be less definitive."}], "tags": [], "owner": {"reputation": 4182, "user_id": 2992101, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7363e9ce46406af3326492e2f6cf40ca?s=128&d=identicon&r=PG", "display_name": "michalsrb", "link": "https://stackoverflow.com/users/2992101/michalsrb"}, "is_accepted": true, "score": 2, "last_activity_date": 1574155997, "last_edit_date": 1574155997, "creation_date": 1574155276, "answer_id": 58930490, "question_id": 58925979, "link": "https://stackoverflow.com/questions/58925979/does-using-macros-instead-of-functions-make-the-binary-bigger/58930490#58930490", "title": "Does using macros instead of functions make the binary bigger?", "body": "<p>Probably yes, using macros instead of functions may make the binary bigger. But it depends on how your specific case compiles.</p>\n\n<p>Macros are expanded before the compilation proceeds, so the result is like if you copied the code into every function where the macro is used. It is unlikely that the compiler can extract those pieces of code to some common place.</p>\n\n<p>Functions usually exist only in one place and calling them jumps into that place. However, functions may get expanded (inlined) the same way as macros. But that happens only if the compiler decides that it is beneficial, or if you annotate the function with <code>#[inline(always)]</code>.</p>\n\n<p>In general if you can achieve what you need with both function and macro, use function. Macros are useful for special cases that can not be achieved by functions. (Like creating custom syntax, or getting the line number of the call site...)</p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 87, "favorite_count": 0, "accepted_answer_id": 58930490, "answer_count": 1, "score": 1, "last_activity_date": 1574176187, "creation_date": 1574132178, "last_edit_date": 1574176187, "question_id": 58925979, "link": "https://stackoverflow.com/questions/58925979/does-using-macros-instead-of-functions-make-the-binary-bigger", "title": "Does using macros instead of functions make the binary bigger?", "body": "<p>Will using macros result in having more machine instructions (and hence, the binary size) than using functions? I am asking because one of my macros that I use a lot became quite large so I started worrying. I have an impression that macros are copy-pasted as many times as I use them. Is that true?</p>\n\n<p>I could test that myself, but it's a bit troublesome, also I wanted to hear what informed people would say. I am an absolute layman when it comes to assembly language, machine instructions and the like, so sorry if I wrote something stupid.</p>\n"}, {"tags": ["rust", "locking", "mutex", "rwlock"], "comments": [{"owner": {"reputation": 209014, "user_id": 125816, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/7f5aa40b1e7a95599c7a19451f88ff3a?s=128&d=identicon&r=PG", "display_name": "Sergio Tulentsev", "link": "https://stackoverflow.com/users/125816/sergio-tulentsev"}, "edited": false, "score": 0, "creation_date": 1574112724, "post_id": 58923187, "comment_id": 104107869, "body": "What are you locking, the struct itself? Or something else?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574113023, "post_id": 58923187, "comment_id": 104107994, "body": "It&#39;s possible that we&#39;d better understand your question if you include a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. It would make it easier for us to help you if you reproduce your situation on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> if possible, otherwise in a brand new Cargo project, then <a href=\"https://stackoverflow.com/posts/58923187/edit\">edit</a> your question to include the additional info. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MRE tips</a> you can use to reduce your original code for posting here. Thanks!"}, {"owner": {"reputation": 19, "user_id": 12086666, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-Qum7eroTq2E/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdp8EdVV7FAlxCf_EUOeFwern_3KQ/photo.jpg?sz=128", "display_name": "mm mm", "link": "https://stackoverflow.com/users/12086666/mm-mm"}, "edited": false, "score": 0, "creation_date": 1574113123, "post_id": 58923187, "comment_id": 104108032, "body": "Yes, I&#39;m locking a struct. I know, but I want to check number of readers. I know, that read locks are used for reading values"}], "owner": {"reputation": 19, "user_id": 12086666, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-Qum7eroTq2E/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdp8EdVV7FAlxCf_EUOeFwern_3KQ/photo.jpg?sz=128", "display_name": "mm mm", "link": "https://stackoverflow.com/users/12086666/mm-mm"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 59, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1574112934, "creation_date": 1574112580, "last_edit_date": 1574112934, "question_id": 58923187, "link": "https://stackoverflow.com/questions/58923187/how-do-i-modify-something-inside-a-read-lock", "title": "How do I modify something inside a read lock?", "body": "<p>I have a struct that contains two fields: the number of readers and the number of writers. When I use a write lock, I modify the writers value, and print both of them. When I use read lock, I would like to modify the number of readers and then print both values. Can I do something like that? Or is there another way to do it, such as some kind of a counter with a mutex?</p>\n"}, {"tags": ["rust", "iterator"], "comments": [{"owner": {"reputation": 6137, "user_id": 847382, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/b73e2fff665c33621c8a4347cf8074be?s=128&d=identicon&r=PG", "display_name": "PitaJ", "link": "https://stackoverflow.com/users/847382/pitaj"}, "edited": false, "score": 1, "creation_date": 1574117729, "post_id": 58922744, "comment_id": 104109780, "body": "Can you give an example of what you&#39;re doing that requires chunking? You may be able to just use a straight-up <code>for</code> loop over <code>v</code> instead, pausing every 42 elements."}], "answers": [{"comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1574115393, "post_id": 58923094, "comment_id": 104108876, "body": "You can also write <code>let value = value.as_ref().map_err(SomeError::clone)?</code> (adding a <code>derive(Clone)</code> for the <code>SomeError</code>) and clone only in the case of error."}, {"owner": {"reputation": 14545, "user_id": 42188, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/0b0abbefc6a9375882ea3cc0c6da61c8?s=128&d=identicon&r=PG", "display_name": "muhuk", "link": "https://stackoverflow.com/users/42188/muhuk"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574147704, "post_id": 58923094, "comment_id": 104117195, "body": "@Shepmaster you are right, if <code>to_vec</code> is used <code>SomeError</code> also needs to be cloneable.  Thanks.  I updated the answer."}], "tags": [], "owner": {"reputation": 14545, "user_id": 42188, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/0b0abbefc6a9375882ea3cc0c6da61c8?s=128&d=identicon&r=PG", "display_name": "muhuk", "link": "https://stackoverflow.com/users/42188/muhuk"}, "is_accepted": false, "score": 1, "last_activity_date": 1574147651, "last_edit_date": 1574147651, "creation_date": 1574112080, "answer_id": 58923094, "question_id": 58922744, "link": "https://stackoverflow.com/questions/58922744/how-can-i-use-the-question-mark-operator-while-iterating-over-references-to-resu/58923094#58923094", "title": "How can I use the question mark operator while iterating over references to Result?", "body": "<h2>Understanding the Error</h2>\n\n<p>Here is the signature of <code>Vec::chunks</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn chunks(&amp;self, chunk_size: usize) -&gt; Chunks&lt;T&gt;\n</code></pre>\n\n<p>Notice <code>&amp;self</code>, because the <code>Chunks&lt;T&gt;</code> returned has an iterator of type <code>Item = &amp;'a [T]</code>.  When you iterate over this slice (each chunks is a slice) you get a reference to a <code>T</code>.  Hence the error the compiler gives:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>the trait `std::ops::Try` is not implemented for `&amp;std::result::Result&lt;SomeStruct, SomeError&gt;`\n</code></pre>\n\n<p>Basically this is saying <code>Try</code> is not implemented for <code>&amp;Result&lt;SomeStruct&gt;</code>.</p>\n\n<h2>Solution</h2>\n\n<p>I don't think it is not possible to take ownership of a reference of a slice (without copying).</p>\n\n<h3>Copy to a <code>Vec</code>:</h3>\n\n<p>You can use <code>to_vec</code> on the slice (chunk) provided that <code>SomeStruct</code> &amp; <code>SomeError</code> implement <code>Clone</code>.</p>\n\n<h3>Use <code>SomeStruct</code> as a reference:</h3>\n\n<p>Since your code returns <code>Ok(())</code>, you might be able to use a <code>&amp;SomeStruct</code> in <code>//do smth with value</code>.  In fact this is a common, and very useful pattern in Rust:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn do_something_with_value(v: &amp;SomeStruct) {\n    unimplemented!();\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1574194223, "last_edit_date": 1574194223, "creation_date": 1574175368, "answer_id": 58936829, "question_id": 58922744, "link": "https://stackoverflow.com/questions/58922744/how-can-i-use-the-question-mark-operator-while-iterating-over-references-to-resu/58936829#58936829", "title": "How can I use the question mark operator while iterating over references to Result?", "body": "<h1>General case</h1>\n\n<p>Your function signature requires that you return an <em>owned</em> <code>SomeError</code>, but all you have is a reference to one. Unless you have <em>some</em> way of converting a <code>&amp;SomeError</code> into a <code>SomeError</code>, this problem is unsolvable.</p>\n\n<p>The most applicable solution is to change your error to be clonable (or copyable, if appropriate) and then convert your <code>&amp;Result&lt;T, E&gt;</code> into a <code>Result&lt;&amp;T, E&gt;</code> via <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.as_ref\" rel=\"nofollow noreferrer\"><code>Result::as_ref</code></a> and <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.map_err\" rel=\"nofollow noreferrer\"><code>Result::map_err</code></a>:</p>\n\n<pre><code>#[derive(Debug, Clone)]\nstruct SomeError {}\n</code></pre>\n\n<pre><code>for value in chunk {\n    let value = value.as_ref().map_err(Clone::clone)?;\n    // do something with `value`\n}\n</code></pre>\n\n<p>Also possible, but far less common, would be to return a <em>reference</em> to the error. This requires that the error lives longer than the call to the function:</p>\n\n<pre><code>type Result&lt;T, E = SomeError&gt; = std::result::Result&lt;T, E&gt;;\n\nfn foo(v: &amp;[Result&lt;SomeStruct&gt;]) -&gt; Result&lt;(), &amp;SomeError&gt; {\n    for chunk in v.chunks(42) {\n        for value in chunk {\n            let value = value.as_ref()?;\n            // do something with `value`\n        }\n    }\n    Ok(())\n}\n\nfn main() {\n    let values = Vec::new();\n    foo(&amp;values).unwrap();\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/22282117/155423\">How do I borrow a reference to what is inside an Option&lt;T&gt;?</a></li>\n<li><a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a></li>\n</ul>\n\n<h1>Specific case</h1>\n\n<p>Since you take ownership of the <code>Vec</code> and don't make use of the fact that the inner iterator is a slice, you don't need to have a <code>&amp;Result</code> to start with. Instead, convert the <code>Vec</code> into an iterator and <code>take</code> chunk-length pieces of it: </p>\n\n<pre><code>fn foo(v: Vec&lt;Result&lt;SomeStruct&gt;&gt;) -&gt; Result&lt;()&gt; {\n    let mut v = v.into_iter().peekable();\n\n    while v.peek().is_some() {\n        for value in v.by_ref().take(42) {\n            let _value = value?;\n            // do something with `value`\n        }\n    }\n\n    Ok(())\n}\n</code></pre>\n\n<p>You can also use <a href=\"https://docs.rs/itertools/0.8.1/itertools/trait.Itertools.html#method.chunks\" rel=\"nofollow noreferrer\"><code>Itertools::chunks</code></a>:</p>\n\n<pre><code>use itertools::Itertools; // 0.8.1\n\nfn foo(v: Vec&lt;Result&lt;SomeStruct&gt;&gt;) -&gt; Result&lt;()&gt; {\n    for chunk in &amp;v.into_iter().chunks(42) {\n        for value in chunk {\n            let value = value?;\n            // do something with `value`\n        }\n    }\n    Ok(())\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/45761364/155423\">What is the canonical way to implement is_empty for Iterator?</a></li>\n<li><a href=\"https://stackoverflow.com/q/42134874/155423\">Are there equivalents to slice::chunks/windows for iterators to loop over pairs, triplets etc?</a></li>\n<li><a href=\"https://stackoverflow.com/q/46867355/155423\">Is it possible to split a vector into groups of 10 with iterators?</a></li>\n</ul>\n"}], "owner": {"reputation": 584, "user_id": 6121268, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f445cd88162e1194f4962fd22a073923?s=128&d=identicon&r=PG&f=1", "display_name": "NikBond", "link": "https://stackoverflow.com/users/6121268/nikbond"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 493, "favorite_count": 0, "accepted_answer_id": 58936829, "answer_count": 2, "score": 0, "last_activity_date": 1574194223, "creation_date": 1574110441, "last_edit_date": 1574110637, "question_id": 58922744, "link": "https://stackoverflow.com/questions/58922744/how-can-i-use-the-question-mark-operator-while-iterating-over-references-to-resu", "title": "How can I use the question mark operator while iterating over references to Result?", "body": "<p>I need to chunk my vector <code>Vec&lt;Result&lt;SomeStruct&gt;&gt;</code> into pieces, iterate over each piece, do some work, and return an error if <code>Result&lt;SomeStruct&gt;</code> contains it.</p>\n\n<pre><code>enum SomeStruct {}\n\n#[derive(Debug)]\nstruct SomeError {}\n\ntype Result&lt;T&gt; = std::result::Result&lt;T, SomeError&gt;;\n\nfn foo(v: Vec&lt;Result&lt;SomeStruct&gt;&gt;) -&gt; Result&lt;()&gt; {\n    for chunk in v.chunks(42) {\n        for value in chunk {\n            let value = value?;\n            //do smth with value\n        }\n    }\n    Ok(())\n}\n\nfn main() {\n    let mut values = Vec::new();\n    foo(values).unwrap();\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7b5198ba04f1f32786b15451c849f050\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>However, I get the error</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the `?` operator can only be applied to values that implement `std::ops::Try`\n  --&gt; src/main.rs:11:25\n   |\n11 |             let value = value?;\n   |                         ^^^^^^ the `?` operator cannot be applied to type `&amp;std::result::Result&lt;SomeStruct, SomeError&gt;`\n   |\n   = help: the trait `std::ops::Try` is not implemented for `&amp;std::result::Result&lt;SomeStruct, SomeError&gt;`\n   = note: required by `std::ops::Try::into_result`\n</code></pre>\n\n<p>It seems <code>?</code> expects the value itself instead of a shared reference to the value, but I can't dereference a shared reference and don't know how to get this value itself because <code>chunk</code> here is <code>&amp;[Result&lt;SomeStruct&gt;]</code>, and <code>value</code> is <code>&amp;Result&lt;SomeStruct&gt;</code> </p>\n\n<p>How can I fix it?</p>\n"}, {"tags": ["vector", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574109919, "post_id": 58922609, "comment_id": 104106661, "body": "What should <code>vec![9, 9, ...&lt;1000 more&gt;..., 9, 9]</code> result in?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574109954, "post_id": 58922609, "comment_id": 104106674, "body": "<a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574110007, "post_id": 58922609, "comment_id": 104106701, "body": "It is misleading to title this function <b>sum</b>. By the way, idiomatic Rust uses <code>snake_case</code> for variables, methods, macros, fields and modules; <code>UpperCamelCase</code> for types and enum variants; and <code>SCREAMING_SNAKE_CASE</code> for statics and constants."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1574110304, "post_id": 58922609, "comment_id": 104106845, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e928bcc5fe70378bacafa49c807a1ad2\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a> ?"}], "answers": [{"tags": [], "owner": {"reputation": 40432, "user_id": 1807667, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/976dc9df3ea3d05a18e90f0cd9c29b7a?s=128&d=identicon&r=PG", "display_name": "Ortomala Lokni", "link": "https://stackoverflow.com/users/1807667/ortomala-lokni"}, "is_accepted": true, "score": 3, "last_activity_date": 1574149862, "last_edit_date": 1574149862, "creation_date": 1574115028, "answer_id": 58923655, "question_id": 58922609, "link": "https://stackoverflow.com/questions/58922609/how-do-i-concatenate-a-vector-of-integers-into-a-single-integer/58923655#58923655", "title": "How do I concatenate a vector of integers into a single integer?", "body": "<p>As said in the comments by Stargateur, you can do:</p>\n\n<pre><code>fn concat(vec: &amp;[u32]) -&gt; u32 {\n    vec.iter().fold(0, |acc, elem| acc * 10 + elem)\n}\n</code></pre>\n\n<p>You can also write the same function in imperative style:</p>\n\n<pre><code>fn concat(vec: &amp;[u32]) -&gt; u32 {\n    let mut acc = 0;\n    for elem in vec {\n        acc *= 10;\n        acc += elem;\n    }\n    acc\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1574184612, "post_id": 58939536, "comment_id": 104137982, "body": "This is a very inefficient way, even ignoring that it&#39;s ultimately a string. <a href=\"https://stackoverflow.com/q/28333612/155423\">How can I append a formatted string to an existing String?</a>"}, {"owner": {"reputation": 627, "user_id": 3987763, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/5edbe17788bc835fa4f08ac4977e67d1?s=128&d=identicon&r=PG&f=1", "display_name": "basic_bgnr", "link": "https://stackoverflow.com/users/3987763/basic-bgnr"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574185081, "post_id": 58939536, "comment_id": 104138202, "body": "@shepmaster, thanks for the link.but,  I was just highlighting case where multi digit integer would not work."}], "tags": [], "owner": {"reputation": 627, "user_id": 3987763, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/5edbe17788bc835fa4f08ac4977e67d1?s=128&d=identicon&r=PG&f=1", "display_name": "basic_bgnr", "link": "https://stackoverflow.com/users/3987763/basic-bgnr"}, "is_accepted": false, "score": -1, "last_activity_date": 1574186314, "last_edit_date": 1574186314, "creation_date": 1574183773, "answer_id": 58939536, "question_id": 58922609, "link": "https://stackoverflow.com/questions/58922609/how-do-i-concatenate-a-vector-of-integers-into-a-single-integer/58939536#58939536", "title": "How do I concatenate a vector of integers into a single integer?", "body": "<p>You can follow <a href=\"https://stackoverflow.com/a/58923655/155423\">Ortomala Lokni's procedure</a> if your input vector contains single digit integers.</p>\n\n<p>If the vector contains multi-digit integers, the function may not return the intended value. The following <code>concat_new</code> function handles this case.</p>\n\n<pre><code>fn main() {\n    let a = vec![10_i32, 20, 300];\n\n    println!(\"{:?}\", concat_new(&amp;a));\n    println!(\"{:?}\", concat(&amp;a));   \n}\n\nfn concat_new(vec: &amp;[i32]) -&gt; i32 {\n    let t = vec.iter().fold(\"\".to_string(), |acc, x| acc + &amp;x.to_string());\n    t.parse::&lt;i32&gt;().unwrap()\n}\n\nfn concat(vec: &amp;[i32]) -&gt; i32 {\n    vec.iter().fold(0, |acc, elem| acc * 10 + elem)\n}\n</code></pre>\n"}], "owner": {"reputation": 51, "user_id": 11410466, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-UCTL0Rm-mQ4/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcFk8PjAH-pPRb43WyDkuNSCvj6rw/mo/photo.jpg?sz=128", "display_name": "Eadyn Thompson", "link": "https://stackoverflow.com/users/11410466/eadyn-thompson"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 475, "favorite_count": 0, "accepted_answer_id": 58923655, "answer_count": 2, "score": 0, "last_activity_date": 1574186314, "creation_date": 1574109770, "last_edit_date": 1574109866, "question_id": 58922609, "link": "https://stackoverflow.com/questions/58922609/how-do-i-concatenate-a-vector-of-integers-into-a-single-integer", "title": "How do I concatenate a vector of integers into a single integer?", "body": "<p>I'm trying to concatenate all of the contents of a vector into a single number. This would be like <code>[1, 2, 4] -&gt; 124</code>. Here's what I have right now:</p>\n\n<pre><code>fn sumVector(vec: &amp;Vec&lt;u32&gt;) -&gt; u32 {\n    return vec.to_owned().concat();\n}\n</code></pre>\n\n<p>This is failing with error </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0599]: no method named `concat` found for type `std::vec::Vec&lt;u32&gt;` in the current scope\n --&gt; src/lib.rs:2:27\n  |\n2 |     return vec.to_owned().concat();\n  |                           ^^^^^^ method not found in `std::vec::Vec&lt;u32&gt;`\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1574109626, "last_edit_date": 1574109626, "creation_date": 1574108937, "answer_id": 58922427, "question_id": 58922366, "link": "https://stackoverflow.com/questions/58922366/why-does-this-hashmap-key-have-to-be-dereferenced-twice/58922427#58922427", "title": "Why does this HashMap key have to be dereferenced twice?", "body": "<p>It has to be dereferenced twice because you've created a double reference.</p>\n\n<ol>\n<li>You are <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#impl-IntoIterator\" rel=\"nofollow noreferrer\">iterating over <code>&amp;Vec&lt;T&gt;</code></a> which <a href=\"https://doc.rust-lang.org/std/slice/struct.Iter.html#impl-Iterator\" rel=\"nofollow noreferrer\">produces <code>&amp;T</code></a>.</li>\n<li>You called <a href=\"https://doc.rust-lang.org/std/collections/struct.HashMap.html#method.iter\" rel=\"nofollow noreferrer\"><code>HashMap::iter</code></a> on <code>HashMap&lt;K, V&gt;</code> which <a href=\"https://doc.rust-lang.org/std/collections/hash_map/struct.Iter.html#impl-Iterator\" rel=\"nofollow noreferrer\">produces <code>(&amp;K, &amp;V)</code></a>.</li>\n</ol>\n\n<pre><code>fn mode(vec: &amp;[i32]) -&gt; i32 {\n    let mut counts = std::collections::HashMap::new();\n\n    for &amp;n in vec {\n        *counts.entry(n).or_insert(0) += 1;\n    }\n\n    counts.into_iter().max_by_key(|a| a.1).unwrap().0\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/34733811/155423\">What is the difference between iter and into_iter?</a></li>\n<li><a href=\"https://stackoverflow.com/q/43036279/155423\">What does it mean to pass in a vector into a `for` loop versus a reference to a vector?</a></li>\n<li><a href=\"https://stackoverflow.com/q/40613725/155423\">Iterating over a slice&#39;s values instead of references in Rust?</a></li>\n<li><a href=\"https://stackoverflow.com/q/19066402/155423\">Meaning of &#39;&amp;variable&#39; in arguments/patterns</a></li>\n<li><a href=\"https://stackoverflow.com/q/45197826/155423\">What is the difference between `e1` and `&amp;e2` when used as the for-loop variable?</a></li>\n<li><a href=\"https://stackoverflow.com/q/57339201/155423\">What is the purpose of `&amp;` before the loop variable?</a></li>\n<li><a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a></li>\n</ul>\n"}], "owner": {"reputation": 133, "user_id": 11324952, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4d52a1e358a07e09b5531324f5d70373?s=128&d=identicon&r=PG&f=1", "display_name": "swaltek", "link": "https://stackoverflow.com/users/11324952/swaltek"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 60, "favorite_count": 0, "accepted_answer_id": 58922427, "answer_count": 1, "score": 0, "last_activity_date": 1574109626, "creation_date": 1574108624, "last_edit_date": 1574108799, "question_id": 58922366, "link": "https://stackoverflow.com/questions/58922366/why-does-this-hashmap-key-have-to-be-dereferenced-twice", "title": "Why does this HashMap key have to be dereferenced twice?", "body": "<p>This function computes the mode of a <code>Vec&lt;i32&gt;</code> using a <code>HashMap</code> to keep count of the occurrence of each value. I do not understand why this will not compile unless the key is deferenced twice in this last line:</p>\n\n<pre><code>fn mode(vec: &amp;Vec&lt;i32&gt;) -&gt; i32 {\n    let mut counts = HashMap::new();\n\n    for n in vec {\n        let count = counts.entry(n).or_insert(0);\n        *count += 1;\n    }\n\n    **counts.iter().max_by_key(|a| a.1).unwrap().0\n}\n</code></pre>\n"}, {"tags": ["rust", "rust-macros", "rust-proc-macros"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 5, "last_activity_date": 1599675396, "last_edit_date": 1599675396, "creation_date": 1574107588, "answer_id": 58922120, "question_id": 58922119, "link": "https://stackoverflow.com/questions/58922119/how-do-i-create-a-function-like-procedural-macro/58922120#58922120", "title": "How do I create a function-like procedural macro?", "body": "<p>Reading <a href=\"https://doc.rust-lang.org/book/\" rel=\"nofollow noreferrer\">The Rust Programming Language's</a> chapter on <a href=\"https://doc.rust-lang.org/book/ch19-06-macros.html#function-like-macros\" rel=\"nofollow noreferrer\">macros</a> says:</p>\n<blockquote>\n<p>Function-like macros define macros that look like function calls. Similarly to\n<code>macro_rules!</code> macros, they\u2019re more flexible than functions; for example, they\ncan take an unknown number of arguments. However, <code>macro_rules!</code> macros can be\ndefined only using the match-like syntax we discussed in the section\n<a href=\"https://doc.rust-lang.org/book/ch19-06-macros.html#declarative-macros-with-macro_rules-for-general-metaprogramming\" rel=\"nofollow noreferrer\">\u201cDeclarative Macros with <code>macro_rules!</code> for General Metaprogramming\u201d</a>\nearlier. Function-like macros take a <code>TokenStream</code> parameter and their\ndefinition manipulates that <code>TokenStream</code> using Rust code as the other two\ntypes of procedural macros do. An example of a function-like macro is an <code>sql!</code>\nmacro that might be called like so:</p>\n<pre><code>let sql = sql!(SELECT * FROM posts WHERE id=1);\n</code></pre>\n<p>This macro would parse the SQL statement inside it and check that it\u2019s\nsyntactically correct, which is much more complex processing than a\n<code>macro_rules!</code> macro can do. The <code>sql!</code> macro would be defined like this:</p>\n<pre><code>#[proc_macro]\npub fn sql(input: TokenStream) -&gt; TokenStream {\n</code></pre>\n<p>This definition is similar to the custom derive macro\u2019s signature: we receive\nthe tokens that are inside the parentheses and return the code we wanted to\ngenerate.</p>\n</blockquote>\n<hr />\n<p>Since <a href=\"https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1450-2020-07-16\" rel=\"nofollow noreferrer\">Rust 1.45</a>, you can invoke function-like procedural macros as an expression.</p>\n<pre class=\"lang-none prettyprint-override\"><code>example\n\u251c\u2500\u2500 Cargo.toml\n\u251c\u2500\u2500 example-macro\n\u2502   \u251c\u2500\u2500 Cargo.toml\n\u2502   \u251c\u2500\u2500 src\n\u2502   \u2502   \u2514\u2500\u2500 lib.rs\n\u251c\u2500\u2500 src\n\u2502   \u2514\u2500\u2500 main.rs\n</code></pre>\n<p><strong>Cargo.toml</strong></p>\n<pre><code>[package]\nname = &quot;example&quot;\nversion = &quot;0.1.0&quot;\nedition = &quot;2018&quot;\n\n[dependencies]\nexample-macro = { path = &quot;example-macro&quot; }\n</code></pre>\n<p><strong>src/main.rs</strong></p>\n<pre><code>fn main() {\n    assert_eq!(example_macro::a_proc_macro!(), 5);\n}\n</code></pre>\n<p><strong>example-macro/Cargo.toml</strong></p>\n<pre><code>[package]\nname = &quot;example-macro&quot;\nversion = &quot;0.1.0&quot;\nedition = &quot;2018&quot;\n\n[lib]\nproc-macro = true\n</code></pre>\n<p><strong>example-macro/src/lib.rs</strong></p>\n<pre><code>extern crate proc_macro;\n\nuse proc_macro::TokenStream;\n\n#[proc_macro]\npub fn a_proc_macro(_input: TokenStream) -&gt; TokenStream {\n    &quot;5&quot;.parse().unwrap()\n}\n</code></pre>\n<p>See also:</p>\n<ul>\n<li><a href=\"https://stackoverflow.com/q/52585719/155423\">How do I create a proc_macro_attribute?</a></li>\n<li><a href=\"https://stackoverflow.com/q/54165117/155423\">Convert string into TokenStream</a></li>\n<li><a href=\"https://stackoverflow.com/q/56713877/155423\">Why do proc-macros have to be defined in proc-macro crate?</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/issues/54727\" rel=\"nofollow noreferrer\">Tracking issue for procedural macros and &quot;hygiene 2.0&quot; (#54727)</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 102109, "user_id": 1600898, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/01377f8b31f24b0265854666b29d0c03?s=128&d=identicon&r=PG", "display_name": "user4815162342", "link": "https://stackoverflow.com/users/1600898/user4815162342"}, "is_accepted": false, "score": 1, "last_activity_date": 1574110125, "creation_date": 1574110125, "answer_id": 58922680, "question_id": 58922119, "link": "https://stackoverflow.com/questions/58922119/how-do-i-create-a-function-like-procedural-macro/58922680#58922680", "title": "How do I create a function-like procedural macro?", "body": "<p>Directly defining expression-like procedural macros is not yet possible in stable Rust. If you can use nightly, <a href=\"https://stackoverflow.com/a/58922120/1600898\">Shepmaster's answer</a> shows how.</p>\n\n<p>If you are on stable, you can still emulate expression-like procedural macros as follows:</p>\n\n<ul>\n<li>define a procedural macro that expands to a function that evaluates to the expression you want to call;</li>\n<li>then define a regular macro that expands to a block that embeds the function definition and call.</li>\n</ul>\n\n<p>In your case you'd define the procedural macro like this:</p>\n\n<pre><code>#[proc_macro]\npub fn a_proc_macro_impl(_input: TokenStream) -&gt; TokenStream {\n    \"fn output() -&gt; usize { 5 }\".parse().unwrap()\n}\n</code></pre>\n\n<p>...the helper <code>macro_rules!</code> macro follows this pattern:</p>\n\n<pre><code>macro_rules! a_proc_macro {\n    ($($t:tt)*) =&gt; {{\n        struct _X;\n        impl _X {\n            a_proc_macro!($($t)*);\n        }\n        _X::output()\n    }}\n}\n</code></pre>\n\n<p>This is a hack, and a cumbersome one at that, but <a href=\"https://github.com/dtolnay/proc-macro-hack\" rel=\"nofollow noreferrer\">proc-macro-hack</a> crate comes to the rescue and makes it easier to generate procedural macros using the above technique. With the help of the <code>proc-macro-hack</code> crate, you can run the almost unchanged code from Shepmaster's answer on stable:</p>\n\n<ul>\n<li>edit both <code>Cargo.toml</code> files and add <code>proc-macro-hack = \"0.5.11\"</code> to the dependencies section;</li>\n<li>add <code>#[proc_macro_hack] use example_macro::a_proc_macro;</code> in <code>src/main.rs</code>, and invoke <code>a_proc_macro!</code> from the local namespace.</li>\n<li>add <code>#[proc_macro_hack::proc_macro_hack]</code> before the definition of <code>a_proc_macro</code> in <code>example-macro/src/lib.rs</code>.</li>\n</ul>\n"}], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1906, "favorite_count": 0, "accepted_answer_id": 58922120, "answer_count": 2, "score": 6, "last_activity_date": 1599675396, "creation_date": 1574107588, "question_id": 58922119, "link": "https://stackoverflow.com/questions/58922119/how-do-i-create-a-function-like-procedural-macro", "title": "How do I create a function-like procedural macro?", "body": "<p>How should <code>a_proc_macro</code> be defined so it \"returns\" a 5?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let a = a_proc_macro!();\n    assert!(a == 5);\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 3, "creation_date": 1574105875, "post_id": 58921575, "comment_id": 104104767, "body": "include byte can include any byte so... anything, as your lib seem to have a <code>from_raw</code> function just use it."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1574106656, "last_edit_date": 1574106656, "creation_date": 1574106292, "answer_id": 58921835, "question_id": 58921575, "link": "https://stackoverflow.com/questions/58921575/can-include-bytes-be-used-on-a-custom-structure/58921835#58921835", "title": "Can include_bytes!() be used on a custom structure?", "body": "<p>Yes. </p>\n\n<p>From the documentation:</p>\n\n<blockquote>\n  <p>Includes a file as a reference to a byte array.</p>\n  \n  <p>The file is located relative to the current file. (similarly to how\n  modules are found)</p>\n  \n  <p>This macro will yield an expression of type <code>&amp;'static [u8; N]</code> which is\n  the contents of the file.</p>\n</blockquote>\n\n<p>There is no restriction on the type of data. The literal bytes are included. It's worth recognizing that it's up to <em>you</em> to ensure that the bytes make sense for the platform that the code runs on and that you have some way of parsing the bytes.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/25505275/155423\">Is there a good way to include external resource data into Rust source code?</a></li>\n<li><a href=\"https://stackoverflow.com/q/32748918/155423\">Is there any way to include binary or text files in a Rust library?</a></li>\n<li><a href=\"https://stackoverflow.com/q/27140634/155423\">How to embed resources in Rust executable?</a></li>\n</ul>\n"}], "owner": {"reputation": 1507, "user_id": 4296244, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/e8c0940effc84e18a8541145ef2dfbfe?s=128&d=identicon&r=PG&f=1", "display_name": "Natjo", "link": "https://stackoverflow.com/users/4296244/natjo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 215, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1574106656, "creation_date": 1574105255, "last_edit_date": 1574105939, "question_id": 58921575, "link": "https://stackoverflow.com/questions/58921575/can-include-bytes-be-used-on-a-custom-structure", "title": "Can include_bytes!() be used on a custom structure?", "body": "<p>I want to embed an image file in my project. To be more precise, I would like to embed the loaded Rust object containing the image, in my case a <a href=\"https://docs.rs/usvg/0.5.0/x86_64-apple-darwin/usvg/struct.Tree.html\" rel=\"nofollow noreferrer\"><code>usvg::Tree</code></a>, or even more advanced, a <a href=\"https://gtk-rs.org/docs/cairo/struct.ImageSurface.html\" rel=\"nofollow noreferrer\"><code>cairo::ImageSurface</code></a>. Would that be possible? I only find examples for <code>String</code>s.</p>\n"}, {"tags": ["rust", "rust-macros", "rust-proc-macros"], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 1, "last_activity_date": 1574108863, "last_edit_date": 1574108863, "creation_date": 1574108605, "answer_id": 58922361, "question_id": 58920852, "link": "https://stackoverflow.com/questions/58920852/how-can-i-compute-an-instance-of-a-type-in-a-function-like-procedural-macro-and/58922361#58922361", "title": "How can I compute an instance of a type in a function-like procedural macro and return it?", "body": "<p>While this seems like an easy request, there is actually a lot to unroll here.</p>\n\n<p>Most importantly, it is crucial to understand that procedural macros only return <em>tokens</em> (i.e. Rust code). To put it bluntly: the Rust compiler executes your procedural macro, takes the resulting tokens and pastes them in the users code where your procedural macro invocation was. You can think of procedural macros as a pre-processing step that takes your Rust code, transforms it and spits out another <code>.rs</code> file. <em>That</em> file is then fed to the compiler. </p>\n\n<hr>\n\n<p>In order to \"return a value of <code>Foo</code>\" you have to return a <code>TokenStream</code> that represents an expression which evaluates to <code>Foo</code>. For example:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[proc_macro]\npub fn create_foo(_: TokenStream) -&gt; TokenStream {\n    quote! { Foo { data: vec![1, 2, 3] } }\n}\n</code></pre>\n\n<p>In the user's crate:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let a: Foo = create_foo!();\n</code></pre>\n\n<p>Which would expand to:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let a: Foo = Foo { data: vec![1, 2, 3] };\n</code></pre>\n\n<p>The <code>data: vec![1, 2, 3]</code> part could be generated dynamically by the procedural macro. If your <code>Foo</code> instance is very large, the code creating that instance is probably very large as well. This means that compile times might increase because the Rust compiler has to parse and check this huge expression. </p>\n\n<hr>\n\n<p>So you can't return the value directly? No. You might think that you could do it with <code>unsafe</code> code. For example, emit a big <code>const DATA: &amp;[u8] = ...;</code> and <code>mem::transmute</code> it to <code>Foo</code>, but you can't for several reasons:</p>\n\n<ul>\n<li>The procedural macro and the user's crate might not run on the same platform (CPU, OS, ...) which all might influence how <code>Foo</code> is represented in memory. The same <code>Foo</code> instance might be represented differently in memory for your procedural macro and your user crate, so you can't  <code>transmute</code>.</li>\n<li>If <code>Foo</code> contains heap allocated structures (<code>Vec</code>), you can't do it anyway. </li>\n</ul>\n\n<hr>\n\n<p>If you must generate the value in your procedural macro, then there is only one solution to get it to the user, but this is not optimal. Alternatively, maybe calculating it at runtime once isn't that bad.</p>\n"}], "owner": {"reputation": 55, "user_id": 11748992, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/66892637e4600495281137d46605c857?s=128&d=identicon&r=PG&f=1", "display_name": "Nils Andr&#233;", "link": "https://stackoverflow.com/users/11748992/nils-andr%c3%a9"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 261, "favorite_count": 0, "accepted_answer_id": 58922361, "answer_count": 1, "score": 1, "last_activity_date": 1574109394, "creation_date": 1574102037, "last_edit_date": 1574109394, "question_id": 58920852, "link": "https://stackoverflow.com/questions/58920852/how-can-i-compute-an-instance-of-a-type-in-a-function-like-procedural-macro-and", "title": "How can I compute an instance of a type in a function-like procedural macro and return it?", "body": "<p>I have the type <code>Foo</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct Foo { ... }\n</code></pre>\n\n<p>Now I want to create a procedural macro that creates an instance of this struct. This might involve heavy computation, file access, or other stuff only procedural macros can do, but the exact details of how to create that instance are not important here.</p>\n\n<p>I defined my procedural macro like this:</p>\n\n<pre><code>#[proc_macro]\npub fn create_foo(_: TokenStream) -&gt; TokenStream {\n    let foo_value: Foo = /* some complex computation */;\n\n    // TODO: return `foo_value`\n}\n</code></pre>\n\n<p>The users of my procedural macros should be able to write this:</p>\n\n<pre><code>fn main() {\n    let a: Foo = create_foo!();\n}\n</code></pre>\n\n<p>Please note that <code>Foo</code> could contain <em>a lot</em> of data, like many megabytes of <code>Vec</code> data.</p>\n\n<p><strong>How can I return the <code>Foo</code> value from my procedural macro?</strong></p>\n"}, {"tags": ["rust", "mac-catalyst", "rustup"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1574090409, "last_edit_date": 1574090409, "creation_date": 1574088992, "answer_id": 58917341, "question_id": 58916615, "link": "https://stackoverflow.com/questions/58916615/how-do-i-build-for-mac-catalyst-x86-64-apple-ios-macabi/58917341#58917341", "title": "How do I build for Mac Catalyst / x86_64-apple-ios-macabi?", "body": "<p>The <code>x86_64-apple-ios-macabi</code> target is available on the nightly (5c5b8afd8 2019-11-16) compiler. Just because a target is available does not mean that the standard library and friends are compiled or available to rustup:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>% rustc +nightly --print target-list | grep macabi\nx86_64-apple-ios-macabi\n</code></pre>\n\n<p>Rust has a <a href=\"https://forge.rust-lang.org/release/platform-support.html\" rel=\"nofollow noreferrer\">tier system</a> (which is the subject of <a href=\"https://github.com/rust-lang/rfcs/pull/2803\" rel=\"nofollow noreferrer\">a proposed RFC</a>). This target is so new it's not even listed on the tier list, but it's undoubtedly going to be tier 3. Tier 2.5 says (emphasis mine):</p>\n\n<blockquote>\n  <p>Tier 2.5 platforms can be thought of as \"guaranteed to build\", but <strong>without builds available through rustup</strong></p>\n</blockquote>\n\n<p>In the meantime, you will need to build your own libcore / libstd from source. This can be done using the <a href=\"https://github.com/japaric/xargo\" rel=\"nofollow noreferrer\">xargo</a> tool. I don't have the time nor ability to actually test that the compilation works, but something like this is the general starting path:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>% rustup override set nightly\ninfo: using existing install for 'nightly-x86_64-apple-darwin'\ninfo: override toolchain for '/private/tmp/example' set to 'nightly-x86_64-apple-darwin'\n\n  nightly-x86_64-apple-darwin unchanged - rustc 1.41.0-nightly (5c5b8afd8 2019-11-16)\n\n% cat &gt; Xargo.toml\n[target.x86_64-apple-ios-macabi.dependencies.std]\n# features = [\"jemalloc\"] # Whatever is appropriate\n\n% xargo build --target x86_64-apple-ios-macabi\n# Iterate until libcore and libstd compile and work for your platform\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 16755, "user_id": 1457385, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/26e4b04f7983293b58b575db435b8ac2?s=128&d=identicon&r=PG", "display_name": "shallowThought", "link": "https://stackoverflow.com/users/1457385/shallowthought"}, "is_accepted": false, "score": 0, "last_activity_date": 1574847982, "creation_date": 1574847982, "answer_id": 59067279, "question_id": 58916615, "link": "https://stackoverflow.com/questions/58916615/how-do-i-build-for-mac-catalyst-x86-64-apple-ios-macabi/59067279#59067279", "title": "How do I build for Mac Catalyst / x86_64-apple-ios-macabi?", "body": "<p><a href=\"https://stackoverflow.com/a/58917341/1457385\">@shepmaster 's answer</a> is correct. In detail, you have to:</p>\n\n<ul>\n<li>Install Xargo:</li>\n</ul>\n\n<pre><code>cargo install xargo\n</code></pre>\n\n<ul>\n<li><p>cd in your project</p></li>\n<li><p>use the nighly build:</p></li>\n</ul>\n\n<pre><code>rustup override set nightly\n</code></pre>\n\n<ul>\n<li>create the <code>Xargo.toml</code> file with content:</li>\n</ul>\n\n<pre><code>[target.x86_64-apple-ios-macabi.dependencies.std]\n</code></pre>\n\n<ul>\n<li><p>In your projects Cargo.toml, make sure the <code>[profile.release]</code> section contains <code>panic = \"abort\"</code>. If it does not, add it.</p></li>\n<li><p>When building the project, use <code>xargo</code>instead of <code>cargo</code>.</p></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 134, "user_id": 7345663, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b2b69dbb97a2e901c9fa518ab6a612bb?s=128&d=identicon&r=PG&f=1", "display_name": "hohteri", "link": "https://stackoverflow.com/users/7345663/hohteri"}, "is_accepted": false, "score": 0, "last_activity_date": 1587475786, "creation_date": 1587475786, "answer_id": 61344762, "question_id": 58916615, "link": "https://stackoverflow.com/questions/58916615/how-do-i-build-for-mac-catalyst-x86-64-apple-ios-macabi/61344762#61344762", "title": "How do I build for Mac Catalyst / x86_64-apple-ios-macabi?", "body": "<p>If you have an old installation of rust, you might need to remove old nightly (or at least for me it fails to update nightly):</p>\n\n<pre><code>rustup toolchain remove nightly\nrustup update\nrustup toolchain install nightly\n</code></pre>\n"}], "owner": {"reputation": 16755, "user_id": 1457385, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/26e4b04f7983293b58b575db435b8ac2?s=128&d=identicon&r=PG", "display_name": "shallowThought", "link": "https://stackoverflow.com/users/1457385/shallowthought"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 597, "favorite_count": 0, "accepted_answer_id": 58917341, "answer_count": 3, "score": 1, "last_activity_date": 1587475786, "creation_date": 1574086711, "last_edit_date": 1574088565, "question_id": 58916615, "link": "https://stackoverflow.com/questions/58916615/how-do-i-build-for-mac-catalyst-x86-64-apple-ios-macabi", "title": "How do I build for Mac Catalyst / x86_64-apple-ios-macabi?", "body": "<p>The output of <code>rustup target list --toolchain nightly</code> does not contain <code>x86_64-apple-ios-macabi</code>, even though it is in <code>src/librustc_target</code> on <a href=\"https://github.com/rust-lang/rust/blob/a0d40f8bdfcc3c28355467973f97fd4c45ac5876/src/librustc_target/spec/x86_64_apple_ios_macabi.rs\" rel=\"nofollow noreferrer\">the Rust master branch</a>.</p>\n\n<p>How do I build for Mac Catalyst / <code>x86_64-apple-ios-macabi</code>?</p>\n"}, {"tags": ["postgresql", "rust"], "comments": [{"owner": {"reputation": 148602, "user_id": 24545, "user_type": "registered", "accept_rate": 99, "profile_image": "https://i.stack.imgur.com/omB1R.jpg?s=128&g=1", "display_name": "Yuval Adam", "link": "https://stackoverflow.com/users/24545/yuval-adam"}, "edited": false, "score": 1, "creation_date": 1574070061, "post_id": 58911282, "comment_id": 104085329, "body": "Well <code>pub fn from_be_bytes(bytes: [u8; 8]) -&gt; f64</code> expects 8 bytes, perhaps <code>raw: &amp;[u8]</code> is returning more than that? There might be an in herent mismatch between the PG Numeric type and <code>f64</code>"}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 2, "creation_date": 1574071469, "post_id": 58911282, "comment_id": 104086131, "body": "<code>diesel</code> has this <code>diesel::pg::data_types::PgNumeric</code> type. Its <code>impl FromSql&lt;Numeric, Pg&gt; for PgNumeric</code> probably can show you how to do the conversion."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1574090862, "post_id": 58911282, "comment_id": 104097196, "body": "<a href=\"https://www.postgresql.org/docs/current/datatype-numeric.html\" rel=\"nofollow noreferrer\">numeric | user-specified precision, exact | up to <b>131072</b> digits before the decimal point; up to <b>16383</b> digits after the decimal point</a>. There is no Rust type that supports that."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1574090900, "post_id": 58911282, "comment_id": 104097220, "body": "See also <a href=\"https://stackoverflow.com/q/32651069/155423\">C libpq: get float value from numeric</a>"}], "owner": {"reputation": 5906, "user_id": 198825, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/aba9dac582a7e4346b1895366200e2f2?s=128&d=identicon&r=PG", "display_name": "noamt", "link": "https://stackoverflow.com/users/198825/noamt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 184, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1574090912, "creation_date": 1574068725, "last_edit_date": 1574090912, "question_id": 58911282, "link": "https://stackoverflow.com/questions/58911282/how-do-i-convert-a-raw-slice-of-bytes-representing-a-postgresql-numeric-column-i", "title": "How do I convert a raw slice of bytes representing a PostgreSQL numeric column into a f64?", "body": "<p>I'm querying an instance of PostgreSQL and selecting a sum of a decimal value:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>db=# SELECT SUM(distance) AS total_distance FROM table_name WHERE deleted_at IS NULL;\n    total_distance\n-----------------------\n 3808.0666666666666578\n(1 row)\n</code></pre>\n\n<p>When I try to execute this query in Rust:</p>\n\n<pre><code>extern crate postgres;\nuse postgres::{Connection, TlsMode};\n\nfn main() {\n    let conn = Connection::connect(\"postgresql://u:p@localhost:5432/db\", TlsMode::None).unwrap();\n    let query = \"SELECT SUM(distance) AS total_distance FROM table_name WHERE deleted_at IS NULL;\";\n    for row in &amp;conn.query(query, &amp;[]).unwrap() {\n        let total_distance: f64 = row.get(\"total_distance\");\n        println!(\"{}\", total_distance);\n    }\n}\n</code></pre>\n\n<p>Results in:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>thread 'main' panicked at 'error retrieving column \"total_distance\": Error(Conversion(WrongType(Type(Numeric))))'\n</code></pre>\n\n<p>I've seen in various threads that the <code>Numeric</code> type isn't supported by the  Postgres crate, so I've tried creating my own numeric type:</p>\n\n<pre><code>#[derive(Debug)]\nstruct Float64(f64);\n\nimpl FromSql for Float64 {\n    fn from_sql(ty: &amp;Type, raw: &amp;[u8]) -&gt; Result&lt;Float64, Box&lt;Error + Sync + Send&gt;&gt; {\n        let bytes = raw.try_into().expect(\"failed!\");\n        Ok(Float64(f64::from_be_bytes(bytes)))\n    }\n\n    fn from_sql_null(ty: &amp;Type) -&gt; Result&lt;Float64, Box&lt;Error + Sync + Send&gt;&gt; {\n        Ok(Float64(0.0))\n    }\n\n    fn from_sql_nullable(\n        ty: &amp;Type,\n        raw: Option&lt;&amp;[u8]&gt;,\n    ) -&gt; Result&lt;Float64, Box&lt;Error + Sync + Send&gt;&gt; {\n        match raw {\n            None =&gt; Ok(Float64(0.0)),\n            Some(value) =&gt; Float64::from_sql(ty, value),\n        }\n    }\n\n    fn accepts(ty: &amp;Type) -&gt; bool {\n        NUMERIC.eq(ty)\n    }\n}\n\nimpl Display for Float64 {\n    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; std::fmt::Result {\n        write!(f, \"{}\", self.to_string())\n    }\n}\n</code></pre>\n\n<p>But this still doesn't work as the raw bytes fail to unwrap:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>thread 'main' panicked at 'failed!: TryFromSliceError(())', src/libcore/result.rs:1165:5\n</code></pre>\n\n<p><code>raw: &amp;[u8]</code> has the length of 18, which is why it can't unwrap. What would be the best way to convert an 18 byte slice to <code>f64</code>?</p>\n"}, {"tags": ["performance", "rust", "iterator"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1574078964, "post_id": 58910603, "comment_id": 104090330, "body": "There&#39;s no <i>allocation</i> in this code, because <code>Event</code> doesn&#39;t contain any heap-allocating types like <code>Box</code>, <code>Vec</code> or <code>Arc</code>. There might be a <i>copy</i>, but only if LLVM does not elide it (see justinas&#39;s answer). Whether the same <i>stack</i> memory is reused depends on how you call the iterator. Rust is not Java; nothing is boxed unless you make it so."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1574080210, "post_id": 58910603, "comment_id": 104090985, "body": "(It occurs to me that <code>Event</code> may also contain pointers to buffers allocated by the C library, which you cannot avoid reallocating, or pointers <i>allocated</i> by Rust but <i>populated</i> by C, which would be a little unusual as an API and might warrant using something like user2722968&#39;s <code>Rc</code> idea.)"}], "answers": [{"tags": [], "owner": {"reputation": 4491, "user_id": 1264974, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/6558cf06df3ccf1c49329f38fd843b7d?s=128&d=identicon&r=PG", "display_name": "justinas", "link": "https://stackoverflow.com/users/1264974/justinas"}, "is_accepted": false, "score": 1, "last_activity_date": 1574067067, "creation_date": 1574067067, "answer_id": 58910833, "question_id": 58910603, "link": "https://stackoverflow.com/questions/58910603/recycling-items-in-iterators-for-better-performance/58910833#58910833", "title": "&quot;Recycling&quot; items in iterators for better performance", "body": "<p>The compiler (or LLVM) will most likely employ <a href=\"https://en.wikipedia.org/wiki/Copy_elision#Return_value_optimization\" rel=\"nofollow noreferrer\">return value optimization</a> in this case, so you do not need to prematurely optimize by yourself.</p>\n\n<p>See <a href=\"https://godbolt.org/z/GTBCSx\" rel=\"nofollow noreferrer\">this Godbolt example</a>, particularly lines 43 to 47. My comprehension of Assembly is limited, but it seems that <code>next()</code> simply writes the <code>Event</code> value to the memory passed by the caller via a pointer (initially in <code>rdi</code>). In subsequent loop iterations this memory place can be reused.</p>\n\n<p>Note that you get a much longer assembly output (which I did not analyze in depth) if you compile without the <code>-O</code> flag (e.g. when building in the \"debug\" mode as opposed to \"release\").</p>\n"}, {"tags": [], "owner": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "is_accepted": true, "score": 3, "last_activity_date": 1574105031, "last_edit_date": 1574105031, "creation_date": 1574071908, "answer_id": 58912158, "question_id": 58910603, "link": "https://stackoverflow.com/questions/58910603/recycling-items-in-iterators-for-better-performance/58912158#58912158", "title": "&quot;Recycling&quot; items in iterators for better performance", "body": "<p>You can \"recycle\" items between iterations by wrapping the <code>Item</code> in a reference counter. The idea here is that if the caller keeps the item around between iterations, the iterator allocates a new object and returns that new object. If the item is dropped by the caller before the next iteration begins, the item is recycled. This is ensured by <code>std::rc::Rc::get_mut()</code>, which will only return a reference if the reference-count is exactly 1.</p>\n\n<p>This has the downside that your <code>Iterator</code> yields <code>Rc&lt;Foo&gt;</code> instead of <code>Foo</code>. There is also the added code-complexity and (maybe) some runtime-cost due to the reference-counting (which may get elided completely if the compiler can prove that).</p>\n\n<p>You will, therefore, need to measure if this actually gets you a performance win. Allocating a new object on every single iteration may seem costly, but allocators are good at this...</p>\n\n<p>Something to the tune of</p>\n\n<pre><code>use std::rc::Rc;\n\n#[derive(Default)]\nstruct FoobarIterator {\n    item: Rc&lt;String&gt;,\n}\n\nimpl Iterator for FoobarIterator {\n    type Item = Rc&lt;String&gt;;\n\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        let item = match Rc::get_mut(&amp;mut self.item) {\n            Some(item) =&gt; {\n                // This path is only taken if the caller\n                // did not keep the item around\n                // so we are the only reference-holder!\n                println!(\"Item is re-used!\");\n                item   \n            },\n            None =&gt; {\n                // Let go of the item (the caller gets to keep it)\n                // and create a new one\n                println!(\"Creating new item!\");\n                self.item = Rc::new(String::new());\n                Rc::get_mut(&amp;mut self.item).unwrap()\n            }\n        };\n        // Create the item, possible reusing the same allocation...\n        item.clear();\n        item.push('a');\n        Some(Rc::clone(&amp;self.item))\n    }\n}\n\nfn main() {\n    // This will only print \"Item is re-used\"\n    // because `item` is dropped before the next cycle begins\n    for item in FoobarIterator::default().take(5) {\n        println!(\"{}\", item);\n    }\n\n    // This will allocate new objects every time\n    // because the Vec retains ownership.\n    let _: Vec&lt;_&gt; = FoobarIterator::default().take(5).collect();\n}\n</code></pre>\n"}], "owner": {"reputation": 2633, "user_id": 2148076, "user_type": "registered", "accept_rate": 72, "profile_image": "https://i.stack.imgur.com/AyqVf.png?s=128&g=1", "display_name": "danijoo", "link": "https://stackoverflow.com/users/2148076/danijoo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 117, "favorite_count": 1, "accepted_answer_id": 58912158, "answer_count": 2, "score": 0, "last_activity_date": 1574105031, "creation_date": 1574066069, "last_edit_date": 1574085265, "question_id": 58910603, "link": "https://stackoverflow.com/questions/58910603/recycling-items-in-iterators-for-better-performance", "title": "&quot;Recycling&quot; items in iterators for better performance", "body": "<p>I have a file that contains multiple instances of some complex data type (think of a trajectory of events). The API to read this file is written in C and I don't have much control over it. To expose it to Rust, I implemented the following interface:</p>\n\n<pre><code>// a single event read from the file\nstruct Event {\n    a: u32,\n    b: f32,\n}\n\n// A handle to the file used for I/O\nstruct EventFile;\n\nimpl EventFile {\n    fn open() -&gt; Result&lt;EventFile, Error&gt; {\n        unimplemented!()\n    }\n\n    // read the next step of the trajectory into event\n    fn read(&amp;self, event: &amp;mut Event) -&gt; Result&lt;(), Error&gt; {\n        event.a = unimplemented!();\n        event.b = unimplemented!();\n    }\n}\n</code></pre>\n\n<p>To access the file contents, I could call the <code>read</code> function until it returns an <code>Err</code> similar to this:</p>\n\n<pre><code>let event_file = EventFile::open();\nlet mut event = Event::new();\n\nlet mut result = event_file.read(&amp;mut event);\nwhile let Ok(_) = result {\n    println!(\"{:?}\", event);\n    result = event_file.read(&amp;mut event);\n}\n</code></pre>\n\n<p>Because event is reused for each call of <code>read</code>, there's no repeated allocation/deallocation of memory which hopefully results in some performance improvement (the event struct is much bigger in the actual implementation).</p>\n\n<p>Now, It would be nice to be able to access this data through an iterator. However, to my understanding, this means that I have to create a new instance of <code>Event</code> each time the iterator yields - because I cannot reuse the event inside with an iterator. And this will hurt the performance:</p>\n\n<pre><code>struct EventIterator {\n    event_file: EventFile,\n}\nimpl Iterator for EventIterator {\n    type Item = Event;\n    fn next(&amp;mut self) -&gt; Option&lt;Event&gt; {\n        let mut event = Event::new(); // costly allocation\n        let result = self.event_file.read(&amp;mut event);\n        match result {\n            Ok(_) =&gt; Some(event),\n            Err(_) =&gt; None,\n        }\n    }\n}\n\nlet it = EventIterator { event_file };\nit.map(|event| unimplemented!())\n</code></pre>\n\n<p>Is there a way to somehow \"recycle\" or \"reuse\" events inside the iterator? Or is this a concept that is simply not transferable to Rust and I have to live with worse performance using iterators in this case?</p>\n"}, {"tags": ["rust", "reqwest"], "comments": [{"owner": {"reputation": 15778, "user_id": 3706693, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0c23cb4348804fbc993d70df4cab71fc?s=128&d=identicon&r=PG", "display_name": "num8er", "link": "https://stackoverflow.com/users/3706693/num8er"}, "edited": false, "score": 0, "creation_date": 1574046196, "post_id": 58906965, "comment_id": 104077458, "body": "Seems like reqwest not documented well: <a href=\"https://www.gitmemory.com/issue/seanmonstar/reqwest/643/532880897\" rel=\"nofollow noreferrer\">gitmemory.com/issue/seanmonstar/reqwest/643/532880897</a>"}], "answers": [{"tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 35, "last_activity_date": 1574046797, "creation_date": 1574046797, "answer_id": 58907538, "question_id": 58906965, "link": "https://stackoverflow.com/questions/58906965/could-not-find-blocking-in-reqwest/58907538#58907538", "title": "could not find `blocking` in `reqwest`", "body": "<p>It is an optional feature of the crate. You have to explicitly enable it in dependencies:</p>\n\n<pre><code>[dependencies]\nreqwest = { version = \"0.10.0-alpha.2\", features = [\"blocking\"] }\n</code></pre>\n\n<p>The <a href=\"https://docs.rs/reqwest/0.10.0-alpha.2/reqwest/blocking/index.html#optional\" rel=\"noreferrer\"><code>reqwest::blocking</code> documentation</a> does mention it:</p>\n\n<blockquote>\n  <p>This requires the optional <code>blocking</code> feature to be enabled.</p>\n</blockquote>\n"}], "owner": {"reputation": 23772, "user_id": 1035008, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/afa583c070c82a0961be918141f953fe?s=128&d=identicon&r=PG", "display_name": "Yuchen", "link": "https://stackoverflow.com/users/1035008/yuchen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3741, "favorite_count": 2, "closed_date": 1574085877, "accepted_answer_id": 58907538, "answer_count": 1, "score": 24, "last_activity_date": 1574085871, "creation_date": 1574041226, "last_edit_date": 1574085871, "question_id": 58906965, "link": "https://stackoverflow.com/questions/58906965/could-not-find-blocking-in-reqwest", "closed_reason": "Duplicate", "title": "could not find `blocking` in `reqwest`", "body": "<p>I am trying to download a text file from a given URL using <a href=\"https://docs.rs/reqwest/0.10.0-alpha.2/reqwest/blocking/index.html\" rel=\"noreferrer\">reqwest 0.10.0-alpha.2</a>, which looks like an appropriate tool. I have this in my Cargo.toml file:</p>\n\n<pre><code>[package]\nname = \"...\"\nversion = \"0.1.0\"\nauthors = [\"Y*** &lt;y***@***.***&gt;\"]\nedition = \"2019\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\nreqwest = \"0.10.0-alpha.2\"\n</code></pre>\n\n<p>The dependency seems to resolve and I have my Cargo.lock file. </p>\n\n<p>I have this snippet lifted from <a href=\"https://docs.rs/reqwest/0.10.0-alpha.2/reqwest/blocking/index.html:\" rel=\"noreferrer\">the docs</a> </p>\n\n<pre><code>let body = reqwest::blocking::get(\"https://www.rust-lang.org\")?\n    .text()?;\n\nprintln!(\"body = {:?}\", body);\n</code></pre>\n\n<p>But I am getting this error: </p>\n\n<blockquote>\n  <pre class=\"lang-none prettyprint-override\"><code>  |  \n  |     let body = reqwest::blocking::get(\"https://www.rust-lang.org\")?.text()?;  \n  |                         ^^^^^^^^ could not find `blocking` in `reqwest`  \n</code></pre>\n</blockquote>\n\n<p>Why? I do see this line on the doc \"This requires the optional blocking feature to be enabled\" from the above link. It might be just that. However, it is not clear to me how you enable a \"feature\" for a library in Rust either. </p>\n\n<hr>\n\n<p>I also tried this (some shooting in the dark): </p>\n\n<pre><code>use reqwest::blocking;\n</code></pre>\n\n<p>Same error:</p>\n\n<blockquote>\n  <pre class=\"lang-none prettyprint-override\"><code> |\n | use reqwest::blocking;\n |     ^^^^^^^^^^^^^^^^^ no `blocking` in the root\n</code></pre>\n</blockquote>\n\n<hr>\n\n<p>Following @edwardw's answer to enable \"blocking\" in \"reqwest\", and then also have to change <code>?</code> to <code>unwrap</code>. Not sure, but maybe <code>?</code> is from an older version of rust or sth. But it doesn't compile for me. </p>\n\n<pre><code>let body = reqwest::blocking::get(\"https://www.rust-lang.org\")\n    .unwrap()\n    .text();\nprintln!(\"body = {:?}\", body);\n</code></pre>\n"}, {"tags": ["c", "rust", "ffi"], "comments": [{"owner": {"reputation": 6137, "user_id": 847382, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/b73e2fff665c33621c8a4347cf8074be?s=128&d=identicon&r=PG", "display_name": "PitaJ", "link": "https://stackoverflow.com/users/847382/pitaj"}, "edited": false, "score": 0, "creation_date": 1574048048, "post_id": 58906769, "comment_id": 104077845, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ddeab9d1af2a62ecf6ce095dd667590d\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "reply_to_user": {"reputation": 6137, "user_id": 847382, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/b73e2fff665c33621c8a4347cf8074be?s=128&d=identicon&r=PG", "display_name": "PitaJ", "link": "https://stackoverflow.com/users/847382/pitaj"}, "edited": false, "score": 0, "creation_date": 1574049222, "post_id": 58906769, "comment_id": 104078071, "body": "@PitaJ But do I need to use anything like <code>from_raw_parts</code> (obviously it would be a different function) before accessing the struct fields?"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574068464, "post_id": 58906769, "comment_id": 104084491, "body": "&quot;There is no length parameter&quot; a C array have ALWAYS a length, if not it&#39;s not an array by definition. You can have it by doing <code>const size_t len = sizeof glkunix_arguments &#47; sizeof *glkunix_arguments;</code>"}, {"owner": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574076829, "post_id": 58906769, "comment_id": 104089208, "body": "@Stargateur I meant no length parameter was provided to the functions. I could change the end user code but then it wouldn&#39;t be a drop in replacement."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574087717, "post_id": 58906769, "comment_id": 104095343, "body": "Again, no length no array, you can&#39;t pass an array as parameter to a C function, you can only pass a pointer to a whatever you want but not an array. Semantic is very important in a language like C, if you say array it&#39;s an array so it HAD an length."}, {"owner": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574088730, "post_id": 58906769, "comment_id": 104095928, "body": "@Stargateur I never said it didn&#39;t have a length. I said there&#39;s no length <b>parameter</b>, by which I meant it is not exposed as a global that I can simply access with an extern from Rust, nor is it ever given to the library&#39;s functions."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1574098055, "post_id": 58906769, "comment_id": 104101174, "body": "And what I&#39;m saying is it should"}], "answers": [{"comments": [{"owner": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "edited": false, "score": 0, "creation_date": 1574076929, "post_id": 58910948, "comment_id": 104089257, "body": "Oh interesting, I&#39;ve never seen externs or structs inside functions before. Thanks!"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "edited": false, "score": 0, "creation_date": 1574084037, "post_id": 58910948, "comment_id": 104093136, "body": "Rust is super flexible in this aspect. You can put whatever you want in a function."}, {"owner": {"reputation": 2659, "user_id": 8050514, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/6CRdl.jpg?s=128&g=1", "display_name": "Optimistic Peach", "link": "https://stackoverflow.com/users/8050514/optimistic-peach"}, "edited": false, "score": 0, "creation_date": 1574119848, "post_id": 58910948, "comment_id": 104110404, "body": "Actually, you can put whatever you want in a scope, I can mix and match <code>fn</code>, <code>mod</code>, <code>struct</code>, <code>enum</code>, <code>union</code>, <code>type</code> aliases, <code>trait</code>s, <code>const</code>s, <code>extern</code>, <code>static</code>[<code>mut</code>], etc; with some restrictions (IE, you cannot put anything other than members inside a <code>struct</code>/<code>enum</code>/<code>union</code> declaration)"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 1, "last_activity_date": 1574175002, "last_edit_date": 1574175002, "creation_date": 1574067526, "answer_id": 58910948, "question_id": 58906769, "link": "https://stackoverflow.com/questions/58906769/how-can-i-access-a-global-c-array-of-structs-from-a-rust-library/58910948#58910948", "title": "How can I access a global C array of structs from a Rust library?", "body": "<p>You must calculate the length of your C array before creating the slice with <code>from_raw_parts</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use libc::{c_char, c_int};\n\n#[repr(C)]\npub struct GlkUnixArgument {\n    name: *const c_char,\n    argtype: c_int,\n    desc: *const c_char,\n}\n\npub unsafe fn glkunix_arguments() -&gt; &amp;'static [GlkUnixArgument] {\n    extern \"C\" {\n        pub static glkunix_arguments: *const GlkUnixArgument;\n    }\n\n    let len = (0..)\n        .take_while(|i| {\n            let arg = glkunix_arguments.offset(*i);\n            (*arg).name != std::ptr::null()\n                || (*arg).argtype != 0\n                || (*arg).desc != std::ptr::null()\n        })\n        .count();\n\n    std::slice::from_raw_parts(glkunix_arguments, len)\n}\n</code></pre>\n\n<p>You can even map the C struct to a Rust struct:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use libc::{c_char, c_int, strlen};\nuse std::{ptr, slice, str};\n\npub struct GlkUnixArgument {\n    pub name: &amp;'static str,\n    pub argtype: i32,\n    pub desc: &amp;'static str,\n}\n\npub unsafe fn glkunix_arguments() -&gt; Vec&lt;GlkUnixArgument&gt; {\n    extern \"C\" {\n        pub static glkunix_arguments: *const GlkUnixArgument_;\n    }\n\n    #[repr(C)]\n    pub struct GlkUnixArgument_ {\n        name: *const c_char,\n        argtype: c_int,\n        desc: *const c_char,\n    }\n\n    impl GlkUnixArgument_ {\n        fn is_not_empty(&amp;self) -&gt; bool {\n            self.name != ptr::null() || self.argtype != 0 || self.desc != ptr::null()\n        }\n    }\n\n    unsafe fn c_str_to_rust_str(s: *const i8) -&gt; &amp;'static str {\n        str::from_utf8(slice::from_raw_parts(s as *const u8, strlen(s))).unwrap()\n    }\n\n    let len = (0..)\n        .map(|i| glkunix_arguments.offset(i))\n        .take_while(|&amp;arg| (*arg).is_not_empty())\n        .count();\n\n    slice::from_raw_parts(glkunix_arguments, len)\n        .iter()\n        .map(|args| GlkUnixArgument {\n            name: c_str_to_rust_str(args.name),\n            desc: c_str_to_rust_str(args.desc),\n            argtype: args.argtype,\n        })\n        .collect()\n}\n</code></pre>\n\n<p>Using a lazy construct can ensure that you're doing the operation only once.</p>\n"}], "owner": {"reputation": 1035, "user_id": 2854284, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/a66cede09ad91417502051a3a146210a?s=128&d=identicon&r=PG", "display_name": "curiousdannii", "link": "https://stackoverflow.com/users/2854284/curiousdannii"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 365, "favorite_count": 0, "accepted_answer_id": 58910948, "answer_count": 1, "score": 2, "last_activity_date": 1574175002, "creation_date": 1574039203, "last_edit_date": 1574043798, "question_id": 58906769, "link": "https://stackoverflow.com/questions/58906769/how-can-i-access-a-global-c-array-of-structs-from-a-rust-library", "title": "How can I access a global C array of structs from a Rust library?", "body": "<p>I am porting a static library to Rust that will be linked with a C application which will provide a global array. Here is the definition of the struct and array:</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>typedef struct glkunix_argumentlist_struct {\n    char *name;\n    int argtype;\n    char *desc;\n} glkunix_argumentlist_t;\nextern glkunix_argumentlist_t glkunix_arguments[];\n</code></pre>\n\n<p>There is no length parameter, instead the last entry in the array will be <code>{NULL, 0, NULL}</code> (<a href=\"https://github.com/erkyrath/glulxe/blob/master/unixstrt.c#L28\" rel=\"nofollow noreferrer\">example</a>), which you test for when looping through the array.</p>\n\n<p>I think this is the correct Rust representation for the struct:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[repr(C)]\nstruct GlkUnixArgument {\n    name: *const c_char,\n    argtype: c_int,\n    desc: *const c_char,\n}\n</code></pre>\n\n<p>The Rust Nomicon <a href=\"https://doc.rust-lang.org/nomicon/ffi.html#accessing-foreign-globals\" rel=\"nofollow noreferrer\">shows how to define an extern for a single integer</a>.</p>\n\n<p>I've seen that if you have a length parameter <a href=\"https://s3.amazonaws.com/temp.michaelfbryan.com/arrays/index.html#receiving-an-array-from-c\" rel=\"nofollow noreferrer\">you can use <code>std::slice::from_raw_parts</code> to get a slice</a>, but we don't have a length yet. I could modify the C code to provide one, but I would like to be able to provide a drop-in replacement if I can.</p>\n\n<p>I haven't yet seen how to just create one single Rust struct from a extern. Though I did just have the idea of just <code>std::slice::from_raw_parts</code> with a length of 1.</p>\n\n<p>Is there a better way to more directly define an extern struct in Rust?</p>\n"}, {"tags": ["unit-testing", "testing", "rust", "conditional-compilation"], "comments": [{"owner": {"reputation": 6608, "user_id": 4497253, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dc929d11ae26463d18e337d295c86fcc?s=128&d=identicon&r=PG&f=1", "display_name": "CoronA", "link": "https://stackoverflow.com/users/4497253/corona"}, "edited": false, "score": 0, "creation_date": 1574053110, "post_id": 58906379, "comment_id": 104078843, "body": "Have you tried <code>cargo test -- --features foo testing_with_foo</code> (note the <code>--</code>)."}], "answers": [{"comments": [{"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 3, "creation_date": 1574064009, "post_id": 58907673, "comment_id": 104082568, "body": "Or to be closer to what the OP wants: <code>assert!(cfg!(feature = &quot;foo&quot;));</code>"}], "tags": [], "owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "is_accepted": false, "score": 1, "last_activity_date": 1574048133, "creation_date": 1574048133, "answer_id": 58907673, "question_id": 58906379, "link": "https://stackoverflow.com/questions/58906379/how-does-one-test-optional-features-in-rust/58907673#58907673", "title": "How does one test optional features in Rust?", "body": "<p>Your test is incorrect. Quoting <a href=\"https://doc.rust-lang.org/cargo/reference/manifest.html\" rel=\"nofollow noreferrer\">the Cargo book</a>:</p>\n\n<blockquote>\n  <p>This can be tested in code via <code>#[cfg(feature = \"foo\")]</code>.</p>\n</blockquote>\n"}, {"tags": [], "owner": {"reputation": 55, "user_id": 3501996, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56cb74999a5c91fb17fb140ceaa5bebc?s=128&d=identicon&r=PG", "display_name": "dfhoughton", "link": "https://stackoverflow.com/users/3501996/dfhoughton"}, "is_accepted": true, "score": 1, "last_activity_date": 1575388833, "creation_date": 1575388833, "answer_id": 59160947, "question_id": 58906379, "link": "https://stackoverflow.com/questions/58906379/how-does-one-test-optional-features-in-rust/59160947#59160947", "title": "How does one test optional features in Rust?", "body": "<p>The solution is what @Jmb proposed: <code>assert!(cfg!(feature = \"foo\"));</code>. What it says in the Cargo Book</p>\n\n<blockquote>\n  <p>This can be tested in code via <code>#[cfg(feature = \"foo\")]</code>.</p>\n</blockquote>\n\n<p>allows one to confirm that conditional compilation works but doesn't provide a boolean value one can test against. If you want to branch based on the feature at runtime, you need <code>cfg!</code>.</p>\n"}], "owner": {"reputation": 55, "user_id": 3501996, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56cb74999a5c91fb17fb140ceaa5bebc?s=128&d=identicon&r=PG", "display_name": "dfhoughton", "link": "https://stackoverflow.com/users/3501996/dfhoughton"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 575, "favorite_count": 1, "accepted_answer_id": 59160947, "answer_count": 2, "score": 3, "last_activity_date": 1575388833, "creation_date": 1574035033, "question_id": 58906379, "link": "https://stackoverflow.com/questions/58906379/how-does-one-test-optional-features-in-rust", "title": "How does one test optional features in Rust?", "body": "<p>I have a package I want to add an optional feature to. I've added an appropriate section to my Cargo.toml:</p>\n\n<pre><code>[features]\nfoo = []\n</code></pre>\n\n<p>I wrote an experimental test for the basic functionality of the <code>cfg!</code> macro:</p>\n\n<pre><code>#[test]\nfn testing_with_foo() {\n    assert!(cfg!(foo));\n}\n</code></pre>\n\n<p>It looks as though I can activate features during testing via either of the options <code>--features</code> or <code>--all-features</code>:</p>\n\n<pre><code>(master *=) $ cargo help test\ncargo-test \nExecute all unit and integration tests and build examples of a local package\n\nUSAGE:\n    cargo test [OPTIONS] [TESTNAME] [-- &lt;args&gt;...]\n\nOPTIONS:\n    -q, --quiet                      Display one character per test instead of one line\n        ...\n        --features &lt;FEATURES&gt;...     Space-separated list of features to activate\n        --all-features               Activate all available features\n</code></pre>\n\n<p>Neither <code>cargo test --features foo testing_with_foo</code> nor <code>cargo test --all-features testing_with_foo</code> works, though.</p>\n\n<p>What is the proper way to do this?</p>\n"}, {"tags": ["rust", "char", "slice"], "answers": [{"tags": [], "owner": {"reputation": 7716, "user_id": 4639273, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ae38603d40c633012992337a32330fa0?s=128&d=identicon&r=PG", "display_name": "SCappella", "link": "https://stackoverflow.com/users/4639273/scappella"}, "is_accepted": true, "score": 7, "last_activity_date": 1574035078, "creation_date": 1574035078, "answer_id": 58906388, "question_id": 58906030, "link": "https://stackoverflow.com/questions/58906030/is-there-a-better-way-to-test-if-a-char-is-whitespace-than-converting-it-to-a-st/58906388#58906388", "title": "Is there a better way to test if a char is whitespace than converting it to a string?", "body": "<p>Instead of using regex for this problem, you can use <a href=\"https://doc.rust-lang.org/stable/std/primitive.char.html#method.is_whitespace\" rel=\"noreferrer\"><code>char::is_whitespace</code></a>. It should have the same behavior and will likely be more efficient, depending on compiler optimizations. In any case, not depending on the <code>regex</code> crate is a gain.</p>\n\n<p>The only real difference is that <code>char::is_whitespace</code> takes <code>self</code> rather than <code>&amp;self</code>. If you're worried about that, don't be. Using <code>&amp;char</code> over <code>char</code> has no gain since <code>char</code> implements <code>Copy</code>. In fact, since <code>char</code>s are 4 bytes, it'll typically be <em>more</em> efficient to pass the characters directly, rather than an 8 byte pointer. And that's not even taking into account the extra layer of indirection.</p>\n\n<p>If you insist on using the approach you have, it can be simplified to</p>\n\n<pre><code>use regex::Regex;\n\nfn is_any_whitespace(ch: &amp;char) -&gt; bool {\n    let re = Regex::new(r\"\\s\").unwrap();\n    re.is_match(&amp;ch.to_string())\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9b974814a860a853acdb9894bc2b3d1b\" rel=\"noreferrer\">(playground)</a></p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 98, "favorite_count": 0, "accepted_answer_id": 58906388, "answer_count": 1, "score": 0, "last_activity_date": 1574092648, "creation_date": 1574031686, "last_edit_date": 1574092587, "question_id": 58906030, "link": "https://stackoverflow.com/questions/58906030/is-there-a-better-way-to-test-if-a-char-is-whitespace-than-converting-it-to-a-st", "title": "Is there a better way to test if a char is whitespace than converting it to a string?", "body": "<p>I have a function that checks if a <code>char</code> is whitespace:</p>\n\n<pre><code>fn is_any_whitespace(ch: &amp;char) -&gt; bool {\n    let re = Regex::new(r\"\\s\").unwrap();\n    let slice = &amp;ch.to_string()[..];\n    re.is_match(slice)\n}\n</code></pre>\n\n<p>What bothers me is the part where I convert <code>char</code> to <code>&amp;str</code> (<code>&amp;str</code> is the type of the parameter that <code>is_match</code> accepts):</p>\n\n<pre><code>&amp;ch.to_string()[..]\n</code></pre>\n\n<p>Can it be done more elegantly and efficiently?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "edited": false, "score": 0, "creation_date": 1574048425, "post_id": 58905915, "comment_id": 104077914, "body": "Could you add the <code>transfer_server_client_packet</code> and <code>transfer_client_server_packet</code> signatures? It&#39;s already pretty clear what&#39;s going on (in short, they shouldn&#39;t take <code>self</code> if they don&#39;t have to), but this should simplify things both for us and for future readers."}, {"owner": {"reputation": 6608, "user_id": 4497253, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dc929d11ae26463d18e337d295c86fcc?s=128&d=identicon&r=PG&f=1", "display_name": "CoronA", "link": "https://stackoverflow.com/users/4497253/corona"}, "reply_to_user": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "edited": false, "score": 0, "creation_date": 1574055407, "post_id": 58905915, "comment_id": 104079398, "body": "Wrap your connection into an <code>Arc&lt;&gt;</code>. This will solve the <code>moved value</code> problem. Yet your method signatures will probably contain <code>&amp;mut self</code> which will cause a new problem because <code>Arc</code> alone will not be allowed to be borrowed mutably. You should then consider a solution with internal mutability. First add the signatures as @Cerberus mentioned."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 2, "last_activity_date": 1574069436, "creation_date": 1574069436, "answer_id": 58911489, "question_id": 58905915, "link": "https://stackoverflow.com/questions/58905915/how-to-fix-moved-value-problem-with-a-tcpstream/58911489#58911489", "title": "How to fix &quot;moved value&quot; problem with a TcpStream?", "body": "<p>Once you move a value \u2014 in this case, the <code>Connection</code> \u2014 you can't use it again. If you need two threads to have mutable access to the same connection then you can either clone it or share it using synchronisation primitives, such as <code>Arc</code>.</p>\n\n<p>For example:</p>\n\n<pre><code>let connection = Arc::new(Mutex::new(Connection::new()));\nlet connection_server_client = Arc::clone(&amp;connection);\nlet connection_client_server = Arc::clone(&amp;connection);\n\nthread::spawn(move || loop {\n    let connection = connection_server_client.lock().unwrap();\n    connection.transfer_server_client_packet();\n});\n\nthread::spawn(move || loop {\n    let connection = connection_client_server.lock().unwrap();\n    connection.transfer_client_server_packet();\n});\n</code></pre>\n\n<p>This setup manages the shared resource so that only one thread can mutate it at a time. It also will make sure that the resource is dropped when both threads have finished with it.</p>\n\n<hr>\n\n<p>Having said that, I would consider a refactor of your code: the two threads do not actually need the same <code>TcpStream</code>s. The only reason that sharing becomes necessary is that you have stored both streams in the same struct, meaning that you can't borrow one without also borrowing the other.</p>\n"}], "owner": {"reputation": 9, "user_id": 12388489, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/53c9e0c62aa4fa34315420132ba24867?s=128&d=identicon&r=PG&f=1", "display_name": "FrancoisDtm", "link": "https://stackoverflow.com/users/12388489/francoisdtm"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 78, "favorite_count": 0, "closed_date": 1574092807, "answer_count": 1, "score": 0, "last_activity_date": 1574092832, "creation_date": 1574030564, "last_edit_date": 1574092741, "question_id": 58905915, "link": "https://stackoverflow.com/questions/58905915/how-to-fix-moved-value-problem-with-a-tcpstream", "closed_reason": "Duplicate", "title": "How to fix &quot;moved value&quot; problem with a TcpStream?", "body": "<p>I am trying to transmit packets/bytes from a <code>TcpStream</code> to another and vice-versa. I've created a struct <code>Connection</code>:</p>\n\n<pre><code>pub struct Connection {\n    pub client_socket: TcpStream,\n    pub server_socket: TcpStream\n}\n</code></pre>\n\n<p>I'm trying to open two threads so I can transmit all bytes in both directions. Sadly I'm trying to use a moved value because I called connection a second time. How can I fix that ?</p>\n\n<pre><code>thread::spawn(move || loop { connection.transfer_server_client_packet(); });\nthread::spawn(move || loop { connection.transfer_client_server_packet(); });\n</code></pre>\n\n<pre><code>impl Connection {\n    fn get_packet(&amp;mut self, from_client: bool) -&gt; Result&lt;Packet, io::Error&gt; {\n        unimplemented!()\n    }\n    pub fn get_client_packet(&amp;mut self) -&gt; Result&lt;Packet, io::Error&gt; {\n        self.get_packet(true)\n    }\n    pub fn get_server_packet(&amp;mut self) -&gt; Result&lt;Packet, io::Error&gt; {\n        self.get_packet(false)\n    }\n    fn send_packet(&amp;mut self, from_client: bool, mut packet: Packet) -&gt; Result&lt;Packet, io::Error&gt; {\n        unimplemented!()\n    }\n    pub fn send_client_packet(&amp;mut self, packet: Packet) -&gt; Result&lt;Packet, io::Error&gt; {\n        self.send_packet(true, packet)\n    }\n    pub fn send_server_packet(&amp;mut self, packet: Packet) -&gt; Result&lt;Packet, io::Error&gt; {\n        self.send_packet(false, packet)\n    }\n    fn transfer_packet(&amp;mut self, from_client: bool, to_client: bool) -&gt; Result&lt;usize, io::Error&gt; {\n        let packet = if from_client {\n            self.get_client_packet()?\n        } else {\n            self.get_server_packet()?\n        };\n        if to_client {\n            self.send_client_packet(packet)?\n        } else {\n            self.send_server_packet(packet)?\n        };\n        Ok(0)\n    }\n    pub fn transfer_client_server_packet(&amp;mut self) -&gt; Result&lt;usize, io::Error&gt; {\n        self.transfer_packet(true, false)\n    }\n    pub fn transfer_server_client_packet(&amp;mut self) -&gt; Result&lt;usize, io::Error&gt; {\n        self.transfer_packet(false, true)\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "nom"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574021494, "post_id": 58904604, "comment_id": 104072152, "body": "It seems, that you are (still) using nom4. There&#39;s a new version (5) which kind of obsoletes the macros, e.g. <code>names!</code> and uses functions instead. You can take a look at <a href=\"https://docs.rs/nom/5.0.1/nom/\" rel=\"nofollow noreferrer\">docs.rs/nom/5.0.1/nom</a>"}, {"owner": {"reputation": 2167, "user_id": 459877, "user_type": "registered", "accept_rate": 71, "profile_image": "https://i.stack.imgur.com/QdrXY.jpg?s=128&g=1", "display_name": "beta", "link": "https://stackoverflow.com/users/459877/beta"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1574021743, "post_id": 58904604, "comment_id": 104072210, "body": "@hellow: Maybe&#39;s that&#39;s where the disconnect is? I could very well be misunderstanding something\u2026 I <i>am</i> actually using Nom 5.0.1, but I&#39;m still using many of the macros because if I go to <a href=\"https://docs.rs/nom/5.0.1/nom/character/complete/index.html\" rel=\"nofollow noreferrer\">docs.rs/nom/5.0.1/nom/character/complete/index.html</a>, there are very few combinators, and nothing like <code>escaped</code> or <code>take_till</code>. For bytes there <i>is</i> an <code>escaped</code> function (<a href=\"https://docs.rs/nom/5.0.1/nom/bytes/complete/fn.escaped.html\" rel=\"nofollow noreferrer\">docs.rs/nom/5.0.1/nom/bytes/complete/fn.escaped.html</a>), but I&#39;m not working on bytes, I&#39;m working on (unicode) text."}], "answers": [{"comments": [{"owner": {"reputation": 2167, "user_id": 459877, "user_type": "registered", "accept_rate": 71, "profile_image": "https://i.stack.imgur.com/QdrXY.jpg?s=128&g=1", "display_name": "beta", "link": "https://stackoverflow.com/users/459877/beta"}, "edited": false, "score": 0, "creation_date": 1574074312, "post_id": 58907488, "comment_id": 104087756, "body": "Thanks! I was under the (false) impression that the functions from <code>nom::bytes</code> woudn&#39;t work for <code>&amp;str</code>, but it seems that it even works if I change the delimiters from single quotes to e.g. \ud83e\udd50!"}], "tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 1, "last_activity_date": 1574046330, "creation_date": 1574046330, "answer_id": 58907488, "question_id": 58904604, "link": "https://stackoverflow.com/questions/58904604/parsing-single-quoted-string-with-escaped-quotes-with-nom-5/58907488#58907488", "title": "Parsing single-quoted string with escaped quotes with Nom 5", "body": "<p>When operating in the so-called streaming mode, <code>nom</code> may returns <code>Incomplete</code> to indicate that it can't decide and needs more data. The <code>nom</code> 4 introduced <code>CompleteStr</code>. Alongside with <code>CompleteByteSlice</code>, they were complete input counterpart of <code>&amp;str</code> and <code>&amp;[u8]</code>. The parsers taken them as input work in complete mode.</p>\n\n<p>They are gone in <code>nom</code> 5. In <code>nom</code> 5, macro based parsers always work in streaming mode as you've observed. For parser combinators that would work differently in streaming and complete mode, there are different versions of them in separate sub-modules, such as <code>nom::bytes::streaming</code> and <code>nom::bytes::complete</code>.</p>\n\n<p>For all these gory details you may want to check out <a href=\"http://unhandledexpression.com/general/2019/06/17/nom-5-is-here.html\" rel=\"nofollow noreferrer\">this blog post</a>, especially the section <em>Streaming VS complete parsers</em>.</p>\n\n<p>Also, the function combinators are preferred over the macro ones in <code>nom</code> 5. Here is one way to do it:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>//# nom = \"5.0.1\"\nuse nom::{\n    branch::alt,\n    bytes::complete::{escaped, tag},\n    character::complete::none_of,\n    sequence::delimited,\n    IResult,\n};\n\nfn main() {\n    let (_, res) = parse_quoted(r#\"'foo\\' \ud83e\udd16 bar'\"#).unwrap();\n    assert_eq!(res, r#\"foo\\' \ud83e\udd16 bar\"#);\n    let (_, res) = parse_quoted(\"'\u03bbx \u2192 x'\").unwrap();\n    assert_eq!(res, \"\u03bbx \u2192 x\");\n    let (_, res) = parse_quoted(\"'  '\").unwrap();\n    assert_eq!(res, \"  \");\n    let (_, res) = parse_quoted(\"''\").unwrap();\n    assert_eq!(res, \"\");\n}\n\nfn parse_quoted(input: &amp;str) -&gt; IResult&lt;&amp;str, &amp;str&gt; {\n    let esc = escaped(none_of(\"\\\\\\'\"), '\\\\', tag(\"'\"));\n    let esc_or_empty = alt((esc, tag(\"\")));\n    let res = delimited(tag(\"'\"), esc_or_empty, tag(\"'\"))(input)?;\n\n    Ok(res)\n}\n</code></pre>\n"}], "owner": {"reputation": 2167, "user_id": 459877, "user_type": "registered", "accept_rate": 71, "profile_image": "https://i.stack.imgur.com/QdrXY.jpg?s=128&g=1", "display_name": "beta", "link": "https://stackoverflow.com/users/459877/beta"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 696, "favorite_count": 0, "accepted_answer_id": 58907488, "answer_count": 1, "score": 1, "last_activity_date": 1574046330, "creation_date": 1574020598, "question_id": 58904604, "link": "https://stackoverflow.com/questions/58904604/parsing-single-quoted-string-with-escaped-quotes-with-nom-5", "title": "Parsing single-quoted string with escaped quotes with Nom 5", "body": "<p>I'm new to Rust and Nom and I'm trying to parse a (single) quoted string which may contain escaped quotes, e.g. <code>'foo\\' \ud83e\udd16 bar'</code> or <code>'\u03bbx \u2192 x'</code>, <code>''</code> or <code>'  '</code>.</p>\n\n<p>I found the <code>escaped!</code> macro, whose <a href=\"https://docs.rs/nom/5.0.1/nom/macro.escaped.html\" rel=\"nofollow noreferrer\">documentation</a> says:</p>\n\n<blockquote>\n  <p>The first argument matches the normal characters (it must not accept the control character), the second argument is the control character (like \\ in most languages), the third argument matches the escaped characters</p>\n</blockquote>\n\n<p>Since I want to match anything but a backslash in the matcher for \u201cnormal characters\u201d, I tried using <a href=\"https://docs.rs/nom/5.0.1/nom/macro.take_till.html\" rel=\"nofollow noreferrer\"><code>take_till!</code></a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>    named!(till_backslash&lt;&amp;str, &amp;str&gt;, take_till!(|ch| ch == '\\\\'));\n    named!(esc&lt;&amp;str, &amp;str&gt;, escaped!(call!(till_backslash), '\\\\', one_of!(\"'n\\\\\")));\n\n    let (input, _) = nom::character::complete::char('\\'')(input)?;\n    let (input, value) = esc(input)?;\n    let (input, _) = nom::character::complete::char('\\'')(input)?;\n\n    // \u2026 use `value`\n</code></pre>\n\n<p>However, when trying to parse <code>'x'</code>, this returns <code>Err(Incomplete(Size(1)))</code>. When searching for this, people generally recommend using <code>CompleteStr</code>, but that's not in Nom 5. What's the correct way to approach this problem?</p>\n"}, {"tags": ["error-handling", "rust", "refactoring"], "comments": [{"owner": {"reputation": 3201, "user_id": 5986907, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/0521ce05a7fcb2580e4f513990a5a8c8?s=128&d=identicon&r=PG&f=1", "display_name": "joel", "link": "https://stackoverflow.com/users/5986907/joel"}, "edited": false, "score": 0, "creation_date": 1574022379, "post_id": 58904410, "comment_id": 104072409, "body": "one idea: abstract out some bits as functions?"}, {"owner": {"reputation": 235, "user_id": 4014075, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/dfac6f770d9e6b2a82d909382d7da9c6?s=128&d=identicon&r=PG", "display_name": "naiveai", "link": "https://stackoverflow.com/users/4014075/naiveai"}, "reply_to_user": {"reputation": 3201, "user_id": 5986907, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/0521ce05a7fcb2580e4f513990a5a8c8?s=128&d=identicon&r=PG&f=1", "display_name": "joel", "link": "https://stackoverflow.com/users/5986907/joel"}, "edited": false, "score": 0, "creation_date": 1574050712, "post_id": 58904410, "comment_id": 104078362, "body": "@JoelBerkeley well, sure, but most of the actual work here is just one big addition and subtraction, and those seem too coupled to each other to really be separable in their current state."}], "answers": [{"tags": [], "owner": {"reputation": 2330, "user_id": 939467, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/5c2ca1b3b94f649a13dfdee859a4db07?s=128&d=identicon&r=PG", "display_name": "Evan", "link": "https://stackoverflow.com/users/939467/evan"}, "is_accepted": true, "score": 5, "last_activity_date": 1574093256, "last_edit_date": 1574093256, "creation_date": 1574051355, "answer_id": 58907999, "question_id": 58904410, "link": "https://stackoverflow.com/questions/58904410/how-can-i-simplify-this-horribly-nested-error-handling-code-in-rust/58907999#58907999", "title": "How can I simplify this horribly nested error handling code in Rust?", "body": "<p>Here are some things you can try:</p>\n\n<ol>\n<li><p>Use an array, not nested <code>Vec</code>s. With an array, you can guarantee that all the rows have the same width, and <code>NonRectError</code> can't happen. (But maybe you have good reasons to use nested <code>Vec</code>s, so the rest of my examples use nested <code>Vec</code>s.)</p></li>\n<li><p>The block where you calculate <code>summed_value</code> is pretty long. I'd break it up like this:</p>\n\n<pre><code>// I(x, y - 1)\nlet north = ...;\n\n// I(x - 1, y)\nlet west = ...;\n\n// I(x - 1, y - 1)\nlet northwest = ...;\n\nlet summed_values = value + north + west - northwest;\n</code></pre></li>\n<li><p>Instead of checked subtraction, it's easier to check if <code>xi</code> and <code>yi</code> are nonzero. Also, <a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.ok_or\" rel=\"nofollow noreferrer\"><code>.ok_or()</code></a> is a good way to convert <code>None</code> to an error.</p>\n\n<pre><code>let northwest = match (xi, yi) {\n    (0, _) =&gt; 0,\n    (_, 0) =&gt; 0,\n    (_, _) =&gt; {\n        // We know xi and yi are nonzero, so we can subtract without checks\n        summed_area_table.get(yi - 1)\n            .and_then(|row| row.get(xi - 1))\n            .ok_or(NonRectError { xi, yi })?\n    }\n};\n</code></pre>\n\n<p>You could also write that with an <code>if/else</code> chain. They're both idiomatic, it's just a matter of preference. I prefer <code>match</code> because it feels more concise.</p>\n\n<pre><code>let northwest = if xi == 0 {\n    0\n} else if yi == 0 {\n    0\n} else {\n    // same as above\n};\n</code></pre></li>\n</ol>\n"}], "owner": {"reputation": 235, "user_id": 4014075, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/dfac6f770d9e6b2a82d909382d7da9c6?s=128&d=identicon&r=PG", "display_name": "naiveai", "link": "https://stackoverflow.com/users/4014075/naiveai"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 160, "favorite_count": 0, "accepted_answer_id": 58907999, "answer_count": 1, "score": 1, "last_activity_date": 1574233973, "creation_date": 1574019260, "last_edit_date": 1574097679, "question_id": 58904410, "link": "https://stackoverflow.com/questions/58904410/how-can-i-simplify-this-horribly-nested-error-handling-code-in-rust", "title": "How can I simplify this horribly nested error handling code in Rust?", "body": "<p>I'm writing a function to compute a <a href=\"https://en.wikipedia.org/wiki/Summed-area_table#cite_note-5\" rel=\"nofollow noreferrer\">Summed Area Table</a> of a <code>Vec&lt;Vec&lt;isize&gt;&gt;</code> in Rust, without the use of any external crates. I'm trying to learn to do this as idiomatically as possible, but I'm running into some roadblocks with error handling.</p>\n\n<p>Basically all I'm trying to do is this, which is mentioned on the Wikipedia page:</p>\n\n<blockquote>\n  <p>The summed-area table can be computed efficiently in a single pass\n  over the image, as the value in the summed-area table at (x, y) is\n  just:</p>\n  \n  <p><img src=\"https://latex.codecogs.com/gif.latex?I(x,y)=i(x,y)&plus;I(x,y-1)&plus;I(x-1,y)-I(x-1,y-1)\" title=\"I(x,y)=i(x,y)+I(x,y-1)+I(x-1,y)-I(x-1,y-1)\" /></p>\n  \n  <p>where <code>i</code> provides values from the grid, and <code>I</code> from the previously\n  computed values of the table. Obviously, if x or y is 0, then some of\n  these won't exist, in which case they are replaced with <code>0</code>.</p>\n</blockquote>\n\n<p>However, of note is the fact that if <code>I(x, y - 1)</code> does not exist even if <code>y - 1</code> exists, then the grid we're working with is in fact non-rectangular, and we want to return an <code>NonRectError</code> in that case.</p>\n\n<p>With all that background, here's the code: I need to protect against overflow errors from the subtractions, and return the <code>NonRectError</code> in the special case:</p>\n\n<pre><code>fn compute_summed_area_table(grid: &amp;Vec&lt;Vec&lt;isize&gt;&gt;) -&gt; Result&lt;Vec&lt;Vec&lt;isize&gt;&gt;, NonRectError&gt; {\n    let mut summed_area_table =\n        vec![Vec::with_capacity(grid[0].len()); grid.len()];\n\n    for (yi, row) in grid.iter().enumerate() {\n        for (xi, &amp;value) in row.iter().enumerate() {\n            let (prev_row, prev_column_idx) = (\n                yi.checked_sub(1).and_then(|i| summed_area_table.get(i)),\n                xi.checked_sub(1)\n            );\n\n            let summed_values =\n                value +\n                // I(x, y - 1)\n                match prev_row {\n                    None =&gt; &amp;0,\n                    Some(prev_row_vec) =&gt; match prev_row_vec.get(xi) {\n                        Some(v) =&gt; v,\n                        None =&gt; return Err(NonRectError { xi, yi })\n                    }\n                } +\n                // I(x - 1, y)\n                (prev_column_idx\n                     .and_then(|i| summed_area_table[yi].get(i))\n                     .unwrap_or(&amp;0)) -\n                // I(x - 1, y - 1)\n                (prev_row\n                     .map_or(&amp;0, |r| {\n                         prev_column_idx\n                             .and_then(|i| r.get(i))\n                             .unwrap_or(&amp;0)\n                     }));\n\n            summed_area_table[yi].push(summed_values);\n        }\n    }\n\n    Ok(summed_area_table)\n}\n\n// Omitted the definition of NonRectError here, but it is defined.\n</code></pre>\n\n<p>This code is clearly the definition of sin itself, but I'm not sure which angle to approach simplifying this from - there are so many gosh darn edge cases!</p>\n\n<p>Are there any built-in methods that'll allow me to escape this nested error-checking stuff? Can I return the <code>NonRectError</code> in some easier way than this?</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 2149, "user_id": 381697, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/8b688235379811c6092edbcea5f418ce?s=128&d=identicon&r=PG", "display_name": "Josh Peterson", "link": "https://stackoverflow.com/users/381697/josh-peterson"}, "edited": false, "score": 0, "creation_date": 1574024853, "post_id": 58904158, "comment_id": 104073134, "body": "Thank you! I was not aware that the impl did not pick up the Copy trait, but that makes sense."}, {"owner": {"reputation": 3201, "user_id": 5986907, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/0521ce05a7fcb2580e4f513990a5a8c8?s=128&d=identicon&r=PG&f=1", "display_name": "joel", "link": "https://stackoverflow.com/users/5986907/joel"}, "reply_to_user": {"reputation": 2149, "user_id": 381697, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/8b688235379811c6092edbcea5f418ce?s=128&d=identicon&r=PG", "display_name": "Josh Peterson", "link": "https://stackoverflow.com/users/381697/josh-peterson"}, "edited": false, "score": 0, "creation_date": 1574028734, "post_id": 58904158, "comment_id": 104074175, "body": "@JoshPeterson they&#39;re intentionally not automatically carried over, so that you can define methods for specific subsets of type parameters (e.g. only <code>Matrix&lt;u32&gt;</code>)"}], "tags": [], "owner": {"reputation": 3201, "user_id": 5986907, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/0521ce05a7fcb2580e4f513990a5a8c8?s=128&d=identicon&r=PG&f=1", "display_name": "joel", "link": "https://stackoverflow.com/users/5986907/joel"}, "is_accepted": true, "score": 2, "last_activity_date": 1574018445, "last_edit_date": 1574018445, "creation_date": 1574017761, "answer_id": 58904158, "question_id": 58904006, "link": "https://stackoverflow.com/questions/58904006/how-can-i-return-a-generic-type-from-a-member-function-in-rust/58904158#58904158", "title": "How can I return a generic type from a member function in Rust", "body": "<p>In <code>eq</code>, <code>self</code> is a <code>Matrix&lt;T&gt; where T: PartialEq</code> as that's the bound for the <code>impl</code> where <code>eq</code> is defined. Calling <code>get</code> on it requires it's a <code>Matrix&lt;T&gt; where T: Copy</code> as that's the bound on the <code>impl</code> where <code>get</code> is defined. This is what the error message means:</p>\n\n<blockquote>\n  <p>the method <code>get</code> exists but the following trait bounds were not satisfied:\n             <code>T : std::marker::Copy</code></p>\n</blockquote>\n\n<p>A type bound on one impl doesn't automatically get carried on to other impls.</p>\n\n<p>You could fix this with</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>    impl&lt;T&gt; PartialEq for Matrix&lt;T&gt;\n    where\n        T: PartialEq + Copy\n</code></pre>\n\n<p>Or if you don't want to require this, you could return an <code>&amp;T</code> from <code>get</code> and drop the <code>where T: Copy</code></p>\n"}], "owner": {"reputation": 2149, "user_id": 381697, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/8b688235379811c6092edbcea5f418ce?s=128&d=identicon&r=PG", "display_name": "Josh Peterson", "link": "https://stackoverflow.com/users/381697/josh-peterson"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 65, "favorite_count": 0, "accepted_answer_id": 58904158, "answer_count": 1, "score": 0, "last_activity_date": 1574018445, "creation_date": 1574016686, "question_id": 58904006, "link": "https://stackoverflow.com/questions/58904006/how-can-i-return-a-generic-type-from-a-member-function-in-rust", "title": "How can I return a generic type from a member function in Rust", "body": "<p>I'm trying to write a generic matrix class in Rust. I'd like to have a <code>get</code> member function that returns a copy of the element at a given index in the matrix. The code currently looks like this:</p>\n\n<pre><code>mod math {\n    pub struct Matrix&lt;T&gt; {\n        rows: usize,\n        columns: usize,\n        data: Vec&lt;T&gt;,\n    }\n\n    impl&lt;T&gt; Matrix&lt;T&gt; where T: Copy {\n        pub fn empty(rows: usize, columns: usize) -&gt; Matrix&lt;T&gt; {\n            return Matrix {\n                rows: rows,\n                columns: columns,\n                data: Vec::with_capacity(rows * columns),\n            };\n        }\n\n        pub fn get(&amp;self, row: usize, column: usize) -&gt; T {\n            return self.data[column + row * self.columns];\n        }\n    }\n\n    impl&lt;T&gt; PartialEq for Matrix&lt;T&gt;\n    where\n        T: PartialEq,\n    {\n        fn eq(&amp;self, other: &amp;Self) -&gt; bool {\n            if self.rows != other.rows || self.columns != other.columns {\n                return true;\n            }\n\n            for i in 0..self.rows {\n                for j in 0..self.columns {\n                    if self.get(i, j) != other.get(i, j) {\n                        return false;\n                    }\n                }\n            }\n\n            return true;\n        }\n    }\n}\n</code></pre>\n\n<p>I get the following error from the Rust compiler (version 1.39.0):</p>\n\n<pre><code>error[E0599]: no method named `get` found for type `&amp;math::Matrix&lt;T&gt;` in the current scope\n  --&gt; &lt;source&gt;:33:29\n   |\n33 |                     if self.get(i, j) != other.get(i, j) {\n   |                             ^^^ method not found in `&amp;math::Matrix&lt;T&gt;`\n   |\n   = note: the method `get` exists but the following trait bounds were not satisfied:\n           `T : std::marker::Copy`\n   = help: items from traits can only be used if the trait is implemented and in scope\n   = note: the following traits define an item `get`, perhaps you need to implement one of them:\n           candidate #1: `core::panic::BoxMeUp`\n           candidate #2: `std::slice::SliceIndex`\n</code></pre>\n\n<p>I'm struggling to understand what this error means. Is there some additional trait I need to use to constrain the <code>T</code> type?</p>\n"}, {"tags": ["api", "rust", "rust-cargo", "rust-crates", "rustup"], "answers": [{"tags": [], "owner": {"reputation": 1959, "user_id": 421914, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/52130756638b6fbc9d74acd3aeec7657?s=128&d=identicon&r=PG", "display_name": "dchang", "link": "https://stackoverflow.com/users/421914/dchang"}, "is_accepted": true, "score": 0, "last_activity_date": 1574095728, "creation_date": 1574095728, "answer_id": 58919358, "question_id": 58903713, "link": "https://stackoverflow.com/questions/58903713/i-am-trying-to-get-data-over-an-openweather-api-in-rust-but-i-am-facing-some-ius/58919358#58919358", "title": "I am trying to get data over an OpenWeather API in Rust but I am facing some iusse regarding parsing I guess", "body": "<p>The issue is a JSON parsing error due to the deserialized struct not matching OpenWeather's JSON, perhaps the API recently added this? With your example, the <a href=\"https://github.com/BroderickCarlin/openweather/blob/master/src/weather_types.rs#L122-L136\" rel=\"nofollow noreferrer\">OpenWeatherCurrent</a> struct is missing <code>timezone</code>.</p>\n\n<p>But it looks like there is an <a href=\"https://github.com/BroderickCarlin/openweather/pull/7\" rel=\"nofollow noreferrer\">open PR</a> that will fix this, you can test it by doing the following:</p>\n\n<ul>\n<li>Change your <code>Cargo.toml</code> dependency to <code>openweather = { git = \"https://github.com/caemor/openweather\" }</code>.</li>\n<li><p>The PR author has also updated the <code>get_current_weather</code> signature so you'll need to change lines 2, 10 to the following:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use openweather::{LocationSpecifier, Settings};\n\nlet weather = openweather::get_current_weather(&amp;loc, API_KEY, &amp;Settings::default()).unwrap();\n\n</code></pre></li>\n</ul>\n"}], "owner": {"reputation": 13, "user_id": 12387786, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b9d35e85f63999685c19221890979f4a?s=128&d=identicon&r=PG&f=1", "display_name": "Areeb Sid", "link": "https://stackoverflow.com/users/12387786/areeb-sid"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 56, "favorite_count": 0, "accepted_answer_id": 58919358, "answer_count": 1, "score": 0, "last_activity_date": 1574095728, "creation_date": 1574014888, "question_id": 58903713, "link": "https://stackoverflow.com/questions/58903713/i-am-trying-to-get-data-over-an-openweather-api-in-rust-but-i-am-facing-some-ius", "title": "I am trying to get data over an OpenWeather API in Rust but I am facing some iusse regarding parsing I guess", "body": "<pre><code>extern crate openweather;\nuse openweather::LocationSpecifier;\nstatic API_KEY: &amp;str = \"e85e0a3142231dab28a2611888e48f22\";\n\nfn main() {\n    let loc = LocationSpecifier::Coordinates {\n        lat: 24.87,\n        lon: 67.03,\n    };\n    let weather = openweather::get_current_weather(loc, API_KEY).unwrap();\n\n    print!(\n        \"Right now in Minneapolis, MN it is {}K\",\n        weather.main.humidity\n    );\n}\n</code></pre>\n\n<blockquote>\n  <p>error : thread 'main' panicked at 'called <code>Result::unwrap()</code> on an\n  <code>Err</code> value: ErrorReport { cod: 0, message: \"Got unexpected response:\n  \\\"{\\\\\"coord\\\\\":{\\\\\"lon\\\\\":67.03,\\\\\"lat\\\\\":24.87},\\\\\"weather\\\\\":[{\\\\\"id\\\\\":803,\\\\\"main\\\\\":\\\\\"Clouds\\\\\",\\\\\"description\\\\\":\\\\\"broken\n  clouds\\\\\",\\\\\"icon\\\\\":\\\\\"04n\\\\\"}],\\\\\"base\\\\\":\\\\\"stations\\\\\",\\\\\"main\\\\\":{\\\\\"temp\\\\\":294.15,\\\\\"pressure\\\\\":1018,\\\\\"humidity\\\\\":60,\\\\\"temp_min\\\\\":294.15,\\\\\"temp_max\\\\\":294.15},\\\\\"visibility\\\\\":6000,\\\\\"wind\\\\\":{\\\\\"speed\\\\\":5.1,\\\\\"deg\\\\\":30},\\\\\"clouds\\\\\":{\\\\\"all\\\\\":70},\\\\\"dt\\\\\":1574012543,\\\\\"sys\\\\\":{\\\\\"type\\\\\":1,\\\\\"id\\\\\":7576,\\\\\"country\\\\\":\\\\\"PK\\\\\",\\\\\"sunrise\\\\\":1573955364,\\\\\"sunset\\\\\":1573994659},\\\\\"timezone\\\\\":18000,\\\\\"id\\\\\":1174872,\\\\\"name\\\\\":\\\\\"Karachi\\\\\",\\\\\"cod\\\\\":200}\\\"\"\n  }</p>\n</blockquote>\n"}, {"tags": ["rust", "closures", "lifetime"], "answers": [{"comments": [{"owner": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "edited": false, "score": 0, "creation_date": 1573973105, "post_id": 58898108, "comment_id": 104060564, "body": "Thanks for asking so promptly! So I do know about the elision rule... and actually I wrote &#39;b explicitly previously. But what I didn&#39;t quite get, intuitively, is why rustc couldn&#39;t reconcile the two lifetimes. Could you point that out?"}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "reply_to_user": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "edited": false, "score": 0, "creation_date": 1573973771, "post_id": 58898108, "comment_id": 104060663, "body": "@Determinant I believe that&#39;s because the variance. Unless you explicitly define <code>&#39;b: &#39;a</code>, the lifetimes in Rust are invariant, meaning there&#39;s no relationship between them. That&#39;s what <code>rustc</code> tells you in the error message, <code>&#39;_</code> and <code>&#39;a</code> are two different lifetimes."}, {"owner": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "edited": false, "score": 0, "creation_date": 1573975322, "post_id": 58898108, "comment_id": 104060875, "body": "I also tried that, but without luck...Could you show how to do it (with &#39;b: &#39;a bound) correctly? I think that&#39;d be very educational."}, {"owner": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "edited": false, "score": 0, "creation_date": 1573976052, "post_id": 58898108, "comment_id": 104061014, "body": "So my reasoning was: although the def for <code>g</code> doesn&#39;t specify the relation between <code>&#39;a</code> and the implicit <code>&#39;b</code>, <code>x.g</code> still gives the information that <code>&amp;self</code> in g, i.e. <code>&#39;b</code> should be bounded by the lifetime of <code>x</code>, which is bounded by <code>Arc&lt;X&lt;&#39;a&gt;&gt;</code>, which is bounded by <code>&#39;a</code>. So in this sense, <code>&#39;a</code> should outlive <code>&#39;b</code>? Most part of my confusion came from this."}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "reply_to_user": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "edited": false, "score": 1, "creation_date": 1573979220, "post_id": 58898108, "comment_id": 104061568, "body": "@Determinant a flaw in your reasoning, <i><code>&#39;b</code> should be bounded by the lifetime of <code>x</code>, which is bounded by <code>Arc&lt;X&lt;&#39;a&gt;&gt;</code></i>. Not true, remember a closure is a suspended computing, which doesn&#39;t happen yet. <code>&#39;b</code> is only materialized  whenever <code>B::inner::f</code> is called. <code>rustc</code> can&#39;t possibly know what that is. So unless it can statically determines all lifetimes involved, it will complain. <code>fn g(&amp;self, y: u32) -&gt; Z&lt;&#39;a&gt;</code> does just that, which was the only place in your original code that depended on elided lifetime."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1573998776, "post_id": 58898108, "comment_id": 104065730, "body": "Minor correction: relationships between lifetimes are a different thing from <a href=\"https://doc.rust-lang.org/nightly/nomicon/subtyping.html\" rel=\"nofollow noreferrer\">variance</a>, which is a relationship between a type constructor and its parameter. I don&#39;t know if there&#39;s a good name for the relationships between lifetimes but you could say that <code>&#39;b</code> and <code>&#39;a</code> are <i>independent</i> unless explicitly constrained. (Actually, because <code>&#39;b</code> is already constrained not to strictly outlive <code>&#39;a</code>, they are only partially independent; adding <code>&#39;b: &#39;a</code> would constrain them to be the same.)"}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1574000354, "post_id": 58898108, "comment_id": 104066174, "body": "@trentcl thanks, saying they are independent would be better."}, {"owner": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1574012550, "post_id": 58898108, "comment_id": 104069513, "body": "@trentcl I see. So <code>rustc</code> does know that <code>&#39;a: &#39;b</code> has to hold -- which is what I thought. But no matter how I annotate the other part <code>&#39;b: &#39;a</code>, the compiler still doesn&#39;t seem to like what I assert...Could you elaborate on this?"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1574031568, "post_id": 58898108, "comment_id": 104074768, "body": "<code>&#39;b: &#39;a</code> is a mistake because it says that <code>&#39;b</code> must outlive <code>&#39;a</code>. <code>&#39;a</code> must already outlive <code>&#39;b</code>, so adding the annotation just says that <code>&#39;a</code> and <code>&#39;b</code> must be the exact <i>same</i> lifetime -- in other words, it&#39;s equivalent to <code>fn g(&amp;&#39;a self, y: u32) -&gt; Z&lt;&#39;a&gt;</code>. Writing <code>&amp;&#39;a self</code> is nearly always a mistake because it forces <code>self</code> to be borrowed for <code>&#39;a</code>, and when <code>&#39;a</code> is the lifetime of something inside <code>self</code>, the lifetimes can become overconstrained. <a href=\"https://stackoverflow.com/q/58878192/3650362\">This recent question is about a bug in a library caused by just such a misplaced <code>&#39;a</code>.</a>"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1574031683, "post_id": 58898108, "comment_id": 104074784, "body": "Applied to your problem, you can&#39;t make <code>new</code> compile by <i>adding</i> a constraint to <code>g</code> (forcing <code>&#39;b</code> to outlive / be the same as <code>&#39;a</code>), because the problem is that the constraints are contradictory. You need to <i>remove</i> a constraint  (allow <code>&#39;b</code> to be independent of <code>&#39;a</code>)."}], "tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 2, "last_activity_date": 1573972272, "creation_date": 1573972272, "answer_id": 58898108, "question_id": 58897741, "link": "https://stackoverflow.com/questions/58897741/confused-by-rust-closure-lifetime/58898108#58898108", "title": "Confused by Rust closure lifetime", "body": "<p>There was a small oversight in your code. It should be:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;'a&gt; X&lt;'a&gt; {\n    fn g(&amp;self, y: u32) -&gt; Z&lt;'a&gt; {\n        Z { _d: &amp;std::marker::PhantomData }\n    }\n}\n</code></pre>\n\n<p>The whole thing then compiles. This is an example of Rust's <a href=\"https://doc.rust-lang.org/beta/nomicon/lifetime-elision.html\" rel=\"nofollow noreferrer\">lifetime elision  rule</a> coming into play.</p>\n\n<p>According to the relevant elision rules, namely:</p>\n\n<blockquote>\n  <ul>\n  <li>Each elided lifetime in input position becomes a distinct lifetime parameter.</li>\n  <li>If there are multiple input lifetime positions, but one of them is <code>&amp;self</code> or <code>&amp;mut self</code>, the lifetime of <code>self</code> is assigned to all elided output lifetimes.</li>\n  </ul>\n</blockquote>\n\n<p>Then to <code>rustc</code> your original code will actually be like following:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;'a&gt; X&lt;'a&gt; {\n    fn g&lt;'b&gt;(&amp;'b self, y: u32) -&gt; Z&lt;'b&gt; {\n        Z { _d: &amp;std::marker::PhantomData }\n    }\n}\n</code></pre>\n\n<p>The elided lifetime parameter <code>'b</code> will come from the calling site, which is exactly what you saw in the error message. The <code>rustc</code> couldn't reconcile the two lifetimes, hence the error.</p>\n"}], "owner": {"reputation": 3296, "user_id": 544806, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/56b48dda7f9f15078af7c9e5d04b48ae?s=128&d=identicon&r=PG", "display_name": "Determinant", "link": "https://stackoverflow.com/users/544806/determinant"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 212, "favorite_count": 1, "accepted_answer_id": 58898108, "answer_count": 1, "score": 1, "last_activity_date": 1573972272, "creation_date": 1573967882, "question_id": 58897741, "link": "https://stackoverflow.com/questions/58897741/confused-by-rust-closure-lifetime", "title": "Confused by Rust closure lifetime", "body": "<p>I ran into a confusing situation where what the compiler outputs doesn't logically make sense.\nHere is the minimal example to reproduce the same issue I'm having with my project code.</p>\n\n<pre><code>use std::sync::Arc;\n\nstruct A&lt;'a, T&gt; {\n    f: Box&lt;dyn Fn(&amp;u32) -&gt; T + 'a&gt;\n}\n\nstruct B&lt;'a&gt; {\n    inner: A&lt;'a, Z&lt;'a&gt;&gt;\n}\n\nimpl&lt;'a, T&gt; A&lt;'a, T&gt; {\n    fn new&lt;F&gt;(f: F) -&gt; Self where F: Fn(&amp;u32) -&gt; T + 'a {\n        A { f: Box::new(f) }\n    }\n}\n\nstruct X&lt;'a&gt; {\n    _d: &amp;'a std::marker::PhantomData&lt;()&gt;\n}\n\nstruct Z&lt;'a&gt; {\n    _d: &amp;'a std::marker::PhantomData&lt;()&gt;\n}\n\nimpl&lt;'a&gt; X&lt;'a&gt; {\n    fn g(&amp;self, y: u32) -&gt; Z {\n        Z { _d: &amp;std::marker::PhantomData }\n    }\n}\n\nimpl&lt;'a&gt; B&lt;'a&gt; {\n    fn new(x: Arc&lt;X&lt;'a&gt;&gt;) -&gt; Self {\n        B {\n            inner: A::new(move |y: &amp;u32| -&gt; Z {\n                x.g(*y)\n            })\n        }\n    }\n}\n\nfn main() {\n}\n</code></pre>\n\n<p>And the confusing compilation error:</p>\n\n<pre><code>error[E0495]: cannot infer an appropriate lifetime for lifetime parameter in function call due to conflicting requirements\n  --&gt; t.rs:35:19\n   |\n35 |                 x.g(*y)\n   |                   ^\n   |\nnote: first, the lifetime cannot outlive the lifetime '_ as defined on the body at 34:27...\n  --&gt; t.rs:34:27\n   |\n34 |             inner: A::new(move |y: &amp;u32| -&gt; Z {\n   |                           ^^^^^^^^^^^^^^^^^^^\nnote: ...so that closure can access `x`\n  --&gt; t.rs:35:17\n   |\n35 |                 x.g(*y)\n   |                 ^\nnote: but, the lifetime must be valid for the lifetime 'a as defined on the impl at 31:6...\n  --&gt; t.rs:31:6\n   |\n31 | impl&lt;'a&gt; B&lt;'a&gt; {\n   |      ^^\n   = note: ...so that the expression is assignable:\n           expected B&lt;'a&gt;\n              found B&lt;'_&gt;\n\nerror: aborting due to previous error\n</code></pre>\n\n<p>What I don't quite get is what \"the lifetime\" refers to as mentioned in the log, and what exactly that anonymous lifetime <code>'_</code> stands for.</p>\n"}, {"tags": ["rust", "iterator", "closures"], "answers": [{"comments": [{"owner": {"reputation": 5428, "user_id": 482382, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/9fe6eecd0900f0e779711f091fec8b3b?s=128&d=identicon&r=PG", "display_name": "Steven Shaw", "link": "https://stackoverflow.com/users/482382/steven-shaw"}, "edited": false, "score": 0, "creation_date": 1578036458, "post_id": 58897538, "comment_id": 105316307, "body": "I can across this problem when playing with the iterators2.rs exercise in Rustlings. It was quite surprising! Why do you recommend the <code>AsRef</code> solution?"}], "tags": [], "owner": {"reputation": 95188, "user_id": 440119, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/5ec9ca2a92a94a5470396073129d79e7?s=128&d=identicon&r=PG", "display_name": "Benjamin Lindley", "link": "https://stackoverflow.com/users/440119/benjamin-lindley"}, "is_accepted": true, "score": 6, "last_activity_date": 1573966080, "last_edit_date": 1573966080, "creation_date": 1573965424, "answer_id": 58897538, "question_id": 58897146, "link": "https://stackoverflow.com/questions/58897146/using-iter-map-why-does-a-closure-work-but-passing-the-function-directly-does-n/58897538#58897538", "title": "Using iter.map, why does a closure work but passing the function directly does not?", "body": "<p>When you iterate over a collection like you are with your call to <code>words.iter()</code>, you are iterating over references to your elements. The elements in your vector are of type <code>&amp;str</code>, and so references to your elements are of type <code>&amp;&amp;str</code>.</p>\n\n<p>So <code>map</code> is expecting a function which takes an argument of type <code>&amp;&amp;str</code>, and so that is what the <code>word</code> argument in your closure is inferred as. Then when you call <code>capitalize_first</code> on <code>word</code>, it is automatically dereferenced to <code>&amp;str</code>, due to the <a href=\"https://doc.rust-lang.org/stable/std/ops/trait.Deref.html\" rel=\"noreferrer\"><code>Deref</code></a> trait being implemented for all references.</p>\n\n<p>However, even though your function will appear to accept arguments of type <code>&amp;&amp;str</code> due to this conversion, the conversion happens outside your function. So it doesn't mean that your function can be passed in place of a function which expects <code>&amp;&amp;str</code>.</p>\n\n<p>There are 2 solutions. You can either change your function to be more generic, and have it accept anything that implements <code>AsRef&lt;str&gt;</code>. Then it will accept anything that can be dereferenced to <code>str</code>, which includes <code>&amp;str</code>, <code>&amp;&amp;str</code> and <code>String</code>, among others.</p>\n\n<pre><code>pub fn capitalize_first&lt;S: AsRef&lt;str&gt;&gt;(input: S) -&gt; String {\n    let mut c = input.as_ref().chars();\n    // Don't forget this ^\n\n    match c.next() {\n        None =&gt; String::new(),\n        Some(first) =&gt; first.to_uppercase().collect::&lt;String&gt;() + c.as_str(),\n    }\n}\n</code></pre>\n\n<p>Or you can keep your function as it is, and fix it at the call site, by calling <code>copied()</code> on your iterator, which will essentially dereference the elements.</p>\n\n<pre><code>let capitalized_words: Vec&lt;String&gt; = words.iter().copied().map(capitalize_first).collect();\n</code></pre>\n\n<p>I would recommend the first approach.</p>\n"}], "owner": {"reputation": 2003, "user_id": 457586, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/8fced1b618d6b8a714c598d3f8f7d9fe?s=128&d=identicon&r=PG", "display_name": "dynamitereed", "link": "https://stackoverflow.com/users/457586/dynamitereed"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 422, "favorite_count": 0, "accepted_answer_id": 58897538, "answer_count": 1, "score": 2, "last_activity_date": 1573966080, "creation_date": 1573959874, "question_id": 58897146, "link": "https://stackoverflow.com/questions/58897146/using-iter-map-why-does-a-closure-work-but-passing-the-function-directly-does-n", "title": "Using iter.map, why does a closure work but passing the function directly does not?", "body": "<p>I've got this function in Rust that capitalizes a string.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn capitalize_first(input: &amp;str) -&gt; String {\n    let mut c = input.chars();\n    match c.next() {\n        None =&gt; String::new(),\n        Some(first) =&gt; first.to_uppercase().collect::&lt;String&gt;() + c.as_str(),\n    }\n}\n</code></pre>\n\n<p>Later, I use it to iterate over a vector of strings.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let words = vec![\"hello\", \"world\"];\nlet capitalized_words: Vec&lt;String&gt; =\n    words.iter().map(|word| capitalize_first(word)).collect();\n</code></pre>\n\n<p>This works as expected, but I notice that the closure <code>|word| capitalize_first(word)</code> is pretty useless.  So I tried to replace it with passing <code>capitalize_first</code> directly like this.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let words = vec![\"hello\", \"world\"];\nlet capitalized_words: Vec&lt;String&gt; = words.iter().map(capitalize_first).collect();\n</code></pre>\n\n<p>This, however, fails to compile with the following error message.</p>\n\n<pre><code>10 | pub fn capitalize_first(input: &amp;str) -&gt; String {\n   | ---------------------------------------------- found signature of `for&lt;'r&gt; fn(&amp;'r str) -&gt; _`\n...\n38 |         let capitalized_words: Vec&lt;String&gt; = words.iter().map(capitalize_first).collect();\n   |                                                               ^^^^^^^^^^^^^^^^ expected signature of `fn(&amp;&amp;str) -&gt; _`\n</code></pre>\n\n<p>I'm having trouble understanding this error.  Why does the closure work but passing the function directly does not.  Is there something I can change that would allow me to pass the function reference instead of making a useless closure?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573929714, "post_id": 58893899, "comment_id": 104052934, "body": "<a href=\"https://play.integer32.com/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=bb1ab402be807c14e01db5ac944465c2\" rel=\"nofollow noreferrer\">play.integer32.com/&hellip;</a>"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1573933895, "post_id": 58893899, "comment_id": 104054016, "body": "&quot;check if all optional ids are not set&quot; \u2013 I&#39;m not sure I&#39;m parsing this correctly. Do you really want to check for the case that they are <i>all</i> <code>None</code>?"}], "answers": [{"tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 4, "last_activity_date": 1573929925, "last_edit_date": 1573929925, "creation_date": 1573929598, "answer_id": 58893980, "question_id": 58893899, "link": "https://stackoverflow.com/questions/58893899/simplest-way-to-match-multiple-fields-of-a-struct-against-none/58893980#58893980", "title": "Simplest way to match multiple fields of a struct against `None`", "body": "<p>You can destructure a structure in pattern matching like so:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct SomeMapping {\n    pub id: String,\n    pub other_id: Option&lt;String&gt;,\n    pub yet_another_id: Option&lt;String&gt;,\n    pub very_different_id: Option&lt;String&gt;,\n}\n\nfn main() {\n    let x = SomeMapping {\n        id: \"R\".to_string(),\n        other_id: Some(\"u\".to_string()),\n        yet_another_id: Some(\"s\".to_string()),\n        very_different_id: Some(\"t\".to_string()),\n    };\n\n    if let SomeMapping {\n        id: a,\n        other_id: Some(b),\n        yet_another_id: Some(c),\n        very_different_id: Some(d),\n    } = x {\n        println!(\"{} {} {} {}\", a, b, c, d);\n    }\n}\n</code></pre>\n\n<p>It is documented in the Rust book <a href=\"https://doc.rust-lang.org/book/ch18-03-pattern-syntax.html#destructuring-structs\" rel=\"nofollow noreferrer\">chapter 18</a>.</p>\n"}], "owner": {"reputation": 14335, "user_id": 110963, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/096c2c331fa0c946d103e9038930f80e?s=128&d=identicon&r=PG", "display_name": "Achim", "link": "https://stackoverflow.com/users/110963/achim"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 318, "favorite_count": 0, "accepted_answer_id": 58893980, "answer_count": 1, "score": 2, "last_activity_date": 1573929925, "creation_date": 1573928930, "question_id": 58893899, "link": "https://stackoverflow.com/questions/58893899/simplest-way-to-match-multiple-fields-of-a-struct-against-none", "title": "Simplest way to match multiple fields of a struct against `None`", "body": "<p>I have a Rust struct like this:</p>\n\n<pre><code>pub struct SomeMapping {\n    pub id: String,\n    pub other_id: Option&lt;String&gt;,\n    pub yet_another_id: Option&lt;String&gt;,\n    pub very_different_id: Option&lt;String&gt;\n}\n</code></pre>\n\n<p>What is the simplest way to check if all optional ids are not set? I know the syntax like</p>\n\n<pre><code>if let Some(x) = option_value {...}\n</code></pre>\n\n<p>to extract a value from an <code>Option</code>, but I don't get how to use this in a concise way to check multiple values for <code>None</code>.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 6608, "user_id": 4497253, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dc929d11ae26463d18e337d295c86fcc?s=128&d=identicon&r=PG&f=1", "display_name": "CoronA", "link": "https://stackoverflow.com/users/4497253/corona"}, "edited": false, "score": 0, "creation_date": 1573924601, "post_id": 58893035, "comment_id": 104051580, "body": "If you want to have the node in the list and simultaneously for local modification you will have to consider something like <code>Option&lt;Rc&lt;Refcell&lt;Node&gt;&gt;&gt;</code> instead of <code>Option&lt;Box&lt;Node&gt;&gt;</code>."}, {"owner": {"reputation": 37, "user_id": 10882657, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e40f3498b9ede12ba2a21f8c1f535d1?s=128&d=identicon&r=PG&f=1", "display_name": "BuRny", "link": "https://stackoverflow.com/users/10882657/burny"}, "reply_to_user": {"reputation": 6608, "user_id": 4497253, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dc929d11ae26463d18e337d295c86fcc?s=128&d=identicon&r=PG&f=1", "display_name": "CoronA", "link": "https://stackoverflow.com/users/4497253/corona"}, "edited": false, "score": 0, "creation_date": 1573926513, "post_id": 58893035, "comment_id": 104052057, "body": "I&#39;m having trouble trying to implement your suggestion. Do you have a link to an example?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1573937828, "post_id": 58893035, "comment_id": 104055017, "body": "Have you read <a href=\"https://rust-unofficial.github.io/too-many-lists/\" rel=\"nofollow noreferrer\">Learn Rust With Entirely Too Many Linked Lists</a>?"}, {"owner": {"reputation": 37, "user_id": 10882657, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e40f3498b9ede12ba2a21f8c1f535d1?s=128&d=identicon&r=PG&f=1", "display_name": "BuRny", "link": "https://stackoverflow.com/users/10882657/burny"}, "edited": false, "score": 0, "creation_date": 1573978566, "post_id": 58893035, "comment_id": 104061480, "body": "Yeah, this is what I have linked. However I stopped reading after about 30-40% in because it got complicated very quickly. I guess I give it another go."}], "owner": {"reputation": 37, "user_id": 10882657, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e40f3498b9ede12ba2a21f8c1f535d1?s=128&d=identicon&r=PG&f=1", "display_name": "BuRny", "link": "https://stackoverflow.com/users/10882657/burny"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 104, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1593022616, "creation_date": 1573923205, "last_edit_date": 1593022616, "question_id": 58893035, "link": "https://stackoverflow.com/questions/58893035/how-to-implement-recursive-node-struct", "title": "How to implement recursive Node struct?", "body": "<p>Coming from Python, I want to implement a Node struct in Rust similar to the Python code below:</p>\n<pre class=\"lang-py prettyprint-override\"><code>class Node:\n    def __init__(self, value: int, next_node: &quot;Node&quot;):\n        self.value: int = value\n        self.next: Node = next_node\n\n    def __repr__(self):\n        return f&quot;Node(value: {self.value}, next: {self.next})&quot;\n\nif __name__ == &quot;__main__&quot;:\n    a = Node(1, None)\n    b = Node(2, None)\n\n    # Link a.next with b\n    a.next = b\n\n    print(f&quot;a now: {a}\\n&quot;)\n    # Prints:\n    # a now: Node(value: 1, next: Node(value: 2, next: None))\n\n    # Change .value inside b\n    b.value = 3\n\n    print(f&quot;a now: {a}&quot;)\n    print(f&quot;b now: {b}\\n&quot;)\n    # Prints:\n    # a now: Node(value: 1, next: Node(value: 3, next: None))\n    # b now: Node(value: 3, next: None)\n\n    # Change .value inside a.next\n    a.next.value = 4\n\n    print(f&quot;a now: {a}&quot;)\n    print(f&quot;b now: {b}&quot;)\n    # Prints:\n    # a now: Node(value: 1, next: Node(value: 4, next: None))\n    # b now: Node(value: 4, next: None)\n\n</code></pre>\n<p>My implementation so far in Rust is the following:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Debug)]\n#[derive(Clone)]\nstruct Node {\n    value: i32,\n    next: Option&lt;Box&lt;Node&gt;&gt;,\n}\n\nfn main() {\n    let mut a = Node { value: 1, next: None };\n    let mut b = Node { value: 2, next: None };\n\n    // Box and encapsulate a and b inside Option\n    let mut option_a = Some(Box::new(a));\n    let mut option_b = Some(Box::new(b));\n\n    // Link a.next with b\n    if let Some(ref mut a_unwrapped) = option_a {\n        a_unwrapped.next = option_b;\n    }\n    println!(&quot;a now: {:?}&quot;, option_a);\n    // Prints:\n    // a now: Some(Node { value: 1, next: Some(Node { value: 2, next: None }) })\n}\n</code></pre>\n<p>However, the line <code>a_unwrapped.next = option_b;</code> moves the node's <code>option_b</code> inside of <code>a.next</code> instead of creating a reference. Now I'm no longer able to access <code>option_b</code>.</p>\n<p>Unrelated to the above, changing a value inside a node would perhaps be possible using:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>if let Some(ref mut b_unwrapped) = option_b {\n    b_unwrapped.value = 3;\n    // It is desired that a.next.value is now 3 as well\n}\n</code></pre>\n<p>I want to implement this because I want to create a <code>Queue</code> data structure (and perhaps binary trees) without using Rust's <code>Vec</code> data structure and without using the <code>unsafe</code> keyword, just as a personal challenge.</p>\n<p>So far, I was able to build a <code>Stack</code> data structure with the linked list approach described <a href=\"https://rust-unofficial.github.io/too-many-lists/second-option.html\" rel=\"nofollow noreferrer\">here</a>.</p>\n<p>As you can see, I struggle to understand how one would implement this.</p>\n<p>It seems to me that having more than one reference in Rust pointing at the same object is rather difficult (because of Data Races and Race Conditions), or I am just using the wrong approach.</p>\n"}, {"tags": ["rust", "console"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573920840, "post_id": 58892528, "comment_id": 104050577, "body": "as for C and C++, you need specific OS feature, you should look at crates.io to find something that will help you"}, {"owner": {"reputation": 823, "user_id": 9157032, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/be5efaf026881ab3eecab1df1e023f3d?s=128&d=identicon&r=PG&f=1", "display_name": "TimB", "link": "https://stackoverflow.com/users/9157032/timb"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573921400, "post_id": 58892528, "comment_id": 104050738, "body": "Found three crates which look interesting. Thanks!"}], "owner": {"reputation": 823, "user_id": 9157032, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/be5efaf026881ab3eecab1df1e023f3d?s=128&d=identicon&r=PG&f=1", "display_name": "TimB", "link": "https://stackoverflow.com/users/9157032/timb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 459, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1573919841, "creation_date": 1573919841, "question_id": 58892528, "link": "https://stackoverflow.com/questions/58892528/get-console-width-in-rust", "title": "Get console width in Rust", "body": "<p>When line-wrapping our output so it is visually pleasant, it would be helpful knowing the console window or at least the buffer width.</p>\n\n<p>There are answers how to do this in <a href=\"https://stackoverflow.com/questions/6812224/getting-terminal-size-in-c-for-windows\">C</a> and <a href=\"https://stackoverflow.com/questions/23369503/get-size-of-terminal-window-rows-columns\">C++</a>, C# even has properties which make this task easy. But Rust?</p>\n\n<p>Is there anything I could use to get this information, or should I just let the user decide where my program wraps the output?</p>\n"}, {"tags": ["enums", "rust"], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 3, "last_activity_date": 1573915849, "last_edit_date": 1573915849, "creation_date": 1573914759, "answer_id": 58891764, "question_id": 58891643, "link": "https://stackoverflow.com/questions/58891643/how-to-match-self-on-associated-method-of-enum-for-a-given-trait/58891764#58891764", "title": "How to match Self on associated method of enum for a given trait", "body": "<p>Unfortunately, an enum variant is not a type in Rust, so you must stick with your \"verbose\" version.</p>\n\n<p>There is <a href=\"https://github.com/rust-lang/rfcs/pull/2593\" rel=\"nofollow noreferrer\">an RFC</a> that would make variants as types, but even if it is implemented, (if I read it correctly) you won't be able to make them implement a trait anyway.</p>\n\n<hr>\n\n<p>However, in your very case, since your variants don't hold any value, you can write something like that:</p>\n\n<pre><code>#[derive(Debug, std::cmp::PartialEq, Clone, Copy)]\nenum BinOp {\n    Add,\n    Sub\n}\n\ntrait Token {\n    fn regex(self) -&gt; &amp;'static str;\n}\n\nimpl Token for BinOp {\n    fn regex(self) -&gt; &amp;'static str {\n        match self {\n            BinOp::Add =&gt; \"\\\\+\",\n            BinOp::Sub =&gt; \"-\",\n        }\n    }\n}\n\nfn main() {\n    assert_eq!(BinOp::Add.regex(), \"\\\\+\");\n    assert_eq!(BinOp::Sub.regex(), \"-\");\n}\n</code></pre>\n"}], "owner": {"reputation": 191, "user_id": 9643557, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fhqXU.png?s=128&g=1", "display_name": "Robin", "link": "https://stackoverflow.com/users/9643557/robin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 380, "favorite_count": 0, "accepted_answer_id": 58891764, "answer_count": 1, "score": 0, "last_activity_date": 1573919156, "creation_date": 1573913976, "last_edit_date": 1573919156, "question_id": 58891643, "link": "https://stackoverflow.com/questions/58891643/how-to-match-self-on-associated-method-of-enum-for-a-given-trait", "title": "How to match Self on associated method of enum for a given trait", "body": "<p>Before starting, I wasn't able to adapt neither <a href=\"https://stackoverflow.com/questions/41596628/how-to-match-on-data-type-in-rust\">how to match on data type in Rust</a>\nnor the updated version of Shepmaster to <a href=\"https://stackoverflow.com/questions/58847391/can-rust-match-on-a-type-not-a-value-to-conditionally-compile-code-like-cs\">another question</a> I had.</p>\n\n<hr>\n\n<p>I would like to be able to implement the <code>Token</code> trait for each variant of the enum <code>BinOp</code>.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Debug, std::cmp::PartialEq)]\nenum BinOp {\n    Add,\n    Sub\n}\n\ntrait Token {\n    fn regex() -&gt; &amp;'static str;\n}\n</code></pre>\n\n<hr>\n\n<p>Neither this works (this is what I would have like to write)</p>\n\n<p>EDIT: fix typo: <code>impl Token for BinOp</code> instead of <code>impl Token for BinOp::Add</code></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Token for BinOp {\n    fn regex() -&gt; &amp;'static str{\n        match Self {\n            BinOp::Add =&gt; \"\\\\+\",\n            BinOp::Sub =&gt; \"-\"\n        }\n    }\n}\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>        match Self {\n              ^^^^ \nthe `Self` constructor can only be used with tuple or unit structs\n\n\nthe `Self` constructor can only be used with tuple or unit structs\n</code></pre>\n\n<p>Nor that</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Token for BinOp::Add {\n    fn regex() -&gt; &amp;'static str{\n         \"\\\\+\"\n    }\n}\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Token for BinOp::Add {\n               ^^^^^^^^^^ not a type\nexpected type, found variant `BinOp::Add`\n</code></pre>\n\n<hr>\n\n<p>If the above code could be written, I would have liked to be able to use it like this</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let add: BinOp = BinOp::Add;\nlet regex: &amp;str = BinOp::Add::regex();\n</code></pre>\n\n<hr>\n\n<p>Is there a better way than doing the following (witch is way too much verbose)?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Debug, std::cmp::PartialEq)]\nstruct Add;\n#[derive(Debug, std::cmp::PartialEq)]\nstruct Sub;\n#[derive(Debug, std::cmp::PartialEq)]\nenum BinOp {\n    Add(Add),\n    Sub(Sub)\n}\n\ntrait Token {\n    fn regex() -&gt; &amp;'static str;\n}\n\nimpl Token for Add {\n    fn regex() -&gt; &amp;'static str{\n         \"\\\\+\"\n    }\n}\nimpl Token for Sub {\n    fn regex() -&gt; &amp;'static str{\n         \"-\"\n    }\n}\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let add: BinOp = BinOp::Add(Add);\nlet regex: &amp;str = Add::regex();\n</code></pre>\n\n<p>Is this unfortunately a current limitation of Rust? Is there a workaround?</p>\n"}, {"tags": ["rust", "async-await"], "comments": [{"owner": {"reputation": 3931, "user_id": 3398839, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/5186a4aea9a9044d734cd373e6ba835b?s=128&d=identicon&r=PG&f=1", "display_name": "Coder-256", "link": "https://stackoverflow.com/users/3398839/coder-256"}, "edited": false, "score": 0, "creation_date": 1581013397, "post_id": 58891121, "comment_id": 106297378, "body": "Why is the input to <code>normalize_async_cb</code> a function pointer?"}, {"owner": {"reputation": 3931, "user_id": 3398839, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/5186a4aea9a9044d734cd373e6ba835b?s=128&d=identicon&r=PG&f=1", "display_name": "Coder-256", "link": "https://stackoverflow.com/users/3398839/coder-256"}, "edited": false, "score": 0, "creation_date": 1581014181, "post_id": 58891121, "comment_id": 106297731, "body": "Also, what do you mean by a &quot;callback&quot;? Can you provide an example showing where you would need this type of callback?"}], "answers": [{"tags": [], "owner": {"reputation": 3054, "user_id": 115030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15c74c0974c6cc25c194a2737e2d6747?s=128&d=identicon&r=PG", "display_name": "Anders Kaseorg", "link": "https://stackoverflow.com/users/115030/anders-kaseorg"}, "is_accepted": false, "score": 1, "last_activity_date": 1581302402, "last_edit_date": 1581302402, "creation_date": 1581301593, "answer_id": 60143353, "question_id": 58891121, "link": "https://stackoverflow.com/questions/58891121/how-to-use-a-rust-async-fn-that-takes-a-reference-as-a-callback/60143353#60143353", "title": "How to use a Rust async fn that takes a reference as a callback?", "body": "<p>Rust does not support higher-kinded polymorphism, so you need to add a lifetime parameter to the <code>AsyncCb</code> type:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use futures::future::{Future, FutureExt, LocalBoxFuture};\n\ntype Context = ();\ntype AsyncCb&lt;'r&gt; = Box&lt;dyn FnOnce(&amp;'r Context) -&gt; LocalBoxFuture&lt;'r, ()&gt; + 'r&gt;;\n\nfn normalize_async_cb&lt;'r, Fut: Future&lt;Output = ()&gt; + 'r&gt;(f: fn(&amp;'r Context) -&gt; Fut) -&gt; AsyncCb {\n    let cb = move |ctx: &amp;'r Context| f(ctx).boxed_local();\n    Box::new(cb)\n}\n</code></pre>\n\n<p>Aditionally, you can avoid a <code>Box</code> by returning <code>impl</code> trait:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn normalize_async_cb&lt;'r, Fut: Future&lt;Output = ()&gt; + 'r&gt;(\n    f: fn(&amp;'r Context) -&gt; Fut,\n) -&gt; impl FnOnce(&amp;'r Context) -&gt; LocalBoxFuture&lt;'r, ()&gt; {\n    let cb = move |ctx: &amp;'r Context| f(ctx).boxed_local();\n    cb\n}\n</code></pre>\n\n<p>(The caller can then use <code>Box::new(normalize_async_cb(\u2026))</code> as type <code>AsyncCb</code> if desired.)</p>\n"}], "owner": {"reputation": 197, "user_id": 6945484, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3217b6709ab8b0cc941a04694b2593bb?s=128&d=identicon&r=PG", "display_name": "s97712", "link": "https://stackoverflow.com/users/6945484/s97712"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1307, "favorite_count": 2, "answer_count": 1, "score": 11, "last_activity_date": 1582054112, "creation_date": 1573910043, "last_edit_date": 1582054112, "question_id": 58891121, "link": "https://stackoverflow.com/questions/58891121/how-to-use-a-rust-async-fn-that-takes-a-reference-as-a-callback", "title": "How to use a Rust async fn that takes a reference as a callback?", "body": "<p><code>async fn</code> returns an anonymous type that implements <code>Future</code>, so if we want to use it as a callback, we need to convert the return value to a trait object. </p>\n\n<p>I tried to write an function to do this, but I had some lifetime problems.</p>\n\n<p><code>async fn</code> will return lifetime of all parameters, so the signature of callback also needs to. How can I add the lifetime to the return value of the callback?</p>\n\n<pre><code>use futures::future::{Future, FutureExt, LocalBoxFuture};\n\ntype Context = ();\ntype AsyncCb = Box&lt;dyn for&lt;'r&gt; FnOnce(&amp;'r Context) -&gt; LocalBoxFuture&lt;'r, ()&gt;&gt;;\n\nfn normalize_async_cb&lt;Fut: Future&lt;Output = ()&gt;&gt;(f: for&lt;'r&gt; fn(&amp;'r Context) -&gt; Fut) -&gt; AsyncCb\n//                                                    how to add 'r for Fut?  ^^^\n{\n    let cb = move |ctx: &amp;Context| f(ctx).boxed_local();\n    Box::new(cb)\n}\n</code></pre>\n"}, {"tags": ["rust", "language-lawyer"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1573914449, "post_id": 58889717, "comment_id": 104048735, "body": "This reminds me of <a href=\"https://stackoverflow.com/a/52692592/3650362\">this answer</a> (I wrote). The compiler knows the trait generically, and when there&#39;s only one <code>impl</code> that applies, it can disambiguate by choosing the type argument used in that <code>impl</code>. In the other Q&amp;A I used this ability to make the compiler (appear to) choose an <code>impl</code> at the call site, which is something it can&#39;t usually do. Presumably in <i>this</i> case that&#39;s what allows it to do deref coercion. But that&#39;s only a guess."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1574009642, "post_id": 58889717, "comment_id": 104068703, "body": "<a href=\"https://github.com/rust-lang/rust/pull/66215#issuecomment-554750813\" rel=\"nofollow noreferrer\">Here is a comment</a> which states that if only one impl is found the compiler &quot;eagerly confirms&quot; it, which allows deref coercions (among other things) to happen. That does not happen for multiple impl candidates. So I guess that&#39;s kind of the answer, but I&#39;d stil love to know more. <a href=\"https://rust-lang.github.io/rustc-guide/traits/resolution.html\" rel=\"nofollow noreferrer\">This chapter</a> in the rustc book might help, but as far as I can tell, it doesn&#39;t specifically say something about this."}], "answers": [{"tags": [], "owner": {"reputation": 145, "user_id": 13374929, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/40431e5ff1e225d96a68be416e212e65?s=128&d=identicon&r=PG", "display_name": "ramsl&#246;k", "link": "https://stackoverflow.com/users/13374929/ramsl%c3%b6k"}, "is_accepted": false, "score": 1, "last_activity_date": 1587854926, "creation_date": 1587854926, "answer_id": 61433615, "question_id": 58889717, "link": "https://stackoverflow.com/questions/58889717/why-does-adding-a-second-impl-prevent-deref-coercion-of-the-argument/61433615#61433615", "title": "Why does adding a second impl prevent deref coercion of the argument?", "body": "<p>As you yourself explained, the compiler treats the case where there is only one valid <code>impl</code> specially, and can use this to drive type inference:</p>\n\n<blockquote>\n  <p><a href=\"https://github.com/rust-lang/rust/pull/66215#issuecomment-554750813\" rel=\"nofollow noreferrer\">Here is a comment</a> which states that if only one impl is found the compiler \"eagerly confirms\" it, which allows deref coercions (among other things) to happen. That does not happen for multiple impl candidates.</p>\n</blockquote>\n\n<p>The second part is that <em>deref coercion</em> will only happen at sites where the expected type is known, it doesn't happen speculatively. See <a href=\"https://doc.rust-lang.org/stable/reference/type-coercions.html?highlight=deref,coer#coercion-sites\" rel=\"nofollow noreferrer\">coercion sites</a> in the reference. Impl selection and type inference must <em>first</em> explicitly find that <code>MyAdd::add(&amp;str)</code> would be expected, to attempt to coerce the argument to <code>&amp;str</code>.</p>\n\n<p>If a workaround is needed in this situation, use an expression like <code>&amp;*b</code> or <code>&amp;b[..]</code> or <code>b.as_str()</code> for the second argument.</p>\n"}], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 151, "favorite_count": 1, "answer_count": 1, "score": 12, "last_activity_date": 1587854926, "creation_date": 1573899895, "question_id": 58889717, "link": "https://stackoverflow.com/questions/58889717/why-does-adding-a-second-impl-prevent-deref-coercion-of-the-argument", "title": "Why does adding a second impl prevent deref coercion of the argument?", "body": "<p>I came across this issue when trying to add the impl <code>Add&lt;char&gt; for String</code> to the standard library. But we can replicate it easily, without operator shenanigans. We start with this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait MyAdd&lt;Rhs&gt; {\n    fn add(self, rhs: Rhs) -&gt; Self;\n}\n\nimpl MyAdd&lt;&amp;str&gt; for String {\n    fn add(mut self, rhs: &amp;str) -&gt; Self {\n        self.push_str(rhs);\n        self\n    }\n}\n</code></pre>\n\n<p>Simple enough. With this, the following code compiles:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let a = String::from(\"a\");\nlet b = String::from(\"b\");\nMyAdd::add(a, &amp;b);\n</code></pre>\n\n<p>Note that in this case, the second argument expression (<code>&amp;b</code>) has the type <code>&amp;String</code>. It is then deref-coerced into <code>&amp;str</code> and the function call works.</p>\n\n<p><em>However</em>, let's try to add the following impl:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl MyAdd&lt;char&gt; for String {\n    fn add(mut self, rhs: char) -&gt; Self {\n        self.push(rhs);\n        self\n    }\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2015&amp;gist=eff675766988e8cde50f30a003913ad1\" rel=\"noreferrer\">Everything on Playground</a>)</p>\n\n<p>Now the <code>MyAdd::add(a, &amp;b)</code> expression above leads to the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `std::string::String: MyAdd&lt;&amp;std::string::String&gt;` is not satisfied\n  --&gt; src/main.rs:24:5\n   |\n2  |     fn add(self, rhs: Rhs) -&gt; Self;\n   |     ------------------------------- required by `MyAdd::add`\n...\n24 |     MyAdd::add(a, &amp;b);\n   |     ^^^^^^^^^^ the trait `MyAdd&lt;&amp;std::string::String&gt;` is not implemented for `std::string::String`\n   |\n   = help: the following implementations were found:\n             &lt;std::string::String as MyAdd&lt;&amp;str&gt;&gt;\n             &lt;std::string::String as MyAdd&lt;char&gt;&gt;\n</code></pre>\n\n<p><strong>Why is that?</strong> To me it seems like deref-coercion is only done when there is only one function candidate. But this seems wrong to me. Why would the rules be like that? I tried looking through the specification, but I haven't found anything on argument deref coercion.</p>\n"}, {"tags": ["rust", "lifetime"], "answers": [{"tags": [], "owner": {"reputation": 917, "user_id": 4808573, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/oFwhb.jpg?s=128&g=1", "display_name": "pengowen123", "link": "https://stackoverflow.com/users/4808573/pengowen123"}, "is_accepted": false, "score": 3, "last_activity_date": 1573881668, "creation_date": 1573881668, "answer_id": 58887838, "question_id": 58887620, "link": "https://stackoverflow.com/questions/58887620/what-are-the-examples-of-unsafely-specified-lifetimes/58887838#58887838", "title": "What are the examples of unsafely specified lifetimes?", "body": "<p>It is not possible (barring any compiler bugs) to induce undefined behavior with lifetime specifiers unless you use unsafe code (either in the function or elsewhere). However, lifetime specifiers are still necessary because sometimes there is ambiguity in what the proper lifetime should be. For example:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn foo(bar: &amp;i32, baz: &amp;i32) -&gt; &amp;i32 {\n    // ...\n}\n\n</code></pre>\n\n<p>What should the lifetime of the return type be? The compiler cannot infer this because it could be tied to either <code>bar</code> or <code>baz</code>, and each case would affect how long the return value lasts and therefore how the function can be used. The body of the function cannot be used to infer the lifetime because type and lifetime checks must be possible to complete using only the signature of the function. The only way to remove this ambiguity is to explicitly state what lifetime the return value should have:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn foo&lt;'a&gt;(bar: &amp;i32, baz: &amp;'a i32) -&gt; &amp;'a i32 {\n    // ...\n}\n</code></pre>\n\n<p>You can read more about the lifetime elision rules <a href=\"https://doc.rust-lang.org/nomicon/lifetime-elision.html\" rel=\"nofollow noreferrer\">here</a>.</p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 67, "favorite_count": 0, "closed_date": 1613773682, "answer_count": 1, "score": 1, "last_activity_date": 1573884044, "creation_date": 1573879134, "last_edit_date": 1573884044, "question_id": 58887620, "link": "https://stackoverflow.com/questions/58887620/what-are-the-examples-of-unsafely-specified-lifetimes", "closed_reason": "Duplicate", "title": "What are the examples of unsafely specified lifetimes?", "body": "<p>I have been learning the lifetimes topic for the last three days, and they start making sense to me now. However, I experimented a lot, but didn't manage to specify lifetimes in a way when they'd lead to <em>runtime</em>-unsafe behavior, because the compiler seems to be smart enough to prevent such cases, by not compiling. \nHence I have the chain of questions below:</p>\n\n<p>Is it true that Rust compiler will catch every case of unsafe lifetime specifiers usage?  </p>\n\n<ul>\n<li>If yes, then why does Rust require manually specifying lifetimes, when it can do it on its own, by deducing the unsafe scenarios? Or is it just a relic that will go away once the compiler becomes powerful enough to make lifetime elision everywhere?</li>\n<li>If no, what is the example (are the examples) of unsafe lifetime specifiers usage? They'd clearly prove the necessity of manually specifying lifetimes.</li>\n</ul>\n"}, {"tags": ["rust", "rust-tokio"], "comments": [{"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 0, "creation_date": 1573864813, "post_id": 58886314, "comment_id": 104039899, "body": "Use <code>tokio::io::split</code> free function instead. This change was introduced in <a href=\"https://github.com/tokio-rs/tokio/pull/1521\" rel=\"nofollow noreferrer\">this PR</a>."}, {"owner": {"reputation": 347, "user_id": 12167264, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/642adaee4e4afed5e9c20bb29327853f?s=128&d=identicon&r=PG&f=1", "display_name": "rusty", "link": "https://stackoverflow.com/users/12167264/rusty"}, "reply_to_user": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 0, "creation_date": 1573890608, "post_id": 58886314, "comment_id": 104043388, "body": "Thanks @edwardw, that was what I was looking for."}], "owner": {"reputation": 347, "user_id": 12167264, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/642adaee4e4afed5e9c20bb29327853f?s=128&d=identicon&r=PG&f=1", "display_name": "rusty", "link": "https://stackoverflow.com/users/12167264/rusty"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 765, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1573863457, "creation_date": 1573863457, "question_id": 58886314, "link": "https://stackoverflow.com/questions/58886314/concurrent-read-write-on-tokio-tcpstream", "title": "Concurrent read/write on tokio TcpStream", "body": "<p>I have a scenario where thread 1 writes to the socket, thread 2 reads from the socket. I have done this in the past via <code>split()</code> which would consume the TcpStream and return the ReadHalf/WriteHalf, which then could be neatly passed to the threads. I am running into issues on 1.39.0(tokio - 0.2.0-alpha.6).</p>\n\n<ol>\n<li><p>Now it has changed to <code>pub fn split(&amp;mut self) -&gt; (ReadHalf, WriteHalf)</code>. This doesn't allow passing the ReadHalf/WriteHalf(whose lifetime is tied to the stream) to separate threads, without running into messy lifetime issues</p></li>\n<li><p>The plain <code>read()/write()</code> variants take <code>&amp;mut self</code>, which makes it impossible to do concurrent reads/writes.</p></li>\n</ol>\n\n<p>Interestingly, UdpSocket still has the old way(<code>pub fn split(self) -&gt; (UdpSocketRecvHalf, UdpSocketSendHalf)</code>)</p>\n\n<p>Also found this related(unresolved) thread: <a href=\"https://github.com/tokio-rs/tokio/issues/1108\" rel=\"nofollow noreferrer\">https://github.com/tokio-rs/tokio/issues/1108</a>. Not sure it is even possible anymore with TcpStream.</p>\n\n<p>Appreciate any suggestions here.</p>\n\n<p>Thanks.</p>\n"}, {"tags": ["rust", "smart-pointers"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1573858821, "post_id": 58885209, "comment_id": 104038601, "body": "The C++ question was asked in 2008. Stack Overflow was a different place back then, and the rules, expectations and community norms have changed over time. A lot of highly voted early questions would be considered too broad or off topic if asked today. That said, I think there is already a Rust question that is spiritually the same..."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1573858879, "post_id": 58885209, "comment_id": 104038617, "body": "... namely, <a href=\"https://stackoverflow.com/questions/45674479/need-holistic-explanation-about-rusts-cell-and-reference-counted-types\">Need holistic explanation about Rust&#39;s cell and reference counted types</a>."}, {"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1573860044, "post_id": 58885209, "comment_id": 104038927, "body": "@trentcl Thank you so much for actually explaining why my question doesn&#39;t fit today&#39;s SO (I don&#39;t agree too much with this principle, but that&#39;s another subject), instead of silently downvoting. And thanks for the link! Looks like what I need."}], "answers": [{"comments": [{"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "edited": false, "score": 0, "creation_date": 1573862545, "post_id": 58885731, "comment_id": 104039506, "body": "Thank you so much for your time! I was going to select your answer, when the other one popped out and I hope you&#39;ll agree it&#39;s more thorough and polished, also a bit more comprehensible for me personally. Still, I appreciate your answer very much, thank you."}], "tags": [], "owner": {"reputation": 138, "user_id": 1144858, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b3cba17cd5c6e976d2a58ff135587aec?s=128&d=identicon&r=PG", "display_name": "David Brown", "link": "https://stackoverflow.com/users/1144858/david-brown"}, "is_accepted": false, "score": 1, "last_activity_date": 1573858471, "creation_date": 1573858471, "answer_id": 58885731, "question_id": 58885209, "link": "https://stackoverflow.com/questions/58885209/when-should-i-use-smart-pointers/58885731#58885731", "title": "When should I use smart pointers?", "body": "<p>The simple answer I would give would be: use references when you can.  Unfortunately, understanding when you can depends on getting a deeper understanding of the borrow checker, and by that point, I would guess a cheat sheet would be less useful.  However, some simple explanations might help.</p>\n\n<ul>\n<li>The simple case is where you have a clear owner, and references are passed down the stack to functions that you call.  This case works clearly for just references.</li>\n<li>When you have the same clear ownership but the item is either \"large\", or of non-determined size, you may need a <code>Box</code>.  Still a single owner, with possible stack-based borrowing.</li>\n<li>When ownership isn't clearly in a tree, <code>Rc</code> or <code>Arc</code> would be appropriate (with something like a <code>Mutex</code> for sharing).</li>\n</ul>\n\n<p>The other things mentioned (<code>Ref</code>, <code>RefMut</code>) are specifically about borrows of the thing contained in a <code>RefCell</code>.  <code>Cell</code> and <code>RefCell</code> are containers that are mutable.</p>\n\n<p>I would say, start by trying to just have your item owned, and using borrowed references to pass it around.  If you do need sharing, look into <code>Rc</code> or <code>Arc</code>.  If that still doesn't work, consider the other things.</p>\n\n<p>Again, though, the Rust Book's description is very good, and you kind of have to get an understanding of borrowing to get a gut feeling of what to use anyway.</p>\n"}, {"comments": [{"owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "edited": false, "score": 1, "creation_date": 1573860959, "post_id": 58885926, "comment_id": 104039127, "body": "Such a thorough, quality answer! And it&#39;s exactly what I was looking for. Thank you so much for your time and knowledge. I hope my question will be upvoted or un-downvoted eventually so that other people will be able to access this gem (your answer)."}], "tags": [], "owner": {"reputation": 2659, "user_id": 8050514, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/6CRdl.jpg?s=128&g=1", "display_name": "Optimistic Peach", "link": "https://stackoverflow.com/users/8050514/optimistic-peach"}, "is_accepted": true, "score": 5, "last_activity_date": 1573859972, "creation_date": 1573859972, "answer_id": 58885926, "question_id": 58885209, "link": "https://stackoverflow.com/questions/58885209/when-should-i-use-smart-pointers/58885926#58885926", "title": "When should I use smart pointers?", "body": "<blockquote>\n  <p>What are the use cases for <code>Box</code>, <code>Rc</code>, <code>Ref</code>, <code>RefMut</code> (others?) in Rust?</p>\n</blockquote>\n\n<p>Okay, here we go:</p>\n\n<ul>\n<li><code>Box</code>, in the simplest terms, is used when you have an object you want to keep on the heap. Use a box when\n\n<ul>\n<li>You want to <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ae1d3b9b47ebdb47134fb65fd671aaaf\" rel=\"noreferrer\">own a dynamically sized object</a></li>\n<li>You want to leak an object into <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d64fa89bc8c00dd63514d4a4a2281dff\" rel=\"noreferrer\"><code>'static</code> lifetime</a></li>\n<li>You want to produce an <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c52f7379a9f038287680cff0e85d74ce\" rel=\"noreferrer\">ffi pointer</a></li>\n<li>You want to make <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=18acb276a42d11d6bac7378a5cb5a295\" rel=\"noreferrer\">recursive types</a></li>\n</ul></li>\n<li><code>Rc</code> is used when it is very difficult to decide on the lifetimes of objects. It's a sign of laziness to overuse, and somewhat defeats the purpose of lifetimes.</li>\n<li><code>Ref</code> and <code>RefMut</code> are the objects produced by a <a href=\"https://doc.rust-lang.org/book/ch15-05-interior-mutability.html\" rel=\"noreferrer\"><code>RefCell</code></a> when you try to get access to its contents. A <code>RefCell</code> will track the borrowing state of its object at runtime instead of compile time, so it is kind of like lifetimes. A general use for this is when you need to have <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4d2820d53d830014c8ccbd1a753c6a02\" rel=\"noreferrer\">mutable references to many objects in a hashmap</a> for example. </li>\n<li><a href=\"https://doc.rust-lang.org/std/sync/struct.Arc.html\" rel=\"noreferrer\"><code>Arc</code></a> is used with either <a href=\"https://doc.rust-lang.org/std/sync/struct.RwLock.html\" rel=\"noreferrer\"><code>RwLock</code></a> (Essentially the same as <code>RefCell</code> apart from what's below) or <a href=\"https://doc.rust-lang.org/std/sync/struct.Mutex.html\" rel=\"noreferrer\"><code>Mutex</code></a> when trying to share an object across a thread boundary. The examples on their pages will show you how to use them and why they are important as opposed to using the <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> pattern.</li>\n</ul>\n\n<p>There are a few more \"smart\" pointers per se in rust, but what you must know is that everything will eventually de-allocate its contents unless you've used unsafe code or used the global allocator directly. </p>\n\n<p>This ties into why the tools built into the language (lifetimes) are so important to Rust, they accomplish all that <code>Rc</code> and <code>RefCell</code> accomplish but without the performance drawbacks and also do what <code>C/C++</code> do without the chance of UB. </p>\n"}], "owner": {"reputation": 11799, "user_id": 9259778, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/R157q.jpg?s=128&g=1", "display_name": "Nurbol Alpysbayev", "link": "https://stackoverflow.com/users/9259778/nurbol-alpysbayev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 222, "favorite_count": 0, "accepted_answer_id": 58885926, "answer_count": 2, "score": 1, "last_activity_date": 1573859972, "creation_date": 1573854924, "last_edit_date": 1573858017, "question_id": 58885209, "link": "https://stackoverflow.com/questions/58885209/when-should-i-use-smart-pointers", "title": "When should I use smart pointers?", "body": "<p>There is a similar, very popular <a href=\"https://stackoverflow.com/questions/106508/what-is-a-smart-pointer-and-when-should-i-use-one\">question</a> for C++, but I couldn't find a similar existing question for Rust. </p>\n\n<p>So, what are the use cases for <code>Box</code>, <code>Rc</code>, <code>Ref</code>, <code>RefMut</code> (others?) in Rust? </p>\n\n<p>The important part of the question (for me personally): when should smart pointers be used instead of references?</p>\n\n<p>I know The Rust Book explains it very, very thoroughly, but I wish there would be a succinct and quick \"cheatsheet\" on the subject, possibly with some real-world examples that are missing in the book.</p>\n"}, {"tags": ["struct", "enums", "rust", "tuples"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573891291, "post_id": 58884841, "comment_id": 104043556, "body": "what&#39;s wrong with helper function ? <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9f68241fc9bdf2c49f1001bd63f90e2e\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a> and I don&#39;t think your current code bad"}], "answers": [{"tags": [], "owner": {"reputation": 3495, "user_id": 36585, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a0ccd55542e51b1b98f5a72b30c815dc?s=128&d=identicon&r=PG", "display_name": "pnkfelix", "link": "https://stackoverflow.com/users/36585/pnkfelix"}, "is_accepted": true, "score": 3, "last_activity_date": 1573855722, "creation_date": 1573855722, "answer_id": 58885331, "question_id": 58884841, "link": "https://stackoverflow.com/questions/58884841/can-i-cast-a-tuple-struct-enum-variant-into-a-regular-tuple-instead-of-destructu/58885331#58885331", "title": "Can I cast a tuple struct enum variant into a regular tuple instead of destructuring and recreating the tuple?", "body": "<p>I see two ways to answer this.</p>\n\n<ol>\n<li><p>For the <code>enum</code>-definition as written, you do need to do the explicit destructuring and subseuquent tuple construction. One simple reason for this: The language does not guarantee that the layout of the fields in <code>Message::ChangeColor</code> matches the layout of <code>(u8, u8, u8)</code>. So from that point of view, it makes some sense that you cannot convert the <code>Message::ChangeColor</code> payload into its own tuple.</p></li>\n<li><p>If you really do not want to repeat the destructuring and restructuring, and if you are willing to modify your <code>enum</code>-definition <em>slightly</em>, then I recommend you define your <code>enum</code> like this:</p></li>\n</ol>\n\n<pre><code>enum Message {\n   ChangeColor((u8, u8, u8)), // note the extra set of parentheses.\n   // ...\n}\n</code></pre>\n\n<p>With this in place, you can now match the <em>tuple</em> that the enum holds, and pass <em>that</em> to <code>self.change_color</code>. <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e4f8898dff7cae2ad0a606d3f26dbef6\" rel=\"nofollow noreferrer\">Demo playground code</a></p>\n"}, {"tags": [], "owner": {"reputation": 5450, "user_id": 942317, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/SY5ID.jpg?s=128&g=1", "display_name": "STEEL", "link": "https://stackoverflow.com/users/942317/steel"}, "is_accepted": false, "score": -1, "last_activity_date": 1588341374, "creation_date": 1588341374, "answer_id": 61543868, "question_id": 58884841, "link": "https://stackoverflow.com/questions/58884841/can-i-cast-a-tuple-struct-enum-variant-into-a-regular-tuple-instead-of-destructu/61543868#61543868", "title": "Can I cast a tuple struct enum variant into a regular tuple instead of destructuring and recreating the tuple?", "body": "<p>You don't need to pass extra parenthesis for <code>enum</code>. see <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=53bbb526c23233bcb0fc31e2bcd08680\" rel=\"nofollow noreferrer\">demo</a></p>\n\n<pre><code>enum Message {\n    ChangeColor (u8, u8, u8),\n}\nmatch message {\n     Message::ChangeColor(r, g, b) =&gt; self.change_color((r, g, b)),\n     ...\n}\n\nInterp.recv(Message::ChangeColor(1,2,3));\n</code></pre>\n"}], "owner": {"reputation": 2003, "user_id": 457586, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/8fced1b618d6b8a714c598d3f8f7d9fe?s=128&d=identicon&r=PG", "display_name": "dynamitereed", "link": "https://stackoverflow.com/users/457586/dynamitereed"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 228, "favorite_count": 0, "accepted_answer_id": 58885331, "answer_count": 2, "score": 1, "last_activity_date": 1588341374, "creation_date": 1573852896, "last_edit_date": 1573855366, "question_id": 58884841, "link": "https://stackoverflow.com/questions/58884841/can-i-cast-a-tuple-struct-enum-variant-into-a-regular-tuple-instead-of-destructu", "title": "Can I cast a tuple struct enum variant into a regular tuple instead of destructuring and recreating the tuple?", "body": "<p>I have a tuple struct enum variant that looks like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>enum Message {\n    ChangeColor(u8, u8, u8),\n    // ...\n}\n</code></pre>\n\n<p>Later, I have a <code>match</code> construct to detect if a variable is of the <code>ChangeColor</code> subtype.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>match message {\n    Message::ChangeColor(r, g, b) =&gt; self.change_color((r, g, b)),\n    // ...\n}\n</code></pre>\n\n<p>The signature of <code>change_color</code> is <code>change_color(&amp;mut self, color: (u8, u8, u8))</code>.  Is there any way to pass the value of <code>message</code> directly to <code>self.change_color</code> by casting it to the equivalent tuple type, or am I required to deconstruct <code>message</code> and then construct a new tuple to pass to <code>change_color</code>?</p>\n\n<p>It's not that I'm concerned with performance.  I've read that the compiler knows how to pass <code>message</code> directly instead of literally copying the values to a new tuple first.  I'm more concerned with ergonomics.  Do I really have to repeat myself there and possibly mistype something and introduce an error or a bug?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573847681, "post_id": 58883648, "comment_id": 104034772, "body": "what is a unit type for you ?"}, {"owner": {"reputation": 191, "user_id": 9643557, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fhqXU.png?s=128&g=1", "display_name": "Robin", "link": "https://stackoverflow.com/users/9643557/robin"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573847972, "post_id": 58883648, "comment_id": 104034898, "body": "I edited the title. I meant unit struct, like <code>struct Foo;</code>"}], "answers": [{"comments": [{"owner": {"reputation": 191, "user_id": 9643557, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fhqXU.png?s=128&g=1", "display_name": "Robin", "link": "https://stackoverflow.com/users/9643557/robin"}, "edited": false, "score": 0, "creation_date": 1573849796, "post_id": 58884172, "comment_id": 104035709, "body": "The <code>Default</code> trait was exactly what I needed. Thanks."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1573851277, "last_edit_date": 1573851277, "creation_date": 1573849326, "answer_id": 58884172, "question_id": 58883648, "link": "https://stackoverflow.com/questions/58883648/is-it-possible-to-restrict-self-to-unit-structs-in-trait/58884172#58884172", "title": "Is it possible to restrict Self to unit structs in trait?", "body": "<p>No, this is not possible as of Rust 1.39.</p>\n\n<hr>\n\n<p>Honestly, your question doesn't make sense to me. If you want to ensure that you can create a value without any parameters, <em>then require that</em> via a function that creates a value without any parameters:</p>\n\n<pre><code>trait BadCreator: Sized {\n    fn create() -&gt; Self;\n\n    fn maybe_create_me(b: bool) -&gt; Result&lt;Self, Error&gt; {\n        match b {\n            true =&gt; Ok(Self::create()),\n            false =&gt; Err(Error),\n        }\n    }\n}\n</code></pre>\n\n<p>Or use the <a href=\"https://doc.rust-lang.org/std/default/trait.Default.html\" rel=\"nofollow noreferrer\"><code>Default</code></a> trait:</p>\n\n<pre><code>trait BadCreator: Default {\n    fn maybe_create_me(b: bool) -&gt; Result&lt;Self, Error&gt; {\n        match b {\n            true =&gt; Ok(Self::default()),\n            false =&gt; Err(Error),\n        }\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 191, "user_id": 9643557, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fhqXU.png?s=128&g=1", "display_name": "Robin", "link": "https://stackoverflow.com/users/9643557/robin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 84, "favorite_count": 0, "accepted_answer_id": 58884172, "answer_count": 1, "score": 0, "last_activity_date": 1573851277, "creation_date": 1573846925, "last_edit_date": 1573849375, "question_id": 58883648, "link": "https://stackoverflow.com/questions/58883648/is-it-possible-to-restrict-self-to-unit-structs-in-trait", "title": "Is it possible to restrict Self to unit structs in trait?", "body": "<p>Is it possible to restrict <code>Self</code> to unit structs in trait?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Error;\ntrait BadCreator\nwhere\n    Self: Sized, // &lt;&lt;&lt; I would like to restrict Self to unit structs\n{\n    fn maybe_create_me(b: bool) -&gt; Result&lt;Self, Error&gt; {\n        match b {\n            true =&gt; Ok(Self), // &lt;&lt;&lt; This line doesn't compile\n            false =&gt; Err(Error),\n        }\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0423]: expected value, found self type `Self`\n --&gt; src/lib.rs:8:24\n  |\n8 |             true =&gt; Ok(Self),\n  |                        ^^^^ not a value\n  |\n  = note: can't use `Self` as a constructor, you must use the implemented struct\n</code></pre>\n\n<p>I would like to be able to use it like this:</p>\n\n<pre><code>struct Foo;\nimpl BadCreator for Foo {}\n\nlet b: Foo = Foo::maybe_create_me(true)?;\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1573827264, "post_id": 58878748, "comment_id": 104024748, "body": "Feel free to point the mpd maintainer to <a href=\"https://stackoverflow.com/q/31067031/155423\">Cannot borrow as mutable more than once at a time in one code - but can in another very similar</a>"}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 3, "last_activity_date": 1573827034, "creation_date": 1573827034, "answer_id": 58878748, "question_id": 58878192, "link": "https://stackoverflow.com/questions/58878192/cannot-borrow-xxx-as-mutable-more-than-once-at-a-time-when-using-mpds-query/58878748#58878748", "title": "cannot borrow `xxx` as mutable more than once at a time when using mpd&#39;s Query::and", "body": "<p>On first sight, the mutable borrow should end with the <code>if let</code> block, which would allow the subsequent borrows. However there is a bug in <code>rust-mpd</code> that causes the borrow to be extended for the full lifetime of <code>query</code>: the <a href=\"http://kstep.me/rust-mpd/mpd/search/struct.Query.html#method.and\" rel=\"nofollow noreferrer\"><code>Query::and</code></a> method is declared as:</p>\n\n<pre><code>fn and&lt;'b: 'a, V: 'b + Into&lt;Cow&lt;'b, str&gt;&gt;&gt;(\n    &amp;'a mut self,         // &lt;- Note the 'a lifetime here\n    term: Term&lt;'b&gt;,\n    value: V)\n    -&gt; &amp;'a mut Query&lt;'a&gt;  // &lt;- Note the **two** 'a lifetimes here\n</code></pre>\n\n<p>using the same lifetime <code>'a</code> for both the references to the query <em>and</em> the embedded lifetime. The method should be declared like this:</p>\n\n<pre><code>fn and&lt;'b: 'a, V: 'b + Into&lt;Cow&lt;'b, str&gt;&gt;&gt;(\n    &amp;mut self,\n    term: Term&lt;'b&gt;,\n    value: V)\n    -&gt; &amp;mut Query&lt;'a&gt;\n</code></pre>\n\n<p>You should report a bug to <code>rust-mpd</code>.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1573827940, "creation_date": 1573827940, "answer_id": 58879004, "question_id": 58878192, "link": "https://stackoverflow.com/questions/58878192/cannot-borrow-xxx-as-mutable-more-than-once-at-a-time-when-using-mpds-query/58879004#58879004", "title": "cannot borrow `xxx` as mutable more than once at a time when using mpd&#39;s Query::and", "body": "<p>If you just want to use the library in its non-ideal state, you can iteratively update a mutable reference to the <code>Query</code>, instead of using it directly:</p>\n\n<pre><code>use mpd::{Query, Term}; // 0.0.12\nuse std::borrow::Cow;\n\nfn load(\n    track: &amp;Option&lt;String&gt;,\n    artist: &amp;Option&lt;String&gt;,\n    album: &amp;Option&lt;String&gt;,\n) -&gt; Result&lt;(), &amp;'static str&gt; {\n    let mut query = Query::new();\n    let mut query = &amp;mut query;\n\n    if let Some(s) = track {\n        query = query.and(Term::Tag(Cow::Borrowed(\"track\")), s);\n    }\n\n    if let Some(s) = artist {\n        query = query.and(Term::Tag(Cow::Borrowed(\"artist\")), s);\n    }\n\n    if let Some(s) = album {\n        query = query.and(Term::Tag(Cow::Borrowed(\"album\")), s);\n    }\n\n    let mut client = mpd::Client::new(std::fs::File::open(\"/tmp/junk\").unwrap()).unwrap();\n    let _musics = client.search(&amp;query, (1, 2));\n\n    Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 51, "user_id": 12378764, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/61e35db409e203912ac2d14275bc9c29?s=128&d=identicon&r=PG&f=1", "display_name": "Polar Bear", "link": "https://stackoverflow.com/users/12378764/polar-bear"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2437, "favorite_count": 1, "answer_count": 2, "score": 1, "last_activity_date": 1573827940, "creation_date": 1573824951, "last_edit_date": 1573827700, "question_id": 58878192, "link": "https://stackoverflow.com/questions/58878192/cannot-borrow-xxx-as-mutable-more-than-once-at-a-time-when-using-mpds-query", "title": "cannot borrow `xxx` as mutable more than once at a time when using mpd&#39;s Query::and", "body": "<p>I am trying to realize the following function, which takes 3 optional input and get search result from mpd client from the rust-mpd crate. </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn load(\n    &amp;mut self,\n    track: &amp;Option&lt;String&gt;,\n    artist: &amp;Option&lt;String&gt;,\n    album: &amp;Option&lt;String&gt;\n) -&gt; Result&lt;(), &amp;'static str&gt;{\n    println!(\"mpd, load method is invoked with:\");\n    let mut query = Query::new();\n\n    if let Some(s) = track {\n        println!(\"  track: {}\", &amp;s);\n        query.and(Term::Tag(Cow::Borrowed(\"track\")), s);\n    }\n\n    if let Some(s) = artist {\n        println!(\"  artist: {}\", &amp;s);\n        query.and(Term::Tag(Cow::Borrowed(\"artist\")), s);\n    }\n\n    if let Some(s) = album {\n        println!(\"  album: {}\", &amp;s);\n        query.and(Term::Tag(Cow::Borrowed(\"album\")), s);\n    }\n\n    //let musics = self.client.search(&amp;query, Window(None));\n    let musics = self.client.search(&amp;query, (1,2));\n    println!(\"Search result: {:?}\", musics);\n\n    Ok(())\n}\n</code></pre>\n\n<p>However, when I try to compile, it tells me:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0499]: cannot borrow `query` as mutable more than once at a time\n  --&gt; src/player/mpd.rs:62:13\n   |\n57 |             query.and(Term::Tag(Cow::Borrowed(\"track\")), s);\n   |             ----- first mutable borrow occurs here\n...\n62 |             query.and(Term::Tag(Cow::Borrowed(\"artist\")), s);\n   |             ^^^^^\n   |             |\n   |             second mutable borrow occurs here\n   |             first borrow later used here\n\nerror[E0499]: cannot borrow `query` as mutable more than once at a time\n  --&gt; src/player/mpd.rs:67:13\n   |\n62 |             query.and(Term::Tag(Cow::Borrowed(\"artist\")), s);\n   |             ----- first mutable borrow occurs here\n...\n67 |             query.and(Term::Tag(Cow::Borrowed(\"album\")), s);\n   |             ^^^^^\n   |             |\n   |             second mutable borrow occurs here\n   |             first borrow later used here\n\nerror[E0502]: cannot borrow `query` as immutable because it is also borrowed as mutable\n  --&gt; src/player/mpd.rs:71:41\n   |\n67 |             query.and(Term::Tag(Cow::Borrowed(\"album\")), s);\n   |             ----- mutable borrow occurs here\n...\n71 |         let musics = self.client.search(&amp;query, (1,2));\n   |                                         ^^^^^^\n   |                                         |\n   |                                         immutable borrow occurs here\n   |                                         mutable borrow later used here\n</code></pre>\n\n<p>If my way is wrong, how should I achieve the same functionality? </p>\n"}, {"tags": ["rust", "future"], "answers": [{"comments": [{"owner": {"reputation": 543, "user_id": 1039984, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/933bc6d13c42486433166bdee49b6e70?s=128&d=identicon&r=PG", "display_name": "Victor Ermolaev", "link": "https://stackoverflow.com/users/1039984/victor-ermolaev"}, "edited": false, "score": 1, "creation_date": 1574073838, "post_id": 58876157, "comment_id": 104087483, "body": "This is rather unsatisfying but I will accept it. Amount of the boilerplate code when using <code>TryFuture</code> is insane compared to <code>Futue&lt;...Result...&gt;</code>."}], "tags": [], "owner": {"reputation": 18942, "user_id": 894328, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3db17c5296335f63e856be44aa821bf6?s=128&d=identicon&r=PG", "display_name": "Ahmed Masud", "link": "https://stackoverflow.com/users/894328/ahmed-masud"}, "is_accepted": true, "score": 2, "last_activity_date": 1573826672, "last_edit_date": 1573826672, "creation_date": 1573817413, "answer_id": 58876157, "question_id": 58873264, "link": "https://stackoverflow.com/questions/58873264/why-do-i-get-an-error-about-mismatched-types-when-using-tryfuture-instead-of-the/58876157#58876157", "title": "Why do I get an error about mismatched types when using TryFuture instead of the equivalent Future?", "body": "<p>Your syntax doesn't work at the moment. The docs for <a href=\"https://docs.rs/futures-core/0.3.1/futures_core/future/trait.TryFuture.html#tymethod.try_poll\" rel=\"nofollow noreferrer\"><code>TryFuture</code></a> show that you have to wrap the <code>Result</code> in a <code>Poll</code> for the time being (the emphasis is mine): </p>\n\n<blockquote>\n<pre><code>fn try_poll(\n    self: PinMut&lt;Self&gt;, \n    cx: &amp;mut Context ) -&gt; Poll&lt;Result&lt;Self::Ok, Self::Error&gt;&gt; [\u2212]\n</code></pre>\n  \n  <p>Poll this <code>TryFuture</code> as if it were a <code>Future</code>.</p>\n  \n  <p><strong>This method is a stopgap for a compiler limitation that prevents us\n  from directly inheriting from the <code>Future</code> trait; in the future it won't\n  be needed.</strong></p>\n</blockquote>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=78daa6a5e60df17d8334199c43fe1e36\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>When this compiler limitation resolves, this approach will no longer be necessary and you will be able to do what you did (or something along the same lines)</p>\n\n<h2>References</h2>\n\n<ul>\n<li><a href=\"https://github.com/rust-lang-nursery/futures-rs/issues/1776\" rel=\"nofollow noreferrer\">futures issue 1776</a></li>\n<li><a href=\"https://github.com/rust-lang-nursery/futures-rs/issues/1777\" rel=\"nofollow noreferrer\">futures issue 1777</a></li>\n</ul>\n"}], "owner": {"reputation": 543, "user_id": 1039984, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/933bc6d13c42486433166bdee49b6e70?s=128&d=identicon&r=PG", "display_name": "Victor Ermolaev", "link": "https://stackoverflow.com/users/1039984/victor-ermolaev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 240, "favorite_count": 0, "accepted_answer_id": 58876157, "answer_count": 1, "score": 4, "last_activity_date": 1573826795, "creation_date": 1573807618, "last_edit_date": 1573826795, "question_id": 58873264, "link": "https://stackoverflow.com/questions/58873264/why-do-i-get-an-error-about-mismatched-types-when-using-tryfuture-instead-of-the", "title": "Why do I get an error about mismatched types when using TryFuture instead of the equivalent Future?", "body": "<p>I have the following working piece of code using <code>Future</code>.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use futures::{future, Future};\n\nfn fut_res() -&gt; impl Future&lt;Output = Result&lt;(), failure::Error&gt;&gt; {\n    future::ok::&lt;(), failure::Error&gt;(())\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), failure::Error&gt; {\n    if let Err(e) = fut_res().await {\n        println!(\"{:?}\", e);\n    }\n\n    Ok(())\n}\n</code></pre>\n\n<p>From what I read in the docs I should be able to alter the code to use <code>TryFuture</code> as follows:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use futures::{future, TryFuture};\n\nfn try_fut() -&gt; impl TryFuture&lt;Ok = (), Error = failure::Error&gt; {\n    future::ok::&lt;(), failure::Error&gt;(())\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), failure::Error&gt; {\n    if let Err(e) = try_fut().await {\n        println!(\"{:?}\", e);\n    }\n\n    Ok(())\n}\n</code></pre>\n\n<p>The compiler complains that <code>try_fut</code> must return the associated type <code>Output</code>, but this type by definition <em>is</em> <code>Result&lt;(), failure::Error&gt;</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n --&gt; src/lib.rs:9:12\n  |\n9 |     if let Err(e) = try_fut().await {\n  |            ^^^^^^ expected associated type, found enum `std::result::Result`\n  |\n  = note: expected type `&lt;impl futures_core::future::TryFuture as core::future::future::Future&gt;::Output`\n             found type `std::result::Result&lt;_, _&gt;`\n  = note: consider constraining the associated type `&lt;impl futures_core::future::TryFuture as core::future::future::Future&gt;::Output` to `std::result::Result&lt;_, _&gt;` or calling a method that returns `&lt;impl futures_core::future::TryFuture as core::future::future::Future&gt;::Output`\n  = note: for more information, visit https://doc.rust-lang.org/book/ch19-03-advanced-traits.html\n</code></pre>\n\n<p>How do I explain this to the compiler?</p>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d4a5260847e760c77ff3c0e33cb6111f\" rel=\"nofollow noreferrer\">Playground</a> does not work because <code>tokio</code> is still in alpha, but there is also an appropriate <code>Cargo.toml</code>.</p>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 2058, "user_id": 3958875, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/f6149ddd4636bcab17c52b751d79f7fd?s=128&d=identicon&r=PG&f=1", "display_name": "Prime_Aqasix", "link": "https://stackoverflow.com/users/3958875/prime-aqasix"}, "edited": false, "score": 0, "creation_date": 1573800256, "post_id": 58871421, "comment_id": 104011398, "body": "Try making the function public for a quick fix, if you really want it private, have a look at this: <a href=\"https://stackoverflow.com/questions/29378113/how-can-i-include-private-modules-when-generating-documentation-via-cargo\" title=\"how can i include private modules when generating documentation via cargo\">stackoverflow.com/questions/29378113/&hellip;</a>"}, {"owner": {"reputation": 390, "user_id": 7934881, "user_type": "registered", "accept_rate": 0, "profile_image": "https://www.gravatar.com/avatar/aa6f4cdaa2a06c9ed371c080ee77dbb5?s=128&d=identicon&r=PG&f=1", "display_name": "Ayumu Kasugano", "link": "https://stackoverflow.com/users/7934881/ayumu-kasugano"}, "reply_to_user": {"reputation": 2058, "user_id": 3958875, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/f6149ddd4636bcab17c52b751d79f7fd?s=128&d=identicon&r=PG&f=1", "display_name": "Prime_Aqasix", "link": "https://stackoverflow.com/users/3958875/prime-aqasix"}, "edited": false, "score": 0, "creation_date": 1573800953, "post_id": 58871421, "comment_id": 104011625, "body": "@Prime_Aqasix apologies, the function is public"}, {"owner": {"reputation": 467, "user_id": 231203, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0a3585eee458f88629b261a95f3f70a5?s=128&d=identicon&r=PG", "display_name": "Po&#39; Lazarus", "link": "https://stackoverflow.com/users/231203/po-lazarus"}, "edited": false, "score": 1, "creation_date": 1573803252, "post_id": 58871421, "comment_id": 104012545, "body": "Does <code>main.rs</code> declare <code>mod drivers</code> public? does drivers/mod.rs declare <code>mod foo</code> public?"}, {"owner": {"reputation": 390, "user_id": 7934881, "user_type": "registered", "accept_rate": 0, "profile_image": "https://www.gravatar.com/avatar/aa6f4cdaa2a06c9ed371c080ee77dbb5?s=128&d=identicon&r=PG&f=1", "display_name": "Ayumu Kasugano", "link": "https://stackoverflow.com/users/7934881/ayumu-kasugano"}, "edited": false, "score": 0, "creation_date": 1573803392, "post_id": 58871421, "comment_id": 104012590, "body": "D&#39;oh! That&#39;s it!"}], "owner": {"reputation": 390, "user_id": 7934881, "user_type": "registered", "accept_rate": 0, "profile_image": "https://www.gravatar.com/avatar/aa6f4cdaa2a06c9ed371c080ee77dbb5?s=128&d=identicon&r=PG&f=1", "display_name": "Ayumu Kasugano", "link": "https://stackoverflow.com/users/7934881/ayumu-kasugano"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 43, "favorite_count": 0, "closed_date": 1573831461, "answer_count": 0, "score": 0, "last_activity_date": 1573800966, "creation_date": 1573799065, "last_edit_date": 1573800966, "question_id": 58871421, "link": "https://stackoverflow.com/questions/58871421/correctly-generating-rustdocs", "closed_reason": "Duplicate", "title": "Correctly generating Rustdocs", "body": "<p>I'm probably missing something incredibly obvious, but I'm having trouble generating documentation for my code. I'm reading <a href=\"https://facility9.com/2016/05/writing-documentation-in-rust/\" rel=\"nofollow noreferrer\">this</a> tutorial and from what I understand, I can simply do something like</p>\n\n<pre><code>/// this is a doc comment\npub fn something() {\n\n}\n</code></pre>\n\n<p>and run <code>cargo doc --no-deps --open</code> to get my crate's html page. However, my <code>index.html</code> is just showing the crate name and nothing else.</p>\n\n<p>I have the following structure:</p>\n\n<pre><code>src/\n  | main.rs\n  | random_file.rs\n  | drivers/\n    | mod.rs \n    | foo.rs \n    | dummy.rs \n</code></pre>\n\n<p>and in my <code>foo.rs</code> I have</p>\n\n<pre><code>/// in foo doc\npub fn bar() {\n\n}\n</code></pre>\n\n<p>What am I missing?</p>\n"}, {"tags": ["winapi", "rust", "hook", "ipc"], "comments": [{"owner": {"reputation": 2755, "user_id": 2682312, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/M37ut.png?s=128&g=1", "display_name": "Axalo", "link": "https://stackoverflow.com/users/2682312/axalo"}, "edited": false, "score": 0, "creation_date": 1573783111, "post_id": 58869240, "comment_id": 104007514, "body": "Write a driver."}, {"owner": {"reputation": 13237, "user_id": 611545, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/YXVOl.jpg?s=128&g=1", "display_name": "Ross Bush", "link": "https://stackoverflow.com/users/611545/ross-bush"}, "edited": false, "score": 1, "creation_date": 1573783934, "post_id": 58869240, "comment_id": 104007670, "body": "Why can&#39;t the other process create a keyboard hook as well? Are you preventing the message from propagating?"}, {"owner": {"reputation": 6168, "user_id": 10611792, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/r727s.jpg?s=128&g=1", "display_name": "Drake Wu", "link": "https://stackoverflow.com/users/10611792/drake-wu"}, "edited": false, "score": 1, "creation_date": 1573784553, "post_id": 58869240, "comment_id": 104007780, "body": "In IPC, Share memory is usually faster than pipes."}, {"owner": {"reputation": 13237, "user_id": 611545, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/YXVOl.jpg?s=128&g=1", "display_name": "Ross Bush", "link": "https://stackoverflow.com/users/611545/ross-bush"}, "edited": false, "score": 0, "creation_date": 1573789085, "post_id": 58869240, "comment_id": 104008653, "body": "Here is a good article related to memory mapped files --&gt; <a href=\"https://docs.microsoft.com/en-us/dotnet/standard/io/memory-mapped-files\" rel=\"nofollow noreferrer\">docs.microsoft.com/en-us/dotnet/standard/io/memory-mapped-fi&zwnj;&#8203;les</a>"}], "answers": [{"comments": [{"owner": {"reputation": 6168, "user_id": 10611792, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/r727s.jpg?s=128&g=1", "display_name": "Drake Wu", "link": "https://stackoverflow.com/users/10611792/drake-wu"}, "edited": false, "score": 0, "creation_date": 1574214483, "post_id": 58892234, "comment_id": 104149157, "body": "Of course, you can mark yourself if this method is suitable for you and may help the people later."}], "tags": [], "owner": {"reputation": 21, "user_id": 11283529, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-us88l8QyX4A/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rfkRzXVIztBznH3xIdxSUk2ow2DvQ/mo/photo.jpg?sz=128", "display_name": "Joel Eng", "link": "https://stackoverflow.com/users/11283529/joel-eng"}, "is_accepted": false, "score": 1, "last_activity_date": 1573917923, "creation_date": 1573917923, "answer_id": 58892234, "question_id": 58869240, "link": "https://stackoverflow.com/questions/58869240/what-is-the-best-way-to-pass-data-from-a-windows-hook-to-another-process/58892234#58892234", "title": "What is the best way to pass data from a Windows hook to another process?", "body": "<p>I appreciate the suggestions. I implemented the mapped memory approach and found that was significantly faster than named pipes, but also more complicated from my perspective. I actually ended up falling back on the Windows messaging system and passed everything using PostMessageW, which was very simple and fast enough. Thanks a lot.</p>\n"}], "owner": {"reputation": 21, "user_id": 11283529, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-us88l8QyX4A/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rfkRzXVIztBznH3xIdxSUk2ow2DvQ/mo/photo.jpg?sz=128", "display_name": "Joel Eng", "link": "https://stackoverflow.com/users/11283529/joel-eng"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 119, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1573917923, "creation_date": 1573782844, "last_edit_date": 1573783615, "question_id": 58869240, "link": "https://stackoverflow.com/questions/58869240/what-is-the-best-way-to-pass-data-from-a-windows-hook-to-another-process", "title": "What is the best way to pass data from a Windows hook to another process?", "body": "<p>I have implemented a Windows keyboard hook in Rust and would like to pass the data it reads to another process that can actually make use of the data. I tried creating a named pipe and having the callback function write the data to the pipe, but I've found there is a significant amount of overhead in that method. What methods would you suggest for passing data from keyboard hooks to another process?</p>\n"}, {"tags": ["unit-testing", "testing", "parallel-processing", "rust", "automated-tests"], "comments": [{"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1573803600, "post_id": 58866421, "comment_id": 104012667, "body": "Can&#39;t you just use a <code>Mutex</code>?"}], "owner": {"reputation": 1498, "user_id": 6844327, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/9fWJl.jpg?s=128&g=1", "display_name": "HiDefender", "link": "https://stackoverflow.com/users/6844327/hidefender"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 51, "favorite_count": 0, "closed_date": 1573831654, "answer_count": 0, "score": 1, "last_activity_date": 1573772263, "creation_date": 1573765177, "last_edit_date": 1573771516, "question_id": 58866421, "link": "https://stackoverflow.com/questions/58866421/running-some-tests-sequentially-while-others-in-parallel", "closed_reason": "Duplicate", "title": "Running Some Tests Sequentially While Others in Parallel", "body": "<p>I have several tests:</p>\n\n<pre><code>#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn foo() {\n        // Must be run sequentially\n    }\n\n    #[test]\n    fn bar() {\n        // Must be run sequentially.\n    }\n\n    #[test]\n    fn baz() {\n        // Can be run in parallel.\n    }\n\n    #[test]\n    fn qux() {\n        // Can be run in parallel.\n    }\n}\n</code></pre>\n\n<p><code>foo()</code> and <code>bar()</code> must be run sequentially, because they might race with themselves or another test not shown.</p>\n\n<p>I can prevent a race condition by only using one thread to test, <code>cargo test -- --test-threads=1</code>. But I don't want to do this because I'd like <code>baz()</code> and <code>qux()</code> to be run in parallel.</p>\n\n<p>I could also place the <code>#[ignore]</code> attribute on <code>foo()</code> and <code>bar()</code>. Call <code>cargo test</code> to invoke <code>baz()</code> and <code>qux()</code> in parallel, then just individually run <code>foo()</code> and <code>bar()</code>, but that is a lot of work.</p>\n\n<p>Is there any way to ensure that <code>foo()</code> and <code>bar()</code> run sequentially, but all other tests run in parallel with a single invocation of <code>cargo test</code>? For reference <a href=\"https://doc.rust-lang.org/reference/attributes.html\" rel=\"nofollow noreferrer\">here</a> are the current attributes.</p>\n"}, {"tags": ["rust", "rust-macros"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1573772427, "post_id": 58864579, "comment_id": 104004880, "body": "Hi there. It&#39;s currently really hard for us to understand what exactly you are asking. What is your goal exactly? Please <a href=\"https://stackoverflow.com/posts/58864579/edit\">edit</a> your question to clarify that."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 3, "last_activity_date": 1573770109, "creation_date": 1573770109, "answer_id": 58867403, "question_id": 58864579, "link": "https://stackoverflow.com/questions/58864579/can-i-detect-if-an-expression-is-a-mutable-variable-using-rusts-macro-repetitio/58867403#58867403", "title": "Can I detect if an expression is a mutable variable using Rust&#39;s macro repetition?", "body": "<p>Macros only can access token streams, and cannot say anything more about those tokens, apart from what is explicitly given to the macro.</p>\n\n<p>For example, consider this code:</p>\n\n<pre><code>fn main() {\n    let mut foo: i32 = 1;\n    my_macro!(foo);\n}\n</code></pre>\n\n<p>The only information available to the macro <code>my_macro</code> is the input token <code>foo</code>. It can match that <code>foo</code> is is an identifier but it can't say anything more about it. The fact that there is mutable binding called <code>foo</code>, or that this binding is an <code>i32</code> are just not available inside the macro.</p>\n"}], "owner": {"reputation": 198, "user_id": 6239815, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/981e711a47505488f6e0f8e5b9c2ef2e?s=128&d=identicon&r=PG&f=1", "display_name": "CS QGB", "link": "https://stackoverflow.com/users/6239815/cs-qgb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 76, "favorite_count": 1, "answer_count": 1, "score": 0, "last_activity_date": 1573850104, "creation_date": 1573760380, "last_edit_date": 1573850104, "question_id": 58864579, "link": "https://stackoverflow.com/questions/58864579/can-i-detect-if-an-expression-is-a-mutable-variable-using-rusts-macro-repetitio", "title": "Can I detect if an expression is a mutable variable using Rust&#39;s macro repetition?", "body": "<pre><code>macro_rules! log {\n    ($($x:expr),*) =&gt; {\n        {\n            $(\n             //how to detect $x in the Macro repetition?\n\n            )*\n        }\n    };\n}\n</code></pre>\n\n<p>I don't want to use <code>($($x:ident),*)</code>. The <code>log!</code> macro can log the expression and then I want to match the variable type.</p>\n"}, {"tags": ["struct", "rust", "signal-processing", "traits"], "answers": [{"comments": [{"owner": {"reputation": 307, "user_id": 3274010, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/100000728860691/picture?type=large", "display_name": "Reginald Marr", "link": "https://stackoverflow.com/users/3274010/reginald-marr"}, "edited": false, "score": 0, "creation_date": 1573763950, "post_id": 58864409, "comment_id": 104001684, "body": "Right, I do like how that leaves the implementation up to the implementer, the thing I&#39;d really like to do is provide flexibility in choosing whether or not there is an inverse_transform. Or perhaps something additional like a post inverse_filter."}], "tags": [], "owner": {"reputation": 30359, "user_id": 255688, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/74b63650ed07d745fd9accf52e4d286b?s=128&d=identicon&r=PG", "display_name": "phimuemue", "link": "https://stackoverflow.com/users/255688/phimuemue"}, "is_accepted": false, "score": 1, "last_activity_date": 1573759695, "creation_date": 1573759695, "answer_id": 58864409, "question_id": 58864178, "link": "https://stackoverflow.com/questions/58864178/is-there-a-better-way-to-organize-this-behaviour-as-a-collection-of-traits/58864409#58864409", "title": "Is there a better way to organize this behaviour as a collection of traits?", "body": "<p>Why not have a trait somewhat like this:</p>\n\n<pre><code>trait TransformOptions {\n    fn transform(&amp;self, &amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n    fn filter(&amp;self, &amp;mut [SourceType; FFT_SIZE], [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n    fn inverse_transform(&amp;self, &amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n}\n</code></pre>\n\n<p>Then, each implementor can decide itself if it wants to actually do work in <code>transform</code>, <code>filter</code> and <code>inverse_transform</code>. Then, instead of checking if a function is present, you simply call it, and it potentially is a no-op.</p>\n"}], "owner": {"reputation": 307, "user_id": 3274010, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/100000728860691/picture?type=large", "display_name": "Reginald Marr", "link": "https://stackoverflow.com/users/3274010/reginald-marr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 36, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1573764323, "creation_date": 1573758728, "last_edit_date": 1573764323, "question_id": 58864178, "link": "https://stackoverflow.com/questions/58864178/is-there-a-better-way-to-organize-this-behaviour-as-a-collection-of-traits", "title": "Is there a better way to organize this behaviour as a collection of traits?", "body": "<p>I'm putting together an audio dsp and I'm looking for a more \"rustacean\" way to implement the following:</p>\n\n<pre><code>pub struct TransformOptions&lt;SourceType&gt; {\n    transform         : Option&lt;Box&lt;dyn Fn(&amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE])&gt;&gt;,\n    filter            : Option&lt;Box&lt;dyn Fn(&amp;mut [SourceType; FFT_SIZE], [SourceType; FFT_SIZE])&gt;&gt;,\n    inverse_transform : Option&lt;Box&lt;dyn Fn(&amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE])&gt;&gt;\n    //should try anddo this in an array\n    //options           : [Option; NUM_TRANSFORM_OPTIONS],\n}\n\nimpl&lt;SourceType : Default&gt; TransformOptions&lt;SourceType&gt; {\n    fn cycle_through(&amp;self, input : [SourceType; FFT_SIZE])-&gt;[SourceType; FFT_SIZE] {\n        //let input : [T ; FFT_SIZE] = arr![T; FFT_SIZE];\n        //This represents the amplitude of the signal represented as the distance from the origin on a unit circle\n        //Here we transform the signal from the time domain to the frequency domain.\n        //Note that humans can only hear sound with a frequency between 20Hz and 20_000Hz\n        // fft.process(&amp;mut time_ring_buffer[time_index..time_index + fft_size], &amp;mut complex_freq_buffer[..]);\n        if  let Some(_) = self.transform{\n            let transform_func = self.transform.unwrap();\n            let output = input.clone();\n            transform_func(&amp;input, &amp;output);\n            input = output;\n        }\n        //the analytic array acts as a filter, removing the negative and dc portions\n        //of the signal as well as filtering out the nyquist portion of the signal\n        //Also applies the hamming window here\n\n        // By applying the inverse fourier transform we transform the signal from the frequency domain back into the\n        if  let Some(_) = self.filter {\n            let filter_func = self.filter.unwrap();\n            /*\n               this is roughly how it should go down\n               | input, coefficient | {\n               for input_idx in index.ter() {\n                    input_idx = input_idx * coeffcient[input_idx.index];\n               }\n               }\n            */\n            input = filter_func(&amp;input);\n        }\n        // By applying the inverse fourier transform we transform the signal from the frequency domain back into the\n        // time domain. However now this signal can be represented as a series of points on a unit circle.\n        // ifft.process(&amp;mut complex_freq_buffer[..], &amp;mut complex_analytic_buffer[..]);\n        if  let Some(_) = self.inverse_transform {\n            let transform_func = self.inverse_transform.unwrap();\n            let output = input.clone();\n            transform_func(&amp;input, &amp;output);\n            input = output;\n        }\n        input\n    }\n}\n</code></pre>\n\n<p>Essentially what I'd like to do is have some sort of trait which collects some subtraits and checks if they are implemented on this struct. If they are then it was call their respective top level function and pass data through appropriately. I'm not sure if there is a better way to accomplish this than what I have currently.</p>\n\n<p>Edit: Something like this is what I'm shooting for\nIs it possible/advisable to do something like this ?</p>\n\n<pre><code>\ntrait Transform {\n    fn transform(&amp;self, &amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n}\n\ntrait InverseTransform {\n    fn filter(&amp;self, &amp;mut [SourceType; FFT_SIZE], [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n}\n\ntrait InverseTransform {\n    fn inverse_transform(&amp;self, &amp;mut [SourceType; FFT_SIZE], &amp;mut [SourceType; FFT_SIZE]) {\n        // default implementation does nothing\n    }\n}\ntrait TransformOptions {\n    //Check for and use the above traits in here somehow. Leaving room for implementation\n}\n</code></pre>\n"}, {"tags": ["rust", "system-calls", "interrupt"], "comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 2, "creation_date": 1573763135, "post_id": 58863886, "comment_id": 104001377, "body": "Your code is weird, <code>sys_write</code> is number <code>1</code> in x64, but <code>4</code> in x32, so since your <code>eax=1</code> I&#39;m guessing you are in x64 mode, but then you&#39;re using 32-bit registers! Moreover, the <code>fd</code> argument, that I&#39;m guessing you want it to be <code>1 (stdout)</code> should be passed in some register too."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 1, "creation_date": 1573763725, "post_id": 58863886, "comment_id": 104001594, "body": "... but your Godbolt link is 32-bits, but in 32-bit Linux, syscall number 1 is <code>sys_exit</code>."}, {"owner": {"reputation": 1200, "user_id": 2501758, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/85bc622278325facbdf1e8b7cb1e7250?s=128&d=identicon&r=PG", "display_name": "Tuomas Laakkonen", "link": "https://stackoverflow.com/users/2501758/tuomas-laakkonen"}, "reply_to_user": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1573864801, "post_id": 58863886, "comment_id": 104039892, "body": "@rodrigo This isn&#39;t Linux. I&#39;m writing my own basic OS, and for now I only have one syscall (print) with number 1. Everything is in 32-bit because I&#39;ve decided to develop for protected mode not long mode. Sorry for the confusion!"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1573907265, "post_id": 58863886, "comment_id": 104047128, "body": "Ahhh, that explains the lacking of OS tag. Anyway I&#39;ve tested the proper code in Linux and both versions print just one line, as expected. I&#39;m guessing this is not a Rust issue, but maybe there is a bug in your OS."}, {"owner": {"reputation": 1200, "user_id": 2501758, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/85bc622278325facbdf1e8b7cb1e7250?s=128&d=identicon&r=PG", "display_name": "Tuomas Laakkonen", "link": "https://stackoverflow.com/users/2501758/tuomas-laakkonen"}, "reply_to_user": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1573945704, "post_id": 58863886, "comment_id": 104056706, "body": "@rodrigo Damn :/ I&#39;ve had a look but I can&#39;t find a bug. I guess it goes into the long list of weird kernel bugs I can&#39;t explain.. thanks for the help though. For the record, which version of the compiler were you using?"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1573992493, "post_id": 58863886, "comment_id": 104064173, "body": "I used <code>rustc 1.40 nightly</code>, to be able to use the <code>asm!</code>. On second thought maybe your bug is in the implementation of the <code>std</code> module?"}], "owner": {"reputation": 1200, "user_id": 2501758, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/85bc622278325facbdf1e8b7cb1e7250?s=128&d=identicon&r=PG", "display_name": "Tuomas Laakkonen", "link": "https://stackoverflow.com/users/2501758/tuomas-laakkonen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 132, "favorite_count": 0, "answer_count": 0, "score": 4, "last_activity_date": 1573829307, "creation_date": 1573757445, "last_edit_date": 1573829307, "question_id": 58863886, "link": "https://stackoverflow.com/questions/58863886/why-is-a-syscall-from-inline-assembly-executed-twice-when-called-directly-from-p", "title": "Why is a syscall from inline assembly executed twice when called directly from println, but not when stored in a temporary variable?", "body": "<p>I have the following function which triggers a syscall in my OS to print a string to the screen:</p>\n\n<pre><code>pub fn print(ptr: *const u8, len: usize) -&gt; u32 {\n    let r: u32;\n    unsafe {\n        asm!(\"int 0x80\" : \"={eax}\"(r) : \"{eax}\"(1u32), \"{esi}\"(ptr as u32), \"{ecx}\"(len as u32) : : \"intel\");\n    }\n    r\n}\n</code></pre>\n\n<p>However, when I execute it as follows:</p>\n\n<pre><code>const s: &amp;'static str = \"Hello, World!\\n\";\nprintln!(\"{}\", print(s.as_ptr(), s.len()));\n</code></pre>\n\n<p>I get the following output:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Hello, World!\nHello, World!\n0\n</code></pre>\n\n<p>But, when I write this:</p>\n\n<pre><code>const s: &amp;'static str = \"Hello, World!\\n\";\nlet r = print(s.as_ptr(), s.len());\nprintln!(\"{}\", r);\n</code></pre>\n\n<p>It correctly prints:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Hello, World!\n0\n</code></pre>\n\n<p>Looking at this in <a href=\"https://godbolt.org/z/mmjeHs\" rel=\"nofollow noreferrer\">Godbolt</a>, I can see that there is only one <code>int</code> instruction that would be triggering the syscall, and as far as I can tell, the <code>print</code> function is only called once. I've never experienced side-effects occurring twice in Rust before. Does anyone know what is causing this strange behaviour?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 5304, "user_id": 2757035, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/fade5daafd5717576b33f2e08f4f9429?s=128&d=identicon&r=PG&f=1", "display_name": "underscore_d", "link": "https://stackoverflow.com/users/2757035/underscore-d"}, "edited": false, "score": 2, "creation_date": 1573750843, "post_id": 58862093, "comment_id": 103995091, "body": "&quot;<i>I get why the error is being returned</i>&quot; Could you quote it in your post? That could help future users find this."}], "answers": [{"comments": [{"owner": {"reputation": 847, "user_id": 2415238, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/nGfYo.png?s=128&g=1", "display_name": "notquiteamonad", "link": "https://stackoverflow.com/users/2415238/notquiteamonad"}, "edited": false, "score": 0, "creation_date": 1573752127, "post_id": 58862436, "comment_id": 103995783, "body": "While this might help their general solution, it doesn&#39;t answer the question. The question asked was how to return the value as a reference, not how to hash the data."}], "tags": [], "owner": {"reputation": 83, "user_id": 3217587, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/PZFMW.jpg?s=128&g=1", "display_name": "z2oh", "link": "https://stackoverflow.com/users/3217587/z2oh"}, "is_accepted": false, "score": 0, "last_activity_date": 1573751969, "creation_date": 1573751969, "answer_id": 58862436, "question_id": 58862093, "link": "https://stackoverflow.com/questions/58862093/returns-a-value-referencing-data-owned-by-the-current-function/58862436#58862436", "title": "returns a value referencing data owned by the current function", "body": "<p>I'm not sure which hashing library you are using, but there should be a way to get the actual hash data (instead of a reference to it). Looking at your code, this will probably be a value of type <code>[u8; 32]</code>. This is the value you want to return from your function.</p>\n"}, {"tags": [], "owner": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "is_accepted": true, "score": 4, "last_activity_date": 1573751969, "creation_date": 1573751969, "answer_id": 58862437, "question_id": 58862093, "link": "https://stackoverflow.com/questions/58862093/returns-a-value-referencing-data-owned-by-the-current-function/58862437#58862437", "title": "returns a value referencing data owned by the current function", "body": "<p>Short answer: You can't. That's because <code>digest()</code> returns an owned value and <code>as_ref()</code> (by definition) borrows from it. When the function returns, the memory owned by the return value of <code>digest()</code> is destroyed and the referenced returned by <code>as_ref()</code> becomes invalid.</p>\n\n<p>I guess your goal is to hide the implementation detail that <code>digest()</code> returns a <code>GenericArray</code>, while you only need a <code>&amp;[u8]</code>. You can get something similar by hiding the concrete type:</p>\n\n<pre><code>fn sha512_256_digest(str: &amp;[u8]) -&gt; impl AsRef&lt;[u8]&gt; {\n    digest::digest(&amp;digest::SHA512_256, str)\n}\n</code></pre>\n\n<p>... should work. The function signature says that the return value will be some anonymous type which the caller can only ever know about that it can be referenced as if it was a <code>&amp;[u8]</code>. The caller can do</p>\n\n<pre><code>// `d` is of some anonymous type\nlet d = sha512_256_digest(...);\n\n// `db` is a &amp;[u8]\nlet db = d.as_ref();\n</code></pre>\n\n<p>However, I'd recommend <em>not</em> to hide types in such a way.</p>\n"}, {"tags": [], "owner": {"reputation": 847, "user_id": 2415238, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/nGfYo.png?s=128&g=1", "display_name": "notquiteamonad", "link": "https://stackoverflow.com/users/2415238/notquiteamonad"}, "is_accepted": false, "score": 1, "last_activity_date": 1573752065, "creation_date": 1573752065, "answer_id": 58862463, "question_id": 58862093, "link": "https://stackoverflow.com/questions/58862093/returns-a-value-referencing-data-owned-by-the-current-function/58862463#58862463", "title": "returns a value referencing data owned by the current function", "body": "<p>Since the value you're returning is created in (and thus owned by) the function, a reference to it <strong>cannot</strong> be returned as it won't exist once the function finishes.</p>\n\n<p>You must either change the function to return an owned value or make its argument a mutable reference <code>&amp;mut [u8]</code> and remove the return - so your options for function signatures would probably be one of the following:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn sha512_256_digest(str: &amp;mut [u8])\n</code></pre>\n\n<p>or</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn sha512_256_digest(str: &amp;[u8]) -&gt; Vec&lt;u8&gt;\n</code></pre>\n\n<p>A complete example with the former would be:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut x = &lt;insert your byte array here&gt;;\nsha512_256_digest(&amp;mut x);\n&lt;use x here&gt;\n</code></pre>\n\n<p>A complete example with the latter would be:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let x = &lt;insert your byte array here&gt;;\nlet y = sha512_256_digest(&amp;x);\n&lt;use y here&gt;\n</code></pre>\n"}], "owner": {"reputation": 105, "user_id": 4018703, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/2t2nz.jpg?s=128&g=1", "display_name": "themonkey", "link": "https://stackoverflow.com/users/4018703/themonkey"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1682, "favorite_count": 0, "closed_date": 1573823021, "accepted_answer_id": 58862437, "answer_count": 3, "score": 3, "last_activity_date": 1593018561, "creation_date": 1573750763, "last_edit_date": 1593018561, "question_id": 58862093, "link": "https://stackoverflow.com/questions/58862093/returns-a-value-referencing-data-owned-by-the-current-function", "closed_reason": "Duplicate", "title": "returns a value referencing data owned by the current function", "body": "<p>This code is throwing an error about returning a reference from the function:</p>\n<pre><code>fn sha512_256_digest(str: &amp;[u8]) -&gt; &amp;[u8] {\n    let x = digest::digest(&amp;digest::SHA512_256, str);\n    x.as_ref()\n}\n</code></pre>\n<p>What would be the correct way to return the <em>as_ref()</em> value of <em>x</em> here?</p>\n"}, {"tags": ["module", "rust", "rust-cargo", "rust-crates"], "comments": [{"owner": {"reputation": 222, "user_id": 10846614, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-LA8RIpBdeSY/AAAAAAAAAAI/AAAAAAAACik/440wHakbStc/photo.jpg?sz=128", "display_name": "Jawwad Turabi", "link": "https://stackoverflow.com/users/10846614/jawwad-turabi"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1573754213, "post_id": 58859681, "comment_id": 103996867, "body": "No its not from another file it is to call the function from another directory in the same src directory"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1573772726, "post_id": 58859681, "comment_id": 104004965, "body": "Hi there! Your problem is not about calling the function. The error message you posted is about your <code>mod library;</code> statement. The Rust compiler should show that line below the error message. In short, the solution to your problem is: rename<code>library&#47;file.rs</code> to <code>library&#47;mod.rs</code>. You should also remove <code>pub mod name1</code> as one usually does not use inline <code>mod</code> definitions. I hope this helps. But I recommend you to read through the answers in the linked questions."}], "answers": [{"tags": [], "owner": {"reputation": 88, "user_id": 12039194, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-QC2gwQPhXLc/AAAAAAAAAAI/AAAAAAAAAJo/D2BPWLeTQqE/photo.jpg?sz=128", "display_name": "Abdur Rehman Siddiqui", "link": "https://stackoverflow.com/users/12039194/abdur-rehman-siddiqui"}, "is_accepted": false, "score": 1, "last_activity_date": 1573744356, "last_edit_date": 1573744356, "creation_date": 1573743691, "answer_id": 58859807, "question_id": 58859681, "link": "https://stackoverflow.com/questions/58859681/how-to-access-the-function-in-main-rs-which-has-been-written-in-a-file-in-differ/58859807#58859807", "title": "How to access the function in main.rs which has been written in a file in different directory in rust in same package", "body": "<p>Create a file in src directory named as library.rs and than in library.rs write the following code:</p>\n\n<pre><code>pub mod file;\n</code></pre>\n\n<p>Than access the same function from your main file as you are doing right now.Than it will work properly.</p>\n\n<p>You can follow this method too</p>\n\n<p><a href=\"https://github.com/Abdul-sid/PIAIC-IOT-RUST-CLASS/tree/master/13th-Oct-chapter-7-part-2/dir-mod-bin/src\" rel=\"nofollow noreferrer\">https://github.com/Abdul-sid/PIAIC-IOT-RUST-CLASS/tree/master/13th-Oct-chapter-7-part-2/dir-mod-bin/src</a></p>\n"}, {"comments": [{"owner": {"reputation": 222, "user_id": 10846614, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-LA8RIpBdeSY/AAAAAAAAAAI/AAAAAAAACik/440wHakbStc/photo.jpg?sz=128", "display_name": "Jawwad Turabi", "link": "https://stackoverflow.com/users/10846614/jawwad-turabi"}, "edited": false, "score": 0, "creation_date": 1573744400, "post_id": 58860002, "comment_id": 103990958, "body": "It doesn&#39;t solve the issue. The error is the same as I change the file name to library.rs"}], "tags": [], "owner": {"reputation": 472, "user_id": 11847611, "user_type": "registered", "profile_image": "https://graph.facebook.com/2399816810113390/picture?type=large", "display_name": "Faheem Uz Zaman", "link": "https://stackoverflow.com/users/11847611/faheem-uz-zaman"}, "is_accepted": false, "score": 0, "last_activity_date": 1573746946, "last_edit_date": 1573746946, "creation_date": 1573744316, "answer_id": 58860002, "question_id": 58859681, "link": "https://stackoverflow.com/questions/58859681/how-to-access-the-function-in-main-rs-which-has-been-written-in-a-file-in-differ/58860002#58860002", "title": "How to access the function in main.rs which has been written in a file in different directory in rust in same package", "body": "<p>You can use the concept of library which rust have in it.\nSimply making a library project having the --lib flag.</p>\n\n<pre><code>cargo build library --lib\n</code></pre>\n\n<p>After doing it. You will write this in your dependency section in <em>Cargo.toml</em>.</p>\n\n<pre><code>library = {path = \"./src/library\"}  \n</code></pre>\n\n<p>You can even use the absolute path of your directory.</p>\n\n<pre><code>library = {path = \"C:/Users/Admin/Desktop/Rust/jawwad/src/library\"}  \n</code></pre>\n\n<p>Then write your library code in lib.rs file.</p>\n\n<pre><code>pub mod name1 {\n    pub fn name(a: i32) -&gt; i32 {\n          println!(\"from diff file {}\", a);\n          a * a\n    }\n}\n</code></pre>\n\n<p>Here is the main.rs file.</p>\n\n<pre><code>use library;\n\nfn main() {\n   println!(\"{}\", library::name1::name(4));\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 26, "user_id": 11267980, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2b8f89fe5be5ae717467a23b93e69bb8?s=128&d=identicon&r=PG&f=1", "display_name": "rajabraza", "link": "https://stackoverflow.com/users/11267980/rajabraza"}, "edited": false, "score": 0, "creation_date": 1573746861, "post_id": 58860819, "comment_id": 103992562, "body": "also delete the &quot;library&quot; directory you created in the src directory"}], "tags": [], "owner": {"reputation": 26, "user_id": 11267980, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2b8f89fe5be5ae717467a23b93e69bb8?s=128&d=identicon&r=PG&f=1", "display_name": "rajabraza", "link": "https://stackoverflow.com/users/11267980/rajabraza"}, "is_accepted": true, "score": 1, "last_activity_date": 1573749280, "last_edit_date": 1573749280, "creation_date": 1573746768, "answer_id": 58860819, "question_id": 58859681, "link": "https://stackoverflow.com/questions/58859681/how-to-access-the-function-in-main-rs-which-has-been-written-in-a-file-in-differ/58860819#58860819", "title": "How to access the function in main.rs which has been written in a file in different directory in rust in same package", "body": "<p>You can fix this issue in 2 different ways:</p>\n\n<p>1 ) Using Module\n2 ) Using Library</p>\n\n<p><strong>Using Module</strong></p>\n\n<p>Simply create a file next to main.rs in <strong>src</strong> directory and name it <strong>name1.rs</strong></p>\n\n<p>name1.rs will look like:</p>\n\n<pre><code>//no need to specify \"pub mod name1;\" explicitly\npub fn name(a: i32) -&gt; i32 {\n   println!(\"from diff file {}\", a);\n   a * a\n}\n</code></pre>\n\n<p>main.rs will look like:</p>\n\n<pre><code>//name of the second file will be treated as module here\npub mod name1;\n\nfn main() {\n   println!(\"{}\", name1::name(4));\n}\n</code></pre>\n\n<p><strong>Using Library</strong></p>\n\n<p>a) create a library, standing in main project directory (i.e. parent of src directory) and run the command below:</p>\n\n<pre><code>//In your case library name \"file\"     \n$ cargo new --lib file\n</code></pre>\n\n<p>This command will create another directory of name file same as your main project.</p>\n\n<p>b) Add this library(file) in the dependency section of Cargo.toml file of main project</p>\n\n<pre><code>[package]\nname = \"test_project\"\nversion = \"0.1.0\"\nauthors = [\"mohammadrajabraza &lt;mohammadrajabraza@gmail.com&gt;\"]\nedition = \"2018\"\n\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\nfile = {path =\"file\"}\n</code></pre>\n\n<p>c) A file under main_project>file(library)>src>lib.rs will be created, once you created library using command above.</p>\n\n<p>lib.rs will be look like:</p>\n\n<pre><code>pub fn name(a: i32) -&gt; i32 {\n             println!(\"from diff file {}\", a);\n             a * a\n}\n</code></pre>\n\n<p>d) and finally your main.rs will be:</p>\n\n<pre><code>//importing library in thescope\nuse file;\n\nfn main() {\n   println!(\"{}\", file::name(4));\n}\n</code></pre>\n"}], "owner": {"reputation": 222, "user_id": 10846614, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-LA8RIpBdeSY/AAAAAAAAAAI/AAAAAAAACik/440wHakbStc/photo.jpg?sz=128", "display_name": "Jawwad Turabi", "link": "https://stackoverflow.com/users/10846614/jawwad-turabi"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1776, "favorite_count": 0, "closed_date": 1573772562, "accepted_answer_id": 58860819, "answer_count": 3, "score": 3, "last_activity_date": 1573948050, "creation_date": 1573743339, "last_edit_date": 1573948050, "question_id": 58859681, "link": "https://stackoverflow.com/questions/58859681/how-to-access-the-function-in-main-rs-which-has-been-written-in-a-file-in-differ", "closed_reason": "Duplicate", "title": "How to access the function in main.rs which has been written in a file in different directory in rust in same package", "body": "<p>I want to call a function inside a main.rs file. I have made one directory name \"library\" inside the same src folder as main.rs exist.</p>\n\n<p>src/main.rs</p>\n\n<pre><code>mod library;\n\nfn main() {\n   println!(\"{}\", library::name1::name(4));\n}\n</code></pre>\n\n<p>src/library/file.rs</p>\n\n<pre><code>pub mod name1 {\n    pub fn name(a: i32) -&gt; i32 {\n        println!(\"from diff file {}\", a);\n        a * a\n    }\n}\n</code></pre>\n\n<p>when I call this function name in main.rs, compiler throws an error:</p>\n\n<blockquote>\n  <p>error[E0583]: file not found for module library</p>\n</blockquote>\n\n<p>I think I am missing something. What is the correct way to do this? Keep in mind that the library directory is just an ordinary directory not a cargo package</p>\n"}, {"tags": ["memory", "enums", "rust"], "comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 3, "creation_date": 1573735186, "post_id": 58856828, "comment_id": 103985404, "body": "&quot;Is there a efficient way to get the size of each enum variant?&quot; \u2192 All variants have the same size, the size of the corresponding enum."}, {"owner": {"reputation": 1460, "user_id": 2655102, "user_type": "registered", "accept_rate": 22, "profile_image": "https://www.gravatar.com/avatar/a14dc4fa847dd6fe776da0cc90cce8cf?s=128&d=identicon&r=PG", "display_name": "Renkai", "link": "https://stackoverflow.com/users/2655102/renkai"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1573738343, "post_id": 58856828, "comment_id": 103987246, "body": "@mcarton &quot;All variants have the same size&quot; which is decided by the size of variant that consumes most memory,if I can find that variant quickly,I can improve my enum  definition quickly.I want to ask how to find that variant quickly, sorry I don&#39;t express well."}, {"owner": {"reputation": 1460, "user_id": 2655102, "user_type": "registered", "accept_rate": 22, "profile_image": "https://www.gravatar.com/avatar/a14dc4fa847dd6fe776da0cc90cce8cf?s=128&d=identicon&r=PG", "display_name": "Renkai", "link": "https://stackoverflow.com/users/2655102/renkai"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1573739160, "post_id": 58856828, "comment_id": 103987732, "body": "@mcarton In the above example,<code>D(String)</code> require most memory size,which is 24,so the size of enum is (24 + 8) = 32.If I replace the <code>D(String)</code> by <code>D(Box&lt;String&gt;)</code>, size of the enum can be reduced to 16.It is a great benefit if rust can tell me <code>D(String)</code> use 24 bytes, which is the max one of all variants,so the enum size should be 32 bytes,if the size of <code>D(String)</code> can be reduced, the size of enum can be reduced,too."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1573739848, "post_id": 58856828, "comment_id": 103988124, "body": "@mcarton while you are technically correct, I think you&#39;re splitting hairs and it&#39;s quite clear what OP intended. There is even a Clippy lint for <i>&quot;large size difference between variants on an enum&quot;</i>, because there is a concept of the size of an enum and space utilisation of each variant."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1573743444, "post_id": 58856828, "comment_id": 103990366, "body": "Tangentially, in a case like the example, you may also use <code>Box&lt;str&gt;</code> which is mostly the same as <code>Box&lt;String&gt;</code> but only costs 16 bytes, so this whole enum would fit in 24 while avoiding the cost of double indirection. There is rarely a good reason to use <code>Box&lt;String&gt;</code>."}], "answers": [{"tags": [], "owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "is_accepted": false, "score": 2, "last_activity_date": 1573743241, "creation_date": 1573743241, "answer_id": 58859650, "question_id": 58856828, "link": "https://stackoverflow.com/questions/58856828/how-to-find-biggest-variant-in-an-enum-in-rust/58859650#58859650", "title": "How to find biggest variant in an enum in Rust?", "body": "<p>No, there is no way to get the size of just one variant of an <code>enum</code>. The best you can do is get the size of what the variant contains, as if it were a standalone struct:</p>\n\n<pre><code>    println!(\"sizeof EE::A: {}\", std::mem::size_of::&lt;()&gt;());         // 0\n    println!(\"sizeof EE::B: {}\", std::mem::size_of::&lt;i32&gt;());        // 4\n    println!(\"sizeof EE::C: {}\", std::mem::size_of::&lt;i64&gt;());        // 8\n    println!(\"sizeof EE::D: {}\", std::mem::size_of::&lt;String&gt;());     // 24\n    println!(\"sizeof EE::E: {}\", std::mem::size_of::&lt;(i64, i32)&gt;()); // 16\n</code></pre>\n\n<p>Even this isn't especially useful because it includes padding bytes that may be used to store the tag; as you point out, the size of the <code>enum</code> can be reduced to 16 if <code>D</code> is shrunk to a single pointer, but you can't know that from looking at just the sizes. If <code>y</code> were instead defined as <code>i64</code>, the size of each variant would be the same, but the size of the <code>enum</code> would need to be 24. Alignment is another confounding factor that makes the size of an <code>enum</code> more complex than just \"the size of the largest variant plus the tag\".</p>\n\n<p>Of course, this is all highly platform-dependent, and your code should not rely on any <code>enum</code> having a particular layout (unless you can guarantee it with a <code>#[repr]</code> annotation).</p>\n\n<p>If you have a particular <code>enum</code> you're worried about, it's not difficult to get the size of each contained type. Clippy also has a lint for <code>enum</code>s with extreme size differences between variants. However, I don't recommend using size alone to make manual optimizations to <code>enum</code> layouts, or boxing things that are only a few pointers in size -- indirection suppresses other kinds of optimizations the compiler may be able to do. If you prioritize minimal space usage you may accidentally make your code much slower in the process.</p>\n"}], "owner": {"reputation": 1460, "user_id": 2655102, "user_type": "registered", "accept_rate": 22, "profile_image": "https://www.gravatar.com/avatar/a14dc4fa847dd6fe776da0cc90cce8cf?s=128&d=identicon&r=PG", "display_name": "Renkai", "link": "https://stackoverflow.com/users/2655102/renkai"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 307, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1573743241, "creation_date": 1573734601, "last_edit_date": 1573742869, "question_id": 58856828, "link": "https://stackoverflow.com/questions/58856828/how-to-find-biggest-variant-in-an-enum-in-rust", "title": "How to find biggest variant in an enum in Rust?", "body": "<p>I'm trying to improve the performance of a rust program, which requires me to reduce the size of some large <code>enum</code>s. For example</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>enum EE {\n    A, // 0\n    B(i32), //4\n    C(i64), // 8\n    D(String), // 24\n    E { // 16\n        x: i64,\n        y: i32,\n    },\n}\n\nfn main() {\n    println!(\"{}\", std::mem::size_of::&lt;EE&gt;()); // 32\n}\n</code></pre>\n\n<p>prints <code>32</code>. But if I want to know the size of <code>EE::A</code>, I get a compile error</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>error[E0573]: expected type, found variant `EE::A`\n  --&gt; src/main.rs:14:40\n   |\n14 |     println!(\"{}\", std::mem::size_of::&lt;EE::A&gt;());\n   |                                        ^^^^^\n   |                                        |\n   |                                        not a type\n   |                                        help: try using the variant's enum: `crate::EE`\n\nerror: aborting due to previous error\n\nerror: could not compile `play_rust`.\n</code></pre>\n\n<p>Is there a way to find out which variant takes the most space?</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 334, "user_id": 494308, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/dfe6a2426956a1d9c7f9ec4baa72535f?s=128&d=identicon&r=PG", "display_name": "Max Levy", "link": "https://stackoverflow.com/users/494308/max-levy"}, "edited": false, "score": 0, "creation_date": 1574043691, "post_id": 58864483, "comment_id": 104077009, "body": "Does it mean that it&#39;s possible to have <code>zip_archive</code> as a function parameter instead, in order to overcome the problem?"}], "tags": [], "owner": {"reputation": 1862, "user_id": 4658000, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/0Sw3Y.jpg?s=128&g=1", "display_name": "Le\u015bny Rumcajs", "link": "https://stackoverflow.com/users/4658000/le%c5%9bny-rumcajs"}, "is_accepted": false, "score": 1, "last_activity_date": 1573760039, "creation_date": 1573760039, "answer_id": 58864483, "question_id": 58856599, "link": "https://stackoverflow.com/questions/58856599/a-rust-function-to-return-an-iterator-over-lines-of-a-zipped-file/58864483#58864483", "title": "A Rust function to return an iterator over lines of a zipped file", "body": "<p>The issue is that <code>read_zip_file</code> is doing much more than the <code>read_file_iterator</code> - <code>ZipFile</code> mutably <em>borrows</em> <code>zip_archive</code> which then goes out of scope. <code>ZipFile</code> does not exist without <code>ZipArchive</code>. This is not allowed, as the borrow checker suggested.</p>\n\n<p>One approach would be to unzip this particular file as a temporary (as your ordinary zip browser does) and then do the iteration as in your first snippet. If the file is small and you know it beforehand - you better just collect the data, with e.g. <a href=\"https://doc.rust-lang.org/nightly/std/io/trait.Read.html#method.read_to_end\" rel=\"nofollow noreferrer\">read_to_end</a> which <code>ZipFile</code> implements.</p>\n"}], "owner": {"reputation": 334, "user_id": 494308, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/dfe6a2426956a1d9c7f9ec4baa72535f?s=128&d=identicon&r=PG", "display_name": "Max Levy", "link": "https://stackoverflow.com/users/494308/max-levy"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 222, "favorite_count": 1, "answer_count": 1, "score": 1, "last_activity_date": 1573760039, "creation_date": 1573733813, "last_edit_date": 1573742053, "question_id": 58856599, "link": "https://stackoverflow.com/questions/58856599/a-rust-function-to-return-an-iterator-over-lines-of-a-zipped-file", "title": "A Rust function to return an iterator over lines of a zipped file", "body": "<p>I found code for a function that returns an iterator over the lines of a text file:</p>\n\n<pre><code>pub fn read_file_iterator(path: &amp;str) -&gt; io::Result&lt;Lines&lt;BufReader&lt;File&gt;&gt;&gt; {\n    let file = File::open(path)?;\n    let buf_reader = BufReader::new(file);\n    // lines() returns an iterator over lines\n    Ok(buf_reader.lines())\n}\n</code></pre>\n\n<p>Having zero experience with Rust, I thought I could adopt this code for a file which is a part of a ZIP archive:</p>\n\n<pre><code>use std::io::prelude::*;\nuse std::io::{self, BufReader, Lines, Cursor};\nuse std::path::Path;\nuse zip::read::ZipFile;\n\npub fn read_zip_file(_filename: &amp;Path) -&gt; io::Result&lt;Lines&lt;BufReader&lt;ZipFile&gt;&gt;&gt; {\n    let reader = Cursor::new(std::fs::read(_filename)?);\n\n    let mut zip_archive = zip::ZipArchive::new(reader)?;\n\n    assert_eq!(1, zip_archive.len());\n\n    let zip_file: ZipFile = zip_archive.by_index(0).unwrap(); // E: `zip_archive` is borrowed here\"\n\n    let buf_reader = BufReader::new(zip_file);\n\n    Ok(buf_reader.lines()) // E: returns a value referencing data owned by the current function\n}\n</code></pre>\n\n<p>Building this code results in an error (see also the comments that reflect the error details):</p>\n\n<blockquote>\n  <p>cannot return value referencing local variable <code>zip_archive</code></p>\n</blockquote>\n\n<p>What is the right way of writing such a function?</p>\n"}, {"tags": ["string", "join", "vector", "rust"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1573730924, "post_id": 58855349, "comment_id": 103983129, "body": "There isn&#39;t much point having a <code>Vec&lt;&amp;String&gt;</code>. A <code>Vec&lt;&amp;str&gt;</code> is the same but more flexible."}], "answers": [{"comments": [{"owner": {"reputation": 31, "user_id": 4314040, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jAkFj.png?s=128&g=1", "display_name": "Yuanbo Han", "link": "https://stackoverflow.com/users/4314040/yuanbo-han"}, "edited": false, "score": 0, "creation_date": 1573785510, "post_id": 58855827, "comment_id": 104007976, "body": "Thanks, Jmb. I know <code>&amp;String</code> is discouraged, and I rarely use it. I really appreciate it   if you can help to explain it."}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 2, "last_activity_date": 1573731185, "creation_date": 1573731185, "answer_id": 58855827, "question_id": 58855349, "link": "https://stackoverflow.com/questions/58855349/join-a-string-vector-in-rust/58855827#58855827", "title": "join a string vector in rust", "body": "<p>In general, using a <code>&amp;String</code> is discouraged: if you need an owned copy, use a <code>String</code> and if you need a reference, use an <code>&amp;str</code>. Automatic dereferencing allows this to be reasonably transparent:</p>\n\n<pre><code>let foo: String = \"foo\".to_string();\nlet bar: String = \"bar\".to_string();\nlet v3: Vec&lt;&amp;str&gt; = vec![&amp;foo, &amp;bar];\n</code></pre>\n\n<p><strong>Note:</strong> In the above code, you don't really need to write the types explicitly, but I put them in to show that a <code>Vec&lt;&amp;str&gt;</code> can be built transparently from references to variables of type <code>String</code>.</p>\n"}], "owner": {"reputation": 31, "user_id": 4314040, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jAkFj.png?s=128&g=1", "display_name": "Yuanbo Han", "link": "https://stackoverflow.com/users/4314040/yuanbo-han"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 384, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1573731185, "creation_date": 1573729629, "last_edit_date": 1573730840, "question_id": 58855349, "link": "https://stackoverflow.com/questions/58855349/join-a-string-vector-in-rust", "title": "join a string vector in rust", "body": "<p>I want to join a <strong>string</strong> vector into a <code>String</code>, but I got confused on the different result of vector of <code>&amp;str</code> <code>&amp;String</code> <code>String</code>:</p>\n\n<pre><code>let v1: Vec&lt;String&gt; = vec![\"foo\".to_string(), \"bar\".to_string()];\nprintln!(\"{:?}\", v1.join(\",\")); // OK\n\nlet v2: Vec&lt;&amp;str&gt; = vec![\"foo\", \"bar\"];\nprintln!(\"{:?}\", v2.join(\",\")); // OK\n\nlet foo = \"foo\".to_string();\nlet bar = \"bar\".to_string();\nlet v3: Vec&lt;&amp;String&gt; = vec![&amp;foo, &amp;bar];\nprintln!(\"{:?}\", v3.join(\",\")); // error\n</code></pre>\n\n<p>Here's the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0599]: no method named `join` found for type `std::vec::Vec&lt;&amp;std::string::String&gt;` in the current scope\n  --&gt; src/main.rs:11:21\n   |\n11 | println!(\"{:?}\", v3.join(\",\")); // error\n   |                     ^^^^ method not found in `std::vec::Vec&lt;&amp;std::string::String&gt;`\n</code></pre>\n\n<p>Any help and explanation is really welcome</p>\n"}, {"tags": ["rust", "borrow-checker"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1573750505, "post_id": 58855297, "comment_id": 103994864, "body": "You should either store only <code>Vec&lt;u8&gt;</code> (if you want <code>Parsed</code> to own the data) or only <code>&amp;a [u8]</code> (if you want <code>Parsed&lt;&#39;a&gt;</code> to reference the data owned elsewhere)."}], "owner": {"reputation": 11, "user_id": 12372101, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/a-/AAuE7mALPNyk2dIxf6qbo5F7dZuMfaohjJawZ5gSy37mipQ=k-s128", "display_name": "\u0411\u0430\u0440\u0438\u043d\u043e\u0432 \u0421\u0435\u0440\u0433\u0435\u0439", "link": "https://stackoverflow.com/users/12372101/%d0%91%d0%b0%d1%80%d0%b8%d0%bd%d0%be%d0%b2-%d0%a1%d0%b5%d1%80%d0%b3%d0%b5%d0%b9"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 32, "favorite_count": 0, "closed_date": 1573730743, "answer_count": 0, "score": 1, "last_activity_date": 1573730305, "creation_date": 1573729441, "last_edit_date": 1573730305, "question_id": 58855297, "link": "https://stackoverflow.com/questions/58855297/is-there-way-to-make-stuct-contains-inner-references", "closed_reason": "Duplicate", "title": "Is there way to make stuct, contains inner references?", "body": "<p>How can I do something like that:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>    struct Parsed&lt;'a&gt; {\n        bytes: Vec&lt;u8&gt;,\n        h: &amp;'a [u8]\n    }\n    impl&lt;'a&gt; Parsed&lt;'a&gt; {\n        fn new(bytes: Vec&lt;u8&gt;) -&gt; Self {\n            let h = bytes.as_slice();\n            Parsed {\n                bytes,\n                h,\n            }\n        }\n    }\n</code></pre>\n\n<p>I need it for parsing messages with nom from tcp streams without copy objects.\nCause I know size of messages, I can prepare some byte array for nom, but cannot return parsed messages to caller. I think it's a good idea to place buffer inside message struct, but it fail with rust borrow-checker :'(</p>\n\n<p>Borrow checker says as follows:</p>\n\n<pre><code>error[E0515]: cannot return value referencing function parameter `bytes`\n   --&gt; src/main.rs:217:13\n    |\n216 |               let h = bytes.as_slice();\n    |                       ----- `bytes` is borrowed here\n217 | /             Parsed {\n218 | |                 bytes,\n219 | |                 h,\n220 | |             }\n    | |_____________^ returns a value referencing data owned by the current function\n\nerror[E0505]: cannot move out of `bytes` because it is borrowed\n   --&gt; src/main.rs:218:17\n    |\n214 |       impl&lt;'a&gt; Parsed&lt;'a&gt; {\n    |            -- lifetime `'a` defined here\n215 |           fn new(bytes: Vec&lt;u8&gt;) -&gt; Self {\n216 |               let h = bytes.as_slice();\n    |                       ----- borrow of `bytes` occurs here\n217 | /             Parsed {\n218 | |                 bytes,\n    | |                 ^^^^^ move out of `bytes` occurs here\n219 | |                 h,\n220 | |             }\n    | |_____________- returning this value requires that `bytes` is borrowed for `'a`\n</code></pre>\n"}, {"tags": ["rust"], "owner": {"reputation": 11, "user_id": 2353510, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a4797c0907585df4b1710969aa7e7a0f?s=128&d=identicon&r=PG", "display_name": "dkov", "link": "https://stackoverflow.com/users/2353510/dkov"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 37, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1573724599, "creation_date": 1573724599, "question_id": 58853664, "link": "https://stackoverflow.com/questions/58853664/compile-cdylib-with-different-calling-conventions", "title": "Compile cdylib with different calling conventions", "body": "<p>I need to compile a cdylib with extern functions with the cdecl and stdcall calling conventions on windows.</p>\n\n<p>I have some functions declarations like this:</p>\n\n<pre><code>pub extern \"C\" fn foo() -&gt; {}.\n</code></pre>\n\n<p>and I would like to conditionally compile it with:</p>\n\n<pre><code>pub extern \"stdcall\" fn foo() -&gt; {}.\n</code></pre>\n\n<p>So I am looking for the possibility to write:</p>\n\n<pre><code>pub extern fn foo() -&gt; {}\n</code></pre>\n\n<p>and set the calling convention globally or something like this:</p>\n\n<pre><code>#[mymacro]\npub fn foo() -&gt; {}\n</code></pre>\n\n<p>I would prefer the latter, because I would introduce a crate feature and \ncall cargo build --features=stdcall.</p>\n"}, {"tags": ["rust", "extension-methods", "traits"], "answers": [{"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 6, "last_activity_date": 1613674201, "last_edit_date": 1613674201, "creation_date": 1573721617, "answer_id": 58852750, "question_id": 58852640, "link": "https://stackoverflow.com/questions/58852640/rust-equivalent-to-swifts-extension-methods-to-a-protocol/58852750#58852750", "title": "Rust equivalent to Swift&#39;s extension methods to a protocol?", "body": "<p>In Rust, you can use <a href=\"http://xion.io/post/code/rust-extension-traits.html\" rel=\"nofollow noreferrer\"><code>extension traits</code></a>, that is a trait with a generic implementation for all types <code>T</code> that implement the base trait:</p>\n<pre><code>struct Kaz {}\n\nimpl Foo for Kaz {}\n\ntrait Foo {\n    fn sample1(&amp;self) -&gt; isize { 111 } \n}\n\ntrait FooExt {\n    fn sample2(&amp;self);\n}\n\nimpl&lt;T: Foo&gt; FooExt for T {\n    fn sample2(&amp;self) {\n        println!(&quot;{}&quot;, self.sample1());\n    }\n}\n\nfn main() {\n    let x = Kaz {};\n    x.sample1();\n    x.sample2();\n}\n</code></pre>\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e784b921a49eaadf50396b646225f89e\" rel=\"nofollow noreferrer\">Playground</a></p>\n"}], "owner": {"reputation": 74890, "user_id": 246776, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/PZwCJ.jpg?s=128&g=1", "display_name": "eonil", "link": "https://stackoverflow.com/users/246776/eonil"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 803, "favorite_count": 1, "accepted_answer_id": 58852750, "answer_count": 1, "score": 4, "last_activity_date": 1613674201, "creation_date": 1573721176, "question_id": 58852640, "link": "https://stackoverflow.com/questions/58852640/rust-equivalent-to-swifts-extension-methods-to-a-protocol", "title": "Rust equivalent to Swift&#39;s extension methods to a protocol?", "body": "<p>In Swift I can attach extension methods to any of <code>struct</code>, <code>enum</code> or <code>protocol</code>(same with <code>trait</code> in Rust).</p>\n\n<pre class=\"lang-swift prettyprint-override\"><code>protocol Foo1 {\n    func method1() -&gt; Int \n}\nextension Foo1 {\n    func method2() {\n        print(\"\\(method1())\")\n    }\n}\n</code></pre>\n\n<p>Then all types conforming the protocol <code>Foo1</code> now all have <code>method2()</code>. \nThis is very useful to build \"method chaining\" easily.</p>\n\n<p>How to do same in Rust? This doesn't work with an error.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Kaz {}\n\nimpl Foo for Kaz {}\n\ntrait Foo {\n    fn sample1(&amp;self) -&gt; isize { 111 } \n}\n\nimpl Foo {\n    fn sample2(&amp;self) {\n        println!(\"{}\", self.sample1());\n    }\n}\n\nfn main() {\n    let x = Kaz {};\n    x.sample1();\n    x.sample2();\n}\n</code></pre>\n\n<p>Here's the error.</p>\n\n<pre><code>warning: trait objects without an explicit `dyn` are deprecated\n  --&gt; src/main.rs:13:6\n   |\n13 | impl Foo {\n   |      ^^^ help: use `dyn`: `dyn Foo`\n   |\n   = note: `#[warn(bare_trait_objects)]` on by default\n\nerror[E0599]: no method named `sample2` found for type `Kaz` in the current scope\n  --&gt; src/main.rs:22:7\n   |\n3  | struct Kaz {}\n   | ---------- method `sample2` not found for this\n...\n22 |     x.sample2();\n   |       ^^^^^^^ method not found in `Kaz`\n\nerror: aborting due to previous error\n</code></pre>\n"}, {"tags": ["generics", "rust", "traits"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573709305, "post_id": 58849618, "comment_id": 103972819, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=44857edc02636657a4e3c914bdf478b1\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>, you can&#39;t"}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1573732702, "post_id": 58850368, "comment_id": 103984114, "body": "I don&#39;t see any advantage to do this, it&#39;s just noise."}, {"owner": {"reputation": 1568, "user_id": 1099922, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0e30326b099b71f27a3722e10fd66ce4?s=128&d=identicon&r=PG", "display_name": "superdweebie", "link": "https://stackoverflow.com/users/1099922/superdweebie"}, "edited": false, "score": 0, "creation_date": 1573765356, "post_id": 58850368, "comment_id": 104002274, "body": "Thanks @Thayne."}, {"owner": {"reputation": 319, "user_id": 7698902, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/504b47ca61e2dea92102495da1750314?s=128&d=identicon&r=PG&f=1", "display_name": "vandenheuvel", "link": "https://stackoverflow.com/users/7698902/vandenheuvel"}, "edited": false, "score": 0, "creation_date": 1593472757, "post_id": 58850368, "comment_id": 110788656, "body": "In <code>add_number_ref</code>, you don&#39;t need HRTB and can instead just do <code>fn add_number_ref&lt;&#39;a, N: NumberTrait&gt;(a: &amp;&#39;a N, b: &amp;&#39;a N) -&gt; N where &amp;&#39;a N: Add&lt;Output = N&gt; { a + b }</code>."}], "tags": [], "owner": {"reputation": 5869, "user_id": 2543666, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/4e7c6887ce958029525412ab297b5895?s=128&d=identicon&r=PG", "display_name": "Thayne", "link": "https://stackoverflow.com/users/2543666/thayne"}, "is_accepted": true, "score": 0, "last_activity_date": 1573718232, "last_edit_date": 1573718232, "creation_date": 1573711685, "answer_id": 58850368, "question_id": 58849618, "link": "https://stackoverflow.com/questions/58849618/how-to-specify-a-supertrait-for-the-reference-of-a-trait/58850368#58850368", "title": "How to specify a supertrait for the reference of a trait?", "body": "<p>You can do something like this:</p>\n\n<pre><code>use std::ops::Add;\n\npub trait NumberTrait: Sized + Add&lt;Output = Self&gt;\nwhere\n    for&lt;'a&gt; &amp;'a Self: Add&lt;Output = Self&gt;,\n{\n}\n\nfn add_number&lt;N: NumberTrait&gt;(a: N, b: N) -&gt; N\nwhere\n    for&lt;'a&gt; &amp;'a N: Add&lt;Output = N&gt;,\n{\n    a + b\n}\n\nfn add_number_ref&lt;N: NumberTrait&gt;(a: &amp;N, b: &amp;N) -&gt; N\nwhere\n    for&lt;'a&gt; &amp;'a N: Add&lt;Output = N&gt;,\n{\n    a + b\n}\n\n</code></pre>\n\n<p>But most likely, you don't need that constraint everywhere, and you could just put where clause on the <code>add_number_ref</code> function.</p>\n\n<p>See: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b5bdd3633d22ea1e0873d431a6665f9d\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b5bdd3633d22ea1e0873d431a6665f9d</a></p>\n"}], "owner": {"reputation": 1568, "user_id": 1099922, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0e30326b099b71f27a3722e10fd66ce4?s=128&d=identicon&r=PG", "display_name": "superdweebie", "link": "https://stackoverflow.com/users/1099922/superdweebie"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 103, "favorite_count": 0, "accepted_answer_id": 58850368, "answer_count": 1, "score": 1, "last_activity_date": 1573718232, "creation_date": 1573707263, "last_edit_date": 1573707731, "question_id": 58849618, "link": "https://stackoverflow.com/questions/58849618/how-to-specify-a-supertrait-for-the-reference-of-a-trait", "title": "How to specify a supertrait for the reference of a trait?", "body": "<p>I'd like to create a trait that enforces implementation of the <code>Add</code> trait for both the type and a reference to the type. That is, <code>N + N</code> and <code>&amp;N + &amp;N</code> should both be implemented if using the NumberTrait shown below.</p>\n\n<pre><code>use std::ops::Add;\n\n// I think a supertrait needs to be added to NumberTrait,\n// something like &amp;Add&lt;Output = Self&gt;, but I don't know\n// the correct syntax\npub trait NumberTrait: Sized + Add&lt;Output = Self&gt; {}\n\nfn add_number&lt;N: NumberTrait&gt;(a: N, b: N) -&gt; N {\n    a + b\n}\n\nfn add_number_ref&lt;N: NumberTrait&gt;(a: &amp;N, b: &amp;N) -&gt; N {\n    a + b // compiler error occurs in this line: an implementation of `std::ops::Add` might be missing for `&amp;N`\n}\n</code></pre>\n"}, {"tags": ["rust", "actix-web"], "comments": [{"owner": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 0, "creation_date": 1573706871, "post_id": 58849546, "comment_id": 103972172, "body": "Can you please provide the compiler error you&#39;re getting?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1573715718, "post_id": 58849546, "comment_id": 103975064, "body": "Try adding <code>move</code> in front of your closure: <code>move || App::new().service (route)</code>"}, {"owner": {"reputation": 133, "user_id": 4841072, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/d2ced6c99273e990b4c9b38f403244f5?s=128&d=identicon&r=PG&f=1", "display_name": "Zale", "link": "https://stackoverflow.com/users/4841072/zale"}, "reply_to_user": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 0, "creation_date": 1573720406, "post_id": 58849546, "comment_id": 103977079, "body": "@SimonWhitehead lots of error messages, the first one is: within <code>[closure@src\\main.rs:9:21: 9:54 route:actix_web::resource::Resource]</code>, the trait <code>std::clone::Clone</code> is not implemented for `actix_web::resource::Resource"}, {"owner": {"reputation": 133, "user_id": 4841072, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/d2ced6c99273e990b4c9b38f403244f5?s=128&d=identicon&r=PG&f=1", "display_name": "Zale", "link": "https://stackoverflow.com/users/4841072/zale"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1573720515, "post_id": 58849546, "comment_id": 103977135, "body": "@Jmb it doesn&#39;t work."}], "answers": [{"tags": [], "owner": {"reputation": 1862, "user_id": 4658000, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/0Sw3Y.jpg?s=128&g=1", "display_name": "Le\u015bny Rumcajs", "link": "https://stackoverflow.com/users/4658000/le%c5%9bny-rumcajs"}, "is_accepted": true, "score": 2, "last_activity_date": 1573728708, "creation_date": 1573728708, "answer_id": 58855057, "question_id": 58849546, "link": "https://stackoverflow.com/questions/58849546/how-to-extract-variable-in-actix-web-example-code/58855057#58855057", "title": "How to extract variable in actix_web example code?", "body": "<p>The problem is that the service needs exclusive ownership in a multi-threaded environment. Normally you would just clone it but as you noticed, <code>actix_web::resource::Resource</code> does not implement <code>std::clone::Clone</code>. One way would be to implements this trait yourself and call clone. </p>\n\n<p>A simpler way around this would be to use a closure:</p>\n\n<pre><code>fn main() -&gt; std::io::Result&lt;()&gt; {\n    let route = || web::resource(\"/{id}/{name}/index.html\").to(index);\n    HttpServer::new(move || {\n        App::new().service(route())\n    })\n        .bind(\"127.0.0.1:8080\")?\n        .run()\n}\n</code></pre>\n\n<p>You could also go with <a href=\"https://github.com/actix/actix-web/issues/408#issuecomment-406994821\" rel=\"nofollow noreferrer\">this</a> approach, which may be the reason why you want to extract the variable outside.</p>\n"}], "owner": {"reputation": 133, "user_id": 4841072, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/d2ced6c99273e990b4c9b38f403244f5?s=128&d=identicon&r=PG&f=1", "display_name": "Zale", "link": "https://stackoverflow.com/users/4841072/zale"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 115, "favorite_count": 0, "accepted_answer_id": 58855057, "answer_count": 1, "score": 2, "last_activity_date": 1573728708, "creation_date": 1573706771, "question_id": 58849546, "link": "https://stackoverflow.com/questions/58849546/how-to-extract-variable-in-actix-web-example-code", "title": "How to extract variable in actix_web example code?", "body": "<p>Here's actix_web example code from its homepage:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use actix_web::{web, App, Responder, HttpServer};\n\nfn index(info: web::Path&lt;(String, u32)&gt;) -&gt; impl Responder {\n    format!(\"Hello {}! id:{}\", info.0, info.1)\n}\n\nfn main() -&gt; std::io::Result&lt;()&gt; {\n    HttpServer::new(|| App::new().service(\n        web::resource(\"/{name}/{id}/index.html\").to(index))\n    )\n        .bind(\"127.0.0.1:8080\")?\n        .run()\n}\n</code></pre>\n\n<p>I tried to refactor code by extracting a variable for <code>web::resource...</code> line as:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use actix_web::{web, App, HttpServer, Responder};\n\nfn index(info: web::Path&lt;(u32, String)&gt;) -&gt; impl Responder {\n    format!(\"Hello {}! id:{}\", info.1, info.0)\n}\n\nfn main() -&gt; std::io::Result&lt;()&gt; {\n    let route = web::resource(\"/{id}/{name}/index.html\").to(index);\n    HttpServer::new(|| App::new().service(route))\n        .bind(\"127.0.0.1:8080\")?\n        .run()\n}\n</code></pre>\n\n<p>But it failed to compile. Why failed? And how to extract that variable here? Thanks.</p>\n"}, {"tags": ["asynchronous", "rust", "rust-tokio"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1573692239, "post_id": 58847457, "comment_id": 103968979, "body": "It looks like your question might be answered by the answers of <a href=\"https://stackoverflow.com/q/41932137/155423\">What is the best approach to encapsulate blocking I/O in future-rs?</a>. If not, please <b><a href=\"https://stackoverflow.com/posts/58847457/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 347, "user_id": 12167264, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/642adaee4e4afed5e9c20bb29327853f?s=128&d=identicon&r=PG&f=1", "display_name": "rusty", "link": "https://stackoverflow.com/users/12167264/rusty"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1573755866, "post_id": 58847457, "comment_id": 103997643, "body": "Thanks for the link,  gives a good background. That discussion focuses on blocking for a long running operation. My case is little different, but still about blocking: blocking on sync locks. The code is designed to hold these for minimal time(e.g) update a HashMap under lock."}, {"owner": {"reputation": 347, "user_id": 12167264, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/642adaee4e4afed5e9c20bb29327853f?s=128&d=identicon&r=PG&f=1", "display_name": "rusty", "link": "https://stackoverflow.com/users/12167264/rusty"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1573755998, "post_id": 58847457, "comment_id": 103997713, "body": "So IIUC, if we make sure the per-CPU executor threads don&#39;t block(or block for short/reasonable duration), we should be fine. Does this assertion sound right?"}], "owner": {"reputation": 347, "user_id": 12167264, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/642adaee4e4afed5e9c20bb29327853f?s=128&d=identicon&r=PG&f=1", "display_name": "rusty", "link": "https://stackoverflow.com/users/12167264/rusty"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 1041, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1573691571, "creation_date": 1573689855, "last_edit_date": 1573691571, "question_id": 58847457, "link": "https://stackoverflow.com/questions/58847457/using-stdsyncmutex-from-asynchronous-tokio-code", "title": "Using std::sync::Mutex from asynchronous Tokio code", "body": "<p>I am implementing a feature using the async/await based Tokio and Rust 1.39.0. I understand there can be performance implications with using the regular <code>Mutex</code> from within an async context, but are there any other possible effects? For example, I remember reading somewhere it can lock up the thread pool/runtime or hang the system.</p>\n\n<p>For context, the rest of our system is written in a synchronous way. I am looking at implementing the network facing part using the latest Tokio which would use <code>tokio::sync::Mutex</code> and friends. It is possible that the asynchronous network component calls into the synchronous parts which try to take the <code>sync::Mutex</code>.</p>\n\n<p>Some options: </p>\n\n<ol>\n<li>Separate these parts via message passing</li>\n<li>Change parts of the rest of the system to be async aware, which would be a big undertaking.</li>\n</ol>\n\n<p>I would like to avoid both if possible.</p>\n"}]