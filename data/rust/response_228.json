[{"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558572868, "post_id": 56265931, "comment_id": 99149487, "body": "My quick idea is that you cannot do this because ego-tree has (for some reason) tied the lifetime of the return value of <code>next_sibling</code> to the preceding node. Once that node goes out of scope (such as when you overwrite it in the loop), any references become invalid. In my XML crate, I avoid this by having nodes maintain references to the document value, not other nodes."}], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 0, "last_activity_date": 1558618801, "last_edit_date": 1558618801, "creation_date": 1558573785, "answer_id": 56266844, "question_id": 56265931, "link": "https://stackoverflow.com/questions/56265931/rust-ego-tree-crate-loops-with-mutable-borrows-inside-a-recursion/56266844#56266844", "title": "rust ego-tree crate: loops with mutable borrows inside a recursion", "body": "<p>You could do this by using the stack:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>/// Traverse the tree and insert a sibling after the node specified by `data`\nfn traverse(node: Option&lt;NodeMut&lt;String&gt;&gt;) {\n    match node {\n        None =&gt; {\n            println!(\"done traversing a level\");\n            return;\n        }\n        Some(mut n) =&gt; {\n            traverse(n.first_child());\n            n.append(\"x\".into());\n            traverse(n.next_sibling());\n        }\n    }\n}\n</code></pre>\n\n<p>With:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let mut tree = build_simple_tree();\n    println!(\"{:#?}\", tree);\n    traverse(Some(tree.root_mut()));\n    println!(\"{:#?}\", tree);\n}\n</code></pre>\n\n<p>This will output:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Tree { \"a\" =&gt; { \"b\", \"c\", \"d\" } }\ndone traversing a level\ndone traversing a level\ndone traversing a level\ndone traversing a level\ndone traversing a level\nTree { \"a\" =&gt; { \"b\" =&gt; { \"x\" }, \"c\" =&gt; { \"x\" }, \"d\" =&gt; { \"x\" }, \"x\" } }\n</code></pre>\n"}], "owner": {"reputation": 11, "user_id": 11541981, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fc62186f788036b8d44d79ea897cd212?s=128&d=identicon&r=PG&f=1", "display_name": "tikowasag", "link": "https://stackoverflow.com/users/11541981/tikowasag"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 100, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1558618801, "creation_date": 1558565305, "last_edit_date": 1558571733, "question_id": 56265931, "link": "https://stackoverflow.com/questions/56265931/rust-ego-tree-crate-loops-with-mutable-borrows-inside-a-recursion", "title": "rust ego-tree crate: loops with mutable borrows inside a recursion", "body": "<p>I am using version 0.6.0 of the ego-tree crate, and I am not sure how to traverse mutable nodes. The following is a contrived example, but it illustrates my intent. The <code>append(&amp;mut self)</code> operation may be seen as an easy placeholder for any other function which also takes a mutable reference.</p>\n\n<p>The basic problem is that I do not understand how to conceptually traverse the sibling nodes given the mutable reference that is consumed each time a new sibling is requested.</p>\n\n<p>I understand that the compiler is telling me that the mutable reference cannot be used after it is consumed (upon the >= 2nd iteration), but I do not know what pattern to use instead.</p>\n\n<p>The error I receive is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `sibling` does not live long enough\n  --&gt; src/main.rs:15:35\n   |\n12 |             while !sibling_mut.is_none() {\n   |                    ----------- borrow used here, in later iteration of loop\n...\n15 |                     sibling_mut = sibling.next_sibling();\n   |                                   ^^^^^^^ borrowed value does not live long enough\n16 |                 }\n   |                 - `sibling` dropped here while still borrowed\n</code></pre>\n\n<p>The code to reproduce the error:</p>\n\n<pre><code>use ego_tree::{tree, NodeMut, Tree};\n\n/// Traverse the tree and insert a sibling after the node specified by `data`\nfn traverse(node: &amp;mut Option&lt;NodeMut&lt;String&gt;&gt;) {\n    match node {\n        None =&gt; {\n            println!(\"done traversing a level\");\n            return;\n        }\n        Some(n) =&gt; {\n            let mut sibling_mut = n.next_sibling();\n            while !sibling_mut.is_none() {\n                if let Some(mut sibling) = sibling_mut {\n                    sibling.append(\"x\".into());\n                    sibling_mut = sibling.next_sibling();\n                }\n            }\n            traverse(&amp;mut None);\n        }\n    }\n}\n\nfn main() {\n    let mut tree = build_simple_tree();\n    traverse(&amp;mut Some(tree.root_mut()));\n}\n\nfn build_simple_tree() -&gt; Tree&lt;String&gt; {\n    tree! {\n        \"a\".into() =&gt; {\n            \"b\".into(),\n            \"c\".into(),\n            \"d\".into(),\n        }\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "rust-cargo"], "owner": {"reputation": 31, "user_id": 11472446, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/k7ckD.jpg?s=128&g=1", "display_name": "gfine", "link": "https://stackoverflow.com/users/11472446/gfine"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 129, "favorite_count": 1, "answer_count": 0, "score": 3, "last_activity_date": 1558567072, "creation_date": 1558559697, "last_edit_date": 1558567072, "question_id": 56265116, "link": "https://stackoverflow.com/questions/56265116/a-standalone-executable-for-armv7-fails-because-it-cannot-open-shared-object-fi", "title": "A standalone executable for ARMv7 fails because it &quot;cannot open shared object file&quot; for libstd", "body": "<p>I am attempting to build a standalone Rust based binary using:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>cargo --target=armv7-unknown-linux-gnueabihf --release\n</code></pre>\n\n<p>Anytime I build the binary for the target system and copy and execute that binary on the target it will panic: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>&lt;binary&gt;:error while loading shared libraries: \n libstd-42431e74081a30a8.so: \ncannot open shared object file: No such file or directory\n</code></pre>\n\n<p>This means it cannot find a dynamic library.</p>\n\n<p>If the dynamic libraries are copied to an external SSD and there is a path to them, the binary will not panic as it finds the libraries.  </p>\n\n<p>Originally the .cargo/config had </p>\n\n<pre><code>rustflags = [\"-C\",\"target-feature=prefer-dynamic]\n</code></pre>\n\n<p>I have also tried </p>\n\n<pre><code>rustflags = [\"-C\", \"target-feature=+crt-static\"]\n</code></pre>\n\n<p>But the binary still requires the external dynamic libs</p>\n\n<p>The .cargo/config file contents are:  </p>\n\n<pre><code>[target.armv7-unknown-linux-gnueabihf]\nar = \"arm-dey-linux-gnueabi-gcc-ar\"\nlinker = \"gcc-sysroot\"\n\n[build]\nrustflags = [\"-C\", \"target-feature=+crt-static\"]\n</code></pre>\n\n<p>I expect that the target's binary will execute without the dependencies on dynamic .so or .rlib system files as we have a space constraint system where the SSD may not be there.</p>\n"}, {"tags": ["datetime", "rust", "rust-cargo", "chrono"], "answers": [{"tags": [], "owner": {"reputation": 1862, "user_id": 4658000, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/0Sw3Y.jpg?s=128&g=1", "display_name": "Le\u015bny Rumcajs", "link": "https://stackoverflow.com/users/4658000/le%c5%9bny-rumcajs"}, "is_accepted": false, "score": 4, "last_activity_date": 1558566805, "last_edit_date": 1558566805, "creation_date": 1558558375, "answer_id": 56264863, "question_id": 56264503, "link": "https://stackoverflow.com/questions/56264503/how-can-i-round-a-chronodatetime-to-the-nearest-second/56264863#56264863", "title": "How can I round a chrono::Datetime to the nearest second?", "body": "<p>Use the <a href=\"https://docs.rs/chrono/0.4.6/chrono/trait.SubsecRound.html#tymethod.round_subsecs\" rel=\"nofollow noreferrer\"><code>round_subsecs</code> method</a> with <code>0</code> as an argument.</p>\n\n<pre><code>use chrono::prelude::*;\n\nfn main() {\n    let utc: DateTime&lt;Utc&gt; = Utc::now().round_subsecs(0);\n    println!(\"{}\", utc);\n}\n</code></pre>\n\n<p>The result is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>2019-05-22 20:50:46 UTC\n</code></pre>\n"}], "owner": {"reputation": 139, "user_id": 11326116, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/957e6efd129a4373cf07387ddc11c56a?s=128&d=identicon&r=PG", "display_name": "Samson G.", "link": "https://stackoverflow.com/users/11326116/samson-g"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 346, "favorite_count": 0, "answer_count": 1, "score": 5, "last_activity_date": 1558566877, "creation_date": 1558556752, "last_edit_date": 1558566877, "question_id": 56264503, "link": "https://stackoverflow.com/questions/56264503/how-can-i-round-a-chronodatetime-to-the-nearest-second", "title": "How can I round a chrono::Datetime to the nearest second?", "body": "<p>I want to get the current time rounded to the nearest second using the chrono crate but I don't know how to strip or round the result of\n<code>chrono::UTC.now()</code>.</p>\n\n<p>It doesn't seem like there are any operations to modify an existing <a href=\"https://docs.rs/chrono/0.4.6/chrono/struct.DateTime.html\" rel=\"nofollow noreferrer\">`DateTime</a>.</p>\n\n<pre><code>chrono::UTC.now()\n</code></pre>\n\n<p>Returns: <code>2019-05-22T20:07:59.250194427Z</code></p>\n\n<p>I want to get: <code>2019-05-22T20:07:59.000000000Z</code></p>\n\n<p>How would I go about doing that in the most efficient way without breaking up the <code>DateTime</code> value into its components and recreating it?</p>\n"}, {"tags": ["utf-8", "rust", "newline", "stdio", "carriage-return"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 2, "creation_date": 1558559607, "post_id": 56264376, "comment_id": 99146531, "body": "You can also use the <code>lines()</code> iterator, which will trim the newline characters for you."}], "answers": [{"tags": [], "owner": {"reputation": 1862, "user_id": 4658000, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/0Sw3Y.jpg?s=128&g=1", "display_name": "Le\u015bny Rumcajs", "link": "https://stackoverflow.com/users/4658000/le%c5%9bny-rumcajs"}, "is_accepted": true, "score": 4, "last_activity_date": 1558566705, "last_edit_date": 1558566705, "creation_date": 1558557741, "answer_id": 56264723, "question_id": 56264376, "link": "https://stackoverflow.com/questions/56264376/how-to-trim-off-newline-and-carriage-return-from-a-line-read-from-stdin-in-rust/56264723#56264723", "title": "How to trim off Newline and Carriage-return from a line read from stdin in Rust?", "body": "<p><code>String</code> has a <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.trim\" rel=\"nofollow noreferrer\"><code>trim</code> method</a> that returns a trimmed string slice:</p>\n\n<pre><code>use std::io;\nuse std::str;\n\nfn main() {\n    let mut input = String::new();\n    match io::stdin().read_line(&amp;mut input) {\n        Ok(_) =&gt; {\n            let trimmed_input = input.trim();\n            println!(\"{:?}\", trimmed_input.as_bytes());\n            println!(\"{}\", trimmed_input);\n        }\n        Err(e) =&gt; {\n            println!(\"{:?}\", e);\n        }\n    }\n}\n</code></pre>\n\n<p>Result for <code>\"test\"</code> input:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[116, 101, 115, 116]\ntest\n</code></pre>\n"}], "owner": {"reputation": 571, "user_id": 6780089, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/bcb6413d5c1778241f37cc86901c957a?s=128&d=identicon&r=PG&f=1", "display_name": "YLyu", "link": "https://stackoverflow.com/users/6780089/ylyu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1699, "favorite_count": 0, "closed_date": 1558566646, "accepted_answer_id": 56264723, "answer_count": 1, "score": 3, "last_activity_date": 1558566768, "creation_date": 1558556252, "question_id": 56264376, "link": "https://stackoverflow.com/questions/56264376/how-to-trim-off-newline-and-carriage-return-from-a-line-read-from-stdin-in-rust", "closed_reason": "Duplicate", "title": "How to trim off Newline and Carriage-return from a line read from stdin in Rust?", "body": "<p>I want to read a line from stdin and store it in a string variable and parse the string value into a u32 integer value.\nThe read_line() method reads 2 extra UTF-8 values which cause the parse method to panic.</p>\n\n<p>Below is what I have tried to trim off Carriage-return and Newline:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::io;\nuse std::str;\n\nfn main() {\n    let mut input = String::new();\n    match io::stdin().read_line(&amp;mut input) {\n        Ok(n) =&gt; {\n            println!(\"{:?}\", input.as_bytes());\n            println!(\"{}\", str::from_utf8(&amp;input.as_bytes()[0..n-2]).unwrap());\n        }\n        Err(e) =&gt; {\n            println!(\"{:?}\", e);\n        }\n    }\n}\n</code></pre>\n\n<p>What is the most idiomatic way to do this in Rust?</p>\n"}, {"tags": ["vector", "rust", "b-tree", "set-intersection"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558543750, "post_id": 56261476, "comment_id": 99139650, "body": "<a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558543857, "post_id": 56261476, "comment_id": 99139715, "body": "Your question might be answered by the answers of <a href=\"https://stackoverflow.com/q/35439376/155423\">Python set intersection is faster than Rust HashSet intersection</a> (specifically <a href=\"https://stackoverflow.com/a/53841407/155423\">this answer</a>)."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558550846, "post_id": 56261476, "comment_id": 99142728, "body": "For your problem beyond this question, you may want to look into using a bit set which I&#39;d expect to beat the performance of both."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558553398, "post_id": 56261476, "comment_id": 99143861, "body": "For the purposes of comparison, do the four lines starting with <code>let left_side</code> do anything? Couldn&#39;t you <i>just</i> calculate the intersection?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558553548, "post_id": 56261476, "comment_id": 99143933, "body": "How does the benchmark software ignore the difference in time for constructing the <code>Vec</code> and the <code>BTreeSet</code>?"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 3, "creation_date": 1558554609, "post_id": 56261476, "comment_id": 99144377, "body": "I think your sets are indeed too small to gain anything from a <code>BTreeSet</code>. The &quot;B&quot; in the Rust implementation is 6, so up to 11 numbers are stored in a single node. Each node is scanned linearly, so there is hardly a chance to gain anything over a vector. Regardless of the set size, a parallel scan on sorted vectors will always beat the <code>BTreeSet</code>, since it is <code>O(m + n)</code>, where <code>m</code> and <code>n</code> are the sizes of the two vectors."}, {"owner": {"reputation": 55, "user_id": 8141373, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/94463019c89310ecb3360aec91058d00?s=128&d=identicon&r=PG&f=1", "display_name": "HelloImRandom", "link": "https://stackoverflow.com/users/8141373/helloimrandom"}, "edited": false, "score": 0, "creation_date": 1558555315, "post_id": 56261476, "comment_id": 99144686, "body": "Unfortunately it does not ignore this difference, but I have tried constructing them in different ways (eg <code>Vec:with_capacity()</code>) and the time difference was negligible. And yes, I could just calculate the intersection. I left that code in in case someone was able to come up with a way to improve the performance of this bit as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1558555384, "post_id": 56261476, "comment_id": 99144727, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=790608fec0f57dadbfa92bf90160a88a\" rel=\"nofollow noreferrer\">Benchmarking the core algorithm via Criterion.rs</a> yields <code>vec time: [61.092 ms 61.882 ms 62.686 ms]</code> and <code>set time: [91.517 ms 92.385 ms 93.441 ms]</code>, so apparently the creation overhead isn&#39;t solely to blame."}], "answers": [{"comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1558595484, "post_id": 56265037, "comment_id": 99154559, "body": "I note that another change which was made here is using <code>u32</code> instead of <code>usize</code> =&gt; Memory matters! If it fits in a u32, no point in wasting half the space using a <code>usize</code>!"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1558595629, "post_id": 56265037, "comment_id": 99154622, "body": "@MatthieuM. Yeah, the OP mentioned that the maximum is 840000, so I sliently made that change. I expected it to have some performance impact as well due to memory bandwidth, but on my machine the difference was just 1%, so I didn&#39;t explicitly mention it in the answer."}, {"owner": {"reputation": 55, "user_id": 8141373, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/94463019c89310ecb3360aec91058d00?s=128&d=identicon&r=PG&f=1", "display_name": "HelloImRandom", "link": "https://stackoverflow.com/users/8141373/helloimrandom"}, "edited": false, "score": 0, "creation_date": 1558915445, "post_id": 56265037, "comment_id": 99245322, "body": "I have tried both BitSet and this method and while BitSet yielded even greater performance benefits, memory overhead was too large in some cases. This method achieves similar performance while using negligible amounts of memory."}, {"owner": {"reputation": 12296, "user_id": 461597, "user_type": "registered", "accept_rate": 97, "profile_image": "https://www.gravatar.com/avatar/7fa573d21875f5b980a2d81c695c71f3?s=128&d=identicon&r=PG", "display_name": "Unapiedra", "link": "https://stackoverflow.com/users/461597/unapiedra"}, "edited": false, "score": 0, "creation_date": 1607218520, "post_id": 56265037, "comment_id": 115203463, "body": "&quot;This probably isn&#39;t particularly well optimised;&quot; yes, maybe emphasize that this is not the linear time complexity that is possible. While I may be mistaken, it looks to me that the <code>for current_a in a</code> loop is not advancing both iterators at the same time."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "reply_to_user": {"reputation": 12296, "user_id": 461597, "user_type": "registered", "accept_rate": 97, "profile_image": "https://www.gravatar.com/avatar/7fa573d21875f5b980a2d81c695c71f3?s=128&d=identicon&r=PG", "display_name": "Unapiedra", "link": "https://stackoverflow.com/users/461597/unapiedra"}, "edited": false, "score": 0, "creation_date": 1607347203, "post_id": 56265037, "comment_id": 115235190, "body": "@Unapiedra I&#39;m pretty confident the algorithm has linear runtime. The loop does advance both iterators in parallel, since that&#39;s the whole idea of computing the intersection of two sorted vectors. The &quot;not well optimised&quot; comment is about micro-optimizations \u2013 I don&#39;t think it&#39;s possible to improve the algorithmic complexity."}, {"owner": {"reputation": 12296, "user_id": 461597, "user_type": "registered", "accept_rate": 97, "profile_image": "https://www.gravatar.com/avatar/7fa573d21875f5b980a2d81c695c71f3?s=128&d=identicon&r=PG", "display_name": "Unapiedra", "link": "https://stackoverflow.com/users/461597/unapiedra"}, "edited": false, "score": 0, "creation_date": 1607381802, "post_id": 56265037, "comment_id": 115250479, "body": "@SvenMarnach you are right. The indention of the <code>for current_a in a</code> line threw me off. I thought that was repeated but it is only run once. So you are right, this is linear."}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 4, "last_activity_date": 1558619235, "last_edit_date": 1558619235, "creation_date": 1558559247, "answer_id": 56265037, "question_id": 56261476, "link": "https://stackoverflow.com/questions/56261476/why-is-finding-the-intersection-of-integer-sets-faster-with-a-vec-compared-to-bt/56265037#56265037", "title": "Why is finding the intersection of integer sets faster with a Vec compared to BTreeSet?", "body": "<p>Since your sets don't change over time, I think your best option is to use sorted vectors. Sorting the vectors will be required only once, at initialization time. The intersection of two sorted vectors can be computed in linear time by iterating over them simultaneously, always advancing the iterator that currently points to the lower number. Here is an attempt at an implementation:</p>\n\n<pre><code>fn intersection_count_sorted_vec(a: &amp;[u32], b: &amp;[u32]) -&gt; usize {\n    let mut count = 0;\n    let mut b_iter = b.iter();\n    if let Some(mut current_b) = b_iter.next() {\n        for current_a in a {\n            while current_b &lt; current_a {\n                current_b = match b_iter.next() {\n                    Some(current_b) =&gt; current_b,\n                    None =&gt; return count,\n                };\n            }\n            if current_a == current_b {\n                count += 1;\n            }\n        }\n    }\n    count\n}\n</code></pre>\n\n<p>This probably isn't particularly well optimised; regardless, <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=790608fec0f57dadbfa92bf90160a88a\" rel=\"nofollow noreferrer\">benchmarking with Criterion-based code</a> indicates this version is more than three times as fast as your solution using vectors.</p>\n"}], "owner": {"reputation": 55, "user_id": 8141373, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/94463019c89310ecb3360aec91058d00?s=128&d=identicon&r=PG&f=1", "display_name": "HelloImRandom", "link": "https://stackoverflow.com/users/8141373/helloimrandom"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1736, "favorite_count": 0, "accepted_answer_id": 56265037, "answer_count": 1, "score": 5, "last_activity_date": 1558619235, "creation_date": 1558543165, "last_edit_date": 1558553157, "question_id": 56261476, "link": "https://stackoverflow.com/questions/56261476/why-is-finding-the-intersection-of-integer-sets-faster-with-a-vec-compared-to-bt", "title": "Why is finding the intersection of integer sets faster with a Vec compared to BTreeSet?", "body": "<p>I need to find out how many integers are present in both of two given sets, fast. The sets are written to only once but this operation will be performed many times with different pairs of sets. The sets contain 5-30 integers and the largest of these integers is 840000.</p>\n\n<p>I have initially tried to iterate over one <code>Vec</code> and for each element check if its present in the other <code>Vec</code>. I then decided to use <code>BTreeSet</code> instead since it should be significantly faster at checking if an integer is present in the set, but that does not seem to be the case. The <code>Vec</code> implementation takes ~72ms and the BTreeSet ~96ms when called on couple thousands of sets in release mode under stable Rust 1.34 with same performance when using nightly.</p>\n\n<p>This is the <code>Vec</code> implementation:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::cmp;\n\nfn main() {\n    let mut sets = Vec::with_capacity(1000);\n    for i in 1..1000 {\n        let mut set = Vec::new();\n        for j in 1..i % 30 {\n            set.push(i * j % 50000);\n        }\n        sets.push(set);\n    }\n    for left_set in sets.iter() {\n        for right_set in sets.iter() {\n            calculate_waste(left_set, right_set);\n        }\n    }\n}\n\nfn calculate_waste(left_nums: &amp;Vec&lt;usize&gt;, right_nums: &amp;Vec&lt;usize&gt;) -&gt; usize {\n    let common_nums = left_nums.iter().fold(0, |intersection_count, num| {\n        intersection_count + right_nums.contains(num) as usize\n    });\n    let left_side = left_nums.len() - common_nums;\n    let right_side = right_nums.len() - common_nums;\n    let score = cmp::min(common_nums, cmp::min(left_side, right_side));\n    left_side - score + right_side - score + common_nums - score\n}\n</code></pre>\n\n<p>And this is the <code>BTreeSet</code> implementation:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::cmp;\nuse std::collections::BTreeSet;\n\nfn main() {\n    let mut sets = Vec::with_capacity(1000);\n    for i in 1..1000 {\n        let mut set = BTreeSet::new();\n        for j in 1..i % 30 {\n            set.insert(i * j % 50000);\n        }\n        sets.push(set);\n    }\n    for left_set in sets.iter() {\n        for right_set in sets.iter() {\n            calculate_waste(left_set, right_set);\n        }\n    }\n}\n\nfn calculate_waste(left_nums: &amp;BTreeSet&lt;usize&gt;, right_nums: &amp;BTreeSet&lt;usize&gt;) -&gt; usize {\n    let common_nums = left_nums.intersection(&amp;right_nums).count();\n    let left_side = left_nums.len() - common_nums;\n    let right_side = right_nums.len() - common_nums;\n    let score = cmp::min(common_nums, cmp::min(left_side, right_side));\n    left_side - score + right_side - score + common_nums - score\n}\n</code></pre>\n\n<p>It was ran with the command (<code>-w 50</code> makes it ignore the first 50 runs):</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>hyperfine \"cargo run --release\" -w 50 -m 100\n</code></pre>\n\n<p>Full code of the program available <a href=\"https://github.com/HeIIoImRandom/hash_code_2019\" rel=\"nofollow noreferrer\">here</a>.</p>\n\n<p>Is the <code>BTreeSet</code> implementation slower because there are too few integers in the set to allow its O(log n) access time to shine? If so, is there anything else I can do to speed up this function?</p>\n"}, {"tags": ["regex", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558540324, "post_id": 56260605, "comment_id": 99137926, "body": "<a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.skip\" rel=\"nofollow noreferrer\"><code>Iterator::skip</code></a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1558540502, "post_id": 56260605, "comment_id": 99138011, "body": "Please make a <i>self-contained</i> <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. There&#39;s no reason to have config files or read from standard input to demonstrate your problem. Iterate over an array of strings and hard-code the configuration. These are essential steps to <b>minimize</b> your problem to the core issue."}, {"owner": {"reputation": 10100, "user_id": 619216, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/c07104de771c3b6f6c30be8f592ef8f7?s=128&d=identicon&r=PG", "display_name": "BurntSushi5", "link": "https://stackoverflow.com/users/619216/burntsushi5"}, "edited": false, "score": 0, "creation_date": 1558540825, "post_id": 56260605, "comment_id": 99138203, "body": "&quot;That strikes me as beyond clunky&quot; -- Consider how clunky it would be if you didn&#39;t have <code>RegexSet</code> at all."}], "owner": {"reputation": 1962, "user_id": 982364, "user_type": "registered", "accept_rate": 41, "profile_image": "https://www.gravatar.com/avatar/8f7fcd81979b29f5fd4ddf155987e588?s=128&d=identicon&r=PG", "display_name": "Tom", "link": "https://stackoverflow.com/users/982364/tom"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 181, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1558540304, "creation_date": 1558539947, "last_edit_date": 1558540304, "question_id": 56260605, "link": "https://stackoverflow.com/questions/56260605/how-do-i-perform-replacement-with-a-regexset", "title": "How do I perform replacement with a RegexSet?", "body": "<p>Given a config file that specifies several (possibly dozens) of regular expressions, such as:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>(\"2018\")\nauthors[ ]*=[ ]*(.*)\n</code></pre>\n\n<p>I want to iterate over an input stream (line-by-line) and replace all the <strong>captures</strong> (in this example, all instances of \"2018\" and author names). The replacement depends on the capture, so the year would be replaced with \"(year)\" and the author name with \"(author)\".</p>\n\n<h2>What I tried</h2>\n\n<pre><code>extern crate regex; // 1.1.5\n\nuse regex::Regex;\nuse regex::RegexSet;\nuse std::process;\nuse std::{\n    fs::File,\n    io,\n    io::{prelude::*, BufReader},\n    path::PathBuf,\n};\n\nfn main() {\n    let contents = read_to_array(\"config.conf\");\n    println!(\"{:?}\", contents);\n\n    let set = RegexSet::new(&amp;contents).unwrap(); // FIXME: this panics if there is an invalid regex\n    println!(\"{:?}\", set);\n\n    let mut regexs: Vec&lt;Regex&gt; = Vec::new();\n    for line in contents {\n        let re = Regex::new(&amp;line).unwrap(); // should not panic because we parsed Regexes above already\n        regexs.push(re);\n    }\n\n    read(set, regexs);\n}\n\nfn read_to_array(filename: &amp;str) -&gt; Vec&lt;String&gt; {\n    let file = File::open(filename).expect(\"no such file\");\n    let buf = BufReader::new(file);\n    buf.lines()\n        .map(|l| l.expect(\"Could not parse line\"))\n        .collect()\n}\n\nfn read(set: RegexSet, regexs: Vec&lt;Regex&gt;) {\n    let stdin = io::stdin();\n    for line in stdin.lock().lines() {\n        let l = line.unwrap();\n        let mut r = l.to_string();\n        println!(\"line: {}\", l);\n        for idx in set.matches(&amp;l).into_iter() {\n            println!(\n                \"matches: {:?} - {:?} = {:?}\",\n                idx,\n                set.patterns()[idx],\n                regexs[idx]\n            );\n            for caps in regexs[idx].captures_iter(&amp;l) {\n                println!(\"captures: {:?}\", caps);\n                for c in caps.iter() {\n                    println!(\"cap: {:?}\", c);\n                }\n                r = regexs[idx].replace_all(&amp;r, \"xxx\").to_string();\n                println!(\"result: {:?}\", r);\n            }\n        }\n        println!(\"new line: {}\", r);\n    }\n}\n</code></pre>\n\n<p><a href=\"https://play.integer32.com/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=50b9578e627a365b6cb40dae9b535428\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>This needs <code>regex = \"1\"</code> in Cargo.toml, expects a config file named <code>config.conf</code> in the current directory and the data to be manipulated piped in via stdin - Cargo.toml works well for testing purposes.</p>\n\n<h2>What doesn't work</h2>\n\n<p><code>RegexSet</code> doesn't give me captures, so I use it to efficiently figure out if I have a match at all and then match <strong>again</strong> for the replacement. That strikes me as beyond clunky but is the only way I could get it to work at all.</p>\n\n<p>Second, the replace always replaces the entire match, not just the captured part. That is something I don't understand and it doesn't fit to the documentation of the regex crate. </p>\n\n<p>Third, iterating over the captures - and this could be the reason for #2 - always gives me the entire match at index 0, which I would like to skip. Is there something like \"iterate over this, but skip the first element\" in Rust?</p>\n"}, {"tags": ["unit-testing", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558537425, "post_id": 56259636, "comment_id": 99136244, "body": "You need to have <code>mod functions;</code> in lib.rs (or main.rs, it&#39;s unclear from your code) in order to tell the compiler that the file needs to be read."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558537513, "post_id": 56259636, "comment_id": 99136304, "body": "You may wish to read the <a href=\"https://doc.rust-lang.org/book/ch07-02-modules-and-use-to-control-scope-and-privacy.html#separating-modules-into-different-files\" rel=\"nofollow noreferrer\">Separating Modules into Different Files</a> part of <a href=\"https://doc.rust-lang.org/book/\" rel=\"nofollow noreferrer\"><i>The Rust Programming Language</i></a>."}, {"owner": {"reputation": 3792, "user_id": 1493608, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/456a5b948592dbd489efea7a433b3068?s=128&d=identicon&r=PG", "display_name": "air-dex", "link": "https://stackoverflow.com/users/1493608/air-dex"}, "edited": false, "score": 0, "creation_date": 1558753194, "post_id": 56259636, "comment_id": 99214454, "body": "Add an empty main in function.rs (<code>fn main() {}</code>). Then tell your Cargo manifest (here the <code>Cargo.toml</code> file) that there is a new executable crate (<code>[[bin]]</code>) whose <code>path</code> is <code>src&#47;functions.rs</code>. <code>cargo test</code> will create an executable for excuting <code>src&#47;functions.rs</code>&#39;s tests."}], "owner": {"reputation": 93, "user_id": 7671504, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-PQz7fec8k7g/AAAAAAAAAAI/AAAAAAAABHI/KUq574Q2yIU/photo.jpg?sz=128", "display_name": "san1127", "link": "https://stackoverflow.com/users/7671504/san1127"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 36, "favorite_count": 1, "closed_date": 1558537390, "answer_count": 0, "score": 0, "last_activity_date": 1558537341, "creation_date": 1558536824, "last_edit_date": 1558537341, "question_id": 56259636, "link": "https://stackoverflow.com/questions/56259636/how-can-i-run-tests-that-are-not-in-lib-rs-or-main-rs", "closed_reason": "Duplicate", "title": "How can I run tests that are not in lib.rs or main.rs?", "body": "<p>I am learning to write unit tests in rust. However, I can't get my test running when they are not in <code>src/lib.rs</code> or <code>src/main.rs</code>.</p>\n\n<p>I created a project with the following structure:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>\u251c\u2500\u2500 Cargo.lock\n\u251c\u2500\u2500 Cargo.toml\n\u251c\u2500\u2500 src\n    \u251c\u2500\u2500 lib.rs\n    \u2514\u2500\u2500 main.rs\n    \u2514\u2500\u2500 functions.rs\n</code></pre>\n\n<p>and added the following code:</p>\n\n<p><strong>main.rs</strong></p>\n\n<pre><code>#[cfg(test)]\nmod test {\n    #[test]\n    fn test_main() {}\n}\n</code></pre>\n\n<p><strong>lib.rs</strong></p>\n\n<pre><code>#[cfg(test)]\nmod test {\n    #[test]\n    fn test_lib() {}\n}\n</code></pre>\n\n<p><strong>functions.rs</strong></p>\n\n<pre><code>#[cfg(test)]\nmod test {\n    #[test]\n    fn test_functions() { }\n}\n</code></pre>\n\n<p>When I run <code>cargo test</code>, this is what I got:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Finished dev [unoptimized + debuginfo] target(s) in 0.01s\n     Running target\\debug\\deps\\rust_unittests-b0ed92af162e0288.exe\n\nrunning 1 test\ntest test::test_lib ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n\n     Running target\\debug\\deps\\rust_unittests-c4edac234e8e3d9a.exe\n\nrunning 1 test\ntest test::test_main ... ok\n\ntest result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n\n   Doc-tests rust_unittests\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n</code></pre>\n\n<p>The test function in main.rs and lib.rs were run as expected but the one in functions.rs wasn't.</p>\n\n<p>I read the Rust book and several articles I Googled but none have mentioned this problem. What am I missing? </p>\n"}, {"tags": ["types", "enums", "rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558533870, "post_id": 56258667, "comment_id": 99133972, "body": "Please use <code>rustfmt</code> to format your snippets. This is much better to read and one instantly knows what you want the enums are."}, {"owner": {"reputation": 754, "user_id": 658176, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/90ff6fa97674f4fc3462f2a5fb9f7d20?s=128&d=identicon&r=PG", "display_name": "usul", "link": "https://stackoverflow.com/users/658176/usul"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1558534028, "post_id": 56258667, "comment_id": 99134085, "body": "@hellow, sounds good, thanks!"}], "answers": [{"comments": [{"owner": {"reputation": 754, "user_id": 658176, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/90ff6fa97674f4fc3462f2a5fb9f7d20?s=128&d=identicon&r=PG", "display_name": "usul", "link": "https://stackoverflow.com/users/658176/usul"}, "edited": false, "score": 0, "creation_date": 1558536169, "post_id": 56259010, "comment_id": 99135440, "body": "Thanks, this is helpful! To explain my dependent types comment, ApprovedRequest could be a dependent sum type, i.e. a pair (x: Request, y: ??) where the type of y depends on the runtime value of x, for example, if x is Request::A then y: i64, but if x is Request::B, then y: f64."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 754, "user_id": 658176, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/90ff6fa97674f4fc3462f2a5fb9f7d20?s=128&d=identicon&r=PG", "display_name": "usul", "link": "https://stackoverflow.com/users/658176/usul"}, "edited": false, "score": 0, "creation_date": 1558539152, "post_id": 56259010, "comment_id": 99137292, "body": "In a language supporting dependent types, possibly. Rust does not support them for now, and there is no known plan to add them for now."}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 2, "last_activity_date": 1558534815, "creation_date": 1558534815, "answer_id": 56259010, "question_id": 56258667, "link": "https://stackoverflow.com/questions/56258667/how-to-model-dependent-and-nested-sum-types/56259010#56259010", "title": "How to model dependent and nested sum types?", "body": "<p>In this case, my go-to solution is creating independent types and wrapping them in the enum:</p>\n\n<pre><code>struct A(i64);\nstruct B(f64);\nstruct C(String);\n\nenum Request {\n    A(A),\n    B(B),\n    C(C),\n}\n</code></pre>\n\n<p>There is a bit of repetition involved, but it's otherwise fairly simple. The names need not match, either.</p>\n\n<hr>\n\n<p>With this in place, expressing <code>ApprovedRequest</code> and <code>DeniedRequest</code> is immediately possible.</p>\n\n<p><em>Another</em> possibility, though, is to use traits and generics:</p>\n\n<pre><code>trait Approved {\n    type Payload;\n}\n\nstruct ApprovedT&lt;T: Approved&gt; {\n    request: T,\n    approval: T::Payload,\n}\n\nenum ApprovedRequest {\n    A(ApprovedT&lt;A&gt;),\n    B(ApprovedT&lt;B&gt;),\n    C(ApprovedT&lt;C&gt;),\n}\n</code></pre>\n\n<p>And then, per request, explain the payload:</p>\n\n<pre><code>impl Approved for A {\n    type Payload = i64;\n}\n\nimpl Denied for A {\n    type Payload = String;\n}\n</code></pre>\n\n<p>The main benefit of this approach is that any method that needs to manipulate an approved request and its approval payload can be made generic on <code>ApprovedT</code>, as otherwise, what would be the type of the payload?</p>\n\n<hr>\n\n<blockquote>\n  <p>I think the way I've presented the problem would be a use case for dependent types.</p>\n</blockquote>\n\n<p>Careful; <em>Dependent Typing</em> is a concept of Computer Science generally understood to linking run-time values to types.</p>\n\n<p>For example, the following would require dependent types as a run-time value ends up being used in a type definition:</p>\n\n<pre><code>//  Not valid Rust.\nfn create_array(n: usize) -&gt; [u8; n];\n</code></pre>\n"}], "owner": {"reputation": 754, "user_id": 658176, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/90ff6fa97674f4fc3462f2a5fb9f7d20?s=128&d=identicon&r=PG", "display_name": "usul", "link": "https://stackoverflow.com/users/658176/usul"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 224, "favorite_count": 0, "accepted_answer_id": 56259010, "answer_count": 1, "score": 2, "last_activity_date": 1558534815, "creation_date": 1558533718, "last_edit_date": 1558533827, "question_id": 56258667, "link": "https://stackoverflow.com/questions/56258667/how-to-model-dependent-and-nested-sum-types", "title": "How to model dependent and nested sum types?", "body": "<p>I'm wondering how one would organize the following kind of data, especially in Rust, but answers in any programming language are interesting.</p>\n\n<p>My system processes requests of several types each with different data associated, e.g.</p>\n\n<pre><code>enum Request {\n    A(i64),\n    B(f64),\n    C(String),\n}\n</code></pre>\n\n<p>If a processed request is approved, we need to store the request along with data about the approval process, but the kind of data depends on the type. So I want to say</p>\n\n<pre><code>enum ApprovedRequest {\n    ApprovedA(Request::A, i64),\n    ApprovedB(Request::B, f64),\n    ApprovedC(Request::C, String),\n}\n</code></pre>\n\n<p>On the other hand, it might get denied and then different information would be appended, so I want to say</p>\n\n<pre><code>enum DeniedRequest {\n    DeniedA(Request::A, String),\n    DeniedB(Request::B, String),\n    DeniedC(Request::C, i64),\n}\n</code></pre>\n\n<p>This isn't valid Rust, because Request::A is not a type. <a href=\"https://github.com/rust-lang/rfcs/issues/754\" rel=\"nofollow noreferrer\">See issue 754.</a> I think the way I've presented the problem would be a use case for dependent types. But anyway, any suggestion for how to organize this, in Rust or another language with pattern matching?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558536498, "post_id": 56253623, "comment_id": 99135632, "body": "Do <i>not</i> use <code>thread::sleep</code> in a future: <a href=\"https://stackoverflow.com/q/48735952/155423\">Why does Future::select choose the future with a longer sleep period first?</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558537144, "post_id": 56253623, "comment_id": 99136041, "body": "If you are running every second and a function takes 10 seconds, should there be a break of 1 second before the function runs again, or will it run again immediately?"}, {"owner": {"reputation": 20521, "user_id": 1135424, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/rvwBS.jpg?s=128&g=1", "display_name": "nbari", "link": "https://stackoverflow.com/users/1135424/nbari"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558539700, "post_id": 56253623, "comment_id": 99137574, "body": "@Shepmaster thanks for all your comments but due to my lack of understanding and experience with RUST that&#39;s why I came with what you describe as an inconsistent question if it helps at the end I just would like to know what is the RUST way of doing something like in the working example <a href=\"https://play.golang.org/p/ZLw6ESioqfu\" rel=\"nofollow noreferrer\">play.golang.org/p/ZLw6ESioqfu</a>, my point of asking about how to do it only with std lib only is because of the simplicity of this with other programming languages and could be considered probably a &quot;best practice&quot; but totally fine to use a crate,I&#39;m just trying to learn how to do things right :-)"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558541135, "post_id": 56253623, "comment_id": 99138368, "body": "<i>what is the RUST way</i> \u2014 why do you believe that there is <b>one</b> right way? You can probably do it with threads and you can probably do it with futures (and probably other ways). Neither of these is &quot;the right way&quot;; that&#39;s why this question feels overly broad. If you can narrow it to something like &quot;how can I do &lt;this task&gt; using &lt;this aspect of Rust&gt;&quot; then it seems more on-topic for Stack Overflow. (And it&#39;s just &quot;Rust&quot;, not all caps, not all lowercase)."}, {"owner": {"reputation": 20521, "user_id": 1135424, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/rvwBS.jpg?s=128&g=1", "display_name": "nbari", "link": "https://stackoverflow.com/users/1135424/nbari"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558543947, "post_id": 56253623, "comment_id": 99139765, "body": "@Shepmaster got it, thanks for the heads up, I would appreciate a constructive answer that could help me to achieve what described in the question, example."}], "answers": [{"comments": [{"owner": {"reputation": 20521, "user_id": 1135424, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/rvwBS.jpg?s=128&g=1", "display_name": "nbari", "link": "https://stackoverflow.com/users/1135424/nbari"}, "edited": false, "score": 0, "creation_date": 1558605544, "post_id": 56262173, "comment_id": 99160057, "body": "pretty much appreciated, I will post another question regarding the usage of Tokio following your advice"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1558547184, "last_edit_date": 1558547184, "creation_date": 1558546503, "answer_id": 56262173, "question_id": 56253623, "link": "https://stackoverflow.com/questions/56253623/how-can-i-run-a-set-of-functions-on-a-recurring-interval-without-running-the-sam/56262173#56262173", "title": "How can I run a set of functions on a recurring interval without running the same function at the same time using only the standard Rust library?", "body": "<p>Since you want concurrency and will only use the standard library, then you basically must use threads.</p>\n\n<p>Here, we start a thread for every function for every iteration of the scheduler loop, allowing them to run in parallel. We then wait for all functions to finish, preventing ever running the same function twice concurrently.</p>\n\n<pre><code>use std::{\n    thread,\n    time::{Duration, Instant},\n};\n\nfn main() {\n    let scheduler = thread::spawn(|| {\n        let wait_time = Duration::from_millis(500);\n\n        // Make this an infinite loop\n        // Or some control path to exit the loop\n        for _ in 0..5 {\n            let start = Instant::now();\n            eprintln!(\"Scheduler starting at {:?}\", start);\n\n            let thread_a = thread::spawn(a);\n            let thread_b = thread::spawn(b);\n\n            thread_a.join().expect(\"Thread A panicked\");\n            thread_b.join().expect(\"Thread B panicked\");\n\n            let runtime = start.elapsed();\n\n            if let Some(remaining) = wait_time.checked_sub(runtime) {\n                eprintln!(\n                    \"schedule slice has time left over; sleeping for {:?}\",\n                    remaining\n                );\n                thread::sleep(remaining);\n            }\n        }\n    });\n\n    scheduler.join().expect(\"Scheduler panicked\");\n}\n\nfn a() {\n    eprintln!(\"a\");\n    thread::sleep(Duration::from_millis(100))\n}\nfn b() {\n    eprintln!(\"b\");\n    thread::sleep(Duration::from_millis(200))\n}\n</code></pre>\n\n<p>You could also make use of a <a href=\"https://doc.rust-lang.org/std/sync/struct.Barrier.html\" rel=\"nofollow noreferrer\"><code>Barrier</code></a> to start each function in a thread once and then synchronize all of them at the end of execution:</p>\n\n<pre><code>use std::{\n    sync::{Arc, Barrier},\n    thread,\n    time::Duration,\n};\n\nfn main() {\n    let scheduler = thread::spawn(|| {\n        let barrier = Arc::new(Barrier::new(2));\n\n        fn with_barrier(barrier: Arc&lt;Barrier&gt;, f: impl Fn()) -&gt; impl Fn() {\n            move || {\n                // Make this an infinite loop\n                // Or some control path to exit the loop\n                for _ in 0..5 {\n                    f();\n                    barrier.wait();\n                }\n            }\n        }\n\n        let thread_a = thread::spawn(with_barrier(barrier.clone(), a));\n        let thread_b = thread::spawn(with_barrier(barrier.clone(), b));\n\n        thread_a.join().expect(\"Thread A panicked\");\n        thread_b.join().expect(\"Thread B panicked\");\n    });\n\n    scheduler.join().expect(\"Scheduler panicked\");\n}\n\nfn a() {\n    eprintln!(\"a\");\n    thread::sleep(Duration::from_millis(100))\n}\nfn b() {\n    eprintln!(\"b\");\n    thread::sleep(Duration::from_millis(200))\n}\n</code></pre>\n\n<p>I wouldn't use <em>either</em> of these solutions, personally. I'd <a href=\"https://crates.io/\" rel=\"nofollow noreferrer\">find a crate</a> where someone else has written and tested the code I need. </p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/37009480/155423\">Does Rust have an equivalent of Python&#39;s threading.Timer?</a></li>\n<li><a href=\"https://stackoverflow.com/q/28364995/155423\">Is there a way to schedule a task at a specific time or with an interval?</a></li>\n<li><a href=\"https://stackoverflow.com/q/37434695/155423\">How do I emulate a timer inside an object that will periodically mutate the object?</a></li>\n</ul>\n"}], "owner": {"reputation": 20521, "user_id": 1135424, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/rvwBS.jpg?s=128&g=1", "display_name": "nbari", "link": "https://stackoverflow.com/users/1135424/nbari"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3163, "favorite_count": 0, "accepted_answer_id": 56262173, "answer_count": 1, "score": 3, "last_activity_date": 1558547184, "creation_date": 1558517492, "last_edit_date": 1558541264, "question_id": 56253623, "link": "https://stackoverflow.com/questions/56253623/how-can-i-run-a-set-of-functions-on-a-recurring-interval-without-running-the-sam", "title": "How can I run a set of functions on a recurring interval without running the same function at the same time using only the standard Rust library?", "body": "<p>I would like to use Rust to create a simple scheduler in order to run multiple concurrent functions at a defined time but do not start more if they haven't finished.</p>\n\n<p>For example, if the defined interval is one second, the scheduler should run the functions and don't start more if the previous functions have not returned. The goal is to prevent running the same function multiple times.</p>\n\n<p>I created <a href=\"https://play.golang.org/p/ZLw6ESioqfu\" rel=\"nofollow noreferrer\">a working example</a> with Go like this:</p>\n\n<pre class=\"lang-golang prettyprint-override\"><code>package main\n\nimport (\n    \"fmt\"\n    \"sync\"\n    \"time\"\n)\n\nfunc myFunc(wg *sync.WaitGroup) {\n    fmt.Printf(\"now: %+s\\n\", time.Now())\n    time.Sleep(3 * time.Second)\n    wg.Done()\n}\n\nfunc main() {\n    quit := make(chan bool)\n\n    t := time.NewTicker(time.Second)\n    go func() {\n        for {\n            select {\n            case &lt;-t.C:\n                var wg sync.WaitGroup\n                for i := 0; i &lt;= 4; i++ {\n                    wg.Add(1)\n                    go myFunc(&amp;wg)\n                }\n                wg.Wait()\n                fmt.Printf(\"--- done ---\\n\\n\")\n            case &lt;-quit:\n                return\n            }\n        }\n    }()\n\n    &lt;-time.After(time.Minute)\n    close(quit)\n}\n</code></pre>\n\n<p>Since I didn't find something like Go's <code>NewTicker</code> within the Rust standard library, I used <a href=\"https://tokio.rs/\" rel=\"nofollow noreferrer\">Tokio</a> and <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4d93bbffb8f61b2bd9366cb6dae3209d\" rel=\"nofollow noreferrer\">came up with this</a></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate futures;\nextern crate tokio;\n\nuse futures::future::lazy;\nuse std::{thread, time};\nuse tokio::prelude::*;\nuse tokio::timer::Interval;\n\nfn main() {\n    let task = Interval::new(time::Instant::now(), time::Duration::new(1, 0))\n        .for_each(|interval| {\n            println!(\"Interval: {:?}\", interval);\n            for i in 0..5 {\n                tokio::spawn(lazy(move || {\n                    println!(\"I am i: {}\", i);\n                    thread::sleep(time::Duration::from_secs(3));\n                    Ok(())\n                }));\n            }\n            Ok(())\n        })\n        .map_err(|e| panic!(\"interval errored; err={:?}\", e));\n\n    tokio::run(task);\n}\n</code></pre>\n\n<p>The problem I have with this approach is that the tasks don't wait for the previous functions to be called therefore the functions start again no matter if previously they were running, I am missing here something like Go's <code>sync.WaitGroup</code>. What could be used to achieve the same results as in the working example?</p>\n\n<p>Is it possible to achieve this by only using the standard library? This is mainly for learning purposes, probably there is a pretty straightforward way of doing it and I could avoid extra complexity.</p>\n\n<p>In the end, I would like to periodically monitor some sites via HTTP (get just the returned status code) but don't query all of them again until I have all the responses.  </p>\n"}, {"tags": ["asynchronous", "rust", "future"], "answers": [{"comments": [{"owner": {"reputation": 6932, "user_id": 774236, "user_type": "registered", "accept_rate": 51, "profile_image": "https://www.gravatar.com/avatar/7e46879a230ff1e28cd975e3b0a0873b?s=128&d=identicon&r=PG", "display_name": "Matteo Monti", "link": "https://stackoverflow.com/users/774236/matteo-monti"}, "edited": false, "score": 0, "creation_date": 1558535288, "post_id": 56258784, "comment_id": 99134892, "body": "Amazing! Minor question: what&#39;s still in nightly is the <code>async&#47;await</code> feature (hence the <code>#![feature(async_await)]</code>), but the <code>std::Future</code> interface is now stable, right?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 6932, "user_id": 774236, "user_type": "registered", "accept_rate": 51, "profile_image": "https://www.gravatar.com/avatar/7e46879a230ff1e28cd975e3b0a0873b?s=128&d=identicon&r=PG", "display_name": "Matteo Monti", "link": "https://stackoverflow.com/users/774236/matteo-monti"}, "edited": false, "score": 0, "creation_date": 1558535513, "post_id": 56258784, "comment_id": 99135037, "body": "@MatteoMonti kind of? <code>Future</code> has been stabilized in the nightly compiler, but that stabilization has not yet made it to the beta channel. It definitely hasn&#39;t made it to any released Rust version."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "reply_to_user": {"reputation": 6932, "user_id": 774236, "user_type": "registered", "accept_rate": 51, "profile_image": "https://www.gravatar.com/avatar/7e46879a230ff1e28cd975e3b0a0873b?s=128&d=identicon&r=PG", "display_name": "Matteo Monti", "link": "https://stackoverflow.com/users/774236/matteo-monti"}, "edited": false, "score": 0, "creation_date": 1558535571, "post_id": 56258784, "comment_id": 99135063, "body": "@MatteoMonti <code>Future</code> will be stabilized (in 1.36.0), but not in the current stable (1.34.0). You need the feature fo <code>async fn hellow</code>."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 7, "last_activity_date": 1573222088, "last_edit_date": 1573222088, "creation_date": 1558534115, "answer_id": 56258784, "question_id": 56252798, "link": "https://stackoverflow.com/questions/56252798/how-do-i-execute-an-async-await-function-without-using-any-external-dependencies/56258784#56258784", "title": "How do I execute an async/await function without using any external dependencies?", "body": "<p>This part of the futures stack is not <em>intended</em> to be implemented by many people. The rough estimate that I have seen in that maybe there will be 10 or so actual implementations.</p>\n\n<p>That said, you can fill in the basic aspects of an executor that is extremely limited by following the function signatures needed:</p>\n\n<pre><code>async fn hello() {\n    println!(\"Hello, World!\");\n}\n\nfn main() {\n    drive_to_completion(hello());\n}\n\nuse std::{\n    future::Future,\n    ptr,\n    task::{Context, Poll, RawWaker, RawWakerVTable, Waker},\n};\n\nfn drive_to_completion&lt;F&gt;(f: F) -&gt; F::Output\nwhere\n    F: Future,\n{\n    let waker = my_waker();\n    let mut context = Context::from_waker(&amp;waker);\n\n    let mut t = Box::pin(f);\n    let t = t.as_mut();\n\n    loop {\n        match t.poll(&amp;mut context) {\n            Poll::Ready(v) =&gt; return v,\n            Poll::Pending =&gt; panic!(\"This executor does not support futures that are not ready\"),\n        }\n    }\n}\n\ntype WakerData = *const ();\n\nunsafe fn clone(_: WakerData) -&gt; RawWaker {\n    my_raw_waker()\n}\nunsafe fn wake(_: WakerData) {}\nunsafe fn wake_by_ref(_: WakerData) {}\nunsafe fn drop(_: WakerData) {}\n\nstatic MY_VTABLE: RawWakerVTable = RawWakerVTable::new(clone, wake, wake_by_ref, drop);\n\nfn my_raw_waker() -&gt; RawWaker {\n    RawWaker::new(ptr::null(), &amp;MY_VTABLE)\n}\n\nfn my_waker() -&gt; Waker {\n    unsafe { Waker::from_raw(my_raw_waker()) }\n}\n</code></pre>\n\n<p>Starting at <a href=\"https://doc.rust-lang.org/nightly/std/future/trait.Future.html#tymethod.poll\" rel=\"nofollow noreferrer\"><code>Future::poll</code></a>, we see we need a <a href=\"https://doc.rust-lang.org/nightly/std/pin/struct.Pin.html\" rel=\"nofollow noreferrer\"><code>Pin</code></a>ned future and a <a href=\"https://doc.rust-lang.org/nightly/std/task/struct.Context.html\" rel=\"nofollow noreferrer\"><code>Context</code></a>. <code>Context</code> is created from a <a href=\"https://doc.rust-lang.org/nightly/std/task/struct.Waker.html\" rel=\"nofollow noreferrer\"><code>Waker</code></a> which needs a <a href=\"https://doc.rust-lang.org/nightly/std/task/struct.RawWaker.html\" rel=\"nofollow noreferrer\"><code>RawWaker</code></a>. A <code>RawWaker</code> needs a <a href=\"https://doc.rust-lang.org/nightly/std/task/struct.RawWakerVTable.html\" rel=\"nofollow noreferrer\"><code>RawWakerVTable</code></a>. We create all of those pieces in the simplest possible ways:</p>\n\n<ul>\n<li><p>Since we aren't trying to support <code>NotReady</code> cases, we never need to actually do anything for that case and can instead panic. This also means that the implementations of <code>wake</code> can be no-ops. </p></li>\n<li><p>Since we aren't trying to be efficient, we don't need to store any data for our waker, so <code>clone</code> and <code>drop</code> can basically be no-ops as well.</p></li>\n<li><p>The easiest way to pin the future is to <code>Box</code> it, but this isn't the most efficient possibility.</p></li>\n</ul>\n\n<hr>\n\n<p>If you wanted to support <code>NotReady</code>, the simplest extension is to have a busy loop, polling forever. A slightly more efficient solution is to have a global variable that indicates that someone has called <code>wake</code> and block on that becoming true. </p>\n"}], "owner": {"reputation": 6932, "user_id": 774236, "user_type": "registered", "accept_rate": 51, "profile_image": "https://www.gravatar.com/avatar/7e46879a230ff1e28cd975e3b0a0873b?s=128&d=identicon&r=PG", "display_name": "Matteo Monti", "link": "https://stackoverflow.com/users/774236/matteo-monti"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1354, "favorite_count": 0, "accepted_answer_id": 56258784, "answer_count": 1, "score": 3, "last_activity_date": 1573222088, "creation_date": 1558514915, "last_edit_date": 1558531495, "question_id": 56252798, "link": "https://stackoverflow.com/questions/56252798/how-do-i-execute-an-async-await-function-without-using-any-external-dependencies", "title": "How do I execute an async/await function without using any external dependencies?", "body": "<p>I am attempting to create simplest possible example that can get <code>async fn hello()</code> to eventually print out <code>Hello World!</code>. This should happen without any external dependency like <code>tokio</code>, just plain Rust and <code>std</code>. Bonus points if we can get it done without ever using <code>unsafe</code>.</p>\n\n<pre><code>#![feature(async_await)]\n\nasync fn hello() {\n    println!(\"Hello, World!\");\n}\n\nfn main() {\n    let task = hello();\n\n    // Something beautiful happens here, and `Hello, World!` is printed on screen.\n}\n</code></pre>\n\n<ul>\n<li>I know <code>async/await</code> is still a nightly feature, and it is subject to change in the foreseeable future.</li>\n<li>I know there is a whole lot of <code>Future</code> implementations, I am aware of the existence of <code>tokio</code>.</li>\n<li>I am just trying to educate myself on the inner workings of standard library futures.</li>\n</ul>\n\n<h3>My helpless, clumsy endeavours</h3>\n\n<p>My vague understanding is that, first off, I need to <code>Pin</code> task down. So I went ahead and</p>\n\n<pre><code>let pinned_task = Pin::new(&amp;mut task);\n</code></pre>\n\n<p>but</p>\n\n<pre><code>the trait `std::marker::Unpin` is not implemented for `std::future::GenFuture&lt;[static generator@src/main.rs:7:18: 9:2 {}]&gt;`\n</code></pre>\n\n<p>so I thought, of course, I probably need to <code>Box</code> it, so I'm sure it won't move around in memory. Somewhat surprisingly, I get the same error.</p>\n\n<p>What I could get so far is</p>\n\n<pre><code>let pinned_task = unsafe {\n    Pin::new_unchecked(&amp;mut task)\n};\n</code></pre>\n\n<p>which is obviously not something I should do. Even so, let's say I got my hands on the <code>Pin</code>ned <code>Future</code>. Now I need to <code>poll()</code> it somehow. For that, I need a <code>Waker</code>.</p>\n\n<p>So I tried to look around on how to get my hands on a <code>Waker</code>. On the <a href=\"https://doc.rust-lang.org/std/task/struct.Waker.html\" rel=\"nofollow noreferrer\">doc</a> it kinda looks like the only way to get a <code>Waker</code> is with another <code>new_unchecked</code> that accepts a <code>RawWaker</code>. From there I got <a href=\"https://doc.rust-lang.org/std/task/struct.RawWaker.html\" rel=\"nofollow noreferrer\">here</a> and from there <a href=\"https://doc.rust-lang.org/std/task/struct.RawWakerVTable.html\" rel=\"nofollow noreferrer\">here</a>, where I just curled up on the floor and started crying.</p>\n"}, {"tags": ["rust", "substrate"], "answers": [{"comments": [{"owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "edited": false, "score": 0, "creation_date": 1558623326, "post_id": 56260534, "comment_id": 99170209, "body": "Thanks, so if a stubborn runtime implementer only wants their  operation to run on-chain, but wants to minimise associated risks, could they just take the following actions? 1) Discourage blockchain attacks by attaching a bond amount to calling the operation to cover the maximum possible execution cost; 2) Ensure the node continues block production by preventing runtime upgrades that extend the default block time, and testing that the operation doesn&#39;t exceed it."}], "tags": [], "owner": {"reputation": 9375, "user_id": 1396977, "user_type": "registered", "accept_rate": 82, "profile_image": "https://i.stack.imgur.com/PylBh.jpg?s=128&g=1", "display_name": "Shawn Tabrizi", "link": "https://stackoverflow.com/users/1396977/shawn-tabrizi"}, "is_accepted": false, "score": 0, "last_activity_date": 1558539730, "creation_date": 1558539730, "answer_id": 56260534, "question_id": 56249972, "link": "https://stackoverflow.com/questions/56249972/why-should-runtime-implementers-avoid-enumerating-enumerablestoragemap-storage-e/56260534#56260534", "title": "Why should runtime implementers avoid enumerating EnumerableStorageMap storage entries on-chain?", "body": "<p>In runtime development, list iteration is, generally speaking, evil.</p>\n\n<p>Unless explicitly guarded against, it will add unbounded O(N) complexity to an operation that will only charge O(1) fees. As a result, your chain becomes attackable.</p>\n\n<p>Additionally, if lists become so large, and you iterate over all the elements, the process may take longer than the block time, and thus a node would never produce a block.</p>\n\n<p>You will find bounded loops within certain Runtime modules, but you need to be conscious of the time/computation complexity of those loops.</p>\n\n<p>You can easily \"simulate\" an enumerable list with two storage items:</p>\n\n<pre><code>decl_storage! {\n    trait Store for Module&lt;T: Trait&gt; as Example {\n        AllPeopleArray get(person): map u32 =&gt; T::AccountId;\n        AllPeopleCount get(num_of_people): u32;\n    }\n}\n</code></pre>\n\n<p>But I believe the intention is to make it a little more difficult for you to do bad things within your modules.</p>\n"}], "owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 73, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558540125, "creation_date": 1558503524, "last_edit_date": 1558540125, "question_id": 56249972, "link": "https://stackoverflow.com/questions/56249972/why-should-runtime-implementers-avoid-enumerating-enumerablestoragemap-storage-e", "title": "Why should runtime implementers avoid enumerating EnumerableStorageMap storage entries on-chain?", "body": "<p>The documentation for <a href=\"https://crates.parity.io/srml_support/storage/trait.EnumerableStorageMap.html\" rel=\"nofollow noreferrer\"><code>EnumerableStorageMap</code></a> states:</p>\n\n<blockquote>\n  <p>Primarily useful for off-chain computations. Runtime implementors should avoid enumerating storage entries on-chain.</p>\n</blockquote>\n\n<p>Why should runtime implementers avoid enumerating these storage entries on-chain?</p>\n"}, {"tags": ["javascript", "rust", "webassembly"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558489777, "post_id": 56248080, "comment_id": 99114684, "body": "You&#39;ve elided parts of the linked answer and in doing so cause problems that you have to then work around (*no field ... *). Why have you made these changes to the (presumably) working code?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558489795, "post_id": 56248080, "comment_id": 99114687, "body": "By the way, idiomatic Rust uses <code>snake_case</code> for variables, methods, macros, fields and modules; <code>UpperCamelCase</code> for types and enum variants; and <code>SCREAMING_SNAKE_CASE</code> for statics and constants."}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558489992, "post_id": 56248080, "comment_id": 99114719, "body": "The no field error comes from the linked answer, even if I don&#39;t change anything that error occurs. I see the warnings when compiling for snake_case, etc and those are easy to fix. I don&#39;t think those are the issue here. The only changes I made from the linked code is the: let data = std::slice::from_raw_parts((*s).data, (*s).len);  This line didn&#39;t compile by itself anyway. Do you have any idea regarding the question I asked?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558490366, "post_id": 56248080, "comment_id": 99114775, "body": "The linked code <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=50c67af0778d430f9a37091c81f8cd14\" rel=\"nofollow noreferrer\">builds just fine</a>. You&#39;ve stated that the existing answer doesn&#39;t even compile, but that&#39;s demonstrably not true."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558490519, "post_id": 56248080, "comment_id": 99114801, "body": "<code>Ok(s) =&gt; real_code::compute(dataToPrint.unwrap())</code> \u2014 just use <code>Ok(s) =&gt; real_code::compute(s)</code>. You may wish to re-read the relevant sections of <a href=\"https://doc.rust-lang.org/book/\" rel=\"nofollow noreferrer\"><i>The Rust Programming Language</i></a> to help avoid these types of contortions."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558490586, "post_id": 56248080, "comment_id": 99114814, "body": "Why is there an <code>unsafe</code> block inside of your <code>unsafe</code> function?"}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558490765, "post_id": 56248080, "comment_id": 99114841, "body": "The verbatim original post builds fine, I wouldn&#39;t be posting this if it doesn&#39;t....."}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558490943, "post_id": 56248080, "comment_id": 99114866, "body": "Im saying the code I attached here doesn&#39;t build, but it is taking aspects of the post you linked... if you are going to respond, I&#39;d prefer you actually try to answer my question.... plz  whether i use dataToPrint.unwrap() or just dataToPrint it works fine, but this still doesn&#39;t answer the posted question...  yes the linked post builds, but with these changes it does not. Can you actually help me debug this...  even if I take out the unsafe inside the unsafe, it doesn&#39;t do anything for my question being answered..."}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558491027, "post_id": 56248080, "comment_id": 99114879, "body": "ALSO, the code compiles just fine, its not a compilation problem shepmaster, its PURELY about the data being passed from javascript, showing up as empty during runtime..... please read my question carefully before you answer about specific tokens or lines of code."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558491096, "post_id": 56248080, "comment_id": 99114890, "body": "I&#39;m sorry that I&#39;ve made you angry. Good luck solving your problem!"}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558491237, "post_id": 56248080, "comment_id": 99114914, "body": "you didn&#39;t make me angry, just trying to make sure we stay on task here... none of your answers were helpful towards the goal"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558491469, "post_id": 56248080, "comment_id": 99114955, "body": "I haven&#39;t provided <b>any</b> answers. I&#39;ve only <i>commented</i> on issues with the code. That&#39;s the distinction between comments and answers on Stack Overflow."}, {"owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558545125, "post_id": 56248080, "comment_id": 99140262, "body": "@Shepmaster updated the question even further, I think I figured it out. Your old post helped me think it through, but it wasn&#39;t as straight forward as it was back then. Still simple though."}], "owner": {"reputation": 11, "user_id": 11536629, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/14140e3906c16454d82e17a2a69df2e3?s=128&d=identicon&r=PG&f=1", "display_name": "gadgethead", "link": "https://stackoverflow.com/users/11536629/gadgethead"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 203, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1563203982, "creation_date": 1558487432, "last_edit_date": 1563203982, "question_id": 56248080, "link": "https://stackoverflow.com/questions/56248080/javascript-string-is-empty-when-passed-to-rust-webassembly-module", "title": "JavaScript string is empty when passed to Rust WebAssembly module", "body": "<p>When passing a string to a Rust WASM module, the passed data shows up as blank, as per the pattern matching in the <code>real_code::compute</code> function</p>\n\n<p>The following code is what I've tried. I don't know if it has to do with how its being returned, but when I pass a hardcoded <code>&amp;str</code>, it works fine. However, the <code>JsInteropString</code> shows as blank. </p>\n\n<p>Here is how I encoded the string before sending it to WASM (from <a href=\"https://stackoverflow.com/questions/49014610/passing-a-javascript-string-to-a-rust-function-compiled-to-webassembly\">Passing a JavaScript string to a Rust function compiled to WebAssembly</a>)</p>\n\n<pre><code>const memory = new WebAssembly.Memory({ initial: 20, \n                                        maximum: 100 });\n\nconst importObject = {\n  env: { memory }\n};\n\nconst memoryManager = (memory) =&gt; {\n  var base = 0;\n\n  // NULL is conventionally at address 0, so we \"use up\" the first 4\n  // bytes of address space to make our lives a bit simpler.\n  base += 4;\n\n  return {\n    encodeString: (jsString) =&gt; {\n      // Convert the JS String to UTF-8 data\n      const encoder = new TextEncoder();\n      const encodedString = encoder.encode(jsString);\n\n      // Organize memory with space for the JsInteropString at the\n      // beginning, followed by the UTF-8 string bytes.\n      const asU32 = new Uint32Array(memory.buffer, base, 2);\n      const asBytes = new Uint8Array(memory.buffer, asU32.byteOffset + asU32.byteLength, encodedString.length);\n\n      // Copy the UTF-8 into the WASM memory.\n      asBytes.set(encodedString);\n\n      // Assign the data pointer and length values.\n      asU32[0] = asBytes.byteOffset;\n      asU32[1] = asBytes.length;\n\n      // Update our memory allocator base address for the next call\n      const originalBase = base;\n      base += asBytes.byteOffset + asBytes.byteLength;\n\n      return originalBase;\n    }\n  };\n};\n</code></pre>\n\n<p>invoking wasm like this:</p>\n\n<pre><code>//...loading and compiling WASM, getting instance from promise (standard)\nconst testStr = \"TEST\"\nconst input = myMemory.encodeString(testStr);\nconst offset = instance.exports.func_to_call(input);\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// A struct with a known memory layout that we can pass string information in\n#[repr(C)]\npub struct JsInteropString {\n    data: *const u8,\n    len: usize,\n}\n\n// Our FFI shim function\n#[no_mangle]\npub unsafe extern \"C\" fn func_to_call(s: *const JsInteropString) -&gt; *mut c_char {\n    // ... check for nulls etc\n\n    /*\n    THROWS ERROR\n    error[E0609]: no field `data` on type `*const JsInteropString`\n    */\n    //////let data = std::slice::from_raw_parts(s.data, s.len);\n\n    //this fixes the above error\n    let data = std::slice::from_raw_parts((*s).data, (*s).len);\n\n    let dataToPrint: Result&lt;_, _&gt; = std::str::from_utf8(data);\n\n    let real_res: &amp;str = match dataToPrint {\n        Ok(s) =&gt; real_code::compute(dataToPrint.unwrap()), //IS BLANK\n        //Ok(s) =&gt; real_code::compute(\"SUCCESS\"), //RETURNS \"SUCCESS made it\"\n        Err(_) =&gt; real_code::compute(\"ERROR\"),\n    };\n\n    unsafe {\n        let s = CString::new(real_res).unwrap();\n        println!(\"result: {:?}\", &amp;s);\n        s.into_raw()\n    }\n}\n\nmod real_code {\n    pub fn compute(operator: &amp;str) -&gt; &amp;str {\n        match operator {\n            \"SUCCESS\" =&gt; \"SUCCESS made it\",\n            \"ERROR\" =&gt; \"ERROR made it\",\n            \"TEST\" =&gt; \"TEST made it\",\n            _ =&gt; operator,\n        }\n    }\n}\n</code></pre>\n\n<p>When the function is called from JavaScript, it should return the same string passed. I even went as far as to update my Rust environment with rustup... any ideas? </p>\n\n<h3>UPDATE</h3>\n\n<p>Using a more representative version of the referenced post:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub unsafe extern \"C\" fn compute(s: *const JsInteropString) -&gt; i32 {\n\n    let s = match s.as_ref() {\n        Some(s) =&gt; s,\n        None =&gt; return -1,\n    };\n\n    // Convert the pointer and length to a `&amp;[u8]`.\n    let data = std::slice::from_raw_parts(s.data, s.len);\n\n    // Convert the `&amp;[u8]` to a `&amp;str`    \n    match std::str::from_utf8(data) {\n        Ok(s) =&gt; real_code::compute(s),\n        Err(_) =&gt; -2,\n    }\n\n}\n\nmod real_code {\n    pub fn compute(operator: &amp;str) -&gt; i32 {\n        match operator {\n            \"SUCCESS\"  =&gt; 1,\n            \"ERROR\" =&gt; 2,\n            \"TEST\" =&gt; 3,\n            _ =&gt; 10,\n        }\n    }\n}\n</code></pre>\n\n<p>regardless on the string passed through the js encoding, it still returns the default value from compute. I don't know if the referenced post actually solves the problem.</p>\n\n<p>So yes, the code compiles. It is a runtime issue I am trying to solve. Something is off about how the string is being encoded and passed to WASM.</p>\n\n<h1>Update 2</h1>\n\n<p>Tried switching my toolchain to Nightly, and what I also found is that the following macros/attributes throw an error regarding unstable attributes</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(wasm_import_memory)]\n#![wasm_import_memory]\n</code></pre>\n\n<p>After realizing that I need to tell rust that memory will be imported, this seems to have fixed the problem of the string being passed as empty. It wasn't empty, it wasnt even passed it seems like.</p>\n\n<p>Inside the .cargo file</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>[target.wasm32-unknown-unknown]\nrustflags = [\n    \"-Clink-args=-s EXPORTED_FUNCTIONS=['_func_to_call'] -s ASSERTIONS=1\",\n    \"-C\", \"link-args=--import-memory\",\n]\n</code></pre>\n\n<p>This seems to may have done the trick! @Shepmaster, update your answer from last year for others who stumble across it, as it has good SEO. This is due to changes in the rust environment. </p>\n"}, {"tags": ["rust", "immutability", "borrow-checker"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558483472, "post_id": 56246436, "comment_id": 99113699, "body": "What do you believe that the <code>clone</code> method does? Why do you think it is required to &quot;clone graph so I can mutate graph later&quot;?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558483544, "post_id": 56246436, "comment_id": 99113711, "body": "It&#39;s a bit hard to answer your question because it doesn&#39;t include a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. Your code compiles, but doesn&#39;t include code that demonstrates the problem, such as an example main. It would make it much easier for us to help if you try to reproduce your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> if possible, otherwise in a brand new Cargo project, then <a href=\"https://stackoverflow.com/posts/56246436/edit\">edit</a> your question to include the additional info. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> you can use to reduce your original code for posting here. Thanks!"}, {"owner": {"reputation": 171, "user_id": 4181689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/3QTrP.jpg?s=128&g=1", "display_name": "Thomas C", "link": "https://stackoverflow.com/users/4181689/thomas-c"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558530753, "post_id": 56246436, "comment_id": 99131774, "body": "@Shepmaster Thanks for looking, I think that clone is making an immutable copy of the map?  This is required because when I try to access the map contents and then later mutate it, I get an error.   In my understanding I should be cloning the now mutated map, so the values in the clone should be updated?"}, {"owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "edited": false, "score": 0, "creation_date": 1558949963, "post_id": 56246436, "comment_id": 99254779, "body": "@ThomasC did you have a chance to look at the provided answer?  How is that not satisfying your requirements?"}], "answers": [{"comments": [{"owner": {"reputation": 171, "user_id": 4181689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/3QTrP.jpg?s=128&g=1", "display_name": "Thomas C", "link": "https://stackoverflow.com/users/4181689/thomas-c"}, "edited": false, "score": 1, "creation_date": 1559131928, "post_id": 56246864, "comment_id": 99323980, "body": "Thanks, your answer let me see that I was cloning the original map each time. I now just clone the original and pass it in as a parameter to the function."}, {"owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "reply_to_user": {"reputation": 171, "user_id": 4181689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/3QTrP.jpg?s=128&g=1", "display_name": "Thomas C", "link": "https://stackoverflow.com/users/4181689/thomas-c"}, "edited": false, "score": 0, "creation_date": 1559135077, "post_id": 56246864, "comment_id": 99325933, "body": "No worries, I&#39;m glad if my answer was any help!"}], "tags": [], "owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "is_accepted": true, "score": 1, "last_activity_date": 1558483424, "last_edit_date": 1558483424, "creation_date": 1558475913, "answer_id": 56246864, "question_id": 56246436, "link": "https://stackoverflow.com/questions/56246436/updating-mutable-hashmap-in-a-while-loop/56246864#56246864", "title": "Updating mutable HashMap in a while loop", "body": "<p>I'm not really sure what you are trying to achieve here, but based on what I can see above, that is, you'd like to mutate your original <code>graph</code> (because you are passing that as a mutable borrow to your function) and that you don't have a return value, and that your question is about mutating a hashmap -- I assume that you'd like the changes to be reflected in your original <code>HashMap</code>.  So why are you cloning it in the first place then?</p>\n\n<p>If on the other hand you don't want to mutate your original object, then don't pass it in as a mutable borrow, but as an immutable one.  Then create a clone of it before you start the loop and use that cloned version throughout your algorithm.  </p>\n\n<p>The problem you are facing with is happening because on every iteration you are cloning the original <code>graph</code> and not your cloned <code>imut_graph</code>, i.e. on every iteration you create a new <code>HashMap</code>, which then you are mutating, then you start a new cycle and you are still checking the length of the original one and then you clone the original one again.</p>\n\n<p>So the two options you have are:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::collections::HashMap;\n\nfn mutated(map: &amp;mut HashMap&lt;i32, Vec&lt;i32&gt;&gt;) {\n    map.insert(1, vec![4, 5, 6]);\n}\n\nfn cloned(map: &amp;HashMap&lt;i32, Vec&lt;i32&gt;&gt;) -&gt; HashMap&lt;i32, Vec&lt;i32&gt;&gt; {\n    let mut map = map.clone();\n    map.insert(2, vec![7, 8, 9]);\n    map\n}\n\nfn main() {\n    let mut map = HashMap::new();\n    map.insert(0, vec![1, 2, 3]);\n\n    println!(\"{:?}\", cloned(&amp;map));\n\n    mutated(&amp;mut map);\n    println!(\"{:?}\", map);\n}\n</code></pre>\n\n<p>Which will give you:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>{0: [1, 2, 3], 2: [7, 8, 9]}\n{0: [1, 2, 3], 1: [4, 5, 6]}\n</code></pre>\n"}], "owner": {"reputation": 171, "user_id": 4181689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/3QTrP.jpg?s=128&g=1", "display_name": "Thomas C", "link": "https://stackoverflow.com/users/4181689/thomas-c"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 721, "favorite_count": 0, "accepted_answer_id": 56246864, "answer_count": 1, "score": 0, "last_activity_date": 1558483424, "creation_date": 1558473155, "last_edit_date": 1558483354, "question_id": 56246436, "link": "https://stackoverflow.com/questions/56246436/updating-mutable-hashmap-in-a-while-loop", "title": "Updating mutable HashMap in a while loop", "body": "<p>I am trying to implement Karger's algorithm in Rust and I have run into an issue while trying to update a mutable hashmap in a while loop.</p>\n\n<p>The map is updated successfully, but then in the next iteration when it was cloned, the values that were updated don't seem to have been changed. However removing elements from the map is reflected on later iterations.</p>\n\n<p>I have tried debugging and printing the values of the map, but the sequence of events doesn't make sense to me.</p>\n\n<pre><code>use itertools::Itertools;  // 0.8.0\nuse rand::seq::{IteratorRandom, SliceRandom}; // 0.6.5\nuse std::collections::HashMap;\n\nfn contract_edge(graph: &amp;mut HashMap&lt;i32, Vec&lt;i32&gt;&gt;, num_trials: i32) {\n    let mut count = 0;\n\n    while graph.len() &gt; 2 &amp;&amp; count &lt; num_trials {\n        // clone graph so I can mutate graph later\n        let imut_graph = graph.clone();\n\n        // choose random node\n        let from_value = imut_graph\n            .keys()\n            .choose(&amp;mut rand::thread_rng())\n            .unwrap()\n            .clone();\n        let values = imut_graph.get(&amp;from_value);\n        let to_value = values\n            .unwrap()\n            .choose(&amp;mut rand::thread_rng())\n            .unwrap()\n            .clone();\n\n        let from_edges = imut_graph[&amp;from_value].iter().clone();\n\n        // accessing to_value in imut_graph gives error here later\n        let to_edges = imut_graph[&amp;to_value]\n            .iter()\n            .clone()\n            .filter(|&amp;x| *x != from_value &amp;&amp; *x != to_value);\n\n        let new_edges = from_edges.chain(to_edges);\n\n        // since I am mutating the graph I thought the next time is is clone it would be updated?\n        graph.insert(from_value, new_edges.map(|v| v.clone()).collect());\n        graph.remove(&amp;to_value);\n        for (_key, val) in graph.iter_mut() {\n            *val = val\n                .iter()\n                .map(|v| if v == &amp;to_value { &amp;from_value } else { v })\n                .unique()\n                .cloned()\n                .collect();\n        }\n        count += 1;\n    }\n}\n</code></pre>\n\n<p>When I try to access the map, I get element not found error, but the keys which have been removed should not exist in the vector values at that point.</p>\n\n<p>I am convinced this is something I don't understand about (Im)mutability in Rust.</p>\n"}, {"tags": ["rust", "iterator", "lifetime", "borrow-checker"], "answers": [{"comments": [{"owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "edited": false, "score": 0, "creation_date": 1558533326, "post_id": 56246567, "comment_id": 99133594, "body": "What you suggest was in fact my starting point. It yields this error:       |                                          expected mutable reference, found struct <code>itertools::PutBack</code>     |                                          help: consider mutably borrowing here: <code>&amp;mut put_back(s.chars() }</code>"}, {"owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "edited": false, "score": 0, "creation_date": 1558533522, "post_id": 56246567, "comment_id": 99133736, "body": "Then if I follow that advice, i get <code>returns a value referencing data owned by the current function</code>"}, {"owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "edited": false, "score": 0, "creation_date": 1558535523, "post_id": 56246567, "comment_id": 99135042, "body": "I didn&#39;t notice your changes to the lifetimes. Testing it again."}, {"owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "edited": false, "score": 1, "creation_date": 1558535678, "post_id": 56246567, "comment_id": 99135121, "body": "Your proposal compiles! On to the next problem..."}, {"owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "reply_to_user": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "edited": false, "score": 0, "creation_date": 1558537867, "post_id": 56246567, "comment_id": 99136546, "body": "The devil is always in the detail, isn&#39;t he?  Anyway, I&#39;m glad if I could help ;)"}], "tags": [], "owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "is_accepted": true, "score": 1, "last_activity_date": 1558474598, "last_edit_date": 1558474598, "creation_date": 1558473965, "answer_id": 56246567, "question_id": 56245854, "link": "https://stackoverflow.com/questions/56245854/create-an-iterator-and-put-it-into-a-new-struct-without-bothering-the-borrow-che/56246567#56246567", "title": "Create an iterator and put it into a new struct without bothering the borrow-checker", "body": "<p>Well, the compiler is almost telling you the solution by reflecting to the obvious problem: you can't have a borrow which doesn't live long enough, i.e. the borrow would point to a nonexistent location after the stack memory of the function has been destroyed.</p>\n\n<p>This would happen because the borrow is referencing an object (in this case an <code>itertools::struct::PutBack</code> instance) that has been newly created within the function body.  This instance gets destroyed at the end of the function along with all the references to it.  So the compiler is preventing you to have a so called <em>dangling pointer</em>.</p>\n\n<p>Thus, instead of borrowing you should <strong>move</strong> the <code>PutBack</code> instance into your <code>struct</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// ...\n\npub struct ParserEventIterator&lt;'e&gt; {\n    char_iter: itertools::PutBack&lt;std::str::Chars&lt;'e&gt;&gt;\n}\n\nimpl&lt;'e&gt; ParserEventIterator&lt;'e&gt; {\n    fn new(s: &amp;'e std::string::String) -&gt; ParserEventIterator&lt;'e&gt; {\n        ParserEventIterator { char_iter: put_back(s.chars()) }\n    }\n\n    // ...\n}\n</code></pre>\n"}], "owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 70, "favorite_count": 0, "closed_date": 1558483791, "accepted_answer_id": 56246567, "answer_count": 1, "score": 1, "last_activity_date": 1558534601, "creation_date": 1558470188, "last_edit_date": 1558534601, "question_id": 56245854, "link": "https://stackoverflow.com/questions/56245854/create-an-iterator-and-put-it-into-a-new-struct-without-bothering-the-borrow-che", "closed_reason": "Duplicate", "title": "Create an iterator and put it into a new struct without bothering the borrow-checker", "body": "<p>I am trying to create a lexical analyzer which uses <code>itertools::PutBack</code> to make an iterator over the characters in a <code>String</code>. I intend to store the pushback iterator in a struct and delegate methods to it so that I can categorize the characters by an enum, which will then be passed to  a state machine at the core of the lexical analyzer (not yet written).</p>\n\n<p>The borrow-checker is not happy with me. Method <code>ParserEventIterator::new</code> near the bottom of the listing causes the error. How do I define the lifetimes or borrowing so that I can get this to compile? Or what Rustic data structure design should I use in its stead? </p>\n\n<p>Ultimately, I would like this to implement the appropriate traits to become a proper iterator. (Newbie to Rust. Prior to this, I have programmed in 28 languages, but this one has me stumped.)</p>\n\n<p>Here is a code sample:</p>\n\n<pre><code>extern crate itertools;\nuse itertools::put_back;\nuse std::fmt::Display;\nuse std::fmt::Formatter;\nuse std::fmt::Result;\n\npub enum ParserEvent {\n    Letter(char),\n    Digit(char),\n    Other(char),\n}\n\nimpl ParserEvent {\n    fn new(c: char) -&gt; ParserEvent {\n        match c {\n            'a'...'z' | 'A'...'Z' =&gt; ParserEvent::Letter(c),\n            '0'...'9' =&gt; ParserEvent::Digit(c),\n            _ =&gt; ParserEvent::Other(c),\n        }\n    }\n}\n\nimpl Display for ParserEvent {\n    fn fmt(&amp;self, f: &amp;mut Formatter) -&gt; Result {\n        let mut _ctos = |c: char| write!(f, \"{}\", c.to_string());\n        match self {\n            ParserEvent::Letter(letter) =&gt; _ctos(*letter),\n            ParserEvent::Digit(digit) =&gt; _ctos(*digit),\n            ParserEvent::Other(o) =&gt; _ctos(*o),\n        }\n    }\n}\n\n//  ParserEventIterator\n//  Elements ('e) must have lifetime longer than the iterator ('i).\npub struct ParserEventIterator&lt;'i, 'e: 'i&gt; {\n    char_iter: &amp;'i mut itertools::PutBack&lt;std::str::Chars&lt;'e&gt;&gt;,\n}\n\nimpl&lt;'i, 'e: 'i&gt; ParserEventIterator&lt;'i, 'e&gt; {\n    fn new(s: &amp;'e std::string::String) -&gt; ParserEventIterator&lt;'i, 'e&gt; {\n        // THIS NEXT LINE IS THE LINE WITH THE PROBLEM!!!\n        ParserEventIterator {\n            char_iter: &amp;mut put_back(s.chars()),\n        }\n    }\n\n    fn put_back(&amp;mut self, e: ParserEvent) -&gt; () {\n        if let Some(c) = e.to_string().chars().next() {\n            self.char_iter.put_back(c);\n        }\n    }\n}\n\nimpl&lt;'i, 'e: 'i&gt; Iterator for ParserEventIterator&lt;'i, 'e&gt; {\n    type Item = ParserEvent;\n    fn next(&amp;mut self) -&gt; Option&lt;ParserEvent&gt; {\n        match self.char_iter.next() {\n            Some(c) =&gt; Some(ParserEvent::new(c)),\n            None =&gt; None,\n        }\n    }\n}\n\nfn main() {\n    let mut _i = ParserEventIterator::new(&amp;String::from(\"Hello World\"));\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b02afdef23533d8c2667c954202d0a1a\" rel=\"nofollow noreferrer\">On the Rust Playground</a></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0515]: cannot return value referencing temporary value\n  --&gt; src/main.rs:43:9\n   |\n43 | /         ParserEventIterator {\n44 | |             char_iter: &amp;mut put_back(s.chars()),\n   | |                             ------------------- temporary value created here\n45 | |         }\n   | |_________^ returns a value referencing data owned by the current function\n</code></pre>\n"}, {"tags": ["rust", "ffi"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558462592, "post_id": 56244190, "comment_id": 99107018, "body": "You have a function called <code>init</code> that is never called by the code you have posted. Thus, the message will never be printed."}, {"owner": {"reputation": 91, "user_id": 8706910, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/21ab5dabdc4ab080436915b5050ac3cd?s=128&d=identicon&r=PG&f=1", "display_name": "Nicolas Chan", "link": "https://stackoverflow.com/users/8706910/nicolas-chan"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558462686, "post_id": 56244190, "comment_id": 99107058, "body": "This is a dynamic library plugin, and the <code>init()</code> function is called by the C code loading the plugin. I have confirmed that <code>init()</code> is being called because the first example where everything is in the same file works."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558462720, "post_id": 56244190, "comment_id": 99107071, "body": "It&#39;s a bit hard to answer your question because it doesn&#39;t include a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. We can&#39;t tell what crates (and their versions), external code, etc. are present in the code. It would make it much easier for us to help if you try to reproduce your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> if possible, otherwise in a brand new Cargo project, then <a href=\"https://stackoverflow.com/posts/56244190/edit\">edit</a> your question to include the additional info. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> you can use to reduce your original code for posting here. Thanks!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1558463043, "post_id": 56244190, "comment_id": 99107210, "body": "<code>CString::new(message).unwrap().as_ptr()</code> is 100% incorrect, which is why <a href=\"https://doc.rust-lang.org/std/ffi/struct.CString.html#method.as_ptr\" rel=\"nofollow noreferrer\">the documentation has a specific warning about what you have written</a>: <i>This happens because the pointer returned by <code>as_ptr</code> does not carry any lifetime information and the <code>CString</code> is deallocated immediately after the [...] expression is evaluated</i>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558463210, "post_id": 56244190, "comment_id": 99107271, "body": "Notably, your code (both versions) contains <i>undefined behavior</i>. Your first example &quot;works&quot; only through a stroke of (bad?) luck. Running it under a tool like Valgrind will should report warnings for both examples."}, {"owner": {"reputation": 91, "user_id": 8706910, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/21ab5dabdc4ab080436915b5050ac3cd?s=128&d=identicon&r=PG&f=1", "display_name": "Nicolas Chan", "link": "https://stackoverflow.com/users/8706910/nicolas-chan"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558464066, "post_id": 56244190, "comment_id": 99107621, "body": "It works after changing my code to keep the CString alive by introducing a variable for it as you suggested <a href=\"https://stackoverflow.com/a/52175101/8706910\">here</a>. Thank you for pointing this out. I didn&#39;t expect the CString to_ptr() to be the issue since it worked in the first example."}], "owner": {"reputation": 91, "user_id": 8706910, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/21ab5dabdc4ab080436915b5050ac3cd?s=128&d=identicon&r=PG&f=1", "display_name": "Nicolas Chan", "link": "https://stackoverflow.com/users/8706910/nicolas-chan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 116, "favorite_count": 0, "closed_date": 1558462911, "answer_count": 0, "score": 0, "last_activity_date": 1558463702, "creation_date": 1558462424, "last_edit_date": 1558463702, "question_id": 56244190, "link": "https://stackoverflow.com/questions/56244190/why-does-calling-a-ffi-function-that-takes-a-string-not-work-when-its-defined-i", "closed_reason": "Duplicate", "title": "Why does calling a FFI function that takes a string not work when it&#39;s defined in a Rust module?", "body": "<p>I'm creating a dynamic library C plugin in Rust (\"cdynlib\"). There is an <code>info()</code> function in the C code, but when I try to call this <code>info()</code> function from a Rust module it does not work.</p>\n\n<p>It does work when I put everything in the same Rust file, but I don't want to do this because I have to make several plugins and want to be able to reuse a safe wrapper over <code>info()</code>.</p>\n\n<p>Here is what works (<code>plugin.rs</code>):</p>\n\n<pre><code>extern \"C\" {\n    fn info(message: *const c_char);\n}\nfn log(message: &amp;str) {\n    unsafe { info(CString::new(message).unwrap().as_ptr()); }\n}\n\n#[no_mangle]\npub extern fn init() {\n    log(\"this message gets through\");\n}\n</code></pre>\n\n<p>But when I move the following to <code>logging.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern \"C\" {\n    fn info(message: *const c_char);\n}\npub fn log(message: &amp;str) {\n    unsafe { info(CString::new(message).unwrap().as_ptr()); }\n}\n</code></pre>\n\n<p>and use it from <code>plugin.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub extern fn init() {\n    logging::log(\"this message does not get through\");\n}\n</code></pre>\n\n<p>The message does not get through when my plugin is loaded.</p>\n\n<p>I expected the code in the logging module to behave the same as in the plugin file, but that is not the case. Perhaps this has something to do with the <code>extern \"C\"</code> block not being in the right place? What is the proper way to do this?</p>\n"}, {"tags": ["linux", "multithreading", "rust", "operating-system"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558456446, "post_id": 56242612, "comment_id": 99104230, "body": "The linked answer shows how to get a pthread ID. I&#39;ve updated this question and the other answer clearly state that pthread vs OS (specifically Linux) ID (what is reported by htop)."}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558456678, "post_id": 56242612, "comment_id": 99104340, "body": "Shit. So you are telling me the pthread_id is yet another intermediate id that needs to be mapped to the OS PID? Any suggestions on how to get the PID from that?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558456782, "post_id": 56242612, "comment_id": 99104391, "body": "I don&#39;t know for sure. I&#39;d try <a href=\"https://docs.rs/nix/0.13.0/nix/unistd/fn.gettid.html\" rel=\"nofollow noreferrer\"><code>gettid</code></a>."}], "answers": [{"tags": [], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "is_accepted": true, "score": 1, "last_activity_date": 1558541300, "last_edit_date": 1558541300, "creation_date": 1558458622, "answer_id": 56243291, "question_id": 56242612, "link": "https://stackoverflow.com/questions/56242612/how-can-i-get-the-linux-pid-for-a-thread/56243291#56243291", "title": "How can I get the Linux PID for a thread?", "body": "<p>I found the answer using an existing crate called <a href=\"https://crates.io/crates/palaver\" rel=\"nofollow noreferrer\">Palaver</a>. It includes a <code>gettid()</code> that works across platforms. The only caveat is that the default configuration of the crate uses nightly features, so if you are on stable, make sure to disable them like this <code>palaver = { version = \"*\", default-features = false }</code></p>\n\n<p>Now, when I run the code that uses <code>gettid()</code>, this is the output:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>This PID 9009\nPriority changed for thread\nSpawned PID 9010\nProcessing request 803\nProcessing request 279\nProcessing request 624\n</code></pre>\n\n<p>And the output from my htop:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code> 6164  1026 root       20   0   98M  7512  6512 S  0.0  0.0  0:00.03 \u2502  \u251c\u2500 sshd: dash [priv]\n 6195  6164 dash       20   0   98M  4176  3176 S  0.0  0.0  0:00.21 \u2502  \u2502  \u2514\u2500 sshd: dash@pts/11\n 6196  6195 dash       20   0 22964  5648  3408 S  0.0  0.0  0:00.10 \u2502  \u2502     \u2514\u2500 -bash\n 9009  6196 dash       20   0  2544     4     0 S  0.0  0.0  0:00.00 \u2502  \u2502        \u2514\u2500 ./process_priorities\n 9010  6196 dash       20   0  2544     4     0 S  0.0  0.0  0:00.00 \u2502  \u2502           \u2514\u2500 LongRunningThre\n</code></pre>\n"}], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 392, "favorite_count": 0, "accepted_answer_id": 56243291, "answer_count": 1, "score": 1, "last_activity_date": 1558541300, "creation_date": 1558455795, "last_edit_date": 1558456083, "question_id": 56242612, "link": "https://stackoverflow.com/questions/56242612/how-can-i-get-the-linux-pid-for-a-thread", "title": "How can I get the Linux PID for a thread?", "body": "<p>I'm interested in obtaining the PID of a thread created inside a Rust program. As stated in the <a href=\"https://doc.rust-lang.org/std/thread/struct.Thread.html#method.id\" rel=\"nofollow noreferrer\">documentation</a>, <code>thread::id()</code> does not work for this purpose. I found <a href=\"https://stackoverflow.com/questions/47075469/get-the-current-thread-id-and-process-id-as-integers\">Get the current thread id and process id as integers?</a> that seemed like the answer, but my experiments show it doesn't work.</p>\n\n<p>This is the code:</p>\n\n<pre><code>extern crate rand;\nextern crate libc;\n\nuse std::thread::{self, Builder};\nuse std::process::{self, Command};\nuse rand::thread_rng;\nuse rand::RngCore;\nuse std::time::Duration;\nuse std::os::unix::thread::JoinHandleExt;\nuse libc::pthread_t;\n\nfn main() {\n    let main_pid = process::id();\n    println!(\"This PID {}\", main_pid);\n\n    let b = Builder::new().name(String::from(\"LongRunningThread\")).spawn(move || {\n        let mut rng = thread_rng();\n        let spawned_pid = process::id();\n        println!(\"Spawned PID {}\", spawned_pid);\n        loop {\n            let u = rng.next_u64() % 1000;\n            println!(\"Processing request {}\", u);\n            thread::sleep(Duration::from_millis(u));\n        }\n\n    }).expect(\"Could not spawn worker thread\");\n\n    let p_threadid : pthread_t = b.as_pthread_t();\n    println!(\"Spawned p_threadid {}\", p_threadid);\n    let thread_id = b.thread().id();\n    println!(\"Spawned thread_id {:?}\", thread_id);\n\n    thread::sleep(Duration::from_millis(60_000));\n}\n</code></pre>\n\n<p>The output from running the program inside a Linux machine is the following:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>This PID 8597\nSpawned p_threadid 139858455706368. &lt;-- Clearly wrong\nSpawned thread_id ThreadId(1) &lt;-- Clearly wrong\nSpawned PID 8597\nProcessing request 289\nProcessing request 476\nProcessing request 361\nProcessing request 567\n</code></pre>\n\n<p>The following is an excerpt from the output of htop in my system:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code> 6164  1026 root       20   0   98M  7512  6512 S  0.0  0.0  0:00.03 \u2502  \u251c\u2500 sshd: dash [priv]\n 6195  6164 dash       20   0   98M  4176  3176 S  0.0  0.0  0:00.20 \u2502  \u2502  \u2514\u2500 sshd: dash@pts/11\n 6196  6195 dash       20   0 22964  5648  3408 S  0.0  0.0  0:00.09 \u2502  \u2502     \u2514\u2500 -bash\n 8597  6196 dash       20   0  2544     4     0 S  0.0  0.0  0:00.00 \u2502  \u2502        \u2514\u2500 ./process_priorities\n 8598  6196 dash       20   0  2544     4     0 S  0.0  0.0  0:00.00 \u2502  \u2502           \u2514\u2500 LongRunningThre\n</code></pre>\n\n<p>The PID I want from the spawned thread is 8598, but I can't figure out how to obtain it in a Rust program. Any ideas?</p>\n"}, {"tags": ["rust", "lifetime"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558448077, "post_id": 56238529, "comment_id": 99099245, "body": "It looks like your question might be answered by the answers of <a href=\"https://stackoverflow.com/a/44987645/155423\">How do I add references to a container when the borrowed values are created after the container?</a>; specifically the part about <code>may_dangle</code>. If not, please <b><a href=\"https://stackoverflow.com/posts/56238529/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558451426, "post_id": 56240642, "comment_id": 99101476, "body": "Additional questions have also been asked about lifetime variance: <a href=\"https://stackoverflow.com/q/55200843/155423\">Covariance of Box type in Rust</a>; <a href=\"https://stackoverflow.com/q/55344893/155423\">What is an example of contravariant use in Rust?</a>"}, {"owner": {"reputation": 95, "user_id": 9112890, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-fj7nqZ-TLFI/AAAAAAAAAAI/AAAAAAAACHQ/DsQ0zlISkcg/photo.jpg?sz=128", "display_name": "SRU", "link": "https://stackoverflow.com/users/9112890/sru"}, "edited": false, "score": 0, "creation_date": 1558458214, "post_id": 56240642, "comment_id": 99105070, "body": "Thank you very much! That&#39;s exactly what I was looking for:   * <a href=\"https://github.com/bluss/arrayvec/issues/96\" rel=\"nofollow noreferrer\">github.com/bluss/arrayvec/issues/96</a>  * <a href=\"https://doc.rust-lang.org/nomicon/subtyping.html#variance\" rel=\"nofollow noreferrer\">doc.rust-lang.org/nomicon/subtyping.html#variance</a>  Unfortunately it seems that I have to get rid of SmallVec in my project (until it&#39;s covariant like Vec): The type <code>ItemTraitReturns</code> in my project is a lot more complex and this invariance inherits tru the entire hierarchy."}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 4, "last_activity_date": 1558451205, "last_edit_date": 1558451205, "creation_date": 1558449284, "answer_id": 56240642, "question_id": 56238529, "link": "https://stackoverflow.com/questions/56238529/why-does-smallvec-have-different-behaviour-when-storing-types-with-lifetimes-com/56240642#56240642", "title": "Why does SmallVec have different behaviour when storing types with lifetimes compared to Vec?", "body": "<p>This difference appears to be caused by a difference in <em>variance</em> between <code>Vec</code> and <code>SmallVec</code>.  While <code>Vec&lt;T&gt;</code> is <em>covariant</em> in <code>T</code>, <code>SmallVec</code> appears to be <em>invariant</em>. As a result, <code>SmallVec&lt;[&amp;'a T; 1]&gt;</code> can't be converted to <code>SmallVec&lt;[&amp;'b T; 1]&gt;</code> even when lifetime <code>'a</code> outlives <code>'b</code> and the conversion should be safe. Here is a minimal example triggering the compiler error:</p>\n\n<pre><code>fn foo&lt;'a, T&gt;(x: SmallVec&lt;[&amp;'static T; 1]&gt;) -&gt; SmallVec&lt;[&amp;'a T; 1]&gt; {\n    x  // Compiler error here: lifetime mismatch\n}\n\nfn bar&lt;'a, T&gt;(x: Vec&lt;&amp;'static T&gt;) -&gt; Vec&lt;&amp;'a T&gt; {\n    x  // Compiles fine\n}\n</code></pre>\n\n<p>This appears to be a shortcoming of <code>SmallVec</code>. Variance is automatically determined by the compiler, and it is sometimes cumbersome to convince the compiler that it is safe to assume that a type is covariant.</p>\n\n<p>There is an <a href=\"https://github.com/servo/rust-smallvec/issues/146\" rel=\"nofollow noreferrer\">open Github issue for this problem</a>.</p>\n\n<p>Unfortunately, I don't know a way of figuring out the variance of a type based on its public interface. Variance is not included in the documentation, and depends on the private implementation details of a type. You can read more on variance <a href=\"https://doc.rust-lang.org/reference/subtyping.html\" rel=\"nofollow noreferrer\">in the language reference</a> or <a href=\"https://doc.rust-lang.org/nomicon/subtyping.html\" rel=\"nofollow noreferrer\">in the Nomicon</a>.</p>\n"}], "owner": {"reputation": 95, "user_id": 9112890, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-fj7nqZ-TLFI/AAAAAAAAAAI/AAAAAAAACHQ/DsQ0zlISkcg/photo.jpg?sz=128", "display_name": "SRU", "link": "https://stackoverflow.com/users/9112890/sru"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 163, "favorite_count": 0, "accepted_answer_id": 56240642, "answer_count": 1, "score": 4, "last_activity_date": 1558451205, "creation_date": 1558442437, "last_edit_date": 1558449770, "question_id": 56238529, "link": "https://stackoverflow.com/questions/56238529/why-does-smallvec-have-different-behaviour-when-storing-types-with-lifetimes-com", "title": "Why does SmallVec have different behaviour when storing types with lifetimes compared to Vec?", "body": "<p>I've got three examples, one using <code>Vec</code> one using <code>SmallVec</code>, and one with my own implementation of <code>SmallVec</code>. The ones using <code>Vec</code> and my own <code>SmallVec</code> compile but the one using the real <code>SmallVec</code> does not.</p>\n\n<h3>Working example using <code>Vec</code></h3>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::borrow::Cow;\nuse std::collections::HashMap;\n\npub trait MyTrait {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns;\n}\n\n/// IMPORTANT PART IS HERE: `Vec&lt;Cow&lt;'a, str&gt;&gt;`\npub struct ItemTraitReturns&lt;'a&gt;(Vec&lt;Cow&lt;'a, str&gt;&gt;);\n\n/// this implementation only takes items with static lifetime (but other implementations also might have different lifetimes)\npub struct MyTraitStruct {\n    map: HashMap&lt;usize, ItemTraitReturns&lt;'static&gt;&gt;,\n}\n\nimpl MyTrait for MyTraitStruct {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns {\n        let temp: &amp;ItemTraitReturns&lt;'static&gt; = self.map.get(&amp;id).unwrap();\n        // Works as expected: I expect that I can return `&amp;ItemTraitReturns&lt;'_&gt;`\n        // when I have `&amp;ItemTraitReturns&lt;'static&gt;` (since 'static outlives everything).\n        temp\n        // Will return `&amp;ItemTraitReturns&lt;'_&gt;`\n    }\n}\n</code></pre>\n\n<h3>Failing example with SmallVec</h3>\n\n<p>Uses <code>SmallVec</code> instead of <code>Vec</code> with no other changes.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use smallvec::SmallVec;\nuse std::borrow::Cow;\nuse std::collections::HashMap;\n\npub trait MyTrait {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns;\n}\n\n/// IMPORTANT PART IS HERE: Uses SmallVec instead of Vec\npub struct ItemTraitReturns&lt;'a&gt;(SmallVec&lt;[Cow&lt;'a, str&gt;; 2]&gt;);\n\n/// this implementation only takes items with static lifetime (but other implementations also might have different lifetimes)\npub struct MyTraitStruct {\n    map: HashMap&lt;usize, ItemTraitReturns&lt;'static&gt;&gt;,\n}\n\nimpl MyTrait for MyTraitStruct {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns {\n        let temp: &amp;ItemTraitReturns&lt;'static&gt; = self.map.get(&amp;id).unwrap();\n        temp\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/lib.rs:23:9\n   |\n23 |         temp\n   |         ^^^^ lifetime mismatch\n   |\n   = note: expected type `&amp;ItemTraitReturns&lt;'_&gt;`\n              found type `&amp;ItemTraitReturns&lt;'static&gt;`\nnote: the anonymous lifetime #1 defined on the method body at 18:5...\n  --&gt; src/lib.rs:18:5\n   |\n18 | /     fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns {\n19 | |         let temp: &amp;ItemTraitReturns&lt;'static&gt; = self.map.get(&amp;id).unwrap();\n20 | |         // Error:\n21 | |         //    = note: expected type `&amp;demo2::ItemTraitReturns&lt;'_&gt;`\n22 | |         //              found type `&amp;demo2::ItemTraitReturns&lt;'static&gt;`\n23 | |         temp\n24 | |     }\n   | |_____^\n   = note: ...does not necessarily outlive the static lifetime\n</code></pre>\n\n<h3>Working example with my own <code>SmallVec</code></h3>\n\n<p>When I implement my own (very naive) <code>SmallVec&lt;[T; 2]&gt;</code> (called <code>NaiveSmallVec2&lt;T&gt;</code>) the code also compiles... Very strange!</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::borrow::Cow;\nuse std::collections::HashMap;\n\n/// This is a very naive implementation of a SmallVec&lt;[T; 2]&gt;\npub struct NaiveSmallVec2&lt;T&gt; {\n    item1: Option&lt;T&gt;,\n    item2: Option&lt;T&gt;,\n    more: Vec&lt;T&gt;,\n}\n\nimpl&lt;T&gt; NaiveSmallVec2&lt;T&gt; {\n    pub fn push(&amp;mut self, item: T) {\n        if self.item1.is_none() {\n            self.item1 = Some(item);\n        } else if self.item2.is_none() {\n            self.item2 = Some(item);\n        } else {\n            self.more.push(item);\n        }\n    }\n\n    pub fn element_by_index(&amp;self, index: usize) -&gt; Option&lt;&amp;T&gt; {\n        match index {\n            0 =&gt; self.item1.as_ref(),\n            1 =&gt; self.item2.as_ref(),\n            _ =&gt; self.more.get(index - 2),\n        }\n    }\n}\n\npub trait MyTrait {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns;\n}\n\n/// IMPORTANT PART IS HERE: Uses NaiveSmallVec2\npub struct ItemTraitReturns&lt;'a&gt;(NaiveSmallVec2&lt;Cow&lt;'a, str&gt;&gt;);\n\n/// only takes items with static lifetime\npub struct MyTraitStruct {\n    map: HashMap&lt;usize, ItemTraitReturns&lt;'static&gt;&gt;,\n}\n\nimpl MyTrait for MyTraitStruct {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns {\n        let temp: &amp;ItemTraitReturns&lt;'static&gt; = self.map.get(&amp;id).unwrap();\n        // astonishingly this works!\n        temp\n    }\n}\n</code></pre>\n\n<hr>\n\n<p>I expect the <code>SmallVec</code> version to compile like the <code>Vec</code> version does. I don't understand why in some cases (in the case of <code>Vec</code>) <code>&amp;ItemTraitReturns&lt;'static&gt;</code> can be converted to <code>&amp;ItemTraitReturns&lt;'_&gt;</code> and in some cases (<code>SmallVec</code>) it's not possible (I don't see the influence of <code>Vec</code> / <code>SmallVec</code>). </p>\n\n<p>I don't want to change lifetimes of this trait:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait MyTrait {\n    fn get_by_id(&amp;self, id: usize) -&gt; &amp;ItemTraitReturns;\n}\n</code></pre>\n\n<p>... since when using the trait I don't care about lifetimes (this should be an implementation detail) ... but still would like to use <code>SmallVec</code>.</p>\n"}, {"tags": ["hash", "rust", "substrate"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 4, "creation_date": 1558437522, "post_id": 56237091, "comment_id": 99092871, "body": "This is the fourth question you are asking in roughly 4 hours. Although we are glad to help here on SO, I think (this is my personal opinion), that you should deal with the topic a little bit more instead of asking a question after another. It seems, that you haven&#39;t understand the topic as such (at least to <i>me</i>). Please correct me if I&#39;m wrong."}, {"owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558438612, "post_id": 56237091, "comment_id": 99093486, "body": "Thanks. I&#39;ve revisited the question and tailored it to just focus on a single question, as one of the questions applied to multiple storage types"}, {"owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558502513, "post_id": 56237091, "comment_id": 99117052, "body": "I&#39;ve also now removed what was meant to serve as a helpful background context (even for my future self), which is my usual practice, and any &quot;brand&quot;-related words, since some users considered it spam/promotion. Sorry, I didn&#39;t realise it would be perceived this way."}], "answers": [{"tags": [], "owner": {"reputation": 42460, "user_id": 642626, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/fedc5e6b7fef29a8b539e20da8c85971?s=128&d=identicon&r=PG", "display_name": "Bryan Chen", "link": "https://stackoverflow.com/users/642626/bryan-chen"}, "is_accepted": false, "score": 2, "last_activity_date": 1559537327, "last_edit_date": 1559537327, "creation_date": 1559009025, "answer_id": 56334175, "question_id": 56237091, "link": "https://stackoverflow.com/questions/56237091/why-cant-blake2-256-prevent-the-first-key-pair-in-a-storagedoublemap-from-b/56334175#56334175", "title": "Why can&#39;t `blake2_256` prevent the &quot;first key pair&quot; in a StorageDoubleMap from being compromised when using decl_storage?", "body": "<p>Let's say the hash of <code>module1.someValue</code> is <code>0x12345678</code></p>\n\n<p>hash of <code>module2.doubleMapValue.firstKey(value1)</code> is <code>0x1234</code></p>\n\n<p>hash of <code>module2.doubleMapValue.secondKey(value2)</code> is <code>0x5678</code></p>\n\n<p>This means <code>module2.doubleMapValue.fullKey(value1, value2)</code> and <code>module1.someValue</code> have same hash. i.e. the values are stored in the same place.</p>\n\n<p>If a user is able to control both keys of <code>module2.doubleMapValue</code> and figure out the value of <code>value1</code> and <code>value2</code>, then they will be able to override the value of <code>module1.someValue</code> and cause security issues.</p>\n\n<p>That's why the hash function of key1 of double map needs to be a cryptographic hasher if the value is controlled by a user. Otherwise a user may be able to craft <code>value1</code> such it collides with the storage of all other modules, and hence compromise them.</p>\n\n<p>In case a user does not control key2, double map provides a clear all keys with hash(key1) prefix feature that could be hijacked to cause troubles as well.</p>\n"}], "owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 98, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1559537327, "creation_date": 1558437337, "last_edit_date": 1559536644, "question_id": 56237091, "link": "https://stackoverflow.com/questions/56237091/why-cant-blake2-256-prevent-the-first-key-pair-in-a-storagedoublemap-from-b", "title": "Why can&#39;t `blake2_256` prevent the &quot;first key pair&quot; in a StorageDoubleMap from being compromised when using decl_storage?", "body": "<p><a href=\"https://crates.parity.io/srml_support_procedural/macro.decl_storage.html\" rel=\"nofollow noreferrer\"><code>decl_storage!</code></a> is a \"procedural macro\" used for storing data to make it available in subsequent blocks.</p>\n\n<p>It says if the user is able to set the <strong>first key pair</strong> in the <code>double_map</code>, then we cannot trust that key pair, and so we must use a cryptographic hasher such as <code>blake2_256</code> to prevent \"other values of all storage items being compromised\".</p>\n\n<p>Then it goes on to say that if the user is able to set the <strong>second key pair</strong> in the <code>double_map</code>, then we cannot trust that key pair, and so we must use a cryptographic hasher such as <code>blake2_256</code> to prevent \"other items in storage with the same first key being compromised\".</p>\n\n<p>With regard to the <strong>first key pair</strong>, why does it say that it's just to prevent <strong>\"other values of all storage items being compromised\"</strong>? Isn't <code>blake2_256</code> also used to prevent the first key pair <em>itself</em> from being compromised (rather than just \"other values\")?</p>\n"}, {"tags": ["generics", "rust", "segmentation-fault", "queue", "unsafe"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558438161, "post_id": 56236962, "comment_id": 99093229, "body": "I think this is a duplicate of <a href=\"https://stackoverflow.com/questions/31360993\">stackoverflow.com/questions/31360993</a> or <a href=\"https://stackoverflow.com/questions/55741517\">stackoverflow.com/questions/55741517</a>. TL;DR - you are dropping values which hasn&#39;t been initialized. You are setting the length to a number, but the values in that range are uninitialzed memory."}, {"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558438735, "post_id": 56236962, "comment_id": 99093553, "body": "no, I don&#39;t think there is any problem with calling drop on uninitialized memory here. As far as I can see, problem emerges in the <code>add</code> method when assigning value to the uninitialized memory"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558439225, "post_id": 56236962, "comment_id": 99093838, "body": "That&#39;s the problem with this unsafe code. You are dropping the element when you assign the new values to the index. If you do <code>buff.resize_with(size, T::default);</code> instead of <code>set_len</code> it won&#39;t crash anymore <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ae87d9ffce5c41e4a0f2f02d0bf93b09\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558439434, "post_id": 56236962, "comment_id": 99093975, "body": "thanks, but if previous value is getting dropped when assigning new value, how come it works for <code>test0</code> where there is also a heap allocated object (string)?  I understand I can use default values, I was specifically trying to avoid it"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1558439593, "post_id": 56236962, "comment_id": 99094071, "body": "Pure luck. As said, you are accessing uninitialized memory which is undefined behavior. Don&#39;t do it ;) You could use <code>mem::forget</code> to not call the destructor of the element you are trying to swap. All in all, don&#39;t do it. The initialization is a one-time-cost, which is not the costly thing. You are defeating the safe purpose of Rust for nothing IMHO."}, {"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558439967, "post_id": 56236962, "comment_id": 99094292, "body": "it&#39;s not a production implementation :), I was doing this to get a better grasp of rust. I understand the issue now as you explained. I believe I&#39;ve fixed it, I&#39;ve edited the question. I am still a little interested why this doesn&#39;t happen with the string. Maybe rusts uses small-string-optimization and creates a stack allocated string?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1558440124, "post_id": 56236962, "comment_id": 99094377, "body": "It doesn&#39;t happen with the <code>String</code> because this is Undefined Behaviour. You can&#39;t predict what will happen or when. It could break on a different operating system or different CPU architecture or in a future Rust compiler."}], "answers": [{"comments": [{"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "edited": false, "score": 0, "creation_date": 1558507878, "post_id": 56239983, "comment_id": 99119175, "body": "thanks, I didn&#39;t realize there is a move of old value involved when assigning new value to a pointer. It all makes sense and, as I said in the edit section of my question, by running <code>unsafe {std::ptr::write(self.buff.get_unchecked_mut(idx), elem)};</code> old value is not moved and consequently it isn&#39;t dropped and everything works"}], "tags": [], "owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "is_accepted": true, "score": 2, "last_activity_date": 1558447317, "last_edit_date": 1558447317, "creation_date": 1558447143, "answer_id": 56239983, "question_id": 56236962, "link": "https://stackoverflow.com/questions/56236962/unsafe-queue-implementation/56239983#56239983", "title": "Unsafe queue implementation", "body": "<p>When you run <code>*unsafe { self.buff.get_unchecked_mut(idx) } = elem;</code> to replace an uninitialized <code>Box</code> or <code>String</code>, it will run <code>drop</code> on this uninitialized <code>Box</code> or <code>String</code>. <code>Box</code> and <code>String</code> both contain a pointer to the part of the heap where their data is supposed to be stored, and when they are dropped, it will deallocate the memory at this location. </p>\n\n<p>By dropping an uninitialized <code>Box</code> or <code>String</code>, it will be deallocating memory at an arbitrary location as the uninitialized pointer could be anything. It is undefined behavior to deallocate memory which has not been allocated.</p>\n"}], "owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 76, "favorite_count": 0, "accepted_answer_id": 56239983, "answer_count": 1, "score": 0, "last_activity_date": 1558447317, "creation_date": 1558436848, "last_edit_date": 1558439232, "question_id": 56236962, "link": "https://stackoverflow.com/questions/56236962/unsafe-queue-implementation", "title": "Unsafe queue implementation", "body": "<p>I try to create an unsafe, but more performant <code>ArrayQueue</code> implementation. After I added test cases, one of them produces a segmentation fault.\nHere is my simple minimal implementation:</p>\n\n<pre><code>use std::mem;\n\npub struct ArrayQueue&lt;T&gt; {\n    buff: Vec&lt;T&gt;,\n    head: usize,\n    size: usize,\n}\n\nimpl&lt;T&gt; ArrayQueue&lt;T&gt; {\n    pub fn new(size: usize) -&gt; Self {\n        let mut buff = Vec::with_capacity(size);\n\n        unsafe {\n            buff.set_len(size);\n        }\n\n        ArrayQueue {\n            buff: buff,\n            head: 0,\n            size: 0,\n        }\n    }\n\n    pub fn add(&amp;mut self, elem: T) {\n        let idx = (self.head + self.size) % self.buff.len();\n        *unsafe { self.buff.get_unchecked_mut(idx) } = elem;\n        self.size += 1;\n    }\n\n    pub fn remove(&amp;mut self) -&gt; T {\n        let idx = self.head;\n\n        self.size -= 1;\n        self.head = (self.head + 1) % self.buff.len();\n        mem::replace(unsafe { self.buff.get_unchecked_mut(idx) }, unsafe {\n            mem::uninitialized()\n        })\n    }\n}\n\nimpl&lt;T&gt; Drop for ArrayQueue&lt;T&gt; {\n    fn drop(&amp;mut self) {\n        let mut idx = self.head;\n\n        for _ in 0..self.size {\n            // Drop only valid elements of the queue\n            drop(unsafe { self.buff.get_unchecked_mut(idx) });\n            idx = (idx + 1) % self.buff.len();\n        }\n\n        unsafe {\n            // Prevent deallocation of vector elements\n            // This still dallocates vector's internal buffer\n            self.buff.set_len(0);\n        }\n    }\n}\n\n#[cfg(test)]\nmod test {\n    use super::ArrayQueue;\n\n    #[test]\n    fn test0() {\n        let mut x = ArrayQueue::new(10);\n        x.add(String::from(\"K\"));\n        assert_eq!(x.remove(), String::from(\"K\"));\n    }\n\n    #[test]\n    fn test1() {\n        let mut x: ArrayQueue&lt;Box&lt;String&gt;&gt; = ArrayQueue::new(10);\n        x.add(Box::new(String::from(\"K\")));\n        assert_eq!(x.remove(), Box::new(String::from(\"K\")));\n    }\n}\n</code></pre>\n\n<p>I believe I am doing proper dropping to prevent any memory leaks.</p>\n\n<p>I've attached two test cases where one works, but the other results in a crash due to invalid memory reference.</p>\n\n<p>It crashes inside the <code>add</code> method (<code>*unsafe {self.buff.get_unchecked_mut(idx)} = elem;</code>) and I suspect that happens because I am somehow trying to write to an invalid memory location.<br>\nI've specifically used heap allocated objects for vector elements in test but to my surprise <code>String</code> works properly while <code>Box</code> doesn't.</p>\n\n<p>I would like to understand if it's possible to make an unsafe implementation like this and why it's currently failing?</p>\n\n<p><strong>Edit</strong></p>\n\n<hr>\n\n<p>I've fixed the issue by replacing <code>*unsafe {self.buff.get_unchecked_mut(idx)} = elem;</code> with <code>unsafe {std::ptr::write(self.buff.get_unchecked_mut(idx), elem)};</code></p>\n\n<p>Now I would like to understand why this works and previous version doesn't</p>\n"}, {"tags": ["hash", "rust", "substrate"], "answers": [{"tags": [], "owner": {"reputation": 396, "user_id": 6597519, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qDT9g.jpg?s=128&g=1", "display_name": "apopiak", "link": "https://stackoverflow.com/users/6597519/apopiak"}, "is_accepted": true, "score": 5, "last_activity_date": 1597832111, "creation_date": 1597832111, "answer_id": 63484815, "question_id": 56236827, "link": "https://stackoverflow.com/questions/56236827/why-use-a-hashing-algorithm-other-than-blake2-256-in-a-storagemap-when-using-dec/63484815#63484815", "title": "Why use a hashing algorithm other than blake2_256 in a StorageMap when using decl_storage", "body": "<p>The <code>blake2_256</code> hasher is an opaque cryptographic hasher which incurs two costs/has two disadvantages:</p>\n<ul>\n<li>computationally expensive</li>\n<li>does not allow iterating through storage</li>\n</ul>\n<p>Thus there are alternative hashers that improve on these for situations where you care about them:</p>\n<ul>\n<li>The <code>twox</code> hasher is cheap to compute, so you can use it if the blockchain controls the input to the <code>StorageMap</code>, e.g. when using a counter to index into it.</li>\n<li>The <code>blake2_128_concat</code> hasher concatenates the input to the hasher onto the end of the hash to allow iterating over the keys (and values) of the map.</li>\n</ul>\n<p>Find more information in the updated <a href=\"https://crates.parity.io/frame_support/macro.decl_storage.html\" rel=\"noreferrer\">documentation for <code>decl_storage</code></a></p>\n"}], "owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 126, "favorite_count": 0, "accepted_answer_id": 63484815, "answer_count": 1, "score": 2, "last_activity_date": 1597832111, "creation_date": 1558436329, "last_edit_date": 1558501896, "question_id": 56236827, "link": "https://stackoverflow.com/questions/56236827/why-use-a-hashing-algorithm-other-than-blake2-256-in-a-storagemap-when-using-dec", "title": "Why use a hashing algorithm other than blake2_256 in a StorageMap when using decl_storage", "body": "<p>It says <a href=\"https://crates.parity.io/srml_support_procedural/macro.decl_storage.html\" rel=\"nofollow noreferrer\"><code>decl_storage!</code></a> is a \"procedural macro\" used for storing data to make it available in subsequent blocks.</p>\n\n<p>It says that if the user is able to set the key pair, then we cannot trust the key pair, and so we must use a cryptographic hasher such as blake2_256 to prevent \"other values in storage being compromised\".</p>\n\n<p>Why would you use a hashing algorithm (<code>$hash</code>) other than the default <code>blake2_256</code> in a <a href=\"https://crates.parity.io/srml_support/storage/trait.StorageMap.html\" rel=\"nofollow noreferrer\"><code>StorageMap</code></a> (i.e. why would anyone use <a href=\"https://crates.parity.io/srml_support/trait.Hashable.html\" rel=\"nofollow noreferrer\"><code>twox</code></a> instead of the default <code>blake2_256</code>)?</p>\n\n<p>Also, why does it say that its just to prevent \"other values in storage being compromised\"? Isn't <code>blake2_256</code> also used to prevent the key pair itself from being compromised?</p>\n"}, {"tags": ["rust", "rustdoc"], "owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 63, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1558502908, "creation_date": 1558434528, "last_edit_date": 1558502908, "question_id": 56236315, "link": "https://stackoverflow.com/questions/56236315/what-is-the-standard-for-showing-tooltip-warnings-in-rustdocs", "title": "What is the standard for showing tooltip warnings in rustdocs?", "body": "<p>In <a href=\"https://crates.parity.io/srml_support_procedural/macro.decl_storage.html\" rel=\"nofollow noreferrer\"><code>decl_storage!</code></a>, it appears that the syntax used for tooltip warnings appears to be <code>/!\\</code> (i.e. <code>/!\\ Be careful ...</code>). If it's a tooltip warning it may be preferable to show it in bold or italic text by using HTML syntax (i.e. using HTML such as <code>&lt;b&gt;&lt;/b&gt;</code>). What is the standard for showing tooltip warnings in rustdocs?</p>\n"}, {"tags": ["rust", "substrate"], "answers": [{"tags": [], "owner": {"reputation": 176, "user_id": 8058332, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e4be7b7419bbe35d91dd57972cde6e28?s=128&d=identicon&r=PG&f=1", "display_name": "thiolliere", "link": "https://stackoverflow.com/users/8058332/thiolliere"}, "is_accepted": true, "score": 2, "last_activity_date": 1558433169, "creation_date": 1558433169, "answer_id": 56235917, "question_id": 56233031, "link": "https://stackoverflow.com/questions/56233031/what-is-an-example-of-a-storage-name-in-decl-storage/56235917#56235917", "title": "What is an example of a `storage_name` in decl_storage", "body": "<p>Yes <code>Foo</code> is an example of a storage name that can be used in decl_storage!.</p>\n\n<p>All rust ident should be usable as a storage name in decl_storage I think.</p>\n\n<p>(Indeed the documentation is mixing example and definition, sometimes using <code>u32</code> sometimes <code>type</code> for example)</p>\n"}], "owner": {"reputation": 3360, "user_id": 3208553, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/Tjyir.png?s=128&g=1", "display_name": "Luke Schoen", "link": "https://stackoverflow.com/users/3208553/luke-schoen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 86, "favorite_count": 0, "accepted_answer_id": 56235917, "answer_count": 1, "score": 1, "last_activity_date": 1558501707, "creation_date": 1558422988, "last_edit_date": 1558501707, "question_id": 56233031, "link": "https://stackoverflow.com/questions/56233031/what-is-an-example-of-a-storage-name-in-decl-storage", "title": "What is an example of a `storage_name` in decl_storage", "body": "<p>It says that <a href=\"https://crates.parity.io/srml_support_procedural/macro.decl_storage.html\" rel=\"nofollow noreferrer\"><code>decl_storage!</code></a> is a \"procedural macro\" used for storing data to make it available in subsequent blocks.</p>\n\n<p>At that link there's a sentence that says <em>Basic storage consists of a <strong>name</strong> and a type</em>. It then shows the different supported types, including the most basic supported type, which just contains a \"Value\" that appears to correspond to the <strong>\"storage name\"</strong> of <code>Foo</code>. This <a href=\"https://github.com/paritytech/substrate/blob/master/srml/example/src/lib.rs#L271\" rel=\"nofollow noreferrer\">line of the \"Example\" module of the SRML</a> also matches this pattern.</p>\n\n<p>It then shows how the hashing algorithms are used to hash a combination of values, including the <code>storage_name</code>. The <code>storage_name</code> that's shown appears to correspond to a <strong>\"storage name\"</strong> such a <code>Foo</code> that was shown earlier on that page.</p>\n\n<p>Then there's a sentence that says <em>Basic storage can be extended as such:</em>, it shows a pattern <code>... #name ...</code>, and describes it as <code>#name: Name of the storage item, used as a prefix in storage.</code>, which appears to correspond to a <strong>\"storage name\"</strong> such as <code>Foo</code> that was shown earlier on the page, and both <code>#name</code> and <code>#type</code> are not labelled as <code>[optional]</code> because they are not \"extensions\" to basic storage, that are fundamental to basic storage</p>\n\n<p>Is <code>Foo</code> supposed to be an example of a <code>storage_name</code> that may be used with decl_storage!?</p>\n"}, {"tags": ["rust", "borrow-checker", "mutability"], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 3, "last_activity_date": 1558430817, "last_edit_date": 1558430817, "creation_date": 1558430396, "answer_id": 56235108, "question_id": 56232556, "link": "https://stackoverflow.com/questions/56232556/immutable-borrow-tied-to-mutable-borrow-causes-cannot-borrow-self-as-mutable/56235108#56235108", "title": "Immutable borrow tied to mutable borrow causes &quot;cannot borrow `*self` as mutable more than once at a time&quot;", "body": "<p>Rust is protecting you from a potentially dangerous situation. There is nothing in <code>recalculate</code>'s signature to guarantee that it won't mutate <code>sheet</code> in such at way that the references in <code>cells</code> become invalid. For example <code>recalculate</code> <em>could</em> delete some cells and then the references in <code>cell.parents</code> would be dangling pointers.</p>\n\n<p>You probably need to pass a clone of the parent cells instead:</p>\n\n<pre><code>if let Some(cell) = updated_cell {\n    let parents = cell.parents.clone();\n    recalculate(self, &amp;parents);\n}\n</code></pre>\n\n<p>Alternatively, you may need to consider a different data model, which separates the mutability of individual cells from the mutability of the overall structure. For example, you could wrap cells in a <code>std::cell::Cell</code> or <code>std::cell::RefCell</code>, and pass an immutable reference to the <code>Sheet</code>.</p>\n"}], "owner": {"reputation": 405, "user_id": 7080683, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-vHnjck4jA_4/AAAAAAAAAAI/AAAAAAAAACE/wU6N3qQY4hM/photo.jpg?sz=128", "display_name": "Arne J", "link": "https://stackoverflow.com/users/7080683/arne-j"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 868, "favorite_count": 0, "closed_date": 1558485828, "accepted_answer_id": 56235108, "answer_count": 1, "score": 9, "last_activity_date": 1558485916, "creation_date": 1558421223, "last_edit_date": 1558485719, "question_id": 56232556, "link": "https://stackoverflow.com/questions/56232556/immutable-borrow-tied-to-mutable-borrow-causes-cannot-borrow-self-as-mutable", "closed_reason": "Duplicate", "title": "Immutable borrow tied to mutable borrow causes &quot;cannot borrow `*self` as mutable more than once at a time&quot;", "body": "<p>I am learning Rust by exercise. In this file the goal is to update cells as in a spreadsheet: when a value changes, all cells that are derived from it have to be recalculated. Here, those are called that cell's parents.</p>\n\n<p>Updating a cell value proves no problem, but updating the parents gets me fighting the borrow checker. When I have retrieved the cell from a <code>HashMap</code> and updated the value, I no longer need a mutable reference - so I tried wrapping it in an immutable reference instead. That way I only have to find it once.</p>\n\n<p>But it seems Rust figures since I originally got my immutable reference from a borrowed <code>&amp;mut self</code>, it must still be tied to it. This obviously prevents me from reusing <code>self</code> a second time.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::collections::HashMap;\nuse std::vec::Vec;\n\nstruct Cell {\n    value: i32,\n    parents: Vec&lt;u32&gt;,\n}\n\npub struct Sheet {\n    table: HashMap&lt;u32, Cell&gt;,\n}\n\nimpl Sheet {\n    pub fn set_value(&amp;mut self, identifier: u32, new_value: i32) {\n        let mut updated_cell: Option&lt;&amp;Cell&gt; = None;\n        if let Some(cell) = self.table.get_mut(&amp;identifier) {\n            let Cell { value, .. } = cell;\n            *value = new_value;\n            updated_cell = Some(cell);\n        }\n        if let Some(cell) = updated_cell {\n            recalculate(self, &amp;cell.parents);\n        }\n    }\n}\n\nfn recalculate(_sheet: &amp;mut Sheet, _cells: &amp;[u32]) {}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0499]: cannot borrow `*self` as mutable more than once at a time\n  --&gt; src/lib.rs:20:16\n   |\n16 |         if let Some(cell) = self.table.get_mut(&amp;identifier) {\n   |                             ---------- first mutable borrow occurs here\n...\n22 |             recalculate(self, &amp;cell.parents);\n   |                         ^^^^  ------------- first borrow later used here\n   |                         |\n   |                         second mutable borrow occurs here\n</code></pre>\n\n<p>I want to know if there is a solution which avoids searching a second time or taking an unnecessary vector copy. I have tried to adjust the code many times, but not all of the syntax is yet clear to me yet.</p>\n"}, {"tags": ["rust", "rust-cargo", "rust-proc-macros"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1558450565, "post_id": 56231963, "comment_id": 99100935, "body": "For what it&#39;s worth, you can write a build script that makes the values of the environment variables available during compilation, either with <code>rustc-env=VAR=VALUE</code> or with <code>rustc-cfg=FEATURE</code>. See the <a href=\"https://doc.rust-lang.org/cargo/reference/build-scripts.html\" rel=\"nofollow noreferrer\">documentation on build scripts</a> for more details."}, {"owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1559284010, "post_id": 56231963, "comment_id": 99378574, "body": "@SvenMarnach Tunneling build script variables by redefining them is something that I had completely overlooked. Thank you for mentioning it. Tunneling env vars solves problem 2 but doesn&#39;t solve problem 1 unfortunately. Since it&#39;s still helpful, please feel free to post it as a partial answer and I&#39;ll gladly upvote it."}, {"owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1559284124, "post_id": 56231963, "comment_id": 99378612, "body": "@SvenMarnach I have another open question where your solution would be an acceptable answer, so please also feel free to post an answer there so I can accept it. See <a href=\"https://stackoverflow.com/questions/56215463/what-is-a-suitable-place-to-store-procedural-macro-artifacts-so-that-they-are-cl\" title=\"what is a suitable place to store procedural macro artifacts so that they are cl\">stackoverflow.com/questions/56215463/&hellip;</a>"}], "owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 75, "favorite_count": 0, "answer_count": 0, "score": 4, "last_activity_date": 1558418513, "creation_date": 1558418513, "question_id": 56231963, "link": "https://stackoverflow.com/questions/56231963/how-can-the-compilation-properties-be-determined-in-a-procedural-macro", "title": "How can the compilation properties be determined in a procedural macro?", "body": "<p>I'm working on a procedural macro that does a lot of work that can slow down compilation considerably. The work done does not effect the semantics of the function; that is, if given the same set of arguments, the returned value is does not change depending on whether the macro is applied.</p>\n\n<p>In an effort to make the edit-comp-test loop quicker, I would like to make the macro a no-op depending on conditions that relate to how the crate is being compiled. I would like to be able to determine two properties in particular:</p>\n\n<ol>\n<li>Why the macro is being executed: Build/Run, Documentation, Testing</li>\n<li>Whether the macro being executed for optimized builds. </li>\n</ol>\n\n<p>Cargo <a href=\"https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-build-scripts\" rel=\"nofollow noreferrer\">exposes</a> the optimization level to build scripts (through environment variables <code>OPT_LEVEL</code> and <code>PROFILE</code>) but does not expose the mode (Build, Documentation, ..). However, none of this information seems to be exposed to procedural macros at all.</p>\n"}, {"tags": ["rust", "rust-actix"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558406389, "post_id": 56229457, "comment_id": 99080473, "body": "I don&#39;t follow the logic behind your question. You have created a generic actor, which means there might be multiple actors with different concrete types (<code>MyActor1&lt;i32&gt;</code> and <code>MyActor1&lt;bool&gt;</code>, for example). If <i>you</i> don&#39;t know which actor you want to reference, how would the code?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558406407, "post_id": 56229457, "comment_id": 99080482, "body": "Are you literally looking for the syntax <code>let addr = MyActor1::&lt;One&gt;::from_registry()</code>?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558406458, "post_id": 56229457, "comment_id": 99080488, "body": "If so, this question will be a duplicate of <a href=\"https://stackoverflow.com/q/41882151/155423\">How do I imply the type of the value when there are no type parameters or ascriptions?</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558406515, "post_id": 56229457, "comment_id": 99080496, "body": "<i>maybe I had some code to initialize <code>MyActor1</code> as <code>MyActor1&lt;Two&gt;</code> at runtime</i> \u2014 that&#39;s not how <b>statically</b> typed languages work."}], "answers": [{"tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 1, "last_activity_date": 1558442444, "creation_date": 1558442444, "answer_id": 56238533, "question_id": 56229457, "link": "https://stackoverflow.com/questions/56229457/how-do-i-determine-the-type-annotation-while-calling-myactorfrom-registry-fr/56238533#56238533", "title": "How do I determine the type annotation while calling MyActor::from_registry() from another actor&#39;s handler that doesn&#39;t define T?", "body": "<p><strong>TL;DR: <code>MyActor1</code> is not a type, it's a blueprint.</strong></p>\n\n<hr>\n\n<p>When you declare <code>struct Foo&lt;T&gt;</code>, <code>Foo</code> is not a type, it's a blueprint for the compiler to create types, or, as computer science would have it, a <strong>type constructor</strong>.</p>\n\n<p>If you have the blueprints for a house, you cannot open the door of the blueprint and go for a nap in the bedroom: there is no bedroom, there is an idea of what the bedroom will look like once the house is built.</p>\n\n<p>The same thing applies here. You cannot use a <em>type constructor</em> where a <em>type</em> is needed.</p>\n\n<hr>\n\n<p>You are left with 3 solutions:</p>\n\n<ul>\n<li>Make <code>MyActor1</code> a type, removing the parameter <code>T</code>; for example, it may store <code>T</code> as a <code>Box&lt;Thing&gt;</code>.</li>\n<li>Make <code>MyActor2</code> a generic, adding the parameter <code>T</code>.</li>\n<li>Implement some run-time discovery, for example using a type-map.</li>\n</ul>\n\n<p>Which is the best solution in your case will vastly depend on your use case, and I am loathe to give any advice based on a reduced example.</p>\n"}], "owner": {"reputation": 71, "user_id": 1296849, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15429ba65d37cb4e2b2b2f8a248e33ee?s=128&d=identicon&r=PG", "display_name": "Greg Melton", "link": "https://stackoverflow.com/users/1296849/greg-melton"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 114, "favorite_count": 0, "accepted_answer_id": 56238533, "answer_count": 1, "score": 1, "last_activity_date": 1558442444, "creation_date": 1558396220, "last_edit_date": 1558406486, "question_id": 56229457, "link": "https://stackoverflow.com/questions/56229457/how-do-i-determine-the-type-annotation-while-calling-myactorfrom-registry-fr", "title": "How do I determine the type annotation while calling MyActor::from_registry() from another actor&#39;s handler that doesn&#39;t define T?", "body": "<p>I have two Actix actors. <code>MyActor1</code> defines a generic trait that one of its fields implements. <code>MyActor2</code> doesn't need to define <code>T</code> and I can't figure out how to call <code>MyActor1::from_registry()</code> from <code>MyActor2</code> message handlers without knowing what type <code>T</code> maps to.</p>\n\n<p>I've tried variations of this:</p>\n\n<pre><code>let addr: Addr&lt;MyActor1&lt;T&gt;&gt; = MyActor1::from_registry();\n</code></pre>\n\n<p>This doesn't work because I don't know where/how to define <code>T</code> unless it's also defined on <code>struct MyActor2&lt;T: Thing&gt;</code> and then added to the <code>impl&lt;T&gt; Handler&lt;Msg&gt; for MyActor2&lt;T&gt; where T:...</code>.</p>\n\n<p>I also tried this but it doesn't work because <code>Thing</code> doesn't implement <code>Default</code> (because it's a trait):</p>\n\n<pre><code>let addr: Addr&lt;MyActor1&lt;Thing&gt;&gt; = MyActor1::from_registry();\n</code></pre>\n\n<p>Here's an example I'm using:</p>\n\n<p><strong>Cargo.toml</strong></p>\n\n<pre><code>[package]\nname = \"actix-example\"\nversion = \"0.1.0\"\nauthors = [\"me\"]\nedition = \"2018\"\n\n[dependencies]\nactix = \"0.8.1\"\n</code></pre>\n\n<p><strong>main.rs</strong></p>\n\n<pre><code>#![allow(dead_code)]\n\nuse actix::prelude::*;\n\ntrait Thing {\n    fn name(&amp;self) {}\n}\n\n#[derive(Default)]\nstruct One;\nimpl Thing for One {}\n\n#[derive(Default)]\nstruct Two;\nimpl Thing for Two {}\n\n// MyActor1\n#[derive(Default)]\nstruct MyActor1&lt;T: Thing&gt; {\n    thing: T,\n}\n\nimpl&lt;T&gt; Actor for MyActor1&lt;T&gt;\nwhere\n    T: Thing + 'static + Default,\n{\n    type Context = Context&lt;Self&gt;;\n}\nimpl&lt;T&gt; Supervised for MyActor1&lt;T&gt; where T: Thing + 'static + Default {}\nimpl&lt;T&gt; SystemService for MyActor1&lt;T&gt; where T: Thing + 'static + Default {}\nimpl&lt;T&gt; Handler&lt;Msg&gt; for MyActor1&lt;T&gt;\nwhere\n    T: Thing + 'static + Default,\n{\n    type Result = ();\n    fn handle(&amp;mut self, _msg: Msg, _ctx: &amp;mut Context&lt;Self&gt;) {}\n}\n\n// MyActor2\n#[derive(Default)]\nstruct MyActor2;\n\n#[derive(Message)]\nstruct Msg;\nimpl Actor for MyActor2 {\n    type Context = Context&lt;Self&gt;;\n}\nimpl Supervised for MyActor2 {}\nimpl SystemService for MyActor2 {}\n\nimpl Handler&lt;Msg&gt; for MyActor2 {\n    type Result = ();\n    fn handle(&amp;mut self, _msg: Msg, _ctx: &amp;mut Context&lt;Self&gt;) {\n        let addr = MyActor1::from_registry();\n    }\n}\n\nfn main() {\n    let sys = System::new(\"test\");\n    let act1 = MyActor1 {\n        thing: One::default(),\n    };\n    let act2 = MyActor2::default();\n    actix::SystemRegistry::set(act1.start());\n    actix::SystemRegistry::set(act2.start());\n    let _ = sys.run();\n}\n</code></pre>\n\n<p>When running the code, I get this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0283]: type annotations required: cannot resolve `_: Thing`\n  --&gt; src/main.rs:50:20\n   |\n50 |         let addr = MyActor1::from_registry();\n   |                    ^^^^^^^^^^^^^^^^^^^^^^^\n   |\nnote: required by `MyActor1`\n  --&gt; src/main.rs:15:1\n   |\n15 | struct MyActor1&lt;T: Thing&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>I know this solves this example:</p>\n\n<pre><code>let addr: Addr&lt;MyActor1&lt;One&gt;&gt; = MyActor1::from_registry();\n</code></pre>\n\n<p>What would I do if I didn't know what <code>MyActor1&lt;T&gt;</code> was at runtime? For example, maybe I had some code to initialize <code>MyActor1</code> as <code>MyActor1&lt;Two&gt;</code> at runtime based on some command line argument.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558398660, "post_id": 56228614, "comment_id": 99079206, "body": "It&#39;s a bit hard to answer your question because it doesn&#39;t include a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. We can&#39;t tell what crates (and their versions), types, traits, fields, etc. are present in the code. It would make it much easier for us to help if you try to reproduce your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> if possible, otherwise in a brand new Cargo project, then <a href=\"https://stackoverflow.com/posts/56228614/edit\">edit</a> your question to include the additional info. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> you can use to reduce your original code for posting here. Thanks!"}], "answers": [{"tags": [], "owner": {"reputation": 29810, "user_id": 423170, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/H9kNQ.png?s=128&g=1", "display_name": "Frxstrem", "link": "https://stackoverflow.com/users/423170/frxstrem"}, "is_accepted": true, "score": 9, "last_activity_date": 1613575734, "last_edit_date": 1613575734, "creation_date": 1558391195, "answer_id": 56228926, "question_id": 56228614, "link": "https://stackoverflow.com/questions/56228614/how-to-change-the-value-of-an-arcu64-in-a-struct/56228926#56228926", "title": "How to change the value of an Arc&lt;u64&gt; in a struct?", "body": "<p><code>Arc</code> only allows you to gain a mutable reference to the contents if you have a mutable reference to the <code>Arc</code> object itself, and the <code>Arc</code> is the <em>only</em> one that points to its contents (all the others having been dropped already).</p>\n<p>What you want here is one of the equivalents of <code>RefCell</code> for thread-safe coding, namely <a href=\"https://doc.rust-lang.org/std/sync/struct.Mutex.html\" rel=\"nofollow noreferrer\"><code>Mutex</code></a> or <a href=\"https://doc.rust-lang.org/std/sync/struct.RwLock.html\" rel=\"nofollow noreferrer\"><code>RwLock</code></a>. These will lock access to the contents while you borrow them, so that you can safely access them from multiple threads at the same time:</p>\n<pre><code>use std::sync::{Arc, Mutex};\n\nfn example() {\n    // defining the counter variable\n    let counter = Arc::new(Mutex::new(0));\n\n    // lock the mutex to borrow\n    // it is automatically released when the borrow ends\n    let mut counter_lock = counter.lock().unwrap();\n    *counter_lock = *counter_lock + 1;\n}\n</code></pre>\n<p><code>Mutex</code> only allows you to mutably borrow, which makes it simpler, but sometimes not sufficient. <code>RwLock</code> allows you to immutably borrow as well, so that you can have either one mutable borrow, or multiple immutable borrows.</p>\n<hr />\n<p>Alternatively, for numeric types it may be preferable to use <a href=\"https://doc.rust-lang.org/std/sync/atomic/index.html\" rel=\"nofollow noreferrer\">atomic types</a>. These are specifically made for integers, and are faster than <code>Mutex</code> or <code>RwLock</code> (since they don't need to lock anything, changes happen  atomically). For a counter as above, the corresponing example would be something like:</p>\n<pre><code>use std::sync::{\n    atomic::{AtomicU32, Ordering},\n    Arc,\n};\n\nfn example() {\n    // define the counter variable\n    let counter = Arc::new(AtomicU32::new(0));\n\n    // increment the counter\n    // no lock or mutable borrow is necessary\n    counter.fetch_add(1, Ordering::SeqCst);\n}\n</code></pre>\n"}], "owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1153, "favorite_count": 0, "accepted_answer_id": 56228926, "answer_count": 1, "score": 0, "last_activity_date": 1613575734, "creation_date": 1558389066, "last_edit_date": 1558398655, "question_id": 56228614, "link": "https://stackoverflow.com/questions/56228614/how-to-change-the-value-of-an-arcu64-in-a-struct", "title": "How to change the value of an Arc&lt;u64&gt; in a struct?", "body": "<p>I can't increment a value inside a struct. I'm getting lots of different compile errors. I have an immutable reference to <code>self</code> and I can't make it mutable.</p>\n\n<p>Here is my struct:</p>\n\n<pre><code>/// Proposer factory.\npub struct ProposerFactory&lt;C, A&gt;\nwhere\n    A: txpool::ChainApi,\n{\n    /// The client instance.\n    pub client: Arc&lt;C&gt;,\n    /// The transaction pool.\n    pub transaction_pool: Arc&lt;TransactionPool&lt;A&gt;&gt;,\n    /// The inherents pool\n    pub inherents_pool: Arc&lt;InherentsPool&lt;&lt;A::Block as BlockT&gt;::Extrinsic&gt;&gt;,\n    /// Current queue number\n    cur_queue_no_ptr: Arc&lt;u64&gt;,\n}\n</code></pre>\n\n<p>I want to increment <code>cur_queue_no_ptr</code> by +1</p>\n\n<p>I tried this code:</p>\n\n<pre><code>let old_value_ref = Arc::get_mut(&amp;mut self.cur_queue_no_ptr).unwrap();\nlet old_value = *old_value_ref;\nlet new_value = old_value + 1;\n</code></pre>\n\n<p>but got this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>    152 |         let old_value_ref=Arc::get_mut(&amp;mut self.cur_queue_no_ptr).unwrap();\n        |                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^ `self` is a `&amp;` reference, so the data it refers to cannot be borrowed as mutable\n</code></pre>\n\n<p>I tried this code:</p>\n\n<pre><code>let copied_arc = Arc::clone(&amp;self.cur_queue_no_ptr);\nlet old_value = *Arc::make_mut(&amp;mut copied_arc);\nlet new_value = old_value + 1;\n</code></pre>\n\n<p>And another error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>150 |         let old_value = *Arc::make_mut(&amp;mut copied_arc);\n    |                                        ^^^^^^^^^^^^^^^ cannot borrow as mutable\n</code></pre>\n\n<p>I also tried with <code>RefCell</code> but I get this errror:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>   ^^^^^ `std::cell::RefCell&lt;u64&gt;` cannot be shared between threads safely\n</code></pre>\n\n<p>Apparently the examples in the docs will only work for variables but not structs, so how do you do it with structs?</p>\n"}, {"tags": ["rust", "rust-cargo"], "answers": [{"comments": [{"owner": {"reputation": 15015, "user_id": 1191635, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/I8bEt.jpg?s=128&g=1", "display_name": "Armeen Harwood", "link": "https://stackoverflow.com/users/1191635/armeen-harwood"}, "edited": false, "score": 1, "creation_date": 1558457536, "post_id": 56242793, "comment_id": 99104765, "body": "Any docs on what makes a dynamic library &quot;dynamic&quot;? Sorry for ignorance :("}, {"owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "reply_to_user": {"reputation": 15015, "user_id": 1191635, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/I8bEt.jpg?s=128&g=1", "display_name": "Armeen Harwood", "link": "https://stackoverflow.com/users/1191635/armeen-harwood"}, "edited": false, "score": 0, "creation_date": 1558539162, "post_id": 56242793, "comment_id": 99137301, "body": "I think ignorance is ok on a site specifically designed to ask questions ;-). Sadly I can not think of any reference stating the exact differences between static and dynamic libraries. On the top of my hat I can think of two things though: First: Dynamic libraries have to compiled with position independent code, although this is nowadays also the default for static libs. Second: Dynamic libraries provide an initialization function to be called then they are loaded. Usually this is used to initialize their global symbols."}], "tags": [], "owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "is_accepted": true, "score": 5, "last_activity_date": 1558456593, "creation_date": 1558456593, "answer_id": 56242793, "question_id": 56227766, "link": "https://stackoverflow.com/questions/56227766/why-must-a-wasm-library-in-rust-set-the-crate-type-to-cdylib/56242793#56242793", "title": "Why must a WASM library in Rust set the crate-type to cdylib?", "body": "<p>It is exactly as the Rust reference states: We are creating a dynamic library to be loaded from another language. So why is the output neither <code>.dll</code>, <code>.so</code> or <code>.dylib</code>? That is because we are not compiling for either Windows, Linux or MacOS. We are compiling for <code>wasm32-unknown-unknown</code>. So the only shortcoming of the reference here is not listing all possible platforms and their dynamic library file endings.</p>\n\n<p>We need a dynamic library, because dynamic libraries can be loaded at runtime (typically by the browser). Rust libraries have to be statically linked to be used.</p>\n\n<p>An extra tidbit of information of what is going on under the hood:</p>\n\n<p>If you invoke the <code>wasm_bindgen</code> macro it will (among other things) expand the signature of a function into a <code>C</code> function.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[wasm_bindgen]\npub fn my_function() \n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[export_name = \"my_function\"]\npub extern \"C\" fn __wasm_bindgen_my_function()\n</code></pre>\n\n<p>Why a C Function? Function calls can differ from language to language. By mangling, order of the arguments on the callstack, etc. . This is called the ABI. <code>C</code> has the distinct advantage of having a defined and stable ABI, which is why it is a popular choice for foreign function interfaces.</p>\n"}], "owner": {"reputation": 15015, "user_id": 1191635, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/I8bEt.jpg?s=128&g=1", "display_name": "Armeen Harwood", "link": "https://stackoverflow.com/users/1191635/armeen-harwood"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 454, "favorite_count": 0, "accepted_answer_id": 56242793, "answer_count": 1, "score": 6, "last_activity_date": 1558456593, "creation_date": 1558384219, "last_edit_date": 1558385719, "question_id": 56227766, "link": "https://stackoverflow.com/questions/56227766/why-must-a-wasm-library-in-rust-set-the-crate-type-to-cdylib", "title": "Why must a WASM library in Rust set the crate-type to cdylib?", "body": "<p>The <a href=\"https://doc.rust-lang.org/reference/linkage.html\" rel=\"noreferrer\">Rust reference states</a>:</p>\n\n<blockquote>\n  <p>A dynamic system library will be produced. This is used when compiling a dynamic library to be loaded from another language. This output type will create <code>*.so</code> files on Linux, <code>*.dylib</code> files on macOS, and <code>*.dll</code> files on Windows.</p>\n</blockquote>\n\n<p>My WASM is not a <code>*.dylib</code>, <code>*.dll</code>, or <code>*.so</code>... so why must the crate type be set to cdylib? What is really happening under the hood?</p>\n\n<p>lib.rs</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub extern fn add_one(x: u32) -&gt; u32 {\n    x + 1\n}\n</code></pre>\n\n<p>Cargo.toml</p>\n\n<pre><code>[package]\nname = \"utils\"\nversion = \"0.1.0\"\nauthors = [\"\"]\nedition = \"2018\"\n\n[dependencies]\n\n[lib]\ncrate-type = [\"cdylib\"] // Why is this needed\n</code></pre>\n\n<p>index.html:</p>\n\n<pre class=\"lang-html prettyprint-override\"><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n  &lt;head&gt;\n    &lt;script&gt; \n      fetch(\"utils.gc.wasm\")\n        .then(response =&gt; response.arrayBuffer())\n        .then(result =&gt; WebAssembly.instantiate(result))\n        .then(wasmModule =&gt; {\n          const result = wasmModule.instance.exports.add_one(2);\n          const text = document.createTextNode(result);\n          document.body.appendChild(text);\n        });\n    &lt;/script&gt;\n  &lt;head&gt;\n  &lt;body&gt;&lt;/body&gt;\n&lt;html&gt;\n</code></pre>\n\n<p>Terminal:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ cd utils\n$ cargo build --target wasm32-unknown-unknown --release\n$ wasm-gc target/wasm32-unknown-unknown/release/utils.wasm -o utils.gc.wasm\n$ http\n</code></pre>\n"}, {"tags": ["rust", "itertools"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558375552, "post_id": 56226013, "comment_id": 99072672, "body": "Applying the duplicate: <code>itertools::PutBack&lt;std::str::Chars&lt;&#39;_&gt;&gt;</code>"}, {"owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558375697, "post_id": 56226013, "comment_id": 99072730, "body": "Thank you ! I was looking for a general way to find out type names and searched for such a question, but that question did not pop up."}], "owner": {"reputation": 4459, "user_id": 127251, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/9b6273d6505f5cead55793f95dbe7873?s=128&d=identicon&r=PG", "display_name": "Paul Chernoch", "link": "https://stackoverflow.com/users/127251/paul-chernoch"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 30, "favorite_count": 0, "closed_date": 1558375538, "answer_count": 0, "score": 0, "last_activity_date": 1558375612, "creation_date": 1558375266, "last_edit_date": 1558375612, "question_id": 56226013, "link": "https://stackoverflow.com/questions/56226013/what-is-the-fully-qualified-type-name-of-the-value-returned-by-put-back", "closed_reason": "Duplicate", "title": "What is the fully-qualified type name of the value returned by put_back?", "body": "<p>I am trying to create a struct that will hold an iterator returned by <code>itertools::put_back</code>. I do not know the type name to use for the struct member.</p>\n\n<p>Here is how I obtain the iterator over a <code>String</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use itertools::put_back; // 0.8.0\n\nfn main() {\n    let hello = \"Hello world\".to_owned();\n    let hello_iter = hello.chars();\n    let mut putback_iterator = put_back(hello_iter);\n}\n</code></pre>\n\n<p>Here is the struct definition:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct ParserEventIterator {\n    char_iter: itertools::PutBack&lt;/* What DO I PUT HERE??? */&gt;,\n}\n</code></pre>\n\n<p>What is the type for <code>putback_iterator</code> in this case? I've tried:</p>\n\n<pre><code>itertools::PutBack&lt;&lt;std::string::String as Trait&gt;::IntoIter&gt;\n</code></pre>\n"}, {"tags": ["rust", "deserialization", "serde"], "comments": [{"owner": {"reputation": 65310, "user_id": 201725, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/616f7a1cbb20fe949d883393657c039a?s=128&d=identicon&r=PG", "display_name": "Jan Hudec", "link": "https://stackoverflow.com/users/201725/jan-hudec"}, "edited": false, "score": 1, "creation_date": 1558351313, "post_id": 56219767, "comment_id": 99060255, "body": "What is this serializer you are trying to decode data from? Bincode is not supposed to be compatible with any existing serializers."}, {"owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "reply_to_user": {"reputation": 65310, "user_id": 201725, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/616f7a1cbb20fe949d883393657c039a?s=128&d=identicon&r=PG", "display_name": "Jan Hudec", "link": "https://stackoverflow.com/users/201725/jan-hudec"}, "edited": false, "score": 0, "creation_date": 1558351505, "post_id": 56219767, "comment_id": 99060375, "body": "This data is serialized by a python program and sent over an udp socket."}, {"owner": {"reputation": 65310, "user_id": 201725, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/616f7a1cbb20fe949d883393657c039a?s=128&d=identicon&r=PG", "display_name": "Jan Hudec", "link": "https://stackoverflow.com/users/201725/jan-hudec"}, "edited": false, "score": 0, "creation_date": 1558352335, "post_id": 56219767, "comment_id": 99060820, "body": "But is the serialization in the python program some publicly named format? Or is it just ad-hoc set of <code>struct.pack</code>s created for the project?"}, {"owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "reply_to_user": {"reputation": 65310, "user_id": 201725, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/616f7a1cbb20fe949d883393657c039a?s=128&d=identicon&r=PG", "display_name": "Jan Hudec", "link": "https://stackoverflow.com/users/201725/jan-hudec"}, "edited": false, "score": 0, "creation_date": 1558352361, "post_id": 56219767, "comment_id": 99060833, "body": "The latter, and i didn&#39;t create this program. It&#39;s part of tribler&#39;s ipv8 project <a href=\"https://github.com/Tribler/py-ipv8/blob/master/ipv8/messaging/serialization.py\" rel=\"nofollow noreferrer\">github.com/Tribler/py-ipv8/blob/master/ipv8/messaging/&hellip;</a>. I just need to interpret the data they send. Bincode seemed like the best way and I implemented 90% of their standard. Its mostly about the variable length things they send as their length prefix is not compatible with bincode."}], "answers": [{"comments": [{"owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "edited": false, "score": 0, "creation_date": 1558353215, "post_id": 56220483, "comment_id": 99061301, "body": "Alright. I was already afraid this would be the answer. Thanks for your help though."}], "tags": [], "owner": {"reputation": 65310, "user_id": 201725, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/616f7a1cbb20fe949d883393657c039a?s=128&d=identicon&r=PG", "display_name": "Jan Hudec", "link": "https://stackoverflow.com/users/201725/jan-hudec"}, "is_accepted": true, "score": 4, "last_activity_date": 1558360463, "last_edit_date": 1558360463, "creation_date": 1558353090, "answer_id": 56220483, "question_id": 56219767, "link": "https://stackoverflow.com/questions/56219767/can-i-deserialize-vectors-with-variable-length-prefix-with-bincode/56220483#56220483", "title": "Can I deserialize vectors with variable length prefix with Bincode?", "body": "<p><a href=\"https://github.com/TyOverby/bincode\" rel=\"nofollow noreferrer\">Bincode</a> is not supposed to be compatible with any existing serializer or standard. Nor is, according to the comment, the format you are trying to read.</p>\n\n<p>I suggest you get the <a href=\"https://github.com/TyOverby/bincode\" rel=\"nofollow noreferrer\">bincode</a> sources\u2014they are MIT-licensed, so you are free to do basically whatever you please with them\u2014and modify them to suit your format (and give it your name and include it in your project).</p>\n\n<p><a href=\"https://docs.rs/serde/1.0.91/serde/trait.Deserializer.html\" rel=\"nofollow noreferrer\"><code>serde::Deserializer</code></a> is quite well documented, as is the underlying <a href=\"https://serde.rs/data-model.html\" rel=\"nofollow noreferrer\">data model</a>, and the implementation in bincode is trivial to find (in <code>de/mod.rs</code>), so take it as your starting point and adjust as needed.</p>\n"}, {"tags": [], "owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "is_accepted": false, "score": 0, "last_activity_date": 1558448989, "last_edit_date": 1558448989, "creation_date": 1558432353, "answer_id": 56235684, "question_id": 56219767, "link": "https://stackoverflow.com/questions/56219767/can-i-deserialize-vectors-with-variable-length-prefix-with-bincode/56235684#56235684", "title": "Can I deserialize vectors with variable length prefix with Bincode?", "body": "<p>I have figured out a (possibly very ugly) way to do it without implementing my own deserializer \u2014 Bincode could do it after all. It looks something like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;'de&gt; Deserialize&lt;'de&gt; for VarLen16 {\n    fn deserialize&lt;D&gt;(deserializer: D) -&gt; Result&lt;Self, D::Error&gt;\n    where\n        D: Deserializer&lt;'de&gt;,\n    {\n        struct VarLen16Visitor;\n        impl&lt;'de&gt; Visitor&lt;'de&gt; for VarLen16Visitor {\n            type Value = VarLen16;\n            fn expecting(&amp;self, formatter: &amp;mut fmt::Formatter) -&gt; fmt::Result {\n                formatter.write_str(\"VarLen16\")\n            }\n\n            fn visit_seq&lt;A&gt;(self, mut seq: A) -&gt; Result&lt;Self::Value, A::Error&gt;\n            where\n                A: SeqAccess&lt;'de&gt;,\n            {\n                let mut res: Vec&lt;u8&gt; = vec![];\n\n                let length: u16 = seq\n                    .next_element()?\n                    .ok_or_else(|| serde::de::Error::invalid_length(1, &amp;self))?;\n\n                for i in 0..length {\n                    res.push(\n                        seq.next_element()?\n                            .ok_or_else(|| serde::de::Error::invalid_length(1, &amp;self))?,\n                    );\n                }\n\n                return Ok(VarLen16(res));\n            }\n        }\n\n        return Ok(deserializer.deserialize_tuple(1 &lt;&lt; 16, VarLen16Visitor)?);\n    }\n}\n</code></pre>\n\n<p>In short, I make the system think I deserialize a tuple where I set the length to the maximum I need. I have tested this, it does not actually allocate that much memory. Then I act like the length is part of this tuple, read it first and then continue reading as far as this length tells me to. It's not pretty but it certainly works.</p>\n"}], "owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 816, "favorite_count": 1, "accepted_answer_id": 56220483, "answer_count": 2, "score": 1, "last_activity_date": 1558448989, "creation_date": 1558350609, "last_edit_date": 1558360414, "question_id": 56219767, "link": "https://stackoverflow.com/questions/56219767/can-i-deserialize-vectors-with-variable-length-prefix-with-bincode", "title": "Can I deserialize vectors with variable length prefix with Bincode?", "body": "<p>I am having a problem with the Rust bincode library. When it serializes a vector, it always assumes the prefixed length is 8 bytes. This is a fine assumption when you always encode data using bincode because bincode can read it's own serialized data.</p>\n\n<p>I am in the situation where I cannot influence the serializer as I did not write it and it has to stay the same for legacy reasons. It encodes its vectors as a length-prefixed array where the prefix is always 2 bytes (or in some cases it is 4 bytes but but I know these cases well. Once I know how to do it with 2 bytes 4 bytes should not be a problem). </p>\n\n<p>How can I use bincode (and serde for that matter) to deserialize these fields? Can I work around the default 8 bytes of length hardcoded in bincode?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1558341699, "post_id": 56217143, "comment_id": 99054963, "body": "Relevant: <a href=\"https://stackoverflow.com/q/55995061/1233251\">stackoverflow.com/q/55995061/1233251</a>"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1558341714, "post_id": 56217143, "comment_id": 99054972, "body": "Why don&#39;t you have a trait for the database operations that has 2 implementations: a mock, and the production operations?"}, {"owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1558342712, "post_id": 56217143, "comment_id": 99055548, "body": "@FrenchBoiethios I do, and that&#39;s why I&#39;d like to detect which one to use by detecting if it&#39;s running in a test. Also I don&#39;t mock because it would make it less of an integration test."}, {"owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1558342779, "post_id": 56217143, "comment_id": 99055579, "body": "@E_net4 can that be used in an <code>if</code> statement? I.e. <code>cfg!(test)</code>. I&#39;ve not tried it"}], "answers": [{"comments": [{"owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "edited": false, "score": 0, "creation_date": 1558347441, "post_id": 56218694, "comment_id": 99058090, "body": "That doesn&#39;t work for me. Did you test this? I&#39;d be curious to know if it works for you"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "edited": false, "score": 0, "creation_date": 1558347558, "post_id": 56218694, "comment_id": 99058156, "body": "Yes, it works for me,"}, {"owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "edited": false, "score": 0, "creation_date": 1558347761, "post_id": 56218694, "comment_id": 99058274, "body": "Are you running it with <code>cargo test</code> and is this via the unit test convention or integration test convention?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "edited": false, "score": 1, "creation_date": 1558347978, "post_id": 56218694, "comment_id": 99058376, "body": "Try in the playground: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=38b1ecd1cde65003406dafd600bdb400\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "edited": false, "score": 3, "creation_date": 1558348515, "post_id": 56218694, "comment_id": 99058686, "body": "Hm, I don&#39;t think this flag is getting set using the <a href=\"https://doc.rust-lang.org/rust-by-example/testing/integration_testing.html\" rel=\"nofollow noreferrer\">integration testing</a> convention. The example uses private functions, so it can&#39;t be testing externally as a <code>lib</code>."}, {"owner": {"reputation": 3026, "user_id": 381712, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/561f214b150981056634bc5b60a995cb?s=128&d=identicon&r=PG", "display_name": "soulmachine", "link": "https://stackoverflow.com/users/381712/soulmachine"}, "edited": false, "score": 0, "creation_date": 1609630671, "post_id": 56218694, "comment_id": 115883593, "body": "It seems <code>cfg!(test)</code> doesn&#39;t work with integration tests"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 5, "last_activity_date": 1558348040, "last_edit_date": 1558348040, "creation_date": 1558346968, "answer_id": 56218694, "question_id": 56217143, "link": "https://stackoverflow.com/questions/56217143/check-if-rust-is-running-a-test-build/56218694#56218694", "title": "Check if Rust is running a test build", "body": "<p>You can use <code>cfg!(test)</code>:</p>\n\n<pre><code>if cfg!(test) {\n    // do test stuff\n} else {\n    // do non-test stuff\n}\n</code></pre>\n\n<p>However, this can lead to fragile code. For example, you might accidentally not execute some code in production, even though the tests all pass. It is often more robust to switch code at the item level, which would result in a compile error if you get it wrong:</p>\n\n<pre><code>#[cfg(test)]\nimpl Write for DB {\n    fn write(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;usize&gt; {\n        // test stuff\n    }\n\n    fn flush(&amp;mut self) -&gt; Result&lt;()&gt; {\n        // test stuff\n    }\n}\n\n#[cfg(not(test))]\nimpl Write for DB {\n    fn write(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;usize&gt; {\n        // actually write\n    }\n\n    fn flush(&amp;mut self) -&gt; Result&lt;()&gt; {\n        // actually flush\n    }\n}\n</code></pre>\n\n<p>If you forget to implement the <code>not(test)</code> version, you will get a compilation error.</p>\n"}], "owner": {"reputation": 4415, "user_id": 2230347, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/wrVIW.jpg?s=128&g=1", "display_name": "Will Squire", "link": "https://stackoverflow.com/users/2230347/will-squire"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1086, "favorite_count": 0, "closed_date": 1558359655, "answer_count": 1, "score": 2, "last_activity_date": 1558348040, "creation_date": 1558341496, "last_edit_date": 1558347938, "question_id": 56217143, "link": "https://stackoverflow.com/questions/56217143/check-if-rust-is-running-a-test-build", "closed_reason": "Duplicate", "title": "Check if Rust is running a test build", "body": "<p>I can use <code>cfg!(debug_assertions)</code> to check if the Rust project is running in development mode, but I'd like to know how to check if a test is being run. Is there a similar flag for tests I can use in an <code>if</code> statement?</p>\n\n<p>The reason is to prevent database writes while running integration tests.</p>\n"}, {"tags": ["rust", "rust-cargo", "rust-proc-macros"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558360985, "post_id": 56215463, "comment_id": 99065698, "body": "Note that the linked <b>answer</b> discusses using the filesystem for this state and lists a number of problems with it, such as it randomly and arbitrarily breaking."}, {"owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558361949, "post_id": 56215463, "comment_id": 99066259, "body": "@Shepmaster Thank you for pointing that out (and fixing mistakes in my post). The answer does indeed discuss using the filesystem to store state, but not in a way that plays nice with a crate&#39;s file structure. My goal is to find a place within a crate&#39;s directory that can be automatically cleaned up by cargo."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558362078, "post_id": 56215463, "comment_id": 99066327, "body": "My point that is even if you find a place to store the data, the concept of storing intermediate state on the filesystem is fundamentally flawed. It doesn&#39;t matter <i>where</i> you store it if it&#39;s going to break when it&#39;s used."}, {"owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558409273, "post_id": 56215463, "comment_id": 99080945, "body": "I&#39;m not sure comments is the right place to have this discussion, but what makes you assume that it is intermediate state or that it would break if used? Could you please elaborate further? If it helps, the state I&#39;m tracking lives across multiple compilations and isn&#39;t tied to compilation artifices but source code."}], "answers": [{"tags": [], "owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "is_accepted": false, "score": 2, "last_activity_date": 1559886232, "last_edit_date": 1559886232, "creation_date": 1559830449, "answer_id": 56479446, "question_id": 56215463, "link": "https://stackoverflow.com/questions/56215463/what-is-a-suitable-place-to-store-procedural-macro-artifacts-so-that-they-are-cl/56479446#56479446", "title": "What is a suitable place to store procedural macro artifacts so that they are cleaned up by `cargo clean`?", "body": "<p>It appears that the best place for storing temporary files (that both persist across compilation runs and also get cleaned up by Cargo) is to smuggle the location of the temporary directory Cargo sets up for build scripts (<code>OUT_DIR</code>) to the rest of your compilation environment. </p>\n\n<p>One thing to keep in mind that the <strong><em>same directory</em></strong> will be used by any crate that uses your macros. Make sure to design your macro so that multiple concurrent instances of the macro can use the same directory at the same time without conflict.</p>\n\n<p>Solution in steps:</p>\n\n<ol>\n<li><p>Place the following line in the build script of your procedural macro crate:</p>\n\n<pre><code>println!(\"cargo:rustc-env=PROC_ARTIFACT_DIR={}\", std::env::var(\"OUT_DIR\").unwrap())\n</code></pre></li>\n<li><p>Use <code>env!(\"PROC_ARTIFACT_DIR\")</code> in your procedural macros to get the path to the state directory. </p></li>\n</ol>\n\n<p>Note that this is only a workaround until Cargo provides native support for temp directories for procedural macro crates. Full credit for this method goes to <a href=\"https://stackoverflow.com/questions/56231963/how-can-the-compilation-properties-be-determined-in-a-procedural-macro?noredirect=1#comment99100935_56231963\">@sven-marnach</a>.</p>\n"}], "owner": {"reputation": 709, "user_id": 10126273, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/6trXt.png?s=128&g=1", "display_name": "Tenders McChiken", "link": "https://stackoverflow.com/users/10126273/tenders-mcchiken"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 556, "favorite_count": 0, "answer_count": 1, "score": 6, "last_activity_date": 1559886232, "creation_date": 1558334208, "last_edit_date": 1558360906, "question_id": 56215463, "link": "https://stackoverflow.com/questions/56215463/what-is-a-suitable-place-to-store-procedural-macro-artifacts-so-that-they-are-cl", "title": "What is a suitable place to store procedural macro artifacts so that they are cleaned up by `cargo clean`?", "body": "<p>I'm working on a procedural macro that needs a place to store state on the system where it is run. The state should be cleaned up when <code>cargo clean</code> is run.</p>\n\n<p>In the past, I've assumed that the <code>target</code> directory is the proper place. However, my assumption is likely incorrect because:</p>\n\n<ol>\n<li>my files and directories may conflict with those of <code>rustc</code> and <code>cargo</code>.</li>\n<li>the location of the target directory can change from the default.</li>\n</ol>\n\n<p>In an effort to avoid these issues, I've been attempting to determine a way to locate a location properly but haven't been successful. The closest I've found is the environment variable <code>OUT_DIR</code> that Cargo sets for build scripts which, unfortunately, isn't set for procedural macro runs.</p>\n\n<p>Note that this question is not a duplicate of <a href=\"https://stackoverflow.com/questions/52910783/within-rusts-procedural-macros-is-it-possible-to-store-state\">Is it possible to store state within Rust&#39;s procedural macros?</a>. That question covers procedural macro state in general while this question is about determining a suitable location within a crate's file structure.  </p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 9010, "user_id": 2588800, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/847da843d41921363502159c8b7e5549?s=128&d=identicon&r=PG", "display_name": "Svetlin Zarev", "link": "https://stackoverflow.com/users/2588800/svetlin-zarev"}, "edited": false, "score": 0, "creation_date": 1558331067, "post_id": 56214766, "comment_id": 99050536, "body": "What about <a href=\"https://doc.rust-lang.org/std/cell/struct.RefCell.html\" rel=\"nofollow noreferrer\">doc.rust-lang.org/std/cell/struct.RefCell.html</a> ?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558331771, "post_id": 56214766, "comment_id": 99050750, "body": "Why the <code>UnsafeCell</code>? It is in its name... <b>unsafe</b>, don&#39;t use it! You don&#39;t know what you&#39;re doing ;) Btp: Use <code>RefCell</code> or a <code>Mutex</code>."}, {"owner": {"reputation": 9010, "user_id": 2588800, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/847da843d41921363502159c8b7e5549?s=128&d=identicon&r=PG", "display_name": "Svetlin Zarev", "link": "https://stackoverflow.com/users/2588800/svetlin-zarev"}, "edited": false, "score": 0, "creation_date": 1558332268, "post_id": 56214766, "comment_id": 99050917, "body": "On a second thought you cannot return <code>&amp;T</code>, with <code>RefCell</code> because the <code>Ref&lt;T&gt;</code> cannot outlive the function call."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558333030, "post_id": 56214766, "comment_id": 99051170, "body": "Right, neither <code>RefCell</code> nor <code>Mutex</code> fulfill the goals here, 1) because they are not zero-cost (they involve storing more data than that of an <code>Option&lt;T&gt;</code> and also add unnecessary runtime checks), and 2) they do not seem to provide any way to return a real reference with the lifetime that we want -- instead we could only return a <code>Ref</code> or <code>MutexGuard</code> which is not the same thing."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558333199, "post_id": 56214766, "comment_id": 99051220, "body": "@BrentKerby then you can&#39;t achieve what you&#39;re looking for. Your code will fail in multi-threaded code and your unsafe will probably hide it."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1558333455, "post_id": 56214766, "comment_id": 99051305, "body": "I don&#39;t understand the purpose, why not just use only an option. Your question don&#39;t make sense. also your code is broken in case of multi threading."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558333459, "post_id": 56214766, "comment_id": 99051309, "body": "Because of the contained <code>UnsafeCell</code>, <code>Cache</code> does not implement <code>Sync</code>, so Rust will not allow it to be shared across threads, but that is fine. In other words, sharing across threads is not part of the goal here."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558333762, "post_id": 56214766, "comment_id": 99051422, "body": "Using only an <code>Option</code> would not provide the same functionality: if we share immutable references to the <code>Cache</code>, any holder of such a reference can invoke <code>call</code> and obtain the desired value (and mutating the <code>Cache</code> in the process so that future calls will retrieve the same value); whereas, sharing immutable references to an <code>Option</code>, it would not be possible to mutate the <code>Option</code>, so it could not work."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1558334668, "post_id": 56214766, "comment_id": 99051763, "body": "Could you please edit in the question that you are not looking for a solution which is <code>Sync</code>? This was my first question too, and may be the only thing making a solution to your task possible."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1558335544, "post_id": 56214766, "comment_id": 99052091, "body": "@MatthieuM, done! Yeah, the multithreaded case is interesting too but would inevitably require some kind of synchronization, so I doubt it could be done with only an <code>Option&lt;T&gt;</code> amount of storage."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1558336613, "post_id": 56214766, "comment_id": 99052544, "body": "@BrentKerby: Oh, I am sure it could; but you would need some kind of &quot;sync Option&quot;. Actually, this sparks another question: does it matter if <code>f</code> is called multiple times? Notably, if the call to <code>f()</code> somehow calls <code>Cache::call</code> which triggers another execution of <code>f()</code>?"}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558337439, "post_id": 56214766, "comment_id": 99052914, "body": "Yeah, I guess you&#39;re right that in theory it should be possible to support multithreaded use still with only <code>Option&lt;T&gt;</code> amount of storage, at least if we were okay with <code>f</code> possibly being called multiple times (e.g., if a second thread invokes <code>call</code> while the first is still computing); in that case, it seems like we would just need to be able to access the discriminant of the Option atomically. But since Rust&#39;s layout of the Option is unspecified and may depend on various optimizations, it seems that this would probably require some kind of special compiler support to implement properly."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558337755, "post_id": 56214766, "comment_id": 99053058, "body": "I&#39;ll have to think more about that though, because it seems like even in the single-threaded case, the ability of <code>f</code> to call the same <code>Cache</code> again could make it possible for the value to be written more than once, potentially compromising safety."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 1, "creation_date": 1558338360, "post_id": 56214766, "comment_id": 99053343, "body": "Yeah, I&#39;m convinced now my original implementation was unsound in that it could result in undefined behavior, from mutation still being possible on a value referenced by an immutable reference returned by <code>call</code>. I&#39;ve modified it now to guard against the possibility that <code>f()</code> itself may invoke <code>call</code> on the same <code>Cache</code>. This stuff sure is tricky to get right!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558361982, "post_id": 56214766, "comment_id": 99066276, "body": "I&#39;d challenge the purpose of your question. If you are caching something, that&#39;s because either its &quot;big&quot; or &quot;expensive&quot; or both. Within that view, adding the extra few bytes for a <code>RefCell</code> is a pittance. See <a href=\"https://stackoverflow.com/q/29401626/155423\">How do I return a reference to something inside a RefCell without breaking encapsulation?</a> for how to avoid the API issues."}, {"owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "edited": false, "score": 0, "creation_date": 1558363097, "post_id": 56214766, "comment_id": 99066897, "body": "Here&#39;s one use case: a reactive system with a lot of small functional components arranged in a directed acyclic graph. The cost of a recomputing a component would not have to be very great in order to justify caching it, given that it&#39;s possible to cache it so cheaply. The added cost of a <code>RefCell</code> could become significant in such a scenario, which might force us to artificially group some of the small components together, adding complexity and maybe hurting performance. Part of what makes Rust awesome is that we can create zero-cost abstractions so we don&#39;t have to make compromises like that."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558368897, "post_id": 56214766, "comment_id": 99070012, "body": "The cost of a <code>RefCell</code> is a pointer-sized integer and a check of that integer. I doubt that either of those are going to show up in any performance trace unless the value being cached is smaller than or equal to a pointer and the computation of the value is less expensive than an integer comparison."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1558369105, "post_id": 56214766, "comment_id": 99070091, "body": "For what it&#39;s worth: <a href=\"https://crates.io/crates/once_cell\" rel=\"nofollow noreferrer\">once_cell</a>"}], "owner": {"reputation": 1248, "user_id": 4704553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d9a1bf227c6838e4c21190d57b1464a0?s=128&d=identicon&r=PG", "display_name": "Brent Kerby", "link": "https://stackoverflow.com/users/4704553/brent-kerby"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 186, "favorite_count": 0, "answer_count": 0, "score": 4, "last_activity_date": 1558359905, "creation_date": 1558330342, "last_edit_date": 1558359905, "question_id": 56214766, "link": "https://stackoverflow.com/questions/56214766/it-is-possible-to-have-single-threaded-zero-cost-memoization-without-mutability", "title": "It is possible to have single-threaded zero-cost memoization without mutability in safe Rust?", "body": "<p>I'm interested in finding or implementing a Rust data structure that provides a zero-cost way to memoize a single computation with an arbitrary output type <code>T</code>. Specifically I would like a generic type <code>Cache&lt;T&gt;</code> whose internal data takes up no more space than an <code>Option&lt;T&gt;</code>, with the following basic API:</p>\n\n<pre><code>impl&lt;T&gt; Cache&lt;T&gt; {\n    /// Return a new Cache with no value stored in it yet.\n    pub fn new() -&gt; Self {\n        // ...\n    }\n\n    /// If the cache has a value stored in it, return a reference to the \n    /// stored value. Otherwise, compute `f()`, store its output\n    /// in the cache, and then return a reference to the stored value.\n    pub fn call&lt;F: FnOnce() -&gt; T&gt;(&amp;self, f: F) -&gt; &amp;T {\n        // ...\n    }\n}\n</code></pre>\n\n<p>The goal here is to be able to share multiple immutable references to a <code>Cache</code> within a single thread, with any holder of such a reference being able to access the value (triggering the computation if it is the first time). Since we're only requiring to be able to share a <code>Cache</code> within a single thread, it is not necessary for it to be <code>Sync</code>.</p>\n\n<p>Here is a way to implement the API safely (or at least I think it's safe) using <code>unsafe</code> under the hood:</p>\n\n<pre><code>use std::cell::UnsafeCell;\n\npub struct Cache&lt;T&gt; {\n    value: UnsafeCell&lt;Option&lt;T&gt;&gt;\n}\n\nimpl&lt;T&gt; Cache&lt;T&gt; {\n    pub fn new() -&gt; Self {\n        Cache { value: UnsafeCell::new(None) }\n    }\n\n    pub fn call&lt;F: FnOnce() -&gt; T&gt;(&amp;self, f: F) -&gt; &amp;T {\n        let ptr = self.value.get();\n        unsafe {\n            if (*ptr).is_none() {\n                let t = f();\n                // Since `f` potentially could have invoked `call` on this\n                // same cache, to be safe we must check again that *ptr\n                // is still None, before setting the value.\n                if (*ptr).is_none() {\n                    *ptr = Some(t);\n                }\n            }\n            (*ptr).as_ref().unwrap()\n        }\n    }\n}\n</code></pre>\n\n<p>Is it possible to implement such a type in safe Rust (i.e., not writing our own <code>unsafe</code> code, only indirectly relying on <code>unsafe</code> code in the standard library)? </p>\n\n<p>Clearly, the <code>call</code> method requires mutating <code>self</code>, which means that <code>Cache</code> must use some form of interior mutability. However, it does not seem possible to do with a <code>Cell</code>, because <code>Cell</code> provides no way to retrieve a reference to the enclosed value, as is required by the desired API of <code>call</code> above. And this is for a good reason, as it would be unsound for <code>Cell</code> to provide such a reference, because it would have no way to ensure that the referenced value is not mutated over the lifetime of the reference. On the other hand, for the <code>Cache</code> type, after <code>call</code> is called once, the API above does not provide any way for the stored value to be mutated again, so it is safe for it to hand out a reference with a lifetime that can be a long as that of the <code>Cache</code> itself.</p>\n\n<p>If <code>Cell</code> can't work, I'm curious if the Rust standard library might provide some other safe building blocks for interior mutability which could be used to implement this <code>Cache</code>.</p>\n\n<p>Neither <code>RefCell</code> nor <code>Mutex</code> fulfill the goals here:</p>\n\n<ol>\n<li>they are not zero-cost: they involve storing more data than that of an <code>Option&lt;T&gt;</code> and add unnecessary runtime checks.</li>\n<li>they do not seem to provide any way to return a real reference with the lifetime that we want -- instead we could only return a <code>Ref</code> or <code>MutexGuard</code> which is not the same thing.</li>\n</ol>\n\n<p>Using only an <code>Option</code> would not provide the same functionality: if we share immutable references to the <code>Cache</code>, any holder of such a reference can invoke <code>call</code> and obtain the desired value (and mutating the <code>Cache</code> in the process so that future calls will retrieve the same value); whereas, sharing immutable references to an <code>Option</code>, it would not be possible to mutate the <code>Option</code>, so it could not work. </p>\n"}, {"tags": ["rust"], "owner": {"reputation": 2826, "user_id": 1575632, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/SPw2f.jpg?s=128&g=1", "display_name": "amin", "link": "https://stackoverflow.com/users/1575632/amin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 47, "favorite_count": 0, "closed_date": 1558314317, "answer_count": 0, "score": 1, "last_activity_date": 1589474846, "creation_date": 1558314092, "last_edit_date": 1589474846, "question_id": 56213243, "link": "https://stackoverflow.com/questions/56213243/what-is-the-equivalent-of-optiontake-for-a-vect", "closed_reason": "Duplicate", "title": "What is the equivalent of Option::take() for a Vec&lt;T&gt;?", "body": "<pre><code>struct A {\n    pub v: Vec&lt;i32&gt;\n}\n\nfn extract(a: &amp;mut A) -&gt; Vec&lt;i32&gt; {\n    let res = a.v.clone(); // TODO: move out of a.v\n    res\n}\n</code></pre>\n\n<p>How to move out a <code>Vec&lt;T&gt;</code> while it's inside a <code>&amp;mut</code> struct?</p>\n"}, {"tags": ["eclipse", "rust"], "comments": [{"owner": {"reputation": 21982, "user_id": 6505250, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FgNJn.jpg?s=128&g=1", "display_name": "howlger", "link": "https://stackoverflow.com/users/6505250/howlger"}, "edited": false, "score": 0, "creation_date": 1558336425, "post_id": 56212192, "comment_id": 99052470, "body": "Maybe your Eclipse is too old. Which Eclipse version do you have? If it is older than Eclipse 2019-03 (4.11), please <a href=\"https://wiki.eclipse.org/FAQ_How_do_I_upgrade_Eclipse_IDE%3F#Always_enable_major_upgrades\" rel=\"nofollow noreferrer\">upgrade</a>."}, {"owner": {"reputation": 1344, "user_id": 562646, "user_type": "registered", "accept_rate": 40, "profile_image": "https://www.gravatar.com/avatar/e1dc86932c17fa61ffd81a0a0e63e6b8?s=128&d=identicon&r=PG", "display_name": "digitig", "link": "https://stackoverflow.com/users/562646/digitig"}, "reply_to_user": {"reputation": 21982, "user_id": 6505250, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FgNJn.jpg?s=128&g=1", "display_name": "howlger", "link": "https://stackoverflow.com/users/6505250/howlger"}, "edited": false, "score": 0, "creation_date": 1558451750, "post_id": 56212192, "comment_id": 99101674, "body": "That could be it; I&#39;m at Eclipse 4.7. But I can&#39;t work out how to upgrade - where is the repository? I&#39;ve got <a href=\"http://download.eclipse.org/releases/oxygen\" rel=\"nofollow noreferrer\">download.eclipse.org/releases/oxygen</a> in my list of available software sites, but it&#39;s showing me no upgrades available (as you can tell, I&#39;m not a regular Eclipse user!)"}, {"owner": {"reputation": 21982, "user_id": 6505250, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FgNJn.jpg?s=128&g=1", "display_name": "howlger", "link": "https://stackoverflow.com/users/6505250/howlger"}, "edited": false, "score": 0, "creation_date": 1558452377, "post_id": 56212192, "comment_id": 99102045, "body": "In <i>Window &gt; Preferences: Install/Update &gt; Available Software Sites</i> add the update site <a href=\"http://download.eclipse.org/releases/latest\" rel=\"nofollow noreferrer\"><code>http:&#47;&#47;download.eclipse.org&#47;releases&#47;latest</code></a> and do <i>Help &gt; Check for Updates</i>."}, {"owner": {"reputation": 1344, "user_id": 562646, "user_type": "registered", "accept_rate": 40, "profile_image": "https://www.gravatar.com/avatar/e1dc86932c17fa61ffd81a0a0e63e6b8?s=128&d=identicon&r=PG", "display_name": "digitig", "link": "https://stackoverflow.com/users/562646/digitig"}, "reply_to_user": {"reputation": 21982, "user_id": 6505250, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FgNJn.jpg?s=128&g=1", "display_name": "howlger", "link": "https://stackoverflow.com/users/6505250/howlger"}, "edited": false, "score": 1, "creation_date": 1558534438, "post_id": 56212192, "comment_id": 99134353, "body": "Thanks - my problem was finding the right update site."}], "owner": {"reputation": 1344, "user_id": 562646, "user_type": "registered", "accept_rate": 40, "profile_image": "https://www.gravatar.com/avatar/e1dc86932c17fa61ffd81a0a0e63e6b8?s=128&d=identicon&r=PG", "display_name": "digitig", "link": "https://stackoverflow.com/users/562646/digitig"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 90, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1558311906, "creation_date": 1558301632, "last_edit_date": 1558311906, "question_id": 56212192, "link": "https://stackoverflow.com/questions/56212192/how-to-install-corrosion-on-eclipse", "title": "How to install Corrosion on Eclipse?", "body": "<p>The <a href=\"https://marketplace.eclipse.org/content/corrosion-develop-rust-applications-eclipse-ide\" rel=\"nofollow noreferrer\">Corrosion website</a> says that I just need to drag the install button to an open Eclipse workspace. When I do that, all it does is open Eclipse Marketplace (yes, that is installed); it doesn't install anything, and marketplace doesn't appear to contain Corrosion (and the only thing I can find for Rust is RustDT, no longer supported). What am I missing?</p>\n"}, {"tags": ["rust", "ffi"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558276272, "post_id": 56207345, "comment_id": 99038821, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/36649865/155423\">How can I guarantee that a type that doesn&#39;t implement Sync can actually be safely shared between threads?</a>. If you disagree, please <b><a href=\"https://stackoverflow.com/posts/56207345/edit\">edit</a></b> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 21, "user_id": 9486796, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ebf6211b5fef9904421c68c6168bc4a8?s=128&d=identicon&r=PG&f=1", "display_name": "Emil", "link": "https://stackoverflow.com/users/9486796/emil"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558301325, "post_id": 56207345, "comment_id": 99045432, "body": "Thanks for the reference. You are right, I can declare a newtype struct for the  <code>exports</code> symbol (i.e <code>pub struct ModuleExports(pub *const kam_module_exports)</code>) and unsafe implement <code>Sync</code> for it. This makes the compiler pass the code."}], "owner": {"reputation": 21, "user_id": 9486796, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ebf6211b5fef9904421c68c6168bc4a8?s=128&d=identicon&r=PG&f=1", "display_name": "Emil", "link": "https://stackoverflow.com/users/9486796/emil"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 149, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1558276226, "creation_date": 1558265428, "last_edit_date": 1558276226, "question_id": 56207345, "link": "https://stackoverflow.com/questions/56207345/how-to-declare-a-no-mangle-pub-static-symbol-with-const-t-members", "title": "How to declare a #[no_mangle] pub static symbol with const *T members", "body": "<p>I'm trying to build a shared library module to be loaded by <a href=\"https://www.kamailio.org/\" rel=\"nofollow noreferrer\">Kamailio</a> using <code>rust-bindgen</code>. The module interface requires a symbol <code>exports</code> pointing to a C struct defined in <code>Kamailio</code>. </p>\n\n<p>This struct contains some function pointers and other pointer fields (declared as <code>const *T</code>) and thus cannot implement <code>Sync</code>. How do I export such a symbol in safe or unsafe Rust? </p>\n\n<p>Do I need to write a wrapper C object for my Rust shared library module just to export this symbol?</p>\n\n<p>I am using stable Rust 2018 Edition and latest <code>rust-bindgen</code>.</p>\n\n<p>This is the declaration of the struct type for the module exports symbol. Generated by <code>bindgen</code> and adapted by me.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[doc = \" kamailio/openser module exports version\"]\n#[repr(C)]\n#[derive(Debug, Copy, Clone)]\npub struct kam_module_exports {\n    #[doc = \"&lt; null terminated module name\"]\n    pub name: *const ::std::os::raw::c_char,\n    #[doc = \"&lt; flags for dlopen\"]\n    pub dlflags: ::std::os::raw::c_uint,\n    #[doc = \"&lt; null terminated array of the exported\"]\n    #[doc = \"commands\"]\n    pub cmds: *const kam_cmd_export_t,\n    #[doc = \"&lt; null terminated array of the exported\"]\n    #[doc = \"module parameters\"]\n    pub params: *const param_export_t,\n    #[doc = \"&lt; null terminated array of the exported\"]\n    #[doc = \"module statistics\"]\n    pub stats: *const stat_export_t,\n    #[doc = \"&lt; null terminated array of the exported\"]\n    #[doc = \"NN functions\"]\n    pub nn_cmds: *const nn_export_t,\n    #[doc = \"&lt; null terminated array of the exported\"]\n    #[doc = \"module items (pseudo-variables)\"]\n    pub items: *const pv_export_t,\n    #[doc = \"&lt; null terminated array of the\"]\n    #[doc = \"additional processes required by the\"]\n    #[doc = \"module\"]\n    pub procs: *const proc_export_t,\n    #[doc = \"&lt; Initialization function\"]\n    pub init_f: init_function,\n    #[doc = \"&lt; function used for responses,\"]\n    #[doc = \"returns yes or no; can be null\"]\n    pub response_f: response_function,\n    #[doc = \"&lt; function called when the module should\"]\n    #[doc = \"be \\\"destroyed\\\", e.g: on ser exit;\"]\n    #[doc = \"can be null\"]\n    pub destroy_f: destroy_function,\n    #[doc = \"&lt; function called by all processes\"]\n    #[doc = \"after the fork\"]\n    pub init_child_f: child_init_function,\n}\n</code></pre>\n\n<p>The exports symbol is declared like so:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub static exports: *const ::kamailio_mod::kam_module_exports =\n            &amp;::kamailio_mod::kam_module_exports {\n                name: &amp;name[0],\n                dlflags: 0,\n                cmds: &amp;cmd_exports[0],\n                params: ::std::ptr::null_mut(),\n                stats: ::std::ptr::null_mut(),\n                nn_cmds: ::std::ptr::null_mut(),\n                items: ::std::ptr::null_mut(),\n                procs: ::std::ptr::null_mut(),\n                init_f: None,\n                response_f: None,\n                destroy_f: None,\n                init_child_f: None,\n            };\n</code></pre>\n\n<blockquote>\n  <p>error[E0277]: *const kamailio_mod::kam_module_exports cannot be shared between threads safely</p>\n</blockquote>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "edited": false, "score": 0, "creation_date": 1558222890, "post_id": 56203213, "comment_id": 99029623, "body": "Can you share your error? It may be because of your compiler version, but when I compile your code, the error is not a borrow conflict - it&#39;s instead because you pass <code>arg</code> as an owned value into <code>entry</code>, and then try to reuse it in the closure of <code>or_insert_with</code>. In fact, there&#39;s no way to do what you want with your current types - inserting the key requires ownership of the key, and the calculation requires ownership of the key."}, {"owner": {"reputation": 61, "user_id": 8141800, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-Hwmr7fZ4arI/AAAAAAAAAAI/AAAAAAAAB3Y/GwMAT1ZlWZc/photo.jpg?sz=128", "display_name": "Pramod Jacob", "link": "https://stackoverflow.com/users/8141800/pramod-jacob"}, "reply_to_user": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "edited": false, "score": 0, "creation_date": 1558238827, "post_id": 56203213, "comment_id": 99031348, "body": "I see both the error you mentioned and the error mentioned in my post.  Should I be utilizing a reference to the arg param in the value method, rather than have the value method take ownership of &quot;arg&quot;?"}, {"owner": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "edited": false, "score": 0, "creation_date": 1558256529, "post_id": 56203213, "comment_id": 99034190, "body": "You can&#39;t do that - the call to <code>entry</code> takes ownership of the argument, so you can&#39;t reference it afterwards. If you try to get the reference from the entry using <code>Entry::key</code>, you&#39;ll have a borrow which will stop you from using <code>Entry::or_insert_with</code>, since that requires ownership."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1558274460, "post_id": 56203213, "comment_id": 99038369, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=54ea24f045d40a6b41d5830a8e4d5e82\" rel=\"nofollow noreferrer\">The duplicates applied to your question</a> (and yes, I&#39;d use a reference)"}, {"owner": {"reputation": 61, "user_id": 8141800, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-Hwmr7fZ4arI/AAAAAAAAAAI/AAAAAAAAB3Y/GwMAT1ZlWZc/photo.jpg?sz=128", "display_name": "Pramod Jacob", "link": "https://stackoverflow.com/users/8141800/pramod-jacob"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558287546, "post_id": 56203213, "comment_id": 99042020, "body": "I apologize that it&#39;s a duplicate question - I wasn&#39;t quite sure how to phrase it, so I wasn&#39;t sure where I could find that it was already answered. Thank you for taking the time to answer the question @Shepmaster!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558288039, "post_id": 56203213, "comment_id": 99042142, "body": "@PramodJacob no need to apologize for duplicates. Now that you\u2019ve asked yours, anyone who uses the same terms will find this and be redirected to the original questions."}], "owner": {"reputation": 61, "user_id": 8141800, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-Hwmr7fZ4arI/AAAAAAAAAAI/AAAAAAAAB3Y/GwMAT1ZlWZc/photo.jpg?sz=128", "display_name": "Pramod Jacob", "link": "https://stackoverflow.com/users/8141800/pramod-jacob"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 336, "favorite_count": 1, "closed_date": 1558274086, "answer_count": 0, "score": 2, "last_activity_date": 1558290403, "creation_date": 1558217342, "last_edit_date": 1558290403, "question_id": 56203213, "link": "https://stackoverflow.com/questions/56203213/handling-immutable-borrow-inside-of-closure-that-is-part-of-a-mutable-borrow", "closed_reason": "Duplicate", "title": "Handling immutable borrow inside of closure that is part of a mutable borrow", "body": "<p>As part of the <a href=\"https://doc.rust-lang.org/book/ch13-01-closures.html\" rel=\"nofollow noreferrer\">Rust book</a>, I implemented a <code>Cacher</code> struct with generics. <code>Cacher</code> contains two fields: a closure <code>calculation</code> and a <code>value</code> field which is a <code>HashMap</code>: </p>\n\n<pre><code>use std::{collections::HashMap, hash::Hash};\n\nstruct Cacher&lt;T, U, V&gt;\nwhere\n    T: Fn(U) -&gt; V,\n    U: Eq + Hash,\n{\n    calculation: T,\n    value: HashMap&lt;U, V&gt;,\n}\n\nimpl&lt;T, U, V&gt; Cacher&lt;T, U, V&gt;\nwhere\n    T: Fn(U) -&gt; V,\n    U: Eq + Hash,\n{\n    fn new(calculation: T) -&gt; Cacher&lt;T, U, V&gt; {\n        Cacher {\n            calculation,\n            value: HashMap::new(),\n        }\n    }\n\n    fn value(&amp;mut self, arg: U) -&gt; &amp;V {\n        self.value\n            .entry(arg)\n            .or_insert_with(|| (self.calculation)(arg))\n    }\n}\n</code></pre>\n\n<p>I'm struggling with the <code>Cacher::value</code> method which should do the following: </p>\n\n<ul>\n<li><p>If the <code>value</code> <code>HashMap</code> contains a key matching the provided argument, then return the corresponding value.</p></li>\n<li><p>If the <code>value</code> <code>HashMap</code> does not contain a key matching the argument, execute <code>Cacher</code>'s <code>calculation</code> closure. Save the result of this closure in the <code>HashMap</code>, using the provided argument as the key. </p></li>\n</ul>\n\n<p>I've tried a variety of solutions that always result in conflicts between mutable borrows and immutable borrows. I'm not sure how to resolve the issue. </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `self` as immutable because it is also borrowed as mutable\n  --&gt; src/lib.rs:27:29\n   |\n24 |       fn value(&amp;mut self, arg: U) -&gt; &amp;V {\n   |                - let's call the lifetime of this reference `'1`\n25 |           self.value\n   |           ----------\n   |           |\n   |  _________mutable borrow occurs here\n   | |\n26 | |             .entry(arg)\n27 | |             .or_insert_with(|| (self.calculation)(arg))\n   | |_____________________________^^__----__________________- returning this value requires that `self.value` is borrowed for `'1`\n   |                               |   |\n   |                               |   second borrow occurs due to use of `self` in closure\n   |                               immutable borrow occurs here\n\nerror[E0382]: use of moved value: `arg`\n  --&gt; src/lib.rs:27:29\n   |\n12 | impl&lt;T, U, V&gt; Cacher&lt;T, U, V&gt;\n   |         - consider adding a `Copy` constraint to this type argument\n...\n24 |     fn value(&amp;mut self, arg: U) -&gt; &amp;V {\n   |                         --- move occurs because `arg` has type `U`, which does not implement the `Copy` trait\n25 |         self.value\n26 |             .entry(arg)\n   |                    --- value moved here\n27 |             .or_insert_with(|| (self.calculation)(arg))\n   |                             ^^                    --- use occurs due to use in closure\n   |                             |\n   |                             value used here after move\n</code></pre>\n\n<p>I'm running into a compile-time error because <code>self.value.entry().or_insert_with()</code> is a mutable borrow, while the use of <code>self</code> in the closure inside of <code>or_insert_with()</code> triggers an immutable borrow. </p>\n\n<p>I'm also running into an error in the value method because I'm passing ownership of <code>arg</code> into <code>entry()</code> and trying to use it again inside of the closure. Should I be using references in this method? If so, how?</p>\n\n<p>I understand the issues from a high level, but I'm struggling trying to find a fix around it. What can I do to prevent a mix of mutable and immutable borrows when trying to read or write to the <code>value</code> <code>HashMap</code>?</p>\n\n<p><strong>Solution</strong></p>\n\n<p>The <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=54ea24f045d40a6b41d5830a8e4d5e82\" rel=\"nofollow noreferrer\">solution</a> I settled on. </p>\n\n<p>The closure signature changed to <code>Fn(&amp;U) -&gt; V</code> and the <code>value</code> method changed to: </p>\n\n<pre><code>fn value(&amp;mut self, arg: U) -&gt; &amp;V {\n    match self.value.entry(arg) {\n        Entry::Occupied(e) =&gt; e.into_mut(),\n        Entry::Vacant(e) =&gt; {\n            let v = (self.calculation)(e.key());\n            e.insert(v)\n        }\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "closures", "traits"], "answers": [{"tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 3, "last_activity_date": 1558273256, "last_edit_date": 1558273256, "creation_date": 1558204536, "answer_id": 56201832, "question_id": 56201717, "link": "https://stackoverflow.com/questions/56201717/returning-closure-from-a-closure-as-return-value-for-function/56201832#56201832", "title": "Returning closure from a closure as return value for function", "body": "<p>If you read the message closer, it explains exactly what the issue is:</p>\n\n<blockquote>\n  <pre class=\"lang-none prettyprint-override\"><code>`impl Trait` not allowed outside of function and inherent method return types\n</code></pre>\n</blockquote>\n\n<p>At the moment, you can only use <code>impl Trait</code>:</p>\n\n<ul>\n<li>As the return type of a function: <code>fn</code> used outside of an <code>impl</code> block.</li>\n<li>As the return type of an inherent method: <code>fn</code> used in an <code>impl Type</code> block.</li>\n</ul>\n\n<p>And that's it.</p>\n\n<p>Therefore, you cannot form a trait <code>Fn() -&gt; impl X</code>.</p>\n\n<p>I would note that this is, hopefully, a temporary limitation as work is ongoing to extend the places where <code>impl X</code> can be used, and associated types and trait methods are desired.</p>\n\n<blockquote>\n  <p>Why is it allowed for the first <code>impl Fn</code>, but not allowed for the second?</p>\n</blockquote>\n\n<p>The first <code>impl Fn</code> is the return type of a function (<code>y</code>) so it is allowed. The second is the return type of a trait method so it is not.</p>\n\n<blockquote>\n  <p>How this can be done without using the heap?</p>\n</blockquote>\n\n<p>You could return a concrete instance out of the first <code>Fn</code>.</p>\n\n<p>For example, if you do not need state, you could return a <code>fn(bool) -&gt; bool</code> instead.</p>\n\n<p>Otherwise, you would need to manually create a struct which encapsulates said state so as to be able to name the type, instead of relying on a closure.</p>\n"}], "owner": {"reputation": 4710, "user_id": 2281274, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/sHobc.gif?s=128&g=1", "display_name": "George Shuklin", "link": "https://stackoverflow.com/users/2281274/george-shuklin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 137, "favorite_count": 0, "accepted_answer_id": 56201832, "answer_count": 1, "score": 1, "last_activity_date": 1558273256, "creation_date": 1558203662, "last_edit_date": 1558273191, "question_id": 56201717, "link": "https://stackoverflow.com/questions/56201717/returning-closure-from-a-closure-as-return-value-for-function", "title": "Returning closure from a closure as return value for function", "body": "<p>I'm trying to get used to <code>impl Fn</code>, but I don't understand the error for this code:</p>\n\n<pre><code>fn y(state: bool) -&gt; impl Fn() -&gt; impl Fn(bool) -&gt; bool {\n    move || {\n        println!(\"state, {}\", state);\n        |x: bool| {\n            println!(\"state, {}\", state);\n            !x\n        }\n    }\n}\n\nfn main() {\n    y(true)()(true);\n}\n</code></pre>\n\n<p>The error is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0562]: `impl Trait` not allowed outside of function and inherent method return types\n --&gt; src/main.rs:1:35\n  |\n1 | fn y(state: bool) -&gt; impl Fn() -&gt; impl Fn(bool) -&gt; bool {\n  |                                   ^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<ol>\n<li>Why is it allowed for the first <code>impl Fn</code>, but not allowed for the second?</li>\n<li>How this can be done without using the heap (via <code>Box</code>, etc.)?</li>\n</ol>\n"}, {"tags": ["rust", "closures", "type-parameter"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558271469, "post_id": 56201604, "comment_id": 99037628, "body": "<b>Please</b> include all of the code needed \u2014 I had to add <code>use</code> statements. <b>Please</b> include the error you are getting."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558272229, "post_id": 56201604, "comment_id": 99037815, "body": "TL;DR the duplicates: You are using an unstable syntax; use the syntax that you used on the function (<code>F: FnMut() -&gt; Z</code>), not on the type (<code>F: FnMut&lt;()&gt;</code>). You then have to add a <code>Box::new</code>; you can&#39;t use <code>call()</code> (also unstable); you have to handle the error from <code>lock</code>; then work around an issue regarding <code>DerefMut</code>. It&#39;s unclear why you have duplicated the bound on <code>F</code> in two places. <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=70570f1b7f5d871bdba5dfb3d252222f\" rel=\"nofollow noreferrer\">All together, it looks like this</a>."}], "owner": {"reputation": 375, "user_id": 11134001, "user_type": "registered", "profile_image": "https://graph.facebook.com/2130930103663266/picture?type=large", "display_name": "Thomas Braun", "link": "https://stackoverflow.com/users/11134001/thomas-braun"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 71, "favorite_count": 0, "closed_date": 1558271935, "answer_count": 0, "score": 0, "last_activity_date": 1558271985, "creation_date": 1558202843, "last_edit_date": 1558271427, "question_id": 56201604, "link": "https://stackoverflow.com/questions/56201604/creating-a-thread-safe-wrapper-for-an-executable-closure", "closed_reason": "Duplicate", "title": "Creating a thread-safe wrapper for an executable closure", "body": "<p>I want an arbitrary input, <code>F</code>, that returns an arbitrary value, <code>Z</code>. From the API perspective, I want something like this:</p>\n\n<pre><code>let mut action = ExecutableAction::create(move || {\n    true\n});\n</code></pre>\n\n<p>In this case, <code>Z</code> is an instance of <code>bool</code> and <code>F</code> is a function which returns <code>Z</code>. </p>\n\n<p>I tried this code:</p>\n\n<pre><code>use std::sync::{Arc, Mutex};\n\npub struct ExecutableAction&lt;F, Z&gt;\nwhere\n    F: FnMut() -&gt; Z + Send + Sync,\n{\n    action: Arc&lt;Mutex&lt;Box&lt;F&gt;&gt;&gt;,\n}\n\nimpl&lt;F, Z&gt; ExecutableAction&lt;F, Z&gt;\nwhere\n    F: FnMut&lt;()&gt; + Send + Sync,\n    Z: Send + Sync,\n{\n    pub fn create(closure: F) -&gt; Self\n    where\n        F: FnMut() -&gt; Z + Send + Sync,\n    {\n        Self {\n            action: Arc::new(Mutex::new(closure)),\n        }\n    }\n\n    pub fn call(&amp;mut self) -&gt; Z {\n        self.action.lock().call()\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0658]: the precise format of `Fn`-family traits' type parameters is subject to change. Use parenthetical notation (Fn(Foo, Bar) -&gt; Baz) instead (see issue #29625)\n  --&gt; src/lib.rs:12:8\n   |\n12 |     F: FnMut&lt;()&gt; + Send + Sync,\n   |        ^^^^^^^^^\n</code></pre>\n\n<p>I'm sure my syntax is off, as it does not compile. How could I go about making this generically applicable? Also, what about denoting the arguments of <code>F</code> with a type parameter <code>R</code>? How might this be added on here?</p>\n"}, {"tags": ["rust", "substrate"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1558194623, "post_id": 56200408, "comment_id": 99024011, "body": "Where did you find that code? That is not syntactically valid Rust, unless it&#39;s inside a macro of some sort."}, {"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1558195214, "post_id": 56200408, "comment_id": 99024153, "body": "@E_net4 , hmm, well it is part of a macro, but in its body. I have posted the link to the source"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 4, "creation_date": 1558195983, "post_id": 56200408, "comment_id": 99024335, "body": "Once inside a macro, it&#39;s the macro itself that defines what syntax to accept."}, {"owner": {"reputation": 478, "user_id": 3491376, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/lh2OC.png?s=128&g=1", "display_name": "Deadooshka", "link": "https://stackoverflow.com/users/3491376/deadooshka"}, "edited": false, "score": 2, "creation_date": 1558197476, "post_id": 56200408, "comment_id": 99024667, "body": "<a href=\"https://github.com/holygits/substrate/blob/2ad85daba580cd0248013be6351f1a81cef62fd6/srml/support/procedural/src/lib.rs#L56\" rel=\"nofollow noreferrer\"><code>decl_storage</code> proc_macro</a> , <a href=\"https://github.com/paritytech/substrate/blob/e0daf600287f1212d2c41a5b3d1b92921391e7ab/core/storage/procedural/src/storage/transformation.rs#L51\" rel=\"nofollow noreferrer\"><code>decl_storage_impl</code></a>"}], "answers": [{"tags": [], "owner": {"reputation": 9375, "user_id": 1396977, "user_type": "registered", "accept_rate": 82, "profile_image": "https://i.stack.imgur.com/PylBh.jpg?s=128&g=1", "display_name": "Shawn Tabrizi", "link": "https://stackoverflow.com/users/1396977/shawn-tabrizi"}, "is_accepted": false, "score": 1, "last_activity_date": 1558293829, "last_edit_date": 1558293829, "creation_date": 1558293514, "answer_id": 56211222, "question_id": 56200408, "link": "https://stackoverflow.com/questions/56200408/what-does-impl-trait-x-for-y-as-z-mean-inside-of-substrates-decl-storage-macro/56211222#56211222", "title": "What does impl trait X for Y as Z mean inside of Substrate&#39;s decl_storage macro?", "body": "<p>The line <code>trait Store for Module&lt;T: Trait&gt; as NAME</code> is macro magic. That line as written is not valid Rust, but it gets converted to valid Rust code through the <code>decl_storage!</code> macro.</p>\n\n<p>Ultimately, <code>as Indices</code> makes it so that Substrate generates a user friendly alias (<code>Indices</code>) in the Substrate metadata for this storage item.</p>\n\n<p>For example, you could name your storage something like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>decl_storage! {\n    trait Store for Module&lt;T: Trait&gt; as KittyStorage {\n        Value: map T::AccountId =&gt; u64;\n    }\n}\n</code></pre>\n\n<p>It would appear in the Polkadot UI like so:</p>\n\n<p><a href=\"https://i.stack.imgur.com/sCUBS.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/sCUBS.png\" alt=\"enter image description here\"></a></p>\n\n<p>The name you choose here does not matter other than how you want your storage name to appear to the outside world.</p>\n"}], "owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 123, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558293829, "creation_date": 1558193583, "last_edit_date": 1558293254, "question_id": 56200408, "link": "https://stackoverflow.com/questions/56200408/what-does-impl-trait-x-for-y-as-z-mean-inside-of-substrates-decl-storage-macro", "title": "What does impl trait X for Y as Z mean inside of Substrate&#39;s decl_storage macro?", "body": "<p>What does <code>as Indices</code> mean in the <a href=\"https://github.com/paritytech/substrate/blob/89a9556e30404a2772b9e235c631179f0c5e8d78/srml/indices/src/lib.rs#L91\" rel=\"nofollow noreferrer\">following Substrate storage definition</a>?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>decl_storage! {\n    trait Store for Module&lt;T: Trait&gt; as Indices { ... }\n}\n</code></pre>\n\n<p>I have read the <strong>Advanced Traits</strong> section in the docs but the syntax for <code>trait</code> keyword doesn't consider any option labeled as <code>as</code>.</p>\n"}, {"tags": ["enums", "rust", "lifetime"], "answers": [{"tags": [], "owner": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "is_accepted": true, "score": 1, "last_activity_date": 1558273461, "last_edit_date": 1558273461, "creation_date": 1558180396, "answer_id": 56198664, "question_id": 56198573, "link": "https://stackoverflow.com/questions/56198573/does-returning-a-type-with-static-tell-the-compiler-this-value-doesnt-have-an/56198664#56198664", "title": "Does returning a type with &#39;static tell the compiler this value doesn&#39;t have an associated lifetime or does it make that value static?", "body": "<p>It's exactly what it seems to be: You are telling the compiler that the type returned by <code>from_u16</code> will have a lifetime of <code>'static</code> associated with it. This lifetime is carried with the enum type itself, not a specific variant.</p>\n\n<p>The type <code>Sometimes&lt;'static&gt;</code> is different from any other type <code>Sometime&lt;'a&gt;</code> unless <code>'a</code> is <code>'static</code>. For example, you may not be able to call/return from a function <code>fn foobar&lt;'a&gt;(foo: Sometime&lt;'a&gt;) -&gt; ...</code> with values returned from <code>from_u16</code> unless <code>'a</code> can be made to be <code>'static</code> (the compiler will yell at you for promising a generic lifetime <code>'a</code> but using a specific lifetime <code>'static</code> and not being able to prove that <code>'a</code> is in fact <code>'static</code>).</p>\n\n<p>Another consequence is that you can't change the value of the thing returned by <code>from_u16</code> to <code>Sometimes::Borrow(&amp;mut u16)</code> unless that reference is <code>'static</code> (which may be what you want). Consider a function <code>foobar</code> as above, where the compiler figured that <code>'a</code> is <code>'static</code> as it was passed what was returned from <code>from_u16</code>. Now some code somewhere mutates the values to be a <code>Sometimes::Borrow</code>. This is safe only if the lifetime associated with <code>Sometimes::Borrow</code> is still <code>'static</code> all along, otherwise <code>foobar</code> now handles what it supposed was a <code>'static</code> lifetime but is, in fact, a dangling reference. That's a paddling.</p>\n\n<p>So no, you can't guide the compiler that there is a variant of enum where the lifetime does not matter. The instance returned is not <code>'static</code> by itself, it just carries an associated lifetime of <code>'static</code> wherever it goes and the compiler will complain if you try to return some generic lifetime but actually return <code>'static</code>.</p>\n"}], "owner": {"reputation": 604, "user_id": 8908931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0e9a2630c9ff44937efd1bcb036b018e?s=128&d=identicon&r=PG&f=1", "display_name": "OriBS", "link": "https://stackoverflow.com/users/8908931/oribs"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 62, "favorite_count": 0, "accepted_answer_id": 56198664, "answer_count": 1, "score": 1, "last_activity_date": 1558273461, "creation_date": 1558179565, "last_edit_date": 1558273425, "question_id": 56198573, "link": "https://stackoverflow.com/questions/56198573/does-returning-a-type-with-static-tell-the-compiler-this-value-doesnt-have-an", "title": "Does returning a type with &#39;static tell the compiler this value doesn&#39;t have an associated lifetime or does it make that value static?", "body": "<p>I have an enum with a \"partial\" lifetime: one of its variants contains a borrowed value, and another contains an owning value. I have a function which always returns an enum with the owning variant. In order to make the compiler happy, I have to state that the lifetime for the returned enum is <code>'static</code>.</p>\n\n<p>My question is about the real lifetime of the returned enum:</p>\n\n<p>By stating that the lifetime is <code>'static</code>, am I just guiding the compiler this enum doesn't have an associated lifetime or am I actually turning that instance to be static?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub enum Sometimes&lt;'a&gt; {\n    Own(u16),\n    Borrow(&amp;'a mut u16),\n}\n\nimpl&lt;'a&gt; Sometimes&lt;'a&gt; {\n    pub fn from_u16(data: u16) -&gt; Sometimes&lt;'static&gt; {\n        Sometimes::Own(data)\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "macros"], "answers": [{"tags": [], "owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "is_accepted": true, "score": 1, "last_activity_date": 1558168792, "last_edit_date": 1558168792, "creation_date": 1558168450, "answer_id": 56197288, "question_id": 56197213, "link": "https://stackoverflow.com/questions/56197213/how-can-i-implement-complicated-macros-like-format-args-in-user-space/56197288#56197288", "title": "How can I implement complicated macros like `format_args!` in user space?", "body": "<p>Complex macros are usually implemented as <em>procedural macros</em>, which you can learn more about in <a href=\"https://doc.rust-lang.org/book/ch19-06-macros.html#procedural-macros-for-generating-code-from-attributes\" rel=\"nofollow noreferrer\"><em>The Rust Programming Language</em></a> or in <a href=\"https://doc.rust-lang.org/reference/procedural-macros.html#procedural-macros\" rel=\"nofollow noreferrer\"><em>The Rust Reference</em></a> books.</p>\n\n<p>You can also achieve very complex things with the so called <em>declarative macros</em>, look at the excellent <a href=\"https://danielkeep.github.io/tlborm/book/index.html\" rel=\"nofollow noreferrer\"><em>The Little Book of Rust Macros</em></a>.</p>\n\n<p>There are several talks about these on YouTube, but you may find the following in particular very interesting, which was given at the RustConf 2018, My Little Procedural Macro by Chris Wong:</p>\n\n<p><a href=\"https://youtu.be/11Bme1xw0ag\" rel=\"nofollow noreferrer\"><img src=\"https://i3.ytimg.com/vi/11Bme1xw0ag/maxresdefault.jpg\" alt=\"youtube\"></a></p>\n"}], "owner": {"reputation": 777, "user_id": 6863221, "user_type": "registered", "accept_rate": 60, "profile_image": "https://lh4.googleusercontent.com/-f5m1FK2hI1s/AAAAAAAAAAI/AAAAAAAAABw/o6L7n6Vydlw/photo.jpg?sz=128", "display_name": "Matthias", "link": "https://stackoverflow.com/users/6863221/matthias"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 124, "favorite_count": 0, "accepted_answer_id": 56197288, "answer_count": 1, "score": 0, "last_activity_date": 1558275919, "creation_date": 1558167803, "last_edit_date": 1558275919, "question_id": 56197213, "link": "https://stackoverflow.com/questions/56197213/how-can-i-implement-complicated-macros-like-format-args-in-user-space", "title": "How can I implement complicated macros like `format_args!` in user space?", "body": "<p>I like that Rust comes with a lot of macros which moves computation to compile-time instead of repeatably to run-time.</p>\n\n<p><code>print!</code> and all its variants using <code>format_args!</code> <a href=\"https://github.com/rust-lang/rust/blob/df41e4f695a057fb14fdbc63b9009dafe4d7f681/src/libstd/macros.rs#L521\" rel=\"nofollow noreferrer\">See source code</a> are great examples.</p>\n\n<p>Unfortunately, in the source code you see the comment <em><code>/* compiler built-in */</code></em> instead of a implementation direct in the source file.</p>\n\n<p>Does Rust have the capability to let the user write such complex logic as a macro as well? If so, how can I do so?</p>\n"}, {"tags": ["hash", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558277142, "post_id": 56197060, "comment_id": 99039034, "body": "Idiomatic Rust uses <code>snake_case</code> for variables, methods, macros, fields and modules; <code>UpperCamelCase</code> for types and enum variants; and <code>SCREAMING_SNAKE_CASE</code> for statics and constants. Use <code>first_name</code> and <code>last_name</code> instead, please."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1558277230, "post_id": 56197060, "comment_id": 99039062, "body": "The code you have provided isn&#39;t valid Rust syntax and contains typos, which demonstrates that you haven&#39;t even attempted to run the code."}], "answers": [{"tags": [], "owner": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "is_accepted": false, "score": 5, "last_activity_date": 1558277284, "last_edit_date": 1558277284, "creation_date": 1558179658, "answer_id": 56198580, "question_id": 56197060, "link": "https://stackoverflow.com/questions/56197060/how-do-i-hash-a-struct-using-a-type-that-implements-the-digest-trait-from-the-sh/56198580#56198580", "title": "How do I hash a struct using a type that implements the Digest trait from the sha2 crate, such as Sha256?", "body": "<p><a href=\"https://stackoverflow.com/q/25413201/155423\">You can't implement an external trait for an external type</a>.</p>\n\n<p>Your issue is that the <code>digest</code> types, like <code>Sha256</code>, don't implement <code>Hasher</code> - because they're different kinds of hashes. The <code>Hasher</code> trait is for types which hash data <a href=\"https://doc.rust-lang.org/std/hash/trait.Hasher.html#tymethod.finish\" rel=\"nofollow noreferrer\">into a 64 bit hash value</a>, for use in Rust's own code, like <code>HashMap</code>. <code>Sha256</code>, on the other hand, gives a hash of <strong>32 bytes</strong>.</p>\n\n<p>To use <code>Sha256</code>, you need to manually feed it the bytes you want to compute the hash of - you can do this in an <code>impl</code> block.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Person {\n    fn id(&amp;self) -&gt; sha2::digest::generic_array::GenericArray&lt;u8, &lt;Sha256 as Digest&gt;::OutputSize&gt; {\n        let mut s = Sha256::new();\n        s.input(self.firstName.as_bytes());\n        s.input(self.lastName.as_bytes());\n        s.result()\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 807, "user_id": 2609301, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/0dd738a4d38dc9458c30b18fc5e997c7?s=128&d=identicon&r=PG", "display_name": "Marais Rossouw", "link": "https://stackoverflow.com/users/2609301/marais-rossouw"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 681, "favorite_count": 0, "answer_count": 1, "score": 3, "last_activity_date": 1558277546, "creation_date": 1558166172, "last_edit_date": 1558277546, "question_id": 56197060, "link": "https://stackoverflow.com/questions/56197060/how-do-i-hash-a-struct-using-a-type-that-implements-the-digest-trait-from-the-sh", "title": "How do I hash a struct using a type that implements the Digest trait from the sha2 crate, such as Sha256?", "body": "<p>I'm trying to <code>Sha256</code> hash a struct to generate a GUID for that struct based on its contents.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use sha2::{Digest, Sha256};\nuse std::hash::{Hash, Hasher};\n\n#[derive(Hash)]\nstruct Person {\n  firstName: String;\n  lastName: String;\n}\n\nlet a = Person {\n   firstName: \"bob\".to_string(),\n   lastName: \"the builder\".to_string()\n}\n\nlet mut s = Sha256::new();\na.hash(&amp;mut s);\nprintln!(\"{}\", s.finsih());\n</code></pre>\n\n<p>My stretch goal would be to simply use <code>a.id()</code> which would hash all the properties on that struct. Is this a <code>impl Person { id() -&gt; String }</code>? </p>\n\n<p>I tried using <code>impl x for y</code> but that threw a <code>impl doesn't use types inside crate</code></p>\n\n<pre><code>impl Hasher for Sha256 {\n    fn finish(&amp;self) -&gt; u64 {\n        self.0.result()\n    }\n\n    fn write(&amp;mut self, msg: &amp;[u8]) {\n        self.0.input(msg)\n    }\n}\n</code></pre>\n"}, {"tags": ["rust", "iterator"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558158307, "post_id": 56195957, "comment_id": 99016449, "body": "For the line <code>&quot;However, I&#39;m not sure about the semantics.&quot;</code>, should your iterator skip the line or return <code>&quot;not&quot;</code>? From reading your explanation, I&#39;d expect the latter, but your code does the former."}], "answers": [{"comments": [{"owner": {"reputation": 939, "user_id": 11140945, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/j5Esk.png?s=128&g=1", "display_name": "Listerone", "link": "https://stackoverflow.com/users/11140945/listerone"}, "edited": false, "score": 0, "creation_date": 1558187153, "post_id": 56196409, "comment_id": 99022203, "body": "Yes, that&#39;s it. There are so many iterators that return <code>Result</code>, this couldn&#39;t have been an uncommon situation. Thanks."}], "tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 1, "last_activity_date": 1558169989, "last_edit_date": 1558169989, "creation_date": 1558159382, "answer_id": 56196409, "question_id": 56195957, "link": "https://stackoverflow.com/questions/56195957/simple-implementation-to-get-iterator-of-first-word-of-each-line-of-input/56196409#56196409", "title": "Simple implementation to get iterator of first word of each line of input", "body": "<p>You can replace your <code>match</code> expression with <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.transpose\" rel=\"nofollow noreferrer\"><code>Result::transpose()</code></a>. I would also suggest to split out the function returning the first word to make the code more readable. Finally, you don't need to accept <code>&amp;'a mut impl Read</code> \u2013 simply accepting <code>impl Read</code> instead will work as well, since there is a <a href=\"https://doc.rust-lang.org/std/io/trait.Read.html#impl-Read-14\" rel=\"nofollow noreferrer\">forwarding implementation</a> that implements <code>Read</code> for <code>&amp;mut impl Read</code>. Together, the simplified code could look like this:</p>\n\n<pre><code>fn first_word(s: String) -&gt; Option&lt;String&gt; {\n    s.split_whitespace()\n        .next()\n        .filter(|word| word.chars().all(char::is_alphabetic))\n        .map(From::from)\n}\n\nfn get_first_words(r: impl Read) -&gt; impl Iterator&lt;Item = Result&lt;String&gt;&gt; {\n    BufReader::new(r)\n        .lines()\n        .filter_map(|line| line.map(first_word).transpose())\n}\n</code></pre>\n\n<p>Edit: Using <code>impl Read</code> instead of <code>&amp;mut impl Read</code> will result in mutable references being moved into the function rather than being implicitly reborrowed, so maybe it's not a good idea after all, since it will be confusing to remember to explicitly reborrow them where necessary.</p>\n"}], "owner": {"reputation": 939, "user_id": 11140945, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/j5Esk.png?s=128&g=1", "display_name": "Listerone", "link": "https://stackoverflow.com/users/11140945/listerone"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 332, "favorite_count": 1, "accepted_answer_id": 56196409, "answer_count": 1, "score": 0, "last_activity_date": 1558169989, "creation_date": 1558153605, "last_edit_date": 1558154353, "question_id": 56195957, "link": "https://stackoverflow.com/questions/56195957/simple-implementation-to-get-iterator-of-first-word-of-each-line-of-input", "title": "Simple implementation to get iterator of first word of each line of input", "body": "<p>I needed an iterator that streams the first alphabetic word of each line of an implementation of <code>Read</code>. This iterator:</p>\n\n<ul>\n<li>Returns an error if reading the input failed</li>\n<li>Returns an iterator of strings, each representing an alphabetic word</li>\n<li>ignores empty strings or first words containing characters other than <code>[a-zA-Z]</code></li>\n</ul>\n\n<p>I eventually ended up with the following implementation (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a5068dbc2ba0144afd7d2e1c5246a326\" rel=\"nofollow noreferrer\">test here</a>):</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn get_first_words&lt;'a&gt;(r: &amp;'a mut impl Read) -&gt; impl Iterator&lt;Item = Result&lt;String&gt;&gt; + 'a {\n    BufReader::new(r).lines().filter_map(|rline| {\n        match rline.map(|line| {\n            line.split_whitespace()\n                .next()\n                .filter(|word| word.chars().all(char::is_alphabetic))\n                .map(&amp;str::to_string)\n        }) {\n            Err(e) =&gt; Some(Err(e)),\n            Ok(Some(w)) =&gt; Some(Ok(w)),\n            Ok(None) =&gt; None,\n        }\n    })\n}\n</code></pre>\n\n<p>This works fine but was more complex than I had expected. There are nested iterators in this implementation, and there was some type juggling in order to keep <code>Result</code> as the wrapping type while filtering on the contained values. </p>\n\n<p>Could this have been written more simply, with less nested logic and with less type juggling? </p>\n"}, {"tags": ["linux", "rust", "raspberry-pi", "arm", "cross-compiling"], "answers": [{"tags": [], "owner": {"reputation": 4172, "user_id": 3508956, "user_type": "registered", "accept_rate": 58, "profile_image": "https://i.stack.imgur.com/umLTo.jpg?s=128&g=1", "display_name": "laptou", "link": "https://stackoverflow.com/users/3508956/laptou"}, "is_accepted": true, "score": 3, "last_activity_date": 1558150292, "creation_date": 1558150292, "answer_id": 56195752, "question_id": 56195677, "link": "https://stackoverflow.com/questions/56195677/how-to-cross-compile-rust-code-for-the-raspberry-pi-zero-w/56195752#56195752", "title": "How to cross-compile Rust code for the Raspberry Pi Zero W", "body": "<p>It worked when I set an environment variable:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>$ export CC=\"/home/ibi/x-tools/arm-unknown-linux-gnueabihf/bin/arm-unknown-linux-gnueabihf-gcc\"\n</code></pre>\n"}], "owner": {"reputation": 4172, "user_id": 3508956, "user_type": "registered", "accept_rate": 58, "profile_image": "https://i.stack.imgur.com/umLTo.jpg?s=128&g=1", "display_name": "laptou", "link": "https://stackoverflow.com/users/3508956/laptou"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 805, "favorite_count": 1, "accepted_answer_id": 56195752, "answer_count": 1, "score": 3, "last_activity_date": 1558150292, "creation_date": 1558149145, "question_id": 56195677, "link": "https://stackoverflow.com/questions/56195677/how-to-cross-compile-rust-code-for-the-raspberry-pi-zero-w", "title": "How to cross-compile Rust code for the Raspberry Pi Zero W", "body": "<p>I am attempting to cross-compile Rust code on my 64-bit x86 laptop to run on the Raspberry Pi Zero W. I installed the <code>arm-unknown-linux-gnueabihf</code> toolchain using Rustup, but when I run <code>cargo build --target arm-unknown-linux-gnueabihf</code>, I get this error:</p>\n\n<blockquote>\n  <p>Internal error occurred: Failed to find tool. Is <code>arm-linux-gnueabihf-gcc</code> installed?</p>\n</blockquote>\n\n<p>I tried to install the <a href=\"https://aur.archlinux.org/packages/arm-linux-gnueabihf-gcc/\" rel=\"nofollow noreferrer\"><code>arm-linux-gnueabihf-gcc</code> package from AUR</a>, but that kept failing because of some sort of GPG key error, so I just decided to make my own cross-compiler using crosstool-ng.</p>\n\n<p>I tried to point Cargo at my newly built cross-compiler using a <code>~/.cargo/config</code> file:</p>\n\n<pre><code>[target.arm-unknown-linux-gnueabihf]\nlinker = \"/home/ibi/x-tools/arm-unknown-linux-gnueabihf/bin/arm-unknown-linux-gnueabihf-gcc\"\n</code></pre>\n\n<p>But Cargo seems to be ignoring this and giving me the same error. How do I fix this?</p>\n"}, {"tags": ["sqlite", "rust", "rust-cargo"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1558138240, "post_id": 56194885, "comment_id": 99014128, "body": "<code>features = [&quot;blob&quot;]</code> ..."}, {"owner": {"reputation": 88, "user_id": 11309069, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6689801423b1e6057462161b7b743974?s=128&d=identicon&r=PG&f=1", "display_name": "PineconeDude", "link": "https://stackoverflow.com/users/11309069/pineconedude"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1558142761, "post_id": 56194885, "comment_id": 99014683, "body": "@Stargateur This works! Thank you!"}], "owner": {"reputation": 88, "user_id": 11309069, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6689801423b1e6057462161b7b743974?s=128&d=identicon&r=PG&f=1", "display_name": "PineconeDude", "link": "https://stackoverflow.com/users/11309069/pineconedude"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 98, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1558137765, "creation_date": 1558137765, "question_id": 56194885, "link": "https://stackoverflow.com/questions/56194885/error-could-not-find-blob-in-rusqlite", "title": "Error: Could not find &#39;blob&#39; in &#39;rusqlite&#39;", "body": "<p>I'm trying to read/write blob data from a .sqlite file using Rust and rusqlite; however, Cargo is telling me <code>blob</code> does not exist in rusqlite.\nHere is the example code I was testing with from <a href=\"https://docs.rs/rusqlite/0.18.0/rusqlite/blob/index.html\" rel=\"nofollow noreferrer\">the documentation</a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use rusqlite::blob::ZeroBlob;\nuse rusqlite::{Connection, DatabaseName, NO_PARAMS};\nuse std::error::Error;\nuse std::io::{Read, Seek, SeekFrom, Write};\n\nfn main() -&gt; Result&lt;(), Box&lt;Error&gt;&gt; {\n    let db = Connection::open_in_memory()?;\n    db.execute_batch(\"CREATE TABLE test (content BLOB);\")?;\n    db.execute(\n        \"INSERT INTO test (content) VALUES (ZEROBLOB(10))\",\n        NO_PARAMS,\n    )?;\n\n    let rowid = db.last_insert_rowid();\n    let mut blob = db.blob_open(DatabaseName::Main, \"test\", \"content\", rowid, false)?;\n\n    /* snip */\n\n    Ok(())\n}\n</code></pre>\n\n<p>Here is my Cargo.toml file:</p>\n\n<pre><code>[package]\n# ...\n\n[dependencies]\n\n    [dependencies.rusqlite]\n    version = \"0.18.0\"\n    features = [\"bundled\"]\n</code></pre>\n\n<p>It should be noted that I had to use the <code>bundled</code> method as the standard <code>rusqlite = \"0.18.0\"</code> did not work for me. The documentation says <code>blob</code> is only supposed to work with SQLite 3.7.4 and higher, but I don't see any reason that I would have an older version, and I also don't know how to check. Any ideas?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 7716, "user_id": 4639273, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ae38603d40c633012992337a32330fa0?s=128&d=identicon&r=PG", "display_name": "SCappella", "link": "https://stackoverflow.com/users/4639273/scappella"}, "is_accepted": true, "score": 2, "last_activity_date": 1558138853, "creation_date": 1558138853, "answer_id": 56194976, "question_id": 56194680, "link": "https://stackoverflow.com/questions/56194680/passing-stringas-str-to-optionstringmap-fails-to-compile-with-a-type-mis/56194976#56194976", "title": "Passing String::as_str to Option&lt;String&gt;::map() fails to compile with a type mismatch error", "body": "<p>The problem is that <code>String::as_str</code> expects a reference to a <code>String</code> rather than the <code>String</code> itself. <code>String::as_str</code>'s signature is <code>fn as_str(&amp;self) -&gt; &amp;str</code>, so you can see that it takes <code>self</code> (the <code>String</code>) as a reference.</p>\n\n<p>To interpret the error message, look at the \"expected\" vs \"found\". In the \"expected\" part of the message, we see <code>fn(std::string::String) -&gt; _</code>, so it's expecting a function that takes <code>std::string::String</code> (i.e. <code>String</code>) and returns some irrelevant type (<code>_</code>). In the \"found\" part of the message however, we find <code>for&lt;'r&gt; fn(&amp;'r std::string::String) -&gt; _</code>. This is harder to understand since it uses an idea that's rarely seen in Rust code.</p>\n\n<p>The <code>for&lt;'r&gt;</code> part means that the function should be generic with respect to the lifetime. It should accept any lifetime and a <code>String</code> with that lifetime. The output type can also have the given lifetime. Usually a function like this has a signature like <code>fn foo(x: &amp;T) -&gt; &amp;U</code> and the lifetimes are implicitly added. This is exactly what <code>String::as_str</code> is.</p>\n\n<p>One way to fix your code is to ensure that a reference is passed to <code>map</code>. Something like <code>let _switcheroo = hello.as_ref().map(String::as_str);</code> should work.</p>\n"}], "owner": {"reputation": 6509, "user_id": 356011, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/d17ff41be1044be6fb5ef186b83efb20?s=128&d=identicon&r=PG", "display_name": "marathon", "link": "https://stackoverflow.com/users/356011/marathon"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 154, "favorite_count": 0, "closed_date": 1558454957, "accepted_answer_id": 56194976, "answer_count": 1, "score": 2, "last_activity_date": 1558454978, "creation_date": 1558135350, "last_edit_date": 1558454978, "question_id": 56194680, "link": "https://stackoverflow.com/questions/56194680/passing-stringas-str-to-optionstringmap-fails-to-compile-with-a-type-mis", "closed_reason": "Duplicate", "title": "Passing String::as_str to Option&lt;String&gt;::map() fails to compile with a type mismatch error", "body": "<p>The second <code>map</code> statement in this code fails to compile.</p>\n\n<pre><code>fn main() {\n    let hello = Some(\"hello\");\n    let _switcheroo = hello.map(str::to_string); //ok\n\n    let hello = Some(\"hello\".to_string());\n    let _switcheroo = hello.map(String::as_str); //not ok\n}\n</code></pre>\n\n<p>The error is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0631]: type mismatch in function arguments\n --&gt; src/main.rs:6:29\n  |\n6 |     let _switcheroo = hello.map(String::as_str); //not ok\n  |                             ^^^\n  |                             |\n  |                             expected signature of `fn(std::string::String) -&gt; _`\n  |                             found signature of `for&lt;'r&gt; fn(&amp;'r std::string::String) -&gt; _`\n</code></pre>\n\n<p>I would expect an error about borrowing some moved data. What is this error trying to say?</p>\n\n<p>This does compile:</p>\n\n<pre><code>let hello = Some(\"hello\".to_string());\nlet _switcheroo = hello.as_ref().map(String::as_str); //ok\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 2659, "user_id": 8050514, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/6CRdl.jpg?s=128&g=1", "display_name": "Optimistic Peach", "link": "https://stackoverflow.com/users/8050514/optimistic-peach"}, "is_accepted": true, "score": 1, "last_activity_date": 1558128260, "last_edit_date": 1558128260, "creation_date": 1558127803, "answer_id": 56193675, "question_id": 56193397, "link": "https://stackoverflow.com/questions/56193397/is-it-possible-to-do-destructuring-assignment-with-type-annotations/56193675#56193675", "title": "Is it possible to do destructuring assignment with type annotations?", "body": "<p>Casts cannot be performed during type destructuring. This is because you cannot annotate the type that will be contained in the type you're destructuring, therefore it doesn't depend on you, and instead on the type that is being destructured. For example:</p>\n\n<pre><code>struct Point {\n    x: f32,\n    y: f32,\n}\nlet myOtherPoint = Point { x: 0, y: 0 };\nlet Point {x, y} = myOtherPoint;\n</code></pre>\n\n<p>The type of <code>x</code> and <code>y</code> are defined by the type <code>Point</code>. This can, on the other hand be changed in the case of tuples and arrays:</p>\n\n<pre><code>fn main() {\n    let [x, y, z]: [f32; 3] = [1.2, 2.3, 3.4];\n    let (x, y, z): (usize, f32, String) = (1, 2.3, \"3.4\".into());\n}\n</code></pre>\n\n<p>This is mostly because of type annotations needed for tuples when writing function signatures:</p>\n\n<pre><code>fn foo((a, b, c): (usize, f32, String)) {}\n</code></pre>\n\n<p>But this is only because tuples are not named types, per se, so there is a need to name the tuple, by annotating the type. On the other hand, <code>struct</code>s and <code>enum</code>s are named and therefore destructurable. </p>\n\n<hr>\n\n<p>The solution to your specific issue described in the body, and not the title:<br>\nUse a separate variable with shadowing to preserve usability. Note too, that the floating point types (<code>f32</code> and <code>f64</code>) cannot be overflowed (<a href=\"https://doc.rust-lang.org/std/f32/constant.INFINITY.html\" rel=\"nofollow noreferrer\">They have an infinity</a>), only integers (<code>[u, i][size, 8, 16, 32, 64, 128]</code>). </p>\n\n<pre><code>fn area(x: Rectangle) -&gt; f64 {\n    // Here's where I'd like have type annotations\n    // while doing destructuring assignment:\n    let Rectangle {\n        p1: Point { x: x1, y: y1 },\n        p2: Point { x: x2, y: y2 },\n    } = rect;\n\n    let (x1, x2, y1, y2) = (x1 as f64, x2 as f64,\n                            y1 as f64, y2 as f64);\n\n    ((x2 - x1) * (y2 - y1)).abs()\n}\n</code></pre>\n"}], "owner": {"reputation": 2757, "user_id": 1042144, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8d1bc195cf067a719735316e970a5449?s=128&d=identicon&r=PG", "display_name": "Brian Kung", "link": "https://stackoverflow.com/users/1042144/brian-kung"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 490, "favorite_count": 1, "accepted_answer_id": 56193675, "answer_count": 1, "score": 1, "last_activity_date": 1558144434, "creation_date": 1558126210, "last_edit_date": 1558144434, "question_id": 56193397, "link": "https://stackoverflow.com/questions/56193397/is-it-possible-to-do-destructuring-assignment-with-type-annotations", "title": "Is it possible to do destructuring assignment with type annotations?", "body": "<p>The overall question is how to do nested destructuring assignment with type annotations. I'm multiplying two <code>f32</code> values, but I'm unsure what will happen if the multiple overflows. Therefore, I'd like to assign them as <code>f64</code> values in order to prevent the overflow.</p>\n\n<p>This example is lightly modified from Rust By Example's chapter on <a href=\"https://doc.rust-lang.org/rust-by-example/custom_types/structs.html\" rel=\"nofollow noreferrer\">structures:</a></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Point {\n    x: f32,\n    y: f32,\n}\n\nstruct Rectangle {\n    p1: Point,\n    p2: Point,\n}\n\nfn area(rect: Rectangle) -&gt; f64 {\n    // Here's where I'd like have type annotations\n    // while doing destructuring assignment:\n    let Rectangle {\n        p1: Point { x: x1, y: y1 },\n        p2: Point { x: x2, y: y2 },\n    } = rect;\n\n    ((x2 - x1) * (y2 - y1)).abs() as f64\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 1, "creation_date": 1558121737, "post_id": 56192300, "comment_id": 99009781, "body": "I found the problem, <code>cargo build</code> passes <code>-nodefaultlibs</code> flag to the linker, and it doesn&#39;t link against LIBC. How do I tell cargo to remove this flag when it invokes <code>CC</code> to link the final binary?"}, {"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 1, "creation_date": 1558124130, "post_id": 56192300, "comment_id": 99010692, "body": "solved it adding <code>rustflags = [&quot;-C&quot;, &quot;link-args=-lc&quot;]</code> to <code>.cargo&#47;config</code> file"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1558128633, "post_id": 56192300, "comment_id": 99012164, "body": "You seem to be in good position to answer your own question."}], "answers": [{"tags": [], "owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "is_accepted": false, "score": 3, "last_activity_date": 1558130812, "creation_date": 1558130812, "answer_id": 56194124, "question_id": 56192300, "link": "https://stackoverflow.com/questions/56192300/undefined-reference-to-printf-in-rust/56194124#56194124", "title": "undefined reference to `printf&#39; in Rust", "body": "<p>solved it adding \n    <code>rustflags = [\"-C\", \"link-args=-lc\"]</code> </p>\n\n<p>to <code>.cargo/config</code> under the package root directory.</p>\n"}], "owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 576, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1558130812, "creation_date": 1558120407, "last_edit_date": 1558121051, "question_id": 56192300, "link": "https://stackoverflow.com/questions/56192300/undefined-reference-to-printf-in-rust", "title": "undefined reference to `printf&#39; in Rust", "body": "<p>Why isn't this code compiling ? (x86_64, Ubuntu Linux)</p>\n\n<p><strong>main.rs</strong></p>\n\n<pre><code>#![feature(lang_items)]\n#![no_std]\n#![no_main]\nextern crate libc;\n\n#[no_mangle]\npub extern \"C\" fn main(_argc: isize, _argv: *const *const u8) -&gt; isize {\n    // Since we are passing a C string the final null character is mandatory\n    const HELLO: &amp;'static str = \"Hello, world!\\n\\0\";\n    unsafe {\n        libc::printf(HELLO.as_ptr() as *const _);\n    }\n    0\n}\n\n#[panic_handler]\nfn my_panic(_info: &amp;core::panic::PanicInfo) -&gt; ! {\n    loop {}\n}\n\n#[lang = \"eh_personality\"]\nextern \"C\" fn eh_personality() {}\n</code></pre>\n\n<p><strong>Cargo.toml</strong></p>\n\n<pre><code>[package]\nname = \"decaddr\"\nversion = \"0.1.0\"\nauthors = [\"niko\"]\nedition = \"2018\"\n\n[dependencies]\nlibc = { version = \"0.2\" , features = [\"extra_traits\"] }\n\n[profile.dev]\npanic = \"abort\"\n\n[profile.release]\npanic = \"abort\"\n</code></pre>\n\n<p>The error is :</p>\n\n<pre><code>  niko@lap:~/rustcode/decaddr$ cargo build --verbose\n       Fresh libc v0.2.55\n   Compiling decaddr v0.1.0 (/home/niko/rustcode/decaddr)\n     Running `rustc --edition=2018 --crate-name decaddr src/main.rs --color always --crate-type bin --emit=dep-info,link -C panic=abort -C debuginfo=2 -C metadata=df8e75f6f5ad2fb8 -C extra-filename=-df8e75f6f5ad2fb8 --out-dir /home/niko/rustcode/decaddr/target/debug/deps -C incremental=/home/niko/rustcode/decaddr/target/debug/incremental -L dependency=/home/niko/rustcode/decaddr/target/debug/deps --extern libc=/home/niko/rustcode/decaddr/target/debug/deps/liblibc-5f6fa16b68152311.rlib`\nerror: linking with `cc` failed: exit code: 1\n  |\n  = note: \"cc\" \"-Wl,--as-needed\" \"-Wl,-z,noexecstack\" \"-m64\" \"-L\" \"/home/niko/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"/home/niko/rustcode/decaddr/target/debug/deps/decaddr-df8e75f6f5ad2fb8.2eeyjncolvpqxm5x.rcgu.o\" \"/home/niko/rustcode/decaddr/target/debug/deps/decaddr-df8e75f6f5ad2fb8.31phrjq5za9cdsbr.rcgu.o\" \"-o\" \"/home/niko/rustcode/decaddr/target/debug/deps/decaddr-df8e75f6f5ad2fb8\" \"-Wl,--gc-sections\" \"-pie\" \"-Wl,-zrelro\" \"-Wl,-znow\" \"-nodefaultlibs\" \"-L\" \"/home/niko/rustcode/decaddr/target/debug/deps\" \"-L\" \"/home/niko/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-Wl,-Bstatic\" \"/home/niko/rustcode/decaddr/target/debug/deps/liblibc-5f6fa16b68152311.rlib\" \"/home/niko/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/librustc_std_workspace_core-29eb95682c6c4d0d.rlib\" \"/home/niko/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcore-3204fb057f1d714e.rlib\" \"/home/niko/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-ed9475e351b9a592.rlib\" \"-Wl,-Bdynamic\" \"-lutil\" \"-lutil\"\n  = note: /usr/lib/gcc/x86_64-linux-gnu/5/../../../x86_64-linux-gnu/Scrt1.o: In function `_start':\n          (.text+0x12): undefined reference to `__libc_csu_fini'\n          /usr/lib/gcc/x86_64-linux-gnu/5/../../../x86_64-linux-gnu/Scrt1.o: In function `_start':\n          (.text+0x19): undefined reference to `__libc_csu_init'\n          /usr/lib/gcc/x86_64-linux-gnu/5/../../../x86_64-linux-gnu/Scrt1.o: In function `_start':\n          (.text+0x25): undefined reference to `__libc_start_main'\n          /home/niko/rustcode/decaddr/target/debug/deps/decaddr-df8e75f6f5ad2fb8.31phrjq5za9cdsbr.rcgu.o: In function `main':\n          /home/niko/rustcode/decaddr/src/main.rs:11: undefined reference to `printf'\n          collect2: error: ld returned 1 exit status\n\n\nerror: aborting due to previous error\n\nerror: Could not compile `decaddr`.\n\nCaused by:\n  process didn't exit successfully: `rustc --edition=2018 --crate-name decaddr src/main.rs --color always --crate-type bin --emit=dep-info,link -C panic=abort -C debuginfo=2 -C metadata=df8e75f6f5ad2fb8 -C extra-filename=-df8e75f6f5ad2fb8 --out-dir /home/niko/rustcode/decaddr/target/debug/deps -C incremental=/home/niko/rustcode/decaddr/target/debug/incremental -L dependency=/home/niko/rustcode/decaddr/target/debug/deps --extern libc=/home/niko/rustcode/decaddr/target/debug/deps/liblibc-5f6fa16b68152311.rlib` (exit code: 1)\nniko@lap:~/rustcode/decaddr$ \n</code></pre>\n"}, {"tags": ["rust", "substrate"], "comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 1, "creation_date": 1558110665, "post_id": 56189290, "comment_id": 99005564, "body": "Please keep your error messages as plain as possible, if the duplicate lang item error is not a concern it is better if you remove it from the post, as i removed unnecessary warnings. And please provide your minimum toml to test this code."}, {"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 1, "creation_date": 1558110880, "post_id": 56189290, "comment_id": 99005644, "body": "According to github page of parity_codec Input is not implemented for Vec but it is <a href=\"https://github.com/paritytech/parity-codec/blob/06a6bdd736a5d710bb5d51c44e67e5e448e2f079/src/codec.rs#L114\" rel=\"nofollow noreferrer\">implemented for slice of byte array</a> so you can pass your slice of your vector as Input like this : <code>UncheckedMortalExtrinsic::decode(&amp;v1[..])</code>"}, {"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "reply_to_user": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1558140064, "post_id": 56189290, "comment_id": 99014373, "body": "@&#214;merErden , I have solved the duplicated symbol error, it was due to using disabled default features in sr-primitives in Cargo.toml"}, {"owner": {"user_type": "does_not_exist", "display_name": "user3956566"}, "edited": false, "score": 1, "creation_date": 1558174098, "post_id": 56189290, "comment_id": 99019284, "body": "Do not edit the question to <a href=\"https://meta.stackoverflow.com/a/290704/3956566\">invalidate existing answers</a>."}, {"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 0, "creation_date": 1558175625, "post_id": 56189290, "comment_id": 99019580, "body": "@YvetteColomb , the question stays as before: <code>How to decode the extrinsic into a struct?</code>"}], "answers": [{"comments": [{"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 0, "creation_date": 1558122076, "post_id": 56192597, "comment_id": 99009922, "body": "Thanks, but just passing the Input won&#39;t convert raw extrinsic to a struct, there will be other errors, after providing correct input to <code>UncheckedMortalExtrinsic::decode</code> function"}, {"owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 0, "creation_date": 1558139981, "post_id": 56192597, "comment_id": 99014366, "body": "I have updated the question, it is now showing the next error."}, {"owner": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "reply_to_user": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "edited": false, "score": 1, "creation_date": 1558171985, "post_id": 56192597, "comment_id": 99018895, "body": "Don&#39;t update questions - you should instead ask a new question. Editing questions invalidates the answers you have already received, and stops others from getting help for the same problem as you had."}], "tags": [], "owner": {"reputation": 1602, "user_id": 5947247, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f5212b96ae435bb73b9980f34b2913e8?s=128&d=identicon&r=PG&f=1", "display_name": "Isaac van Bakel", "link": "https://stackoverflow.com/users/5947247/isaac-van-bakel"}, "is_accepted": false, "score": 0, "last_activity_date": 1558121843, "creation_date": 1558121843, "answer_id": 56192597, "question_id": 56189290, "link": "https://stackoverflow.com/questions/56189290/parity-codeccodecinput-is-not-implemented-for-vecu8-when-decoding-an-extri/56192597#56192597", "title": "parity_codec::codec::Input is not implemented for Vec&lt;u8&gt; when decoding an extrinsic into a struct", "body": "<blockquote>\n  <p>If so, how would one add this trait to Vec ?</p>\n</blockquote>\n\n<p>In your code, you can't. For coherence reasons, Rust says that an implementation of a trait X for a type Y must exist in the crate for X or the crate for Y.</p>\n\n<blockquote>\n  <p>Or better said, what are the functions from Susbtrate framework I am missing so the Input trait is automatically provided?</p>\n</blockquote>\n\n<p>If you <a href=\"https://crates.parity.io/parity_codec/trait.Input.html#implementors\" rel=\"nofollow noreferrer\">look at the \"Implementors\" part of the Input trait documentation</a> - you can see that every type that implements <code>std::io::Read</code> will implement <code>Input</code>.</p>\n\n<p>As the comments say, the implementation that is useful for you is the one on <code>&amp;[u8]</code>, which exists because it implements <code>std::io::Read</code>.</p>\n"}], "owner": {"reputation": 4733, "user_id": 922445, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/a469120d35647d9aa50646cb4d778c71?s=128&d=identicon&r=PG&f=1", "display_name": "Nulik", "link": "https://stackoverflow.com/users/922445/nulik"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 364, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558449970, "creation_date": 1558106130, "last_edit_date": 1558449970, "question_id": 56189290, "link": "https://stackoverflow.com/questions/56189290/parity-codeccodecinput-is-not-implemented-for-vecu8-when-decoding-an-extri", "title": "parity_codec::codec::Input is not implemented for Vec&lt;u8&gt; when decoding an extrinsic into a struct", "body": "<p>How would I decode the standard <a href=\"https://wiki.parity.io/Extrinsic\" rel=\"nofollow noreferrer\">Substrate extrinsic format</a> into a <code>Transaction</code> object in a way where it would be possible to get the <code>Sender</code>, preferably as a string? </p>\n\n<p>I have started with this code with a hardcoded sample extrinsic data for testing in the <code>extrinsic_hex</code> variable:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use hex::decode;\nuse hex_literal::hex;\nuse parity_codec::{Decode, Encode, Input};\nuse primitives::generic::UncheckedMortalExtrinsic;\nuse std::fmt;\nuse std::fmt::Debug;\n\nfn main() {\n    let extrinsic_hex: &amp;'static str =  \"81ffd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d3c6b8941e2976034e67bdd1a999c3eff4403c8ceaf717f18d9760ab18573ab2ce870e9b751c2f14dd9883e54746e1eb6639978ceab49968c25176cc0d2507205040003000ca10f\";\n    let result = hex::decode(extrinsic_hex);\n    match result {\n        Ok(v1) =&gt; {\n            let extr_option = UncheckedMortalExtrinsic::decode(&amp;mut v1);\n            ()\n        }\n        _ =&gt; {\n            println!(\"Error decoding\");\n            ()\n        }\n    }\n}\n</code></pre>\n\n<p>The error I get is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: duplicate lang item in crate `sr_io`: `panic_impl`.\n  |\n  = note: first defined in crate `std`.\n\nerror: duplicate lang item in crate `sr_io`: `oom`.\n  |\n  = note: first defined in crate `std`.\n\nerror[E0277]: the trait bound `std::vec::Vec&lt;u8&gt;: parity_codec::codec::Input` is not satisfied\n  --&gt; core/decaddr/src/main.rs:13:20\n   |\n13 |             let extr_option=UncheckedMortalExtrinsic::decode(&amp;mut v1);\n   |                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `parity_codec::codec::Input` is not implemented for `std::vec::Vec&lt;u8&gt;`\n   |\n   = note: required by `parity_codec::codec::Decode::decode`\n</code></pre>\n\n<p>Let's pretend that the error <code>error: duplicate lang item in crate</code>sr_io<code>:</code>panic_impl<code>.</code> doesn't exist for now. </p>\n\n<p>If I am understanding correctly, it doesn't work because <code>Vec</code> doesn't implement the <a href=\"https://crates.parity.io/parity_codec/trait.Input.html\" rel=\"nofollow noreferrer\"><code>parity_codec::Input</code> trait</a>, am I right? If so, how would one add this trait to <code>Vec</code>? Or better said, what are the functions from the Substrate framework I am missing so the <code>Input</code> trait is automatically provided?</p>\n"}, {"tags": ["rust", "rust-proc-macros"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1558104561, "post_id": 56188700, "comment_id": 99002723, "body": "Do you use the <a href=\"https://crates.io/crates/syn\" rel=\"nofollow noreferrer\"><code>syn</code> crate</a>?"}, {"owner": {"user_type": "does_not_exist", "display_name": "user7924331"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1558105874, "post_id": 56188700, "comment_id": 99003427, "body": "@FrenchBoiethios yes yes i do"}], "answers": [{"comments": [{"owner": {"user_type": "does_not_exist", "display_name": "user7924331"}, "edited": false, "score": 0, "creation_date": 1558289043, "post_id": 56198097, "comment_id": 99042421, "body": "Thank you very much for this answer! I&#39;ve been tearing my hair out for a day now :) You&#39;re a life saver! Couldn&#39;t find much documentation about attribute macros, this is awesome!"}, {"owner": {"reputation": 2244, "user_id": 1825860, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/b9e1d70a0cbe81683a016e700d3239bf?s=128&d=identicon&r=PG", "display_name": "AlphaModder", "link": "https://stackoverflow.com/users/1825860/alphamodder"}, "edited": false, "score": 1, "creation_date": 1558298615, "post_id": 56198097, "comment_id": 99044820, "body": "@StefanChircop Glad I could help! Procedural macros are a relatively new language feature, so the documentation is pretty sparse right now. Browsing the source of other procedural macro crates is a good way to learn how to do stuff right now. (As is asking here, of course!)"}, {"owner": {"user_type": "does_not_exist", "display_name": "user7924331"}, "edited": false, "score": 0, "creation_date": 1558529373, "post_id": 56198097, "comment_id": 99130866, "body": "If I may ask, using your implementation, I get the following error : <code>14 | #[GraphStruct&lt;&#39;a, V, E, map, inc, out, sen, rec, nodes, edges&gt;]    |              ^ expected one of </code>(<code>, </code>::<code>, </code>=<code>, </code>[<code>, </code>]<code>, or </code>{` here`   If I swap <code>&lt;&gt;</code> for <code>()</code> in the attribute, I instead get this : <code>Invalid GraphStruct attribute!: Error(&quot;expected </code>&lt;<code>&quot;)</code> when trying to parse the arguments. However &#39;(&#39; is not allowed in use with &#39;Token!&#39;, so I&#39;m lost here"}, {"owner": {"reputation": 2244, "user_id": 1825860, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/b9e1d70a0cbe81683a016e700d3239bf?s=128&d=identicon&r=PG", "display_name": "AlphaModder", "link": "https://stackoverflow.com/users/1825860/alphamodder"}, "edited": false, "score": 1, "creation_date": 1558607302, "post_id": 56198097, "comment_id": 99160997, "body": "@StefanChircop Ah, evidently rust still has some restrictions on what can be present at that point in an attribute. Since you don&#39;t seem to mind using parentheses, I&#39;ve updated my answer to show how to parse them."}, {"owner": {"user_type": "does_not_exist", "display_name": "user7924331"}, "edited": false, "score": 0, "creation_date": 1558655462, "post_id": 56198097, "comment_id": 99182254, "body": "Thank you a lot for your patience :)"}, {"owner": {"reputation": 2244, "user_id": 1825860, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/b9e1d70a0cbe81683a016e700d3239bf?s=128&d=identicon&r=PG", "display_name": "AlphaModder", "link": "https://stackoverflow.com/users/1825860/alphamodder"}, "edited": false, "score": 0, "creation_date": 1558658662, "post_id": 56198097, "comment_id": 99182746, "body": "@StefanChircop No problem, it was my bad for not making sure the angle brackets would work."}], "tags": [], "owner": {"reputation": 2244, "user_id": 1825860, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/b9e1d70a0cbe81683a016e700d3239bf?s=128&d=identicon&r=PG", "display_name": "AlphaModder", "link": "https://stackoverflow.com/users/1825860/alphamodder"}, "is_accepted": true, "score": 7, "last_activity_date": 1558607527, "last_edit_date": 1558607527, "creation_date": 1558175281, "answer_id": 56198097, "question_id": 56188700, "link": "https://stackoverflow.com/questions/56188700/how-do-i-make-my-custom-derive-macro-accept-trait-generic-parameters/56198097#56198097", "title": "How do I make my custom derive macro accept trait generic parameters?", "body": "<p>I don't believe it's possible to use exactly the syntax you describe in your post (<code>#[derive(MyCustomDerive&lt;'a, B, C&gt;)]</code>). However, consider the following syntax that used an additional custom attribute instead:</p>\n\n<pre><code>#[derive(MyTrait)]\n#[my_trait('a, B, C)]\nstruct MyStruct {\n    // ...\n}\n</code></pre>\n\n<p>To allow the <code>my_trait</code> attribute to be used, you'll have to add an <code>attributes</code> section to your <code>proc_macro_derive</code> attribute.</p>\n\n<pre><code>#[proc_macro_derive(MyTrait, attributes(my_trait))]\npub fn derive_my_trait(input: TokenStream) -&gt; TokenStream {\n    // ...\n}\n</code></pre>\n\n<p>For help with parsing the attribute itself, take a look at <a href=\"https://docs.rs/syn/0.15.34/syn/struct.Attribute.html\" rel=\"noreferrer\"><code>syn::Attribute</code></a>. The <code>tts</code> field is a <code>TokenStream</code> from which you could extract the necessary parameters. For example, if your trait has one lifetime and two type parameters, your parsing logic might look something like this:</p>\n\n<pre><code>struct MyParams(syn::Lifetime, syn::Ident, syn::Ident);\nimpl syn::Parse for MyParams {\n    fn parse(input: syn::ParseStream) -&gt; Result&lt;Self&gt; {\n        let content;\n        syn::parenthesized!(content in input);\n        let lifetime = content.parse()?;\n        content.parse::&lt;Token![,]&gt;()?;\n        let type1 = content.parse()?;\n        content.parse::&lt;Token![,]&gt;()?;\n        let type2 = content.parse()?;\n        Ok(MyParams(lifetime, type1, type2))\n    }\n}\n\npub fn derive(ast: &amp;syn::DeriveInput) -&gt; TokenStream {\n    let attribute = ast.attrs.iter().filter(\n        |a| a.path.segments.len() == 1 &amp;&amp; attr.path.segments[0].ident == \"my_trait\"\n    ).nth(0).expect(\"my_trait attribute required for deriving MyTrait!\");\n\n    let parameters: MyParams = syn::parse2(attribute.tts.clone()).expect(\"Invalid my_trait attribute!\");\n    // ... do stuff with `parameters`\n}\n</code></pre>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user7924331"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1150, "favorite_count": 0, "accepted_answer_id": 56198097, "answer_count": 1, "score": 5, "last_activity_date": 1558607527, "creation_date": 1558104010, "last_edit_date": 1558106556, "question_id": 56188700, "link": "https://stackoverflow.com/questions/56188700/how-do-i-make-my-custom-derive-macro-accept-trait-generic-parameters", "title": "How do I make my custom derive macro accept trait generic parameters?", "body": "<p>I am trying to implement custom derive macros for my traits, and they actually work!</p>\n\n<p>However I have a slight problem. I can't seem to find a way to include generic parameters to the trait.</p>\n\n<p>Specifically, I want to do something like this : <code>#[derive(MyCustomDerive&lt;'a, B, C&gt;)]</code></p>\n\n<p>Instead, right now I am hard-coding the generics, like so :</p>\n\n<pre><code>let gen = quote! {\n        impl #impl_generics Graph&lt;'a, V, E&gt; for #name #ty_generics #where_clause {\n            fn Map(&amp;self) -&gt; &amp;MAP&lt;V, E&gt; {\n                &amp;self.map\n            }\n            ...\n}\n</code></pre>\n\n<p>As you can see, I am including <strong>'a</strong>, <strong>V</strong> and <strong>E</strong> fixed within the quote block, instead of something I want to achieve, which is being able to flexibly derive the trait with the generic types I want.</p>\n\n<p>What I would like is something akin to this :</p>\n\n<p><code>#[derive(MyCustomDerive&lt;'a, B, C&gt;)]</code></p>\n\n<p>to result in something equivalent to this</p>\n\n<pre><code>let gen = quote! {\n        impl #impl_generics Graph&lt;'a, B, C&gt; for #name #ty_generics #where_clause {\n            fn Map(&amp;self) -&gt; &amp;MAP&lt;B, C&gt; {\n                &amp;self.map\n            }\n            ...\n}\n</code></pre>\n\n<p>This would allow me to reserve (of course if necessary) V and E for other things and in my opinion make code more controllable.\nThank you for your help!</p>\n\n<p>Update 1 :\nThis is how my derive function looks</p>\n\n<pre><code>pub fn derive(ast: &amp;syn::DeriveInput) -&gt; TokenStream {\n   let name = &amp;ast.ident;\n   let generics = &amp;ast.generics;\n   let (impl_generics, ty_generics, where_clause) = generics.split_for_impl();\n   let gen = quote! {\n       impl #impl_generics Graph&lt;'a, V, E&gt; for #name #ty_generics #where_clause {\n           fn Map(&amp;self) -&gt; &amp;MAP&lt;V, E&gt; {\n            &amp;self.map\n           } ...\n</code></pre>\n"}, {"tags": ["rust", "deserialization", "serde"], "answers": [{"comments": [{"owner": {"reputation": 455, "user_id": 8144553, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-vI_L8zmpMpc/AAAAAAAAAAI/AAAAAAAAAfc/nVixM67Njss/photo.jpg?sz=128", "display_name": "jonathan", "link": "https://stackoverflow.com/users/8144553/jonathan"}, "edited": false, "score": 1, "creation_date": 1558174829, "post_id": 56189837, "comment_id": 99019425, "body": "By chance this is also exactly what i needed! Thanks for this response and a +1 from me :D"}], "tags": [], "owner": {"reputation": 6357, "user_id": 6086311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb99289473f6393b89474785f2d294d1?s=128&d=identicon&r=PG", "display_name": "dtolnay", "link": "https://stackoverflow.com/users/6086311/dtolnay"}, "is_accepted": true, "score": 6, "last_activity_date": 1558108351, "creation_date": 1558108351, "answer_id": 56189837, "question_id": 56188291, "link": "https://stackoverflow.com/questions/56188291/how-can-i-deserialize-a-bincode-field-without-a-given-length/56189837#56189837", "title": "How can I deserialize a bincode field without a given length", "body": "<p><a href=\"https://docs.rs/bincode/1.1.4/bincode/fn.deserialize_from.html\" rel=\"noreferrer\"><code>bincode::deserialize_from</code></a> lets you retain any trailing data in the input stream.</p>\n\n<hr>\n\n<pre><code>use serde::Deserialize;\n\n#[derive(Deserialize, Debug)]\nstruct Data {\n    q: String,\n    r: i32,\n\n    #[serde(skip)]\n    trailing: Vec&lt;u8&gt;,\n}\n\nfn main() -&gt; bincode::Result&lt;()&gt; {\n    let bytes = [7, 0, 0, 0, 0, 0, 0, 0, 115, 117, 99, 99, 101, 115, 115, 227, 7, 0, 0, 3, 2, 1];\n\n    let mut cursor = &amp;bytes[..];\n    let mut data: Data = bincode::deserialize_from(&amp;mut cursor)?;\n    data.trailing = cursor.to_owned();\n\n    println!(\"{:#?}\", data);\n    Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 167, "user_id": 11456509, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c7e14c326dc50a205b833182dc160cac?s=128&d=identicon&r=PG", "display_name": "0x76", "link": "https://stackoverflow.com/users/11456509/0x76"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 588, "favorite_count": 0, "accepted_answer_id": 56189837, "answer_count": 1, "score": 4, "last_activity_date": 1558108351, "creation_date": 1558102607, "question_id": 56188291, "link": "https://stackoverflow.com/questions/56188291/how-can-i-deserialize-a-bincode-field-without-a-given-length", "title": "How can I deserialize a bincode field without a given length", "body": "<p>So I'm trying to deserialize a message consisting of binary data (bincode), this binary isn't serialized by serde but I'm trying to use serde to deserialize it. However, the data send optionally has a raw data section at the end of which the length isn't prefixed but is guaranteed to be the rest of the message. Serde always expects a length. I can't add the length due to backwards compatability concerns with a system not made/designed by me, this compat is important. Is this possible to achieve with Serde and how would I go about doing that?</p>\n\n<p>I've already looked at the docs for serde and bincode and couldn't find anything in there to help me.</p>\n"}, {"tags": ["json", "rust", "rust-rocket"], "comments": [{"owner": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "edited": false, "score": 0, "creation_date": 1558091202, "post_id": 56184109, "comment_id": 98995505, "body": "If you have a <code>struct Response { items: Vec&lt;Bookable&gt; }</code> where <code>Bookable</code> and <code>Response</code> impl <code>serde::Deserialize</code> (e.g. via a derive) you should be able to return a <code>rocket_contrib::json::Json&lt;Response&gt;</code> right away."}], "answers": [{"tags": [], "owner": {"reputation": 3557, "user_id": 1036888, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/jUkhz.png?s=128&g=1", "display_name": "Abhay PS", "link": "https://stackoverflow.com/users/1036888/abhay-ps"}, "is_accepted": true, "score": 0, "last_activity_date": 1567530737, "last_edit_date": 1567530737, "creation_date": 1567526612, "answer_id": 57775225, "question_id": 56184109, "link": "https://stackoverflow.com/questions/56184109/how-to-convert-vec-to-jsonvalue-in-rust/57775225#57775225", "title": "How to convert Vec to JsonValue in Rust", "body": "<p>First, you derive your struct like -</p>\n\n<pre><code>use serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse rocket_contrib::{json::{Json}};\n\n#[derive(QueryableByName, Deserialize, Serialize)]\npub struct Bookable {\n  #[sql_type = \"BigInt\"]\n  pub id: i64,\n  #[sql_type = \"Text\"]\n  pub title: String\n}\n</code></pre>\n\n<p>Then you can do something like -</p>\n\n<pre><code> let conn = connect();\n let terms = bookable::get_terms(&amp;conn);\n let mut data: Vec&lt;Bookable&gt; = HashMap::new();\n data.insert(\"data\", terms);\n return Json(Vec&lt;Bookable&gt;);\n</code></pre>\n\n<p><code>Json(Vec&lt;Bookable&gt;)</code> will also set the content-type as json for the response.</p>\n"}], "owner": {"reputation": 685, "user_id": 1127557, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/b520b02910b5efa0f813441c85171066?s=128&d=identicon&r=PG", "display_name": "Alex", "link": "https://stackoverflow.com/users/1127557/alex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1297, "favorite_count": 0, "accepted_answer_id": 57775225, "answer_count": 1, "score": 1, "last_activity_date": 1600191650, "creation_date": 1558087384, "last_edit_date": 1600191650, "question_id": 56184109, "link": "https://stackoverflow.com/questions/56184109/how-to-convert-vec-to-jsonvalue-in-rust", "title": "How to convert Vec to JsonValue in Rust", "body": "<p>I am querying my database and getting an <code>Vec&lt;Bookable&gt;</code> struct, using diesel library.</p>\n\n<pre><code>#[derive(QueryableByName)]\npub struct Bookable {\n  #[sql_type = \"BigInt\"]\n  pub id: i64,\n  #[sql_type = \"Text\"]\n  pub title: String\n}\n</code></pre>\n\n<p>When I query the elements, I can access the result, but it's not possible to convert the <code>Vec&lt;Bookable&gt;</code> to <code>json!</code> macro:</p>\n\n<pre><code>pub fn get_terms(conn: &amp;MysqlConnection) -&gt; Vec&lt;Bookable&gt; {\n  diesel::sql_query(r#\"SELECT title, LAST_INSERT_ID() 'id' from bookable_term;\"#)\n    .load::&lt;Bookable&gt;(conn).expect(\"Query failed\")\n}\n</code></pre>\n\n<p>And later I call it this way:</p>\n\n<pre><code>  let conn = connect();\n  let terms = bookable::get_terms(&amp;conn);\n  json!({ \"data\": {\n    \"items\": terms }\n  })\n</code></pre>\n\n<p>The question is how to put the terms into this object and send the whole array to the API? I can stringify a json like this:</p>\n\n<pre><code>\"items:\" &amp;vec![\"to\", \"be\", \"or\", \"not\", \"to\", \"be\"]\n</code></pre>\n\n<p>But when it comes to an existing Vec I get compiler error. I am using <code>Rocket</code> so it provides a <code>rocket_contrib::json::JsonValue</code> which holds <code>json!</code> macro</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1558084525, "post_id": 56183111, "comment_id": 98992023, "body": "Hi there! You have seen the error message, right? Can you explain what confused you about it or why it didn&#39;t help you with your problem? Thanks!"}, {"owner": {"reputation": 21, "user_id": 11228800, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FydNu.png?s=128&g=1", "display_name": "ptato", "link": "https://stackoverflow.com/users/11228800/ptato"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1558084622, "post_id": 56183111, "comment_id": 98992074, "body": "The error message just tells me to modify the reference so that it points to a different value. It doesn&#39;t help me with modifying the original value. @LukasKalbertodt"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1558084761, "post_id": 56183111, "comment_id": 98992170, "body": "Oh oops, this time I was the one to not fully read the error message :D It&#39;s a bad suggestion by the compiler IMO, because that&#39;s almost never what you want. The solution to your problem is to say <code>*test_ref = TestType::Second(49);</code> (dereference the reference with <code>*</code>). I&#39;m pretty sure this has been asked and answered before. I will try to find a relevant Q&amp;A shortly!"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1558085083, "post_id": 56183111, "comment_id": 98992339, "body": "Strange, the best related questions I was able to find are <a href=\"https://stackoverflow.com/q/45985827/2408867\">this</a> and <a href=\"https://stackoverflow.com/q/36557412/2408867\">this</a>, both of which don&#39;t perfectly answer your question IMO (but they might help you regardless). Please let us know if the <code>*</code> solved your problem. Thanks!"}], "answers": [{"tags": [], "owner": {"reputation": 1, "user_id": 12959013, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c14058893f3020b12f1d788041c8111f?s=128&d=identicon&r=PG&f=1", "display_name": "Hamid Reza", "link": "https://stackoverflow.com/users/12959013/hamid-reza"}, "is_accepted": false, "score": 0, "last_activity_date": 1592839787, "last_edit_date": 1592839787, "creation_date": 1592839390, "answer_id": 62517874, "question_id": 56183111, "link": "https://stackoverflow.com/questions/56183111/how-do-i-modify-the-full-content-of-a-mutable-reference-in-rust/62517874#62517874", "title": "How do I modify the full content of a mutable reference in Rust?", "body": "<p>You have a vector of references, so when getting an element from it, the variable must be mutable then you dereference it to assign a value:</p>\n<pre><code>#[derive(Debug)]\nenum TestType {\n    First,\n    Second(i32),\n}\n\nfn main() {\n    let mut test_var = TestType::First;\n    println!(&quot;Original {:?}&quot;, test_var);\n\n    let mut test_vec: Vec&lt;&amp;mut TestType&gt; = vec![&amp;mut test_var];\n\n    println!(&quot;--------------&quot;);\n    {\n        let mut test_ref = test_vec.pop().unwrap();\n        *test_ref = TestType::Second(49);\n    }\n    println!(&quot;Original {:?}&quot;, test_var);\n}\n</code></pre>\n<p>Result:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Original First\n--------------\nOriginal Second(49)\n</code></pre>\n"}], "owner": {"reputation": 21, "user_id": 11228800, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FydNu.png?s=128&g=1", "display_name": "ptato", "link": "https://stackoverflow.com/users/11228800/ptato"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 162, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1592839787, "creation_date": 1558083969, "last_edit_date": 1592839753, "question_id": 56183111, "link": "https://stackoverflow.com/questions/56183111/how-do-i-modify-the-full-content-of-a-mutable-reference-in-rust", "title": "How do I modify the full content of a mutable reference in Rust?", "body": "<p>I have an enum type. I create a variable and assign it a value of that enum type, and I want that variable to be the owner of the value &quot;forever&quot;. There is a <code>Vec</code> of <em>mutable</em> references to that type. I then want to retrieve those references and maybe modify the value that they point towards, so that the original variable is changed. Is there a way to do this?</p>\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Debug)]\nenum TestType {\n    First,\n    Second(i32),\n}\n\nfn main() {\n    let mut test_var = TestType::First;\n    println!(&quot;Original {:?}&quot;, test_var);\n\n    let mut test_vec: Vec&lt;&amp;mut TestType&gt; = vec![&amp;mut test_var];\n\n    println!(&quot;--------------&quot;);\n    {\n        let test_ref = test_vec.pop().unwrap();\n        test_ref = TestType::Second(49);\n    }\n    println!(&quot;Original {:?}&quot;, test_var);\n}\n</code></pre>\n<p>(<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=2e9db9898c691853fd5ede3ddd68c32d\" rel=\"nofollow noreferrer\">Playground</a>)</p>\n<p>Compiling results in:</p>\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:16:20\n   |\n16 |         test_ref = TestType::Second(49);\n   |                    ^^^^^^^^^^^^^^^^^^^^\n   |                    |\n   |                    expected mutable reference, found enum `TestType`\n   |                    help: consider mutably borrowing here: `&amp;mut TestType::Second(49)`\n   |\n   = note: expected type `&amp;mut TestType`\n              found type `TestType`\n</code></pre>\n"}, {"tags": ["oop", "rust"], "comments": [{"owner": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "edited": false, "score": 1, "creation_date": 1558083972, "post_id": 56183016, "comment_id": 98991725, "body": "I don&#39;t see much of OOP in your example. I would say, that rust is partly OOP, at least in that sens, that there are methods (there is data and that data brings it&#39;s own processing). But you do not have inheritance in rust."}, {"owner": {"reputation": 97, "user_id": 4507906, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6c99d92d722697d34f3b6003c2e23818?s=128&d=identicon&r=PG&f=1", "display_name": "usr784638", "link": "https://stackoverflow.com/users/4507906/usr784638"}, "reply_to_user": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "edited": false, "score": 0, "creation_date": 1558084396, "post_id": 56183016, "comment_id": 98991949, "body": "@chpio im sorry but i am very new to Rust and everything sound different. So what is your example of a proper architecture for Rust. appreciate if you comment a simple example here so i can take it as my reference. Thanks"}, {"owner": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "edited": false, "score": 0, "creation_date": 1558084638, "post_id": 56183016, "comment_id": 98992081, "body": "&quot;i&#39;ve tried reading this tutorial but i didn&#39;t get what i want.&quot; What do you want?"}, {"owner": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "edited": false, "score": 0, "creation_date": 1558084757, "post_id": 56183016, "comment_id": 98992168, "body": "&quot;how can implement the same OOP structure as python in Rust&quot; You can&#39;t, what is the point in copy &amp; pasting the python code if you want rust code? Rust is not python."}, {"owner": {"reputation": 469147, "user_id": 476, "user_type": "moderator", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/a235706e3d81b614acaec3368edfea4b?s=128&d=identicon&r=PG", "display_name": "deceze", "link": "https://stackoverflow.com/users/476/deceze"}, "edited": false, "score": 8, "creation_date": 1558084893, "post_id": 56183016, "comment_id": 98992247, "body": "Generally speaking, if you come from one language to another which is very different, the least productive thing to do is to try to translate code 1:1. Learn Rust on its own terms first, follow all the tutorials and write code that <i>provides the same result</i>, not code that tries to imitate another language. Eventually when you know Rust well enough you will see the patterns and similarities, or know why something can&#39;t be translated 1:1 and what pattern to apply instead."}, {"owner": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "reply_to_user": {"reputation": 469147, "user_id": 476, "user_type": "moderator", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/a235706e3d81b614acaec3368edfea4b?s=128&d=identicon&r=PG", "display_name": "deceze", "link": "https://stackoverflow.com/users/476/deceze"}, "edited": false, "score": 0, "creation_date": 1558084987, "post_id": 56183016, "comment_id": 98992293, "body": "@deceze that&#39;s what i wanted to write :)"}, {"owner": {"reputation": 97, "user_id": 4507906, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6c99d92d722697d34f3b6003c2e23818?s=128&d=identicon&r=PG&f=1", "display_name": "usr784638", "link": "https://stackoverflow.com/users/4507906/usr784638"}, "reply_to_user": {"reputation": 555, "user_id": 5572146, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c799e0c44a11d16cc175a717d5dca855?s=128&d=identicon&r=PG&f=1", "display_name": "chpio", "link": "https://stackoverflow.com/users/5572146/chpio"}, "edited": false, "score": 0, "creation_date": 1558085061, "post_id": 56183016, "comment_id": 98992325, "body": "@chpio im not trying to say python is good or i want the exact same thing. I&#39;m beginner dude (no need to fight). All I&#39;m asking is just how should i start, the rust is different than other languages and i have experience in python that i can put an example... . if i knew Rust well, never asked here!"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1558085213, "post_id": 56183016, "comment_id": 98992401, "body": "There is no inheritance in your Python code, so it&#39;s not strictly speaking OOP. The tutorial you want is <a href=\"https://stevedonovan.github.io/rust-gentle-intro/2-structs-enums-lifetimes.html#structs\" rel=\"nofollow noreferrer\">this one</a>."}, {"owner": {"reputation": 97, "user_id": 4507906, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6c99d92d722697d34f3b6003c2e23818?s=128&d=identicon&r=PG&f=1", "display_name": "usr784638", "link": "https://stackoverflow.com/users/4507906/usr784638"}, "reply_to_user": {"reputation": 469147, "user_id": 476, "user_type": "moderator", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/a235706e3d81b614acaec3368edfea4b?s=128&d=identicon&r=PG", "display_name": "deceze", "link": "https://stackoverflow.com/users/476/deceze"}, "edited": false, "score": 0, "creation_date": 1558085350, "post_id": 56183016, "comment_id": 98992481, "body": "@deceze Thanks for your gentle highlights. Do you think is this enough to only follow <a href=\"https://doc.rust-lang.org/book/ch17-00-oop.html\" rel=\"nofollow noreferrer\">this Tutorial</a> ?"}], "answers": [{"tags": [], "owner": {"reputation": 2244, "user_id": 1825860, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/b9e1d70a0cbe81683a016e700d3239bf?s=128&d=identicon&r=PG", "display_name": "AlphaModder", "link": "https://stackoverflow.com/users/1825860/alphamodder"}, "is_accepted": true, "score": 1, "last_activity_date": 1558085341, "creation_date": 1558085341, "answer_id": 56183503, "question_id": 56183016, "link": "https://stackoverflow.com/questions/56183016/what-is-the-proper-oop-architecture-for-rust/56183503#56183503", "title": "What is the proper OOP architecture for Rust?", "body": "<p>The python code example you give doesn't make use of many object-oriented features, but it's not too hard to translate into Rust:</p>\n\n<p>file: main.rs</p>\n\n<pre><code>mod my_lib; // This instructs Rust to look for `my_lib.rs` and import it as `my_lib`.\nmod main {\n    pub fn init() {\n        println!(\"main &gt; init\");\n    }\n\n    pub fn start() {\n        super::my_lib::run() // We have to add super:: to talk about things that were imported in the parent module rather than the `main` module itself, like `my_lib` \n    }\n}\n\nfn main() { // This is the function that starts your program. It's always called `main`.\n    main::init()\n}\n</code></pre>\n\n<p>file: my_lib.rs</p>\n\n<pre><code>pub fn run() {\n    println!(\"running...\")\n}\n</code></pre>\n\n<p>Notably, this isn't quite equivalent to your python code, because <code>main</code> is a module instead of a class. If you intend to use its <code>self</code> instance to store data or any persistent state, the example would look different (<code>main</code> would be a <code>struct</code>, and its methods would be in an <code>impl</code> block.) I can edit my answer if that's closer to what you're looking for.</p>\n"}], "owner": {"reputation": 97, "user_id": 4507906, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6c99d92d722697d34f3b6003c2e23818?s=128&d=identicon&r=PG&f=1", "display_name": "usr784638", "link": "https://stackoverflow.com/users/4507906/usr784638"}, "delete_vote_count": 1, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 317, "favorite_count": 0, "closed_date": 1558104928, "accepted_answer_id": 56183503, "answer_count": 1, "score": -1, "last_activity_date": 1558085341, "creation_date": 1558083616, "last_edit_date": 1558084516, "question_id": 56183016, "link": "https://stackoverflow.com/questions/56183016/what-is-the-proper-oop-architecture-for-rust", "closed_reason": "Opinion-based", "title": "What is the proper OOP architecture for Rust?", "body": "<p>I have a program that written in python and uses classes.\ni wanna convert the same structure to Rust but we don't have classes in rust instead we have (impl &amp; strcut). so that makes me confuse that how can implement the same OOP structure as python in Rust !</p>\n\n<p>Please bring an example for the architecture in Rust so i can have it as reference. </p>\n\n<p>i've tried reading this tutorial but i didn't get what i want.\n<a href=\"https://stevedonovan.github.io/rust-gentle-intro/object-orientation.html\" rel=\"nofollow noreferrer\">https://stevedonovan.github.io/rust-gentle-intro/object-orientation.html</a></p>\n\n<p>My existing program example:</p>\n\n<p>file: main.py</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>import my_lib\n\nclass main(object):\n    def __init__(self):\n        print('main &gt; init')\n\n    def start(self):\n        my_lib.run()\n\n\nif __name__ == \"__main__\":\n    main()\n</code></pre>\n\n<p>file: /lib/my_lib.py</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>    def run():\n        print('running...')\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1558077219, "post_id": 56181266, "comment_id": 98988320, "body": "Your case could be even simpler, by not returning a <code>&amp;u32</code> but <code>u32</code> instead."}, {"owner": {"reputation": 1291, "user_id": 6331045, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/189f94db303d16b891800f11846bd753?s=128&d=identicon&r=PG&f=1", "display_name": "Laney", "link": "https://stackoverflow.com/users/6331045/laney"}, "edited": false, "score": 1, "creation_date": 1558103759, "post_id": 56181266, "comment_id": 99002273, "body": "<code>value</code> function can be replaced with one-liner: <code>self.values.entry(arg).or_insert((self.calculation)(&amp;arg))</code>"}], "answers": [{"comments": [{"owner": {"reputation": 1773, "user_id": 447661, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/ByuIX.jpg?s=128&g=1", "display_name": "Mihai Rotaru", "link": "https://stackoverflow.com/users/447661/mihai-rotaru"}, "edited": false, "score": 0, "creation_date": 1558109196, "post_id": 56189760, "comment_id": 99005010, "body": "Thank you; I haven&#39;t ran it yet but I should have mentioned in the question that I&#39;m primarily interested in learning about <i>why</i> the compiler is saying what it&#39;s saying, rather than solving the actual problem."}, {"owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "reply_to_user": {"reputation": 1773, "user_id": 447661, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/ByuIX.jpg?s=128&g=1", "display_name": "Mihai Rotaru", "link": "https://stackoverflow.com/users/447661/mihai-rotaru"}, "edited": false, "score": 0, "creation_date": 1558109471, "post_id": 56189760, "comment_id": 99005126, "body": "You are welcome. You could probably simplify the question and the code involved. Any function signature returning a reference will do. The Casher and its usecase is just a red hering."}], "tags": [], "owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "is_accepted": false, "score": 1, "last_activity_date": 1558108073, "creation_date": 1558108073, "answer_id": 56189760, "question_id": 56181266, "link": "https://stackoverflow.com/questions/56181266/mutable-borrow-from-hashmap-and-lifetime-elision/56189760#56189760", "title": "Mutable borrow from HashMap and lifetime elision", "body": "<p>I do not think that you are going to be happy with that signature:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn value(&amp;mut self, arg: u32) -&gt; &amp;u32\n</code></pre>\n\n<p>Without lifetime elision this is read as:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn value(&amp;'a mut self, arg: u32) -&gt; &amp;'a u32\n</code></pre>\n\n<p>Even if you implement it correctly this has huge implications. For example you can not call <code>value</code> again as long as old results are still in use. And rightly so, after all nothing is preventing the function body to delete old values from the cache.</p>\n\n<p>Better to follow @hellow advice and make the return type u32.</p>\n\n<p>Another misunderstanding: Just because you borrowed values already, does not mean you cannot borrow from it again.</p>\n\n<p>Now to answer your original question:\nThe compiler is not lying to you <code>values.get(arg)</code> is indeed an immutable borrow of <code>values</code>. The technical explanation is that the signature of that method call is (simplified) <code>get(&amp;self, k: &amp;Q) -&gt; Option&lt;&amp;V&gt;</code>. So the borrow of <code>self</code> (aka <code>values</code>) is valid as long as <code>&amp;V</code> can still be referenced. &amp;V however needs to be valid for the entire function body at least (so it can be returned). Now you tried to mutably borrow in the <code>None</code> case which means <code>&amp;V</code> never existed in the first place. So if the compiler gets smarter it may allow your code to run, but for now (1.34.0) it isn't.</p>\n"}], "owner": {"reputation": 1773, "user_id": 447661, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/ByuIX.jpg?s=128&g=1", "display_name": "Mihai Rotaru", "link": "https://stackoverflow.com/users/447661/mihai-rotaru"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 137, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558108073, "creation_date": 1558076757, "last_edit_date": 1558081621, "question_id": 56181266, "link": "https://stackoverflow.com/questions/56181266/mutable-borrow-from-hashmap-and-lifetime-elision", "title": "Mutable borrow from HashMap and lifetime elision", "body": "<p>Chapter 13 of the Rust book (2nd edition) contains an example of a simple calculation cache. <code>Cacher</code> takes the calculation function as a constructor param, and will cache the result - after the first call, it will not invoke the function again, but simply return the cached result:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Cacher&lt;T&gt;\nwhere\n    T: Fn(u32) -&gt; u32,\n{\n    calculation: T,\n    value: Option&lt;u32&gt;,\n}\n\nimpl&lt;T&gt; Cacher&lt;T&gt;\nwhere\n    T: Fn(u32) -&gt; u32,\n{\n    fn new(calculation: T) -&gt; Cacher&lt;T&gt; {\n        Cacher {\n            calculation,\n            value: None,\n        }\n    }\n\n    fn value(&amp;mut self, arg: u32) -&gt; u32 {\n        match self.value {\n            Some(v) =&gt; v,\n            None =&gt; {\n                let v = (self.calculation)(arg);\n                self.value = Some(v);\n                v\n            }\n        }\n    }\n}\n</code></pre>\n\n<p>It is very limited, and there are a couple of improvement suggestions in the book, left as an exercise for the reader.</p>\n\n<p>So I'm trying to make it cache multiple values. The <code>Cacher</code> holds a <code>HashMap</code> with result values, instead of just one value. When asked for a value, if it has in the map (cache), return it. Otherwise, calculate it, store it the cache, and then return it.</p>\n\n<p>The cacher takes references, because it doesn't want to own the inputs. When using it (see unit test), I'm borrowing, because the cacher owns the results.</p>\n\n<p>Here's my attempt:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::collections::HashMap;\n\nstruct Cacher&lt;T&gt;\nwhere\n    T: Fn(&amp;u32) -&gt; u32,\n{\n    calculation: T,\n    values: HashMap&lt;u32, u32&gt;,\n}\n\nimpl&lt;T&gt; Cacher&lt;T&gt;\nwhere\n    T: Fn(&amp;u32) -&gt; u32,\n{\n    fn new(calculation: T) -&gt; Cacher&lt;T&gt; {\n        Cacher {\n            calculation,\n            values: HashMap::new(),\n        }\n    }\n\n    fn value(&amp;mut self, arg: u32) -&gt; &amp;u32 {\n        let values = &amp;mut self.values;\n        match values.get(&amp;arg) {\n            Some(v) =&gt; &amp;v,\n            None =&gt; {\n                let v = (self.calculation)(&amp;arg);\n                values.insert(arg, v);\n                &amp;values.get(&amp;arg).unwrap()\n            }\n        }\n    }\n}\n\n#[test]\nfn call_with_different_values() {\n    let mut c = Cacher::new(|a| a + 1);\n    let v1 = c.value(1);\n    assert_eq!(*v1, 2);\n    let v2 = c.value(2);\n    assert_eq!(*v2, 3);\n}\n</code></pre>\n\n<p>Compiler output:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>22 |     fn value(&amp;mut self, arg: u32) -&gt; &amp;u32 {\n   |              - let's call the lifetime of this reference `'1`\n23 |         let values = &amp;mut self.values;\n24 |         match values.get(&amp;arg) {\n   |               ------ immutable borrow occurs here\n25 |             Some(v) =&gt; &amp;v,\n   |                        -- returning this value requires that `*values` is borrowed for `'1`\n...\n28 |                 values.insert(arg, v);\n   |                 ^^^^^^^^^^^^^^^^^^^^^ mutable borrow occurs here\n</code></pre>\n\n<p>I'm borrowing <code>self.values</code> as mutable on line <code>23</code>. However, when I try to use it on the following line, I get the \"immutable borrow\" error. How is <code>match values.get(arg)</code> an immutable borrow of <code>values</code> ? Didn't the borrowing already happen ?</p>\n\n<p>There is also the error for line <code>25</code>. From my understanding of <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/0141-lifetime-elision.md\" rel=\"nofollow noreferrer\">lifetime elision rules</a>, the 3rd one should apply here - we have <code>&amp;mut self</code> as a method parameter, so it's lifetime should be automatically assigned to the return value ?</p>\n"}, {"tags": ["rust", "stm32", "cortex-m", "stm32f4discovery"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558072588, "post_id": 56179131, "comment_id": 98986472, "body": "Does this code show &quot;Inerrupt Received&quot; when you short PA0 or do you have to modify your code for that?"}, {"owner": {"reputation": 1846, "user_id": 1601448, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/7d6abd2bfe7848e0693972db9f82c2e7?s=128&d=identicon&r=PG", "display_name": "Russell Greene", "link": "https://stackoverflow.com/users/1601448/russell-greene"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558074724, "post_id": 56179131, "comment_id": 98987219, "body": "This code on its own shows interrupt received when I short PA0 to 3.3V."}], "answers": [{"tags": [], "owner": {"reputation": 1846, "user_id": 1601448, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/7d6abd2bfe7848e0693972db9f82c2e7?s=128&d=identicon&r=PG", "display_name": "Russell Greene", "link": "https://stackoverflow.com/users/1601448/russell-greene"}, "is_accepted": true, "score": 0, "last_activity_date": 1558295859, "creation_date": 1558295859, "answer_id": 56211525, "question_id": 56179131, "link": "https://stackoverflow.com/questions/56179131/cannot-receive-interrupt-on-pe0-stm32/56211525#56211525", "title": "Cannot receive interrupt on PE0 STM32", "body": "<p>Apparently, the system configuration controller clock must be enabled to change syscfg registers. Adding <code>rcc.apb2enr.modify(|_, w| w.syscfgen().enabled());</code> makes it work. Full source:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![no_std]\n#![no_main]\n\nextern crate panic_semihosting;\n\nuse cortex_m::interrupt::{free, Mutex};\nuse cortex_m_rt::entry;\nuse cortex_m_semihosting::hprintln;\nuse hal::gpio::{gpioe, Edge, ExtiPin, Input, PullDown};\nuse hal::prelude::*;\nuse hal::stm32::{interrupt, Interrupt, EXTI};\n\nuse core::cell::RefCell;\n\nstatic PE0: Mutex&lt;RefCell&lt;Option&lt;gpioe::PE0&lt;Input&lt;PullDown&gt;&gt;&gt;&gt;&gt; = Mutex::new(RefCell::new(None));\nstatic EXT_INTER: Mutex&lt;RefCell&lt;Option&lt;EXTI&gt;&gt;&gt; = Mutex::new(RefCell::new(None));\n\n#[entry]\nfn start() -&gt; ! {\n    let p = hal::stm32::Peripherals::take().unwrap();\n    let c = cortex_m::Peripherals::take().unwrap();\n\n    let gpioe = p.GPIOE.split();\n    let rcc = p.RCC;\n    let mut syscfg = p.SYSCFG;\n    let mut exti = p.EXTI;\n    let mut nvic = c.NVIC;\n\n    rcc.apb2enr.modify(|_, w| w.syscfgen().enabled()); // important\n\n    nvic.enable(Interrupt::EXTI0);\n\n    let mut pe0 = gpioe.pe0.into_pull_down_input();\n    pe0.make_interrupt_source(&amp;mut syscfg);\n    pe0.enable_interrupt(&amp;mut exti);\n    pe0.trigger_on_edge(&amp;mut exti, Edge::FALLING);\n\n    free(|cs| {\n        let cell = PE0.borrow(&amp;cs);\n        *cell.borrow_mut() = Some(pe0);\n\n        let cell = EXT_INTER.borrow(&amp;cs);\n        *cell.borrow_mut() = Some(exti);\n    });\n\n    loop {}\n}\n\n#[interrupt]\nfn EXTI0() {\n    hprintln!(\"Interrupt received\").unwrap();\n\n    // clear the interrupt\n    free(|cs| {\n        let pe0 = PE0.borrow(&amp;cs);\n        let exti = EXT_INTER.borrow(&amp;cs);\n\n        if let (Some(pe0), Some(mut exti)) = (pe0.borrow_mut().as_mut(), exti.borrow_mut().as_mut())\n        {\n            pe0.clear_interrupt_pending_bit(&amp;mut exti);\n        }\n    });\n}\n</code></pre>\n"}], "owner": {"reputation": 1846, "user_id": 1601448, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/7d6abd2bfe7848e0693972db9f82c2e7?s=128&d=identicon&r=PG", "display_name": "Russell Greene", "link": "https://stackoverflow.com/users/1601448/russell-greene"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 330, "favorite_count": 0, "accepted_answer_id": 56211525, "answer_count": 1, "score": 0, "last_activity_date": 1564833152, "creation_date": 1558063238, "last_edit_date": 1564833152, "question_id": 56179131, "link": "https://stackoverflow.com/questions/56179131/cannot-receive-interrupt-on-pe0-stm32", "title": "Cannot receive interrupt on PE0 STM32", "body": "<p>I'm trying to receive simple interrupts on my STM32F407G-DISC1, and I can't seem to configure the EXTI0 interrupt channel to receive from PE0, and instead it only seems to trigger on changes to PA0. </p>\n\n<p>When I short the 3.3V pin to PA0, it prints \"Interrupt Received\", but when I short 3.3V to PE0, nothing happens.</p>\n\n<p>Is there some configuration call I'm missing?</p>\n\n<p>The build scripts and other configuration files are based off of <a href=\"https://github.com/rust-embedded/cortex-m-quickstart\" rel=\"nofollow noreferrer\">the cortex-m quickstart</a>, with small modifications. If those are relevant I can post those as well.</p>\n\n<p>Here's my code:</p>\n\n<pre><code># Cargo.toml\n[package]\nname = \"embedded-interrupt\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[dependencies]\ncortex-m = \"0.6.0\"\ncortex-m-rt = \"0.6.8\"\ncortex-m-semihosting = \"0.3.3\"\npanic-semihosting = \"0.5\"\nhal = {package = \"stm32f4xx-hal\", features = [\"stm32f407\", \"rt\"], version = \"0.5\" }\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// main.rs\n#![no_std]\n#![no_main]\n\nextern crate panic_semihosting;\n\nuse cortex_m_rt::entry;\nuse cortex_m::interrupt::{Mutex, free};\nuse cortex_m_semihosting::hprintln;\nuse hal::prelude::*;\nuse hal::stm32::{interrupt, Interrupt, EXTI};\nuse hal::gpio::{ExtiPin, Edge, gpioe, Input, PullDown};\n\nuse core::cell::RefCell;\n\nstatic PE0: Mutex&lt;RefCell&lt;Option&lt;gpioe::PE0&lt;Input&lt;PullDown&gt;&gt;&gt;&gt;&gt; = Mutex::new(RefCell::new(None));\nstatic EXT_INTER: Mutex&lt;RefCell&lt;Option&lt;EXTI&gt;&gt;&gt; = Mutex::new(RefCell::new(None));\n\n#[entry]\nfn start() -&gt; ! {\n\n    let p = hal::stm32::Peripherals::take().unwrap();\n    let c = cortex_m::Peripherals::take().unwrap();\n\n    let gpioe = p.GPIOE.split();\n    let mut syscfg = p.SYSCFG;\n    let mut exti = p.EXTI;\n    let mut nvic = c.NVIC;\n\n    nvic.enable(Interrupt::EXTI0);\n\n    let mut pe0 = gpioe.pe0.into_pull_down_input();\n    pe0.make_interrupt_source(&amp;mut syscfg);\n    pe0.enable_interrupt(&amp;mut exti);\n    pe0.trigger_on_edge(&amp;mut exti, Edge::FALLING);\n\n    free(|cs| {\n        let cell = PE0.borrow(&amp;cs);\n        *cell.borrow_mut() = Some(pe0);\n\n        let cell = EXT_INTER.borrow(&amp;cs);\n        *cell.borrow_mut() = Some(exti);\n    });\n\n    loop{}\n}\n\n#[interrupt]\nfn EXTI0() {\n    hprintln!(\"Interrupt received\").unwrap();\n\n    // clear the interrupt\n    free(|cs| {\n        let pe0 = PE0.borrow(&amp;cs);\n        let exti = EXT_INTER.borrow(&amp;cs);\n\n        if let (Some(pe0), Some(mut exti)) = (pe0.borrow_mut().as_mut(), exti.borrow_mut().as_mut()) {\n            pe0.clear_interrupt_pending_bit(&amp;mut exti);\n        }\n    });\n\n}\n\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 3, "creation_date": 1558083485, "post_id": 56177664, "comment_id": 98991462, "body": "Note that <code>impl Hello for Any</code> actually means <code>impl Hello for dyn Any</code>, i.e. it implements the <code>Hello</code> trait for trait objects of the <code>Any</code> trait. If you want to call this on an object, you first need to cast it to a trait object, like <code>(&amp;foo as &amp;dyn Any).hello()</code>."}], "answers": [{"tags": [], "owner": {"reputation": 22505, "user_id": 1411457, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/XqssD.png?s=128&g=1", "display_name": "harmic", "link": "https://stackoverflow.com/users/1411457/harmic"}, "is_accepted": true, "score": 2, "last_activity_date": 1558066129, "creation_date": 1558066129, "answer_id": 56179481, "question_id": 56177664, "link": "https://stackoverflow.com/questions/56177664/universal-impl-for-all-t-t-mut-t-t-t-mut-t/56179481#56179481", "title": "Universal impl for all T, &amp;T, &amp;mut T, [T], &amp;[T], *mut T", "body": "<p>Well, you could make a generic implementation of your trait:</p>\n\n<pre><code>pub trait Hello {\n    fn hello(&amp;self);\n}\n\nimpl&lt;T&gt; Hello for T {\n    fn hello(&amp;self) {\n        println!(\"Hello!!!!!\");\n    }\n}\n\nfn main() {\n    let foo = 0 as u8;\n    foo.hello();\n    let bar = \"world!\".to_string();\n    bar.hello();\n}\n</code></pre>\n\n<p>Note that Rust currently does not allow specialization of generics (although there is an <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1210-impl-specialization.md\" rel=\"nofollow noreferrer\">open RFC</a> on it) so your trait implementation has to work as-is for any T.</p>\n"}], "owner": {"reputation": 375, "user_id": 11134001, "user_type": "registered", "profile_image": "https://graph.facebook.com/2130930103663266/picture?type=large", "display_name": "Thomas Braun", "link": "https://stackoverflow.com/users/11134001/thomas-braun"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 97, "favorite_count": 0, "accepted_answer_id": 56179481, "answer_count": 1, "score": 0, "last_activity_date": 1558066129, "creation_date": 1558048101, "last_edit_date": 1558048581, "question_id": 56177664, "link": "https://stackoverflow.com/questions/56177664/universal-impl-for-all-t-t-mut-t-t-t-mut-t", "title": "Universal impl for all T, &amp;T, &amp;mut T, [T], &amp;[T], *mut T", "body": "<p>Consider this code:</p>\n\n<pre><code>pub trait Hello {\n    fn hello(&amp;self);\n}\n\nimpl Hello for Any {\n    fn hello(&amp;self) {\n        println!(\"Hello!!!!!\");\n    }\n}\n</code></pre>\n\n<p>I remember seeing somewhere that there was a new feature in Rust that lets you implement a function that is directly accessible for all objects like this:</p>\n\n<pre><code>let foo = 0 as u8;\nfoo.hello();\n</code></pre>\n\n<p>Unfortunately, I have not been able to find it. Is there actually a global/universal \"implementor\"?</p>\n"}, {"tags": ["compilation", "rust", "computer-science", "interpreter"], "answers": [{"comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1558072449, "post_id": 56177758, "comment_id": 98986432, "body": "Can you please explain why the RLS should be similar to a rust interpreter?"}, {"owner": {"reputation": 1054, "user_id": 187769, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/9d0faacd977c18b42da378bcfe38927c?s=128&d=identicon&r=PG", "display_name": "RandomInsano", "link": "https://stackoverflow.com/users/187769/randominsano"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1558105818, "post_id": 56177758, "comment_id": 99003399, "body": "Sorry, I jumped right to an answer without connecting the dots. Compiling the source real time as it&#39;s changing is something RLS 2.0 is trying to solve, but without a command line interface like Python. I think your concerns would be solved by the goals of that project. You <i>could</i> write a command line interpreter on top of RLS2.0."}], "tags": [], "owner": {"reputation": 1054, "user_id": 187769, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/9d0faacd977c18b42da378bcfe38927c?s=128&d=identicon&r=PG", "display_name": "RandomInsano", "link": "https://stackoverflow.com/users/187769/randominsano"}, "is_accepted": false, "score": 3, "last_activity_date": 1558049111, "creation_date": 1558049111, "answer_id": 56177758, "question_id": 56177318, "link": "https://stackoverflow.com/questions/56177318/is-there-a-rust-interpreter/56177758#56177758", "title": "Is there a Rust interpreter?", "body": "<p>I think the closest thing to what you'd like to see is the <a href=\"https://github.com/rust-lang/rls\" rel=\"nofollow noreferrer\">Rust Language Server</a>. Specifically, IDEs use this to feed in just the changes so that code compiles much faster.</p>\n\n<p>There's also <a href=\"https://github.com/rust-lang/compiler-team/blob/master/working-groups/rls-2.0/NOTES.md\" rel=\"nofollow noreferrer\">work on RLS 2.0</a> that you might be interested in watching / contributing to.</p>\n\n<p>As far as UI / Web, that's a different ball of wax that I haven't had much luck with yet.</p>\n"}, {"comments": [{"owner": {"reputation": 1192, "user_id": 664509, "user_type": "registered", "accept_rate": 12, "profile_image": "https://www.gravatar.com/avatar/8dba6ba9791388d4c527a6f7b78a2724?s=128&d=identicon&r=PG&f=1", "display_name": "SomethingsGottaGive", "link": "https://stackoverflow.com/users/664509/somethingsgottagive"}, "edited": false, "score": 0, "creation_date": 1558174298, "post_id": 56182274, "comment_id": 99019314, "body": "Couldn&#39;t the rust compiler skip all those checks and just interpret the code?"}, {"owner": {"user_type": "does_not_exist", "display_name": "user3646022"}, "reply_to_user": {"reputation": 1192, "user_id": 664509, "user_type": "registered", "accept_rate": 12, "profile_image": "https://www.gravatar.com/avatar/8dba6ba9791388d4c527a6f7b78a2724?s=128&d=identicon&r=PG&f=1", "display_name": "SomethingsGottaGive", "link": "https://stackoverflow.com/users/664509/somethingsgottagive"}, "edited": false, "score": 0, "creation_date": 1582975628, "post_id": 56182274, "comment_id": 106966363, "body": "@SomethingsGottaGive Maybe not the rust compiler in the current form, but sure it would be possible to build an interpreter for pure rust that skips all safety checks and uses an GC for memory management. This would have similiar performance as Python but could be used for fast testing and REPL."}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 2, "last_activity_date": 1558080712, "creation_date": 1558080712, "answer_id": 56182274, "question_id": 56177318, "link": "https://stackoverflow.com/questions/56177318/is-there-a-rust-interpreter/56182274#56182274", "title": "Is there a Rust interpreter?", "body": "<p><strong>No</strong>, there is currently no Rust interpreter that can simply be used as a replacement for compiling with <code>rustc</code>.</p>\n\n<p>There is <a href=\"https://github.com/rust-lang/miri\" rel=\"nofollow noreferrer\"><strong><code>miri</code></strong></a> which is an interpreter for MIR, the Rust \"mid-level intermediate representation\" (basically defining a control flow graph). The Rust compiler generates MIR code as part of its usual pipeline. This MIR code is usually translated to LLVM-IR next, which is then translated to machine code by LLVM. Miri allows to interpret that MIR code directly.</p>\n\n<p><em>However</em>, Miri is not really build for programmers to interpret their project instead of compiling it. At least not yet. Instead, it is built mainly to check unsafe code for undefined behavior: a dynamic code analysis tool/sanitizer. Additionally, Miri is still notably limited. In particular, last time I checked, <code>extern \"C\"</code> calls were not supported.</p>\n\n<p>I would also say that Rust is not as well suited to be completely  interpret as other languages. The Rust compiler performs a fair amount of heavy analysis on the source code which has to be done at some point one way or another. </p>\n"}], "owner": {"reputation": 1192, "user_id": 664509, "user_type": "registered", "accept_rate": 12, "profile_image": "https://www.gravatar.com/avatar/8dba6ba9791388d4c527a6f7b78a2724?s=128&d=identicon&r=PG&f=1", "display_name": "SomethingsGottaGive", "link": "https://stackoverflow.com/users/664509/somethingsgottagive"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2304, "favorite_count": 0, "answer_count": 2, "score": 6, "last_activity_date": 1558080776, "creation_date": 1558045402, "last_edit_date": 1558080776, "question_id": 56177318, "link": "https://stackoverflow.com/questions/56177318/is-there-a-rust-interpreter", "title": "Is there a Rust interpreter?", "body": "<p>I am just starting with Rust and was wondering: is a Rust interpreter? With an interpreter the Rust compiler would not need to compile all the source files every time it is invoked and would only interpret the code as it changed. It's how JavaScript and Python have no real compile time.  </p>\n\n<p>There's incremental compilation with Rust but it's still very slow with big projects. It would be a boon to GUI development with rust for the web IMO.</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": -1, "last_activity_date": 1558074996, "creation_date": 1558074996, "answer_id": 56180859, "question_id": 56175542, "link": "https://stackoverflow.com/questions/56175542/rust-validate-a-username-and-password-against-active-directory/56180859#56180859", "title": "Rust: Validate a username and password against Active Directory?", "body": "<p><a href=\"https://en.wikipedia.org/wiki/Active_Directory\" rel=\"nofollow noreferrer\">Active Directory</a> is Microsoft's implementation of the LDAP protocol, so any <a href=\"https://crates.io/search?q=ldap\" rel=\"nofollow noreferrer\">LDAP crate</a> should allow you to do what you want.</p>\n"}], "owner": {"reputation": 99, "user_id": 8183973, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/526550e86061a30b3fdcf01dee3bf2c0?s=128&d=identicon&r=PG&f=1", "display_name": "Fran&#231;ois Dubois", "link": "https://stackoverflow.com/users/8183973/fran%c3%a7ois-dubois"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 231, "favorite_count": 0, "answer_count": 1, "score": -1, "last_activity_date": 1558090349, "creation_date": 1558035541, "last_edit_date": 1558090349, "question_id": 56175542, "link": "https://stackoverflow.com/questions/56175542/rust-validate-a-username-and-password-against-active-directory", "title": "Rust: Validate a username and password against Active Directory?", "body": "<p>I want to validate a user/password against active directory. I found solution using .NET code (System.DirectoryServices.AccountManagement), but I can\u2019t find the call made to the windows api. I know LogonUser in WinApi, but it validates the username/password on the specific host running the code. I want to validate a user against the active directory directly. Any idea ?</p>\n\n<p>I have tried with LogonUser, but there is some cases where my user can't log on the host running the code calling LogonUser, but he can on other host of the domain so I want to accept that user.</p>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558015105, "post_id": 56168525, "comment_id": 98967195, "body": "I&#39;m not sure I understand correctly. Does the <a href=\"https://doc.rust-lang.org/cargo/reference/manifest.html#the-patch-section\" rel=\"nofollow noreferrer\"><code>patch</code> section of <code>Cargo.toml</code></a> solve your problem?"}, {"owner": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558023315, "post_id": 56168525, "comment_id": 98971972, "body": "It&#39;s a good start, but fails when I try to define a lib with the same name as the original one. I&#39;ll look into it some more."}, {"owner": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558110334, "post_id": 56168525, "comment_id": 99005450, "body": "Edited the question. @SvenMarnach, patch should work, except it doesn&#39;t accept local paths, only an URL or a registry name. And I don&#39;t think I can build the plem_main binary directly from an URL, can I?"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558123420, "post_id": 56168525, "comment_id": 99010422, "body": "You should be able to use a local path in the patch section \u2013 see the example <code>bar = { path = &#39;my&#47;local&#47;bar&#39; }</code> in the linked documentation."}, {"owner": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558130785, "post_id": 56168525, "comment_id": 99012718, "body": "I meant it doesn&#39;t let you write <code>[patch.&#39;my&#47;local&#47;bar&#39;] etc.</code>, i.e. when specifying the thing-to-replace, not the thing-with-which-to-replace."}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1558206305, "post_id": 56168525, "comment_id": 99026719, "body": "I see. Honestly, I&#39;ve got no idea whether this is possible with <code>patch</code>. You could also try <code>replace</code> instead."}], "owner": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 57, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1558110061, "creation_date": 1558009572, "last_edit_date": 1558110061, "question_id": 56168525, "link": "https://stackoverflow.com/questions/56168525/can-i-swap-out-the-library-used-by-a-binary-with-a-wrapper-when-building-a-third", "title": "Can I swap out the library used by a binary with a wrapper when building a third-party crate?", "body": "<p>Let's say there is a vendored third-party cargo project consisting of a library <code>plem</code> and a binary <code>plem_main</code> that I want to extend with some functionality of my own. Crucially, the functionality needs to go in the library <code>plem</code>, not the binary <code>plem_main</code> (which can stay the same). I could write a wrapper <code>my_plem</code> around the library that offers the same interface to the binary, but with the extra functionality included. The project would be set up like this:</p>\n\n<pre><code>.\n\u251c\u2500\u2500 Cargo.toml\n\u251c\u2500\u2500 my_plem\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Cargo.toml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 src\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 lib.rs\n\u2514\u2500\u2500 third-party\n    \u251c\u2500\u2500 plem\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 Cargo.toml\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 src\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 lib.rs\n    \u2514\u2500\u2500 plem_main\n        \u251c\u2500\u2500 Cargo.toml\n        \u2514\u2500\u2500 src\n            \u2514\u2500\u2500 main.rs\n</code></pre>\n\n<p><code>my_plem/src/lib.rs</code> would depend on things in <code>third-party/plem/src/lib.rs</code> and reexport or overwrite the functions exported by the latter. Is there a good way to get cargo to build the binary <code>plem_main</code> on top of <code>my_plem</code> instead of <code>plem</code>?</p>\n\n<p>\"Best\" here means that the solution has no or minimal merge conflicts when updating <code>plem</code> in my project and doesn't duplicate the code of <code>plem_main</code>. Ideally it does not touch third-party at all.</p>\n"}, {"tags": ["websocket", "rust"], "comments": [{"owner": {"reputation": 890, "user_id": 11389321, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9048fa908f45d0795f0a5c47eaa8a637?s=128&d=identicon&r=PG&f=1", "display_name": "ecstaticm0rse", "link": "https://stackoverflow.com/users/11389321/ecstaticm0rse"}, "edited": false, "score": 2, "creation_date": 1558043947, "post_id": 56163680, "comment_id": 98980687, "body": "I took a quick look at the source of <code>rouille</code>, and it seems that if <code>read</code> were to return <code>Ok(0)</code> <a href=\"https://github.com/tomaka/rouille/blob/70cc68738ce1549ba208d628064f8dc8dc270f3e/src/websocket/websocket.rs#L146\" rel=\"nofollow noreferrer\">here</a> it could cause <code>websocket.next()</code> to loop indefinitely. <code>Ok(0)</code> can be returned to indicate EOF. Could you set a breakpoint here and try to confim this?"}, {"owner": {"reputation": 152698, "user_id": 745, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/edf857d71f672d8f411ef6b8376316b8?s=128&d=identicon&r=PG", "display_name": "dbr", "link": "https://stackoverflow.com/users/745/dbr"}, "reply_to_user": {"reputation": 890, "user_id": 11389321, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9048fa908f45d0795f0a5c47eaa8a637?s=128&d=identicon&r=PG&f=1", "display_name": "ecstaticm0rse", "link": "https://stackoverflow.com/users/11389321/ecstaticm0rse"}, "edited": false, "score": 0, "creation_date": 1558101080, "post_id": 56163680, "comment_id": 99000656, "body": "@ecstaticm0rse Aha, well spotted - that is indeed the problem! If the socket gets closed abruptly that loop gets stuck with <code>n</code> set to zero"}], "answers": [{"tags": [], "owner": {"reputation": 152698, "user_id": 745, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/edf857d71f672d8f411ef6b8376316b8?s=128&d=identicon&r=PG", "display_name": "dbr", "link": "https://stackoverflow.com/users/745/dbr"}, "is_accepted": true, "score": 1, "last_activity_date": 1558102242, "creation_date": 1558102242, "answer_id": 56188177, "question_id": 56163680, "link": "https://stackoverflow.com/questions/56163680/high-cpu-usage-from-websocket-in-rouille/56188177#56188177", "title": "High CPU usage from websocket in Rouille", "body": "<p>As @ecstaticm0rse spotted in a comment, the issue is within Rouille 3.0.0,</p>\n\n<pre><code>fn next(&amp;mut self) -&gt; Option&lt;Message&gt; {\n    loop {\n        [...snip...]\n        let n = match self.socket.as_mut().unwrap().read(&amp;mut buf) {\n            Ok(n) =&gt; n,\n            Err(ref err) if err.kind() == io::ErrorKind::Interrupted =&gt; 0,\n            Err(_) =&gt; {\n                self.socket = None;\n                return None;\n            },\n        };\n        [...snip...]\n        for element in self.state_machine.feed(&amp;buf[0 .. n]) {\n        [...snip...]\n</code></pre>\n\n<p>The call to <code>read(...)</code> might return <code>Ok(0)</code> to signify EOF if the socket is closed (not closed via the websocket protocol, but at a network level such as a device losing it's connection)</p>\n\n<p>Since <code>n</code> is set to zero, the <code>for element ...</code> in loop because of the <code>0 .. n</code> range, and then calls <code>read(...)</code> again, and then loops back to calling <code>read()</code> (which again returns <code>Ok(0)</code>, and, loops on for ever)</p>\n\n<p>Reproduction of the bug was to use a websocket client like <a href=\"https://github.com/vi/websocat\" rel=\"nofollow noreferrer\">websocat</a> and connect to the server and kill the client with sigint (ctrl+c) a few times.</p>\n\n<p>I have reported this bug onthe Rouille issue tracker and created a pull request to fix it,</p>\n\n<p><a href=\"https://github.com/tomaka/rouille/issues/211\" rel=\"nofollow noreferrer\">https://github.com/tomaka/rouille/issues/211</a></p>\n"}], "owner": {"reputation": 152698, "user_id": 745, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/edf857d71f672d8f411ef6b8376316b8?s=128&d=identicon&r=PG", "display_name": "dbr", "link": "https://stackoverflow.com/users/745/dbr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 125, "favorite_count": 0, "accepted_answer_id": 56188177, "answer_count": 1, "score": 1, "last_activity_date": 1558102242, "creation_date": 1557993633, "question_id": 56163680, "link": "https://stackoverflow.com/questions/56163680/high-cpu-usage-from-websocket-in-rouille", "title": "High CPU usage from websocket in Rouille", "body": "<p>I have a small web-app server written in Rust, the code <a href=\"https://github.com/dbr/juke-rs/\" rel=\"nofollow noreferrer\">is available here</a>.</p>\n\n<p>It all functions properly, however after being actively used for \"some time\", the process CPU usage will be at 100% (as reported by <code>top</code>) and stay there until it is restarted.</p>\n\n<p>The problem is I cannot work out what is causing this CPU usage, nor how to go about debugging it effectively - mainly as I cannot recreate the CPU usage locally. It occurs on both FreeBSD (where the process was accessed directly) and on the new server running Ubuntu 18.10 (where it was reversed-proxied via Nginx); however I cannot recreate this on my local machine running macOS (possibly due to the OS, but possible just different access</p>\n\n<p>If I run <code>perf record</code> the report shows this:</p>\n\n<pre><code>Samples: 44K of event 'cpu-clock', Event count (approx.): 11073000000\nOverhead  Command          Shared Object               Symbol\n  21.92%  juke             [kernel.kallsyms]           [k] do_syscall_64\n  17.52%  juke             libpthread-2.23.so          [.] __libc_recv\n   5.53%  juke             [kernel.kallsyms]           [k] inet_diag_table+0x800000004df0\n   4.13%  juke             [kernel.kallsyms]           [k] tcp_recvmsg\n   3.59%  juke             [kernel.kallsyms]           [k] __fget\n   3.31%  juke             [kernel.kallsyms]           [k] inet_recvmsg\n   3.22%  juke             [kernel.kallsyms]           [k] seccomp_run_filters\n   3.10%  juke             [kernel.kallsyms]           [k] aa_profile_af_perm\n   3.05%  juke             [kernel.kallsyms]           [k] aa_label_sk_perm\n   2.27%  juke             [kernel.kallsyms]           [k] aa_sk_perm\n   1.94%  juke             [kernel.kallsyms]           [k] __sys_recvfrom\n   1.75%  juke             [kernel.kallsyms]           [k] tcp_release_cb\n   1.74%  juke             [kernel.kallsyms]           [k] __local_bh_enable_ip\n   1.74%  juke             [kernel.kallsyms]           [k] syscall_trace_enter\n   1.74%  juke             [kernel.kallsyms]           [k] __x64_sys_recvfrom\n   1.63%  juke             libpthread-2.23.so          [.] __pthread_enable_asynccancel\n   1.54%  juke             [kernel.kallsyms]           [k] release_sock\n   1.44%  juke             [kernel.kallsyms]           [k] __seccomp_filter\n   1.34%  juke             libpthread-2.23.so          [.] __pthread_disable_asynccancel\n   1.31%  juke             juke                        [.] _ZN88_$LT$tiny_http..util..sequential..SequentialReader$LT$R$GT$$u20$as$u20$std..io..Read$GT$4read17h1ab62509f0eccd24E\n   1.23%  juke             juke                        [.] _ZN71_$LT$std..io..buffered..BufReader$LT$R$GT$$u20$as$u20$std..io..Read$GT$4read17he719b00617f471fdE\n   1.18%  juke             juke                        [.] _ZN91_$LT$rouille..websocket..websocket..Websocket$u20$as$u20$core..iter..iterator..Iterator$GT$4next17h0096bf051fcbfa61E\n   1.09%  juke             [kernel.kallsyms]           [k] import_single_range\n   0.98%  juke             [kernel.kallsyms]           [k] aa_label_next_confined\n   0.94%  juke             [kernel.kallsyms]           [k] sock_recvmsg\n   0.76%  juke             [kernel.kallsyms]           [k] apparmor_socket_recvmsg\n   0.75%  juke             [kernel.kallsyms]           [k] _raw_spin_lock_bh\n   0.70%  juke             [kernel.kallsyms]           [k] __fget_light\n   0.63%  juke             [kernel.kallsyms]           [k] __indirect_thunk_start\n   0.61%  juke             [kernel.kallsyms]           [k] rcu_all_qs\n   0.55%  juke             juke                        [.] _ZN96_$LT$tiny_http..util..custom_stream..CustomStream$LT$R$C$$u20$W$GT$$u20$as$u20$std..io..Read$GT$4read17h4875891095ddc7f7E\n   0.50%  juke             [kernel.kallsyms]           [k] security_socket_recvmsg\n   0.44%  juke             [kernel.kallsyms]           [k] _raw_spin_unlock_bh\n</code></pre>\n\n<p>..and if I attach gdb to it, there are a bunch of threads (around 15?) which are doing this:</p>\n\n<pre><code>#0  0x00007f41cf58087f in recv () from target:/lib/x86_64-linux-gnu/libpthread.so.0\n#1  0x00005598b9ef49ba in recv_with_flags () at src/libstd/sys/unix/net.rs:228\n#2  read () at src/libstd/sys/unix/net.rs:237\n#3  read () at src/libstd/sys_common/net.rs:255\n#4  read () at src/libstd/net/tcp.rs:570\n#5  0x00005598b9c3d6dc in &lt;std::io::buffered::BufReader&lt;R&gt; as std::io::Read&gt;::read ()\n#6  0x00005598b9c30441 in &lt;tiny_http::util::sequential::SequentialReader&lt;R&gt; as std::io::Read&gt;::read ()\n#7  0x00005598b9be94c2 in &lt;tiny_http::util::custom_stream::CustomStream&lt;R, W&gt; as std::io::Read&gt;::read ()\n#8  0x00005598b9c0caad in &lt;rouille::websocket::websocket::Websocket as core::iter::traits::iterator::Iterator&gt;::next ()\n#9  0x00005598b9bcf839 in juke::web::websocket_handling_thread ()\n#10 0x00005598b9bc67b4 in std::sys_common::backtrace::__rust_begin_short_backtrace ()\n#11 0x00005598b9bb109c in std::panicking::try::do_call ()\n#12 0x00005598b9f0113a in __rust_maybe_catch_panic () at src/libpanic_unwind/lib.rs:87\n#13 0x00005598b9bba0b0 in &lt;F as alloc::boxed::FnBox&lt;A&gt;&gt;::call_box ()\n#14 0x00005598b9f004ce in call_once&lt;(),()&gt; () at /rustc/fc50f328b0353b285421b8ff5d4100966387a997/src/liballoc/boxed.rs:759\n#15 start_thread () at src/libstd/sys_common/thread.rs:14\n#16 thread_start () at src/libstd/sys/unix/thread.rs:81\n#17 0x00007f41cf5776ba in start_thread () from target:/lib/x86_64-linux-gnu/libpthread.so.0\n#18 0x00007f41cf09741d in clone () from target:/lib/x86_64-linux-gnu/libc.so.6\n</code></pre>\n\n<p>This backtrace points towards this section in my code:</p>\n\n<p><a href=\"https://github.com/dbr/juke-rs/blob/f845e36402d7106dc4b2262adc165fb3e5f4c123/src/web.rs#L64\" rel=\"nofollow noreferrer\">https://github.com/dbr/juke-rs/blob/f845e36402d7106dc4b2262adc165fb3e5f4c123/src/web.rs#L64</a></p>\n\n<pre><code>fn websocket_handling_thread(\n    mut websocket: websocket::Websocket,\n    global_status: &amp;Arc&lt;RwLock&lt;PlaybackStatus&gt;&gt;,\n    global_queue: &amp;Arc&lt;RwLock&lt;TheList&gt;&gt;,\n) {\n    // We wait for a new message to come from the websocket.\n    while let Some(message) = websocket.next() {\n</code></pre>\n\n<p>..called via:</p>\n\n<pre><code>(GET) (/ws) =&gt; {\n    let (response, websocket) = try_or_400!(websocket::start(&amp;request, Some(\"juke\")));\n    let gs = global_status.clone();\n    let gq = global_queue.clone();\n    std::thread::spawn(move || {\n        let ws = websocket.recv().unwrap();\n        websocket_handling_thread(ws, &amp;gs, &amp;gq);\n    });\n    response\n},\n</code></pre>\n\n<p>However this all appears to be in line with Rouille's examples - is this a bug in Rouille (or the underlying tiny_http library), or is there anything obvious I am doing wrong?</p>\n"}, {"tags": ["c++", "go", "rust", "toolchain", "build-tools"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 3, "creation_date": 1557989910, "post_id": 56161935, "comment_id": 98952569, "body": "Note: The Rust community is working on a Rust backend (cranelift) as an alternative (but not a replacement) to LLVM. Even then, though, the rustc compiler would still depend on a libc implementation being present. I think steed (embedded) and relibc (Redox) are about re-implementing the libc in Rust, but not clear where they are."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1557995397, "post_id": 56161935, "comment_id": 98955494, "body": "I think this question is either too broad either too small, basically the answer is because rustc require it. Long answer is just too broad."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1557995929, "post_id": 56161935, "comment_id": 98955782, "body": "The answer for Rust is that by default it compiles by linking statically to the libc. I wonder if the C toolchain must be present if you use the flag for the dynamic linking. I know too few about Go to answer, though."}, {"owner": {"reputation": 7202, "user_id": 2491, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/00f2c9b243b278d2ba50bc1aeeccc642?s=128&d=identicon&r=PG&f=1", "display_name": "Svend", "link": "https://stackoverflow.com/users/2491/svend"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1557996299, "post_id": 56161935, "comment_id": 98955994, "body": "@Stargateur if you&#39;re new to programming, compiler infrastructure can be quite mysterious. Asking why one seemingly unrelated depends on another is a perfectly fair question. Seems programming related to me as well, but there&#39;s so many estoeric SE these days and people love to split hairs."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 7202, "user_id": 2491, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/00f2c9b243b278d2ba50bc1aeeccc642?s=128&d=identicon&r=PG&f=1", "display_name": "Svend", "link": "https://stackoverflow.com/users/2491/svend"}, "edited": false, "score": 1, "creation_date": 1557997831, "post_id": 56161935, "comment_id": 98956833, "body": "@Svend I didn&#39;t say it was off topic, I said it&#39;s too broad. Explain &quot;compiler infrastructure&quot; is too broad."}, {"owner": {"reputation": 1230, "user_id": 1196058, "user_type": "registered", "accept_rate": 33, "profile_image": "https://graph.facebook.com/100000940246001/picture?type=large", "display_name": "JackSparrow123", "link": "https://stackoverflow.com/users/1196058/jacksparrow123"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1558012821, "post_id": 56161935, "comment_id": 98965725, "body": "@Stargateur you missed the whole point, I wanted to know why Go does not require a separate toolchain like Rust does - simple, not <i>why</i> Rust requires a Toolchain - that info is already available in Google."}, {"owner": {"reputation": 1230, "user_id": 1196058, "user_type": "registered", "accept_rate": 33, "profile_image": "https://graph.facebook.com/100000940246001/picture?type=large", "display_name": "JackSparrow123", "link": "https://stackoverflow.com/users/1196058/jacksparrow123"}, "edited": false, "score": 0, "creation_date": 1558012836, "post_id": 56161935, "comment_id": 98965736, "body": "I feel that the downgrade in my post rating is unfair."}], "answers": [{"comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1558007671, "post_id": 56166959, "comment_id": 98962431, "body": "Maybe the OP is talking about a C++ toolchain because he uses a Windows OS. It seems that there is not a clear difference in it between the C and C++ toolchains."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1558009708, "post_id": 56166959, "comment_id": 98963608, "body": "@FrenchBoiethios: Possibly. I clarified this is a different requirement in general, and a much less onerous one."}, {"owner": {"reputation": 1230, "user_id": 1196058, "user_type": "registered", "accept_rate": 33, "profile_image": "https://graph.facebook.com/100000940246001/picture?type=large", "display_name": "JackSparrow123", "link": "https://stackoverflow.com/users/1196058/jacksparrow123"}, "edited": false, "score": 0, "creation_date": 1558012778, "post_id": 56166959, "comment_id": 98965691, "body": "Thanks @MatthieuM. your answer on the Go part is all I was looking for, and thanks for explaining the part on Rust as well."}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 15, "last_activity_date": 1558004197, "creation_date": 1558004197, "answer_id": 56166959, "question_id": 56161935, "link": "https://stackoverflow.com/questions/56161935/why-does-rust-require-a-c-toolchain-to-produce-a-rust-binary-while-languages/56166959#56166959", "title": "Why does Rust require a C++ toolchain to produce a Rust binary, while languages like Go do not have this requirement?", "body": "<p><strong>TL;DR: Because everyone has a C toolchain.</strong></p>\n\n<p><em>Slight correction: rustc does not require a C++ toolchain, it only requires a C toolchain. Notably, rustc created binaries only depend on <code>libc</code> (or equivalent), not on <code>libstdc++</code> (or equivalent).</em></p>\n\n<hr>\n\n<p>As Go demonstrated, it is possible to not require a C toolchain. You only need to re-implement its functionality:</p>\n\n<ul>\n<li>You need to implement your own linker, respecting the target platform format.</li>\n<li>You need to implement your own libc (aka OS layer).</li>\n</ul>\n\n<p>There are advantages to doing so, such as possibly faster compilation or easier cross-compiling, however there is a cost in doing the implementation, and <em>it's easy to <a href=\"https://marcan.st/2017/12/debugging-an-evil-go-runtime-bug/\" rel=\"noreferrer\">get things wrong</a></em>.</p>\n\n<hr>\n\n<p>The Rust community preferred to put more effort into the language than in the toolchain, and therefore reusing the stock toolchain was easier. Specifically, rustc will require a platform linker (<code>ld</code> on Unix) and platform equivalent to <code>libc</code>.</p>\n\n<p>This is not a core design principle, it's just a pragmatic approach, and there are projects to cut down on these dependencies:</p>\n\n<ul>\n<li>Using <a href=\"https://lld.llvm.org/\" rel=\"noreferrer\">lld</a> rather than ld would allow shipping a single linker with rustc which can target all platforms.</li>\n<li>Using <a href=\"https://github.com/CraneStation/cranelift\" rel=\"noreferrer\">cranelift</a> as an alternative backend could also remove the dependency on ld.</li>\n<li>The Redox project is working on <a href=\"https://github.com/redox-os/relibc\" rel=\"noreferrer\">relibc</a>, a portable Rust implementation of the <code>libc</code> API.</li>\n</ul>\n\n<p>Those are all work in progress, and in the meantime rustc will require a C toolchain. Furthermore, even in the foreseeable future, I would expect rustc to require a C toolchain for targets not yet covered by any Rust toolchain, just so you can use the target without waiting for some hypothetical development.</p>\n"}], "owner": {"reputation": 1230, "user_id": 1196058, "user_type": "registered", "accept_rate": 33, "profile_image": "https://graph.facebook.com/100000940246001/picture?type=large", "display_name": "JackSparrow123", "link": "https://stackoverflow.com/users/1196058/jacksparrow123"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 543, "favorite_count": 2, "accepted_answer_id": 56166959, "answer_count": 1, "score": 3, "last_activity_date": 1558004197, "creation_date": 1557987420, "last_edit_date": 1557993671, "question_id": 56161935, "link": "https://stackoverflow.com/questions/56161935/why-does-rust-require-a-c-toolchain-to-produce-a-rust-binary-while-languages", "title": "Why does Rust require a C++ toolchain to produce a Rust binary, while languages like Go do not have this requirement?", "body": "<p>Compiling a Rust file with <code>rustc foo.rs</code> fails if I don't have a C++ toolchain installed. But when compiling a Go program, such a toolchain is not required. Why is that?</p>\n"}, {"tags": ["asynchronous", "rust", "rust-tokio"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1557976506, "post_id": 56159897, "comment_id": 98948653, "body": "did you just try to use a string ? Also, it&#39;s better on server to limit memory allocation from client"}, {"owner": {"reputation": 141, "user_id": 5698862, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/490f92d05ab10973a695fd6ac5202016?s=128&d=identicon&r=PG&f=1", "display_name": "lucarlig", "link": "https://stackoverflow.com/users/5698862/lucarlig"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1557977221, "post_id": 56159897, "comment_id": 98948779, "body": "@Stargateur yes I coulnd&#39;t make it compile. Interesting makes total sense, do you know where can i find more info about this kind of design decisions on server programming? Book or whatever."}], "answers": [{"tags": [], "owner": {"reputation": 1291, "user_id": 6331045, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/189f94db303d16b891800f11846bd753?s=128&d=identicon&r=PG&f=1", "display_name": "Laney", "link": "https://stackoverflow.com/users/6331045/laney"}, "is_accepted": true, "score": 2, "last_activity_date": 1557994309, "creation_date": 1557994309, "answer_id": 56163860, "question_id": 56159897, "link": "https://stackoverflow.com/questions/56159897/buffer-in-rust-tokio-streams-is-there-a-way-to-use-something-other-then-u8/56163860#56163860", "title": "buffer in rust-tokio streams is there a way to use something other then &amp;[u8]?", "body": "<p>I believe <code>tokio_codec</code> is a right tool for such tasks. Tokio documentation: <a href=\"https://tokio.rs/docs/going-deeper/frames/\" rel=\"nofollow noreferrer\">https://tokio.rs/docs/going-deeper/frames/</a>  </p>\n\n<p>It uses <code>Bytes</code> / <code>BytesMut</code> as its buffer - very powerful structure which will allow you to process your data however you want and avoid unnecessary copies</p>\n"}], "owner": {"reputation": 141, "user_id": 5698862, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/490f92d05ab10973a695fd6ac5202016?s=128&d=identicon&r=PG&f=1", "display_name": "lucarlig", "link": "https://stackoverflow.com/users/5698862/lucarlig"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 258, "favorite_count": 2, "accepted_answer_id": 56163860, "answer_count": 1, "score": 3, "last_activity_date": 1557994309, "creation_date": 1557973018, "question_id": 56159897, "link": "https://stackoverflow.com/questions/56159897/buffer-in-rust-tokio-streams-is-there-a-way-to-use-something-other-then-u8", "title": "buffer in rust-tokio streams is there a way to use something other then &amp;[u8]?", "body": "<p>I am trying to make a echo server that capitalize a String when it replies, to practice with tokio as an exercise. I used an array as a buffer which is annoying because what if the string overflows the buffer?</p>\n\n<p>I would like to know if there is a better way to this without using an array, ideally just using a <strong>String</strong> or a vector without needing to create the buffer array.</p>\n\n<p>I tried read_from_string() but is not <strong>async</strong> and ends up blocking the socket.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate tokio;\nuse tokio::net::TcpListener;\nuse tokio::prelude::*;\n\nfn main() {\n    let addr = \"127.0.0.1:6142\".parse().unwrap();\n    let listener = TcpListener::bind(&amp;addr).unwrap();\n\n    let server = listener\n        .incoming()\n        .for_each(|socket| {\n\n            let (mut reader, mut writer) = socket.split();\n            let mut buffer = [0; 16];\n            reader.poll_read(&amp;mut buffer)?;\n\n            let s = std::str::from_utf8(&amp;buffer).unwrap();\n            s.to_uppercase();\n            writer.poll_write(&amp;mut s.as_bytes())?;\n\n            Ok(())\n        })\n        .map_err(|e| {\n            eprintln!(\"something went wrong {}\", e);\n        });\n\n    tokio::run(server);\n}\n</code></pre>\n\n<p>Results:\n\"012345678901234567890\" becomes -> \"0123456789012345\"</p>\n\n<p>I could increase the buffer of course but it would just kick the can down the road.</p>\n"}, {"tags": ["visual-studio-code", "rust"], "answers": [{"comments": [{"owner": {"reputation": 570, "user_id": 2780630, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/57f6fdc404f5a270e608f3df85f40dfb?s=128&d=identicon&r=PG&f=1", "display_name": "DanielV", "link": "https://stackoverflow.com/users/2780630/danielv"}, "edited": false, "score": 0, "creation_date": 1558051235, "post_id": 56177973, "comment_id": 98982144, "body": "I eventually found a bare minimum answer to my question.  If someone finds a more detailed response and can confirm or deny my suspicion that this is a big bug then I will accept that answer instead, thank you."}], "tags": [], "owner": {"reputation": 570, "user_id": 2780630, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/57f6fdc404f5a270e608f3df85f40dfb?s=128&d=identicon&r=PG&f=1", "display_name": "DanielV", "link": "https://stackoverflow.com/users/2780630/danielv"}, "is_accepted": false, "score": 0, "last_activity_date": 1558051194, "creation_date": 1558051194, "answer_id": 56177973, "question_id": 56159436, "link": "https://stackoverflow.com/questions/56159436/visual-studio-code-task-is-prepending-the-working-directory-to-the-command/56177973#56177973", "title": "Visual Studio Code Task is Prepending the working directory to the command", "body": "<p>The answer to this question <a href=\"https://stackoverflow.com/questions/50707118/how-to-debug-rust-unit-tests-on-windows\">How to debug Rust unit tests on Windows?</a>\nsuggests that changing</p>\n\n<pre><code>\"command\": \"cargo build\",\n</code></pre>\n\n<p>into </p>\n\n<pre><code>\"command\": \"cargo\",\n    \"args\": [\n        \"build\"\n    ],\n</code></pre>\n\n<p>in the tasks.json file works and somehow it does.  Maybe the editor is configured to search the %path% for single word commands, or maybe some plugin I installed overwrote the \"cargo\" command.  Maybe the reason echo wasn't found is because it is a terminal command, not a program.  Maybe the error message was a lie and it was only reporting that it couldn't find workspacefolder\\command despite checking %path%?  Or maybe none of that.  I have no idea.  It is some pretty idiosyncratic behavior.</p>\n"}], "owner": {"reputation": 570, "user_id": 2780630, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/57f6fdc404f5a270e608f3df85f40dfb?s=128&d=identicon&r=PG&f=1", "display_name": "DanielV", "link": "https://stackoverflow.com/users/2780630/danielv"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 848, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1558051194, "creation_date": 1557968278, "question_id": 56159436, "link": "https://stackoverflow.com/questions/56159436/visual-studio-code-task-is-prepending-the-working-directory-to-the-command", "title": "Visual Studio Code Task is Prepending the working directory to the command", "body": "<p>I'm trying to setup visual studio code for rust to do debugging.  In my launch.json file I have</p>\n\n<pre><code>{\n    \"version\": \"0.2.0\",\n    \"configurations\": [\n        {\n            \"name\": \"(Windows) Launch\",\n            \"type\": \"cppvsdbg\",\n            \"request\": \"launch\",\n            \"program\": \"${workspaceRoot}/target/debug/vscode-rust-debug-example.exe\",\n            \"args\": [],\n            \"stopAtEntry\": false,\n            \"cwd\": \"${workspaceRoot}\",\n            \"environment\": [],\n            \"externalConsole\": true,\n            \"preLaunchTask\": \"localcargobuildtask\"\n        }\n    ]\n}\n</code></pre>\n\n<p>and in my tasks.json I have </p>\n\n<pre><code>{\n    // See https://go.microsoft.com/fwlink/?LinkId=733558 \n    // for the documentation about the tasks.json format\n    \"version\": \"2.0.0\",\n    \"tasks\": [\n        {\n            \"label\": \"localcargobuildtask\",\n            \"command\": \"echo hi\",\n            \"group\": {\n                \"kind\": \"build\",\n                \"isDefault\": true\n            }\n        }        \n    ]\n}\n</code></pre>\n\n<p>Where \"echo hi\" is in my tasks I eventually want to have something like \"cargo build\" or \"cargo test\" or whatever.  But this is just a starting step.</p>\n\n<p>But when I press F5 the output I get is </p>\n\n<pre><code>&gt; Executing task: C:\\programs\\VSCodeWorkspaces\\RustProjects\\vscode-rust-debug-example-debug-config-included\\echo hi  &lt;\n\nThe terminal process terminated with exit code: 2\n\nTerminal will be reused by tasks, press any key to close it.\n</code></pre>\n\n<p>Rather than running \"echo\" from where ever the terminal finds it (working directory first, then check global path variable like you would expect) it is actually looking for a program named \"echo\" in my root folder of the workspace.</p>\n\n<p>How do I tell visual studio code \"No I don't want you to run workspace/echo, I want you to run echo in workspace\" ?  Or is there another more direct way to tell visual studio code \"compile this before you debug it\" ?</p>\n"}]