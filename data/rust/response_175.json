[{"tags": ["generics", "syntax", "rust", "traits"], "answers": [{"comments": [{"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "edited": false, "score": 0, "creation_date": 1526516292, "post_id": 50381619, "comment_id": 87779370, "body": "Thank you! I am still trying to get my head around lifetime syntax etc, one step at a time :)"}, {"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "edited": false, "score": 0, "creation_date": 1526519339, "post_id": 50381619, "comment_id": 87779889, "body": "I am trying to implement <code>vector.abs()</code> where <code>abs()</code> computes the absolute but <code>std::ops</code> does not seem to have a Absolute trait, how can other operations such as absolute be implemented? Should I make this a separate question? <a href=\"https://play.rust-lang.org/?gist=02d3f595f256b0d909506d1bd33b052a&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 3212, "user_id": 2731452, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xA89V.jpg?s=128&g=1", "display_name": "red75prime", "link": "https://stackoverflow.com/users/2731452/red75prime"}, "edited": false, "score": 1, "creation_date": 1526529777, "post_id": 50381619, "comment_id": 87781877, "body": "You may want to <a href=\"https://play.rust-lang.org/?gist=3a2ea1ef23909b34aa971ac77e1c20bb&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">use num crate</a>."}, {"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "reply_to_user": {"reputation": 3212, "user_id": 2731452, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xA89V.jpg?s=128&g=1", "display_name": "red75prime", "link": "https://stackoverflow.com/users/2731452/red75prime"}, "edited": false, "score": 0, "creation_date": 1526530453, "post_id": 50381619, "comment_id": 87782040, "body": "@red75prime Thank you :)"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 5, "last_activity_date": 1526517071, "last_edit_date": 1526517071, "creation_date": 1526515975, "answer_id": 50381619, "question_id": 50381524, "link": "https://stackoverflow.com/questions/50381524/how-to-implement-a-trait-for-a-vector-of-generic-type-vect/50381619#50381619", "title": "How to implement a trait for a vector of generic type Vec&lt;T&gt;?", "body": "<p>The correct syntax is:</p>\n\n<pre><code>trait Difference&lt;T&gt; { /* ... */ }\n\nimpl&lt;T&gt; Difference&lt;T&gt; for Vec&lt;T&gt; { /* ... */ }\n</code></pre>\n\n<p>Then you will need to require that <code>T</code> implements subtraction:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0369]: binary operation `-` cannot be applied to type `T`\n --&gt; src/main.rs:9:26\n  |\n9 |             .map(|slice| (slice[0] - slice[1]))\n  |                          ^^^^^^^^^^^^^^^^^^^^^\n  |\n  = note: `T` might need a bound for `std::ops::Sub`\n</code></pre>\n\n<p>And that you can copy the values:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0508]: cannot move out of type `[T]`, a non-copy slice\n  --&gt; src/main.rs:10:27\n   |\n10 |             .map(|slice| (slice[0] - slice[1]))\n   |                           ^^^^^^^^ cannot move out of here\n</code></pre>\n\n\n\n<pre><code>impl&lt;T&gt; Difference&lt;T&gt; for Vec&lt;T&gt;\nwhere\n    T: std::ops::Sub&lt;Output = T&gt; + Copy,\n{\n    // ...\n}\n</code></pre>\n\n<p>Or that references to <code>T</code> can be subtracted:</p>\n\n<pre><code>impl&lt;T&gt; Difference&lt;T&gt; for Vec&lt;T&gt;\nwhere\n    for&lt;'a&gt; &amp;'a T: std::ops::Sub&lt;Output = T&gt;,\n{\n    fn diff(&amp;self) -&gt; Vec&lt;T&gt; {\n        self.windows(2)\n            .map(|slice| &amp;slice[0] - &amp;slice[1])\n            .collect()\n    }\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/42741600/155423\">How to implement non-generic trait on a struct with a generic parameter</a></li>\n<li><a href=\"https://stackoverflow.com/q/36993605/155423\">Using a generic in a struct and implementing via a trait</a></li>\n<li><a href=\"https://stackoverflow.com/q/29184358/155423\">Requiring implementation of Mul in generic function</a></li>\n<li><a href=\"https://stackoverflow.com/q/35592750/155423\">How does for&lt;&gt; syntax differ from a regular lifetime bound?</a></li>\n</ul>\n"}, {"comments": [{"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526516524, "post_id": 50381649, "comment_id": 87779412, "body": "@Shepmaster, @Peter Hall  What is the difference/significance between <code>T: std::ops::Sub&lt;Output = T&gt; + Copy</code> and <code>for&lt;&#39;a&gt; &amp;&#39;a T: std::ops::Sub&lt;Output = T&gt;</code> ?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "edited": false, "score": 2, "creation_date": 1526516716, "post_id": 50381649, "comment_id": 87779458, "body": "The latter works with references rather than copying. For most numeric types, copying is preferred because it&#39;s actually smaller than a pointer. Notice in that part of Shepmaster&#39;s answer that he changed the code a little, so that it is working with references. I&#39;m going to say that the type syntax he&#39;s used there is a little <i>advanced</i> and you probably shouldn&#39;t worry about it if you are just starting out."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 2, "last_activity_date": 1526517092, "last_edit_date": 1526517092, "creation_date": 1526516304, "answer_id": 50381649, "question_id": 50381524, "link": "https://stackoverflow.com/questions/50381524/how-to-implement-a-trait-for-a-vector-of-generic-type-vect/50381649#50381649", "title": "How to implement a trait for a vector of generic type Vec&lt;T&gt;?", "body": "<p>You need to parameterise over <code>T</code> not <code>Vec&lt;T&gt;</code>. Then you'll also need to constrain <code>T</code> so that you can do subtraction (with the <code>Sub</code> trait) and so that the values can be copied in memory (with the <code>Copy</code> trait). Numeric types will mostly implement these traits.</p>\n\n<pre><code>use std::ops::Sub;\n\ntrait Difference&lt;T&gt; {\n    fn diff(&amp;self) -&gt; Vec&lt;T&gt;;\n}\n\nimpl&lt;T&gt; Difference&lt;T&gt; for Vec&lt;T&gt;\nwhere\n    T: Sub&lt;Output = T&gt; + Copy,\n{\n    fn diff(&amp;self) -&gt; Vec&lt;T&gt; {\n        self.windows(2).map(|slice| slice[0] - slice[1]).collect()\n    }\n}\n\nfn main() {\n    let vector = vec![1.025_f64, 1.028, 1.03, 1.05, 1.051];\n    println!(\"{:?}\", vector.diff());\n}\n</code></pre>\n"}], "owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2305, "favorite_count": 0, "accepted_answer_id": 50381619, "answer_count": 2, "score": 2, "last_activity_date": 1549459473, "creation_date": 1526515124, "last_edit_date": 1549459473, "question_id": 50381524, "link": "https://stackoverflow.com/questions/50381524/how-to-implement-a-trait-for-a-vector-of-generic-type-vect", "title": "How to implement a trait for a vector of generic type Vec&lt;T&gt;?", "body": "<p>How to implement the below trait for a vector of generic type <code>Vec&lt;T&gt;</code>?</p>\n\n<p>For example, how to implement the below (working) <code>Difference</code> trait in a generic way (e.g. so that it is valid for <code>Vec&lt;i32&gt;</code>, <code>Vec&lt;f32&gt;</code>, <code>Vec&lt;f64&gt;</code>)?</p>\n\n<pre><code>trait Difference {\n    fn diff(&amp;self) -&gt; Vec&lt;f64&gt;;\n}\n\nimpl Difference for Vec&lt;f64&gt; {\n    fn diff(&amp;self) -&gt; Vec&lt;f64&gt; {\n        self.windows(2)\n            .map(|slice| (slice[0] - slice[1]))\n            .collect()\n    }\n}\n\nfn main() {\n    let vector = vec![1.025_f64, 1.028, 1.03, 1.05, 1.051];\n    println!(\"{:?}\", vector.diff());\n}\n</code></pre>\n\n<p>From looking <a href=\"https://doc.rust-lang.org/book/second-edition/ch19-03-advanced-traits.html#associated-types-versus-generics\" rel=\"nofollow noreferrer\">at the documentation</a>, it seems like it should be something along the lines of:</p>\n\n<pre><code>trait Difference&lt;Vec&lt;T&gt;&gt; {\n    fn diff(&amp;self) -&gt; Vec&lt;T&gt;;\n}\n\nimpl Difference for Vec&lt;T&gt; {\n    fn diff(&amp;self) -&gt; Vec&lt;T&gt; {\n        self.windows(2)\n            .map(|slice| (slice[0] - slice[1]))\n            .collect()\n    }\n}\n\nfn main() {\n    let vector = vec![1.025_f64, 1.028, 1.03, 1.05, 1.051];\n    println!(\"{:?}\", vector.diff());\n}\n</code></pre>\n\n<p>However the above results in:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: expected one of `,`, `:`, `=`, or `&gt;`, found `&lt;`\n --&gt; src/main.rs:2:21\n  |\n2 | trait Difference&lt;Vec&lt;T&gt;&gt; {\n  |                     ^ expected one of `,`, `:`, `=`, or `&gt;` here\n</code></pre>\n\n<p>I've tried a few other variations however all of them resulted in much longer error messages.</p>\n"}, {"tags": ["rust", "grouping"], "comments": [{"owner": {"reputation": 170, "user_id": 8248760, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/1984177314941872/picture?type=large", "display_name": "eXodiquas", "link": "https://stackoverflow.com/users/8248760/exodiquas"}, "edited": false, "score": 0, "creation_date": 1526509335, "post_id": 50380352, "comment_id": 87777644, "body": "Why is iterating over the vector and just checking if the next i64 is +1 to the previous not a option?"}, {"owner": {"reputation": 93, "user_id": 6286935, "user_type": "registered", "profile_image": "https://graph.facebook.com/1757727524471491/picture?type=large", "display_name": "Sergey Yakovlev", "link": "https://stackoverflow.com/users/6286935/sergey-yakovlev"}, "reply_to_user": {"reputation": 170, "user_id": 8248760, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/1984177314941872/picture?type=large", "display_name": "eXodiquas", "link": "https://stackoverflow.com/users/8248760/exodiquas"}, "edited": false, "score": 0, "creation_date": 1526563278, "post_id": 50380352, "comment_id": 87800755, "body": "It&#39;s a good decision and I haven&#39;t any thoughts against it! But it will have much more code than a functional approach. And the main reason - I&#39;m trying to rewrite my pet project from Python to Rust and I made it  like this: <code>group_normal_data = [list(map(itemgetter(1), g)) for (k, g) in groupby(enumerate(source_normal), lambda ix: ix[0] - ix[1])]</code>. It&#39;s hard to understand of course, but it works just in only one  line and I tried to make the same in Rust"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1526564747, "post_id": 50380352, "comment_id": 87801859, "body": "The final snippet in my answer is pretty similar in meaning to the Python version. In fact, it started out <a href=\"http://play.rust-lang.org/?gist=c24c233c347cde1048d4375f408ba1bb&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">even more similar</a>, using <code>enumerate</code>. But just like with list comprehensions in Python, it&#39;s easy to go crazy with iterator adapters until you have an unreadable mess."}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1526516309, "post_id": 50380900, "comment_id": 87779372, "body": "This will panic if the starting vector is empty. You can use <code>mem::replace</code> instead of cloning &amp; clearing the vector."}, {"owner": {"reputation": 93, "user_id": 6286935, "user_type": "registered", "profile_image": "https://graph.facebook.com/1757727524471491/picture?type=large", "display_name": "Sergey Yakovlev", "link": "https://stackoverflow.com/users/6286935/sergey-yakovlev"}, "edited": false, "score": 0, "creation_date": 1526564734, "post_id": 50380900, "comment_id": 87801853, "body": "Thank you for your decision! It completely resolves my problem and I think that I will use exactly this approach. But you are right: I wanted some functionals due to less code. Other reason: I haven&#39;t been successful with <code>group_by</code>function in Rust (But I resolve the same task in Python exactly with a very similar itertools library without any problem) and I want to understand how I can use it."}], "tags": [], "owner": {"reputation": 170, "user_id": 8248760, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/1984177314941872/picture?type=large", "display_name": "eXodiquas", "link": "https://stackoverflow.com/users/8248760/exodiquas"}, "is_accepted": false, "score": 3, "last_activity_date": 1526511367, "last_edit_date": 1526511367, "creation_date": 1526510378, "answer_id": 50380900, "question_id": 50380352, "link": "https://stackoverflow.com/questions/50380352/how-can-i-group-consecutive-integers-in-a-vector-in-rust/50380900#50380900", "title": "How can I group consecutive integers in a vector in Rust?", "body": "<pre><code>let v = vec![1, 2, 3, 5, 6, 7, 9, 10];\nlet mut res = Vec::new();\nlet mut prev = v[0];\nlet mut sub_v = Vec::new();\n\nsub_v.push(prev);\n\nfor i in 1..v.len() {\n    if v[i] == prev + 1 {\n        sub_v.push(v[i]);\n        prev = v[i];\n    } else {\n        res.push(sub_v.clone());\n        sub_v.clear();\n        sub_v.push(v[i]);\n        prev = v[i];\n    }\n}\n\nres.push(sub_v);\n</code></pre>\n\n<p>This should solve your problem.</p>\n\n<p>Iterating over the given vector, checking if the current <code>i64</code> (in my case <code>i32</code>) is +1 to the previous <code>i64</code>, if so push it into a vector (<code>sub_v</code>). After the series breaks, push the <code>sub_v</code> into the result vector. Repeat.</p>\n\n<p>But I guess you wanted something functional?</p>\n"}, {"comments": [{"owner": {"reputation": 93, "user_id": 6286935, "user_type": "registered", "profile_image": "https://graph.facebook.com/1757727524471491/picture?type=large", "display_name": "Sergey Yakovlev", "link": "https://stackoverflow.com/users/6286935/sergey-yakovlev"}, "edited": false, "score": 0, "creation_date": 1526566929, "post_id": 50392400, "comment_id": 87803411, "body": "Thank you! The first version is quite simple for understanding and it&#39;s really good! The last version is really one that I wanted. Now I can play with these functions and understand how to use it in my project. Big Thanks!"}, {"owner": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "edited": false, "score": 0, "creation_date": 1586782415, "post_id": 50392400, "comment_id": 108245693, "body": "The first version at least is buggy, try a vector with only consecutive elements."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 4970, "user_id": 1726797, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a76b9e0b9a393201d9897082bf70bf07?s=128&d=identicon&r=PG", "display_name": "nnnmmm", "link": "https://stackoverflow.com/users/1726797/nnnmmm"}, "edited": false, "score": 1, "creation_date": 1586784412, "post_id": 50392400, "comment_id": 108246647, "body": "@nnnmmm Thanks! I was trying to make sure it wouldn&#39;t return <code>[[]]</code> when passed an empty slice, but I overlooked that possibility. Nice catch. I hope this bug hasn&#39;t made it into anyone&#39;s production code over the last 2 years..."}, {"owner": {"reputation": 1960, "user_id": 549531, "user_type": "registered", "accept_rate": 18, "profile_image": "https://i.stack.imgur.com/qV5qe.png?s=128&g=1", "display_name": "Evgeni Nabokov", "link": "https://stackoverflow.com/users/549531/evgeni-nabokov"}, "edited": false, "score": 0, "creation_date": 1596868982, "post_id": 50392400, "comment_id": 111954480, "body": "To get rid of <code>if data.len() &gt; 0</code> in the first snippet, you can modify the condition above: <code>if i == data.len() || data[i - 1] + 1 != data[i]</code>. Also, don&#39;t forget to modify the range: <code>1..=data.len()</code>."}], "tags": [], "owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "is_accepted": true, "score": 5, "last_activity_date": 1586785275, "last_edit_date": 1586785275, "creation_date": 1526562850, "answer_id": 50392400, "question_id": 50380352, "link": "https://stackoverflow.com/questions/50380352/how-can-i-group-consecutive-integers-in-a-vector-in-rust/50392400#50392400", "title": "How can I group consecutive integers in a vector in Rust?", "body": "<p>You <em>can indeed</em> use <code>group_by</code> for this, but you might not really want to. Here's what I would probably write instead:</p>\n\n<pre><code>fn consecutive_slices(data: &amp;[i64]) -&gt; Vec&lt;&amp;[i64]&gt; {\n    let mut slice_start = 0;\n    let mut result = Vec::new();\n    for i in 1..data.len() {\n        if data[i - 1] + 1 != data[i] {\n            result.push(&amp;data[slice_start..i]);\n            slice_start = i;\n        }\n    }\n    if data.len() &gt; 0 {\n        result.push(&amp;data[slice_start..]);\n    }\n    result\n}\n</code></pre>\n\n<p>This is similar in principle to eXodiquas' answer, but instead of accumulating a <code>Vec&lt;Vec&lt;i64&gt;&gt;</code>, I use the indices to accumulate a <code>Vec</code> of slice references that refer to the original data. (<a href=\"https://stackoverflow.com/q/40006219/3650362\">This question</a> explains why I made <code>consecutive_slices</code> take <code>&amp;[T]</code>.)</p>\n\n<p>It's also possible to do the same thing without allocating a <code>Vec</code>, by returning an iterator; however, I like the above version better. Here's the zero-allocation version I came up with:</p>\n\n<pre><code>fn consecutive_slices(data: &amp;[i64]) -&gt; impl Iterator&lt;Item = &amp;[i64]&gt; {\n    let mut slice_start = 0;\n    (1..data.len() + 1).flat_map(move |i| {\n        if i == data.len() || data[i - 1] + 1 != data[i] {\n            let begin = slice_start;\n            slice_start = i;\n            Some(&amp;data[begin..i])\n        } else {\n            None\n        }\n    })\n}\n</code></pre>\n\n<p>It's not as readable as a <code>for</code> loop, but it doesn't need to allocate a <code>Vec</code> for the return value, so this version is more flexible.</p>\n\n<hr>\n\n<p>Here's a \"more functional\" version using <code>group_by</code>:</p>\n\n<pre><code>use itertools::Itertools;\n\nfn consecutive_slices(data: &amp;[i64]) -&gt; Vec&lt;Vec&lt;i64&gt;&gt; {\n    (&amp;(0..data.len()).group_by(|&amp;i| data[i] as usize - i))\n        .into_iter()\n        .map(|(_, group)| group.map(|i| data[i]).collect())\n        .collect()\n}\n</code></pre>\n\n<p>The idea is to make a key function for <code>group_by</code> that takes the difference between each element and its index in the slice. Consecutive elements will have the same key because indices increase by 1 each time. One reason I don't like this version is that it's quite difficult to get slices of the original data structure; you almost have to create a <code>Vec&lt;Vec&lt;i64&gt;&gt;</code> (hence the two <code>collect</code>s). The other reason is that I find it harder to read.</p>\n\n<p>However, when I first wrote my preferred version (the first one, with the <code>for</code> loop), it had a bug (now fixed), while the other two versions were correct from the start. So there may be merit to writing denser code with functional abstractions, even if there is some hit to readability and/or performance.</p>\n"}, {"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1526602577, "post_id": 50400965, "comment_id": 87819898, "body": "I&#39;ve never seen anyone actually use <code>scan</code> before, but it works! A few suggestions: <code>Option</code> implements <code>IntoIterator</code>, so you can <code>.chain(v.last().or(Some(&amp;-1)))</code> instead of making a 1-element array; if you return an <code>Option&lt;Option&lt;...&gt;&gt;</code> you can simplify the <code>flat_map</code> call; and <code>mem::replace</code> can avoid the overhead of cloning <code>s</code>. <a href=\"http://play.rust-lang.org/?gist=09f5acd501330493bf2b46ab91a0298e&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">Here&#39;s a playground link.</a>"}], "tags": [], "owner": {"reputation": 66, "user_id": 9293552, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/47ad98f0b089bc22924bd0690fd76a87?s=128&d=identicon&r=PG&f=1", "display_name": "iclac", "link": "https://stackoverflow.com/users/9293552/iclac"}, "is_accepted": false, "score": 2, "last_activity_date": 1526593606, "creation_date": 1526593606, "answer_id": 50400965, "question_id": 50380352, "link": "https://stackoverflow.com/questions/50380352/how-can-i-group-consecutive-integers-in-a-vector-in-rust/50400965#50400965", "title": "How can I group consecutive integers in a vector in Rust?", "body": "<p>Another possible solution, that uses std only, could be:</p>\n\n<pre><code>fn consecutive_slices(v: &amp;[i64]) -&gt; Vec&lt;Vec&lt;i64&gt;&gt; {\n    let t: Vec&lt;Vec&lt;i64&gt;&gt; = v\n        .into_iter()\n        .chain([*v.last().unwrap_or(&amp;-1)].iter())\n        .scan(Vec::new(), |s, &amp;e| {\n            match s.last() {\n                None =&gt; { s.push(e); Some((false, Vec::new())) },\n                Some(&amp;p) if p == e - 1 =&gt; { s.push(e); Some((false, Vec::new()))},\n                Some(&amp;p) if p != e - 1 =&gt; {let o = s.clone(); *s = vec![e]; Some((true, o))},\n                _ =&gt; None,\n            }\n         })\n         .filter_map(|(n, v)| {\n             match n {\n                 true =&gt; Some(v.clone()),\n                 false =&gt; None,\n             }\n         })\n         .collect();\n\n    t\n}\n</code></pre>\n\n<p>The chain is used to get the last vector. </p>\n"}], "owner": {"reputation": 93, "user_id": 6286935, "user_type": "registered", "profile_image": "https://graph.facebook.com/1757727524471491/picture?type=large", "display_name": "Sergey Yakovlev", "link": "https://stackoverflow.com/users/6286935/sergey-yakovlev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1958, "favorite_count": 1, "accepted_answer_id": 50392400, "answer_count": 3, "score": 4, "last_activity_date": 1586785275, "creation_date": 1526507046, "last_edit_date": 1526558623, "question_id": 50380352, "link": "https://stackoverflow.com/questions/50380352/how-can-i-group-consecutive-integers-in-a-vector-in-rust", "title": "How can I group consecutive integers in a vector in Rust?", "body": "<p>I have a <code>Vec&lt;i64&gt;</code> and I want to know all the groups of integers that are consecutive. As an example:</p>\n\n<pre><code>let v = vec![1, 2, 3, 5, 6, 7, 9, 10];\n</code></pre>\n\n<p>I'm expecting something like this or similar:</p>\n\n<pre><code>[[1, 2, 3], [5, 6, 7], [9, 10]];\n</code></pre>\n\n<p>The view (vector of vectors or maybe tuples or something else) really doesn't matter, but I should get several grouped lists with continuous numbers.</p>\n\n<p>At the first look, it seems like I'll need to use itertools and the <code>group_by</code> function, but I have no idea how...</p>\n"}, {"tags": ["rust", "traits"], "comments": [{"owner": {"reputation": 28990, "user_id": 1114966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/af8712b05e5cfb862323a07c83749054?s=128&d=identicon&r=PG", "display_name": "squiguy", "link": "https://stackoverflow.com/users/1114966/squiguy"}, "edited": false, "score": 1, "creation_date": 1526502272, "post_id": 50379239, "comment_id": 87774921, "body": "I believe you are looking for <a href=\"https://doc.rust-lang.org/std/ops/trait.Index.html\" rel=\"nofollow noreferrer\">Index</a> or <a href=\"https://doc.rust-lang.org/std/ops/trait.IndexMut.html\" rel=\"nofollow noreferrer\">IndexMut</a>"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 28990, "user_id": 1114966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/af8712b05e5cfb862323a07c83749054?s=128&d=identicon&r=PG", "display_name": "squiguy", "link": "https://stackoverflow.com/users/1114966/squiguy"}, "edited": false, "score": 0, "creation_date": 1526503250, "post_id": 50379239, "comment_id": 87775337, "body": "@squiguy Going to make that an answer?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526503365, "post_id": 50379239, "comment_id": 87775387, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/28126735/155423\">Is there a way to perform an index access to an instance of a struct?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50379239/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 2416, "user_id": 1902291, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/Wtz5E.png?s=128&g=1", "display_name": "opus111", "link": "https://stackoverflow.com/users/1902291/opus111"}, "edited": false, "score": 0, "creation_date": 1526503425, "post_id": 50379239, "comment_id": 87775418, "body": "Hi.  I implemented both of those, but it didn&#39;t let me do []=.  I am just learning Rust, so probably I am missing an important concept here.  IndexMut certainly <i>sounds</i> like what I need..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526503550, "post_id": 50379239, "comment_id": 87775478, "body": "@user1902291 Please <a href=\"https://stackoverflow.com/posts/50379239/edit\">edit</a> your question with more prose to describe what you expect <code>foo[bar] = zot</code> to <i>do</i>, as well as any attempts you&#39;ve made, what you expect them to do, what they do, etc."}, {"owner": {"reputation": 2416, "user_id": 1902291, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/Wtz5E.png?s=128&g=1", "display_name": "opus111", "link": "https://stackoverflow.com/users/1902291/opus111"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526503597, "post_id": 50379239, "comment_id": 87775495, "body": "Hi @Shepmaster.  Yes I believe <a href=\"https://stackoverflow.com/questions/28126735/is-there-a-way-to-perform-an-index-access-to-an-instance-of-a-struct\" title=\"is there a way to perform an index access to an instance of a struct\">stackoverflow.com/questions/28126735/&hellip;</a> asks the same question.  Thanks"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526503634, "post_id": 50379239, "comment_id": 87775513, "body": "@user1902291 so you&#39;d be comfortable marking this as a duplicate?"}, {"owner": {"reputation": 2416, "user_id": 1902291, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/Wtz5E.png?s=128&g=1", "display_name": "opus111", "link": "https://stackoverflow.com/users/1902291/opus111"}, "edited": false, "score": 0, "creation_date": 1526518349, "post_id": 50379239, "comment_id": 87779732, "body": "Sure.  Thank you"}], "owner": {"reputation": 2416, "user_id": 1902291, "user_type": "registered", "accept_rate": 52, "profile_image": "https://i.stack.imgur.com/Wtz5E.png?s=128&g=1", "display_name": "opus111", "link": "https://stackoverflow.com/users/1902291/opus111"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 50, "favorite_count": 0, "closed_date": 1526506840, "answer_count": 0, "score": 2, "last_activity_date": 1526503321, "creation_date": 1526501691, "last_edit_date": 1526503321, "question_id": 50379239, "link": "https://stackoverflow.com/questions/50379239/what-trait-do-i-need-to-implement-to-provide-the-index-operation", "closed_reason": "Duplicate", "title": "What trait do I need to implement to provide the [index]= operation?", "body": "<p>I want to implement a Rust struct that provides the <code>[index]=</code> operation.</p>\n\n<p>For example</p>\n\n<pre><code>foo[bar] = zot\n</code></pre>\n\n<p>What trait does <code>foo</code> need to implement here?  Is it perhaps some combination of <code>std::ops</code>?</p>\n"}, {"tags": ["rust", "ffi"], "answers": [{"comments": [{"owner": {"reputation": 2865, "user_id": 171520, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/3da837d1227e7df8153c68d502f64994?s=128&d=identicon&r=PG", "display_name": "Dave Challis", "link": "https://stackoverflow.com/users/171520/dave-challis"}, "edited": false, "score": 0, "creation_date": 1526500212, "post_id": 50377830, "comment_id": 87773965, "body": "Many thanks @Shepmaster, some great pointers there. <code>str::ptr</code> is a typo, should have been <code>std::ptr</code>, will fix. Excellent idea about CVec too. One thing I&#39;m still uncertain about - the API I&#39;m wrapping doesn&#39;t provide a deallocation method for the array it creates, would using <code>libc::free</code> be appropriate (i.e. <code>libc::free(self.ptr)</code> in <code>impl Drop</code>?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 2865, "user_id": 171520, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/3da837d1227e7df8153c68d502f64994?s=128&d=identicon&r=PG", "display_name": "Dave Challis", "link": "https://stackoverflow.com/users/171520/dave-challis"}, "edited": false, "score": 4, "creation_date": 1526500337, "post_id": 50377830, "comment_id": 87774026, "body": "<i>would using <code>libc::free</code> be appropriate</i> \u2014 *shrug*. It will <i>probably</i> work; what do you call to free the data when you use that function from C? That&#39;ll be the correct thing to do."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 13, "last_activity_date": 1578328308, "last_edit_date": 1578328308, "creation_date": 1526495573, "answer_id": 50377830, "question_id": 50376516, "link": "https://stackoverflow.com/questions/50376516/creating-a-vec-in-rust-from-a-c-array-pointer-and-safely-freeing-it/50377830#50377830", "title": "Creating a Vec in Rust from a C array pointer and safely freeing it?", "body": "<blockquote>\n  <p>can I create a <code>Vec</code> which takes ownership of the underlying memory, which is freed when the <code>Vec</code> is freed?</p>\n</blockquote>\n\n<p>Not safely, no. You <strong>must not</strong> use <code>Vec::from_raw_parts</code> unless the pointer came from a <code>Vec</code> originally (well, from the same memory allocator). Otherwise, you will try to free memory that your allocator doesn't know about; a very bad idea.</p>\n\n<p>Note that the same thing is true for <code>String::from_raw_parts</code>, as a <code>String</code> is a wrapper for a <code>Vec&lt;u8&gt;</code>.</p>\n\n<blockquote>\n  <p>where/how in Rust should I free the memory that the C function allocated?</p>\n</blockquote>\n\n<p>As soon as you are done with it and no sooner.</p>\n\n<blockquote>\n  <p>anything else in the above that could/should be improved on?</p>\n</blockquote>\n\n<ul>\n<li>There's no need to cast the pointer when calling <code>slice::from_raw_parts</code></li>\n<li>There's no need for explicit types on the variables</li>\n<li>Use <code>ptr::null</code>, not <code>ptr::null_mut</code></li>\n<li>Perform a NULL pointer check</li>\n<li>Check the length is non-negative</li>\n</ul>\n\n\n\n<pre><code>use std::{ptr, slice};\n\nextern \"C\" {\n    fn allocate_data(data_ptr: *mut *const f32, data_len: *mut i32);\n    fn deallocate_data(data_ptr: *const f32);\n}\n\nfn get_vec() -&gt; Vec&lt;f32&gt; {\n    let mut data_ptr = ptr::null();\n    let mut data_len = 0;\n\n    unsafe {\n        allocate_data(&amp;mut data_ptr, &amp;mut data_len);\n        assert!(!data_ptr.is_null());\n        assert!(data_len &gt;= 0);\n\n        let v = slice::from_raw_parts(data_ptr, data_len as usize).to_vec();\n        deallocate_data(data_ptr);\n\n        v\n    }\n}\n\nfn main() {}\n</code></pre>\n\n<hr>\n\n<p>You didn't state why you need it to be a <code>Vec</code>, but if you never need to change the size, you can create your own type that can be dereferenced as a slice and drops the data when appropriate:</p>\n\n<pre><code>use std::{ptr, slice};\n\nextern \"C\" {\n    fn allocate_data(data_ptr: *mut *const f32, data_len: *mut i32);\n    fn deallocate_data(data_ptr: *const f32);\n}\n\nstruct CVec {\n    ptr: *const f32,\n    len: usize,\n}\n\nimpl std::ops::Deref for CVec {\n    type Target = [f32];\n\n    fn deref(&amp;self) -&gt; &amp;[f32] {\n        unsafe { slice::from_raw_parts(self.ptr, self.len) }\n    }\n}\n\nimpl Drop for CVec {\n    fn drop(&amp;mut self) {\n        unsafe { deallocate_data(self.ptr) };\n    }\n}\n\nfn get_vec() -&gt; CVec {\n    let mut ptr = ptr::null();\n    let mut len = 0;\n\n    unsafe {\n        allocate_data(&amp;mut ptr, &amp;mut len);\n        assert!(!ptr.is_null());\n        assert!(len &gt;= 0);\n\n        CVec {\n            ptr,\n            len: len as usize,\n        }\n    }\n}\n\nfn main() {}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/34622127/155423\">How to convert a *const pointer into a Vec to correctly drop it?</a></li>\n<li><a href=\"https://stackoverflow.com/q/37436779/155423\">Is it possible to call a Rust function taking a Vec from C?</a></li>\n</ul>\n"}], "owner": {"reputation": 2865, "user_id": 171520, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/3da837d1227e7df8153c68d502f64994?s=128&d=identicon&r=PG", "display_name": "Dave Challis", "link": "https://stackoverflow.com/users/171520/dave-challis"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3162, "favorite_count": 0, "accepted_answer_id": 50377830, "answer_count": 1, "score": 4, "last_activity_date": 1578328308, "creation_date": 1526490476, "last_edit_date": 1526500259, "question_id": 50376516, "link": "https://stackoverflow.com/questions/50376516/creating-a-vec-in-rust-from-a-c-array-pointer-and-safely-freeing-it", "title": "Creating a Vec in Rust from a C array pointer and safely freeing it?", "body": "<p>I'm calling a C function from Rust which takes a null pointer as as an argument, then allocates some memory to point it to.</p>\n\n<p>What is the correct way to efficiently (i.e. avoiding unnecessary copies) and safely (i.e. avoid memory leaks or segfaults) turn data from the C pointer into a <code>Vec</code>?</p>\n\n<p>I've got something like:</p>\n\n<pre><code>extern \"C\" {\n    // C function that allocates an array of floats\n    fn allocate_data(data_ptr: *mut *const f32, data_len: *mut i32);\n}\n\nfn get_vec() -&gt; Vec&lt;f32&gt; {\n    // C will set this to length of array it allocates\n    let mut data_len: i32 = 0;\n\n    // C will point this at the array it allocates\n    let mut data_ptr: *const f32 = std::ptr::null_mut();\n\n    unsafe { allocate_data(&amp;mut data_ptr, &amp;mut data_len) };\n\n    let data_slice = unsafe { slice::from_raw_parts(data_ptr as *const f32, data_len as usize) };\n    data_slice.to_vec()\n}\n</code></pre>\n\n<p>If I understand correctly, <code>.to_vec()</code> will copy data from the slice into a new <code>Vec</code>, so the underlying memory will still need to be freed (as the underlying memory for the slice won't be freed when it's dropped).</p>\n\n<p>What is the correct approach for dealing with the above?</p>\n\n<ul>\n<li>can I create a <code>Vec</code> which takes ownership of the underlying memory, which is freed when the <code>Vec</code> is freed?</li>\n<li>if not, where/how in Rust should I free the memory that the C function allocated?</li>\n<li>anything else in the above that could/should be improved on?</li>\n</ul>\n"}, {"tags": ["object", "rust", "sharing"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526487242, "post_id": 50375499, "comment_id": 87767475, "body": "Welcome to Stack Overflow! I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/30831037/155423\">Situations where Cell or RefCell is the best choice</a>, <a href=\"https://stackoverflow.com/q/30882065/155423\">Immutable reference after mutable borrow</a>, <a href=\"https://stackoverflow.com/q/28385339/155423\">Mutable self while reading from owner object</a>, <a href=\"https://stackoverflow.com/q/35936995\">Mutating one field while iterating over another immutable field</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50375499/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1, "user_id": 9801310, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=128", "display_name": "Amit Maimon", "link": "https://stackoverflow.com/users/9801310/amit-maimon"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526487495, "post_id": 50375499, "comment_id": 87767612, "body": "Actually yes! Thanks a lot! :)"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526487647, "post_id": 50375499, "comment_id": 87767701, "body": "Are any of those more useful than the other? Are any not useful? I can mark up to 5 duplicates, but I&#39;d prefer to order them most usefully."}, {"owner": {"reputation": 1, "user_id": 9801310, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=128", "display_name": "Amit Maimon", "link": "https://stackoverflow.com/users/9801310/amit-maimon"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526490968, "post_id": 50375499, "comment_id": 87769445, "body": "i think the first and the second are the most relevant ones. the others were a bit more complicated for me to understand with my knowledge."}], "owner": {"reputation": 1, "user_id": 9801310, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=128", "display_name": "Amit Maimon", "link": "https://stackoverflow.com/users/9801310/amit-maimon"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 39, "favorite_count": 0, "closed_date": 1526491028, "answer_count": 0, "score": 0, "last_activity_date": 1526491050, "creation_date": 1526486855, "last_edit_date": 1526487094, "question_id": 50375499, "link": "https://stackoverflow.com/questions/50375499/sharing-objects-for-reading-and-writing-in-a-single-threaded-context", "closed_reason": "Duplicate", "title": "Sharing objects for reading and writing in a single-threaded context", "body": "<p>I've been working on a C++ game with a board and soldiers on it. My <code>Player</code> object has an array of pointers to his soldiers so that the player has quick access to his soldiers. The tricky thing is to sync them both to prevent issues.</p>\n\n<p>How would you design something similar in Rust? I know there are raw pointers, but they are considered unsafe. </p>\n\n<p>Is there a way to share an object between 2 classes so that one could read and one write? What about both read and write?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526482665, "post_id": 50373726, "comment_id": 87764527, "body": "What prevents you from casting the raw pointer to <code>*mut u8</code>?"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526485652, "post_id": 50373726, "comment_id": 87766536, "body": "@Shepmaster I wasn&#39;t sure, if this is UB or something."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526491642, "post_id": 50373726, "comment_id": 87769783, "body": "@Tim As long as your allocate give mutable memory it&#39;s should be OK."}], "answers": [{"comments": [{"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1526751360, "post_id": 50427464, "comment_id": 87870433, "body": "The generic in <code>alloc</code> is just for interpreting an opaque userdata-pointer. Regarding the <code>extend_packed</code>: Thanks for the hint, I&#39;m using <code>extend</code> anyway, can&#39;t say, why I typed <code>extend_packed</code>, maybe because of autocompletition in my IDE..."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1526748311, "creation_date": 1526748311, "answer_id": 50427464, "question_id": 50373726, "link": "https://stackoverflow.com/questions/50373726/how-to-add-subtract-an-offset-to-from-nonnullopaque/50427464#50427464", "title": "How to add/subtract an offset to/from NonNull&lt;Opaque&gt;?", "body": "<p>I'd probably write it like this, using <a href=\"https://doc.rust-lang.org/nightly/core/ptr/struct.NonNull.html#method.as_ptr\" rel=\"nofollow noreferrer\"><code>NonNull::as_ptr</code></a> to get a <code>*mut Opaque</code> and then cast that to different concrete types:</p>\n\n<pre><code>#![feature(allocator_api)]\n#![no_std]\n\nextern crate libc;\n\nuse core::alloc::{Alloc, Layout};\nuse libc::c_void;\n\nunsafe fn alloc&lt;A: Alloc&gt;(allocator: &amp;mut A, size: usize, alignment: usize) -&gt; *mut c_void {\n    let requested_layout = Layout::from_size_align(size, alignment).expect(\"Invalid layout\");\n\n    let (layout, _padding) = Layout::new::&lt;Layout&gt;()\n        .extend_packed(requested_layout)\n        .expect(\"Unable to create layout\");\n\n    let ptr = allocator.alloc(layout).expect(\"Unable to allocate\");\n\n    // Get a pointer to our layout storage \n    let raw = ptr.as_ptr() as *mut Layout;\n    // Save it\n    raw.write(layout);\n    // Skip over it\n    raw.offset(1) as *mut _\n}\n</code></pre>\n\n<hr>\n\n<blockquote>\n  <p><code>unsafe extern \"system\" fn alloc&lt;A: Alloc&gt;(</code></p>\n</blockquote>\n\n<p>This makes no sense to me. The various FFI ABIs (\"C\", \"system\", etc.) have no way of specifying Rust generic types. It seems deeply incorrect for this function to be marked <code>extern</code>.</p>\n\n<hr>\n\n<blockquote>\n  <p><code>Layout::new::&lt;Layout&gt;().extend_packed(requested_layout)</code></p>\n</blockquote>\n\n<p>This seems likely to be very broken. As the <a href=\"https://doc.rust-lang.org/nightly/core/alloc/struct.Layout.html#method.extend_packed\" rel=\"nofollow noreferrer\">documentation for <code>Layout::extend_packed</code></a> states, emphasis mine:</p>\n\n<blockquote>\n  <p>the alignment of <code>next</code> is irrelevant, and is <strong>not incorporated at all into the resulting layout</strong>.</p>\n</blockquote>\n\n<p>Your returned pointer doesn't seem to honor the alignment request.</p>\n"}], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 179, "favorite_count": 0, "accepted_answer_id": 50427464, "answer_count": 1, "score": 1, "last_activity_date": 1526748311, "creation_date": 1526481291, "last_edit_date": 1526747435, "question_id": 50373726, "link": "https://stackoverflow.com/questions/50373726/how-to-add-subtract-an-offset-to-from-nonnullopaque", "title": "How to add/subtract an offset to/from NonNull&lt;Opaque&gt;?", "body": "<p>I provide two functions for managing memory: </p>\n\n<pre><code>unsafe extern \"system\" fn alloc&lt;A: Alloc&gt;(\n    size: usize,\n    alignment: usize,\n) -&gt; *mut c_void { ... }\n\nunsafe extern \"system\" fn free&lt;A: Alloc&gt;(\n    memory: *mut c_void\n) { ... }\n</code></pre>\n\n<p>Both functions internally use the <a href=\"https://github.com/rust-lang/rust/issues/32838\" rel=\"nofollow noreferrer\">allocator-api</a>.</p>\n\n<p>These signatures cannot be changed. The problem is that <code>free</code> does not ask for <code>size</code> and <code>alignment</code>, which is required for <code>Alloc::dealloc</code>. To get around this, <code>alloc</code> allocates some extra space for one <a href=\"https://doc.rust-lang.org/nightly/core/alloc/struct.Layout.html\" rel=\"nofollow noreferrer\"><code>Layout</code></a>. <code>free</code> can now access this <code>Layout</code> to get the needed extra data. </p>\n\n<p>Recently, the <a href=\"https://github.com/rust-lang/rust/issues/32838\" rel=\"nofollow noreferrer\">allocator-api</a> changed and instead of <code>*mut u8</code> it now uses <code>NonNull&lt;Opaque&gt;</code>. This is where my problem occurs. </p>\n\n<p><a href=\"https://doc.rust-lang.org/nightly/core/alloc/foreigntype.Opaque.html\" rel=\"nofollow noreferrer\"><code>core::alloc::Opaque</code></a>:</p>\n\n<blockquote>\n  <p>An opaque, unsized type. Used for pointers to allocated memory. [...] Such pointers are similar to C\u2019s <code>void*</code> type.</p>\n</blockquote>\n\n<p><code>Opaque</code> is not <code>Sized</code>, so the use of <code>NonNull::as_ptr().add()</code> and <code>NonNull::as_ptr().sub()</code> are forbidden. </p>\n\n<p>Previously, I used something like this (for simplicity, I assume <code>Alloc</code>'s functions to be static):</p>\n\n<pre><code>#![feature(allocator_api)]\n#![no_std]\n\nextern crate libc;\n\nuse core::alloc::{Alloc, Layout};\nuse libc::c_void;\n\nunsafe extern \"system\" fn alloc&lt;A: Alloc&gt;(\n    size: usize,\n    alignment: usize,\n) -&gt; *mut c_void\n{\n    let requested_layout =\n        Layout::from_size_align(size, alignment).unwrap();\n\n    let (layout, padding) = Layout::new::&lt;Layout&gt;()\n        .extend_packed(requested_layout)\n        .unwrap();\n\n    let ptr = A::alloc(layout).unwrap(); \n    (ptr as *mut Layout).write(layout);\n    ptr.add(padding)\n}\n</code></pre>\n\n<p>The last line is not possible anymore with <code>NonNull&lt;Opaque&gt;</code>. How I can get around this?</p>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 574, "user_id": 6223139, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ac13786ba62de8ccfaba0fa087e876c5?s=128&d=identicon&r=PG&f=1", "display_name": "Vaishakh", "link": "https://stackoverflow.com/users/6223139/vaishakh"}, "edited": false, "score": 0, "creation_date": 1602503002, "post_id": 50364390, "comment_id": 113731872, "body": "Where is the default directory, i cant find the build output of cargo"}], "answers": [{"tags": [], "owner": {"reputation": 340, "user_id": 652278, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9bbc401e0db6b59e8152fba482308e02?s=128&d=identicon&r=PG", "display_name": "sdht0", "link": "https://stackoverflow.com/users/652278/sdht0"}, "is_accepted": true, "score": 9, "last_activity_date": 1606315071, "last_edit_date": 1606315071, "creation_date": 1526456714, "answer_id": 50365079, "question_id": 50364390, "link": "https://stackoverflow.com/questions/50364390/how-can-i-specify-a-custom-cargo-output-directory/50365079#50365079", "title": "How can I specify a custom Cargo output directory?", "body": "<p><code>[build]</code> is a <a href=\"https://doc.rust-lang.org/cargo/reference/config.html\" rel=\"nofollow noreferrer\">Cargo-level configuration</a> rather than for the project:</p>\n<blockquote>\n<p>This document will explain how Cargo\u2019s configuration system works, as well as available keys or configuration. For configuration of a project through its manifest, see the manifest format.</p>\n</blockquote>\n<p>Put your <code>[build]</code> inside <code>$PROJECT_DIR/.cargo/config</code> or even <code>$HOME/.cargo/config</code>. See the above link for all the options.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 3, "last_activity_date": 1606315052, "creation_date": 1606315052, "answer_id": 65006802, "question_id": 50364390, "link": "https://stackoverflow.com/questions/50364390/how-can-i-specify-a-custom-cargo-output-directory/65006802#65006802", "title": "How can I specify a custom Cargo output directory?", "body": "<p>Use the <a href=\"https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-reads\" rel=\"nofollow noreferrer\"><code>CARGO_TARGET_DIR</code> environment variable</a>:</p>\n<pre class=\"lang-none prettyprint-override\"><code>CARGO_TARGET_DIR=../my-target cargo run --bin my_project\n</code></pre>\n<p>(This is stated in the question, but I wanted to highlight it for anyone that skips over that)</p>\n"}, {"comments": [{"owner": {"reputation": 2879, "user_id": 11082165, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4b73f08b7fb69386c5dc56497ff2ca58?s=128&d=identicon&r=PG&f=1", "display_name": "Brian", "link": "https://stackoverflow.com/users/11082165/brian"}, "edited": false, "score": 1, "creation_date": 1612292346, "post_id": 66014787, "comment_id": 116719818, "body": "Hello! While this command may solve the question, <a href=\"https://meta.stackexchange.com/q/114762\">including an explanation</a> of how and why this solves the problem would really help to improve the quality of your post, and probably result in more up-votes. Remember that you are answering the question for readers in the future, not just the person asking now. Please <a href=\"https://stackoverflow.com/posts/66014787/edit\">edit</a> your answer to add explanations and give an indication of what limitations and assumptions apply."}], "tags": [], "owner": {"reputation": 1, "user_id": 15131217, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-zylyVyH_IUk/AAAAAAAAAAI/AAAAAAAAAAA/AMZuuck_GHAmt7bS_145PNg9xvM1wF1hTg/s96-c/photo.jpg?sz=128", "display_name": "Meloni Vanderpool", "link": "https://stackoverflow.com/users/15131217/meloni-vanderpool"}, "is_accepted": false, "score": -2, "last_activity_date": 1612287366, "creation_date": 1612287366, "answer_id": 66014787, "question_id": 50364390, "link": "https://stackoverflow.com/questions/50364390/how-can-i-specify-a-custom-cargo-output-directory/66014787#66014787", "title": "How can I specify a custom Cargo output directory?", "body": "<p>CARGO_TARGET_DIR=../my-target cargo run --bin my_projectCARGO_TARGET_DIR=../my-target cargo run --bin my_projectCARGO_TARGET_DIR=../my-target cargo run --bin my_projectCARGO_TARGET_DIR=../my-target cargo run --bin my_projectCARGO_TARGET_DIR=../my-target cargo run --bin my_projectCARGO_TARGET_DIR=../my-target cargo run --bin my_projectvvcvvvCARGO_TARGET_DIR=../my-target cargo run --bin my_projectv637u3./337eyh8uew0iu722.ls-4 82[dh3lfh3f.d;epe]\npd;wegoj48t732sdl3od';e3;4lpw04u8uer43w4lp4pli0peodkhp5;r/b?/;\n;;phlli;yog;jhjou[uj[jud7ffe5e6e6wuduy373y82889478</p>\n"}], "owner": {"reputation": 657, "user_id": 2547570, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/66ac34b6d04aa0bf9c738ef391c8b722?s=128&d=identicon&r=PG", "display_name": "mq7", "link": "https://stackoverflow.com/users/2547570/mq7"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3566, "favorite_count": 0, "accepted_answer_id": 50365079, "answer_count": 3, "score": 8, "last_activity_date": 1612287366, "creation_date": 1526454307, "last_edit_date": 1606314971, "question_id": 50364390, "link": "https://stackoverflow.com/questions/50364390/how-can-i-specify-a-custom-cargo-output-directory", "title": "How can I specify a custom Cargo output directory?", "body": "<p>I put this in my Cargo.toml</p>\n<pre><code>[build]\ntarget-dir = &quot;../my-target&quot;\n</code></pre>\n<p>However, Cargo doesn't recognize this key.</p>\n<pre class=\"lang-none prettyprint-override\"><code>cargo run --release --bin my_project\n\nwarning: unused manifest key: build\nerror: failed to open: /.../project-root/target/releases/.cargo-lock\n\nCaused by:\n  Permission denied (os error 13)\n</code></pre>\n<p>The custom target dir with the environment variable works:</p>\n<pre class=\"lang-none prettyprint-override\"><code>CARGO_TARGET_DIR=../my-target cargo run --bin my_project\n</code></pre>\n<p>but how can I specify '../my-target' in Cargo.toml?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1526452924, "post_id": 50362066, "comment_id": 87744130, "body": "Do you want to know (1) how many digits are necessary to represent the floating point number or (2) how many bits/digits are precise and how many are noise in the floating point number as a result of the computations?"}, {"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1526453021, "post_id": 50362066, "comment_id": 87744190, "body": "@MatthieuM. How many digits are necessary to represent the floating point number so that I can use it as input for rounding of addition/subtraction arithmetic."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1526493938, "post_id": 50362066, "comment_id": 87770999, "body": "This is not a well defined question. How many digits are necessary to represent <code>0.1</code>? What about <code>0.1000</code>? What about <code>0.1000000000000000055511151231257827021181583404541015625</code>? (I didn&#39;t pick that last one randomly, it&#39;s the exact value of <code>0.1f64</code>.)"}], "answers": [{"tags": [], "owner": {"reputation": 9980, "user_id": 1944004, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/60f3cc97f94fa3690ba406f8c1a7fc4f?s=128&d=identicon&r=PG", "display_name": "Henri Menke", "link": "https://stackoverflow.com/users/1944004/henri-menke"}, "is_accepted": true, "score": 1, "last_activity_date": 1526446007, "last_edit_date": 1526446007, "creation_date": 1526445341, "answer_id": 50362523, "question_id": 50362066, "link": "https://stackoverflow.com/questions/50362066/how-to-identify-floating-point-precision-at-runtime-with-rust/50362523#50362523", "title": "How to identify floating point precision at runtime with Rust?", "body": "<p>I'm not sure whether I understand the question correctly.  You want the number of decimal places?</p>\n\n<pre><code>fn round(n: f64, precision: u32) -&gt; f64 {\n    (n * 10_u32.pow(precision) as f64).round() / 10_i32.pow(precision) as f64\n}\n\nfn precision(x: f64) -&gt; Option&lt;u32&gt; {\n    for digits in 0..std::f64::DIGITS {\n        if round(x, digits) == x {\n            return Some(digits);\n        }\n    }\n    None\n}\n\nfn main() {\n    let x = 1.0005_f64;\n\n    println!(\"{:?}\", precision(x));\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=fcd50136aba13a2f92dca9acbfce251a&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p>I'd also recommend making the types in your round function a bit larger, so you don't run into overflow so fast.  The above code fails already as <code>x = 1e-10</code>.</p>\n\n<pre><code>fn round(n: f64, precision: u32) -&gt; f64 {\n    let precision = precision as f64;\n    (n * 10_f64.powf(precision)).round() / 10_f64.powf(precision)\n}\n</code></pre>\n"}], "owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 312, "favorite_count": 0, "accepted_answer_id": 50362523, "answer_count": 1, "score": -2, "last_activity_date": 1526461126, "creation_date": 1526441354, "question_id": 50362066, "link": "https://stackoverflow.com/questions/50362066/how-to-identify-floating-point-precision-at-runtime-with-rust", "title": "How to identify floating point precision at runtime with Rust?", "body": "<p>How to identify that the precision of <code>1.0005</code> in the below code (<a href=\"https://play.rust-lang.org/?gist=379c1c7d2437123c64541ce617d64d22&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">rust playground link</a>) is 4 at runtime?:</p>\n\n<pre><code>fn round(n: f64, precision: u32) -&gt; f64 {\n    (n * 10_u32.pow(precision) as f64).round() / 10_i32.pow(precision) as f64\n}\n\nfn main() {\n    let x = 1.0005_f64;\n\n    println!(\"{:?}\", round(x, 1));\n    println!(\"{:?}\", round(x, 2));\n    println!(\"{:?}\", round(x, 3));\n    println!(\"{:?}\", round(x, 4));\n    println!(\"{:?}\", round(x, 5));\n}\n</code></pre>\n"}, {"tags": ["floating-point", "rust", "precision", "floating-accuracy"], "comments": [{"owner": {"reputation": 14609, "user_id": 667648, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/mTpbt.jpg?s=128&g=1", "display_name": "Dair", "link": "https://stackoverflow.com/users/667648/dair"}, "edited": false, "score": 0, "creation_date": 1526433575, "post_id": 50361151, "comment_id": 87738890, "body": "I believe you can round the numbers to the nearest 1/10,000 and you should be fine."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 5, "creation_date": 1526433589, "post_id": 50361151, "comment_id": 87738895, "body": "There are <a href=\"https://rads.stackoverflow.com/amzn/click/com/081764704X\" rel=\"nofollow noreferrer\" rel=\"nofollow noreferrer\">literal books written on the topic of &quot;handling&quot; floating point math</a>. This question is <i>far</i> too broad to answer in a useful manner, especially as you don&#39;t even know what direction you want to go in to solve it. Check out <a href=\"http://floating-point-gui.de/\" rel=\"nofollow noreferrer\">What Every Programmer Should Know About Floating-Point Arithmetic</a> as well."}, {"owner": {"reputation": 10625, "user_id": 463813, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/0330196fcbc9cd35a4cb4a82a5f249a6?s=128&d=identicon&r=PG", "display_name": "patrick", "link": "https://stackoverflow.com/users/463813/patrick"}, "edited": false, "score": 0, "creation_date": 1526433610, "post_id": 50361151, "comment_id": 87738898, "body": "Either don\u2019t use floating point (since you know why this is happening I won\u2019t go in to that), or round the answer to the precision you need. That\u2019s usually enough."}, {"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "reply_to_user": {"reputation": 10625, "user_id": 463813, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/0330196fcbc9cd35a4cb4a82a5f249a6?s=128&d=identicon&r=PG", "display_name": "patrick", "link": "https://stackoverflow.com/users/463813/patrick"}, "edited": false, "score": 0, "creation_date": 1526434381, "post_id": 50361151, "comment_id": 87739056, "body": "@patrick Is there a way to identify precision of inputs at runtime? This post looks like a good solution and I just need to understand what power to raise the 10 to at runtime: <a href=\"https://stackoverflow.com/questions/28655362/how-does-one-round-a-floating-point-number-to-a-specified-number-of-digits\" title=\"how does one round a floating point number to a specified number of digits\">stackoverflow.com/questions/28655362/&hellip;</a>"}, {"owner": {"reputation": 112912, "user_id": 2410359, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/pIl9T.png?s=128&g=1", "display_name": "chux - Reinstate Monica", "link": "https://stackoverflow.com/users/2410359/chux-reinstate-monica"}, "edited": false, "score": 0, "creation_date": 1526441738, "post_id": 50361151, "comment_id": 87740570, "body": "Print your output to 15 significant digits or less.  <code>-0.010000000000000009</code> is 17 significant digits."}, {"owner": {"reputation": 9980, "user_id": 1944004, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/60f3cc97f94fa3690ba406f8c1a7fc4f?s=128&d=identicon&r=PG", "display_name": "Henri Menke", "link": "https://stackoverflow.com/users/1944004/henri-menke"}, "edited": false, "score": 4, "creation_date": 1526446047, "post_id": 50361151, "comment_id": 87741576, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/588004/is-floating-point-math-broken\">Is floating point math broken?</a>"}, {"owner": {"reputation": 10625, "user_id": 463813, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/0330196fcbc9cd35a4cb4a82a5f249a6?s=128&d=identicon&r=PG", "display_name": "patrick", "link": "https://stackoverflow.com/users/463813/patrick"}, "edited": false, "score": 0, "creation_date": 1526457684, "post_id": 50361151, "comment_id": 87746898, "body": "Using powers of 10 is the only way to be sure there are no errors in the math. Even rounding the answer is a risk. Watch that you\u2019re not running to the limits of what an integer can hold though. I\u2019m sure it\u2019s documented somewhere what the error margin is in floating points, but with the right (wrong) calculations it could add up. You decide the precision you need..."}], "answers": [{"tags": [], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "is_accepted": true, "score": 2, "last_activity_date": 1526476904, "last_edit_date": 1526476904, "creation_date": 1526451855, "answer_id": 50363743, "question_id": 50361151, "link": "https://stackoverflow.com/questions/50361151/how-to-deal-with-inexact-floating-point-arithmetic-results-in-rust/50363743#50363743", "title": "How to deal with inexact floating point arithmetic results in Rust?", "body": "<p>Since you know why this happens, I assume you want to format the output.</p>\n\n<p>As in the <a href=\"https://doc.rust-lang.org/std/fmt/#precision\" rel=\"nofollow noreferrer\">official docs</a>: </p>\n\n<blockquote>\n  <p><strong>Precision</strong></p>\n  \n  <p>For non-numeric types, this can be considered a \"maximum width\". If the resulting string is longer than this width, then it is truncated down to this many characters and that truncated value is emitted with proper <code>fill</code>, <code>alignment</code> and <code>width</code> if those parameters are set.</p>\n  \n  <p>For integral types, this is ignored.</p>\n  \n  <p>For floating-point types, this indicates how many digits after the decimal point should be printed.</p>\n  \n  <p>There are three possible ways to specify the desired <code>precision</code>:</p>\n  \n  <ol>\n  <li><p>An integer <code>.N</code>:</p>\n  \n  <p>the integer <code>N</code> itself is the precision.</p></li>\n  <li><p>An integer or name followed by dollar sign <code>.N$</code>:</p>\n  \n  <p>use format argument <code>N</code> (which must be a <code>usize</code>) as the precision.</p></li>\n  <li><p>An asterisk <code>.*</code>:</p>\n  \n  <p><code>.*</code> means that this <code>{...}</code> is associated with <em>two</em> format inputs rather than one: the first input holds the <code>usize</code> precision, and the second holds the value to print. Note that in this case, if one uses the format string <code>{&lt;arg&gt;:&lt;spec&gt;.*}</code>, then the <code>&lt;arg&gt;</code> part refers to the value to print, and the <code>precision</code> must come in the input preceding <code>&lt;arg&gt;</code>.</p></li>\n  </ol>\n</blockquote>\n\n<p>So in your case, one of those does the job:</p>\n\n<pre><code>println!(\"{0:.2?}\", difference);\nprintln!(\"{1:.0$?}\", 2, difference);\nprintln!(\"{:.*?}\", 2, difference);\nprintln!(\"{1:.*?}\", 2, difference);\nprintln!(\"{number:.prec$?}\", prec = 2, number = difference);\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=4e84d9db3d8b006e70cdb79dd062d97d&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p>However, if you want to continue with this precision, you may round the results:</p>\n\n<pre><code>.map(|x| (x * 100.0).round() / 100.0)\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=88167d7211ddc39058babbc54c5217ce&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<hr>\n\n<p><strong>See also:</strong> </p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/28655362/how-does-one-round-a-floating-point-number-to-a-specified-number-of-digits\">How does one round a floating point number to a specified number of digits?</a></li>\n</ul>\n"}], "owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1335, "favorite_count": 1, "closed_date": 1526462552, "accepted_answer_id": 50363743, "answer_count": 1, "score": 1, "last_activity_date": 1526515819, "creation_date": 1526433419, "last_edit_date": 1526515819, "question_id": 50361151, "link": "https://stackoverflow.com/questions/50361151/how-to-deal-with-inexact-floating-point-arithmetic-results-in-rust", "closed_reason": "Needs more focus", "title": "How to deal with inexact floating point arithmetic results in Rust?", "body": "<p>How to deal with floating point arithmetic in Rust?</p>\n\n<p><a href=\"https://play.rust-lang.org/?gist=60012966f3e271b48a0ab9bc8fbd6ab4&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">For example</a>:</p>\n\n<pre><code>fn main() {\n    let vector = vec![1.01_f64, 1.02, 1.03, 1.01, 1.05];\n\n    let difference: Vec&lt;f64&gt; = vector.windows(2).map(|slice| slice[0] - slice[1]).collect();\n    println!(\"{:?}\", difference);\n}\n</code></pre>\n\n<p>Returns:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[-0.010000000000000009, -0.010000000000000009, 0.020000000000000018, -0.040000000000000036]\n</code></pre>\n\n<p>Expected output:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[-0.01, -0.01, 0.02, -0.04]\n</code></pre>\n\n<p>I understand the reason for this happening but have never had to address it. </p>\n\n<p><strong>Update:</strong></p>\n\n<p>This post came about because results in other languages such as Python appeared to be exact. The plan was to replicate Python's approach in Rust however upon further investigation, Python, numpy and pandas all deal with numbers in the same way. That is, the inaccuracies are still present however not always visible/shown. Rust on the other hand made these innacuracies obvious which was confusing at first.</p>\n\n<p>Example: </p>\n\n<pre><code>l = [1.01, 1.02, 1.03, 1.01, 1.05]\n\nfor i in l:\n    print('%.18f' % i)\n</code></pre>\n\n<p>Prints:</p>\n\n<pre><code>1.010000000000000009\n1.020000000000000018\n1.030000000000000027\n1.010000000000000009\n1.050000000000000044\n</code></pre>\n\n<p>whereas <code>print(l)</code> prints:</p>\n\n<pre><code>[1.01, 1.02, 1.03, 1.01, 1.05]\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526433040, "post_id": 50361045, "comment_id": 87738783, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/31230585/155423\">How does the lifetime work on constant strings?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50361045/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered (and delete my answer)."}, {"owner": {"reputation": 339851, "user_id": 149392, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7a561ec0875fcbbe3066ea8fe288ec77?s=128&d=identicon&r=PG", "display_name": "sepp2k", "link": "https://stackoverflow.com/users/149392/sepp2k"}, "edited": false, "score": 0, "creation_date": 1526434069, "post_id": 50361045, "comment_id": 87738995, "body": "Is the <code>return &amp;s</code> in <code>return_string1</code> equivalent to <code>return s</code> because <code>&amp;s</code> is auto-derefed? I was kind of expecting that to be a type error."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 339851, "user_id": 149392, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7a561ec0875fcbbe3066ea8fe288ec77?s=128&d=identicon&r=PG", "display_name": "sepp2k", "link": "https://stackoverflow.com/users/149392/sepp2k"}, "edited": false, "score": 2, "creation_date": 1526434170, "post_id": 50361045, "comment_id": 87739016, "body": "@sepp2k yes, it&#39;s <a href=\"https://stackoverflow.com/q/28519997/155423\">automatically dereferenced</a> because return values are a <a href=\"https://doc.rust-lang.org/nomicon/coercions.html\" rel=\"nofollow noreferrer\">coercion site</a>."}, {"owner": {"reputation": 339851, "user_id": 149392, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7a561ec0875fcbbe3066ea8fe288ec77?s=128&d=identicon&r=PG", "display_name": "sepp2k", "link": "https://stackoverflow.com/users/149392/sepp2k"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526435139, "post_id": 50361045, "comment_id": 87739181, "body": "@shepmaster Thanks. I feel like there should be a warning if an address-of expression is immediately auto-derefed. Something like &quot;Warning: Redundant <code>&amp;</code>&quot;. I think that might have prevented OP&#39;s confusion in this case."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 339851, "user_id": 149392, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7a561ec0875fcbbe3066ea8fe288ec77?s=128&d=identicon&r=PG", "display_name": "sepp2k", "link": "https://stackoverflow.com/users/149392/sepp2k"}, "edited": false, "score": 0, "creation_date": 1526435306, "post_id": 50361045, "comment_id": 87739210, "body": "@sepp2k Clippy warns on that for a function argument, not sure why it doesn&#39;t for a return value."}], "owner": {"reputation": 1674, "user_id": 5420686, "user_type": "registered", "accept_rate": 49, "profile_image": "https://www.gravatar.com/avatar/2c318e16c4b5f17dd1375df8cb1425e5?s=128&d=identicon&r=PG&f=1", "display_name": "Jal", "link": "https://stackoverflow.com/users/5420686/jal"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 138, "favorite_count": 0, "closed_date": 1526433737, "answer_count": 0, "score": 3, "last_activity_date": 1526432970, "creation_date": 1526432150, "last_edit_date": 1526432774, "question_id": 50361045, "link": "https://stackoverflow.com/questions/50361045/why-does-a-str-not-have-a-does-not-live-long-enough-issue-when-returned-from", "closed_reason": "Duplicate", "title": "Why does a &amp;str not have a &quot;does not live long enough&quot; issue when returned from a function?", "body": "<p>Consider the following code:</p>\n\n<pre><code>fn return_string1(filename: &amp;str) -&gt; &amp;str {\n    let s = \"hi\";\n    return &amp;s;\n}\n\nfn return_string2(filename: &amp;str) -&gt; &amp;String {\n    let s = String::from(\"Hello, Rust!\");\n    return &amp;s;\n}\n</code></pre>\n\n<p><code>return_string2</code> will encounter a problem:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `s` does not live long enough\n --&gt; src/main.rs:8:13\n  |\n8 |     return &amp;s;\n  |             ^ borrowed value does not live long enough\n9 | }\n  | - borrowed value only lives until here\n  |\nnote: borrowed value must be valid for the anonymous lifetime #1 defined on the function body at 6:1...\n --&gt; src/main.rs:6:1\n  |\n6 | / fn return_string2(filename: &amp;str) -&gt; &amp;String {\n7 | |     let s = String::from(\"Hello, Rust!\");\n8 | |     return &amp;s;\n9 | | }\n  | |_^\n</code></pre>\n\n<p>This is surprising since I expect <code>return_string1</code> will encounter the same problem since <code>s</code> is allocated in the function's stack and will be dropped after the function returns.</p>\n\n<p>Why does <code>return_string1</code> not have the same issue?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 10100, "user_id": 619216, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/c07104de771c3b6f6c30be8f592ef8f7?s=128&d=identicon&r=PG", "display_name": "BurntSushi5", "link": "https://stackoverflow.com/users/619216/burntsushi5"}, "is_accepted": true, "score": 11, "last_activity_date": 1526426472, "creation_date": 1526426472, "answer_id": 50360432, "question_id": 50360240, "link": "https://stackoverflow.com/questions/50360240/how-to-split-by-an-unknown-number-of-tabs-spaces-and-newlines-in-rust/50360432#50360432", "title": "How to split by an unknown number of tabs, spaces, and newlines in Rust?", "body": "<p>The <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.split_whitespace\" rel=\"noreferrer\"><code>split_whitespace</code></a> method defined on <code>str</code> in the standard library will do what you want.</p>\n\n<p>The example from the documentation is pretty clear:</p>\n\n<pre><code>let mut iter = \" Mary   had\\ta\\u{2009}little  \\n\\t lamb\".split_whitespace();\nassert_eq!(Some(\"Mary\"), iter.next());\nassert_eq!(Some(\"had\"), iter.next());\nassert_eq!(Some(\"a\"), iter.next());\nassert_eq!(Some(\"little\"), iter.next());\nassert_eq!(Some(\"lamb\"), iter.next());\n\nassert_eq!(None, iter.next());\n</code></pre>\n"}], "owner": {"reputation": 1674, "user_id": 5420686, "user_type": "registered", "accept_rate": 49, "profile_image": "https://www.gravatar.com/avatar/2c318e16c4b5f17dd1375df8cb1425e5?s=128&d=identicon&r=PG&f=1", "display_name": "Jal", "link": "https://stackoverflow.com/users/5420686/jal"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 486, "favorite_count": 0, "accepted_answer_id": 50360432, "answer_count": 1, "score": 3, "last_activity_date": 1526430761, "creation_date": 1526425090, "last_edit_date": 1526430761, "question_id": 50360240, "link": "https://stackoverflow.com/questions/50360240/how-to-split-by-an-unknown-number-of-tabs-spaces-and-newlines-in-rust", "title": "How to split by an unknown number of tabs, spaces, and newlines in Rust?", "body": "<p>I want to achieve something very similar to <code>strings.Fields</code> in Go where I get all the non <code>\\t</code> , <code>space</code> and <code>\\n</code> consecutive character in a line</p>\n\n<p>For example</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>this is a \\n special \\t\\t word\n</code></pre>\n\n<p>will return</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[this, is, a, special, word]\n</code></pre>\n\n<p>Is that possible in Rust?</p>\n\n<p>The <code>split</code> function only takes an explicit pattern.</p>\n\n<p>For example</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>a \\t\\t\\t b \\t\\t\\t\\t c\n</code></pre>\n\n<p>with</p>\n\n<pre><code>for s in line.split(\"\\t\\t\\t\") {\n    println!(\"{}\", s);\n}\n</code></pre>\n\n<p>will return</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>a\nb\n\\t\nc\n</code></pre>\n"}, {"tags": ["rust", "traits"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526411329, "post_id": 50357401, "comment_id": 87731627, "body": "you are borrowing self in the closure, <a href=\"https://play.rust-lang.org/?gist=8a33f614f7fec008097ce163459f6e86&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526411423, "post_id": 50357401, "comment_id": 87731679, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/50343130/155423\">Lifetimes for method returning iterator of structs with same lifetime</a>. TL;DR: <code>pub fn looper&lt;&#39;a&gt;(&amp;&#39;a self, l: Vec&lt;Child&gt;) -&gt; impl Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; + &#39;a</code> and add <code>move</code> to your closures. If you disagree, please <a href=\"https://stackoverflow.com/posts/50357401/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526435888, "post_id": 50361392, "comment_id": 87739328, "body": "Why do you disagree that this is a duplicate?"}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526436248, "post_id": 50361392, "comment_id": 87739402, "body": "@Shepmaster this question is literally &#39;what is the syntax for adding a lifetime to an impl Foo&#39;; that question is &#39;how do I write an iterator that returns objects with references in it?`; the answer may be similar, but the questions are not the same."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526436413, "post_id": 50361392, "comment_id": 87739428, "body": "As surprising as it is to many users, Stack Overflow duplicates aren&#39;t about questions, they are about <i>answers</i>. If the question is answered, they are duplicates."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526436533, "post_id": 50361392, "comment_id": 87739459, "body": "I&#39;d argue with &quot;is literally&quot; as well. OP asks not for syntax but to solve their problem. They didn&#39;t ask how to specify anything."}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526436739, "post_id": 50361392, "comment_id": 87739510, "body": "/shrug I have no idea &#39;whats best&#39;, I was just trying to help the OP instead of posting a comment, because getting a comment on your question instead of an actual answer is pretty frustrating, from personal experience. If answering the OP&#39;s question is someone the <i>wrong thing</i> to have done on a <i>Q&amp;A</i> site, then I&#39;m sorry. You&#39;re the mod with 100+K rep; do whatever it is that SO mods do in this kind of situation."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526437223, "post_id": 50361392, "comment_id": 87739606, "body": "I&#39;m not a mod, mods have a diamond next to their names; I have almost exactly the same powers you do (modulo my <a href=\"https://stackoverflow.com/questions/tagged/rust\">rust</a> gold badge and some <a href=\"/help/privileges\">minor editing rights</a>). When we mark as duplicate, we try to provide a comment connecting the duplicate to the OPs specific case. The reason for encouraging duplicates is to avoid scattering different shards of 70% of the answer across multiple posts, which ultimately makes it harder for people to find an answer. The ultimate goal of SO is to prevent ever needing to ask a question again because they&#39;ve all already been answered."}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526437426, "post_id": 50361392, "comment_id": 87739636, "body": "Fair enough. I feel like if I was the OP, I would look at the linked question and go &#39;but I&#39;m not trying to return &amp;self.foo in my iterator, Child is a concrete type with no references in it, this isn&#39;t the same question, I don&#39;t see how this is helpful&#39;."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526437797, "post_id": 50361392, "comment_id": 87739701, "body": "That&#39;s kind of what I was getting at with my first comment (and why I try not to close questions though I can) \u2014 I want to encourage new and unique questions, shaping them through iteration if need be. Focusing the question (by comments and by editing), drawing distinctions between existing questions, etc., are all good and useful. We asked the OP to provide that 7 hours ago and they were last seen 5 hours ago; I don&#39;t know why they didn&#39;t respond then. Usually we we wait a day before closing it in those cases."}, {"owner": {"reputation": 2777, "user_id": 4852094, "user_type": "registered", "accept_rate": 68, "profile_image": "https://graph.facebook.com/10102767534136292/picture?type=large", "display_name": "Rob", "link": "https://stackoverflow.com/users/4852094/rob"}, "edited": false, "score": 0, "creation_date": 1526440880, "post_id": 50361392, "comment_id": 87740356, "body": "Doug&#39;s answer helped me solve my problem, as did your comment.  I also am not sure what the appropriate measure is to take, I felt Doug&#39;s response helped me better understand the question because it provided an alternate explanation, and I value the effort he put into this.  I think Rust is not too saturated with questions, but appreciate your commitment to policing the Rust SO shepmaster."}], "tags": [], "owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "is_accepted": true, "score": 3, "last_activity_date": 1526437998, "last_edit_date": 1526437998, "creation_date": 1526435671, "answer_id": 50361392, "question_id": 50357401, "link": "https://stackoverflow.com/questions/50357401/inferring-lifetime-for-existential-type-impl-trait-in-rust-1-26/50361392#50361392", "title": "Inferring lifetime for existential type (impl Trait) in Rust 1.26", "body": "<pre><code>let y = x.into_iter().map(|d| {\n    d.map(|c| {\n        self.convert(&amp;c); // &lt;--- This\n         c\n    })\n});\n</code></pre>\n\n<p>This borrows <code>&amp;self</code> in the returned iterator, because every time <code>convert</code> is called, it requires that an instance of  <code>&amp;self</code> is passed to the function (even if it is unused).</p>\n\n<p>To explicitly make the lifetime correct, the syntax you want is:</p>\n\n<pre><code>fn foo&lt;'a&gt;(/* ... */) -&gt; impl 'a + Trait\n</code></pre>\n\n<p>e.g.</p>\n\n<pre><code>pub fn looper&lt;'a&gt;(&amp;'a self, l: /* ... */) -&gt; impl 'a + Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; { /* ... */ }\n</code></pre>\n\n<p>i.e. Return an <code>impl Iterator&lt;Item = Result&lt;Child, ()&gt;&gt;</code> with the same lifetime as the borrowed object.</p>\n\n<p>The default is that <code>impl Foo</code> returns a <code>'static</code> lifetime instance, which isn't valid in this case, because <code>convert</code> borrows <code>&amp;self</code>.</p>\n\n<p>Like this:</p>\n\n<pre><code>use std::result;\n\npub struct Child {\n    pub value: u32,\n}\n\npub struct Parent {\n    pub name: u32,\n}\n\nimpl Parent {\n    pub fn process(&amp;self, _l: &amp;Child) -&gt; result::Result&lt;(), ()&gt; {\n        Ok(())\n    }\n\n    pub fn convert(&amp;self, l: &amp;Child) {\n        ()\n    }\n\n    pub fn looper&lt;'a&gt;(&amp;'a self, l: Vec&lt;Child&gt;) -&gt; impl 'a + Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; {\n        let x: Vec&lt;_&gt; = l.into_iter()\n            .map(|tr| self.process(&amp;tr).map(|_| tr))\n            .collect(); // Calling collect() here forces all debits to complete\n\n        let y = x.into_iter().map(move |d| {\n            d.map(|c| {\n                self.convert(&amp;c);\n                c\n            })\n        });\n        y\n    }\n}\n\nfn main() {\n    let b = Parent { name: 0 };\n    let l = vec![Child { value: 10 }, Child { value: 20 }];\n    let k = b.looper(l);\n    drop(b); // &lt;-- Doesn't work.\n    let _: Vec&lt;Child&gt; = k.map(|x| x.unwrap()).collect();\n}\n</code></pre>\n\n<p>Notice the compiler correctly complains about attempting to throw away <code>b</code> while the iterator is not resolved:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0505]: cannot move out of `b` because it is borrowed\n  --&gt; src/main.rs:39:10\n   |\n38 |     let k = b.looper(l);\n   |             - borrow of `b` occurs here\n39 |     drop(b);\n   |          ^ move out of `b` occurs here\n</code></pre>\n\n<p>Alternatively, you could just remove the reference to <code>&amp;self</code> from <code>convert</code>:</p>\n\n<pre><code>pub fn convert(l: &amp;Child) {\n    ()\n}\n</code></pre>\n"}], "owner": {"reputation": 2777, "user_id": 4852094, "user_type": "registered", "accept_rate": 68, "profile_image": "https://graph.facebook.com/10102767534136292/picture?type=large", "display_name": "Rob", "link": "https://stackoverflow.com/users/4852094/rob"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 409, "favorite_count": 0, "closed_date": 1526477028, "accepted_answer_id": 50361392, "answer_count": 1, "score": 1, "last_activity_date": 1526437998, "creation_date": 1526410614, "last_edit_date": 1526410882, "question_id": 50357401, "link": "https://stackoverflow.com/questions/50357401/inferring-lifetime-for-existential-type-impl-trait-in-rust-1-26", "closed_reason": "Duplicate", "title": "Inferring lifetime for existential type (impl Trait) in Rust 1.26", "body": "<p>I'm trying to rewrite a method to use existential types, and I am having trouble deciphering the error:</p>\n\n<pre><code>use std::result;\n\npub struct Child {\n    pub value: u32,\n}\n\npub struct Parent {\n    pub name: u32,\n}\n\nimpl Parent {\n    pub fn process(&amp;self, _l: &amp;Child) -&gt; result::Result&lt;(), ()&gt; {\n        Ok(())\n    }\n\n    pub fn convert(&amp;self, l: &amp;Child) {\n        ()\n    }\n\n    pub fn looper(&amp;self, l: Vec&lt;Child&gt;) -&gt; impl Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; {\n        let x: Vec&lt;_&gt; = l.into_iter()\n            .map(|tr| self.process(&amp;tr).map(|_| tr))\n            .collect(); // Calling collect() here forces all debits to complete\n\n        let y = x.into_iter().map(|d| {\n            d.map(|c| {\n                self.convert(&amp;c);\n                c\n            })\n        });\n        y\n    }\n}\n\nfn main() {\n    let b = Parent { name: 0 };\n    let l = vec![Child { value: 10 }, Child { value: 20 }];\n    let _: Vec&lt;Child&gt; = b.looper(l).map(|x| x.unwrap()).collect();\n}\n</code></pre>\n\n<p>My error message states:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime due to conflicting requirements\n  --&gt; src/main.rs:25:35\n   |\n25 |           let y = x.into_iter().map(|d| {\n   |  ___________________________________^\n26 | |             d.map(|c| {\n27 | |                 self.convert(&amp;c);\n28 | |                 c\n29 | |             })\n30 | |         });\n   | |_________^\n   |\nnote: first, the lifetime cannot outlive the anonymous lifetime #1 defined on the method body at 20:5...\n  --&gt; src/main.rs:20:5\n   |\n20 | /     pub fn looper(&amp;self, l: Vec&lt;Child&gt;) -&gt; impl Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; {\n21 | |         let x: Vec&lt;_&gt; = l.into_iter()\n22 | |             .map(|tr| self.process(&amp;tr).map(|_| tr))\n23 | |             .collect(); // Calling collect() here forces all debits to complete\n...  |\n31 | |         y\n32 | |     }\n   | |_____^\n   = note: ...so that the types are compatible:\n           expected &amp;&amp;Parent\n              found &amp;&amp;Parent\n   = note: but, the lifetime must be valid for the static lifetime...\nnote: ...so that return value is valid for the call\n  --&gt; src/main.rs:20:44\n   |\n20 |     pub fn looper(&amp;self, l: Vec&lt;Child&gt;) -&gt; impl Iterator&lt;Item = Result&lt;Child, ()&gt;&gt; {\n   |                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n"}, {"tags": ["generics", "rust"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 2, "creation_date": 1526399321, "post_id": 50354162, "comment_id": 87725000, "body": "Rust generics do not use SFINAE like in C++ but are semantic. Read more about them."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526399876, "post_id": 50354162, "comment_id": 87725378, "body": "Welcome to Stack Overflow! I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/28219730/155423\">Is it possible to access struct fields from within a trait?</a>. TL;DR: no, you cannot do what you are trying to do. If you disagree, please <a href=\"https://stackoverflow.com/posts/50354162/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526403133, "post_id": 50354162, "comment_id": 87727239, "body": "Please do not change your question to include suggestions from answers. Your question was answered, but it&#39;s acceptable to ask new ones for new topics (after searching for existing posts and creating a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, of course)."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526403252, "post_id": 50354162, "comment_id": 87727300, "body": "For example, your update would be a duplicate of questions like <a href=\"https://stackoverflow.com/q/38812874/155423\">\u201cno method found for type T in the current scope\u201d when wrapping a type</a>. Make sure to search for your error message first."}], "owner": {"reputation": 87, "user_id": 9795022, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=128", "display_name": "yutaaa", "link": "https://stackoverflow.com/users/9795022/yutaaa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 671, "favorite_count": 0, "closed_date": 1526402964, "answer_count": 0, "score": 2, "last_activity_date": 1526402985, "creation_date": 1526398590, "last_edit_date": 1526402985, "question_id": 50354162, "link": "https://stackoverflow.com/questions/50354162/no-field-foo-on-generic-type-t", "closed_reason": "Duplicate", "title": "No field &#39;foo&#39; on generic type &#39;T&#39;", "body": "<p>I tried to implement a builder pattern in Rust as an exercise. Then, I wanted to implement <code>struct Director</code> with generics which handle concrete <code>Builder</code>s and calculates the distance between two points.</p>\n\n<p>Please turn a blind eye to the unsafe code:</p>\n\n<pre><code>struct VecLengthDirector&lt;T&gt; {\n    builder: T,\n}\n\nimpl&lt;T&gt; VecLengthDirector&lt;T&gt; {\n    fn construct(&amp;self) -&gt; f64 {\n        let s = self.builder.start.unwrap();\n        let e = self.builder.end.unwrap();\n\n        let mut sum: i32 = 0;\n        for i in 0..s.len() {\n            sum += (s[i] - e[i]).pow(2);\n        }\n\n        (sum as f64).sqrt()\n    }\n}\n\ntrait AbstractVecLengthBuider&lt;T&gt; {\n    fn addStartPoint(&amp;mut self, point: T);\n    fn addEndPoint(&amp;mut self, point: T);\n}\n\nstruct TwoDimVecLengthBuilder {\n    start: Option&lt;[i32; 2]&gt;,\n    end: Option&lt;[i32; 2]&gt;,\n}\n\nimpl AbstractVecLengthBuider&lt;[i32; 2]&gt; for TwoDimVecLengthBuilder {\n    fn addStartPoint(&amp;mut self, point: [i32; 2]) {\n        self.start = Some(point);\n    }\n    fn addEndPoint(&amp;mut self, point: [i32; 2]) {\n        self.end = Some(point);\n    }\n}\n\npub fn test() {\n    let mut veclen1 = VecLengthDirector {\n        builder: TwoDimVecLengthBuilder {\n            start: None,\n            end: None,\n        },\n    };\n    veclen1.builder.addStartPoint([0, 0]);\n    veclen1.builder.addEndPoint([1, 1]);\n    println!(\n        \"Distance between [0, 0] and [1, 1] is: {}\",\n        veclen1.construct()\n    );\n}\n</code></pre>\n\n<p>After running this code, the following error is reported:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0609]: no field `start` on type `T`\n --&gt; src/main.rs:7:30\n  |\n7 |         let s = self.builder.start.unwrap();\n  |                              ^^^^^\n\nerror[E0609]: no field `end` on type `T`\n --&gt; src/main.rs:8:30\n  |\n8 |         let e = self.builder.end.unwrap();\n  |                              ^^^\n</code></pre>\n\n<p>I researched the error code and read Rust's documentation, but I couldn't understand what is happening and what's wrong.</p>\n"}, {"tags": ["rust", "type-conversion"], "answers": [{"comments": [{"owner": {"reputation": 1209, "user_id": 2179822, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/ec8ebff1de01237c23aa51bff540eb39?s=128&d=identicon&r=PG", "display_name": "K. Biermann", "link": "https://stackoverflow.com/users/2179822/k-biermann"}, "edited": false, "score": 0, "creation_date": 1526398467, "post_id": 50354048, "comment_id": 87724444, "body": "Sry, my question was no clear enough: I want a generic solution. Other datatypes like <code>Vec&lt;u8&gt;</code> support the conversion to <code>&amp;[u8]</code> by using the <code>&amp;</code>-operator. Now it would be cool if I could implement this for my own types so that I don&#39;t have to use <code>.as_ref()</code> every time."}], "tags": [], "owner": {"reputation": 504, "user_id": 7024293, "user_type": "registered", "accept_rate": 68, "profile_image": "https://lh3.googleusercontent.com/-_iHS8SMGqHA/AAAAAAAAAAI/AAAAAAAAAbE/HudebqQ1IF4/photo.jpg?sz=128", "display_name": "stevensonmt", "link": "https://stackoverflow.com/users/7024293/stevensonmt"}, "is_accepted": false, "score": 1, "last_activity_date": 1526398254, "creation_date": 1526398254, "answer_id": 50354048, "question_id": 50353904, "link": "https://stackoverflow.com/questions/50353904/how-to-overload-the-reference-operator/50354048#50354048", "title": "How to overload the reference operator?", "body": "<p>You are calling the whole struct with <code>print_slice(&amp;buffer);</code> but only the <code>data</code> field with <code>print_slice(buffer.as_ref())</code>. If you make it <code>print_slice(&amp;buffer.data)</code> it will work. Alternatively change the type signature of the <code>print_slice</code> function to expect <code>&amp;Buffer</code>, which will make the <code>as_ref()</code> line not work.</p>\n"}, {"comments": [{"owner": {"reputation": 1209, "user_id": 2179822, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/ec8ebff1de01237c23aa51bff540eb39?s=128&d=identicon&r=PG", "display_name": "K. Biermann", "link": "https://stackoverflow.com/users/2179822/k-biermann"}, "edited": false, "score": 0, "creation_date": 1526399535, "post_id": 50354428, "comment_id": 87725147, "body": "This is what I was looking for; thanks for the links!"}, {"owner": {"reputation": 504, "user_id": 7024293, "user_type": "registered", "accept_rate": 68, "profile_image": "https://lh3.googleusercontent.com/-_iHS8SMGqHA/AAAAAAAAAAI/AAAAAAAAAbE/HudebqQ1IF4/photo.jpg?sz=128", "display_name": "stevensonmt", "link": "https://stackoverflow.com/users/7024293/stevensonmt"}, "edited": false, "score": 0, "creation_date": 1526402313, "post_id": 50354428, "comment_id": 87726751, "body": "@Shepmaster, can you explain why after implementing as you show above calling <code>&amp;buffer</code> is equivalent to <code>&amp;buffer.data</code>? I would expect to have an error with <code>&amp;buffer.data</code> because implementing deref returns the <code>data</code> field already, so it is essentially calling <code>(buffer.data).data</code>. See playground: <a href=\"https://play.rust-lang.org/?gist=ebcece3fb7a076c5d8151e94e0c16f0e&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 504, "user_id": 7024293, "user_type": "registered", "accept_rate": 68, "profile_image": "https://lh3.googleusercontent.com/-_iHS8SMGqHA/AAAAAAAAAAI/AAAAAAAAAbE/HudebqQ1IF4/photo.jpg?sz=128", "display_name": "stevensonmt", "link": "https://stackoverflow.com/users/7024293/stevensonmt"}, "edited": false, "score": 1, "creation_date": 1526404118, "post_id": 50354428, "comment_id": 87727812, "body": "@MatthewStevenson 1. it&#39;s precedence is <code>&amp;(buffer.data)</code> 2. deref coercion only kicks in at a <a href=\"https://doc.rust-lang.org/nomicon/coercions.html\" rel=\"nofollow noreferrer\">coercion site</a> and field access isn&#39;t one of them, so <code>&amp;((&amp;buffer).data)</code> also works."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1526399432, "creation_date": 1526399432, "answer_id": 50354428, "question_id": 50353904, "link": "https://stackoverflow.com/questions/50353904/how-to-overload-the-reference-operator/50354428#50354428", "title": "How to overload the reference operator?", "body": "<p>You cannot overload the reference operator, but you <em>can</em> hook into <code>Deref</code> coercion:</p>\n\n<pre><code>impl std::ops::Deref for Buffer {\n    type Target = [u8];\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        &amp;self.data\n    }\n}\n</code></pre>\n\n<p>Your original code works in this case.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/28519997/155423\">What are Rust&#39;s exact auto-dereferencing rules?</a></li>\n<li><a href=\"https://stackoverflow.com/q/45086595/155423\">Is it considered a bad practice to implement Deref for newtypes?</a></li>\n</ul>\n"}], "owner": {"reputation": 1209, "user_id": 2179822, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/ec8ebff1de01237c23aa51bff540eb39?s=128&d=identicon&r=PG", "display_name": "K. Biermann", "link": "https://stackoverflow.com/users/2179822/k-biermann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 257, "favorite_count": 0, "accepted_answer_id": 50354428, "answer_count": 2, "score": 2, "last_activity_date": 1526399432, "creation_date": 1526397798, "last_edit_date": 1526399330, "question_id": 50353904, "link": "https://stackoverflow.com/questions/50353904/how-to-overload-the-reference-operator", "title": "How to overload the reference operator?", "body": "<p>I've implemented <code>AsRef&lt;[u8]&gt;</code> for my type and the automatic conversion to <code>&amp;[u8]</code> using <code>.as_ref()</code> works but the <code>&amp;</code>-operator doesn't... how can I make the operator work?</p>\n\n<pre><code>struct Buffer {\n    data: Vec&lt;u8&gt;,\n}\n\nimpl AsRef&lt;[u8]&gt; for Buffer {\n    fn as_ref(&amp;self) -&gt; &amp;[u8] {\n        &amp;self.data\n    }\n}\n\nfn print_slice(slice: &amp;[u8]) {\n    slice.iter().for_each(|b| print!(\"{:02x}\", b));\n    println!()\n}\n\nfn main() {\n    let buffer = Buffer {\n        data: b\"Testolope\".to_vec(),\n    };\n    // print_slice(&amp;buffer);     // &lt;- This does not work\n    print_slice(buffer.as_ref()) // &lt;- This works\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:20:17\n   |\n20 |     print_slice(&amp;buffer);\n   |                 ^^^^^^^ expected slice, found struct `Buffer`\n   |\n   = note: expected type `&amp;[u8]`\n              found type `&amp;Buffer`\n</code></pre>\n\n<p>I want a generic solution. Other datatypes like <code>Vec&lt;u8&gt;</code> support the conversion to <code>&amp;[u8]</code> by using the <code>&amp;</code>-operator. It would be cool if I could make this work for my own types so that I don't have to use <code>.as_ref()</code> every time.</p>\n"}, {"tags": ["generics", "rust", "lifetime"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1526393092, "post_id": 50351879, "comment_id": 87720512, "body": "It means pretty much the same as when you see a lifetime in any bound. e.g. <code>T: &#39;a + Debug</code>."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526393982, "post_id": 50351879, "comment_id": 87721124, "body": "@PeterHall If I understand well this notation, it is needed when we use a reference to <code>T</code> somewhere. But here, I return a concrete <code>struct</code> that implements <code>Iterator</code>."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526394160, "post_id": 50351879, "comment_id": 87721254, "body": "It would be unfair of the borrow-checker to reason about the code using any information that a human reader wouldn&#39;t also have access to. While the concrete type is known inside the function, it is not known outside."}], "answers": [{"comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 3, "creation_date": 1526394423, "post_id": 50352675, "comment_id": 87721468, "body": "<i>&quot;may contain references with the lifetime &#39;a&quot;</i>  \u2014 Interesting that you phrased it that way. Completely equivalent, but my intuition of its meaning is the contrapositive: &quot;must not outlive the lifetime &#39;a&quot;."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 11, "last_activity_date": 1526396834, "last_edit_date": 1526396834, "creation_date": 1526394183, "answer_id": 50352675, "question_id": 50351879, "link": "https://stackoverflow.com/questions/50351879/what-does-a-lifetime-mean-when-returning-a-conservative-impl-trait/50352675#50352675", "title": "What does a lifetime mean when returning a conservative impl trait?", "body": "<p>The syntax <code>impl Iterator&lt;Item = u32&gt; + 'a</code> means</p>\n\n<ul>\n<li>some type defined by the function will be returned, but you do not know the exact type. That's the <code>impl ...</code> part.</li>\n<li>the unspecified concrete type will be an iterator of <code>u32</code> values. That's the <code>Iterator&lt;Item = u32&gt;</code> part.</li>\n<li>the unspecified concrete type <strong>may contain references</strong> with the lifetime <code>'a</code>. That's the <code>+ 'a</code> part.</li>\n</ul>\n\n<p>In your example, the returned iterator contains references to <code>self</code>, so it must not be allowed to live longer than the instance of <code>A</code>, otherwise it would be invalid. The concrete type (if we could write it) would be <code>iter::Map&lt;slice::Iter&lt;'a, (u32, u32)&gt;, &lt;closure&gt;&gt;</code> \u2014 note that it has a <code>'a</code> in it.</p>\n\n<blockquote>\n  <p>It means that the trait object that lives somewhere in the heap will last during a lifetime <code>'a</code>.</p>\n</blockquote>\n\n<p>This is not quite true. Both cases have the same meaning: the unspecified concrete type may contain a reference. With a trait object, the concrete type is behind a pointer of some kind (<code>Box</code>, <code>&amp;</code>, <code>Rc</code>, etc.). With impl trait, the concrete type is placed directly on the stack.</p>\n\n<blockquote>\n  <p>this is not a trait object but a concrete object that lives in the stack</p>\n</blockquote>\n\n<p>Trait objects do not require the heap; they can utilize only the stack:</p>\n\n<pre><code>let x: &amp;std::fmt::Display = &amp;42;\nprintln!(\"{}\", x);\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/31609137/155423\">Why are explicit lifetimes needed in Rust?</a></li>\n<li><a href=\"https://stackoverflow.com/q/28219519/155423\">Are polymorphic variables allowed?</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": false, "score": 3, "last_activity_date": 1526396458, "creation_date": 1526396458, "answer_id": 50353470, "question_id": 50351879, "link": "https://stackoverflow.com/questions/50351879/what-does-a-lifetime-mean-when-returning-a-conservative-impl-trait/50353470#50353470", "title": "What does a lifetime mean when returning a conservative impl trait?", "body": "<blockquote>\n  <p>It means that the trait object that lives somewhere in the heap will last during a lifetime <code>'a</code>.</p>\n</blockquote>\n\n<p>Not quite.</p>\n\n<p><code>'a</code> here does not exactly specify, it only places an upper-bound on the lifetime of the object. Whether the object is located on the heap or on the stack does not matter: the compiler must ensure that the lifetime of this object does not exceed <code>'a</code>.</p>\n\n<p>The lifetime represents a relationship between referred and referent, and is used to ensure that the referent will never outlive the referred. As such, it places an upper-bound on the lifetime of the referent and a lower-bound on the lifetime of the referred.</p>\n\n<hr>\n\n<p>The compiler <em>could</em> derive the necessary lifetime from the actual concrete type that is returned by the function, however it would require that the type-checker be able to look at the function implementation to perform its job.</p>\n\n<p>Documenting the lifetime constraint at the interface boundary is thus more friendly to both humans and compiler: it allows local reasoning.</p>\n"}], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 112, "favorite_count": 0, "answer_count": 2, "score": 7, "last_activity_date": 1526396834, "creation_date": 1526391898, "last_edit_date": 1526393855, "question_id": 50351879, "link": "https://stackoverflow.com/questions/50351879/what-does-a-lifetime-mean-when-returning-a-conservative-impl-trait", "title": "What does a lifetime mean when returning a conservative impl trait?", "body": "<p>When searching for documentation about <em>conservative impl trait</em>, <a href=\"https://github.com/rust-lang/rust/issues/43719\" rel=\"noreferrer\">I found this example</a>:</p>\n\n<pre><code>struct A {\n    x: [(u32, u32); 10]\n}\n\nimpl A {\n    fn iter_values&lt;'a&gt;(&amp;'a self) -&gt; impl 'a + Iterator&lt;Item = u32&gt; {\n        self.x.iter().map(|a| a.0)\n    }\n}\n</code></pre>\n\n<p>What does the lifetime <code>'a</code> mean in the return type?</p>\n\n<p>I am aware of <a href=\"https://stackoverflow.com/questions/42028470/why-is-adding-a-lifetime-to-a-trait-with-the-plus-operator-iteratoritem-foo\">this question about lifetime bound in <code>Box</code></a>, but I think that the usecases are different. If I understand well the answer:</p>\n\n<blockquote>\n  <p>trait object is only valid for the lifetime 'a</p>\n</blockquote>\n\n<p>It means that the trait object that lives somewhere in the heap will last during a lifetime <code>'a</code>.</p>\n\n<p>But here, this is not a trait object but a concrete object that lives in the stack. So the compiler does not need to have hints about its lifetime.</p>\n\n<p>What am I missing about this?</p>\n"}, {"tags": ["rust", "couchbase", "rust-cargo"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526392173, "post_id": 50351721, "comment_id": 87719874, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/46786956/155423\">Can I add a dependent crate that is a subdirectory in a git repository?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50351721/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526392441, "post_id": 50351721, "comment_id": 87720074, "body": "@Shepmaster I&#39;m not sure that answers it because there are two crates in the same repo."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526392473, "post_id": 50351721, "comment_id": 87720094, "body": "@PeterHall but it works, no? Cargo scans through the entire repo looking for a matching Cargo.toml."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526392882, "post_id": 50351721, "comment_id": 87720358, "body": "@PeterHall I just compiled with <code>[dependencies] couchbase = { git = &quot;https:&#47;&#47;github.com&#47;couchbaselabs&#47;couchbase-rs&quot;, branch = &quot;master&quot; } couchbase-sys = { git = &quot;https:&#47;&#47;github.com&#47;couchbaselabs&#47;couchbase-rs&quot;, branch = &quot;master&quot; }</code> and it worked fine."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526392895, "post_id": 50351721, "comment_id": 87720368, "body": "@Shepmaster Oh yes, you are right. I forget that the LHS is the exact crate name. I always feel like that&#39;s just a label, which you could use to rename the crate even. Which was discussed but never done. It really <i>should</i> work that way IMO."}, {"owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "edited": false, "score": 0, "creation_date": 1526396820, "post_id": 50351721, "comment_id": 87723280, "body": "I compiled with <code>couchbase-sys = { git = &quot;https:&#47;&#47;github.com&#47;couchbaselabs&#47;couchbase-rs&quot;, branch = &quot;master&quot;, features = [&quot;build-lcb&quot;]}</code> without success: <code>thread &#39;main&#39; panicked at &#39;Could not find include path from pkg config&#39;, libcore&#47;option.rs:914:5</code>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526400518, "post_id": 50351721, "comment_id": 87725734, "body": "@attdona I can not reproduce this behavior. Looks like you <a href=\"https://github.com/couchbaselabs/couchbase-rs/blob/41ceed4e30ab13a3acd960cac12e2633c01a31af/couchbase-sys/build.rs#L35-L44\" rel=\"nofollow noreferrer\">haven&#39;t installed a required dependency</a>."}, {"owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526460828, "post_id": 50351721, "comment_id": 87748893, "body": "Many thanks @shepmaster. Was a conflicting couchbase version installed on my machine."}], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 64, "favorite_count": 0, "closed_date": 1526460835, "answer_count": 0, "score": 0, "last_activity_date": 1526391460, "creation_date": 1526391460, "question_id": 50351721, "link": "https://stackoverflow.com/questions/50351721/how-to-use-latest-couchbase-rs-version-from-github", "closed_reason": "Duplicate", "title": "How to use latest couchbase-rs version from GitHub", "body": "<p>I want to use latest couchbase-rs version directly from github.</p>\n\n<p>I managed successfully the <code>couchbase</code> dependency with:</p>\n\n<pre><code>couchbase = { git = \"https://github.com/couchbaselabs/couchbase-rs\", branch = \"master\"}\n</code></pre>\n\n<p>But I'm not able to use the <code>couchbase-sys</code> because it is a subdir of the <a href=\"https://github.com/couchbaselabs/couchbase-rs\" rel=\"nofollow noreferrer\">couchbase-rs</a> github project.</p>\n\n<p>Is there a way to configure such dependency into <code>Cargo.toml</code>?</p>\n"}, {"tags": ["reference", "rust", "borrow-checker"], "answers": [{"comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526371749, "post_id": 50345206, "comment_id": 87706238, "body": "It seems that the <code>const</code> variables are obsolete :p"}, {"owner": {"reputation": 94, "user_id": 9773761, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/hvbIK.png?s=128&g=1", "display_name": "Cosmo", "link": "https://stackoverflow.com/users/9773761/cosmo"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1526372088, "post_id": 50345206, "comment_id": 87706422, "body": "@Boiethios that&#39;s an interesting idea. Have you found discuss on that that you could link?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 94, "user_id": 9773761, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/hvbIK.png?s=128&g=1", "display_name": "Cosmo", "link": "https://stackoverflow.com/users/9773761/cosmo"}, "edited": false, "score": 0, "creation_date": 1526372243, "post_id": 50345206, "comment_id": 87706519, "body": "@Cosmo I saw somewhere that (maybe) one day, the <code>const</code> functions could be detected by the compiler without any hint. However, nothing was said about <code>const</code> variables, and I do not find any link right now."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 5, "creation_date": 1526377984, "post_id": 50345206, "comment_id": 87710171, "body": "@Boiethios They are not obsolete. This only works for literals. Sometimes you need a const that must be computed."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526378600, "post_id": 50345206, "comment_id": 87710603, "body": "@PeterHall Hum, you are right; but in theory, the compiler could know without hint what is <code>const</code> and what isn&#39;t."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 4, "creation_date": 1526378748, "post_id": 50345206, "comment_id": 87710695, "body": "@Boiethios There are some downsides to storing data in static memory, especially if the data is large, and not required for the full lifespan of the program. There are definitely times when you should have to opt in to the behaviour."}, {"owner": {"reputation": 3211, "user_id": 898649, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/63c72161fba6e27cb05c078651c5e969?s=128&d=identicon&r=PG", "display_name": "Alexey", "link": "https://stackoverflow.com/users/898649/alexey"}, "edited": false, "score": 0, "creation_date": 1587220590, "post_id": 50345206, "comment_id": 108427123, "body": "Does the use of <code>&amp;42</code> force the compiler to store <code>42</code> in the static memory instead of inlining it?"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 3211, "user_id": 898649, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/63c72161fba6e27cb05c078651c5e969?s=128&d=identicon&r=PG", "display_name": "Alexey", "link": "https://stackoverflow.com/users/898649/alexey"}, "edited": false, "score": 2, "creation_date": 1587369086, "post_id": 50345206, "comment_id": 108473855, "body": "@Alexey Yes, that&#39;s what the language model says. However, the optimizer can still inline the value later anyway."}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 47, "last_activity_date": 1556033905, "last_edit_date": 1556033905, "creation_date": 1526371426, "answer_id": 50345206, "question_id": 50345139, "link": "https://stackoverflow.com/questions/50345139/why-can-i-return-a-reference-to-a-local-literal-but-not-a-variable/50345206#50345206", "title": "Why can I return a reference to a local literal but not a variable?", "body": "<p>In your example, <code>[1, 2, 3]</code> is not treated as local variable, but as static one!</p>\n\n<p>Let's take a look at this code:</p>\n\n<pre><code>fn foo() -&gt; &amp;'static [i32] {\n    &amp;[1, 2, 3]\n}\n</code></pre>\n\n<p>This works! </p>\n\n<p>Some time ago, <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1414-rvalue_static_promotion.md\" rel=\"noreferrer\">RFC 1414: Rvalue Static Promotion</a> was merged: \"Promote constexpr rvalues to values in static memory instead of stack slots\". This means that basically all literals you write can live forever. Thus, things like <code>let _: &amp;'static i32 = &amp;42;</code> also work!</p>\n\n<p>If we avoid using a literal array, we can see the expected error:</p>\n\n<pre><code>fn bar() -&gt; impl Iterator&lt;Item = i32&gt; {\n    vec![1, 2, 3].iter().map(|&amp;i| i)\n}\n</code></pre>\n\n<p>Here we get the \"<code>v</code> does not live long enough\" error.</p>\n\n<p>This isn't limited to integers or arrays; it applies broadly to any literal that is composed solely of literals:</p>\n\n<pre><code>fn promote_integer() -&gt; &amp;'static i32 {\n    &amp;42\n}\n</code></pre>\n\n<pre><code>fn promote_float() -&gt; &amp;'static f64 {\n    &amp;42.42\n}\n</code></pre>\n\n<pre><code>fn promote_str() -&gt; &amp;'static str {\n    \"Hello World!\"\n}\n</code></pre>\n\n<pre><code>struct Foo(char);\n\nfn promote_struct() -&gt; &amp;'static Foo {\n    &amp;Foo('x')\n}\n</code></pre>\n\n<hr>\n\n<p>Beyond literals, this also works for a <em>tiny</em> number of functions in the standard library, <a href=\"https://github.com/rust-lang/rust/pull/53851/files\" rel=\"noreferrer\">but these were likely a mistake</a>. Deciding on if the result of arbitrary <code>const</code> functions can be automatically promoted to <code>static</code> is still an <a href=\"https://github.com/rust-rfcs/const-eval/issues/19\" rel=\"noreferrer\">open topic</a>.</p>\n"}], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2364, "favorite_count": 4, "accepted_answer_id": 50345206, "answer_count": 1, "score": 29, "last_activity_date": 1556033905, "creation_date": 1526371177, "last_edit_date": 1526391970, "question_id": 50345139, "link": "https://stackoverflow.com/questions/50345139/why-can-i-return-a-reference-to-a-local-literal-but-not-a-variable", "title": "Why can I return a reference to a local literal but not a variable?", "body": "<p>Why does this code compile?</p>\n\n<pre><code>fn get_iter() -&gt; impl Iterator&lt;Item = i32&gt; {\n    [1, 2, 3].iter().map(|&amp;i| i)\n}\n\nfn main() {\n    let _it = get_iter();\n}\n</code></pre>\n\n<p><code>[1, 2, 3]</code> is a local variable and <code>iter()</code> borrows it. This code should not compile because the returned value holds a reference to a local variable.</p>\n"}, {"tags": ["vector", "rust"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1526368374, "post_id": 50344039, "comment_id": 87704332, "body": "SO favors one question at a time; may I recommend eliding the &quot;formatting&quot; question since all others are tied together?"}, {"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1526369893, "post_id": 50344039, "comment_id": 87705199, "body": "@MatthieuM. Thanks, I removed the formatting point"}], "answers": [{"comments": [{"owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "edited": false, "score": 0, "creation_date": 1526371404, "post_id": 50344283, "comment_id": 87706071, "body": "Is this a correct trait implementation of your code for the vector type?: <a href=\"https://play.rust-lang.org/?gist=d3dbe1cb49a0ec1295eb7ef91714f4a3&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "edited": false, "score": 1, "creation_date": 1526374606, "post_id": 50344283, "comment_id": 87707885, "body": "@Greg: It can be simplified a bit (see <a href=\"https://play.rust-lang.org/?gist=ebf266eb481f0a6b58476849dcbb099d&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>) =&gt; no need to clone the option. I find the name <code>minimum</code> a bit confusing though, to be honest, I&#39;d stick to <code>minimum_difference</code>; I would expect <code>minimum</code> to refer to the smallest element, not the smallest difference between elements :)"}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 9, "last_activity_date": 1526368901, "last_edit_date": 1526368901, "creation_date": 1526368328, "answer_id": 50344283, "question_id": 50344039, "link": "https://stackoverflow.com/questions/50344039/how-to-compute-the-minimum-of-the-difference-of-a-vector-of-values/50344283#50344283", "title": "How to compute the minimum of the difference of a vector of values?", "body": "<p>Use iterators!</p>\n\n<p>On slices, it is possible to use the <a href=\"https://doc.rust-lang.org/std/primitive.slice.html#method.windows\" rel=\"noreferrer\"><code>windows()</code></a> method to get the consecutive pairs of elements. In your case, <code>vector.windows(2)</code> will yield: <code>[1.025, 1.028]</code>, <code>[1.028, 1.03]</code>, <code>[1.03, 1.05]</code>, and finally <code>[1.05, 1.051]</code>.</p>\n\n<p>This an iterator, so you can apply a transformation on it. In your case, I would suggest <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map\" rel=\"noreferrer\"><code>map</code></a>, to map each pair to the difference between the two elements of the pair: <code>.map(|slice| slice[0] - slice[1])</code>. And maybe take the absolute difference, using <code>(slice[0] - slice[1]).abs()</code>.</p>\n\n<p>This is still an iterator, so finally you can apply <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.min_by\" rel=\"noreferrer\"><code>min_by</code></a> which will only yield the minimum of all elements. Floats only implement <code>PartialOrd</code><sup>1</sup>, so: <code>.min_by(|x, y| x.partial_cmp(y).unwrap())</code>.</p>\n\n<p>Putting it altogether <a href=\"https://play.rust-lang.org/?gist=deb2b8cdffb4c03755ad9b296ae21b65&amp;version=stable&amp;mode=debug\" rel=\"noreferrer\">in the playground</a>:</p>\n\n<pre><code>fn main() {\n    let vector = vec![1.025_f64, 1.028, 1.03, 1.05, 1.051];\n\n    let minimum =\n        vector.windows(2)\n            .map(|slice| (slice[0] - slice[1]).abs())\n            .min_by(|x, y| x.partial_cmp(y).unwrap());\n\n    println!(\"{:?}\", minimum);\n}\n</code></pre>\n\n<p><sup>1</sup> <em>As seen here, floats CAN be compared. Due to the presence of NaNs however, the result is <code>Option&lt;Ordering&gt;</code>. In this case, assuming that there is no NaN in the input data, I just used <code>unwrap</code> to get to the underlying ordering; if a NaN sneaks in, it will panic.</em></p>\n"}, {"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1526384895, "post_id": 50344292, "comment_id": 87714541, "body": "Say your data points are measurements of the speed of a car spaced evenly in time. Minimum difference tells you how good your brakes are. Minimum absolute difference tells you nothing so useful"}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 2, "last_activity_date": 1526368353, "creation_date": 1526368353, "answer_id": 50344292, "question_id": 50344039, "link": "https://stackoverflow.com/questions/50344039/how-to-compute-the-minimum-of-the-difference-of-a-vector-of-values/50344292#50344292", "title": "How to compute the minimum of the difference of a vector of values?", "body": "<p>You could do it like this:</p>\n\n<pre><code>let v = vec![1.025f64, 1.028, 1.03, 1.05, 1.051];\nlet min = (0..v.len() - 1)\n    .map(|i| (v[i] - v[i + 1]).abs())\n    .min_by(|a, b| a.partial_cmp(b).unwrap());  // panic on `NaN`\n\nprintln!(\"{:?}\", min);\n</code></pre>\n\n<p>This code doesn't use a temporary vector to hold the differences. Instead it computes everything on the fly thanks to lazy iterators. Also note that I uses <a href=\"https://doc.rust-lang.org/stable/std/primitive.f64.html#method.abs\" rel=\"nofollow noreferrer\"><code>abs()</code></a> to compute the absolute difference (this is probably what you wanted).</p>\n\n<p>To find the minimum, <code>Iterator</code> offers a range of methods: <code>min()</code>, <code>min_by_key</code> and <code>min_by</code>. I used the later to deal with the problem of uncomparable floats. My code just panics if we encounter a <code>NaN</code> value. This might be OK for your use case, but you might expect <code>NaN</code> values and want to deal with the error.</p>\n\n<p>The resulting <code>min</code> variable is an <code>Option&lt;f64&gt;</code> which is <code>None</code> if the vector has length 1. If the vector has length 0, it panics when indexing <code>v[i + 1]</code>.</p>\n\n<p>About your \"floats are inaccurate\" problem: Yes, that's true. The only way to really solve this problem is by using a arbitrary precision type. There are probably a couple of crates offering such types. But this isn't really in the scope of this question anymore.</p>\n"}], "owner": {"reputation": 5940, "user_id": 4605629, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/741edb45b2f1d3e3c3d9555085004ad1?s=128&d=identicon&r=PG&f=1", "display_name": "Greg", "link": "https://stackoverflow.com/users/4605629/greg"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 838, "favorite_count": 0, "accepted_answer_id": 50344283, "answer_count": 2, "score": 1, "last_activity_date": 1526389966, "creation_date": 1526367443, "last_edit_date": 1526389966, "question_id": 50344039, "link": "https://stackoverflow.com/questions/50344039/how-to-compute-the-minimum-of-the-difference-of-a-vector-of-values", "title": "How to compute the minimum of the difference of a vector of values?", "body": "<p>How to compute the minimum difference of a vector in Rust?</p>\n\n<p>The below code:</p>\n\n<pre><code>fn main() {\n    let vector: Vec&lt;f64&gt; = vec![1.025, 1.028, 1.03, 1.05, 1.051];\n\n    let mut result: Vec&lt;f64&gt; = Vec::new();\n    for i in 0..vector.len() - 1 {\n        result.push(vector[i] - vector[i + 1]);\n    }\n    println!(\"{:?}\", result);\n\n    let minimum = std::cmp::min(&amp;result[0], &amp;result[1]);\n    println!(\"{}\", minimum)\n}\n</code></pre>\n\n<p>Results in:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `f64: std::cmp::Ord` is not satisfied\n  --&gt; src/main.rs:10:19\n   |\n10 |     let minimum = std::cmp::min(&amp;result[0], &amp;result[1]);\n   |                   ^^^^^^^^^^^^^ the trait `std::cmp::Ord` is not implemented for `f64`\n   |\n   = note: required because of the requirements on the impl of `std::cmp::Ord` for `&amp;f64`\n   = note: required by `std::cmp::min`\n</code></pre>\n\n<p>The challenges are:</p>\n\n<ul>\n<li><p><a href=\"https://github.com/rust-lang/rust/issues/40922\" rel=\"nofollow noreferrer\">no comparison between f32/f64 types</a></p></li>\n<li><p>only two values can be compared at any one time; how can I compute all values? Can a fold be used or does it have to be a macro?</p></li>\n<li>what is a memory efficient way to perform the difference over the vector? For example, creating a range and iterating over a vector (<code>for i in 0..5 { vector[i] }</code>) is more expensive than creating an iterator over the vector itself <code>for i in &amp;vector</code>.</li>\n</ul>\n"}, {"tags": ["rust", "borrow-checker"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526384465, "post_id": 50343279, "comment_id": 87714270, "body": "Why do you use <code>XMLEvent::Start(ref e)</code>? Why not <code>XMLEvent::Start(e)</code>"}, {"owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526384708, "post_id": 50343279, "comment_id": 87714413, "body": "I simply took a look at the readme on the repository <a href=\"https://github.com/tafia/quick-xml\" rel=\"nofollow noreferrer\">github.com/tafia/quick-xml</a>. Does this have an implication? What is the difference between both?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526384865, "post_id": 50343279, "comment_id": 87714523, "body": "Does it compile if you remove the <code>ref</code>? I&#39;ll write an answer if so"}, {"owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526385048, "post_id": 50343279, "comment_id": 87714635, "body": "No :( I have another error <code>cannot bind by-move into a pattern guard</code> and this points to the <code>e</code> symbol with the explanation ` moves value into pattern guard`"}], "answers": [{"comments": [{"owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "edited": false, "score": 0, "creation_date": 1526373350, "post_id": 50343556, "comment_id": 87707156, "body": "I always get the same error by splitting the statements on two lines :("}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "edited": false, "score": 0, "creation_date": 1526376679, "post_id": 50343556, "comment_id": 87709262, "body": "Then can you give the full error message? In particular the compiler should have said where exactly the mutable borrows occur."}, {"owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "edited": false, "score": 0, "creation_date": 1526377911, "post_id": 50343556, "comment_id": 87710127, "body": "It appears exactly as before, at the call to the second method <code>self.read_next_wpt()</code>"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "edited": false, "score": 0, "creation_date": 1526378647, "post_id": 50343556, "comment_id": 87710632, "body": "Can you give the full message please?"}, {"owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "edited": false, "score": 0, "creation_date": 1526399499, "post_id": 50343556, "comment_id": 87725118, "body": "The new answer is fine but what if I add more cases calling other methods ?"}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 1, "last_activity_date": 1526454034, "last_edit_date": 1526454034, "creation_date": 1526365422, "answer_id": 50343556, "question_id": 50343279, "link": "https://stackoverflow.com/questions/50343279/how-to-deal-with-multiple-mutable-borrows-in-rust-with-match/50343556#50343556", "title": "How to deal with multiple mutable borrows in Rust with match?", "body": "<p>The problem comes from the <code>'b</code> lifetime in the <a href=\"https://docs.rs/quick-xml/0.12.1/quick_xml/struct.Reader.html#method.read_event\" rel=\"nofollow noreferrer\">prototype for read_event</a>:</p>\n\n<pre><code>pub fn read_event&lt;'a, 'b&gt;(\n    &amp;'a mut self, \n    buf: &amp;'b mut Vec&lt;u8&gt;\n) -&gt; Result&lt;Event&lt;'b&gt;&gt;\n</code></pre>\n\n<p>This links the lifetime of the buffer with the lifetime of the return value so you can't re-use the buffer so long as the result is alive. You can get around it by returning early when you don't want to recurse and recursing only after you've finished using the result:</p>\n\n<pre><code>pub fn read_next&lt;a&gt;(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n    match self.reader.read_event(&amp;mut self.buff) {\n        Ok(XMLEvent::Start(ref e)) if e.name() == b\"wpt\" =&gt; (),\n        _ =&gt; { return Err(Error::NoCaches) },\n    }\n    self.read_next_wpt()\n}\n</code></pre>\n\n<p>If you want to add more cases, you must first extract any relevant information you wish to use from the result, including any information required to choose the method to call, then have the result go out of scope before you call the method. For example:</p>\n\n<pre><code>pub fn read_next&lt;a&gt;(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n    let next_method = match self.reader.read_event(&amp;mut self.buff) {\n        Ok(XMLEvent::Start(ref e)) if e.name() == b\"wpt\" =&gt; GPXParser&lt;B&gt;::read_next_wpt,\n        Ok(XMLEvent::Start(ref e)) if e.name() == b\"foo\" =&gt; GPXParser&lt;B&gt;::read_next_foo,\n        _ =&gt; { return Err(Error::NoCaches) },\n    }\n    next_method(self)\n}\n</code></pre>\n\n<p>Or it might be easier to just use a different buffer each time if the performance hit is small enough to be acceptable (you should measure it to back up your decision).</p>\n\n<hr>\n\n<p><em>Original answer below for reference:</em></p>\n\n<p>Try to split the <code>read_event</code> and the match into separate lines:</p>\n\n<pre><code>let result = self.reader.read_event(&amp;mut self.buff);\nmatch result {\n    ...\n}\n</code></pre>\n\n<p>Your problem is that the buffer is borrowed mutably for the whole match expression, so you can't re-borrow the buffer inside the match arms. By splitting the code in two lines, the buffer is only borrowed for the first expression (<code>let result=...</code>) and can be borrowed again in the match.</p>\n\n<p>This may be fixed in the future when non-lexical lifetimes become stable.</p>\n"}], "owner": {"reputation": 3087, "user_id": 856142, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5bfb729f6ac07e17c2326a7335a3f3be?s=128&d=identicon&r=PG", "display_name": "yageek", "link": "https://stackoverflow.com/users/856142/yageek"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1630, "favorite_count": 1, "accepted_answer_id": 50343556, "answer_count": 1, "score": 3, "last_activity_date": 1526454034, "creation_date": 1526364268, "last_edit_date": 1526390394, "question_id": 50343279, "link": "https://stackoverflow.com/questions/50343279/how-to-deal-with-multiple-mutable-borrows-in-rust-with-match", "title": "How to deal with multiple mutable borrows in Rust with match?", "body": "<p>I'm trying to encapsulate an XML parser using <code>quick-xml</code> that takes some specific XML in entry. The main code is the following:</p>\n\n<pre><code>pub struct GPXParser&lt;B: BufRead&gt; {\n    reader: Reader&lt;B&gt;,\n    buff: Vec&lt;u8&gt;,\n}\n\nimpl&lt;B&gt; GPXParser&lt;B&gt; {\n    pub fn read_next&lt;a&gt;(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n        match self.reader.read_event(&amp;mut self.buff) {\n            Ok(XMLEvent::Start(ref e)) if e.name() == b\"wpt\" =&gt; {\n                self.read_next_wpt() // --&gt; Multiple mutable borrows error\n            }\n            _ =&gt; Err(Error::NoCaches),\n        }\n    }\n\n    fn read_next_wpt(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n        match self.reader.read_event(&amp;mut self.buff) {\n            _ =&gt; Err(Error::NoCaches),\n        }\n    }\n}\n</code></pre>\n\n<p>I then read this <a href=\"https://users.rust-lang.org/t/workaround-for-cannot-borrow-self-as-mutable-more-than-once-at-a-time/16286/28\" rel=\"nofollow noreferrer\" title=\"topic\">topic</a> on rust-lang.org, mentioning that:</p>\n\n<blockquote>\n  <p>idiomatic Rust code typically avoids holding long-lived references to mutable object internals and favors alternate approaches that use immutable references or independent values</p>\n</blockquote>\n\n<p>I tried to change my approach using an intermediate <code>buff</code> element:</p>\n\n<pre><code>pub struct GPXParser&lt;B: BufRead&gt; {\n    reader: Reader&lt;B&gt;,\n}\n\nimpl&lt;B&gt; GPXParser&lt;B&gt; {\n    pub fn read_next&lt;a&gt;(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n        let mut buff: Vec&lt;u8&gt; = Vec::new();\n\n        match self.reader.read_event(&amp;mut buff) {\n            Ok(XMLEvent::Start(ref e)) if e.name() == b\"wpt\" =&gt; {\n                self.read_next_wpt(&amp;mut buff) // --&gt; Multiple mutable borrows error\n            }\n            _ =&gt; Err(Error::NoCaches),\n        }\n    }\n\n    fn read_next_wpt(&amp;mut self, buff: &amp;mut Vec&lt;u8&gt;) -&gt; Result&lt;XMLCache, Error&gt; {\n        match self.reader.read_event(buff) {\n            _ =&gt; Err(Error::NoCaches),\n        }\n    }\n}\n</code></pre>\n\n<p>I  did not change the approach.</p>\n\n<p>I tried to split the <code>match</code> statement in two lines:</p>\n\n<pre><code>pub fn read_next&lt;a&gt;(&amp;mut self) -&gt; Result&lt;XMLCache, Error&gt; {\n    let result = self.reader.read_event(&amp;mut self.buff);\n    match result {\n        Ok(XMLEvent::Start(ref e)) if e.name() == b\"wpt\" =&gt; self.read_next_wpt(),\n        _ =&gt; Err(Error::NoCaches),\n    }\n}\n</code></pre>\n\n<p>But I get the same error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0499]: cannot borrow `*self` as mutable more than once at a time\n  --&gt; src/gpx/mod.rs:34:17\n   |\n31 |         let result = self.reader.read_event(&amp;mut self.buff);\n   |                                                  --------- first mutable borrow occurs here\n...\n34 |                 self.read_next_wpt()\n   |                 ^^^^ second mutable borrow occurs here\n...\n39 |     }\n   |     - first borrow ends here\n</code></pre>\n\n<p>Is there a way to use the same buffer all around the different methods calls?</p>\n\n<p>Should some lifetimes come into the game?</p>\n\n<p>If not, what would be an idiomatic Rust approach to solve this issue?</p>\n"}, {"tags": ["rust", "lifetime", "borrow-checker"], "answers": [{"comments": [{"owner": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526365527, "post_id": 50343342, "comment_id": 87702946, "body": "Indeed! It&#39;s a shame that the error message for both isn&#39;t the same (because the one you provoked is definitely a lot more explicit that &quot;other referenced variables&quot; could be the problem). Thanks so much! (Also as a note, I was able to get this working with an array by only adding the <code>move</code> and the lifetime to <code>self</code> in 1.26; I&#39;m unsure if you were implying that I needed to keep the vector)"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526366460, "post_id": 50343342, "comment_id": 87703353, "body": "@BaileyParker I was implying that; I cannot explain why this compiles. My answer is still incomplete, then."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526369151, "post_id": 50343342, "comment_id": 87704779, "body": "@BaileyParker I removed the stuff about the array"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526371199, "post_id": 50343342, "comment_id": 87705960, "body": "@BaileyParker FYI, I asked a question about this <a href=\"https://stackoverflow.com/questions/50345139/do-this-code-returns-a-reference-to-a-local-variable\" title=\"do this code returns a reference to a local variable\">stackoverflow.com/questions/50345139/&hellip;</a>"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 7, "last_activity_date": 1526391395, "last_edit_date": 1526391395, "creation_date": 1526364564, "answer_id": 50343342, "question_id": 50343130, "link": "https://stackoverflow.com/questions/50343130/lifetimes-for-method-returning-iterator-of-structs-with-same-lifetime/50343342#50343342", "title": "Lifetimes for method returning iterator of structs with same lifetime", "body": "<p>When you have this kind of issue in a method, a good thing to do is to add an explicit lifetime to <code>&amp;self</code>:</p>\n\n<pre><code>pub fn neighbors(&amp;'a self) -&gt; impl Iterator&lt;Item = Point&lt;'a&gt;&gt; {\n    [(0, -1), (-1, 0), (1, 0), (1, 0)]\n        .iter().map(|(dx, dy)| Point {\n            board: self.board,\n            x: self.x + dx,\n            y: self.y + dy,\n        })\n}\n</code></pre>\n\n<p>The error is now better</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0373]: closure may outlive the current function, but it borrows `self`, which is owned by the current function\n  --&gt; src/main.rs:14:30\n   |\n14 |             .iter().map(|(dx, dy)| Point {\n   |                         ^^^^^^^^^^ may outlive borrowed value `self`\n15 |                 board: self.board,\n   |                        ---- `self` is borrowed here\nhelp: to force the closure to take ownership of `self` (and any other referenced variables), use the `move` keyword\n   |\n14 |             .iter().map(move |(dx, dy)| Point {\n   |                         ^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>You then just need to add the <code>move</code> keyword as advised by the compiler, to say to it that you will not use <code>&amp;'a self</code> again.</p>\n\n<p>Note that the lifetime of <code>self</code> has not to be the same as the lifetime of <code>Point</code>. This is better to use this signature:</p>\n\n<pre><code>fn neighbors&lt;'b&gt;(&amp;'b self) -&gt; impl 'b + Iterator&lt;Item = Point&lt;'a&gt;&gt;\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526402664, "post_id": 50351826, "comment_id": 87726959, "body": "Interesting, I hadn&#39;t considered this. Just to be sure, the reason why your example fails is because board has lifetime <code>&#39;b</code> but <code>inner</code>&#39;s lifetime is tied to the scope assigned to <code>_a</code> (which are distinct)?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526403519, "post_id": 50351826, "comment_id": 87727462, "body": "@BaileyParker it will fail because the unified lifetimes (<code>fn neighbors(&amp;&#39;a self) -&gt; impl Iterator&lt;Item = Point&lt;&#39;a&gt;&gt;</code>) means that the returned <code>Point</code>s might contain a reference to <code>self</code> / the origin <code>Point</code>."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1526391762, "creation_date": 1526391762, "answer_id": 50351826, "question_id": 50343130, "link": "https://stackoverflow.com/questions/50343130/lifetimes-for-method-returning-iterator-of-structs-with-same-lifetime/50351826#50351826", "title": "Lifetimes for method returning iterator of structs with same lifetime", "body": "<p>I would assign a lifetime to <code>self</code> that is distinct from the lifetime of the <code>Board</code>:</p>\n\n<pre><code>impl&lt;'b&gt; Point&lt;'b&gt; {\n    fn neighbors&lt;'a&gt;(&amp;'a self) -&gt; impl Iterator&lt;Item = Point&lt;'b&gt;&gt; + 'a {\n        [(0, -1), (-1, 0), (1, 0), (1, 0)]\n            .iter().map(move |(dx, dy)| Point {\n                board: self.board,\n                x: self.x + dx,\n                y: self.y + dy,\n            })\n    }\n}\n</code></pre>\n\n<p>This also requires marking the closure as <code>move</code> to move the <code>&amp;Self</code> value into the closure so that the closure can still access <code>board</code>, <code>x</code> and <code>y</code> when it is advanced. Since immutable references can be copied, this won't prevent the caller from doing anything.</p>\n\n<p>Without the separate lifetimes, the lifetimes of the <code>Point</code>s returned from the iterator are artificially limited to the lifetime of the <code>Point</code> that generated them. As an example, this code fails when the lifetimes are unified, but works when they are distinct:</p>\n\n<pre><code>fn example&lt;'b&gt;(board: &amp;'b Board) {\n    let _a = {\n        let inner = Point { board, x: 0, y: 0 };\n        let mut n = inner.neighbors();\n        n.next().unwrap()\n    };\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/29861388/155423\">When is it useful to define multiple lifetimes in a struct?</a></li>\n</ul>\n"}, {"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526395480, "post_id": 50352058, "comment_id": 87722284, "body": "@Boiethios There are cases where this won&#39;t work and one might have to fall back to a more restrictive signature. I&#39;ve added a disclaimer"}, {"owner": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "edited": false, "score": 0, "creation_date": 1526402429, "post_id": 50352058, "comment_id": 87726804, "body": "This is a good point. I hadn&#39;t much considered usage context. For my particular case, it may make more sense to not make point <code>Copy</code>, but if it was it looks like you&#39;re correct in that I should store the fields on <code>self</code> that I need in locals. Bioethios had the root cause right, but this is a good point. Wish I could give the check to both :)"}], "tags": [], "owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "is_accepted": false, "score": 3, "last_activity_date": 1526395401, "last_edit_date": 1526395401, "creation_date": 1526392423, "answer_id": 50352058, "question_id": 50343130, "link": "https://stackoverflow.com/questions/50343130/lifetimes-for-method-returning-iterator-of-structs-with-same-lifetime/50352058#50352058", "title": "Lifetimes for method returning iterator of structs with same lifetime", "body": "<p>Both the existing answers (<a href=\"https://stackoverflow.com/a/50351826/3650362\">Shepmaster</a>, <a href=\"https://stackoverflow.com/a/50343342/3650362\">Boiethios</a>) allow the <code>Point</code>s returned by the iterator to outlive the iterator itself. However, it should be possible to build an iterator that even outlives the original <code>Point</code> it was created from, by moving the contents of the <code>Point</code> into it. This version retains the original function signature:</p>\n\n<pre><code>fn neighbors(&amp;self) -&gt; impl Iterator&lt;Item = Point&lt;'a&gt;&gt; {\n    let Point { board, x, y } = *self;\n    [(0, -1), (-1, 0), (1, 0), (1, 0)]\n        .iter().map(move |(dx, dy)| Point {\n            board: board,\n            x: x + dx,\n            y: y + dy,\n        })\n}\n</code></pre>\n\n<p>Copying the contents of <code>*self</code> into local variables which are moved into the closure makes it so the closure -- and therefore the returned iterator -- no longer contains any references to <code>self</code>.</p>\n\n<p>Here's something you can do with this version that can't be done otherwise (<a href=\"http://play.rust-lang.org/?gist=a4dbc41c7cd6c964597999318f4a6cf3&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground</a>):</p>\n\n<pre><code>let mut p = Point {\n    board: &amp;b,\n    x: 10,\n    y: 12,\n};\nfor n in p.neighbors() {\n    p = n;\n}\n</code></pre>\n\n<p>One potential caveat is that if <code>Point</code> contains very large or non-<code>Copy</code> data that can't or shouldn't be moved into the closure, this won't work. In that case you should use the other solution:</p>\n\n<pre><code>fn neighbors&lt;'b&gt;(&amp;'b self) -&gt; impl 'b + Iterator&lt;Item = Point&lt;'a&gt;&gt;\n</code></pre>\n"}], "owner": {"reputation": 14585, "user_id": 568785, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/88c6371f6a47841abde4c60dd8a2f964?s=128&d=identicon&r=PG", "display_name": "Bailey Parker", "link": "https://stackoverflow.com/users/568785/bailey-parker"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 564, "favorite_count": 0, "accepted_answer_id": 50343342, "answer_count": 3, "score": 4, "last_activity_date": 1526395401, "creation_date": 1526363536, "last_edit_date": 1526364336, "question_id": 50343130, "link": "https://stackoverflow.com/questions/50343130/lifetimes-for-method-returning-iterator-of-structs-with-same-lifetime", "title": "Lifetimes for method returning iterator of structs with same lifetime", "body": "<p>Assume the following contrived example:</p>\n\n<pre><code>struct Board {\n    squares: Vec&lt;i32&gt;,\n}\n\nstruct Point&lt;'a&gt; {\n    board: &amp;'a Board,\n    x: i32,\n    y: i32,\n}\n\nimpl&lt;'a&gt; Point&lt;'a&gt; {\n    pub fn neighbors(&amp;self) -&gt; impl Iterator&lt;Item = Point&lt;'a&gt;&gt; {\n        [(0, -1), (-1, 0), (1, 0), (1, 0)]\n            .iter().map(|(dx, dy)| Point {\n                board: self.board,\n                x: self.x + dx,\n                y: self.y + dy,\n            })\n    }\n}\n</code></pre>\n\n<p>This doesn't compile because from what I understand the lifetime of the points created in the lambda isn't correct:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime due to conflicting requirements\n  --&gt; src/main.rs:14:25\n   |\n14 |               .iter().map(|(dx, dy)| Point {\n   |  _________________________^\n15 | |                 board: self.board,\n16 | |                 x: self.x + dx,\n17 | |                 y: self.y + dy,\n18 | |             })\n   | |_____________^\n   |\nnote: first, the lifetime cannot outlive the anonymous lifetime #1 defined on the method body at 12:5...\n  --&gt; src/main.rs:12:5\n   |\n12 | /     pub fn neighbors(&amp;self) -&gt; impl Iterator&lt;Item = Point&lt;'a&gt;&gt; {\n13 | |         [(0, -1), (-1, 0), (1, 0), (1, 0)]\n14 | |             .iter().map(|(dx, dy)| Point {\n15 | |                 board: self.board,\n...  |\n18 | |             })\n19 | |     }\n   | |_____^\n   = note: ...so that the types are compatible:\n           expected &amp;&amp;Point&lt;'_&gt;\n              found &amp;&amp;Point&lt;'a&gt;\nnote: but, the lifetime must be valid for the lifetime 'a as defined on the impl at 11:1...\n  --&gt; src/main.rs:11:1\n   |\n11 | impl&lt;'a&gt; Point&lt;'a&gt; {\n   | ^^^^^^^^^^^^^^^^^^\nnote: ...so that return value is valid for the call\n  --&gt; src/main.rs:12:32\n   |\n12 |     pub fn neighbors(&amp;self) -&gt; impl Iterator&lt;Item = Point&lt;'a&gt;&gt; {\n   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>I'm a bit lost as to why this is the case though, because it seems like the lifetimes here make sense. A <code>Point</code>'s lifetime is caused by the lifetime of the reference to the <code>Board</code>. Thus, a <code>Point&lt;'a&gt;</code> has a reference to a board with lifetime <code>'a</code> so it should be able to create more <code>Point&lt;'a&gt;</code>s because their board references will have the same lifetime (<code>'a</code>).</p>\n\n<p>But, if I remove the lambda, it works:</p>\n\n<pre><code>impl&lt;'a&gt; Point&lt;'a&gt; {\n    pub fn neighbors(&amp;self) -&gt; [Point&lt;'a&gt;; 4] {\n        [\n            Point { board: self.board, x: self.x    , y: self.y - 1},\n            Point { board: self.board, x: self.x - 1, y: self.y    },\n            Point { board: self.board, x: self.x + 1, y: self.y    },\n            Point { board: self.board, x: self.x    , y: self.y + 1},\n        ]\n    }\n}\n</code></pre>\n\n<p>So, I suspect the problem lies in the fact that the lambda may be run after the lifetime <code>'a</code> ends. But, does this mean that I can't lazily produce these points?</p>\n\n<p>tl;dr How do I make the borrow checker happy with a method that lazily creates new structs whose lifetimes are tied to the struct creating them?</p>\n"}, {"tags": ["collections", "rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526351715, "post_id": 50340873, "comment_id": 87699123, "body": "Can you share the usecase with us ? I quite curious ;)"}, {"owner": {"reputation": 43, "user_id": 9791349, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/g7njy.jpg?s=128&g=1", "display_name": "MasterWindu", "link": "https://stackoverflow.com/users/9791349/masterwindu"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526408446, "post_id": 50340873, "comment_id": 87730111, "body": "@Stargateur: I am trying to build a replicate physical changes to a large data-structure backed by a logical array. I would like to keep track of changed ranges so that I can send efficient delta updates. The replication is not realtime but async and lazy; if a sub-range has changed multiple times I don&#39;t want to send every change, just the minimum set to replicate the difference. The reason I need an exclusive search is to be able to efficiently coalesce adjacent modified ranges."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526410259, "post_id": 50340873, "comment_id": 87731072, "body": "Thank, for the use case, I was wondering, <a href=\"https://play.rust-lang.org/?gist=fc5bcd805f7ef9a448402f7d7231d0a7&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">this</a> would not be more effective ? Don&#39;t hesitate to come in the <a href=\"https://chat.stackoverflow.com/rooms/62927/rust\">chat</a>"}, {"owner": {"reputation": 43, "user_id": 9791349, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/g7njy.jpg?s=128&g=1", "display_name": "MasterWindu", "link": "https://stackoverflow.com/users/9791349/masterwindu"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526414946, "post_id": 50340873, "comment_id": 87733404, "body": "@Stargateur: I don&#39;t have enough points to join the chat yet. Thanks for the idea, I think my underlying problem is actually more complicated than the question I have distilled it down to. These data-structures and change-sets are not small (100+ GiB) memory efficiency is important here. Given a sequence of operations like: write(objId, pos0, size0); write(objId, pos1, size1); write(objId, pos2, size2)... I need to perdiocally generate the minimum set of write operations that represents the delta, coalescing overwrites to minimize network usage. A bitmap is the other obvious alternative."}], "answers": [{"comments": [{"owner": {"reputation": 43, "user_id": 9791349, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/g7njy.jpg?s=128&g=1", "display_name": "MasterWindu", "link": "https://stackoverflow.com/users/9791349/masterwindu"}, "edited": false, "score": 1, "creation_date": 1526408886, "post_id": 50341351, "comment_id": 87730337, "body": "Thanks for the link to the PR. I&#39;m new to Rust and am still building a sense of how to build a good Rust API, I can comment on use-cases if that helps the discussion. Coming from C++ it seems like the BTree{Map, Set} lack a bi-directional iterator (or Cursor as also commonly referred to). I can not think of a way to do this in Java that does not involve two searches. The issue is more acute in the case of large trees that involve keys that are expensive to compare."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1526350211, "creation_date": 1526350211, "answer_id": 50341351, "question_id": 50340873, "link": "https://stackoverflow.com/questions/50340873/find-greater-and-lower-keys-in-a-btreeset-in-a-single-search/50341351#50341351", "title": "Find greater and lower keys in a BTreeSet in a single search", "body": "<p>No, there is no way to do this in a single search; <a href=\"https://stackoverflow.com/a/50341316/155423\">you need to call <code>range</code> twice</a>. </p>\n\n<p>There have been discussions about enhancing <code>BTreeMap</code> / <code>BTreeSet</code> to have a \"cursor\" API. Recently, <a href=\"https://github.com/rust-lang/rust/pull/47228\" rel=\"nofollow noreferrer\">a pull request was opened to do so</a>, but it was closed because it was deemed that there should be more discussion about how such an API should look and work.</p>\n\n<p>Perhaps <em>you</em> will be the one to spearhead the discussion about such an API?</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/48575866/155423\">How to get the lower bound and upper bound of an element in Rust BTreeSet?</a></li>\n</ul>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526400235, "post_id": 50354001, "comment_id": 87725574, "body": "Won&#39;t this change what should be an <code>O(log N)</code> operation into <code>O(N)</code>?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526400484, "post_id": 50354001, "comment_id": 87725717, "body": "@Shepmaster That&#39;s true. I didn&#39;t see that aspect."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 0, "last_activity_date": 1526398133, "creation_date": 1526398133, "answer_id": 50354001, "question_id": 50340873, "link": "https://stackoverflow.com/questions/50340873/find-greater-and-lower-keys-in-a-btreeset-in-a-single-search/50354001#50354001", "title": "Find greater and lower keys in a BTreeSet in a single search", "body": "<p>There is not a cursor API in Rust, as said in Shepmaster's answer. You can sometimes simulate it when your iterator implements <code>DoubleEndedIterator</code> with <code>next()</code> and <code>next_back()</code>.</p>\n\n<p>However, if I understand well what you are trying to do, you do not need this stuff because a set is ordered. You can write your code by going through each pair and stop when the second item is greater than your \"point\":</p>\n\n<pre><code>use std::collections::BTreeSet;\n\nfn find_bounds&lt;'a&gt;(set: &amp;'a BTreeSet&lt;&amp;str&gt;, point: &amp;str) -&gt; (Option&lt;&amp;'a str&gt;, Option&lt;&amp;'a str&gt;) {\n    let mut it = set.iter();\n    let mut lower = match it.next() {\n        None =&gt; return (None, None),\n        Some(s) if *s &gt; point =&gt; return (None, Some(s)),\n        Some(s) =&gt; s,\n    };\n\n    while let Some(upper) = it.next() {\n        if *upper &gt; point {\n            return (Some(lower), Some(*upper));\n        }\n        lower = upper;\n    }\n    (Some(lower), None)\n}\n\n#[test]\nfn tests() {\n    let mut s = BTreeSet::new();\n\n    s.insert(\"a\");\n    s.insert(\"c\");\n    s.insert(\"t\");\n    s.insert(\"g\");\n\n    assert_eq!(find_bounds(&amp;s, \"f\"), (Some(\"c\"), Some(\"g\")));\n    assert_eq!(find_bounds(&amp;s, \"z\"), (Some(\"t\"), None));\n    assert_eq!(find_bounds(&amp;s, \" \"), (None, Some(\"a\")));\n}\n</code></pre>\n\n<p>The code is not well written, but it works.</p>\n"}], "owner": {"reputation": 43, "user_id": 9791349, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/g7njy.jpg?s=128&g=1", "display_name": "MasterWindu", "link": "https://stackoverflow.com/users/9791349/masterwindu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 240, "favorite_count": 0, "accepted_answer_id": 50341351, "answer_count": 2, "score": 4, "last_activity_date": 1526407982, "creation_date": 1526345440, "last_edit_date": 1526407982, "question_id": 50340873, "link": "https://stackoverflow.com/questions/50340873/find-greater-and-lower-keys-in-a-btreeset-in-a-single-search", "title": "Find greater and lower keys in a BTreeSet in a single search", "body": "<p>I would like to be able to find keys in a Rust <code>BTreeSet</code> that are strictly lower and greater than a specified key.</p>\n\n<p>For example, given the set <code>{ \"1\", \"3\" }</code>, and the search key is <code>\"2\"</code> then the answer should be (<code>\"1\"</code>, <code>\"3\"</code>). In the cases either where either  lower or greater value does not exist <code>None</code> should be returned.</p>\n\n<p>I can achieve the result that I am looking for by calling the <code>range()</code> method on the <code>BTreeSet</code> twice. </p>\n\n<p>Is there is a way to do this using a single search, like there is in C++? C++'s <code>std::set</code> has a bi-directional iterator:</p>\n\n<pre><code>// $CXX -std=c++17 less-than.c++ -o less-than &amp;&amp; ./less-than\n\n#include &lt;cassert&gt;\n#include &lt;optional&gt;\n#include &lt;set&gt;\n#include &lt;string&gt;\n#include &lt;iostream&gt;\n\nusing std::optional;\nusing std::pair;\nusing std::set;\nusing std::string;\n\npair&lt;optional&lt;string&gt;, optional&lt;string&gt;&gt; bounding_box(\n    const set&lt;string&gt;&amp; space,\n    const string&amp; point)\n{\n    if (space.empty()) { return {}; }\n\n    optional&lt;string&gt; gt_bound;\n    optional&lt;string&gt; lt_bound;\n\n    const auto ge_bound_it = space.lower_bound(point);\n\n    if (ge_bound_it != space.end()) {\n        if (*ge_bound_it == point) {\n            // lower_bound returned an equal point, use the next one\n            // if it exists\n            const auto gt_bound_it = std::next(ge_bound_it, 1);\n\n            if (gt_bound_it != space.end()) {\n                gt_bound = *gt_bound_it;\n            }\n        } else {\n            gt_bound = *ge_bound_it;\n        }\n\n    }\n\n    if (ge_bound_it != space.begin()) {\n        lt_bound = *std::next(ge_bound_it, -1);\n    }\n\n    return {lt_bound, gt_bound};\n}\n\nint main() {\n    {\n        const auto box = bounding_box({\"1\", \"3\"}, \"2\");\n        assert(box.first);\n        assert(*box.first == \"1\");\n\n        assert(box.second);\n        assert(*box.second == \"3\");\n    }\n\n    {\n        const auto box = bounding_box({\"1\", \"3\"}, \"4\");\n        assert(box.first);\n        assert(*box.first == \"3\");\n\n        assert(!box.second);\n    }\n\n    {\n        const auto box = bounding_box({\"1\", \"3\"}, \"0\");\n        assert(!box.first);\n\n        assert(box.second);\n        assert(*box.second == \"1\");\n    }\n\n    {\n        const auto box = bounding_box({\"3\", \"3\"}, \"3\");\n        assert(!box.first);\n        assert(!box.second);\n    }\n\n    {\n        const auto box = bounding_box({\"3\", \"4\"}, \"3\");\n        assert(!box.first);\n        assert(box.second);\n        assert(*box.second == \"4\");\n    }\n\n    {\n        const auto box = bounding_box({}, \"3\");\n        assert(!box.first);\n        assert(!box.second);\n    }\n}\n</code></pre>\n\n<p>The <code>search</code> method is a bit of a hot spot and I wonder if there is an idiomatic way to do this in Rust.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 251753, "user_id": 129570, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/aa98a2c5baceef5ffcaf95fdde12b8fb?s=128&d=identicon&r=PG", "display_name": "Oliver Charlesworth", "link": "https://stackoverflow.com/users/129570/oliver-charlesworth"}, "edited": false, "score": 4, "creation_date": 1526337488, "post_id": 50339943, "comment_id": 87696168, "body": "From the docs: &quot;Inserts an element at position index within the vector, shifting all elements after position i one position to the right.&quot;"}, {"owner": {"reputation": 94277, "user_id": 282848, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/ced1d4c4fa1cd38d87553bf0e4836120?s=128&d=identicon&r=PG", "display_name": "Andreas Rejbrand", "link": "https://stackoverflow.com/users/282848/andreas-rejbrand"}, "edited": false, "score": 0, "creation_date": 1526337519, "post_id": 50339943, "comment_id": 87696179, "body": "So O(n), then..."}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1526338394, "post_id": 50339943, "comment_id": 87696411, "body": "\u201ca VERY large vector which has billions of elements\u201d oh my! You might want to look at other data structures."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 6, "last_activity_date": 1526340134, "last_edit_date": 1526340134, "creation_date": 1526337918, "answer_id": 50340022, "question_id": 50339943, "link": "https://stackoverflow.com/questions/50339943/whats-the-complexity-of-inserting-to-a-vector-in-rust/50340022#50340022", "title": "What&#39;s the complexity of inserting to a vector in Rust?", "body": "<p><a href=\"https://doc.rust-lang.org/std/collections/index.html#sequences\" rel=\"noreferrer\">The documentation lists the complexities for all the standard collections and operations</a>:</p>\n\n<blockquote>\n  <p>Throughout the documentation, we will follow a few conventions. For\n  all operations, the collection's size is denoted by <code>n</code>. If another\n  collection is involved in the operation, it contains <code>m</code> elements.\n  Operations which have an amortized cost are suffixed with a <code>*</code>.\n  Operations with an expected cost are suffixed with a <code>~</code>.</p>\n  \n  <pre class=\"lang-none prettyprint-override\"><code>      get(i)  insert(i)   remove(i)   append  split_off(i)\nVec   O(1)    O(n-i)*     O(n-i)      O(m)*   O(n-i)\n</code></pre>\n</blockquote>\n\n<p>The documentation for <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.insert\" rel=\"noreferrer\"><code>Vec::insert</code></a> explains details, emphasis mine:</p>\n\n<blockquote>\n  <p>Inserts an element at position <code>index</code> within the vector, <strong>shifting all elements after it to the right</strong>.</p>\n</blockquote>\n\n\n\n<blockquote>\n  <p>How efficient is it to insert an element at the start of a VERY large vector which has billions of elements?</p>\n</blockquote>\n\n<p>A VERY bad idea, as everything needs to be moved. Perhaps a <a href=\"https://doc.rust-lang.org/std/collections/struct.VecDeque.html\" rel=\"noreferrer\"><code>VecDeque</code></a> would be better (or finding a different algorithm).</p>\n"}, {"tags": [], "owner": {"reputation": 775, "user_id": 3604955, "user_type": "registered", "accept_rate": 67, "profile_image": "https://i.stack.imgur.com/oMAdr.jpg?s=128&g=1", "display_name": "kaiser", "link": "https://stackoverflow.com/users/3604955/kaiser"}, "is_accepted": false, "score": 0, "last_activity_date": 1586329861, "creation_date": 1586329861, "answer_id": 61095122, "question_id": 50339943, "link": "https://stackoverflow.com/questions/50339943/whats-the-complexity-of-inserting-to-a-vector-in-rust/61095122#61095122", "title": "What&#39;s the complexity of inserting to a vector in Rust?", "body": "<p>Found this question and need to add a thing.</p>\n\n<p>It all depends on your usage. If you're inserting once, it's maybe worth to accept that O(n). If you then do millions of get requests with O(1).</p>\n\n<p>Other datatypes maybe have better insertion time but have O(log(n)) or even O(N) for getting items. </p>\n\n<p>Next thing is iteration where cache friendlyness comes into play for such large arrays, where Vector is perfect.</p>\n\n<p>May advice: if you're inserting once and then do lot of requests, stay with Vec.\nIf inserting and removing is your main task, like a queue, go for something else.</p>\n\n<p>I often found myself in some situation where I need sorted arrays and then go for something like Btreemap, or BTreeSet. I removed them completely and used a Vec now, where after adding all values, I do a sort and a dedup.</p>\n"}], "owner": {"reputation": 291, "user_id": 9143626, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/43746df168c59ad554c770f60b805fa3?s=128&d=identicon&r=PG&f=1", "display_name": "Allen Lee", "link": "https://stackoverflow.com/users/9143626/allen-lee"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1404, "favorite_count": 0, "accepted_answer_id": 50340022, "answer_count": 2, "score": 0, "last_activity_date": 1586329861, "creation_date": 1526337307, "last_edit_date": 1526337991, "question_id": 50339943, "link": "https://stackoverflow.com/questions/50339943/whats-the-complexity-of-inserting-to-a-vector-in-rust", "title": "What&#39;s the complexity of inserting to a vector in Rust?", "body": "<p>How does <a href=\"https://doc.rust-lang.org/src/alloc/vec.rs.html#833-856\" rel=\"nofollow noreferrer\"><code>insert</code></a> work in a Rust <code>Vec</code>? How efficient is it to insert an element at the start of a <strong>VERY</strong> large vector which has billions of elements?</p>\n"}, {"tags": ["static", "rust"], "answers": [{"comments": [{"owner": {"reputation": 78, "user_id": 2468852, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/185d1ca8085923c08d5a74be959f643d?s=128&d=identicon&r=PG", "display_name": "user2468852", "link": "https://stackoverflow.com/users/2468852/user2468852"}, "edited": false, "score": 0, "creation_date": 1554921400, "post_id": 50339441, "comment_id": 97931650, "body": "In case you&#39;re using the <code>dbg!</code> macro, you might need <code>&amp;*LAND_POLYGONS</code> since it doesn&#39;t automatically borrow its argument like <code>println!</code> does."}, {"owner": {"reputation": 4491, "user_id": 1264974, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/6558cf06df3ccf1c49329f38fd843b7d?s=128&d=identicon&r=PG", "display_name": "justinas", "link": "https://stackoverflow.com/users/1264974/justinas"}, "reply_to_user": {"reputation": 78, "user_id": 2468852, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/185d1ca8085923c08d5a74be959f643d?s=128&d=identicon&r=PG", "display_name": "user2468852", "link": "https://stackoverflow.com/users/2468852/user2468852"}, "edited": false, "score": 0, "creation_date": 1554987393, "post_id": 50339441, "comment_id": 97957123, "body": "Wouldn&#39;t <code>&amp;*LAND_POLYGONS</code> result in a <code>&amp;&amp;MultiPolygon&lt;f64&gt;</code>, seeing how <code>deref()</code> returns a reference already?"}], "tags": [], "owner": {"reputation": 4491, "user_id": 1264974, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/6558cf06df3ccf1c49329f38fd843b7d?s=128&d=identicon&r=PG", "display_name": "justinas", "link": "https://stackoverflow.com/users/1264974/justinas"}, "is_accepted": true, "score": 5, "last_activity_date": 1526334127, "creation_date": 1526334127, "answer_id": 50339441, "question_id": 50339314, "link": "https://stackoverflow.com/questions/50339314/giving-a-lazy-static-its-proper-type-in-rust/50339441#50339441", "title": "Giving a lazy_static its proper type in Rust", "body": "<p>Under the hood, lazy_static generates a one-off struct type with a <code>Deref</code> implementation which gives you a reference to the actual value of the type you have specified.</p>\n\n<p>Change your <code>println</code> statement to this:</p>\n\n<pre><code>println!(\"{:?}\", *LAND_POLYGONS);\n</code></pre>\n"}], "owner": {"reputation": 15633, "user_id": 2091169, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/MT8tZ.jpg?s=128&g=1", "display_name": "Jivan", "link": "https://stackoverflow.com/users/2091169/jivan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1174, "favorite_count": 1, "closed_date": 1526335326, "accepted_answer_id": 50339441, "answer_count": 1, "score": 0, "last_activity_date": 1526334127, "creation_date": 1526333485, "last_edit_date": 1526333862, "question_id": 50339314, "link": "https://stackoverflow.com/questions/50339314/giving-a-lazy-static-its-proper-type-in-rust", "closed_reason": "Duplicate", "title": "Giving a lazy_static its proper type in Rust", "body": "<p>I have this file <code>utils.rs</code> declaring a <code>lazy_static</code> like below:</p>\n\n<pre><code>extern crate geojson;\nextern crate geo;\n\nuse self::geo::MultiPolygon;\nuse self::geojson::GeoJson;\nuse self::geojson::conversion::TryInto;\n\nlazy_static! {\n    pub static ref LAND_POLYGONS: MultiPolygon&lt;f64&gt; = {\n        let input_string = include_str!(\"resources/land.geojson\");\n        let mut polygons: Vec&lt;Polygon&lt;f64&gt;&gt; = vec![];\n        // ...\n        // add some polygons here\n        // ...\n        MultiPolygon(polygons)\n    };\n}\n</code></pre>\n\n<p>Then in <code>main.rs</code> I try to use <code>LAND_POLYGONS</code> as follows:</p>\n\n<pre><code>#[macro_use]\nextern crate lazy_static;\n\nextern crate geo;\n\nuse self::geo::MultiPolygon;\nuse utils::LAND_POLYGONS;\n\nfn main() -&gt; Result&lt;(), Box&lt;Error&gt;&gt; {\n    lazy_static::initialize(&amp;LAND_POLYGONS);\n    println!(\"{:?}\", LAND_POLYGONS);\n\n    Ok(())\n}\n</code></pre>\n\n<p>Which produces the following compiler error:</p>\n\n<pre><code>error[E0277]: `utils::LAND_POLYGONS` doesn't implement `std::fmt::Debug`\n  --&gt; src/main.rs:30:22\n   |\n30 |     println!(\"{:?}\", LAND_POLYGONS);\n   |                      ^^^^^^^^^^^^^ `utils::LAND_POLYGONS` cannot be formatted using `:?`; add `#[derive(Debug)]` or manually implement `std::fmt::Debug`\n   |\n   = help: the trait `std::fmt::Debug` is not implemented for `utils::LAND_POLYGONS`\n   = note: required by `std::fmt::Debug::fmt`\n</code></pre>\n\n<p>It seems that <code>LAND_POLYGONS</code> is loaded as an instance of its own type.</p>\n\n<p>How to give <code>LAND_POLYGONS</code> its proper type, being a <code>geo::MultiPolygon</code> instead? As a side note, <code>MultiPolygon</code> does indeed definitely implement <code>Debug</code>.</p>\n\n<p>The <code>lazy_static</code> documentation and examples make it look like this would already be the case without anything special to do.</p>\n\n<p><em>Note: when putting all the above into one single <code>main.rs</code> file, the result is the same.</em></p>\n"}, {"tags": ["windows", "linker", "rust"], "comments": [{"owner": {"reputation": 1410, "user_id": 5827450, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-r3ocQbM_fgs/AAAAAAAAAAI/AAAAAAAAAAw/R48S5OAnokw/photo.jpg?sz=128", "display_name": "Charlie \u6728\u5320", "link": "https://stackoverflow.com/users/5827450/charlie-%e6%9c%a8%e5%8c%a0"}, "edited": false, "score": 0, "creation_date": 1590536303, "post_id": 50337099, "comment_id": 109715395, "body": "linked question. <a href=\"https://stackoverflow.com/questions/59171127/link-exe-not-found-error-while-running-on-windows-system-for-rust-program-is-vi\" title=\"link exe not found error while running on windows system for rust program is vi\">stackoverflow.com/questions/59171127/&hellip;</a>"}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526324963, "post_id": 50337100, "comment_id": 87690996, "body": "visual studio is not primary dev for C++, you need to check some option."}, {"owner": {"reputation": 270, "user_id": 7351717, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/GEvRh.png?s=128&g=1", "display_name": "Hydraxan14", "link": "https://stackoverflow.com/users/7351717/hydraxan14"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526325774, "post_id": 50337100, "comment_id": 87691396, "body": "@Stargateur I don&#39;t understand your comment."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526326165, "post_id": 50337100, "comment_id": 87691594, "body": "To install c++ redistributable visual studio has an option in the installer"}], "tags": [], "owner": {"reputation": 270, "user_id": 7351717, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/GEvRh.png?s=128&g=1", "display_name": "Hydraxan14", "link": "https://stackoverflow.com/users/7351717/hydraxan14"}, "is_accepted": true, "score": 3, "last_activity_date": 1526486102, "last_edit_date": 1526486102, "creation_date": 1526323785, "answer_id": 50337100, "question_id": 50337099, "link": "https://stackoverflow.com/questions/50337099/cargo-build-fails-with-linking-error-link-exe-failed-exit-code-325595/50337100#50337100", "title": "`cargo build` fails with linking error &quot;link.exe failed: exit code: 325595&quot;", "body": "<p>After downloading the latest 64-bit runtime <a href=\"https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads\" rel=\"nofollow noreferrer\">Visual C++ Redistributable for Visual Studio 2017</a>, <code>link.exe</code> works on my Windows 7 computer.  I can now compile my Rust project.</p>\n\n<p>I'm surprised that the Visual Studio Installer doesn't ensure that the necessary runtime components are installed for the 2015 toolset.</p>\n\n<hr>\n\n<p><strong>Update:</strong> <a href=\"https://stackoverflow.com/users/7076153/stargateur\">Stargateur</a> pointed out that the Redistributable can be installed directly from the Visual Studio Installer.\nIt is the <code>Visual C++ 2017 Redistributable Update</code> individual component.</p>\n"}], "owner": {"reputation": 270, "user_id": 7351717, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/GEvRh.png?s=128&g=1", "display_name": "Hydraxan14", "link": "https://stackoverflow.com/users/7351717/hydraxan14"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 5303, "favorite_count": 0, "accepted_answer_id": 50337100, "answer_count": 1, "score": 0, "last_activity_date": 1526486102, "creation_date": 1526323785, "last_edit_date": 1526324322, "question_id": 50337099, "link": "https://stackoverflow.com/questions/50337099/cargo-build-fails-with-linking-error-link-exe-failed-exit-code-325595", "title": "`cargo build` fails with linking error &quot;link.exe failed: exit code: 325595&quot;", "body": "<p>I have a Rust project that compiles okay on Linux, macOS, and Windows 10.</p>\n\n<p>I installed the following individual components on my Windows 7 computer today using the <a href=\"https://www.visualstudio.com/downloads/#build-tools-for-visual-studio-2017\" rel=\"nofollow noreferrer\">Visual Studio Installer</a>:</p>\n\n<ul>\n<li><code>VC++ 2015.3 v14.00 (v140) toolset for desktop</code>\n\n<ul>\n<li><code>Windows Universal CRT SDK</code> (Dependency)</li>\n<li><code>Windows 8.1 SDK</code> (Dependency)</li>\n</ul></li>\n</ul>\n\n<p>After that, I installed Rust using a fresh <code>rustup-init.exe</code> from the <a href=\"https://www.rust-lang.org/en-US/install.html\" rel=\"nofollow noreferrer\">official website</a>.</p>\n\n<p>When I run <code>cargo build</code> on my Rust project on the Windows 7 computer, it fails with the following message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: linking with `C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\bin\\amd64\\link.exe\\` failed: exit code: 325595.\n</code></pre>\n\n<hr>\n\n<p>Running <code>C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\bin\\amd64\\link.exe</code> all on its own with no arguments on my Windows 10 computer produces some \"help\" information, but on my Windows 7 computer, I get a window with the error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>The application was unable to start correctly (0xc000007b).  Click Ok to close the application.\n</code></pre>\n\n<hr>\n\n<p>My Google-Fu hasn't turned up any useful information.  I've tried:</p>\n\n<ul>\n<li><code>sfc /scannow</code></li>\n<li>ensure System32 doesn't have 32-bit DLLs</li>\n<li>ensure SysWOW64 doesn't have 64-bit DLLs</li>\n</ul>\n"}, {"tags": ["static", "rust"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526319581, "post_id": 50336012, "comment_id": 87688270, "body": "You could use <a href=\"https://docs.rs/lazy_static/1.0.0/lazy_static/\" rel=\"nofollow noreferrer\">lazy_static</a> perhaps. But it really depends on what problems you are trying to solve - a &quot;complex long-lived immutable object&quot; isn&#39;t itself a problem, and global variables are an anti-pattern, that can usually be avoided. So it would be useful to know what are the problems that need to be solved."}, {"owner": {"reputation": 15633, "user_id": 2091169, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/MT8tZ.jpg?s=128&g=1", "display_name": "Jivan", "link": "https://stackoverflow.com/users/2091169/jivan"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526319883, "post_id": 50336012, "comment_id": 87688423, "body": "Well, basically, the exact problem stated in the question. As in, how to declare a static complex object like the one mentioned in the example, so that it can be further used from anywhere in the application, with no need to compute it again. Looks like <code>lazy_static</code> is the way to go."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526320502, "post_id": 50336012, "comment_id": 87688723, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/27791532/155423\">How do I create a global, mutable singleton?</a> and <a href=\"https://stackoverflow.com/q/27221504/155423\">How can you make a safe static singleton in Rust?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50336012/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 15633, "user_id": 2091169, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/MT8tZ.jpg?s=128&g=1", "display_name": "Jivan", "link": "https://stackoverflow.com/users/2091169/jivan"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526320672, "post_id": 50336012, "comment_id": 87688813, "body": "@Shepmaster looks like the second one (safe static singleton) is answering it perfectly."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526320744, "post_id": 50336012, "comment_id": 87688841, "body": "Food for thought: how does Scala handle your code in the presence of multiple threads?"}], "owner": {"reputation": 15633, "user_id": 2091169, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/MT8tZ.jpg?s=128&g=1", "display_name": "Jivan", "link": "https://stackoverflow.com/users/2091169/jivan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 37, "favorite_count": 0, "closed_date": 1526320710, "answer_count": 0, "score": 1, "last_activity_date": 1526320629, "creation_date": 1526319314, "last_edit_date": 1526320629, "question_id": 50336012, "link": "https://stackoverflow.com/questions/50336012/what-is-the-most-adequate-pattern-for-immutable-objects-that-are-computed-once-t", "closed_reason": "Duplicate", "title": "What is the most adequate pattern for immutable objects that are computed once then usable anywhere in the application?", "body": "<p>Coming from a Scala background, a typical way of storing complex long lived immutable objects (like a big GeoJson <code>MultiPolygon</code> loaded from a file) would be the following:</p>\n\n<pre class=\"lang-scala prettyprint-override\"><code>// in Helpers.scala\npackage helpers\n\nobject Helpers {\n  val landPolygons = loadFromGeoJsonFile(\"land-polygons.geojson\")\n  val mountains = loadFromGeoJsonFile(\"mountains.geojson\")\n}\n\n// and anywhere else in the app\nimport helpers.Helpers._\n\ndef myAwesomeFunc() = {\n  val myPoint = Point(23.0, 56.0)\n  val distFromLand = myPoint.distance(landPolygons)\n  val distFromMountains = myPoint.distance(mountains)\n}\n</code></pre>\n\n<p>What would be the most adequate pattern to achieve the same functionality in Rust? The idea is that the values <code>landPolygons</code> and <code>mountains</code> have to be computed only once, and then available to use from anywhere in the whole application.</p>\n\n<p>When trying to use a <code>const</code> or <code>static</code> declaration, the compiler outputs the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0015]: calls in constants are limited to struct and enum constructors\n  --&gt; src/utils.rs:30:32\n   |\n30 | const LAND_POLYGONS: GeoJson = include_str!(\"resources/land.geojson\").parse::&lt;GeoJson&gt;().unwrap();\n   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   |\nnote: a limited form of compile-time function evaluation is available on a nightly compiler via `const fn`\n  --&gt; src/utils.rs:30:32\n   |\n30 | const LAND_POLYGONS: GeoJson = include_str!(\"resources/land.geojson\").parse::&lt;GeoJson&gt;().unwrap();\n   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n"}, {"tags": ["generics", "rust", "iterator", "traits", "associated-types"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1526310476, "post_id": 50333526, "comment_id": 87683338, "body": "The output type of an Iterator is not it&#39;s type parameter, but rather its <code>Item</code> associated type."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1526310516, "post_id": 50333526, "comment_id": 87683375, "body": "You confuse the generic parameter of the <code>Iterator</code> (<code>P</code>) with its <code>Item</code> associated type."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 3, "last_activity_date": 1526314964, "last_edit_date": 1526314964, "creation_date": 1526311122, "answer_id": 50333806, "question_id": 50333526, "link": "https://stackoverflow.com/questions/50333526/why-does-the-split-type-only-return-str-even-though-pattern-has-implementations/50333806#50333806", "title": "Why does the Split type only return &amp;str even though Pattern has implementations for both &amp;str and char?", "body": "<blockquote>\n  <p>The type has an implementation for <code>Iterator&lt;'a, P&gt;</code></p>\n</blockquote>\n\n<p>It doesn't. It's just <code>Iterator</code>, which has no type parameters. Every implementation of <code>Iterator</code> must declare the type of the item that it iterates over using an associated type. For example, <code>Split</code>'s implementation<sup>[1]</sup> is something like this:</p>\n\n<pre><code>impl &lt;'a, P&gt; Iterator for Split&lt;'a, P&gt; {\n    type Item = &amp;'a str;\n    fn next(&amp;mut self) -&gt; Option&lt;&amp;'a str&gt; { ... }\n}\n</code></pre>\n\n<blockquote>\n  <p>Why isn't the <code>Split</code> type simply defined as <code>Split&lt;'a, &amp;'a str&gt;</code>, since it is effectively an <code>Iterator</code> over <code>&amp;str</code>s? </p>\n</blockquote>\n\n<p>Because iterators are lazy. The <code>Split</code> struct still needs to know about the pattern in order to match the next item. Its iterator instance has <code>Item = &amp;str</code>, because that is what it iterates over.</p>\n\n<hr>\n\n<p><em><sup>[1]</sup>The actual implementation is <a href=\"https://doc.rust-lang.org/src/core/str/mod.rs.html#957-964\" rel=\"nofollow noreferrer\">generated by a macro</a>.</em></p>\n"}], "owner": {"reputation": 283, "user_id": 1849748, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/e91bda00316cdf3a4af9d974eb5f32f6?s=128&d=identicon&r=PG", "display_name": "rrrrrrrrrrrrrrrr", "link": "https://stackoverflow.com/users/1849748/rrrrrrrrrrrrrrrr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 88, "favorite_count": 0, "accepted_answer_id": 50333806, "answer_count": 1, "score": 2, "last_activity_date": 1551013233, "creation_date": 1526310215, "last_edit_date": 1551013233, "question_id": 50333526, "link": "https://stackoverflow.com/questions/50333526/why-does-the-split-type-only-return-str-even-though-pattern-has-implementations", "title": "Why does the Split type only return &amp;str even though Pattern has implementations for both &amp;str and char?", "body": "<p>I'm having a hard time understanding how the <code>Split</code> type works in Rust.</p>\n\n<p><code>Split&lt;'a, P&gt; where P: Pattern&lt;'a&gt;</code> is the type returned by the <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.split\" rel=\"nofollow noreferrer\"><code>std::string::String::split</code></a> method. The type has an implementation for <code>Iterator&lt;'a, P&gt;</code>, where <code>P</code> is still the <code>Pattern</code> type, but in reality (and as I would expect) the <code>Iterator</code> only returns <code>&amp;str</code> slices.</p>\n\n<p>E.g., <code>split(p).collect::&lt;Vec&lt;&amp;str&gt;&gt;()</code> works but <code>split(p).collect::&lt;Vec&lt;char&gt;&gt;()</code> results a compiler error. This is what I would expect to happen, but I don't understand how it happens since <code>Pattern</code> has implementations for both <code>&amp;str</code> and <code>char</code>.</p>\n\n<p>Why isn't the <code>Split</code> type simply defined as <code>Split&lt;'a, &amp;'a str&gt;</code>, since it is effectively an <code>Iterator</code> over <code>&amp;str</code>s? Why does it behave as if it is effectively defined as that?</p>\n"}, {"tags": ["enums", "rust"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1526309466, "post_id": 50332954, "comment_id": 87682607, "body": "Related: <a href=\"https://stackoverflow.com/a/32712140/4498831\">stackoverflow.com/a/32712140/4498831</a>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1526309472, "post_id": 50332954, "comment_id": 87682613, "body": "It can never return <code>str</code> because that hasn&#39;t got a size. It would need to be <code>String</code> or <code>&amp;str</code>."}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 1, "creation_date": 1526309567, "post_id": 50332954, "comment_id": 87682680, "body": "<i>Do not use <code>transmute</code> like this!</i>  This is wildly unsafe, and can trivially cause undefined behaviour.  Enums in Rust <i>are not</i> like enums in C: they <b>must not</b> have tag values not defined by the compiler.  If you don&#39;t completely understand the rules on unsafe coding in Rust, you should not be using <code>unsafe</code> code."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526309637, "post_id": 50332954, "comment_id": 87682728, "body": "@2080 This is going to blow up if that <code>t</code> is out of range. You will be much better off to use a <code>match</code> statement and handle each case."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1526309681, "post_id": 50332954, "comment_id": 87682750, "body": "Alternatively, you can have a macro generate your <code>enum</code> in the first place, and create a <code>to_str</code> method at the same time."}, {"owner": {"reputation": 721, "user_id": 9779026, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/304c70070e68a9c799518d2cdee4d138?s=128&d=identicon&r=PG", "display_name": "2080", "link": "https://stackoverflow.com/users/9779026/2080"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526309739, "post_id": 50332954, "comment_id": 87682797, "body": "@PeterHall This seems pretty verbose, an assert/range check before the transmute call might be sufficient"}], "answers": [{"comments": [{"owner": {"reputation": 721, "user_id": 9779026, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/304c70070e68a9c799518d2cdee4d138?s=128&d=identicon&r=PG", "display_name": "2080", "link": "https://stackoverflow.com/users/9779026/2080"}, "edited": false, "score": 0, "creation_date": 1526310642, "post_id": 50333614, "comment_id": 87683460, "body": "Why was this downvoted? It works and answers my question."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 4, "creation_date": 1526310677, "post_id": 50333614, "comment_id": 87683485, "body": "There is no guarantee that the representation of an enum starts at 0. Additionally, you are doing no bounds check. This won&#39;t result in a nice error - it may not even cause a panic - it will result in Undefined Behaviour."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1526312858, "post_id": 50333614, "comment_id": 87684838, "body": "This code causes a segfault when <a href=\"https://play.rust-lang.org/?gist=9e8991984c79fd37520ff2ae3a9e6786&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">run in the playground</a>. <b>This is not safe and should not be used</b>."}, {"owner": {"reputation": 1101, "user_id": 8715470, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Dlyj0.jpg?s=128&g=1", "display_name": "Zarenor", "link": "https://stackoverflow.com/users/8715470/zarenor"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1526320440, "post_id": 50333614, "comment_id": 87688695, "body": "It&#39;s worth noting that the segfault is triggered because, as @PeterHall mentioned, if you are out of bounds, the unsafe won&#39;t care, and do whatever you told it. That&#39;s what trips the segfault: 3 is out-of-bounds, here, the assumed bounds being [0,2]. Since this type of cast is UB for all <code>#[repr(Rust)]</code> enums, it&#39;s only by &#39;luck&#39; that it will work when it is in-bound - Rust doesn&#39;t make that a guarantee. It would, however, be guaranteed behavior for <code>#[repr(C)]</code>  C-like enums, but it would be terrible, brittle code, and bad, awful practice. A <code>match</code> is the way to go, or @Shepmaster&#39;s answer."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1526326221, "post_id": 50333614, "comment_id": 87691620, "body": "Adding <code>#[repr(u8)]</code> to the enum, and changing <code>3</code> to <code>2</code> so the <code>transmute</code> call won&#39;t become out of bounds, is the minimum you need to make this answer correct. Making it <i>safe</i> is another question, but you could do that with range checking in the <code>from</code> function."}], "tags": [], "owner": {"reputation": 721, "user_id": 9779026, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/304c70070e68a9c799518d2cdee4d138?s=128&d=identicon&r=PG", "display_name": "2080", "link": "https://stackoverflow.com/users/9779026/2080"}, "is_accepted": false, "score": -2, "last_activity_date": 1526449307, "last_edit_date": 1526449307, "creation_date": 1526310449, "answer_id": 50333614, "question_id": 50332954, "link": "https://stackoverflow.com/questions/50332954/how-do-i-return-the-string-of-an-enum-at-a-specific-index/50333614#50333614", "title": "How do I return the string of an enum at a specific index?", "body": "<p>It was necessary to add the <code>#[derive(Debug)]</code> attribute and define an implementation on the enum:</p>\n\n<pre><code>#[derive(Debug)]\n#[derive(Copy, Clone)]\nenum E {\n    A,\n    B,\n    C,\n}\n\nimpl E {\n    fn from(t: u8) -&gt; E {\n        assert(t&lt;=enum_to_int(E::C), \"Enum range check failed!\");\n        let el: E = unsafe { std::mem::transmute(t) };\n        return el;\n    }\n    fn to_string(&amp;self) -&gt; String {\n        return format!(\"{:?}\", self);\n    }\n\n    fn string_from_int(t: u8) -&gt; String {\n        return E::from(t).to_string();\n    }\n}\n\n\nfn enum_to_int(el: &amp;E) -&gt; u8 {\n    *el as u8\n}\n</code></pre>\n\n<p>It can then by used like this:</p>\n\n<pre><code>fn main() {\n    let s = E::string_from_int(3 as u8);\n    println!(\"{}\", s);\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 3, "last_activity_date": 1526313586, "last_edit_date": 1526313586, "creation_date": 1526312664, "answer_id": 50334259, "question_id": 50332954, "link": "https://stackoverflow.com/questions/50332954/how-do-i-return-the-string-of-an-enum-at-a-specific-index/50334259#50334259", "title": "How do I return the string of an enum at a specific index?", "body": "<p>You cannot return a <code>str</code>, but you can return a <code>&amp;str</code>. Combine ideas from <a href=\"https://stackoverflow.com/q/28028854/155423\">How do I match enum values with an integer?</a> and <a href=\"https://stackoverflow.com/q/32710187/155423\">Get enum as string</a>:</p>\n\n<pre><code>#[macro_use]\nextern crate strum_macros;\nextern crate strum;\n\nuse strum::IntoEnumIterator;\n\n#[derive(EnumIter, AsRefStr)]\nenum E {\n    A,\n    B,\n    C,\n}\n\nfn main() {\n    let e = E::iter().nth(2);\n    assert_eq!(e.as_ref().map(|e| e.as_ref()), Some(\"C\"));\n}\n</code></pre>\n"}], "owner": {"reputation": 721, "user_id": 9779026, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/304c70070e68a9c799518d2cdee4d138?s=128&d=identicon&r=PG", "display_name": "2080", "link": "https://stackoverflow.com/users/9779026/2080"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 744, "favorite_count": 0, "accepted_answer_id": 50334259, "answer_count": 2, "score": 0, "last_activity_date": 1526449307, "creation_date": 1526308578, "last_edit_date": 1526310457, "question_id": 50332954, "link": "https://stackoverflow.com/questions/50332954/how-do-i-return-the-string-of-an-enum-at-a-specific-index", "title": "How do I return the string of an enum at a specific index?", "body": "<p>What would be the easiest way to achieve this?</p>\n\n<pre><code>enum E {\n    A,\n    B,\n    C,\n}\n\n// Should return \"A\" for 0, \"B\" for 1 and \"C\" for 2\nfn convert(i: u32) -&gt; str {\n    // ???\n}\n</code></pre>\n"}, {"tags": ["string", "rust", "iterator", "text-manipulation"], "answers": [{"tags": [], "owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "is_accepted": false, "score": 6, "last_activity_date": 1526309854, "last_edit_date": 1526309854, "creation_date": 1526300586, "answer_id": 50330231, "question_id": 50330070, "link": "https://stackoverflow.com/questions/50330070/get-the-first-letters-of-words-in-a-sentence/50330231#50330231", "title": "Get the first letters of words in a sentence", "body": "<p>This is a perfect task for Rust's iterators; here's how I would do it:</p>\n\n<pre><code>fn main() {                                                                 \n    let string: &amp;'static str = \"Rust is a fast reliable programming language\";\n\n    let first_letters = string\n        .split_whitespace() // split string into words\n        .map(|word| word // map every word with the following:\n            .chars() // split it into separate characters\n            .next() // pick the first character\n            .unwrap() // take the character out of the Option wrap\n        )\n        .collect::&lt;String&gt;(); // collect the characters into a string\n\n    println!(\"First letters: {}\", first_letters); // First letters: Riafrpl\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 3, "creation_date": 1526300988, "post_id": 50330255, "comment_id": 87676588, "body": "Why do you not use <code>split_whitespace()</code>?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 2, "creation_date": 1526301627, "post_id": 50330255, "comment_id": 87677073, "body": "@Boiethios Because I didn&#39;t think of it! It would also remove the possible panic in ljedrz&#39;s answer."}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1526301728, "post_id": 50330255, "comment_id": 87677147, "body": "@PeterHall true, I forgot it accepts multiple whitespaces!"}, {"owner": {"reputation": 2816, "user_id": 5402030, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/pT1Sp.png?s=128&g=1", "display_name": "MutantOctopus", "link": "https://stackoverflow.com/users/5402030/mutantoctopus"}, "edited": false, "score": 2, "creation_date": 1526304865, "post_id": 50330255, "comment_id": 87679248, "body": "I&#39;ve got to say, using <code>flat_map</code> to take advantage of <code>Option</code>&#39;s <code>IntoIterator</code> functionality is something I never would&#39;ve considered."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 9, "last_activity_date": 1526300667, "creation_date": 1526300667, "answer_id": 50330255, "question_id": 50330070, "link": "https://stackoverflow.com/questions/50330070/get-the-first-letters-of-words-in-a-sentence/50330255#50330255", "title": "Get the first letters of words in a sentence", "body": "<pre><code>let initials: String = string\n    .split(\" \")                     // create an iterator, yielding words\n    .flat_map(|s| s.chars().nth(0)) // get the first char of each word\n    .collect();                     // collect the result into a String\n</code></pre>\n"}], "owner": {"reputation": 41, "user_id": 9788111, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5f4bc0881933580af45335537ff1bd4d?s=128&d=identicon&r=PG&f=1", "display_name": "ysKnok", "link": "https://stackoverflow.com/users/9788111/ysknok"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 658, "favorite_count": 1, "accepted_answer_id": 50330255, "answer_count": 2, "score": 3, "last_activity_date": 1551785719, "creation_date": 1526300120, "last_edit_date": 1551785719, "question_id": 50330070, "link": "https://stackoverflow.com/questions/50330070/get-the-first-letters-of-words-in-a-sentence", "title": "Get the first letters of words in a sentence", "body": "<p>How I could get the first letters from a sentence; example: \"Rust is a fast reliable programming language\" should return the output <code>riafrpl</code>.</p>\n\n<pre><code>fn main() {\n    let string: &amp;'static str = \"Rust is a fast reliable programming language\";\n    println!(\"First letters: {}\", string);\n}\n</code></pre>\n"}, {"tags": ["rust", "rust-diesel"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526318394, "post_id": 50323084, "comment_id": 87687737, "body": "Please review how to provide a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. For Diesel-related questions, <a href=\"https://stackoverflow.com/tags/rust-diesel/info\">see its specific MCVE guidance</a>. Providing the <i>schema</i> is vitally important. You haven&#39;t defined what <code>UserRoleEnum</code> is nor where <code>SystemTime</code> comes from. It&#39;s entirely possible that these fields aren&#39;t even needed, that&#39;s part of making it <i>minimal</i>."}], "answers": [{"comments": [{"owner": {"reputation": 43, "user_id": 3493344, "user_type": "registered", "profile_image": "https://graph.facebook.com/100000333292282/picture?type=large", "display_name": "tandry syawaludin", "link": "https://stackoverflow.com/users/3493344/tandry-syawaludin"}, "edited": false, "score": 0, "creation_date": 1526292481, "post_id": 50324792, "comment_id": 87671368, "body": "actually, the type for optional_data is json in postgres. Do you know what is best type of struct for?"}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "reply_to_user": {"reputation": 43, "user_id": 3493344, "user_type": "registered", "profile_image": "https://graph.facebook.com/100000333292282/picture?type=large", "display_name": "tandry syawaludin", "link": "https://stackoverflow.com/users/3493344/tandry-syawaludin"}, "edited": false, "score": 0, "creation_date": 1526293378, "post_id": 50324792, "comment_id": 87671885, "body": "@tandrysyawaludin I would recommend looking into <a href=\"https://serde.rs/json.html\" rel=\"nofollow noreferrer\">Serde&#39;s JSON capabilities</a>."}, {"owner": {"reputation": 43, "user_id": 3493344, "user_type": "registered", "profile_image": "https://graph.facebook.com/100000333292282/picture?type=large", "display_name": "tandry syawaludin", "link": "https://stackoverflow.com/users/3493344/tandry-syawaludin"}, "edited": false, "score": 0, "creation_date": 1526295314, "post_id": 50324792, "comment_id": 87672986, "body": "what if i wanna unstructured JSON? i mean whatever the structure which posted by user"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1526312668, "post_id": 50324792, "comment_id": 87684713, "body": "&quot;In order to be able to <code>#[derive(X)]</code> for a <code>struct</code>, all its members must implement <code>X</code> as well.&quot; That&#39;s not true. See <a href=\"https://mcarton.github.io/rust-derivative/\" rel=\"nofollow noreferrer\">this crate of mine for an example</a>."}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1526313774, "post_id": 50324792, "comment_id": 87685387, "body": "@mcarton you mean it&#39;s possible with some help from an additional crate, no?"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1526314720, "post_id": 50324792, "comment_id": 87685863, "body": "@ljedrz well, <code>Insertable</code> isn&#39;t a standard trait, so it could just do whatever it wants"}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1526314915, "post_id": 50324792, "comment_id": 87685961, "body": "@mcarton ah, ok; you&#39;re right - I&#39;ll add an extra disclaimer. I&#39;m not experienced with <code>diesel</code>, maybe someone else will be able to confirm it."}, {"owner": {"reputation": 43, "user_id": 3493344, "user_type": "registered", "profile_image": "https://graph.facebook.com/100000333292282/picture?type=large", "display_name": "tandry syawaludin", "link": "https://stackoverflow.com/users/3493344/tandry-syawaludin"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1526348058, "post_id": 50324792, "comment_id": 87698387, "body": "@mcarton and how to set type for unstructured JSON?"}], "tags": [], "owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "is_accepted": true, "score": 0, "last_activity_date": 1526315062, "last_edit_date": 1526315062, "creation_date": 1526281786, "answer_id": 50324792, "question_id": 50323084, "link": "https://stackoverflow.com/questions/50323084/deriveinsertable-is-not-implemented-for-stdstringstring/50324792#50324792", "title": "#[derive(Insertable)] is not implemented for `std::string::String`", "body": "<p>In general, in order to be able to <code>#[derive(X)]</code> for a <code>struct</code>, all its members must implement <code>X</code> as well. This might not be the case with <code>Insertable</code>, because it is not a standard trait, but you might want to verify this; in your case <a href=\"https://docs.rs/diesel/1.2.2/diesel/prelude/trait.Insertable.html\" rel=\"nofollow noreferrer\"><code>Insertable</code></a> is not implemented for the <code>String</code> within <code>optional_data</code>; it is implemented for <code>Option&lt;T&gt;</code>, so the <code>Option</code> enclosing it is not an issue.</p>\n\n<p>You might want to implement <code>Insertable</code> manually; I haven't used <code>diesel</code>, though - there might be a simpler way to do this.</p>\n"}], "owner": {"reputation": 43, "user_id": 3493344, "user_type": "registered", "profile_image": "https://graph.facebook.com/100000333292282/picture?type=large", "display_name": "tandry syawaludin", "link": "https://stackoverflow.com/users/3493344/tandry-syawaludin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1138, "favorite_count": 0, "accepted_answer_id": 50324792, "answer_count": 1, "score": 2, "last_activity_date": 1585213421, "creation_date": 1526271937, "last_edit_date": 1526301216, "question_id": 50323084, "link": "https://stackoverflow.com/questions/50323084/deriveinsertable-is-not-implemented-for-stdstringstring", "title": "#[derive(Insertable)] is not implemented for `std::string::String`", "body": "<p>I get this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>#[derive(Insertable, Queryable, Identifiable, Debug, PartialEq)]\n         ^^^^^^^^^^ the trait `diesel::Expression` is not implemented for `std::string::String`\n</code></pre>\n\n<p>when I try to compile this <code>struct</code>:</p>\n\n<pre><code>#[derive(Insertable, Queryable, Identifiable, Debug, PartialEq)]\n#[table_name = \"example_table\"]\npub struct SigninLog {\n    pub id: i32,\n    pub user_group: UserRoleEnum,\n    pub created_at: Option&lt;SystemTime&gt;,\n    pub optional_data: Option&lt;String&gt;\n}\n</code></pre>\n\n<p>Is it because it contains a custom <code>enum</code> or an <code>Option&lt;String&gt;</code>? And if that is the problem how can I solve it?</p>\n"}, {"tags": ["windows", "rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1526270823, "post_id": 50322817, "comment_id": 87661529, "body": "What should happen for <code>\\\\?\\UNC\\server\\share</code>, and <code>\\\\?\\cat_pics</code> ?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526314167, "post_id": 50322817, "comment_id": 87685612, "body": "<i>Useless</i> is a tad strong, but I agree that it would certainly be overkill to use a regex here."}], "answers": [{"comments": [{"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "edited": false, "score": 0, "creation_date": 1526272934, "post_id": 50323079, "comment_id": 87662022, "body": "I&#39;ve received specific feedback on an internal cli tool that  paths rendered as <code>\\\\?\\c:</code> were confusing and didn&#39;t work when copy pasted into notepad++.. What else can I realistically offer as a solution?"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1526281437, "post_id": 50323079, "comment_id": 87665032, "body": "Sounds like this should get fixed in notepad++ rather than broken every where else, is there an issue opened about this on their tracker?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1526283967, "post_id": 50323079, "comment_id": 87666338, "body": "Funny enough, Notepad++ does support these ;)"}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1526289042, "post_id": 50323079, "comment_id": 87669098, "body": "@hellow It really doesn&#39;t. Try copy and pasting it into the File -&gt; Open dialog in the &#39;File name&#39; text box. It even auto-completes as you type if you type it out by hand, but it still won&#39;t open the file."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1526291072, "post_id": 50323079, "comment_id": 87670453, "body": "Notead++ v7.5.6 (64-bit). What&#39;s your version?"}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1526344211, "post_id": 50323079, "comment_id": 87697706, "body": "@hellow 7.5.4 (32-bit). It doesn&#39;t matter though; ultimately, if my application &#39;doesnt work&#39; because of a bug in another application, it&#39;s still my problem to solve. I can&#39;t just be like &#39;oh, I&#39;ll just lodge a bug with application XXX because that&#39;s a bug&#39;, don&#39;t worry about it. Showing that prefix supposes that <i>every other application and user</i> will correctly handle it and know to copy and paste only the relevant part of it, which is demonstrably false. /shrug"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1526271892, "creation_date": 1526271892, "answer_id": 50323079, "question_id": 50322817, "link": "https://stackoverflow.com/questions/50322817/how-do-i-remove-the-prefix-from-a-canonical-windows-path/50323079#50323079", "title": "How do I remove the \\\\?\\ prefix from a canonical Windows path?", "body": "<p>The straightforward answer is to do platform-specific string munging:</p>\n\n<pre><code>use std::path::{Path, PathBuf};\n\n#[cfg(not(target_os = \"windows\"))]\nfn adjust_canonicalization&lt;P: AsRef&lt;Path&gt;&gt;(p: P) -&gt; String {\n    p.as_ref().display().to_string()\n}\n\n#[cfg(target_os = \"windows\")]\nfn adjust_canonicalization&lt;P: AsRef&lt;Path&gt;&gt;(p: P) -&gt; String {\n    const VERBATIM_PREFIX: &amp;str = r#\"\\\\?\\\"#;\n    let p = p.as_ref().display().to_string();\n    if p.starts_with(VERBATIM_PREFIX) {\n        p[VERBATIM_PREFIX.len()..].to_string()\n    } else {\n        p\n    }\n}\n\npub fn main() {\n    let path = PathBuf::from(r#\"C:\\Windows\\System32\"#)\n        .canonicalize()\n        .unwrap();\n    let display_path = adjust_canonicalization(path);\n    println!(\"Output: {}\", display_path);\n}\n</code></pre>\n\n<hr>\n\n<p>For the record, I don't agree that your premise is a good idea. Windows Explorer handles these verbatim paths just fine, and I think users are capable of handling it as well.</p>\n\n<blockquote>\n  <p>For [...] logging purposes</p>\n</blockquote>\n\n<p>This sounds like a terrible idea. If you are logging something, you want to know the <em>exact</em> path, not some potentially incorrect path.</p>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526348552, "post_id": 50340928, "comment_id": 87698491, "body": "<i>converts the path accurately whenever possible</i> \u2014 so it doesn&#39;t always remove the <code>\\\\?</code>? Sounds like OPs users will still be angry."}, {"owner": {"reputation": 90851, "user_id": 27009, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/f0a29af415477aa8c498a4f41ffe6640?s=128&d=identicon&r=PG", "display_name": "Kornel", "link": "https://stackoverflow.com/users/27009/kornel"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526413059, "post_id": 50340928, "comment_id": 87732502, "body": "@Shepmaster Are you saying it&#39;s a flaw that it doesn&#39;t do the <i>impossible</i> conversion?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526431278, "post_id": 50340928, "comment_id": 87738413, "body": "Not at all; just that OP / OPs users want something impossible and will thus always be disappointed."}], "tags": [], "owner": {"reputation": 90851, "user_id": 27009, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/f0a29af415477aa8c498a4f41ffe6640?s=128&d=identicon&r=PG", "display_name": "Kornel", "link": "https://stackoverflow.com/users/27009/kornel"}, "is_accepted": false, "score": 3, "last_activity_date": 1526346123, "creation_date": 1526346123, "answer_id": 50340928, "question_id": 50322817, "link": "https://stackoverflow.com/questions/50322817/how-do-i-remove-the-prefix-from-a-canonical-windows-path/50340928#50340928", "title": "How do I remove the \\\\?\\ prefix from a canonical Windows path?", "body": "<p>Use <a href=\"https://crates.rs/crates/dunce\" rel=\"nofollow noreferrer\">the <code>dunce</code> crate</a>:</p>\n\n<pre><code>extern crate dunce;\n\u2026\nlet compatible_path = dunce::canonicalize(&amp;any_path);\n</code></pre>\n\n<p>Just stripping <code>\\\\?\\</code> may give wrong/invalid paths. The dunce crate checks whether the UNC path is compatible and converts the path accurately whenever possible. It passes through all other paths. It compiles to plain <code>fs::canonicalize()</code> on non-Windows.</p>\n"}], "owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 922, "favorite_count": 0, "accepted_answer_id": 50323079, "answer_count": 2, "score": 5, "last_activity_date": 1526346123, "creation_date": 1526269372, "last_edit_date": 1526269864, "question_id": 50322817, "link": "https://stackoverflow.com/questions/50322817/how-do-i-remove-the-prefix-from-a-canonical-windows-path", "title": "How do I remove the \\\\?\\ prefix from a canonical Windows path?", "body": "<p>On Windows, <code>Path::canonicalize()</code> returns the path in the format:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>\\\\\\\\?\\\\C:\\\\projects\\\\3rdparty\\\\rust...\n</code></pre>\n\n<p>This is because it is the correct canonical path, and allows 'long' paths on Windows (see <a href=\"https://stackoverflow.com/questions/41233684/why-does-my-canonicalized-path-get-prefixed-with\">Why does my canonicalized path get prefixed with \\\\?\\</a>).</p>\n\n<p>However, this is not a user-friendly path, and people do not understand it.</p>\n\n<p>For <strong>display and logging purposes</strong> how can I easily remove this prefix in a generic platform independent way?</p>\n\n<p><code>Path::components</code> will return a component <code>\\\\?\\C:</code> as the first component...</p>\n\n<p>Should I convert this to a <code>&amp;str</code> and use a regex? Is there some other more ergonomic method for removing the prefix, e.g. some type with a <code>Display</code> implementation that automatically does the right thing?</p>\n\n<p>My requirements specifically are:</p>\n\n<ul>\n<li>Correctly displays <code>X:\\\\...</code> for a canonical path on Windows.</li>\n<li>Doesn't screw up non-Windows platforms (e.g. strip or change path components)</li>\n</ul>\n\n<p>Example:</p>\n\n<pre><code>use std::path::{Path, PathBuf};\n\nfn simple_path&lt;P: AsRef&lt;Path&gt;&gt;(p: P) -&gt; String {\n    String::from(p.as_ref().to_str().unwrap()) // &lt;-- ?? What to do here?\n}\n\npub fn main() {\n    let path = PathBuf::from(\"C:\\temp\").canonicalize().unwrap();\n    let display_path = simple_path(path);\n    println!(\"Output: {}\", display_path);\n}\n</code></pre>\n"}, {"tags": ["error-handling", "rust"], "answers": [{"comments": [{"owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1526377465, "post_id": 50332434, "comment_id": 87709819, "body": "Thanks for the feedback @E_net4!"}, {"owner": {"reputation": 7145, "user_id": 25616, "user_type": "registered", "accept_rate": 84, "profile_image": "https://www.gravatar.com/avatar/026a7df26cfba1100757dae52a46a3df?s=128&d=identicon&r=PG", "display_name": "quodlibetor", "link": "https://stackoverflow.com/users/25616/quodlibetor"}, "edited": false, "score": 0, "creation_date": 1526386546, "post_id": 50332434, "comment_id": 87715628, "body": "That is a good point that I don&#39;t need the <code>Arc</code> since I&#39;m not actually sharing the value, just sending it."}], "tags": [], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "is_accepted": false, "score": 1, "last_activity_date": 1526390469, "last_edit_date": 1526390469, "creation_date": 1526307005, "answer_id": 50332434, "question_id": 50321329, "link": "https://stackoverflow.com/questions/50321329/how-to-make-error-chain-errors-compatible-with-failure-errors/50332434#50332434", "title": "How to make error-chain errors compatible with Failure errors?", "body": "<p>The only thing that I can suggest is to remove the <code>Arc</code> type.</p>\n\n<p>If you have something that is not <code>Sync</code> then wrap into a <code>Mutex</code> type, so\nto integrate <code>error-chain</code> with <code>failure</code> just wrap <code>dotenv::Error</code>:</p>\n\n<pre><code>#[macro_use]\nextern crate failure;\nextern crate dotenv;\nuse std::sync::Mutex;\n\n#[derive(Debug, Fail)]\n#[fail(display = \"oh no\")]\npub struct Error(Mutex&lt;dotenv::Error&gt;);\n\nfn main() {\n    match dotenv::dotenv() {\n        Err(e) =&gt; {\n            let err = Error(Mutex::new(e));\n            println!(\"{}\", err)\n        }\n        _ =&gt; (),\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 7145, "user_id": 25616, "user_type": "registered", "accept_rate": 84, "profile_image": "https://www.gravatar.com/avatar/026a7df26cfba1100757dae52a46a3df?s=128&d=identicon&r=PG", "display_name": "quodlibetor", "link": "https://stackoverflow.com/users/25616/quodlibetor"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 448, "favorite_count": 0, "answer_count": 1, "score": 6, "last_activity_date": 1526390469, "creation_date": 1526252348, "last_edit_date": 1526288841, "question_id": 50321329, "link": "https://stackoverflow.com/questions/50321329/how-to-make-error-chain-errors-compatible-with-failure-errors", "title": "How to make error-chain errors compatible with Failure errors?", "body": "<p>Given the following code:</p>\n\n<pre><code>extern crate dotenv; // v0.11.0\n#[macro_use]\nextern crate failure; // v0.1.1\n\n#[derive(Debug, Fail)]\n#[fail(display = \"oh no\")]\npub struct Error(dotenv::Error);\n</code></pre>\n\n<p>Due to the fact that <code>error-chain</code> (v0.11, the latest) does not guarantee that its wrapped error is <code>Sync</code> (<a href=\"https://github.com/rust-lang-nursery/error-chain/pull/241\" rel=\"nofollow noreferrer\">open PR to fix the issue</a>) I get an error saying that <code>Sync</code> is not implemented for <code>dotenv::Error</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `std::error::Error + std::marker::Send + 'static: std::marker::Sync` is not satisfied\n --&gt; src/main.rs:5:17\n  |\n5 | #[derive(Debug, Fail)]\n  |                 ^^^^ `std::error::Error + std::marker::Send + 'static` cannot be shared between threads safely\n  |\n  = help: the trait `std::marker::Sync` is not implemented for `std::error::Error + std::marker::Send + 'static`\n  = note: required because of the requirements on the impl of `std::marker::Sync` for `std::ptr::Unique&lt;std::error::Error + std::marker::Send + 'static&gt;`\n  = note: required because it appears within the type `std::boxed::Box&lt;std::error::Error + std::marker::Send + 'static&gt;`\n  = note: required because it appears within the type `std::option::Option&lt;std::boxed::Box&lt;std::error::Error + std::marker::Send + 'static&gt;&gt;`\n  = note: required because it appears within the type `error_chain::State`\n  = note: required because it appears within the type `dotenv::Error`\n  = note: required because it appears within the type `Error`\n</code></pre>\n\n<p>What's the minimal amount of boilerplate/work I can get away with to make these types play nicely together? The shortest thing I've been able to come up with is adding an <code>ErrorWrapper</code> newtype so that I can implement <code>Error</code> on an <code>Arc&lt;Mutex&lt;ERROR_CHAIN_TYPE&gt;&gt;</code>:</p>\n\n<pre><code>use std::fmt::{self, Debug, Display, Formatter};\nuse std::sync::{Arc, Mutex};\n\n#[derive(Debug, Fail)]\n#[fail(display = \"oh no\")]\npub struct Error(ErrorWrapper&lt;dotenv::Error&gt;);\n\n#[derive(Debug)]\nstruct ErrorWrapper&lt;T&gt;(Arc&lt;Mutex&lt;T&gt;&gt;)\nwhere\n    T: Debug;\n\nimpl&lt;T&gt; Display for ErrorWrapper&lt;T&gt;\nwhere\n    T: Debug,\n{\n    fn fmt(&amp;self, f: &amp;mut Formatter) -&gt; fmt::Result {\n        write!(f, \"oh no!\")\n    }\n}\n\nimpl&lt;T&gt; ::std::error::Error for ErrorWrapper&lt;T&gt;\nwhere\n    T: Debug,\n{\n    fn description(&amp;self) -&gt; &amp;str {\n        \"whoops\"\n    }\n}\n\n// ... plus a bit more for each `From&lt;T&gt;` that needs to be converted into\n// `ErrorWrapper`\n</code></pre>\n\n<p>Is this the right way to go about it? Is there something that will have less code/runtime cost for converting into an <code>Arc&lt;Mutex&lt;T&gt;&gt;</code> for things that don't need it?</p>\n"}, {"tags": ["rust", "udp", "closures", "future", "rust-tokio"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1526244421, "post_id": 50320286, "comment_id": 87656794, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. For example, your import statements (<code>extern crate ...</code> / <code>use ...</code>) are missing, so we can&#39;t even tell what types you are using. Remove all unneeded detail (do you <i>really</i> need the logger calls?). What versions of the crates are you using (these crates are still under active development)?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1526244547, "post_id": 50320286, "comment_id": 87656831, "body": "<i><code>expect(&amp;format!(&quot;Couldn&#39;t create valid SocketAddress out of {}&quot;, addr))</code></i> \u2014 don&#39;t do that, it allocates the <code>String</code> every time that function is called, not just when there&#39;s an error. Use <code>unwrap_or_else(|e| panic!(&quot;Couldn&#39;t create valid SocketAddress out of {}: {}&quot;, addr, e))</code> instead."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1526244778, "post_id": 50320286, "comment_id": 87656905, "body": "Your <code>main</code> function references <code>self</code> \u2014 the code you&#39;ve provided cannot <i>possibly</i> compile."}, {"owner": {"user_type": "does_not_exist", "display_name": "user4063815"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526322419, "post_id": 50320286, "comment_id": 87689630, "body": "@Shepmaster so it allocates a string once, as it&#39;s only called once. But thanks anyways, that was valuable input. And yes, as I tried to create a minimal (albeit incomplete ;)) example, I just put everything into the main function that actually resides in a struct... my bad."}], "answers": [{"comments": [{"owner": {"user_type": "does_not_exist", "display_name": "user4063815"}, "edited": false, "score": 0, "creation_date": 1526322741, "post_id": 50327136, "comment_id": 87689795, "body": "I wonder what&#39;s the right way to do this then with Tokio. The whole benefit for me was that I didn&#39;t need to create the datagrams by hand."}, {"owner": {"user_type": "does_not_exist", "display_name": "user4063815"}, "edited": false, "score": 0, "creation_date": 1526322886, "post_id": 50327136, "comment_id": 87689873, "body": "Also, I guess it brings in the exact same error, doesn&#39;t it? (Will try once at home)... I mean we invoke the <code>for_each</code> on <code>framed</code> and use <code>framed</code> inside the closure."}], "tags": [], "owner": {"reputation": 13169, "user_id": 967945, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/47244a17f72cee237f57f4c4b9613ea1?s=128&d=identicon&r=PG", "display_name": "Dan Hulme", "link": "https://stackoverflow.com/users/967945/dan-hulme"}, "is_accepted": false, "score": 2, "last_activity_date": 1529495783, "last_edit_date": 1529495783, "creation_date": 1526290281, "answer_id": 50327136, "question_id": 50320286, "link": "https://stackoverflow.com/questions/50320286/how-to-use-tokios-udpsocket-to-handle-messages-in-a-1-server-n-clients-setup/50327136#50327136", "title": "How to use tokio&#39;s UdpSocket to handle messages in a 1 server: N clients setup?", "body": "<p>Here's the signature of <a href=\"https://tokio-rs.github.io/tokio-core/tokio_core/net/struct.UdpSocket.html#method.framed\" rel=\"nofollow noreferrer\"><code>UdpSocket::framed</code></a> from Tokio's documentation:</p>\n\n<pre><code>pub fn framed&lt;C: UdpCodec&gt;(self, codec: C) -&gt; UdpFramed&lt;C&gt;\n</code></pre>\n\n<p>Note that it takes <code>self</code>, not <code>&amp;self</code>; that is, calling this function consumes the socket. The <code>UdpFramed</code> wrapper owns the underlying socket when you call this. Your compilation error is telling you that you're moving <code>socket</code> when you call this method, but you're also trying to borrow <code>socket</code> inside your closure (to call <code>send_to</code>).</p>\n\n<p>This probably isn't what you want for real code. The whole point of using <code>framed()</code> is to turn your socket into something higher-level, so you can send your codec's items directly instead of having to assemble datagrams. Using <code>send</code> or <code>send_to</code> directly on the socket will probably break the framing of your message protocol. In this code, where you're trying to implement a simple echo server, you don't need to use <code>framed</code> at all. But if you do want to <em>have your cake and eat it</em> and use both <code>framed</code> and <code>send_to</code>, luckily <code>UdpFramed</code> still allows you to borrow the underlying <code>UdpSocket</code>, using <a href=\"https://tokio-rs.github.io/tokio-core/tokio_core/net/struct.UdpFramed.html#method.get_ref\" rel=\"nofollow noreferrer\"><code>get_ref</code></a>. You can fix your problem this way:</p>\n\n<pre><code>let framed = {\n    let socket = UdpSocket::bind(&amp;addr, &amp;handle).expect(&amp;format!(\"Couldn't bind socket to address {}\", addr));\n    socket.framed(MyCodec {})\n}\n\nlet udp_future = framed.for_each(|(addr, data)| {\n    info!(self.logger, \"Udp packet received from {}: length: {}\", addr, data.len());\n    framed.get_ref().send_to(&amp;data, &amp;addr); // Just echo back the data\n\n    Ok(())\n});\n</code></pre>\n\n<p>I haven't checked this code, since (as Shepmaster rightly pointed out) your code snippet has other problems, but it should give you the idea anyway. I'll repeat my warning from earlier: if you do this in real code, it will break the network protocol you're using. <code>get_ref</code>'s documentation puts it like this:</p>\n\n<blockquote>\n  <p>Note that care should be taken to not tamper with the underlying stream of data coming in as it may corrupt the stream of frames otherwise being worked with.</p>\n</blockquote>\n\n<hr>\n\n<p>To answer the new part of your question: yes, you need to handle reassembly yourself, which means your codec does actually need to do some framing on the bytes you're sending. Typically this might involve a <em>start sequence</em> which cannot occur in the <code>Vec&lt;u8&gt;</code>. The start sequence lets you recognise the start of the next message after a packet was lost (which happens a lot with UDP). If there's no byte sequence that can't occur in the <code>Vec&lt;u8&gt;</code>, you need to escape it when it does occur. You might then send the length of the message, followed by the data itself; or just the data, followed by an end sequence and a checksum so you know none was lost. There are pros and cons to these designs, and it's a big topic in itself.</p>\n\n<p>You also need your <code>UdpCodec</code> to contain data: a map from <code>SocketAddr</code> to the partially-reassembled message that's currently in progress. In <code>decode</code>, if you are given the start of a message, copy it into the map and return <code>Ok</code>. If you are given the middle of a message, and you already have the start of a message in the map (for that <code>SocketAddr</code>), append the buffer to the existing buffer and return <code>Ok</code>. When you get to the end of the message, return the whole thing and empty the buffer. The methods on <code>UdpCodec</code> take <code>&amp;mut self</code> in order to enable this use case. (<strong>NB</strong> In theory, you should also deal with packets arriving out of order, but that's actually quite rare in the real world.)</p>\n\n<p><code>encode</code> is a lot simpler: you just need to add the same framing and copy the message into the buffer.</p>\n\n<p>Let me reiterate here that you don't need to and shouldn't use the underlying socket after calling <code>framed()</code> on it. <code>UdpFramed</code> is both a source and a sink, so you use that one object to send the replies as well. You can even use <code>split()</code> to get separate <code>Stream</code> and <code>Sink</code> implementations out of it, if that makes the ownership easier in your application.</p>\n\n<hr>\n\n<p>Overall, now I've seen how much of the problem you're struggling with, I'd recommend just using several TCP sockets instead of UDP. If you want a connection-oriented, reliable protocol, TCP already exists and does that for you. It's very easy to spend a lot of time making a \"reliable\" layer on top of UDP that is both slower and less reliable than TCP.</p>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user4063815"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2176, "favorite_count": 1, "answer_count": 1, "score": 3, "last_activity_date": 1529495783, "creation_date": 1526242719, "last_edit_date": 1528828617, "question_id": 50320286, "link": "https://stackoverflow.com/questions/50320286/how-to-use-tokios-udpsocket-to-handle-messages-in-a-1-server-n-clients-setup", "title": "How to use tokio&#39;s UdpSocket to handle messages in a 1 server: N clients setup?", "body": "<p><strong>What I want to do:</strong></p>\n\n<p>... write a (1) server/ (N) clients (network-game-)architecture that uses UDP sockets as underlying base for communication.</p>\n\n<ul>\n<li><p>Messages are sent as <code>Vec&lt;u8&gt;</code>, encoded via <code>bincode</code> (crate)</p></li>\n<li><p>I also want to be able to occasionally send datagrams that can exceed the typical max <code>MTU</code> of ~<code>1500 bytes</code> and be correctly assembled on receiver end, including sending of <code>ack</code>-messages etc. <strong><em>(I assume I'll have to implement that myself, right?)</em></strong></p></li>\n</ul>\n\n<p>For the <code>UdpSocket</code> I thought about using <code>tokio</code>'s implementation and maybe <code>framed</code>. I am not sure whether this is a good choice though, as it seems that this would introduce an unnecessary step of mapping <code>Vec&lt;u8&gt;</code> (serialized by <code>bincode</code>) to <code>Vec&lt;u8&gt;</code> (needed by <code>UdpCodec</code> of <code>tokio</code>) (?)</p>\n\n<p>Consider this minimal code-example:</p>\n\n<p>Cargo.toml (server)</p>\n\n<pre><code>bincode = \"1.0\"\nfutures = \"0.1\"\ntokio-core = \"^0.1\"\n</code></pre>\n\n<p>(<code>Serde</code> and <code>serde-derive</code> are used in <code>shared</code> crate where the protocol is defined!)</p>\n\n<p>(I want to replace <code>tokio-core</code> with <code>tokio</code> asap)</p>\n\n<pre><code>fn main() -&gt; () {\n    let addr = format!(\"127.0.0.1:{port}\", port = 8080);\n    let addr = addr.parse::&lt;SocketAddr&gt;().expect(&amp;format!(\"Couldn't create valid SocketAddress out of {}\", addr));\n\n    let mut core = Core::new().unwrap();\n    let handle = core.handle();\n    let socket = UdpSocket::bind(&amp;addr, &amp;handle).expect(&amp;format!(\"Couldn't bind socket to address {}\", addr));\n\n\n    let udp_future = socket.framed(MyCodec {}).for_each(|(addr, data)| {\n        socket.send_to(&amp;data, &amp;addr); // Just echo back the data\n        Ok(())\n    });\n\n    core.run(udp_future).unwrap();\n}\n\nstruct MyCodec;\n\nimpl UdpCodec for MyCodec {\n    type In = (SocketAddr, Vec&lt;u8&gt;);\n    type Out = (SocketAddr, Vec&lt;u8&gt;);\n\n    fn decode(&amp;mut self, src: &amp;SocketAddr, buf: &amp;[u8]) -&gt; io::Result&lt;Self::In&gt; {\n        Ok((*src, buf.to_vec()))\n    }\n\n    fn encode(&amp;mut self, msg: Self::Out, buf: &amp;mut Vec&lt;u8&gt;) -&gt; SocketAddr {\n        let (addr, mut data) = msg;\n        buf.append(&amp;mut data);\n        addr\n    }\n}\n</code></pre>\n\n<p>The problem here is:</p>\n\n<blockquote>\n  <p>let udp_future = socket.framed(MyCodec {}).for_each(|(addr, data)| {\n      |                          ------ value moved here                         ^^^^^^^^^^^^^^ value captured here after move\n      |\n      = note: move occurs because <code>socket</code> has type <code>tokio_core::net::UdpSocket</code>, which does not implement the <code>Copy</code> trait</p>\n</blockquote>\n\n<p>The error makes total sense, yet I am not sure how I would create such a simple echo-service. In reality, the handling of a message involves a bit more logic ofc, but for the sake of a minimal example, this should be enough to give a rough idea.</p>\n\n<p>My workaround is an ugly hack: creating a second socket.</p>\n"}, {"tags": ["rust", "rust-macros"], "answers": [{"comments": [{"owner": {"reputation": 911, "user_id": 1720030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ed169f40f14f68d8eec2a925a3ce8b41?s=128&d=identicon&r=PG", "display_name": "Ivan", "link": "https://stackoverflow.com/users/1720030/ivan"}, "edited": false, "score": 0, "creation_date": 1526375975, "post_id": 50319024, "comment_id": 87708746, "body": "thanks, I know that macros are working on AST, but did not realized how free variable references are handled. I thought that macro pieces are fit in the right places in AST before binding variables.  But solution from trentcl worked great -  having added :ident params to macro introduced variables at right place."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 5, "last_activity_date": 1526234609, "last_edit_date": 1526234609, "creation_date": 1526234259, "answer_id": 50319024, "question_id": 50318744, "link": "https://stackoverflow.com/questions/50318744/creating-environment-for-closure-in-a-macro-in-rust/50319024#50319024", "title": "Creating environment for closure in a macro in Rust", "body": "<blockquote>\n  <p>Is it possible to make this work? My understanding was that macros are expanded before compilation?</p>\n</blockquote>\n\n<p>Macros are expanded before compilation, but not before <em>parsing</em>. The raw input code has already been parsed and macros operate on an abstract syntax tree, not on text. For example, the closure is already understood to be a closure, and its free variables are already bound to variables in its lexical scope.</p>\n\n<p>This is different to some other languages macros, for example <a href=\"https://stackoverflow.com/questions/321143/good-programming-practices-for-macro-definitions-define-in-c#321156\">C/C++</a>, which operate on raw text, and let you screw things up pretty badly if you're not careful.</p>\n"}, {"tags": [], "owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "is_accepted": true, "score": 8, "last_activity_date": 1555719887, "last_edit_date": 1555719887, "creation_date": 1526383982, "answer_id": 50349141, "question_id": 50318744, "link": "https://stackoverflow.com/questions/50318744/creating-environment-for-closure-in-a-macro-in-rust/50349141#50349141", "title": "Creating environment for closure in a macro in Rust", "body": "<p><a href=\"https://stackoverflow.com/a/50319024/3650362\">Peter's answer</a> explains why what you're doing won't work. This is part of what's referred to as \"macro hygiene\": things declared inside macros can't \"leak\" into the surrounding scope.</p>\n\n<p>A common workaround for the problem you're facing is to pass the name of the identifier into the macro as another argument:</p>\n\n<pre><code>macro_rules! atest {\n    ($x:ident, $closure:tt) =&gt; {\n        let $x = 5;\n        println!(\"Result is {}\", $closure())\n    };\n}\n\nfn main() {\n    atest!(x, (|| 5 + x));\n}\n</code></pre>\n\n<p>This will work because naming <code>x</code> puts it in the caller's scope, even though the declaration is inside the macro.</p>\n\n<p>You might notice that the closure is kind of unnecessary, at least in this example -- you could just pass <code>5 + x</code> as an expression to the macro and have it expanded inline.</p>\n\n<pre><code>macro_rules! atest {\n    ($x:ident, $value:expr) =&gt; {\n        let $x = 5;\n        println!(\"Result is {}\", $value)\n    };\n}\n</code></pre>\n\n<p>You call this macro like <code>atest!(x, 5 + x)</code>, which looks a little bit like a closure of its own. That might give you the idea of writing <code>atest!(|x| 5 + x)</code> instead. And that will also work, with a variable scoped to the closure:</p>\n\n<pre><code>macro_rules! atest {\n    ($closure:expr) =&gt; {\n        let x = 5;\n        println!(\"Result is {}\", $closure(x))\n    };\n}\n</code></pre>\n\n<h2>References</h2>\n\n<ul>\n<li><a href=\"https://www.ncameron.org/blog/macros-in-rust-pt1/\" rel=\"noreferrer\">Macros in Rust pt1</a></li>\n</ul>\n"}], "owner": {"reputation": 911, "user_id": 1720030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ed169f40f14f68d8eec2a925a3ce8b41?s=128&d=identicon&r=PG", "display_name": "Ivan", "link": "https://stackoverflow.com/users/1720030/ivan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1552, "favorite_count": 2, "accepted_answer_id": 50349141, "answer_count": 2, "score": 10, "last_activity_date": 1555719887, "creation_date": 1526232320, "last_edit_date": 1555719773, "question_id": 50318744, "link": "https://stackoverflow.com/questions/50318744/creating-environment-for-closure-in-a-macro-in-rust", "title": "Creating environment for closure in a macro in Rust", "body": "<p>I'm trying to achieve something like this (simplified):</p>\n\n<pre><code>macro_rules! atest {\n    ($closure:tt) =&gt; {\n        let x = 5;\n        println!(\"Result is {}\", $closure())\n    };\n}\n\nfn main() {\n    //let x = 50;\n    atest!((|| 5 + x));\n}\n</code></pre>\n\n<p>It does not work because the argument to the <code>atest</code> macro is considered by the compiler before macro evaluation:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0425]: cannot find value `x` in this scope\n  --&gt; src/main.rs:10:20\n   |\n10 |     atest!((|| 5 + x));\n   |                    ^ not found in this scope\n</code></pre>\n\n<p>Is it possible to make this work? My understanding was that macros are expanded before compilation.</p>\n"}, {"tags": ["rust", "traits"], "answers": [{"comments": [{"owner": {"user_type": "does_not_exist", "display_name": "user8569012"}, "edited": false, "score": 0, "creation_date": 1526249487, "post_id": 50316324, "comment_id": 87658033, "body": "So it does! It&#39;s obvious in the <a href=\"https://doc.rust-lang.org/src/alloc/str.rs.html#1797-1799\" rel=\"nofollow noreferrer\">source code view</a>, which is just what I was expecting to see."}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 6, "last_activity_date": 1526215967, "creation_date": 1526215967, "answer_id": 50316324, "question_id": 50316305, "link": "https://stackoverflow.com/questions/50316305/why-doesnt-the-signature-of-stdstrparse-use-a-trait-bound/50316324#50316324", "title": "Why doesn&#39;t the signature of std::str::parse use a trait bound?", "body": "<p>It does use a trait bound, however the bound is specified using the <strong>where</strong> clause. <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.parse\" rel=\"noreferrer\">Look closer</a>:</p>\n\n<blockquote>\n<pre><code>pub fn parse&lt;F&gt;(&amp;self) -&gt; Result&lt;F, &lt;F as FromStr&gt;::Err&gt;\nwhere\n    F: FromStr,\n</code></pre>\n</blockquote>\n"}, {"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 0, "last_activity_date": 1526299539, "last_edit_date": 1526299539, "creation_date": 1526222766, "answer_id": 50317324, "question_id": 50316305, "link": "https://stackoverflow.com/questions/50316305/why-doesnt-the-signature-of-stdstrparse-use-a-trait-bound/50317324#50317324", "title": "Why doesn&#39;t the signature of std::str::parse use a trait bound?", "body": "<p><code>&lt;F as FromStr&gt;::Err</code> means the associated <code>Err</code> type from <code>F</code>'s implementation of <code>FromStr</code>. </p>\n\n<blockquote>\n  <p>Why is it not as below?</p>\n\n<pre><code>pub fn parse&lt;F: FromStr&gt;(&amp;self) -&gt; Result&lt;F, F::Err&gt;\n</code></pre>\n</blockquote>\n\n<p>Because <code>F</code> could implement many different traits, all of which could have a different associated <code>Err</code> type. This syntax makes sure that it gets the type specifically associated with <code>F</code>'s <code>FromStr</code> implementation.</p>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user8569012"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 148, "favorite_count": 0, "accepted_answer_id": 50316324, "answer_count": 2, "score": 0, "last_activity_date": 1526299539, "creation_date": 1526215846, "last_edit_date": 1526218069, "question_id": 50316305, "link": "https://stackoverflow.com/questions/50316305/why-doesnt-the-signature-of-stdstrparse-use-a-trait-bound", "title": "Why doesn&#39;t the signature of std::str::parse use a trait bound?", "body": "<p>The signature of the <code>parse</code> method on the Rust's <code>str</code> primitive type is </p>\n\n<pre><code>pub fn parse&lt;F&gt;(&amp;self) -&gt; Result&lt;F, &lt;F as FromStr&gt;::Err&gt;\n</code></pre>\n\n<p>Why is it not as below?</p>\n\n<pre><code>pub fn parse&lt;F: FromStr&gt;(&amp;self) -&gt; Result&lt;F, F::Err&gt;\n</code></pre>\n\n<p>I thought perhaps the primitive cast would ensure <code>Err</code> resolves to <code>FromStr::Err</code>, not <code>SomeOtherTrait::Err</code>. </p>\n\n<p>Still, given the following line in the <code>parse</code> documentation...</p>\n\n<blockquote>\n  <p>parse can parse any type that implements the FromStr trait</p>\n</blockquote>\n\n<p>Why is there no trait bound?</p>\n"}, {"tags": ["rust"], "owner": {"reputation": 615, "user_id": 770476, "user_type": "registered", "accept_rate": 38, "profile_image": "https://www.gravatar.com/avatar/8cf9af3473871c08a5a80833a7d2824a?s=128&d=identicon&r=PG", "display_name": "fabiim", "link": "https://stackoverflow.com/users/770476/fabiim"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 101, "favorite_count": 0, "closed_date": 1526207198, "answer_count": 0, "score": 1, "last_activity_date": 1526205911, "creation_date": 1526205911, "question_id": 50314946, "link": "https://stackoverflow.com/questions/50314946/convert-iterator-of-result-to-resultvec", "closed_reason": "Duplicate", "title": "Convert iterator of Result to Result&lt;Vec&lt;_&gt;&gt;", "body": "<p>How can I transform an <code>iterator</code> of <code>Result</code> into a <code>Result</code> of a vector?</p>\n\n<p>As an example, suppose I want to transform the <code>Bytes</code> iterator obtainable from the <code>Read</code> trait:</p>\n\n<pre><code>use std::io::{Read, Result};\n\nuse std::fs::File;\n\n\nfn main() {\n    let f = File::open(\"some-file\").unwrap();\n    let bytes = f.bytes();\n\n    let byte_vector: Result&lt;Vec&lt;u8&gt;&gt; = read_bytes(bytes);\n}\n\nfn read_bytes&lt;I: Iterator&lt;Item=Result&lt;u8&gt;&gt;&gt;(bytes: I) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {\n    unimplemented!();\n}\n</code></pre>\n"}, {"tags": ["linux", "rust", "binary-reproducibility"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1526199933, "post_id": 50313333, "comment_id": 87644307, "body": "That shouldn&#39;t happen... <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> ?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526228256, "post_id": 50313333, "comment_id": 87652048, "body": "Is your binary <i>already</i> reproducible? Are you sure you aren&#39;t confusing the result of non-deterministic builds with rustfmt? Perhaps you changed your dependencies or your compiler version, or perhaps the build is multithreaded or otherwise nondeterministic?"}, {"owner": {"reputation": 5913, "user_id": 1244932, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/d2c608e688b798896e8b516855fc1ab1?s=128&d=identicon&r=PG", "display_name": "user1244932", "link": "https://stackoverflow.com/users/1244932/user1244932"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526233850, "post_id": 50313333, "comment_id": 87653689, "body": "@Shepmaster About only rustfmt I am sure. And my build multithread, but why multithread produce not determenistic code (without several cores I will perhaps wait forever for rebuild)? At now my version is that I have too many <code>assert!</code>, and after rustfmt too many lines change numbers, so every <code>assert!</code> transfered to inline code looks different."}], "owner": {"reputation": 5913, "user_id": 1244932, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/d2c608e688b798896e8b516855fc1ab1?s=128&d=identicon&r=PG", "display_name": "user1244932", "link": "https://stackoverflow.com/users/1244932/user1244932"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 153, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1526228085, "creation_date": 1526192511, "last_edit_date": 1526228085, "question_id": 50313333, "link": "https://stackoverflow.com/questions/50313333/how-do-i-prevent-cargo-fmt-from-changing-the-compiled-binary", "title": "How do I prevent cargo fmt from changing the compiled binary?", "body": "<p>I reformatted my code base with rustfmt 0.4.1-stable and had a huge diff that is hard to check by eye.</p>\n\n<p>A long time ago, I had a similar problem after <code>cargo fmt</code> produced a huge diff. At that time, I solved it by:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>cargo build --release\nstrip -s target/release/mylib.so -o target/release/mylib-stripped.so\ndiff &lt;(hexdump -C &lt; target/release/mylib-stripped.so) &lt;(hexdump -C &lt; target/release/prev-mylib-stripped.so)\n</code></pre>\n\n<p>The difference was just few bytes and looked like a time stamp, but this time the difference between both <code>hexdump</code> / <code>objdump</code> outputs is huge.</p>\n\n<p>The code is different, for example:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>                                        push   %r13\n   188d3a:      41 54                   push   %r12\n   188d3c:      53                      push   %rbx\n-  188d3d:      48 81 ec 48 01 00 00    sub    $0x148,%rsp\n-  188d44:      48 89 d3                mov    %rdx,%rbx\n...\n+  188d3d:      48 81 ec 88 06 00 00    sub    $0x688,%rsp\n+  188d44:      4d 89 ce                mov    %r9,%r14\n+  188d47:      4c 89 85 a0 fe ff ff    mov    %r8,-0x160(%rbp)\n...\n</code></pre>\n\n<p>How do I make builds reproducible before and after <code>cargo fmt</code>? </p>\n"}, {"tags": ["datetime", "rust", "chrono"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526200102, "post_id": 50312999, "comment_id": 87644348, "body": "&quot;The date is shown in the following format: %d/%m/%Y (example: 27/08/2018). Time is only an hour (12, 10, 21, etc.)&quot;, Where is the hours in &quot;27/08/2018&quot; ?"}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526206968, "post_id": 50312999, "comment_id": 87645954, "body": "I get the hour in another element. So I parse two strings, one to get the date, one to get the hour. I would like to avoid building a fake datetime string, and specify which time zone the datetime is from."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1526209426, "post_id": 50312999, "comment_id": 87646607, "body": "I am noticing an incoherence. Are all date-time instances in the same time zone or not? Please update the question instead of keeping useful information in the comments."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526212548, "post_id": 50312999, "comment_id": 87647457, "body": "Your question don&#39;t make sense, <code>NaiveDate</code> is already without timezone, this is the first thing write in the doc. <code>naive_date.and_hms(hour, 0, 0);</code> ????"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526229361, "post_id": 50312999, "comment_id": 87652387, "body": "I think I understand the question. You have a time and date, which are both naive - they don&#39;t have timezones attached to them. But, you <i>do</i> happen to know that the timezone is, for example, +0100. You now want to create a <code>DateTime&lt;Utc&gt;</code>, properly adjusted for the timezone. Is that about right?"}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526233357, "post_id": 50312999, "comment_id": 87653566, "body": "@PeterHall exactly"}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526233456, "post_id": 50312999, "comment_id": 87653589, "body": "@Stargateur What I meant is that I want to have the datetime with the timezone, but adjusted to UTC. So for example, let&#39;s say my date element is &quot;27/08/2018&quot; and the hour element is &quot;12&quot;. I know the timezone is Paris (currently UTC + 2).  So, I want to create a DateTime&lt;Utc&gt; from these info.  Sorry if this wasn&#39;t clear..."}], "answers": [{"comments": [{"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 0, "creation_date": 1526242751, "post_id": 50318439, "comment_id": 87656317, "body": "Then it&#39;s exactly what I needed, thank you very much for your answer."}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 0, "creation_date": 1526293724, "post_id": 50318439, "comment_id": 87672095, "body": "For information, using chrono-tz is much more confortable:     pub fn create_date_time_from_paris(date: NaiveDate, time: NaiveTime) -&gt; DateTime&lt;Utc&gt; {     let naive_datetime = NaiveDateTime::new(date, time);     let paris_time = Paris.from_local_datetime(&amp;naive_datetime).unwrap();     paris_time.with_timezone(&amp;Utc) }"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 0, "creation_date": 1526295042, "post_id": 50318439, "comment_id": 87672828, "body": "@Justmaker Thanks, I learnt something too. In looking at the documentation from chrono-tz, I realised you can do the same thing from a <code>FixedOffset</code>, which you already had. I updated my answer with that, since it&#39;s much better than subtracting the offsets."}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 0, "creation_date": 1526299989, "post_id": 50318439, "comment_id": 87675898, "body": "Yes, but then you&#39;d need to handle daylight saving manually, whereas chrono-tz handles it for you ;)"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 2, "creation_date": 1526300183, "post_id": 50318439, "comment_id": 87676024, "body": "@Justmaker It kind of depends what information you have. If you know the current timezone is UTC+0100 then this is fine. If you know you are in Paris, then <code>chrono-tz</code> seems better. I&#39;m still not sure how you would guarantee to pick the correct timezone for an arbitrary city though?"}, {"owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "edited": false, "score": 0, "creation_date": 1526300399, "post_id": 50318439, "comment_id": 87676178, "body": "In my use case, I don&#39;t need to worry about this, the dates are known to be from Paris. My main worry is comparing the user&#39;s (who could be anywhere) datetime to that Paris one.  For picking the correct timezone for an arbitrary city, I don&#39;t think it can be done without having the information. You&#39;d rely on your front or other means to give you the date time + timezone."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 9, "last_activity_date": 1526297625, "last_edit_date": 1526297625, "creation_date": 1526230140, "answer_id": 50318439, "question_id": 50312999, "link": "https://stackoverflow.com/questions/50312999/how-do-i-go-from-a-naivedate-to-a-specific-timezone-with-chrono/50318439#50318439", "title": "How do I go from a NaiveDate to a specific TimeZone with Chrono?", "body": "<p>The Chrono documentation could probably be improved to make it easier to find how to do these things.</p>\n\n<p>Assuming this is your starting point:</p>\n\n<pre><code>use chrono::{DateTime, FixedOffset, NaiveDate, NaiveDateTime, NaiveTime, TimeZone, Utc};\n\n// The date you parsed\nlet date = NaiveDate::from_ymd(2018, 5, 13);\n// The known 1 hour time offset in seconds\nlet tz_offset = FixedOffset::east(1 * 3600);\n// The known time\nlet time = NaiveTime::from_hms(17, 0, 0);\n// Naive date time, with no time zone information\nlet datetime = NaiveDateTime::new(date, time);\n</code></pre>\n\n<p>You can then use the <code>FixedOffset</code> to construct a <code>DateTime</code>:</p>\n\n<pre><code>let dt_with_tz: DateTime&lt;FixedOffset&gt; = tz_offset.from_local_datetime(&amp;datetime).unwrap();\n</code></pre>\n\n<p>If you need to convert it to a <code>DateTime&lt;Utc&gt;</code>, you can do this:</p>\n\n<pre><code>let dt_with_tz_utc: DateTime&lt;Utc&gt; = Utc.from_utc_datetime(&amp;dt_with_tz.naive_utc());\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526257247, "post_id": 50320973, "comment_id": 87659331, "body": "Could be <code>p.offset = Some(1 * 3600);</code> or <code>format::parse(&amp;mut p, timezone.trim(), StrftimeItems::new(&quot;%z&quot;))?;</code>"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 0, "last_activity_date": 1526314927, "last_edit_date": 1526314927, "creation_date": 1526248485, "answer_id": 50320973, "question_id": 50312999, "link": "https://stackoverflow.com/questions/50312999/how-do-i-go-from-a-naivedate-to-a-specific-timezone-with-chrono/50320973#50320973", "title": "How do I go from a NaiveDate to a specific TimeZone with Chrono?", "body": "<blockquote>\n  <p>The dates and times are from a website in which the date and time are from different sections of the page.</p>\n</blockquote>\n\n<p>Here's an example of how you can <em>incrementally</em> parse multiple values from distinct strings, provide default values for unparsed information, and use Chrono's built-in timezone conversion. </p>\n\n<p>The key is to use the <a href=\"https://docs.rs/chrono/0.4.2/chrono/format/fn.parse.html\" rel=\"nofollow noreferrer\"><code>parse</code></a> function to update a <a href=\"https://docs.rs/chrono/0.4.2/chrono/format/struct.Parsed.html\" rel=\"nofollow noreferrer\"><code>Parsed</code></a> struct. You can use the <a href=\"https://docs.rs/chrono/0.4.2/chrono/format/strftime/struct.StrftimeItems.html\" rel=\"nofollow noreferrer\"><code>StrftimeItems</code></a> iterator to continue to use more readable format strings.</p>\n\n<pre><code>extern crate chrono;\n\nuse chrono::prelude::*;\n\nfn example(date: &amp;str, hour: &amp;str) -&gt; chrono::ParseResult&lt;DateTime&lt;Utc&gt;&gt; {\n    use chrono::format::{self, strftime::StrftimeItems, Parsed};\n\n    // Set up a struct to perform successive parsing into\n    let mut p = Parsed::default();\n\n    // Parse the date information\n    format::parse(&amp;mut p, date.trim(), StrftimeItems::new(\"%d/%m/%Y\"))?;\n    // Parse the time information and provide default values we don't parse\n    format::parse(&amp;mut p, hour.trim(), StrftimeItems::new(\"%H\"))?;\n    p.minute = Some(0);\n    p.second = Some(0);\n\n    // Convert parsed information into a DateTime in the Paris timezone\n    let paris_time_zone_offset = FixedOffset::east(1 * 3600);\n    let dt = p.to_datetime_with_timezone(&amp;paris_time_zone_offset)?;\n\n    // You can also use chrono-tz instead of hardcoding it\n    // let dt = p.to_datetime_with_timezone(&amp;chrono_tz::Europe::Paris)?;\n\n    // Convert to UTC\n    Ok(dt.with_timezone(&amp;Utc))\n}\n\nfn main() {\n    let date = \"27/08/2018\";\n    let hour = \"12\";\n\n    println!(\"dt = {:?}\", example(date, hour)); // Ok(2018-08-27T11:00:00Z)\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "is_accepted": false, "score": 6, "last_activity_date": 1526400304, "last_edit_date": 1526400304, "creation_date": 1526397522, "answer_id": 50353821, "question_id": 50312999, "link": "https://stackoverflow.com/questions/50312999/how-do-i-go-from-a-naivedate-to-a-specific-timezone-with-chrono/50353821#50353821", "title": "How do I go from a NaiveDate to a specific TimeZone with Chrono?", "body": "<p>I've discovered <a href=\"https://crates.io/crates/chrono-tz\" rel=\"noreferrer\">chrono-tz</a> and found it much easier to use. For example:</p>\n\n<pre><code>pub fn create_date_time_from_paris(date: NaiveDate, time: NaiveTime) -&gt; DateTime&lt;Utc&gt; {\n    let naive_datetime = NaiveDateTime::new(date, time);\n    let paris_time = Paris.from_local_datetime(&amp;naive_datetime).unwrap();\n    paris_time.with_timezone(&amp;Utc)\n}\n</code></pre>\n"}], "owner": {"reputation": 999, "user_id": 1062022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c93e5c8255d094dad7bca1387ef58e21?s=128&d=identicon&r=PG", "display_name": "Justmaker", "link": "https://stackoverflow.com/users/1062022/justmaker"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 4982, "favorite_count": 2, "accepted_answer_id": 50318439, "answer_count": 3, "score": 11, "last_activity_date": 1526400304, "creation_date": 1526188879, "last_edit_date": 1526397495, "question_id": 50312999, "link": "https://stackoverflow.com/questions/50312999/how-do-i-go-from-a-naivedate-to-a-specific-timezone-with-chrono", "title": "How do I go from a NaiveDate to a specific TimeZone with Chrono?", "body": "<p>I am parsing dates and times in Rust using the <a href=\"https://docs.rs/chrono/0.4.2/chrono/\" rel=\"noreferrer\">chrono crate</a>. The dates and times are from a website in which the date and time are from different sections of the page.</p>\n\n<p>The date is shown in the format <code>%d/%m/%Y</code> (example: 27/08/2018). The time is shown with only the hour (example: 12, 10, 21, etc.)</p>\n\n<p>I want to store these datetimes as UTC so that I can compute time remaining until a given datetime from now in a \"timezone agnostic\" way. I know which timezone these datetimes are from (Paris time).</p>\n\n<p>I created a <code>NaiveDate</code> from the date input (this is a work in progress so there's no error handling yet):</p>\n\n<pre><code>let naive_date = NaiveDate::parse_from_str(date, \"%d/%m/%Y\").unwrap()\n</code></pre>\n\n<p>From that point on, what would be the best way to get the UTC <code>DateTime</code>, given that I have a string with the hour? </p>\n\n<p>I am lost in the various <code>TimeZone</code>/<code>Offset</code> traits, and do not know if I should use a <code>Local</code>, or <code>FixedOffset</code> and then convert to <code>Utc</code>. </p>\n"}, {"tags": ["http", "rust"], "answers": [{"tags": [], "owner": {"reputation": 1940, "user_id": 3134655, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/neEAG.jpg?s=128&g=1", "display_name": "Gomiero", "link": "https://stackoverflow.com/users/3134655/gomiero"}, "is_accepted": true, "score": 6, "last_activity_date": 1585062235, "last_edit_date": 1585062235, "creation_date": 1526187290, "answer_id": 50312897, "question_id": 50312240, "link": "https://stackoverflow.com/questions/50312240/why-does-a-http-get-request-with-vanilla-rust-get-no-answer/50312897#50312897", "title": "Why does a HTTP GET request with vanilla Rust get no answer?", "body": "<p>You should pass the <code>Connection: close</code> HTTP header so the server can properly close the connection.</p>\n\n<p>Note that Google will returns compressed content, so you'll get an error: <strong>err = stream did not contain valid UTF-8</strong>, even sending the header <code>Accept-Encoding: identity</code>.</p>\n\n<p>Testing with the host changed to <em>www.rust-lang.org</em>:</p>\n\n<pre><code>use std::io::Read;\nuse std::io::Result;\nuse std::io::Write;\nuse std::net::TcpStream;\n\nfn main() {\n    if let Err(err) = connect() {\n        println!(\"err = {}\", err);\n    }\n}\n\nfn connect() -&gt; Result&lt;()&gt; {\n    let mut stream = TcpStream::connect(\"www.rust-lang.org:80\")?;\n\n    let mut request_data = String::new();\n    request_data.push_str(\"GET / HTTP/1.0\");\n    request_data.push_str(\"\\r\\n\");\n    request_data.push_str(\"Host: www.rust-lang.org\");\n    request_data.push_str(\"\\r\\n\");\n    request_data.push_str(\"Connection: close\"); // &lt;== Here!\n    request_data.push_str(\"\\r\\n\");\n    request_data.push_str(\"\\r\\n\");\n\n    println!(\"request_data = {:?}\", request_data);\n\n    let request = stream.write_all(request_data.as_bytes())?;\n    println!(\"request = {:?}\", request);\n\n    let mut buf = String::new();\n    let result = stream.read_to_string(&amp;mut buf)?;\n    println!(\"result = {}\", result);\n    println!(\"buf = {}\", buf);\n\n    Ok(())\n}\n</code></pre>\n\n<p>Will result in:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>request_data = \"GET / HTTP/1.0\\r\\nHost: www.rust-lang.org\\r\\nConnection: close\\r\\n\\r\\n\"\nrequest = ()\nresult = 554\nbuf = HTTP/1.1 301 Moved Permanently\nServer: CloudFront\nDate: Sun, 13 May 2018 04:46:00 GMT\nContent-Type: text/html\nContent-Length: 183\nConnection: close\nLocation: https://www.rust-lang.org/\nX-Cache: Redirect from cloudfront\nVia: 1.1 17af5476e6187c3063f9ba7f797d342b.cloudfront.net (CloudFront)\nX-Amz-Cf-Id: lzMymVQ6vTv27VxSU4J0MR6EmgPDCDqO8KFimo1kPvxmQxcKjT33jg==\n\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;\n&lt;body bgcolor=\"white\"&gt;\n&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;CloudFront&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n"}], "owner": {"reputation": 1567, "user_id": 2628048, "user_type": "registered", "accept_rate": 42, "profile_image": "https://i.stack.imgur.com/1pVHc.jpg?s=128&g=1", "display_name": "Rudolf Schmidt", "link": "https://stackoverflow.com/users/2628048/rudolf-schmidt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 876, "favorite_count": 0, "accepted_answer_id": 50312897, "answer_count": 1, "score": 4, "last_activity_date": 1585062235, "creation_date": 1526178486, "last_edit_date": 1585062187, "question_id": 50312240, "link": "https://stackoverflow.com/questions/50312240/why-does-a-http-get-request-with-vanilla-rust-get-no-answer", "title": "Why does a HTTP GET request with vanilla Rust get no answer?", "body": "<p>I have the following code but when I start the app it requests the page but gets no answer.</p>\n\n<pre><code>use std::io::Read;\nuse std::io::Result;\nuse std::io::Write;\nuse std::net::TcpStream;\n\nfn main() {\n    if let Err(err) = connect() {\n        println!(\"err = {}\", err);\n    }\n}\n\nfn connect() -&gt; Result&lt;()&gt; {\n    let mut stream = TcpStream::connect(\"www.google.de:80\")?;\n\n    let mut request_data = String::new();\n    request_data.push_str(\"GET / HTTP/1.1\");\n    request_data.push_str(\"\\r\\n\");\n    request_data.push_str(\"Host: www.google.de\");\n    request_data.push_str(\"\\r\\n\");\n    request_data.push_str(\"\\r\\n\");\n    println!(\"request_data = {:?}\", request_data);\n\n    let request = stream.write_all(request_data.as_bytes())?;\n    println!(\"request = {:?}\", request);\n\n    let mut buf = String::new();\n    let result = stream.read_to_string(&amp;mut buf)?;\n    println!(\"result = {}\", result);\n    println!(\"buf = {}\", buf);\n\n    Ok(())\n}\n</code></pre>\n"}, {"tags": ["rust", "automated-tests", "documentation", "conditional-compilation"], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 8, "last_activity_date": 1526227506, "last_edit_date": 1526227506, "creation_date": 1526205870, "answer_id": 50314936, "question_id": 50312190, "link": "https://stackoverflow.com/questions/50312190/how-can-i-conditionally-execute-a-module-level-doctest-based-on-a-feature-flag/50314936#50314936", "title": "How can I conditionally execute a module-level doctest based on a feature flag?", "body": "<p>I only see one solution: put the <code>#[cfg]</code> inside the test:</p>\n\n<pre><code>//! ```\n//! #[cfg(feature = \"solve_halting_problem\")]\n//! assert!(featureful::is_p_equal_to_np());\n//! ```\n</code></pre>\n\n<p>This will count as a test but it will be empty when the feature is not enabled. You can pair this with the ability to <a href=\"https://doc.rust-lang.org/rustdoc/documentation-tests.html#hiding-portions-of-the-example\" rel=\"noreferrer\">hide portions of the example</a> and the fact that you can put the <code>#[cfg]</code> attribute on entire blocks as well:</p>\n\n<pre><code>//! ```\n//! # #[cfg(feature = \"solve_halting_problem\")] {\n//! assert!(featureful::is_p_equal_to_np());\n//! // Better double check\n//! assert!(featureful::is_p_equal_to_np());\n//! # }\n//! ```\n</code></pre>\n\n<hr>\n\n<p>As a note, maybe you could use <a href=\"https://doc.rust-lang.org/rustdoc/unstable-features.html#documenting-platform-feature-specific-information\" rel=\"noreferrer\"><code>#![feature(doc_cfg)]</code></a> like this:</p>\n\n<pre><code>/// This function is super useful\n///\n/// ```\n/// assert!(featureful::is_p_equal_to_np());\n/// ```\n#[cfg(any(feature = \"solve_halting_problem\", feature = \"dox\"))]\n#[doc(cfg(feature = \"solve_halting_problem\"))]\npub fn is_p_equal_to_np() -&gt; bool {\n    true\n}\n</code></pre>\n\n<p>This will not run the test when the feature is disabled but this will generate the doc with <code>cargo doc --features dox</code>.</p>\n"}], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 628, "favorite_count": 0, "accepted_answer_id": 50314936, "answer_count": 1, "score": 8, "last_activity_date": 1526227506, "creation_date": 1526177867, "last_edit_date": 1526178759, "question_id": 50312190, "link": "https://stackoverflow.com/questions/50312190/how-can-i-conditionally-execute-a-module-level-doctest-based-on-a-feature-flag", "title": "How can I conditionally execute a module-level doctest based on a feature flag?", "body": "<p>I am writing documentation for a module that has some options controlled by a Cargo feature flag. I'd like to always show this documentation so that consumers of the crate know that it's available, but I need to only run the example when the feature is enabled.</p>\n\n<h3>lib.rs</h3>\n\n<pre><code>//! This crate has common utility functions\n//!\n//! ```\n//! assert_eq!(2, featureful::add_one(1));\n//! ```\n//!\n//! You may also want to use the feature flag `solve_halting_problem`:\n//!\n//! ```\n//! assert!(featureful::is_p_equal_to_np());\n//! ```\n\npub fn add_one(a: i32) -&gt; i32 {\n    a + 1\n}\n\n#[cfg(feature = \"solve_halting_problem\")]\npub fn is_p_equal_to_np() -&gt; bool {\n    true\n}\n</code></pre>\n\n<h3>Cargo.toml</h3>\n\n<pre><code>[package]\nname = \"featureful\"\nversion = \"0.1.0\"\nauthors = [\"An Devloper &lt;an.devloper@example.com&gt;\"]\n\n[features]\nsolve_halting_problem = []\n\n[dependencies]\n</code></pre>\n\n<hr>\n\n<p>Running with the feature enabled runs both doctests as expected:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ cargo test --features=solve_halting_problem\n   Doc-tests featureful\n\nrunning 2 tests\ntest src/lib.rs -  (line 7) ... ok\ntest src/lib.rs -  (line 3) ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n</code></pre>\n\n<p>Running without the feature has an error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ cargo test\n   Doc-tests featureful\n\nrunning 2 tests\ntest src/lib.rs -  (line 7) ... FAILED\ntest src/lib.rs -  (line 3) ... ok\n\nfailures:\n\n---- src/lib.rs -  (line 7) stdout ----\n    error[E0425]: cannot find function `is_p_equal_to_np` in module `featureful`\n --&gt; src/lib.rs:8:21\n  |\n4 | assert!(featureful::is_p_equal_to_np());\n  |                     ^^^^^^^^^^^^^^^^ not found in `featureful`\n</code></pre>\n\n<p>Both the <code>```ignore</code> and <code>```no_run</code>  modifiers apply  when the feature is enabled or not, so they don't seem to be useful.</p>\n\n<hr>\n\n<p><a href=\"https://stackoverflow.com/q/38292741/155423\">How would one achieve conditional compilation with Rust projects that have doctests?</a> is close, but the answer focuses on <em>functions</em> that change with conditional compilation, not on documentation of <em>modules</em>.</p>\n"}, {"tags": ["ios", "rust"], "answers": [{"comments": [{"owner": {"reputation": 647, "user_id": 5429050, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/da7e1d765858cc119fc86fa3e48e410b?s=128&d=identicon&r=PG", "display_name": "Hossein Noroozpour", "link": "https://stackoverflow.com/users/5429050/hossein-noroozpour"}, "edited": false, "score": 0, "creation_date": 1526358565, "post_id": 50341023, "comment_id": 87700559, "body": "I knew that, and currently using it in my project <a href=\"https://github.com/Hossein-Noroozpour/vulkust\" rel=\"nofollow noreferrer\">github.com/Hossein-Noroozpour/vulkust</a> but this could be a great help in my project design, because I don&#39;t like to do much in outside of Rust (for example, I have written a pure Rust Android Glue in my project) and finally I believe that there is a hacking way around this problem, but I&#39;m not very familiar with Apple technologies."}], "tags": [], "owner": {"reputation": 90851, "user_id": 27009, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/f0a29af415477aa8c498a4f41ffe6640?s=128&d=identicon&r=PG", "display_name": "Kornel", "link": "https://stackoverflow.com/users/27009/kornel"}, "is_accepted": false, "score": 1, "last_activity_date": 1526347076, "creation_date": 1526347076, "answer_id": 50341023, "question_id": 50309551, "link": "https://stackoverflow.com/questions/50309551/how-to-create-an-ipa-file-with-a-prebuilt-binary/50341023#50341023", "title": "How to create an .ipa file with a prebuilt binary?", "body": "<p>Apple's tooling for App Store is going to be a pain to reproduce outside Xcode. </p>\n\n<p>To use Rust in App Store programs it's best to make a minimal regular C/ObjC Xcode project, and add Rust code to it via a static library.</p>\n\n<ol>\n<li>Add <code>crate-type = [\"staticlib\"]</code> to Cargo.toml</li>\n<li>Add external build system to your Xcode project, make it run cargo </li>\n<li>Add static library produced by Cargo to libraries linked in your project</li>\n<li>Add <code>#[no_mangle] extern fn</code> functions to your code to be able to call them from C.</li>\n<li>Use cbindgen or create header file manually for your functions from Rust</li>\n<li>Call them.</li>\n</ol>\n\n<p><a href=\"https://github.com/sindresorhus/gifski-app\" rel=\"nofollow noreferrer\">https://github.com/sindresorhus/gifski-app</a> is an example that does this.</p>\n"}], "owner": {"reputation": 647, "user_id": 5429050, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/da7e1d765858cc119fc86fa3e48e410b?s=128&d=identicon&r=PG", "display_name": "Hossein Noroozpour", "link": "https://stackoverflow.com/users/5429050/hossein-noroozpour"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 111, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1526347076, "creation_date": 1526150417, "last_edit_date": 1526315442, "question_id": 50309551, "link": "https://stackoverflow.com/questions/50309551/how-to-create-an-ipa-file-with-a-prebuilt-binary", "title": "How to create an .ipa file with a prebuilt binary?", "body": "<p>I have created an executable binary file outside of XCode via the Rust compiler, but I do not have any clue how to create the .ipa file.</p>\n\n<p>If it is possible, I would also like to debug that binary via XCode.</p>\n"}, {"tags": ["rust", "traits"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526145530, "post_id": 50308773, "comment_id": 87633625, "body": "You can&#39;t use <code>self.x</code> and <code>self.y</code> inside the default trait implementation, because some implementation of the trait <i>might</i> not have those fields."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526145536, "post_id": 50308773, "comment_id": 87633627, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/28219730/155423\">Is it possible to access struct fields from within a trait?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50308773/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1526145915, "post_id": 50308773, "comment_id": 87633735, "body": "The other problem is that you are trying to use <code>Type</code> as a constructor, but the compiler can&#39;t know what the constructor looks like for every possible concrete type there. In fact, even if that was allowed, your code would break for <code>Spider</code> because <code>ticks_alive</code> is  missing."}], "owner": {"reputation": 125, "user_id": 5862030, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/c3ea28fa33abc07ba4b55ca26c4ad35c?s=128&d=identicon&r=PG&f=1", "display_name": "KuSpa", "link": "https://stackoverflow.com/users/5862030/kuspa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 78, "favorite_count": 0, "closed_date": 1526154880, "answer_count": 0, "score": 0, "last_activity_date": 1526145199, "creation_date": 1526144934, "last_edit_date": 1526145199, "question_id": 50308773, "link": "https://stackoverflow.com/questions/50308773/how-do-i-use-instance-variables-of-generic-structs-in-traits", "closed_reason": "Duplicate", "title": "How do I use instance variables of generic structs in traits?", "body": "<p>I have a snake game with 2 types of food:</p>\n\n<p>The <code>Fly</code>:</p>\n\n<pre><code> struct Fly {\n    x: u32,\n    y: u32,\n}\n</code></pre>\n\n<p>And the <code>Spider</code>, which disappears if not eaten in time:</p>\n\n<pre><code>struct Spider {\n    x: u32,\n    y: u32,\n    ticks_alive: i32,\n}\n</code></pre>\n\n<p>I want them to have some convenient methods like <code>position(&amp;self) -&gt; (u32, u32)</code> or <code>proxy() -&gt; SpiderOrFly</code>: </p>\n\n<pre><code>pub trait Food&lt;Type&gt; {\n    fn position(&amp;self) -&gt; (u32, u32) {\n        (self.x, self.y)\n    }\n\n    fn proxy() -&gt; Type {\n        Type { x: 0, y: 0 }\n    }\n}\n</code></pre>\n\n<p>I'm getting errors that <code>x</code> is not a field of <code>&amp;self</code> and that <code>Type</code> is not a struct</p>\n\n<p>Is there a way to tell Rust that <code>Type</code> has to be <code>Fly</code> or <code>Spider</code> so that I can access the instance variables in the generic implementation and don't have to produce doubled code?</p>\n"}, {"tags": ["rust", "variadic"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526135728, "post_id": 50306894, "comment_id": 87630649, "body": "&quot;I need to be able to pass in n arguments, with n being determined at run time, so this method of hard coding isn&#39;t practical.&quot;, not clear what you ask here, C standard don&#39;t allow such thing."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 6, "last_activity_date": 1526142028, "last_edit_date": 1592644375, "creation_date": 1526139695, "answer_id": 50307983, "question_id": 50306894, "link": "https://stackoverflow.com/questions/50306894/how-do-i-pass-each-element-of-a-slice-as-a-separate-argument-to-a-variadic-c-fun/50307983#50307983", "title": "How do I pass each element of a slice as a separate argument to a variadic C function?", "body": "<p>You <em>don't</em>, at least not yet, and I'd wager probably never.</p>\n<p>To be able to do this, you'd need two key abilities, both of which are outside of your control:</p>\n<ol>\n<li><p>Redis needs to provide a function that accepts a <code>va_list</code> argument, not just a <code>...</code>.</p>\n<p>It's strange that Redis doesn't already provide such a function, but perhaps this is a sign that other people implementing modules avoid the problem entirely.</p>\n</li>\n<li><p>Rust needs to provide a way to construct the <code>va_list</code> argument.</p>\n<p>While it looks like <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/2137-variadic.md\" rel=\"noreferrer\">RFC 2137</a> will introduce a <code>VaList</code> type, the proposed API does not provide a way to create one <em>or</em> set values in it.</p>\n</li>\n</ol>\n<p>Note that you <a href=\"https://stackoverflow.com/q/988290/155423\">can't do what you want, even in C</a> (at least not easily or portably).</p>\n<hr />\n<p>What can you do instead? Assuming that you are implementing the code that consumes the variadic arguments, you can remove the variation from your call. A collection of items in C is just a pointer and a length, so pass that instead:</p>\n<pre><code>extern &quot;C&quot; {\n    fn call(n_args: i32, ...);\n}\n\nfn x(args: &amp;[i32]) {\n    unsafe { call(2, args.len(), args.as_ptr()) };\n}\n</code></pre>\n<p>If you didn't have control of what reads the code on the other side, one possible (read: <em>terrible</em>) idea is to pattern match on some &quot;large enough&quot; subset of the slice and dispatch off to the variadic function:</p>\n<pre><code>extern &quot;C&quot; {\n    fn call(n_args: i32, ...);\n}\n\nfn x(args: &amp;[i32]) {\n    unsafe {\n        match args {\n            [] =&gt; call(0),\n            [a] =&gt; call(1, a),\n            [a, b] =&gt; call(2, a, b),\n            _ =&gt; panic!(&quot;Didn't implement this yet&quot;),\n        }\n    }\n}\n</code></pre>\n<p>See also:</p>\n<ul>\n<li><a href=\"https://stackoverflow.com/q/40432364/155423\">How to wrap a call to a FFI function that uses VarArgs in Rust?</a></li>\n<li><a href=\"https://stackoverflow.com/q/988290/155423\">Populating a va_list</a></li>\n<li><a href=\"https://stackoverflow.com/q/150543/155423\">Forward an invocation of a variadic function in C</a></li>\n</ul>\n"}], "owner": {"reputation": 1063, "user_id": 1657433, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/fec0a5332c6c0ce0bb6d2a30c0e3829d?s=128&d=identicon&r=PG", "display_name": "stockholmux", "link": "https://stackoverflow.com/users/1657433/stockholmux"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 404, "favorite_count": 0, "accepted_answer_id": 50307983, "answer_count": 1, "score": 3, "last_activity_date": 1526142028, "creation_date": 1526132707, "last_edit_date": 1526138101, "question_id": 50306894, "link": "https://stackoverflow.com/questions/50306894/how-do-i-pass-each-element-of-a-slice-as-a-separate-argument-to-a-variadic-c-fun", "title": "How do I pass each element of a slice as a separate argument to a variadic C function?", "body": "<p>I'm building a Redis Module in Rust. I've found some good examples, but I'm stuck when dealing with interfacing a C function that is supposed to accept variadic arguments. </p>\n\n<p>The Redis Module C SDK has a function called <code>RedisModule_Call</code> which accepts a few specific arguments then <code>n</code> arguments that represent a Redis command. From the <a href=\"https://redis.io/topics/modules-intro#calling-redis-commands\" rel=\"nofollow noreferrer\">Redis Module SDK</a> documentation (in C):</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>RedisModuleCallReply *reply;\nreply = RedisModule_Call(ctx,\"INCR\",\"sc\",argv[1],\"10\");\n</code></pre>\n\n<p><code>RedisModule_Call</code>'s first three arguments are specific, but the rest represent Redis commands that could easily have hundreds of arguments.</p>\n\n<p>In Rust, I'm following the patterns in <a href=\"https://github.com/brandur/redis-cell\" rel=\"nofollow noreferrer\">Redis-Cell</a> which is a Redis module implemented (successfully) in Rust. The module is fantastic but has a very limited way of dealing with this particular problem. Effectively, it accepts up to three arguments in a somewhat brute force way:</p>\n\n<pre><code>pub fn call(&amp;self, command: &amp;str, args: &amp;[&amp;str]) -&gt; Result&lt;Reply, CellError&gt; {\n   // ... code ... \n   let raw_reply = match args.len() {\n        1 =&gt; raw::call1::call(/* ... */),\n        2 =&gt; raw::call2::call(/* ... */),\n        // ...\n</code></pre>\n\n<p>These <code>call1</code> and <code>call2</code> functions are practically just stubs that handle the different argument lengths:</p>\n\n<pre><code>pub mod call2 {\n    use redis::raw;\n\n    pub fn call(\n        ctx: *mut raw::RedisModuleCtx,\n        cmdname: *const u8,\n        fmt: *const u8,\n        arg0: *mut raw::RedisModuleString,\n        arg1: *mut raw::RedisModuleString,\n    ) -&gt; *mut raw::RedisModuleCallReply {\n        unsafe { RedisModule_Call(ctx, cmdname, fmt, arg0, arg1) }\n    }\n\n    #[allow(improper_ctypes)]\n    extern \"C\" {\n        pub static RedisModule_Call: extern \"C\" fn(\n            ctx: *mut raw::RedisModuleCtx,\n            cmdname: *const u8,\n            fmt: *const u8,\n            arg0: *mut raw::RedisModuleString,\n            arg1: *mut raw::RedisModuleString,\n        ) -&gt; *mut raw::RedisModuleCallReply;\n    }\n}\n</code></pre>\n\n<p>I need to be able to pass in <code>n</code> arguments, with <code>n</code> being determined at run time, so this method of hard coding isn't practical. I know Rust has limited support for variadic functions and I've been doing some reading about RFC 2137, but I'm not sure this applies. </p>\n\n<p>I'm looking for a way to apply an argument vector to the end of <code>RedisModule_Call</code> or something like a spread syntax for the arguments. I'm relatively new to Rust but I've searched and searched and I can't seem to find any way to scratch this itch in Rust.</p>\n\n<p>To clarify - I can pass arguments into <code>RedisModule_Call</code> (which is variadic) no problem, but I can't find a syntactical way to pass in a variable number of arguments in Rust into the C function. What I'm trying to accomplish is something like this:</p>\n\n<pre><code>impl Redis {\n    pub fn call(&amp;self, command: &amp;str, args: &amp;[&amp;str]) -&gt; Result&lt;Reply, CellError&gt; {\n        /* ... */\n\n       unsafe { RedisModule_Call(ctx, cmdname, fmt, ...args) }\n       /* ... */ \n</code></pre>\n\n<p>Where <code>...args</code> is some sort of black magic to that would allow args to represent 1 argument or 100 which would be the equivalent of <code>RedisModule_Call(ctx, cmdname, fmt, args[0], args[1] /* ... and so on */)</code>.</p>\n"}, {"tags": ["windows", "rust", "port", "rust-rocket"], "answers": [{"tags": [], "owner": {"reputation": 23600, "user_id": 1695172, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/6319d7eafca7852cf04c88598ca31e75?s=128&d=identicon&r=PG", "display_name": "Netwave", "link": "https://stackoverflow.com/users/1695172/netwave"}, "is_accepted": true, "score": 0, "last_activity_date": 1526088470, "last_edit_date": 1526088470, "creation_date": 1526069188, "answer_id": 50299527, "question_id": 50298681, "link": "https://stackoverflow.com/questions/50298681/rocket-port-override-from-environment-variable-not-working-in-windows/50299527#50299527", "title": "Rocket port override from environment variable not working in Windows", "body": "<p>Setting the variable like this did the trick:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$Env:ROCKET_PORT=4444\n</code></pre>\n"}], "owner": {"reputation": 23600, "user_id": 1695172, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/6319d7eafca7852cf04c88598ca31e75?s=128&d=identicon&r=PG", "display_name": "Netwave", "link": "https://stackoverflow.com/users/1695172/netwave"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 460, "favorite_count": 0, "accepted_answer_id": 50299527, "answer_count": 1, "score": 1, "last_activity_date": 1526088470, "creation_date": 1526065315, "last_edit_date": 1526088458, "question_id": 50298681, "link": "https://stackoverflow.com/questions/50298681/rocket-port-override-from-environment-variable-not-working-in-windows", "title": "Rocket port override from environment variable not working in Windows", "body": "<p>I'm trying to run a rocket-rs application while overriding the port configuration using environment variables as described in the <a href=\"https://rocket.rs/guide/configuration/#environment-variables\" rel=\"nofollow noreferrer\">documentation</a>.</p>\n\n<p>I've set the variable <code>ROCKET_PORT</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>setx ROCKET_PORT 4444\n</code></pre>\n\n<p>I've checked it was set with an <code>echo</code>. When I run the application (with either <code>cargo run</code> or <code>./application.exe</code>) it still uses port 8000:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>\ud83d\udd27  Configured for development.\n    =&gt; address: localhost\n    =&gt; port: 8000\n    =&gt; log: normal\n    =&gt; workers: 16\n    =&gt; secret key: generated\n    =&gt; limits: forms = 32KiB\n    =&gt; tls: disabled\n\ud83d\udef0  Mounting '/':\n    =&gt; GET /mine\n    =&gt; POST /transactions/new application/json\n    =&gt; GET /chain\n    =&gt; GET /nodes/resolve\n    =&gt; POST /nodes/register application/json\n\ud83d\ude80  Rocket has launched from http://localhost:8000\n</code></pre>\n\n<p>I know the port can be configured in <code>Rocket.toml</code>, but the idea is to be able to run in a different port for each console session by setting the environment variable.</p>\n\n<p>Why would this not be working?</p>\n"}, {"tags": ["macros", "rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526055126, "post_id": 50296196, "comment_id": 87609451, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/33751796/is-there-a-way-to-count-with-macros\">Is there a way to count with macros?</a>"}, {"owner": {"reputation": 452, "user_id": 4990191, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-uzhV4XNdp2U/AAAAAAAAAAI/AAAAAAAAAvo/6tbSDTYrDOg/photo.jpg?sz=128", "display_name": "Zz Tux", "link": "https://stackoverflow.com/users/4990191/zz-tux"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526055813, "post_id": 50296196, "comment_id": 87609791, "body": "@Stargateur No, these problems are totally different."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526055856, "post_id": 50296196, "comment_id": 87609813, "body": "I do not think this is a duplicate of &quot;Is there a way to count with macros?&quot; The code has already solved how to count (for some form of counting), but the problem occurs after that."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526055899, "post_id": 50296196, "comment_id": 87609840, "body": "What is also strange is that the same code works if the generic type is replaced with a concrete one, such as <code>i32</code>."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1526056358, "post_id": 50296196, "comment_id": 87610089, "body": "@ZzTux well, your very first question was &quot;How to specify array size by macro in Rust?&quot;, but I let the link it&#39;s maybe just related."}, {"owner": {"reputation": 452, "user_id": 4990191, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-uzhV4XNdp2U/AAAAAAAAAAI/AAAAAAAAAvo/6tbSDTYrDOg/photo.jpg?sz=128", "display_name": "Zz Tux", "link": "https://stackoverflow.com/users/4990191/zz-tux"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1526056607, "post_id": 50296196, "comment_id": 87610210, "body": "@Shepmaster <a href=\"https://play.rust-lang.org/?gist=49f0c890c0fc8998f2985174990db9ee&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">It works on non-generic type as you said.</a> Maybe this is a compiler bug? Should I open an issue on Github?"}, {"owner": {"reputation": 97030, "user_id": 189205, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c60305494593d556e57a3cf8e4a8c163?s=128&d=identicon&r=PG", "display_name": "interjay", "link": "https://stackoverflow.com/users/189205/interjay"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1526059125, "post_id": 50296196, "comment_id": 87611397, "body": "@Shepmaster It seems to fail when the struct is generic, even if the array element type is concrete. <a href=\"https://play.rust-lang.org/?gist=b058f3b36f5a8b070857b873c0840543&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">You don&#39;t even need arrays.</a>"}, {"owner": {"reputation": 452, "user_id": 4990191, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-uzhV4XNdp2U/AAAAAAAAAAI/AAAAAAAAAvo/6tbSDTYrDOg/photo.jpg?sz=128", "display_name": "Zz Tux", "link": "https://stackoverflow.com/users/4990191/zz-tux"}, "edited": false, "score": 0, "creation_date": 1526093232, "post_id": 50296196, "comment_id": 87621250, "body": "I opened an issue on Github: <a href=\"https://github.com/rust-lang/rust/issues/50676\" rel=\"nofollow noreferrer\">github.com/rust-lang/rust/issues/50676</a>"}], "answers": [{"comments": [{"owner": {"reputation": 452, "user_id": 4990191, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-uzhV4XNdp2U/AAAAAAAAAAI/AAAAAAAAAvo/6tbSDTYrDOg/photo.jpg?sz=128", "display_name": "Zz Tux", "link": "https://stackoverflow.com/users/4990191/zz-tux"}, "edited": false, "score": 0, "creation_date": 1526111320, "post_id": 50296888, "comment_id": 87624385, "body": "This doesn&#39;t work if I replace foo!(1) with foo!(my_macro!())."}], "tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 1, "last_activity_date": 1526058037, "last_edit_date": 1526058037, "creation_date": 1526057442, "answer_id": 50296888, "question_id": 50296196, "link": "https://stackoverflow.com/questions/50296196/how-can-i-use-derive-on-a-type-containing-an-array-where-the-length-is-specif/50296888#50296888", "title": "How can I use #[derive] on a type containing an array where the length is specified by a macro?", "body": "<p>A solution could be to use two macros, one macro that defines the struct and another macro that defines the size.</p>\n\n<pre><code>macro_rules! foo {\n    ($x:expr) =&gt; {\n        #[derive(Debug)]\n        struct MyStruct&lt;T&gt; {\n            field_list: [T; $x],\n        }\n    };\n}\n\nmacro_rules! bar {\n    () =&gt; {\n        foo!(1);\n    };\n}\n\nbar!();\n</code></pre>\n\n<hr>\n\n<blockquote>\n  <p><a href=\"https://play.rust-lang.org/?gist=49f0c890c0fc8998f2985174990db9ee&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">It works on non-generic type as you said.</a> Maybe this is a compiler bug? Should I open an issue on Github?</p>\n</blockquote>\n\n<p>This is probably not a bug, but certainly a limitation of macros. You could however open an issue to ask to improve it.</p>\n"}, {"tags": [], "owner": {"reputation": 1295, "user_id": 1114328, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d211889b453feb9210d9645cbcfd524e?s=128&d=identicon&r=PG", "display_name": "durka42", "link": "https://stackoverflow.com/users/1114328/durka42"}, "is_accepted": true, "score": 3, "last_activity_date": 1526270332, "last_edit_date": 1526270332, "creation_date": 1526268345, "answer_id": 50322720, "question_id": 50296196, "link": "https://stackoverflow.com/questions/50296196/how-can-i-use-derive-on-a-type-containing-an-array-where-the-length-is-specif/50322720#50322720", "title": "How can I use #[derive] on a type containing an array where the length is specified by a macro?", "body": "<p>Quoting my answer from the Github issue:</p>\n\n<blockquote>\n  <p>It is intentional (here is the <a href=\"https://github.com/rust-lang/rust/pull/33769\" rel=\"nofollow noreferrer\">historical\n  record</a>), but there is a\n  possibility the situation could be improved in the future, and at\n  least the error message should be rewritten to explain why it refuses\n  to compile.</p>\n  \n  <p>The underlying issue is that <code>#[derive]</code> macros need to \"forward\"\n  their trait requirements to all the fields of the struct. For\n  <code>MyStruct</code> to be <code>Debug</code>, the type of <code>field</code> must also be <code>Debug</code>.\n  Consider this one:</p>\n\n<pre><code>#[derive(Debug)] struct MyStruct&lt;T: FromStr&gt; {\n    field: T\n}\n</code></pre>\n  \n  <p>We need to generate <code>impl&lt;T: FromStr&gt; Debug for MyStruct&lt;T&gt; where T:\n  Debug { ... }</code> (you'll see why I picked\n  <a href=\"https://doc.rust-lang.org/std/str/trait.FromStr.html\" rel=\"nofollow noreferrer\"><code>FromStr</code></a> in a\n  second). However in this case:</p>\n\n<pre><code>#[derive(Debug)] struct MyStruct&lt;T&gt; {\n    field: T::Err\n}\n</code></pre>\n  \n  <p>Here the field is an associated type, so the generated code actually\n  needs to be <code>impl&lt;T: FromStr&gt; Debug for MyStruct&lt;T&gt; where T::Err:\n  Debug { ... }</code>.</p>\n  \n  <p>The derive macros actually scan the field types to see whether they\n  need to bound <code>T</code> or an associated type. But if you use a type macro,\n  this breaks. The code generation can't see through the macro, so it\n  doesn't know what bounds to generate.</p>\n  \n  <p>When this was discovered we couldn't decide whether to let the type\n  macro be expanded eagerly (seems like you could get into a loop or\n  ordering issues), just copy the macro into the <code>where</code> clause (derives\n  normally don't do this because it could expand to a private type,\n  causing type errors in generated code), or <a href=\"https://github.com/rust-lang/rfcs/pull/1671\" rel=\"nofollow noreferrer\">something\n  else</a>, so we punted and\n  made it an error.</p>\n</blockquote>\n\n<p>The problem can't really be fixed while obeying the \"policies\" of deriving: (1) it generates the bounds for you, and (2) it only generates code that compiles. But since custom derive is stable, there are crates you can use, like <a href=\"https://crates.io/crates/derivative\" rel=\"nofollow noreferrer\">derivative</a>, that sidestep the problem by letting you rewrite the bound:</p>\n\n<pre><code>#[derive(Derivative)]\n#[derivative(Debug)]\nstruct MyStruct&lt;T&gt; {\n    #[derivative(Debug(bound=\"T: ::std::fmt::Debug\"))]\n    field_list: [T; count!()],\n}\n</code></pre>\n"}], "owner": {"reputation": 452, "user_id": 4990191, "user_type": "registered", "accept_rate": 100, "profile_image": "https://lh6.googleusercontent.com/-uzhV4XNdp2U/AAAAAAAAAAI/AAAAAAAAAvo/6tbSDTYrDOg/photo.jpg?sz=128", "display_name": "Zz Tux", "link": "https://stackoverflow.com/users/4990191/zz-tux"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 203, "favorite_count": 0, "accepted_answer_id": 50322720, "answer_count": 2, "score": 5, "last_activity_date": 1526270332, "creation_date": 1526054639, "last_edit_date": 1526055668, "question_id": 50296196, "link": "https://stackoverflow.com/questions/50296196/how-can-i-use-derive-on-a-type-containing-an-array-where-the-length-is-specif", "title": "How can I use #[derive] on a type containing an array where the length is specified by a macro?", "body": "<p>I have this code:</p>\n\n<pre><code>macro_rules! count {\n    () =&gt; { 1 };\n}\n\n#[derive(Debug)]\nstruct MyStruct&lt;T&gt; {\n    field_list: [T; count!()],\n}\n</code></pre>\n\n<p>The compiler gives this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: `derive` cannot be used on items with type macros\n --&gt; src/main.rs:7:21\n  |\n7 |     field_list: [T; count!()],\n  |                     ^^^^^^^^\n</code></pre>\n\n<p>Is there any way to use <code>#[derive]</code> on a type containing an array where the length is specified by a macro?</p>\n"}, {"tags": ["image", "rust", "rust-crates", "rust-piston"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1526039994, "post_id": 50291821, "comment_id": 87599837, "body": "open on issue on the github would be more logical, SO is not a support service... the doc is updated, <a href=\"https://docs.rs/image/0.19.0/image/struct.ImageBuffer.html#method.save\" rel=\"nofollow noreferrer\">docs.rs/image/0.19.0/image/struct.ImageBuffer.html#method.sa&zwnj;&#8203;ve</a>."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1526040387, "post_id": 50291821, "comment_id": 87600118, "body": "Please provide a more adequate <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. Content behind links are very likely to change in the future. What&#39;s important here: all relevant dependencies&#39; versions in use, plus a minimal version of that example <i>in the question itself</i>. If the compiler error can be reproduced in the <a href=\"//play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a>, that is a plus."}, {"owner": {"reputation": 1, "user_id": 8151428, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6028b5d07994ecdb8abb1abe105f979f?s=128&d=identicon&r=PG&f=1", "display_name": "TC29", "link": "https://stackoverflow.com/users/8151428/tc29"}, "edited": false, "score": 0, "creation_date": 1526044172, "post_id": 50291821, "comment_id": 87602422, "body": "Sorry Stargateur ! I am a newbie here  and did not know I am not supposed to ask this kind of question. Thank you for the link."}, {"owner": {"reputation": 1, "user_id": 8151428, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6028b5d07994ecdb8abb1abe105f979f?s=128&d=identicon&r=PG&f=1", "display_name": "TC29", "link": "https://stackoverflow.com/users/8151428/tc29"}, "edited": false, "score": 0, "creation_date": 1526045031, "post_id": 50291821, "comment_id": 87602962, "body": "Thank you E_net4! Rust playground gave me the same error as in my comments. It seems that the code in example on <a href=\"https://github.com/PistonDevelopers/image\" rel=\"nofollow noreferrer\">github.com/PistonDevelopers/image</a> was not up to date."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1526069070, "post_id": 50291821, "comment_id": 87615717, "body": "I actually ran the example on the <code>master</code> branch and it compiled and ran just fine. There is probably something different going on in your build. Consider editing your question with all the necessary details, for there&#39;s still a chance that it could be salvaged."}], "answers": [{"tags": [], "owner": {"reputation": 1318, "user_id": 5329711, "user_type": "registered", "accept_rate": 46, "profile_image": "https://i.stack.imgur.com/8KGqg.gif?s=128&g=1", "display_name": "madeinQuant", "link": "https://stackoverflow.com/users/5329711/madeinquant"}, "is_accepted": false, "score": 1, "last_activity_date": 1526826535, "last_edit_date": 1526826535, "creation_date": 1526810857, "answer_id": 50433679, "question_id": 50291821, "link": "https://stackoverflow.com/questions/50291821/rust-image-crate-issue-saving-image-buffer/50433679#50433679", "title": "Rust - image crate: issue saving image buffer", "body": "<p>In the section \"6.2 Generating Fractals\" of PistonDevelopers, the original example cannot be compiled successfully. It seems there are some outdated parameters setting, here is an updated version. hope this help.</p>\n\n<pre><code>//! An example of generating julia fractals.\nextern crate image;\nextern crate num;\n\nuse self::num::Complex;\nuse std::path::Path;\n\nfn main() {\n    let max_iterations = 256u16;\n\n    let imgx = 800;\n    let imgy = 800;\n\n    let scalex = 4.0 / imgx as f32;\n    let scaley = 4.0 / imgy as f32;\n\n    // let mut y = 0;\n    // Create a new ImgBuf with width: imgx and height: imgy\n    let mut imgbuf: image::GrayImage = image::ImageBuffer::new(imgx, imgy);\n\n    // Iterate over the coordinates and pixels of the image\n    for (x, y, pixel) in imgbuf.enumerate_pixels_mut() {\n        let cy = y as f32 * scaley - 2.0;\n        let cx = x as f32 * scalex - 2.0;\n\n        let mut z = Complex::new(cx, cy);\n        let c = Complex::new(-0.4, 0.6);\n\n        let mut i = 0;\n\n        for t in 0..max_iterations {\n            if z.norm() &gt; 2.0 {\n                break;\n            }\n            z = z * z + c;\n            i = t;\n        }\n\n        // Create an 8bit pixel of type Luma and value i\n        // and assign in to the pixel at position (x, y)\n        *pixel = image::Luma([i as u8]);\n    }\n\n    // Save the image as \u201cfractal.png\u201d\n    let path = Path::new(\"fractal.png\");\n\n    // We must indicate the image's color type and what format to save as\n    image::ImageLuma8(imgbuf).save(path).unwrap();\n}\n</code></pre>\n"}], "owner": {"reputation": 1, "user_id": 8151428, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6028b5d07994ecdb8abb1abe105f979f?s=128&d=identicon&r=PG&f=1", "display_name": "TC29", "link": "https://stackoverflow.com/users/8151428/tc29"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 983, "favorite_count": 0, "answer_count": 1, "score": -2, "last_activity_date": 1526826535, "creation_date": 1526039805, "question_id": 50291821, "link": "https://stackoverflow.com/questions/50291821/rust-image-crate-issue-saving-image-buffer", "title": "Rust - image crate: issue saving image buffer", "body": "<p>I have a question related to the fractal example (section '6.2 Generating Fractals', <a href=\"https://github.com/PistonDevelopers/image\" rel=\"nofollow noreferrer\">https://github.com/PistonDevelopers/image</a>) in examples supplied for image crate</p>\n\n<p>1) At line </p>\n\n<pre><code>image::ImageLuma8(imgbuf).save(fout, image::PNG).unwrap();\n</code></pre>\n\n<p>I get the following compile error message (rustc 1.25.0): </p>\n\n<pre><code>error[E0061]: this function takes 1 parameter but 2 parameters were supplied\n  --&gt; src/main.rs:52:31\n   |\n52 |     image::ImageLuma8(imgbuf).save(fout, image::PNG).unwrap();\n   |                               ^^^^ expected 1 parameter\n</code></pre>\n\n<p>Thank you for helping!</p>\n\n<p>2) Note in addition that I had to change </p>\n\n<pre><code>use num_complex::Complex;\n</code></pre>\n\n<p>to </p>\n\n<pre><code>use num::complex::{Complex};\n</code></pre>\n\n<p>at the beginning of the example. Maybe crate num_complex does not exist any longer ?</p>\n"}, {"tags": ["compiler-errors", "rust", "crc"], "comments": [{"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1526034307, "post_id": 50290208, "comment_id": 87596463, "body": "<code>C:\\\\Users\\\\XXXXXX\\\\OUTDIR&#47;crc16_constants.rs</code> - this path looks weird, no? Have you tried substituting <code>&#47;</code> with a <code>\\ </code> in <code>&quot;&#47;crc16_constants.rs&quot;</code>?"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1526035298, "post_id": 50290208, "comment_id": 87597026, "body": "Can you add some more details? What did you call for compiling your program? Do you use Cargo?"}, {"owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "edited": false, "score": 0, "creation_date": 1526035454, "post_id": 50290208, "comment_id": 87597111, "body": "That zero in the path is probably a problem, maybe i have to set beforehand the OUT_DIR to source folder of the library?"}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 0, "creation_date": 1526035494, "post_id": 50290208, "comment_id": 87597129, "body": "You definitely want to set that variable if you want to use it."}, {"owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "edited": false, "score": 0, "creation_date": 1526035889, "post_id": 50290208, "comment_id": 87597366, "body": "Just did it again, and it does not work, the file is not generated, i can see the code in build.rs its there, but it won&#39;t be executed somehow."}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1526036180, "post_id": 50290208, "comment_id": 87597535, "body": "It&#39;s hard to answer the question if you don&#39;t tell us how do you compile the project. What are your exact steps?"}, {"owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "edited": false, "score": 0, "creation_date": 1526036390, "post_id": 50290208, "comment_id": 87597646, "body": "Okay I just enter the place where Cargo.toml is and I execute     cargo build."}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1526037207, "post_id": 50290208, "comment_id": 87598143, "body": "Looking at that project, I don&#39;t see the build script listed in the <code>Cargo.toml</code>.  So the reason it&#39;s not being generated could be because the build script is never run.  This would be the case if you&#39;re using a sufficiently old version of Cargo, though I don&#39;t know in which version the behaviour changed.  What versions of rustc &amp; cargo are you using?"}, {"owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "edited": false, "score": 0, "creation_date": 1526037450, "post_id": 50290208, "comment_id": 87598272, "body": "Um there is cargo.toml inside examples of the platform \\exonum\\examples\\timestamping\\backend. This is the one I am using, the rustc &amp; cargo versions are rustc 1.25.0 (84203cac6 2018-03-25) and  cargo 0.16.0-nightly (3568be9 2016-11-26). I just installed them from the official site."}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1526038035, "post_id": 50290208, "comment_id": 87598630, "body": "<i>cargo 0.16.0-nightly (3568be9 2016-11-26)</i> - this is pretty old."}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 1, "creation_date": 1526038125, "post_id": 50290208, "comment_id": 87598681, "body": "You may try <a href=\"https://github.com/rust-lang-nursery/rustup.rs#installation\" rel=\"nofollow noreferrer\">rustup</a> and check, if it&#39;s working."}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1526038129, "post_id": 50290208, "comment_id": 87598685, "body": "Yeah; the cargo that shipped with Rust 1.25.0 should be cargo 0.26.0.  You&#39;ve somehow ended up with a seriously weird configuration."}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1526038632, "post_id": 50290208, "comment_id": 87599023, "body": "I can confirm that with a fresh, rustup-installed 1.25.0 on Windows 7, the <code>timestamping\\backend</code> example compiles just fine."}], "answers": [{"tags": [], "owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "is_accepted": true, "score": 1, "last_activity_date": 1526050255, "last_edit_date": 1526050255, "creation_date": 1526039845, "answer_id": 50291833, "question_id": 50290208, "link": "https://stackoverflow.com/questions/50290208/cant-compile-crc-library-in-rust-includeconcatenvout-dir-crc16-cons/50291833#50291833", "title": "Can&#39;t compile CRC library in rust include!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/crc16_constants.rs&quot;));", "body": "<p>As pointed in the comments, the solution was to simply update Rust and check <code>PATH</code> for older <code>cargo.exe</code>.</p>\n"}], "owner": {"reputation": 37, "user_id": 9484167, "user_type": "registered", "profile_image": "https://graph.facebook.com/141650019994393/picture?type=large", "display_name": "Friedl Crafts", "link": "https://stackoverflow.com/users/9484167/friedl-crafts"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 366, "favorite_count": 0, "accepted_answer_id": 50291833, "answer_count": 1, "score": 2, "last_activity_date": 1526050255, "creation_date": 1526034177, "last_edit_date": 1526037747, "question_id": 50290208, "link": "https://stackoverflow.com/questions/50290208/cant-compile-crc-library-in-rust-includeconcatenvout-dir-crc16-cons", "title": "Can&#39;t compile CRC library in rust include!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/crc16_constants.rs&quot;));", "body": "<p>I recently found a very interesting library called <code>Exonum</code> and this library is using the <a href=\"https://github.com/mrhooray/crc-rs\" rel=\"nofollow noreferrer\">CRC library</a>.</p>\n\n<p>Every time I try to compile the simple test project in Windows 10 I am greeted with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: couldn't read \"C:\\\\Users\\\\XXXXXX\\\\OUTDIR/crc16_constants.rs\": The \nsystem cannot find the file specified. (os error 2)\n --&gt; src\\crc16.rs:8:1\n  |\n8 | include!(concat!(env!(\"OUT_DIR\"), \"/crc16_constants.rs\"));\n  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror: Could not compile `crc`.\n</code></pre>\n\n<p>I have tried setting the <code>out_dir</code> however it didn't help. There seems to be <code>build.rs</code> file in that library which should export this file, but it does not do it before the build.\nAnyone have the same issue? </p>\n\n<h3>EDIT1:</h3>\n\n<p>After point in comments I removed the <code>OUT_DIR</code> environment variable and changed the string in the source there still seems to be a problem. The output from compilation is as follows:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: environment variable `OUT_DIR` not defined\n --&gt; crc16.rs:8:18\n  |\n8 | include!(concat!(env!(\"OUT_DIR\"), \"\\\\crc16_constants.rs\"));\n  |                  ^^^^^^^^^^^^^^^\n\nerror: couldn't read \"0\\\\crc16_constants.rs\": The system cannot find the file specified. (os error 2)\n --&gt; crc16.rs:8:1\n  |\n8 | include!(concat!(env!(\"OUT_DIR\"), \"\\\\crc16_constants.rs\"));\n  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror: Could not compile `crc`.\n</code></pre>\n"}, {"tags": ["arrays", "syntax", "static", "rust"], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 3, "last_activity_date": 1526044871, "last_edit_date": 1526044871, "creation_date": 1526006593, "answer_id": 50284247, "question_id": 50283865, "link": "https://stackoverflow.com/questions/50283865/how-to-initialize-a-static-array-with-most-values-the-same-but-some-values-diffe/50284247#50284247", "title": "How to initialize a static array with most values the same but some values different?", "body": "<p>There is no Rust equivalent to your C snippet. The <a href=\"https://doc.rust-lang.org/stable/reference/expressions/array-expr.html\" rel=\"nofollow noreferrer\">documentation</a> shows only 3 simple patterns are allowed:</p>\n\n<ol>\n<li>empty</li>\n<li>value, value, value, etc...</li>\n<li>value; size</li>\n</ol>\n\n<p>So, currently with array syntax, you can't do it.</p>\n\n<p>Now, let take a look at the macro solution. There is no way to \"count\", so unless you write a <a href=\"https://stackoverflow.com/a/41213128/7076153\">plugin</a> for the Rust compiler, you can't do it with a macro.</p>\n\n<p>My preferred solution would be to generate the file with other tools before compiling. For example, you could use Cargo to <a href=\"https://doc.rust-lang.org/cargo/reference/build-scripts.html#case-study-code-generation\" rel=\"nofollow noreferrer\">generate the file</a> before compiling.</p>\n\n<hr>\n\n<p>There could be a solution in the future. A <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/0911-const-fn.md\" rel=\"nofollow noreferrer\">RFC</a> about const function could offer the possibility to do what you want at compile time, but this is currently impossible.</p>\n"}], "owner": {"reputation": 33, "user_id": 9773842, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/photo.jpg?sz=128", "display_name": "Andrew Hu", "link": "https://stackoverflow.com/users/9773842/andrew-hu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 672, "favorite_count": 0, "accepted_answer_id": 50284247, "answer_count": 1, "score": 3, "last_activity_date": 1526044871, "creation_date": 1526003469, "last_edit_date": 1526004421, "question_id": 50283865, "link": "https://stackoverflow.com/questions/50283865/how-to-initialize-a-static-array-with-most-values-the-same-but-some-values-diffe", "title": "How to initialize a static array with most values the same but some values different?", "body": "<p>I would like to use a static or const array, but initialize it using something other than the <code>[T; N]</code> syntax. I need to define specific elements but all other values can default to 0 or some other value.</p>\n\n<p>In C, you can do the following:</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>byte ARRAY[256] = {\n    [0x1F] = (1 &lt;&lt; 4),\n    // Or even simply just this\n    [0x46] '\\n'\n};\n</code></pre>\n\n<p>I've tried something along the lines of:</p>\n\n<pre><code>static ARRAY: [u8; 256] = {\n    // x is some arbitrary number of elements\n    let mut array = [0, x];\n    array[i] = 'b',\n    array[j] = 'a',\n    array[k] = 'd',\n    array\n};\n</code></pre>\n\n<p>This was merely trial and error based on syntax I know to work for local array declarations. This throws a compiler error saying that blocks in const and static are limited to items and tail expressions. I know that if I enclose an array definition in brackets, then the last line or last expression must be the implicit return.</p>\n\n<p>Additionally, I don't have access to the std library, but I don't think a complex structure would be necessary for something this simple - to index and obtain a value.</p>\n\n<p>I've looked at the Rust macro rules and think that could be a solution, but all the examples I have seen are iterative and incremental.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 5, "creation_date": 1526003605, "post_id": 50283814, "comment_id": 87584083, "body": "Welcome to Stack Overflow! When asking for help, you should provide a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. The code you have provided is both too big and not big enough. It doesn&#39;t include the imports you are using, but it&#39;s questionable whether those imports are even needed for the core of your question. Additionally, the provided code isn&#39;t even <i>syntactically valid</i>, which means that it didn&#39;t come from code that you have tried to compile once."}], "answers": [{"comments": [{"owner": {"reputation": 29, "user_id": 9430950, "user_type": "registered", "profile_image": "https://graph.facebook.com/759254174263712/picture?type=large", "display_name": "SimGudim", "link": "https://stackoverflow.com/users/9430950/simgudim"}, "edited": false, "score": 0, "creation_date": 1526006314, "post_id": 50284153, "comment_id": 87584691, "body": "this is awesome!! Thank you!!"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1526005682, "creation_date": 1526005682, "answer_id": 50284153, "question_id": 50283814, "link": "https://stackoverflow.com/questions/50283814/looping-through-a-vector-and-finding-a-maximum-sum-of-values-with-fixed-number-o/50284153#50284153", "title": "Looping through a vector and finding a maximum sum of values with fixed number of indices", "body": "<p>Pretend you have an infinite sequence of numbers, repeating itself. It makes the problem much easier:</p>\n\n<pre><code>fn main() {\n    let d = [1, 2, 3, 4, 5, 6, 7, 8];\n    let mut numbers = d.iter().cycle();\n\n    let max = (0..d.len())\n        .map(|_| {\n            let sum1: i32 = numbers.by_ref().take(3).sum();\n            let sum2: i32 = numbers.by_ref().take(5).sum();\n\n            // Skip one so the next iteration is offset by one\n            numbers.next();\n\n            (sum1, sum2)\n        })\n        .map(|(sum1, sum2)| i32::abs(3 * sum1 + 5 * sum2))\n        .max();\n\n    println!(\"{:?}\", max);\n}\n</code></pre>\n"}], "owner": {"reputation": 29, "user_id": 9430950, "user_type": "registered", "profile_image": "https://graph.facebook.com/759254174263712/picture?type=large", "display_name": "SimGudim", "link": "https://stackoverflow.com/users/9430950/simgudim"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 104, "favorite_count": 0, "accepted_answer_id": 50284153, "answer_count": 1, "score": -1, "last_activity_date": 1526005682, "creation_date": 1526003042, "last_edit_date": 1526004180, "question_id": 50283814, "link": "https://stackoverflow.com/questions/50283814/looping-through-a-vector-and-finding-a-maximum-sum-of-values-with-fixed-number-o", "title": "Looping through a vector and finding a maximum sum of values with fixed number of indices", "body": "<p>I need to:</p>\n\n<ol>\n<li>Loop through an array of eight values (<code>d = [1, 2, 3, 4, 5, 6, 7, 8]</code>). </li>\n<li>Sum the first three (indexes: 0, 1, 2) items (<code>'sum1'</code>) and the last five items (indexes: 3, 4, 5, 6, 7) (<code>'sum2'</code>), and perform an operation with those derived sums (<code>abs(3*sum1 + 5*sum2)</code>. </li>\n<li>Do this operation for eight different configurations. The next configuration would be to sum of three items at 1, 2, 3 indices, while the sum of five would be under 4, 5, 6, 7, 0. Under each new configuration the sum of items shifts one index to the right.</li>\n<li><p>From this, eight values in a vector or something else should be obtained from performing the <code>abs(3*sum1 + 5*sum2)</code> expression that each contain different <code>sum1</code> and <code>sum2</code> due to difference in indices. </p></li>\n<li><p>Among those eight values I need to find the maximum.</p></li>\n</ol>\n"}, {"tags": ["generics", "rust", "instanceof", "typeof"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1526001432, "post_id": 50283237, "comment_id": 87583618, "body": "Let me try that last comment again: <a href=\"http://play.rust-lang.org/?gist=e9295f44151b9c0d3b1cea6b33236b99&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Here&#39;s a possible application</a> of the duplicate to your question. You&#39;d presumably want to add additional behavior to the trait, or add bounds to the <code>test</code> function, to be able to do much else."}], "owner": {"reputation": 897, "user_id": 4528728, "user_type": "registered", "accept_rate": 55, "profile_image": "https://www.gravatar.com/avatar/48b7aeab16c3e50657c88ac3542a502b?s=128&d=identicon&r=PG&f=1", "display_name": "Slim Shady", "link": "https://stackoverflow.com/users/4528728/slim-shady"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 36, "favorite_count": 0, "closed_date": 1525999586, "answer_count": 0, "score": 2, "last_activity_date": 1525999607, "creation_date": 1525998031, "last_edit_date": 1525999607, "question_id": 50283237, "link": "https://stackoverflow.com/questions/50283237/can-you-get-the-type-of-generic-variable", "closed_reason": "Duplicate", "title": "Can you get the type of generic variable", "body": "<p>I want to run code based on a type parameter <code>T</code>. <code>T</code> can be one of a list of known types.</p>\n\n<pre><code>fn test&lt;T&gt;(t: T){\n    // if T = u64 print \"Hi\"\n    // if T = u32 print \"Sorry\"\n}\n</code></pre>\n"}, {"tags": ["multithreading", "rust"], "comments": [{"owner": {"reputation": 28990, "user_id": 1114966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/af8712b05e5cfb862323a07c83749054?s=128&d=identicon&r=PG", "display_name": "squiguy", "link": "https://stackoverflow.com/users/1114966/squiguy"}, "edited": false, "score": 2, "creation_date": 1525995152, "post_id": 50282619, "comment_id": 87582235, "body": "In order to achieve thread safety, there is no way around it. You must have a guard around the entire type and not just it&#39;s underlying fields."}, {"owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1525995663, "post_id": 50282619, "comment_id": 87582365, "body": "@Shepmaster Thanks! That&#39;s too bad, sadly. Inserting/removing happens very rarely to the map, it&#39;s like 99.9% updates only. That&#39;s why I thought I would just lock the single element in the map, and use some kind of other method to ensure that inserting/removing happens while there aren&#39;t any workers using the map. Back to thinking I guess."}, {"owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1525997786, "post_id": 50282619, "comment_id": 87582839, "body": "@Shepmaster Forgive me if I&#39;m stupid, but updating a single element in the map wouldn&#39;t still need a write lock? Or do you mean, that I should use a read lock up until I actually modify the map, and then upgrade it to a write lock? Considering the actual work&#39;s ~95% would be under write lock in this way anyway, should I just go ahead and use a <code>Mutex</code> instead to avoid the <code>RwLock</code>&#39;s overhead?"}, {"owner": {"reputation": 165665, "user_id": 721269, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/346ca03edfbde2a468adc289867ab975?s=128&d=identicon&r=PG", "display_name": "David Schwartz", "link": "https://stackoverflow.com/users/721269/david-schwartz"}, "edited": false, "score": 0, "creation_date": 1587154727, "post_id": 50282619, "comment_id": 108408258, "body": "Do your threads really spend a lot of time accessing the HashMap? Is it read-mostly?"}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 14, "last_activity_date": 1587154450, "last_edit_date": 1592644375, "creation_date": 1526004109, "answer_id": 50283931, "question_id": 50282619, "link": "https://stackoverflow.com/questions/50282619/is-it-possible-to-share-a-hashmap-between-threads-without-locking-the-entire-has/50283931#50283931", "title": "Is it possible to share a HashMap between threads without locking the entire HashMap?", "body": "<p>I don't see how your request is possible, at least not without some exceedingly clever lock-free data structures; what should happen if multiple threads need to insert new values that hash to the same location?</p>\n<p>In previous work, I've used a <code>RwLock&lt;HashMap&lt;K, Mutex&lt;V&gt;&gt;&gt;</code>. When inserting a value into the hash, you get an exclusive lock for a short period. The rest of the time, you can have multiple threads with reader locks to the <code>HashMap</code> and thus to a given element. If they need to mutate the data, they can get exclusive access to the <code>Mutex</code>.</p>\n<p>Here's an example:</p>\n<pre><code>use std::{\n    collections::HashMap,\n    sync::{Arc, Mutex, RwLock},\n    thread,\n    time::Duration,\n};\n\nfn main() {\n    let data = Arc::new(RwLock::new(HashMap::new()));\n\n    let threads: Vec&lt;_&gt; = (0..10)\n        .map(|i| {\n            let data = Arc::clone(&amp;data);\n            thread::spawn(move || worker_thread(i, data))\n        })\n        .collect();\n\n    for t in threads {\n        t.join().expect(&quot;Thread panicked&quot;);\n    }\n\n    println!(&quot;{:?}&quot;, data);\n}\n\nfn worker_thread(id: u8, data: Arc&lt;RwLock&lt;HashMap&lt;u8, Mutex&lt;i32&gt;&gt;&gt;&gt;) {\n    loop {\n        // Assume that the element already exists\n        let map = data.read().expect(&quot;RwLock poisoned&quot;);\n\n        if let Some(element) = map.get(&amp;id) {\n            let mut element = element.lock().expect(&quot;Mutex poisoned&quot;);\n\n            // Perform our normal work updating a specific element.\n            // The entire HashMap only has a read lock, which\n            // means that other threads can access it.\n            *element += 1;\n            thread::sleep(Duration::from_secs(1));\n\n            return;\n        }\n\n        // If we got this far, the element doesn't exist\n\n        // Get rid of our read lock and switch to a write lock\n        // You want to minimize the time we hold the writer lock\n        drop(map);\n        let mut map = data.write().expect(&quot;RwLock poisoned&quot;);\n\n        // We use HashMap::entry to handle the case where another thread \n        // inserted the same key while where were unlocked.\n        thread::sleep(Duration::from_millis(50));\n        map.entry(id).or_insert_with(|| Mutex::new(0));\n        // Let the loop start us over to try again\n    }\n}\n</code></pre>\n<p>This takes about 2.7 seconds to run on my machine, even though it starts 10 threads that each wait for 1 second while holding the exclusive lock to the element's data.</p>\n<p>This solution isn't without issues, however. When there's a huge amount of contention for that one master lock, getting a write lock can take a while and completely kills parallelism.</p>\n<p>In that case, you can switch to a <code>RwLock&lt;HashMap&lt;K, Arc&lt;Mutex&lt;V&gt;&gt;&gt;&gt;</code>. Once you have a read or write lock, you can then clone the <code>Arc</code> of the value, returning it and unlocking the hashmap.</p>\n<p>The next step up would be to use a crate like <a href=\"https://docs.rs/arc-swap/0.4.5/arc_swap/\" rel=\"noreferrer\">arc-swap</a>, which says:</p>\n<blockquote>\n<p>Then one would lock, clone the [<code>RwLock&lt;Arc&lt;T&gt;&gt;</code>] and unlock. This suffers from CPU-level contention (on the lock and on the reference count of the <code>Arc</code>) which makes it relatively slow. Depending on the implementation, an update may be blocked for arbitrary long time by a steady inflow of readers.</p>\n<p>The <a href=\"https://docs.rs/arc-swap/0.4.5/arc_swap/type.ArcSwap.html\" rel=\"noreferrer\"><code>ArcSwap</code></a> can be used instead, which solves the above problems and has better performance characteristics than the <code>RwLock</code>, both in contended and non-contended scenarios.</p>\n</blockquote>\n<p>I often advocate for performing some kind of smarter algorithm. For example, you could spin up N threads each with their own <code>HashMap</code>. You then <em>shard</em> work among them. For the simple example above, you could use <code>id % N_THREADS</code>, for example. There are also complicated sharding schemes that depend on your data.</p>\n<p>As Go has done a good job of evangelizing: <em>do not communicate by sharing memory; instead, share memory by communicating</em>.</p>\n"}, {"comments": [{"owner": {"reputation": 4500, "user_id": 8858995, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44d1981ec5dd8311a79e695d512716ef?s=128&d=identicon&r=PG&f=1", "display_name": "Ibraheem Ahmed", "link": "https://stackoverflow.com/users/8858995/ibraheem-ahmed"}, "edited": false, "score": 0, "creation_date": 1617197977, "post_id": 54593536, "comment_id": 118237115, "body": "<code>evmap</code> can be used in a fully consistent mode by refreshing after every write."}, {"owner": {"reputation": 356, "user_id": 1789789, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5c9274d933c3981563fb5059247f386b?s=128&d=identicon&r=PG", "display_name": "jeremyong", "link": "https://stackoverflow.com/users/1789789/jeremyong"}, "edited": false, "score": 0, "creation_date": 1618830516, "post_id": 54593536, "comment_id": 118712807, "body": "The write and flush are not atomic operations though so I do not believe this qualifies as &quot;fully consistent&quot; as a read request could still race against the flush itself right?"}, {"owner": {"reputation": 714, "user_id": 9452151, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8e9a86fdcf564b012e7221bacf7df180?s=128&d=identicon&r=PG&f=1", "display_name": "jonas", "link": "https://stackoverflow.com/users/9452151/jonas"}, "reply_to_user": {"reputation": 356, "user_id": 1789789, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5c9274d933c3981563fb5059247f386b?s=128&d=identicon&r=PG", "display_name": "jeremyong", "link": "https://stackoverflow.com/users/1789789/jeremyong"}, "edited": false, "score": 0, "creation_date": 1618986926, "post_id": 54593536, "comment_id": 118764832, "body": "@jeremyong What makes you think it is not atomic? I couldn&#39;t find any information right now. In my understanding, it works by keeping two copies of the map: one for reading and one for writing. The writes are not atomic, but the swapping of the two references could be atomic."}, {"owner": {"reputation": 356, "user_id": 1789789, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5c9274d933c3981563fb5059247f386b?s=128&d=identicon&r=PG", "display_name": "jeremyong", "link": "https://stackoverflow.com/users/1789789/jeremyong"}, "edited": false, "score": 0, "creation_date": 1619012163, "post_id": 54593536, "comment_id": 118776253, "body": "@jonas When writing, the read map is not locked, so someone could issue a read before the flush is visible."}, {"owner": {"reputation": 714, "user_id": 9452151, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8e9a86fdcf564b012e7221bacf7df180?s=128&d=identicon&r=PG&f=1", "display_name": "jonas", "link": "https://stackoverflow.com/users/9452151/jonas"}, "reply_to_user": {"reputation": 356, "user_id": 1789789, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5c9274d933c3981563fb5059247f386b?s=128&d=identicon&r=PG", "display_name": "jeremyong", "link": "https://stackoverflow.com/users/1789789/jeremyong"}, "edited": false, "score": 0, "creation_date": 1619086905, "post_id": 54593536, "comment_id": 118800968, "body": "@jeremyong Yes indeed. It is lock-free and always consistent (because the writer decides when to sync), but maybe not up to date. This is what &quot;eventual consistency&quot; means here: Eventual consistent between writer and reader, but the data can always be consistent in itself if the writer does something sensible."}, {"owner": {"reputation": 356, "user_id": 1789789, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5c9274d933c3981563fb5059247f386b?s=128&d=identicon&r=PG", "display_name": "jeremyong", "link": "https://stackoverflow.com/users/1789789/jeremyong"}, "edited": false, "score": 0, "creation_date": 1619100842, "post_id": 54593536, "comment_id": 118807290, "body": "@jonas I wasn&#39;t responding to your answer but to ibraheem&#39;s comment that evmap can be used in &quot;fully consistent mode&quot; (which I believe to be erroneous)"}], "tags": [], "owner": {"reputation": 714, "user_id": 9452151, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8e9a86fdcf564b012e7221bacf7df180?s=128&d=identicon&r=PG&f=1", "display_name": "jonas", "link": "https://stackoverflow.com/users/9452151/jonas"}, "is_accepted": false, "score": 4, "last_activity_date": 1617198004, "last_edit_date": 1617198004, "creation_date": 1549632758, "answer_id": 54593536, "question_id": 50282619, "link": "https://stackoverflow.com/questions/50282619/is-it-possible-to-share-a-hashmap-between-threads-without-locking-the-entire-has/54593536#54593536", "title": "Is it possible to share a HashMap between threads without locking the entire HashMap?", "body": "<p>Maybe you want to consider <a href=\"https://github.com/jonhoo/evmap\" rel=\"nofollow noreferrer\"><code>evmap</code></a>:</p>\n<blockquote>\n<p>A lock-free, eventually consistent, concurrent multi-value map.</p>\n</blockquote>\n<p>The trade-off is eventual-consistency: Readers do not see changes until the writer <em>refreshes</em> the map. A refresh is atomic and the writer decides when to do it and expose new data to the readers.</p>\n"}, {"tags": [], "owner": {"reputation": 960, "user_id": 1113302, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/XrUUT.jpg?s=128&g=1", "display_name": "Riccardo Casatta", "link": "https://stackoverflow.com/users/1113302/riccardo-casatta"}, "is_accepted": false, "score": 0, "last_activity_date": 1607091134, "last_edit_date": 1607091134, "creation_date": 1606486029, "answer_id": 65038724, "question_id": 50282619, "link": "https://stackoverflow.com/questions/50282619/is-it-possible-to-share-a-hashmap-between-threads-without-locking-the-entire-has/65038724#65038724", "title": "Is it possible to share a HashMap between threads without locking the entire HashMap?", "body": "<p>Suppose the key of the data is map-able to a <code>u8</code></p>\n<p>You can have <code>Arc&lt;HashMap&lt;u8,Mutex&lt;HashMap&lt;Key,Value&gt;&gt;&gt;</code></p>\n<p>When you initialize the data structure you populate all the first level map before putting it in Arc (it will be immutable after initialization)</p>\n<p>When you want a value from the map you will need to do a double get, something like:</p>\n<p><code>data.get(&amp;map_to_u8(&amp;key)).unwrap().lock().expect(&quot;poison&quot;).get(&amp;key)</code></p>\n<p>where the <code>unwrap</code> is safe because we initialized the first map with all the value.</p>\n<p>to write in the map something like:</p>\n<p><code>data.get(&amp;map_to_u8(id)).unwrap().lock().expect(&quot;poison&quot;).entry(id).or_insert_with(|| value);</code></p>\n<p>It's easy to see contention is reduced because we now have 256 Mutex and the probability of multiple threads asking the same Mutex is low.</p>\n<p>@Shepmaster example with 100 threads takes about 10s on my machine, the following example takes a little more than 1 second.</p>\n<pre><code>use std::{\n    collections::HashMap,\n    sync::{Arc, Mutex, RwLock},\n    thread,\n    time::Duration,\n};\n\nfn main() {\n    let mut inner = HashMap::new( );\n    for i in 0..=u8::max_value() {\n        inner.insert(i, Mutex::new(HashMap::new()));\n    }\n    let data = Arc::new(inner);\n\n    let threads: Vec&lt;_&gt; = (0..100)\n        .map(|i| {\n            let data = Arc::clone(&amp;data);\n            thread::spawn(move || worker_thread(i, data))\n        })\n        .collect();\n\n    for t in threads {\n        t.join().expect(&quot;Thread panicked&quot;);\n    }\n\n    println!(&quot;{:?}&quot;, data);\n}\n\nfn worker_thread(id: u8, data: Arc&lt;HashMap&lt;u8,Mutex&lt;HashMap&lt;u8,Mutex&lt;i32&gt;&gt;&gt;&gt;&gt; ) {\n    loop {\n\n        // first unwrap is safe to unwrap because we populated for every `u8`\n        if let Some(element) = data.get(&amp;id).unwrap().lock().expect(&quot;poison&quot;).get(&amp;id) {\n            let mut element = element.lock().expect(&quot;Mutex poisoned&quot;);\n\n            // Perform our normal work updating a specific element.\n            // The entire HashMap only has a read lock, which\n            // means that other threads can access it.\n            *element += 1;\n            thread::sleep(Duration::from_secs(1));\n\n            return;\n        }\n\n        // If we got this far, the element doesn't exist\n\n        // Get rid of our read lock and switch to a write lock\n        // You want to minimize the time we hold the writer lock\n\n        // We use HashMap::entry to handle the case where another thread\n        // inserted the same key while where were unlocked.\n        thread::sleep(Duration::from_millis(50));\n        data.get(&amp;id).unwrap().lock().expect(&quot;poison&quot;).entry(id).or_insert_with(|| Mutex::new(0));\n        // Let the loop start us over to try again\n    }\n}\n\n</code></pre>\n"}], "owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 8169, "favorite_count": 3, "accepted_answer_id": 50283931, "answer_count": 3, "score": 17, "last_activity_date": 1617198004, "creation_date": 1525992870, "last_edit_date": 1525994733, "question_id": 50282619, "link": "https://stackoverflow.com/questions/50282619/is-it-possible-to-share-a-hashmap-between-threads-without-locking-the-entire-has", "title": "Is it possible to share a HashMap between threads without locking the entire HashMap?", "body": "<p>I would like to have a shared struct between threads. The struct has many fields that are never modified and a <code>HashMap</code>, which is. I don't want to lock the whole <code>HashMap</code> for a single update/remove, so my <code>HashMap</code> looks something like <code>HashMap&lt;u8, Mutex&lt;u8&gt;&gt;</code>. This works, but it makes no sense since the thread will lock the whole map anyways.</p>\n\n<p>Here's this working version, without threads; I don't think that's necessary for the example.</p>\n\n<pre><code>use std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\n\nfn main() {\n    let s = Arc::new(Mutex::new(S::new()));\n    let z = s.clone();\n    let _ = z.lock().unwrap();\n}\n\nstruct S {\n    x: HashMap&lt;u8, Mutex&lt;u8&gt;&gt;, // other non-mutable fields\n}\n\nimpl S {\n    pub fn new() -&gt; S {\n        S {\n            x: HashMap::default(),\n        }\n    }\n}\n</code></pre>\n\n<p><a href=\"http://play.rust-lang.org/?gist=4910ef11949fa6a2127165ce25faef5c&amp;version=stable&amp;mode=debug\" rel=\"noreferrer\">Playground</a> </p>\n\n<p>Is this possible in any way? Is there something obvious I missed in the documentation? </p>\n\n<p>I've been trying to get this working, but I'm not sure how. Basically every example I see there's always a <code>Mutex</code> (or <code>RwLock</code>, or something like that) guarding the inner value.</p>\n"}, {"tags": ["rust", "format"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1525968692, "post_id": 50277050, "comment_id": 87570841, "body": "<a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec) or Box (&amp;Box) as a function argument?</a>."}, {"owner": {"reputation": 119, "user_id": 4907082, "user_type": "registered", "accept_rate": 60, "profile_image": "https://lh6.googleusercontent.com/-E1gbm5vRzlI/AAAAAAAAAAI/AAAAAAAAABI/y6amV80B4RA/photo.jpg?sz=128", "display_name": "Meltinglava", "link": "https://stackoverflow.com/users/4907082/meltinglava"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1525971784, "post_id": 50277050, "comment_id": 87572647, "body": "It does answer my question with the link to the issue on github. And thank you for the link."}], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 6, "last_activity_date": 1537346114, "last_edit_date": 1537346114, "creation_date": 1525973089, "answer_id": 50278316, "question_id": 50277050, "link": "https://stackoverflow.com/questions/50277050/is-there-a-built-in-function-that-converts-a-number-to-a-string-in-any-base/50278316#50278316", "title": "Is there a built-in function that converts a number to a string in any base?", "body": "<p>For now, <a href=\"https://github.com/rust-lang/rust/issues/27728#issuecomment-172538725\" rel=\"nofollow noreferrer\">you cannot do it using the standard library</a>, but you can:</p>\n\n<ul>\n<li>use my crate <a href=\"https://crates.io/crates/radix_fmt\" rel=\"nofollow noreferrer\"><code>radix_fmt</code></a></li>\n<li><p>or roll your own implementation:</p>\n\n<pre><code>fn format_radix(mut x: u32, radix: u32) -&gt; String {\n    let mut result = vec![];\n\n    loop {\n        let m = x % radix;\n        x = x / radix;\n\n        // will panic if you use a bad radix (&lt; 2 or &gt; 36).\n        result.push(std::char::from_digit(m, radix).unwrap());\n        if x == 0 {\n            break;\n        }\n    }\n    result.into_iter().rev().collect()\n}\n\nfn main() {\n    assert_eq!(format_radix(1234, 10), \"1234\");\n    assert_eq!(format_radix(1000, 10), \"1000\");\n    assert_eq!(format_radix(0, 10), \"0\");\n}\n</code></pre></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1526044710, "last_edit_date": 1526044710, "creation_date": 1525989875, "answer_id": 50282149, "question_id": 50277050, "link": "https://stackoverflow.com/questions/50277050/is-there-a-built-in-function-that-converts-a-number-to-a-string-in-any-base/50282149#50282149", "title": "Is there a built-in function that converts a number to a string in any base?", "body": "<p>If you wanted to eke out a little more performance, you can create a struct and implement <code>Display</code> or <code>Debug</code> for it. This avoids allocating a <code>String</code>. For maximum over-engineering, you can also have a stack-allocated array instead of the <code>Vec</code>.</p>\n\n<p>Here is <a href=\"https://stackoverflow.com/a/50278316/155423\">Boiethios' answer</a> with these changes applied:</p>\n\n<pre><code>struct Radix {\n    x: i32,\n    radix: u32,\n}\n\nimpl Radix {\n    fn new(x: i32, radix: u32) -&gt; Result&lt;Self, &amp;'static str&gt; {\n        if radix &lt; 2 || radix &gt; 36 {\n            Err(\"Unnsupported radix\")\n        } else {\n            Ok(Self { x, radix })\n        }\n    }\n}\n\nuse std::fmt;\n\nimpl fmt::Display for Radix {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {\n        let mut x = self.x;\n        // Good for binary formatting of `u128`s\n        let mut result = ['\\0'; 128];\n        let mut used = 0;\n        let negative = x &lt; 0;\n        if negative {\n            x*=-1;\n        }\n        let mut x = x as u32;\n        loop {\n            let m = x % self.radix;\n            x /= self.radix;\n\n            result[used] = std::char::from_digit(m, self.radix).unwrap();\n            used += 1;\n\n            if x == 0 {\n                break;\n            }\n        }\n\n        if negative {\n            write!(f, \"-\")?;\n        }\n\n        for c in result[..used].iter().rev() {\n            write!(f, \"{}\", c)?;\n        }\n\n        Ok(())\n    }\n}\n\nfn main() {\n    assert_eq!(Radix::new(1234, 10).to_string(), \"1234\");\n    assert_eq!(Radix::new(1000, 10).to_string(), \"1000\");\n    assert_eq!(Radix::new(0, 10).to_string(), \"0\");\n}\n</code></pre>\n\n<p>This could still be optimized by:</p>\n\n<ul>\n<li>creating an ASCII array instead of a <code>char</code> array </li>\n<li>not zero-initializing the array</li>\n</ul>\n\n<p>Since these avenues require <code>unsafe</code> or an external crate like <a href=\"https://crates.io/crates/arrayvec\" rel=\"nofollow noreferrer\">arraybuf</a>, I have not included them. You can see sample code in <a href=\"https://github.com/rust-lang/rust/blob/1.26.0/src/libcore/fmt/num.rs#L50-L98\" rel=\"nofollow noreferrer\">internal implementation details of the standard library</a>.</p>\n"}, {"tags": [], "owner": {"reputation": 80945, "user_id": 1002260, "user_type": "registered", "accept_rate": 96, "profile_image": "https://www.gravatar.com/avatar/5ec9c21c8d54825b04def7a41998d18d?s=128&d=identicon&r=PG", "display_name": "Steven Penny", "link": "https://stackoverflow.com/users/1002260/steven-penny"}, "is_accepted": false, "score": -1, "last_activity_date": 1614399418, "last_edit_date": 1614399418, "creation_date": 1604250460, "answer_id": 64634611, "question_id": 50277050, "link": "https://stackoverflow.com/questions/50277050/is-there-a-built-in-function-that-converts-a-number-to-a-string-in-any-base/64634611#64634611", "title": "Is there a built-in function that converts a number to a string in any base?", "body": "<p>This is faster than the other answer:</p>\n<pre><code>use std::char::from_digit;\n\nfn encode(mut n: u32, r: u32) -&gt; Option&lt;String&gt; {\n   let mut s = String::new();\n   loop {\n      if let Some(c) = from_digit(n % r, r) {\n         s.insert(0, c)\n      } else {\n         return None\n      }\n      n /= r;\n      if n == 0 {\n         break\n      }\n   }\n   Some(s)\n}\n</code></pre>\n<p>Note I also tried these, but they were slower:</p>\n<ul>\n<li><a href=\"https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.push_front\" rel=\"nofollow noreferrer\">https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.push_front</a></li>\n<li><a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.push\" rel=\"nofollow noreferrer\">https://doc.rust-lang.org/std/string/struct.String.html#method.push</a></li>\n<li><a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.insert\" rel=\"nofollow noreferrer\">https://doc.rust-lang.org/std/vec/struct.Vec.html#method.insert</a></li>\n</ul>\n"}], "owner": {"reputation": 119, "user_id": 4907082, "user_type": "registered", "accept_rate": 60, "profile_image": "https://lh6.googleusercontent.com/-E1gbm5vRzlI/AAAAAAAAAAI/AAAAAAAAABI/y6amV80B4RA/photo.jpg?sz=128", "display_name": "Meltinglava", "link": "https://stackoverflow.com/users/4907082/meltinglava"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2875, "favorite_count": 0, "accepted_answer_id": 50282149, "answer_count": 3, "score": 5, "last_activity_date": 1614399418, "creation_date": 1525968273, "last_edit_date": 1525987565, "question_id": 50277050, "link": "https://stackoverflow.com/questions/50277050/is-there-a-built-in-function-that-converts-a-number-to-a-string-in-any-base", "title": "Is there a built-in function that converts a number to a string in any base?", "body": "<p>I want to replace the inner <code>match</code> statement and work for all values up to when the alphabet runs out. I know I can write it myself, but I want to  use built-in functions.</p>\n\n<pre><code>fn convert(inp: u32, out: u32, numb: &amp;String) -&gt; Result&lt;String, String&gt; {\n    match isize::from_str_radix(numb, inp) {\n        Ok(a) =&gt; match out {\n            2 =&gt; Ok(format!(\"{:b}\", a)),\n            8 =&gt; Ok(format!(\"{:o}\", a)),\n            16 =&gt; Ok(format!(\"{:x}\", a)),\n            10 =&gt; Ok(format!(\"{}\", a)),\n            0 | 1 =&gt; Err(format!(\"No base lower than 2!\")),\n            _ =&gt; Err(format!(\"printing in this base is not supported\")),\n        },\n        Err(e) =&gt; Err(format!(\n            \"Could not convert {} to a number in base {}.\\n{:?}\\n\",\n            numb, inp, e\n        )),\n    }\n}\n</code></pre>\n"}, {"tags": ["multithreading", "rust", "rayon"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525965259, "post_id": 50271746, "comment_id": 87568906, "body": "There a few problems with your code. 1) Your array is 20 bytes, but <code>u64</code> holds 8 bytes. 2) Your iteration is from 0 - 1e12. To get all the <code>u64</code> values exhaustively your range should be <code>0 .. 0xffffffffffffffff</code>."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525965517, "post_id": 50271746, "comment_id": 87569064, "body": "A way of doing this might be to reformulate it into two loops, The outer (parallel) loop is the first byte, and then the inner loop does exactly the same as you have now, except using the first digit from the outer loop. That way there&#39;ll be a thread per first byte, and they&#39;ll all start short and work up to longer ones."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525969945, "post_id": 50271746, "comment_id": 87571575, "body": "@PeterHall good observation, but this was just a quick thing I wrote; ideally I should be using BigInts or whatever the Rust equivalent is. By the way also note that in my u64 each byte can store 256 different combinations of data, but in the array each byte can only store 26 different combinations of data, because at the moment I&#39;m only working with the lower-case alphabetic characters."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525970021, "post_id": 50271746, "comment_id": 87571625, "body": "Also in your example, if I have each outer loop work with the &quot;first byte&quot;, I don&#39;t get how this would work, because I&#39;d have at most 16 threads on a 16 thread Ryzen machine, whereas the first byte can have 256 different combinations."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525970538, "post_id": 50271746, "comment_id": 87571925, "body": "Actually I could probably at runtime ensure that the number of threads would be a power of 2, and then take that number and make sure that each thread started on the bit level with its own number, and then iterate each thread ensuring the same starting bits. Not a bad idea!"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1525973150, "post_id": 50271746, "comment_id": 87573315, "body": "I added an answer to explain what I meant."}], "answers": [{"comments": [{"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525973637, "post_id": 50276516, "comment_id": 87573525, "body": "The problem I see here is that the outer <code>filter_map()</code> callback is expected to run multiple times per thread to cover every possible combination of the first byte... however the inner loop will run a super long time per callback, resulting in it taking forever to cover each combination of first byte."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525973832, "post_id": 50276516, "comment_id": 87573622, "body": "So say we weren&#39;t dealing with byte arrays, but rather character arrays. Your code would nicely split up the brute force work between two cores to try all combinations starting with a-m for the first core, and n-z for the second. So the first core will try <code>a</code>, then <code>aa</code> all the way to <code>az</code>, then <code>aaa</code> to <code>azz</code> etc all the way to <code>azzzzzzz</code> before it would guess the imaginary correct password: <code>ba</code>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525998630, "post_id": 50276516, "comment_id": 87583039, "body": "Yes. That&#39;s true. Shepmaster&#39;s approach is better."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 1, "last_activity_date": 1525998658, "last_edit_date": 1525998658, "creation_date": 1525966407, "answer_id": 50276516, "question_id": 50271746, "link": "https://stackoverflow.com/questions/50271746/how-can-i-use-rayon-to-split-a-big-range-into-chunks-of-ranges-and-have-each-thr/50276516#50276516", "title": "How can I use Rayon to split a big range into chunks of ranges and have each thread find within a chunk?", "body": "<p>This is a version of what I suggested in my comment.</p>\n\n<p>The main loop is parallel and is only over the first byte of each attempt. For each first byte, do the full brute force search for the remainder.</p>\n\n<pre><code>let matched_bytes = (0 .. 0xFFu8).into_par_iter().filter_map(|n| {\n    let mut array = [0u8; 8];\n    // the first digit is always the same in this run\n    array[0] = n;\n    // The highest byte is 0 because it's provided from the outer loop\n    (0 ..= 0x0FFFFFFFFFFFFFFF as u64).into_iter().filter_map(|i| {\n        // pass a slice so that the first byte is not affected\n        generate_char_array(i, &amp;mut array[1 .. 8]);\n        if &amp;password_bytes[..] == &amp;array[0 .. password_bytes.len()] {\n            Some(array.clone())\n        } else {\n            None\n        }\n    }).next()\n}).find_any(|_| true);\n\nprintln!(\"found = {:?}\", matched_bytes);\n</code></pre>\n\n<p>Also, even for a brute force method, this is probably highly inefficient still!</p>\n"}, {"comments": [{"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525970966, "post_id": 50277106, "comment_id": 87572186, "body": "It doesn&#39;t look like this code would work. Remember, there are always 26^length possible password combinations, so different possible amount of combinations depending on the length. True though that I could determine the ranges needed to be checked for each length, and just iterate those; as long as I can incrementally tests passwords in parallel in order of length, the performance can be good..."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525971053, "post_id": 50277106, "comment_id": 87572230, "body": "By the way I don&#39;t intend any strict sequencing of data processing, but what I was trying to do was to check in batches; so one thread would check, say, ints from 0..100000, another would grab 100000..20000, etc. and each thread is to be working on its batch, and when it&#39;s done, would grab a new batch."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525971076, "post_id": 50277106, "comment_id": 87572249, "body": "@AttilaSzeremi it isn&#39;t supposed to &quot;work&quot; \u2014 how could it considering you haven&#39;t provided 95% of your own code? What it does do is show the shape of the solution you need to implement. I&#39;ll clarify."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525972246, "post_id": 50277106, "comment_id": 87572866, "body": "Hang on, let me provide the code that worked with the help of the information you have provided me..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525972290, "post_id": 50277106, "comment_id": 87572887, "body": "@AttilaSzeremi you are encouraged to post your own answer with that."}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525972573, "post_id": 50277106, "comment_id": 87573034, "body": "So here it is: <a href=\"https://github.com/amcsi/rust-experimenting-password-cracker/commit/8f16495ecac4da0c13e6e45360cfc37a8439947c\" rel=\"nofollow noreferrer\">github.com/amcsi/rust-experimenting-password-cracker/commit/&zwnj;&#8203;&hellip;</a>  I got like a 6x speed improvement with parallelization on my 8 core CPU. That&#39;s a big success!"}, {"owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "edited": false, "score": 0, "creation_date": 1525974748, "post_id": 50277106, "comment_id": 87574091, "body": "I actually also tried linear range iterations rather than incremental ones, and turns out that it doesn&#39;t scale. Probably has to do with the spinning down thing you were talking about."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1525971835, "last_edit_date": 1525971835, "creation_date": 1525968490, "answer_id": 50277106, "question_id": 50271746, "link": "https://stackoverflow.com/questions/50271746/how-can-i-use-rayon-to-split-a-big-range-into-chunks-of-ranges-and-have-each-thr/50277106#50277106", "title": "How can I use Rayon to split a big range into chunks of ranges and have each thread find within a chunk?", "body": "<blockquote>\n  <p>This goes through the alphabet first for 1 character strings, then 2</p>\n</blockquote>\n\n<p>You wish to impose some sequencing on your data processing, but the whole point of Rayon is to go in parallel. </p>\n\n<p>Instead, use regular iterators to sequentially go up in length and then use parallel iterators inside a specific length to quickly process all of the values of that length. </p>\n\n<p>Since you haven't provided enough code for a runnable example, I've made this rough approximation to show the general shape of such a solution:</p>\n\n<pre><code>extern crate rayon;\n\nuse rayon::iter::{IntoParallelRefIterator, ParallelIterator};\nuse std::ops::RangeInclusive;\n\ntype Seed = u8;\n\nconst LENGTHS: RangeInclusive&lt;usize&gt; = 1..=3;\nconst SEEDS: RangeInclusive&lt;Seed&gt; = 0..=std::u8::MAX;\n\nfn find&lt;F&gt;(test_password: F) -&gt; Option&lt;(usize, Seed)&gt;\nwhere\n    F: Fn(usize, Seed) -&gt; bool + Sync,\n{\n    // Rayon doesn't support RangeInclusive yet\n    let seeds: Vec&lt;_&gt; = SEEDS.collect();\n\n    // Step 1-by-1 through the lengths, sequentially\n    LENGTHS.flat_map(|length| {\n        // In parallel, investigate every value in this length\n        // This doesn't do that, but it shows how the parallelization\n        // would be introduced\n        seeds\n            .par_iter()\n            .find_any(|&amp;&amp;seed| test_password(length, seed))\n            .map(|&amp;seed| (length, seed))\n    }).next()\n}\n\nfn main() {\n    let pass = find(|l, s| {\n        println!(\"{}, {}\", l, s);\n        // Actually generate and check the password based on the search criteria\n        l == 3 &amp;&amp; s == 250\n    });\n\n    println!(\"Found password length and seed: {:?}\", pass);\n}\n</code></pre>\n\n<p>This can \"waste\" a little time at the end of each length as the parallel threads spin down one-by-one before spinning back up for the next length, but that seems unlikely to be a primary concern.</p>\n"}, {"tags": [], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "is_accepted": false, "score": 0, "last_activity_date": 1526056081, "last_edit_date": 1526056081, "creation_date": 1526055908, "answer_id": 50296502, "question_id": 50271746, "link": "https://stackoverflow.com/questions/50271746/how-can-i-use-rayon-to-split-a-big-range-into-chunks-of-ranges-and-have-each-thr/50296502#50296502", "title": "How can I use Rayon to split a big range into chunks of ranges and have each thread find within a chunk?", "body": "<p>If Rayon splits the slices as you described, then apply simple math to balance the password lengths:</p>\n\n<pre><code>let found_string_index = (0..max_val as u64).into_par_iter().find_any(|i| {\n    let mut array = [0u8; 20];\n    let v = i/span + (i%span) * num_cpu;\n\n    let bytes = generate_char_array(*v, &amp;mut array);\n    return &amp;password_bytes == &amp;bytes;\n});\n</code></pre>\n\n<p>The <code>span</code> value depends on the number of CPUs (the number of threads used by Rayon), in your case:</p>\n\n<pre><code>let num_cpu = 4;\nlet span = 2.5e11 as u64;\nlet max_val = span * num_cpu;\n</code></pre>\n\n<p><strong>Note</strong> the performance of this approach is highly dependent on how Rayon performs the split of the sequence on parallel threads. Verify that it works as you reported in the question.</p>\n"}], "owner": {"reputation": 4251, "user_id": 1381550, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/da00aeca59e2404304c442ade1391802?s=128&d=identicon&r=PG", "display_name": "Attila Szeremi", "link": "https://stackoverflow.com/users/1381550/attila-szeremi"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1318, "favorite_count": 0, "accepted_answer_id": 50277106, "answer_count": 3, "score": 2, "last_activity_date": 1526056081, "creation_date": 1525951232, "last_edit_date": 1525965169, "question_id": 50271746, "link": "https://stackoverflow.com/questions/50271746/how-can-i-use-rayon-to-split-a-big-range-into-chunks-of-ranges-and-have-each-thr", "title": "How can I use Rayon to split a big range into chunks of ranges and have each thread find within a chunk?", "body": "<p>I am making a program that brute forces a password by parallelization. At the moment the password to crack is already available as plain text, I'm just attempting to brute force it anyway.</p>\n\n<p>I have a function called <code>generate_char_array()</code> which, based on an integer seed, converts base and returns a <code>u8</code> slice of characters to try and check. This goes through the alphabet first for 1 character strings, then 2, etc.</p>\n\n<pre><code>let found_string_index = (0..1e12 as u64).into_par_iter().find_any(|i| {\n    let mut array = [0u8; 20];\n    let bytes = generate_char_array(*i, &amp;mut array);\n    return &amp;password_bytes == &amp;bytes;\n});\n</code></pre>\n\n<p>With the found string index (or seed integer rather), I can generate the found string.</p>\n\n<p>The problem is that the way Rayon parallelizes this for me is split the arbitrary large integer range into <code>thread_count</code>-large slices (e.g. for 4 threads, 0..2.5e11, 2.5e11..5e11 etc). This is not good, because the end of the range is for arbitrarily super large password lengths (10+, I don't know), whereas most passwords (including the fixed \"zzzzz\" I tend to try) are much shorter, and thus what I get is that the first thread does all the work, and the rest of the threads just waste time testing way too long passwords and synchronizing; getting actually slower than single thread performance as a result.</p>\n\n<p><strong>How could I</strong> instead <strong>split the</strong> arbitrary <strong>big range</strong> (doesn't have to have an end actually) <strong>into chunks</strong> of ranges and have each thread find within chunks? That would make the workers in different threads actually useful.</p>\n"}, {"tags": ["rust", "stack", "move"], "owner": {"reputation": 1585, "user_id": 3193180, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/ZJHYL.jpg?s=128&g=1", "display_name": "kreo", "link": "https://stackoverflow.com/users/3193180/kreo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 50, "favorite_count": 0, "closed_date": 1525941870, "answer_count": 0, "score": 3, "last_activity_date": 1525940864, "creation_date": 1525940864, "question_id": 50268629, "link": "https://stackoverflow.com/questions/50268629/what-happens-to-the-stack-when-a-value-is-moved-in-rust", "closed_reason": "Duplicate", "title": "What happens to the stack when a value is moved in Rust?", "body": "<p>Trying to wrap my head around the Rust ownership system and how the compiler implements it. Consider the following example:</p>\n\n<pre><code>fn main() {\n    let my_vec = vec![1, 2, 3];\n    let x = 5;\n    let y = 3.7;\n\n    function_that_takes_ownership(my_vec);\n}\n\nfn function_that_takes_ownership(Vec&lt;i32&gt; vec) {\n    // ...\n}\n</code></pre>\n\n<p>What actually happens to the stack memory occupied by <code>my_vec</code> when <code>function_that_takes_ownership</code> is called?</p>\n\n<p>I guess, before the call the stack should look like this:</p>\n\n<pre><code>+-----------+\n|    ...    |\n+-----------+\n|   my_vec  | // contains size, capacity and a pointer to heap\n+-----------+\n|     x     |\n+-----------+\n|     y     | \n+-----------+  &lt;--- stack pointer points to here\n</code></pre>\n\n<p>What happens when <code>function_that_takes_ownership</code> is called? Is <code>my_vec</code> copy getting pushed to the stack again, while the old location is now considered unused? Or maybe a pointer to <code>my_vec</code> is actually getting pushed?</p>\n"}, {"tags": ["rust", "code-generation"], "answers": [{"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1525949800, "post_id": 50269536, "comment_id": 87559692, "body": "The book link you give only talks about custom derive. Can you make a procedural macro that <i>isn&#39;t</i> a custom derive?"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1525957144, "post_id": 50269536, "comment_id": 87563805, "body": "@trentcl Yes, you can. The most popular examples are <a href=\"https://serde.rs/attributes.html\" rel=\"nofollow noreferrer\">Serde</a> and <a href=\"https://mcarton.github.io/rust-derivative/\" rel=\"nofollow noreferrer\">Derivative</a>."}, {"owner": {"reputation": 74890, "user_id": 246776, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/PZwCJ.jpg?s=128&g=1", "display_name": "eonil", "link": "https://stackoverflow.com/users/246776/eonil"}, "edited": false, "score": 0, "creation_date": 1525962923, "post_id": 50269536, "comment_id": 87567332, "body": "It seems function-like macro can be implemented in two different ways. Template-like or by editing tokens."}], "tags": [], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "is_accepted": false, "score": 3, "last_activity_date": 1525963440, "last_edit_date": 1525963440, "creation_date": 1525944140, "answer_id": 50269536, "question_id": 50267237, "link": "https://stackoverflow.com/questions/50267237/how-to-derive-code-from-crate-module-functions/50269536#50269536", "title": "How to derive code from crate/module/functions?", "body": "<p>The <code>#[derive]</code> attribute is not allowed on modules, only on structs, enums and unions:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: `derive` may only be applied to structs, enums and unions\n --&gt; src/main.rs:1:1\n  |\n1 | #[derive(MyAgg)]\n  | ^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=cbc226524dad98e08d81ab618a5ddd4b&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p>Further information on extending the <code>#[derive]</code> macro can be found in <a href=\"https://doc.rust-lang.org/book/first-edition/procedural-macros.html\" rel=\"nofollow noreferrer\">Procedural Macros (and custom Derive)</a> in the Rust book.</p>\n\n<p>However, you could create your own procedural macro. You may consult the <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1566-proc-macros.md\" rel=\"nofollow noreferrer\">RFC</a> to understand <em>proc-macros</em>. It wouldn't hurt to also take a look at other crates like <a href=\"https://serde.rs/attributes.html\" rel=\"nofollow noreferrer\">Serde</a> or <a href=\"https://mcarton.github.io/rust-derivative/\" rel=\"nofollow noreferrer\">Derivative</a>.</p>\n"}, {"tags": [], "owner": {"reputation": 74890, "user_id": 246776, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/PZwCJ.jpg?s=128&g=1", "display_name": "eonil", "link": "https://stackoverflow.com/users/246776/eonil"}, "is_accepted": false, "score": 0, "last_activity_date": 1534453903, "last_edit_date": 1534453903, "creation_date": 1526219952, "answer_id": 50316890, "question_id": 50267237, "link": "https://stackoverflow.com/questions/50267237/how-to-derive-code-from-crate-module-functions/50316890#50316890", "title": "How to derive code from crate/module/functions?", "body": "<p>I found a workaround. You can spawn a Rust language parser and parse source code yourself.</p>\n\n<p>First, add a dependency to <code>Cargo.toml</code>.</p>\n\n<pre><code>[dependencies]\nsyntex_syntax = \"0.59.1\"\n</code></pre>\n\n<p>And add these lines to <code>src/main.rs</code>.</p>\n\n<pre><code>extern crate syntex_syntax;\n\nuse std::path::*;\nuse syntex_syntax::parse::*;\nuse syntex_syntax::codemap::*;\n\nfn main() {\n    let f = file!(); // Get absolute path to this file.\n    let p = Path::new(f);\n    let m = FilePathMapping::empty();\n    let s = ParseSess::new(m);\n    let r = parse_crate_from_file(&amp;p, &amp;s);\n    println!(\"{:?}\", r);\n}\n</code></pre>\n\n<p>Now you have a parsed AST.</p>\n\n<hr>\n\n<p>Update</p>\n\n<p>After several weeks of tries, I learned macro-expansion is done at syntax parsing stage. As it gets executed before type analysis stage, I cannot query fully resolved paths for each types, therefore stable referencing of multiple types from multiple module becomes very hard or impossible. Finally, I abandoned macro-based approach.</p>\n"}], "owner": {"reputation": 74890, "user_id": 246776, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/PZwCJ.jpg?s=128&g=1", "display_name": "eonil", "link": "https://stackoverflow.com/users/246776/eonil"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 404, "favorite_count": 0, "answer_count": 2, "score": 0, "last_activity_date": 1534453903, "creation_date": 1525935292, "last_edit_date": 1525963372, "question_id": 50267237, "link": "https://stackoverflow.com/questions/50267237/how-to-derive-code-from-crate-module-functions", "title": "How to derive code from crate/module/functions?", "body": "<p>As far as I know, Rust supports <code>#[derive]</code> attribute to generate code at compile time from data structures. How can I generate code for whole crate, module or functions? The <code>#[derive]</code> attribute is not allowed here.</p>\n\n<p>I want to generate a function which involves multiple items (structs/enums/functions) in the project.</p>\n\n<p>For example, for given example module here</p>\n\n<pre><code>#[derive(MyAgg)]\nmod AAA {\n    struct BBB {}\n    struct CCC {}\n    fn ddd() {}\n}\n</code></pre>\n\n<p>I want to produce this.</p>\n\n<pre><code>fn example1() {\n    print(\"{:?}\", AAA::BBB {});\n    print(\"{:?}\", AAA::CCC {});\n    AAA::ddd()\n}\n</code></pre>\n\n<p>This example doesn't make sense, but I think it delivers the point.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 4408, "user_id": 154680, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/1fe5646f7071126187fbda8c68c526f6?s=128&d=identicon&r=PG", "display_name": "russoue", "link": "https://stackoverflow.com/users/154680/russoue"}, "edited": false, "score": 0, "creation_date": 1525931010, "post_id": 50266085, "comment_id": 87550333, "body": "I think the <code>Default</code> trait might help me to return <code>0</code>."}, {"owner": {"reputation": 15864, "user_id": 1870153, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/juCKe.png?s=128&g=1", "display_name": "ljedrz", "link": "https://stackoverflow.com/users/1870153/ljedrz"}, "edited": false, "score": 1, "creation_date": 1525932421, "post_id": 50266085, "comment_id": 87550839, "body": "You are probably interested in one of the traits in the <code>Num</code> crate; such functionality is not provided in the <code>std</code>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1525963571, "post_id": 50266085, "comment_id": 87567805, "body": "<i><code>if maybe_num.is_ok() { return maybe_num.unwrap(); }</code></i>  \u2014 please never do this, this is an antipattern. Use pattern matching to avoid the <code>unwrap</code>: <code>if let Some(v) = maybe_num { return v; }</code>."}], "answers": [{"comments": [{"owner": {"reputation": 1470, "user_id": 2075745, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/6f9a084d236381e1882c4e28edb5151f?s=128&d=identicon&r=PG", "display_name": "user25064", "link": "https://stackoverflow.com/users/2075745/user25064"}, "edited": false, "score": 2, "creation_date": 1525952260, "post_id": 50266839, "comment_id": 87561037, "body": "<code>fn main() -&gt; Result&lt;()&gt;</code> My life is now complete"}], "tags": [], "owner": {"reputation": 4240, "user_id": 1541330, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/9d7b0057ffc24e644c4a30ba599d7753?s=128&d=identicon&r=PG&f=1", "display_name": "U007D", "link": "https://stackoverflow.com/users/1541330/u007d"}, "is_accepted": true, "score": 9, "last_activity_date": 1544368945, "last_edit_date": 1544368945, "creation_date": 1525933724, "answer_id": 50266839, "question_id": 50266085, "link": "https://stackoverflow.com/questions/50266085/is-there-a-trait-for-only-primitive-types-that-i-can-use-in-a-generic-function/50266839#50266839", "title": "Is there a trait for only primitive types that I can use in a generic function?", "body": "<p>The <code>Num</code> trait defined in the <a href=\"https://crates.io/crates/num\" rel=\"nofollow noreferrer\">num crate</a> should meet your needs, but what you are trying to do is not idiomatic in Rust, so I'd like to offer two suggestions:</p>\n\n<ol>\n<li>In some languages like C, for example, it is traditional to overload particular values like 0 or -1 with special meanings, but this has been shown to be a source of confusion and even hard bugs.</li>\n</ol>\n\n<p>Instead, consider using the <code>Result&lt;T, E&gt;</code> type if your function can fail to return a result for more than one reason or the <code>Option&lt;T&gt;</code> type if there is exactly one reason why your function might not be able to return a result.</p>\n\n<p>In your case, you might want to use a <code>Result&lt;T, E&gt;</code> so your function can communicate why the conversion failed--did the string contain invalid numeric characters?  Was the value out of range for the type that was requested?  Callers to your function may need to know to be able to best deal with the situation.</p>\n\n<ol start=\"2\">\n<li>The Rust standard library already includes the functionality you are looking for (conversion of strings to a value via a generic implementation) in the form of the <a href=\"https://doc.rust-lang.org/std/string/struct.String.html#method.parse\" rel=\"nofollow noreferrer\"><code>std::string::String::parse()</code></a> or the <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.parse\" rel=\"nofollow noreferrer\"><code>str::parse()</code></a> methods.  For reasons cited above, these methods do indeed return a <code>Result</code>.</li>\n</ol>\n\n<p>With the above two pieces of information, your code can now be rewritten more robustly as follows (using Rust 1.26+ to simplify error handling):</p>\n\n<pre><code>type Result&lt;T&gt; = std::result::Result&lt;T, Box&lt;std::error::Error&gt;&gt;;\n\nfn main() -&gt; Result&lt;()&gt; {\n    let num_str = String::from(\"12\");\n    println!(\"Converted to i32: {}\", num_str.parse::&lt;i32&gt;()?);\n    Ok(())\n}\n</code></pre>\n\n<p><a href=\"http://play.rust-lang.org/?gist=5669d09b2919b2a8a4d7bf9a2545d536&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground example</a></p>\n\n<p>In the event there is a problem, notice how nicely errors are reported:</p>\n\n<pre><code>type Result&lt;T&gt; = std::result::Result&lt;T, Box&lt;std::error::Error&gt;&gt;;\n\nfn main() -&gt; Result&lt;()&gt; {\n    let num_str = \"-1\";\n    println!(\"Invalid u32 conversion: {}\", num_str.parse::&lt;u32&gt;()?);\n    Ok(())\n}\n</code></pre>\n\n<p><a href=\"http://play.rust-lang.org/?gist=c1e12429a19ea9ec3374822e8fef0d50&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground example</a></p>\n\n<p>This prints <code>Error: ParseIntError { kind: InvalidDigit }</code> to the console and returns the value <code>std::libc::EXIT_FAILURE</code> to the calling process (signifying the program exited with an error) all without any value overloading or \"magic numbers\" required.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 5, "last_activity_date": 1525965290, "last_edit_date": 1525965290, "creation_date": 1525964405, "answer_id": 50275908, "question_id": 50266085, "link": "https://stackoverflow.com/questions/50266085/is-there-a-trait-for-only-primitive-types-that-i-can-use-in-a-generic-function/50275908#50275908", "title": "Is there a trait for only primitive types that I can use in a generic function?", "body": "<p>No, there is no such trait. Why? Because Rust doesn't need to care about distinguishing \"primitives\" from \"non-primitives\" as much as most other languages. Realistically, <em>why should it</em>?</p>\n\n<p>Additionally, note that <em>arrays</em> and <em>raw pointers</em> are also primitives; do you really wish to include those?</p>\n\n<blockquote>\n  <p>which I can use to make sure this function cannot be used for anything other than the number types.</p>\n</blockquote>\n\n<p>Why would you ever want to be <strong>artificially</strong> restricted on what types you can use? Why shouldn't your function work with any type that meets the basic criteria it needs? Who are you trying to protect yourself from?</p>\n\n<p>Your example can be shortened though:</p>\n\n<pre><code>fn get_num_from_str&lt;T: Default + FromStr&gt;(s: &amp;str) -&gt; T {\n    s.parse().unwrap_or_default()\n}\n</code></pre>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec) or Box (&amp;Box) as a function argument?</a></li>\n<li><a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.unwrap_or_default\" rel=\"nofollow noreferrer\"><code>Option::unwrap_or_default</code></a></li>\n<li><a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.parse\" rel=\"nofollow noreferrer\"><code>str::parse</code></a></li>\n</ul>\n"}], "owner": {"reputation": 4408, "user_id": 154680, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/1fe5646f7071126187fbda8c68c526f6?s=128&d=identicon&r=PG", "display_name": "russoue", "link": "https://stackoverflow.com/users/154680/russoue"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2331, "favorite_count": 0, "accepted_answer_id": 50266839, "answer_count": 2, "score": 7, "last_activity_date": 1544368945, "creation_date": 1525930200, "last_edit_date": 1525964415, "question_id": 50266085, "link": "https://stackoverflow.com/questions/50266085/is-there-a-trait-for-only-primitive-types-that-i-can-use-in-a-generic-function", "title": "Is there a trait for only primitive types that I can use in a generic function?", "body": "<p>I am trying to write a generic function which will try to convert a string to a number type like <code>i32</code>, <code>f64</code> etc.  If the string is not convertible then it will return <code>0</code>.  I am looking for an appropriate trait bound to use in my generic function below:</p>\n\n<pre><code>use std::str::FromStr;\n\nfn get_num_from_str&lt;T: FromStr&gt;(maybe_num_str: &amp;String) -&gt; T {\n    let maybe_num = T::from_str(maybe_num_str.as_str());\n    if maybe_num.is_ok() {\n        return maybe_num.unwrap();\n    }\n    0 as T\n}\n\nfn main() {\n    let num_str = String::from(\"12\");\n    println!(\"Converted to i32: {}\", get_num_from_str::&lt;i32&gt;(&amp;num_str));\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=a7bea7bd83f747c6c263b7f74ee5d333&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground Link</a></p>\n\n<p>I found that Rust had a <code>Primitive</code> trait before which was removed.  Is there something else now that can be used instead?</p>\n\n<p>I have found a workaround:</p>\n\n<pre><code>use std::str::FromStr;\n\nfn get_num_from_str&lt;T: Default + FromStr&gt;(maybe_num_str: &amp;String) -&gt; T {\n    let maybe_num = T::from_str(maybe_num_str.as_str());\n    maybe_num.unwrap_or(Default::default())\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=2b5a8151eb60578bec3441ea12a907df&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground Link</a></p>\n\n<p>This, as the trait bound suggests, should work for anything which has implementations for both <code>Default</code> and <code>FromStr</code> and I should rename the function to reflect that, but it would still be nice to know if there is any trait for the primitive number types only which I can use to make sure this function cannot be used for anything other than the number types.</p>\n"}, {"tags": ["rust", "pattern-matching", "move-semantics"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1526044301, "post_id": 50265128, "comment_id": 87602497, "body": "Coincidentally, <i>mere hours</i> after you posted this question, <a href=\"https://blog.rust-lang.org/2018/05/10/Rust-1.26.html\" rel=\"nofollow noreferrer\">Rust 1.26</a> was released, which includes (among other cool things) auto-referencing and dereferencing semantics for <code>match</code> patterns. This means that when  matching against <code>(&amp;self.root, &amp;bt.root)</code>, you can write <code>(Some(rt), Some(node))</code> and the compiler will intelligently turn <code>rt</code> and <code>node</code> into references. (<a href=\"https://play.rust-lang.org/?gist=6e91d8c5cbea662d434c6afcf8aa0172&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground</a>)"}], "answers": [{"tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": true, "score": 4, "last_activity_date": 1525924715, "creation_date": 1525924715, "answer_id": 50265249, "question_id": 50265128, "link": "https://stackoverflow.com/questions/50265128/why-is-an-explicit-borrow-required-in-rust-tuple-pattern-matching/50265249#50265249", "title": "Why is an explicit borrow required in Rust tuple pattern matching?", "body": "<p>The key is that <code>self.root</code> and <code>bt.root</code> are <a href=\"https://doc.rust-lang.org/reference/expressions.html#place-expressions-and-value-expressions\" rel=\"nofollow noreferrer\">\"place expression\"</a>s, whilst a tuple is not.  The reason #3 works is that the compiler knows how to \"reach through\" the intermediate expressions in order to bind to the original storage location.</p>\n\n<p>Another way you could look at it: very simple expressions like <code>self.root</code> are special in that they look and behave like values (and have a value type), but secretly the compiler remembers how it reached that value, allowing it to go back and get a pointer to where that value was read from.</p>\n\n<p>The easy way to work out if something is a \"place expression\" is to try assigning a value to it.  If you can do <code>expr = some_value;</code>, then <code>expr</code> must be a \"place expression\".  Incidentally, this is also why when you write <code>&amp;self.root</code>, you get a pointer to where <code>self.root</code> is being stored, rather than a pointer to a copy of <code>self.root</code>.</p>\n\n<p>This \"place expression\" business doesn't work for tuples because they don't have this property.  To construct a tuple, the compiler has to actually read the values for the tuple elements and move or copy them into new storage for the tuple.  This destroys any place associations the compiler might have had: those values are <em>literally</em> no longer where they used to be.</p>\n\n<p>Finally, you might want to look at <code>Option::as_ref</code>, which turns <code>&amp;Option&lt;T&gt;</code> into <code>Option&lt;&amp;T&gt;</code>.  That would let you match on <code>(self.root.as_ref(), bt.root.as_ref())</code>, with patterns like <code>(Some(rt), Some(node))</code>, which might be more convenient.</p>\n"}], "owner": {"reputation": 73, "user_id": 5570924, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6cf0ad67df4d5808ef0476daa8ec2441?s=128&d=identicon&r=PG&f=1", "display_name": "Allen Wang", "link": "https://stackoverflow.com/users/5570924/allen-wang"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 476, "favorite_count": 0, "accepted_answer_id": 50265249, "answer_count": 1, "score": 1, "last_activity_date": 1526045715, "creation_date": 1525923746, "last_edit_date": 1526045715, "question_id": 50265128, "link": "https://stackoverflow.com/questions/50265128/why-is-an-explicit-borrow-required-in-rust-tuple-pattern-matching", "title": "Why is an explicit borrow required in Rust tuple pattern matching?", "body": "<p>I am writing a binary tree in Rust, and the borrow checker really confuses me. Here is <a href=\"https://play.rust-lang.org/?gist=45c2ddb4855f5b41d69c635c16312927&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">a minimal example that reproduces the problem</a>.</p>\n\n<p>The binary tree is defined as follows:</p>\n\n<pre><code>struct NonEmptyNode;\n\npub struct BinaryTree {\n    root: Option&lt;NonEmptyNode&gt;,\n}\n</code></pre>\n\n<p>The code rejected by the borrow checker is:   </p>\n\n<pre><code>// Implementation #1\nfn set_child_helper(&amp;self, bt: &amp;Self, setter: fn(&amp;NonEmptyNode, &amp;NonEmptyNode)) -&gt; bool {\n    match (self.root, bt.root) {\n        (Some(ref rt), Some(ref node)) =&gt; {\n            setter(rt, node);\n            true\n        }\n        _ =&gt; false,\n    }\n}\n</code></pre>\n\n<p>The error message is</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of borrowed content\n  --&gt; src/main.rs:10:16\n   |\n10 |         match (self.root, bt.root) {\n   |                ^^^^ cannot move out of borrowed content\n\nerror[E0507]: cannot move out of borrowed content\n  --&gt; src/main.rs:10:27\n   |\n10 |         match (self.root, bt.root) {\n   |                           ^^ cannot move out of borrowed content\n</code></pre>\n\n<p>To make it work, the code has to be modified to:</p>\n\n<pre><code>// Implementation #2\nfn set_child_helper(&amp;self, bt: &amp;Self, setter: fn(&amp;NonEmptyNode, &amp;NonEmptyNode)) -&gt; bool {\n    match (&amp;self.root, &amp;bt.root) {\n        // explicit borrow\n        (&amp;Some(ref rt), &amp;Some(ref node)) =&gt; {\n            // explicit borrow\n            setter(rt, node);\n            true\n        }\n        _ =&gt; false,\n    }\n}\n</code></pre>\n\n<p>If I pattern-match one variable at a time without an explicit borrow, the borrow checker won't complain at all:</p>\n\n<pre><code>// Implementation #3\nfn set_child_helper(&amp;self, bt: &amp;Self, setter: fn(&amp;NonEmptyNode, &amp;NonEmptyNode)) -&gt; bool {\n    match self.root {\n        Some(ref rt) =&gt; match bt.root {\n            // No explict borrow will be fine\n            Some(ref node) =&gt; {\n                // No explicit borrow will be fine\n                setter(rt, node);\n                true\n            }\n            _ =&gt; false,\n        },\n        _ =&gt; false,\n    }\n}\n</code></pre>\n\n<p>Why does implementation #3 not require an explicit borrow, while implementation #1 does?</p>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1525918025, "post_id": 50263863, "comment_id": 87546923, "body": "I believe your question is already answered by <a href=\"https://stackoverflow.com/q/35249309/155423\">Result of Option::map does not live long enough</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50263863/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1525919091, "post_id": 50263863, "comment_id": 87547155, "body": "It is also answered by <a href=\"https://stackoverflow.com/q/26056210/155423\">Lifetime of Option::map&#39;s argument</a>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1525920195, "post_id": 50263863, "comment_id": 87547434, "body": "The duplicate&#39;s information <a href=\"https://play.rust-lang.org/?gist=a8e0b0d861cc8e46fb0f006aaef175fa&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">applied to your situation</a>."}, {"owner": {"reputation": 13169, "user_id": 967945, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/47244a17f72cee237f57f4c4b9613ea1?s=128&d=identicon&r=PG", "display_name": "Dan Hulme", "link": "https://stackoverflow.com/users/967945/dan-hulme"}, "edited": false, "score": 0, "creation_date": 1526370754, "post_id": 50263863, "comment_id": 87705701, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/35249309/result-of-optionmap-does-not-live-long-enough\">Result of Option::map does not live long enough</a>"}], "owner": {"reputation": 1567, "user_id": 2628048, "user_type": "registered", "accept_rate": 42, "profile_image": "https://i.stack.imgur.com/1pVHc.jpg?s=128&g=1", "display_name": "Rudolf Schmidt", "link": "https://stackoverflow.com/users/2628048/rudolf-schmidt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 246, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1525917917, "creation_date": 1525912312, "last_edit_date": 1525917917, "question_id": 50263863, "link": "https://stackoverflow.com/questions/50263863/borrowed-value-does-not-live-long-enough-in-optionmap", "title": "Borrowed value does not live long enough in Option::map", "body": "<p>Compiling the following snippet:</p>\n\n<pre><code>use std::env;\n\nfn main() {\n    let base = env::home_dir()\n        .map(|p| p.join(\".foo\"))\n        .map(|p| p.join(\"bar\"))\n        .map(|p| p.display())\n        .expect(\"dir not loadable\");\n    println!(\"Name: {}\", base)\n}\n</code></pre>\n\n<p>I get the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `p` does not live long enough\n  --&gt; src/main.rs:7:18\n   |\n7  |         .map(|p| p.display())\n   |                  ^         - `p` dropped here while still     borrowed\n   |                  |\n   |                  borrowed value does not live long enough\n...\n18 | }\n   | - borrowed value needs to live until here\n</code></pre>\n\n<p>What is the reason of that mistake? What is the solution?</p>\n"}]