[{"tags": ["rust", "lifetime"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1567696133, "post_id": 57795545, "comment_id": 102048337, "body": "The immediate problem resembles <a href=\"https://stackoverflow.com/q/44343166/3650362\">How do I write the lifetimes for references in a type constraint when one of them is a local reference?</a> Putting an HRTB on <code>T</code> alerts you that <code>SomeBigBorrower&lt;&#39;_&gt;</code> doesn&#39;t satisfy the constraint. You can use <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=8e3e4d90545045ddf28cb4b796729abf\" rel=\"nofollow noreferrer\">a &quot;family&quot; trait</a> to make it work by deferring the choice of <code>&#39;a</code> to inside <code>do_stuff</code> (but you probably should look for another solution)."}], "answers": [{"comments": [{"owner": {"reputation": 23, "user_id": 2312937, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/02921dc742111a04e589ab3c649405c9?s=128&d=identicon&r=PG", "display_name": "user2312937", "link": "https://stackoverflow.com/users/2312937/user2312937"}, "edited": false, "score": 0, "creation_date": 1567636963, "post_id": 57795680, "comment_id": 102025859, "body": "Is there a way to create the object in a proxy function with a Trait? Ideally I would like to hide the fact of creating the intermediate object as it&#39;s an implementation detail, I only want to pass the trait to the first function. Now that I understand the problem better, isn&#39;t that the same issue as <a href=\"https://stackoverflow.com/questions/28029565/confused-about-using-trait-with-lifetime-as-generic-parameter-constraint\" title=\"confused about using trait with lifetime as generic parameter constraint\">stackoverflow.com/questions/28029565/&hellip;</a>? Basically I can&#39;t pass the trait without lifetime constraint..."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 23, "user_id": 2312937, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/02921dc742111a04e589ab3c649405c9?s=128&d=identicon&r=PG", "display_name": "user2312937", "link": "https://stackoverflow.com/users/2312937/user2312937"}, "edited": false, "score": 0, "creation_date": 1567673697, "post_id": 57795680, "comment_id": 102035572, "body": "That is indeed the same problem, and also highlights the fact that it just cannot be done directly right now. There is simply no way to express this lifetime requirement in a way that satisfies the conditions right now. One question - on the creation of the object - is the root object (<code>Borrowed</code> in your case) shared in any way, or copied? If not, you might as well get <code>Borrowee</code> to take ownership of it."}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 3, "last_activity_date": 1567696563, "last_edit_date": 1567696563, "creation_date": 1567631413, "answer_id": 57795680, "question_id": 57795545, "link": "https://stackoverflow.com/questions/57795545/passing-local-lifetime-to-satisfy-trait/57795680#57795680", "title": "Passing local lifetime to satisfy trait", "body": "<p>You've just hit one of the issues with lifetimes and the compiler. Once you realize why it happens, it makes sense.</p>\n\n<p>Your method call enforces a lifetime <code>'a</code> for the generic type you're providing. This means, amongst other things, that this lifetime needs to be respected and that all objects are required to live for that long. In practice, when you are doing that, the lifetime is that of the function call.</p>\n\n<p>By passing <code>T::new()</code> a reference to a local variable, you are forcing the compiler to pick a lifetime that is inferior to <code>'a</code> (since it will not outlive the function call), and thus, you are going against your own requirements.</p>\n\n<p>Typically, the way you solve this is to split your <code>do_stuff&lt;'a, T&gt;</code> into two, like on <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1b2584bfcff28e5f0395d8f5ec1703c8\" rel=\"nofollow noreferrer\">this playground sample</a>. This makes the lifetime check palatable by the compiler, seeing as the life expectancy of that reference is <strong>guaranteed</strong> to be longer than that of the function being called.</p>\n\n<p>Do note that I renamed your method <code>new</code> in the trait and implementations to <code>borrow</code>, as that's closer to what it is.</p>\n"}], "owner": {"reputation": 23, "user_id": 2312937, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/02921dc742111a04e589ab3c649405c9?s=128&d=identicon&r=PG", "display_name": "user2312937", "link": "https://stackoverflow.com/users/2312937/user2312937"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 89, "favorite_count": 0, "accepted_answer_id": 57795680, "answer_count": 1, "score": 2, "last_activity_date": 1567696563, "creation_date": 1567630626, "question_id": 57795545, "link": "https://stackoverflow.com/questions/57795545/passing-local-lifetime-to-satisfy-trait", "title": "Passing local lifetime to satisfy trait", "body": "<p>I have a generic function creating a local object and taking a trait specifying what to do with that object. The trait takes the reference to the object and holds it for it's lifetime (to avoid passing it again and again to every function call). It dies before the </p>\n\n<pre><code>fn do_stuff&lt;'a, T&gt;()\n  where T : BigBorrower&lt;'a&gt;\n{\n  let borrowee = Borrowed{ data : 1 };\n  {\n    let _borrowee = T::new(&amp;borrowee);\n  }\n}\n</code></pre>\n\n<p>This is the function call. Because the lifetime for trait has to be specified in function declaraion, it makes the compiler think the lifetime extends lifetime of _borrowee.</p>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a445fb4ab7befefbadd3bdb8fb43c86a\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a445fb4ab7befefbadd3bdb8fb43c86a</a></p>\n\n<pre><code>   |\n24 | fn do_stuff&lt;'a, T&gt;()\n   |             -- lifetime `'a` defined here\n...\n29 |     let _borrowee = T::new(&amp;borrowee);\n   |                     -------^^^^^^^^^-\n   |                     |      |\n   |                     |      borrowed value does not live long enough\n   |                     argument requires that `borrowee` is borrowed for `'a`\n30 |   }\n31 | }\n   | - `borrowee` dropped here while still borrowed\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1567626282, "post_id": 57794849, "comment_id": 102022913, "body": "Did you take a look at the documentation of <a href=\"https://doc.rust-lang.org/nightly/std/io/type.Result.html\" rel=\"nofollow noreferrer\"><code>std::io::Result</code></a>? You will find that it actually takes only a single type parameter."}, {"owner": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1567626375, "post_id": 57794849, "comment_id": 102022946, "body": "Oh! You&#39;re completely right, it&#39;s not the same as <code>Result</code>, hence &quot;Expected io::Error&quot;"}, {"owner": {"reputation": 55, "user_id": 4017367, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/38237f486d8c96317e40976204bf1845?s=128&d=identicon&r=PG", "display_name": "guesty", "link": "https://stackoverflow.com/users/4017367/guesty"}, "edited": false, "score": 0, "creation_date": 1616010326, "post_id": 57794849, "comment_id": 117872703, "body": "i like the way they gave different things the same name"}, {"owner": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "reply_to_user": {"reputation": 55, "user_id": 4017367, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/38237f486d8c96317e40976204bf1845?s=128&d=identicon&r=PG", "display_name": "guesty", "link": "https://stackoverflow.com/users/4017367/guesty"}, "edited": false, "score": 0, "creation_date": 1616019779, "post_id": 57794849, "comment_id": 117876154, "body": "@guesty they did, but they didn&#39;t. The module <code>std::io</code> means that the name <code>Result</code> is safe from shadowing, I just wasn&#39;t paying attention. In my code, I even noted <code>io::Result</code>"}], "answers": [{"comments": [{"owner": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "edited": false, "score": 0, "creation_date": 1567626460, "post_id": 57794943, "comment_id": 102022977, "body": "Thanks, makes sense. Made the mistake of thinking <code>io::Result</code> is the same as <code>Result</code>, which it&#39;s not"}], "tags": [], "owner": {"reputation": 2966, "user_id": 3022310, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/7f10ec2b45320ee843e539d705c31d08?s=128&d=identicon&r=PG", "display_name": "turbulencetoo", "link": "https://stackoverflow.com/users/3022310/turbulencetoo"}, "is_accepted": false, "score": 7, "last_activity_date": 1567626357, "creation_date": 1567626357, "answer_id": 57794943, "question_id": 57794849, "link": "https://stackoverflow.com/questions/57794849/result-getting-unexpected-type-argument/57794943#57794943", "title": "Result getting unexpected type argument", "body": "<p>A common pattern in Rust is if your module uses a lot of <code>Result&lt;T, ModuleSpecificErrorType&gt;</code>, then you can make a custom <code>Result&lt;T&gt;</code> that abstracts out the error type. This custom type has one fewer generic parameter because the error type is hardcoded.</p>\n\n<p>A <code>std::io::Result&lt;T&gt;</code> is an abstraction over <code>std::result:Result&lt;T, std::io::Error&gt;</code>. </p>\n\n<p>See <a href=\"https://doc.rust-lang.org/std/io/type.Result.html\" rel=\"noreferrer\">the documentation for <code>io::Result</code></a>. </p>\n"}, {"comments": [{"owner": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "edited": false, "score": 1, "creation_date": 1567626694, "post_id": 57794978, "comment_id": 102023066, "body": "Fantastic. Yeah, looking back, I&#39;m also just <i>moving</i> the ownership problem to <code>params</code>, which cannot be passed to the <code>BasicExample</code> constructor anyways, because it&#39;s still an Option&lt;borrowed <code>String</code>&gt;. Time to go back to The Book and error handling :)"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "edited": false, "score": 1, "creation_date": 1567626812, "post_id": 57794978, "comment_id": 102023109, "body": "We&#39;ve all started somewhere. The key is to learn and improve, although error handling can be difficult to get right the first time. I know I&#39;m guilty of having created balls of spaghetti before on that very topic :-)"}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 8, "last_activity_date": 1567626549, "creation_date": 1567626549, "answer_id": 57794978, "question_id": 57794849, "link": "https://stackoverflow.com/questions/57794849/result-getting-unexpected-type-argument/57794978#57794978", "title": "Result getting unexpected type argument", "body": "<p>This is actually a super basic error, but one that looks arcane until you get to know (and love) <code>std::io</code>.</p>\n\n<p>In short, <code>std::result::Result</code> (the result you know) !== <code>std::io::Result</code>. The documentation for the first is <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html\" rel=\"noreferrer\">here</a>, while the second is <a href=\"https://doc.rust-lang.org/std/io/type.Result.html\" rel=\"noreferrer\">here</a></p>\n\n<p>You'll notice on the second one that it is actually a type alias to <code>Result&lt;T, std::io::Error&gt;</code>. What this means is that it is effectively shorthand for that, where your error case is an instance of <code>std::io::Error</code>.</p>\n\n<p>As a result, your code is incorrect when you are attempting to just <code>Err()</code> it with a string slice (since the slice is not <code>std::io::Error</code>, evidently).</p>\n\n<p>There are multiple ways to fix this:</p>\n\n<ul>\n<li>You can convert your entire error chain to another type (explicitly or by taking advantage of <code>into()</code> casts)</li>\n<li>You can make your own errors return <code>std::io::Error</code> instances</li>\n</ul>\n\n<p>There are valid cases for both options, which is why I'm mentioning both. The second is done relatively easily, like so (full paths are there for documentation purposes). Suppose you're returning an error which matches an entity not found. You would be able to do it like so:</p>\n\n<pre><code>`Err(std::io::Error::new(std::io::ErrorKind::NotFound, \"Could not read values into AzureAuthentication struct\"))`\n</code></pre>\n\n<p>There is, however, a better way for your function:</p>\n\n<pre><code>pub fn from_config(filename: &amp;str) -&gt; io::Result&lt;Self&gt; {\n    let file = File::open(filename)?;\n    let args: Vec&lt;String&gt; = read_config(file); // This has no error possibility\n\n    let params: Option&lt;(String, String, String, String)&gt; = args.drain(0..4).tuples().next();\n    params.ok_or(std::io::Error::new(std::io::ErrorKind::NotFound, \"Could not read values into struct\")).map(|(a, b, c, d)| BasicExample::new(a,b,c,d))\n}\n</code></pre>\n\n<p>This removes all the indirection from your method and neatly folds away the error types, one by one, so you don't have to worry about them. The <code>Option</code> gets turned into a <code>Result</code> thanks to <code>ok_or</code>, and all is well in the best of worlds :-)</p>\n"}], "owner": {"reputation": 9079, "user_id": 7867968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/c6976c101b7e5d81ad398cedf6a2ab9b?s=128&d=identicon&r=PG&f=1", "display_name": "C.Nivs", "link": "https://stackoverflow.com/users/7867968/c-nivs"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1912, "favorite_count": 0, "accepted_answer_id": 57794978, "answer_count": 2, "score": 5, "last_activity_date": 1567626549, "creation_date": 1567625812, "question_id": 57794849, "link": "https://stackoverflow.com/questions/57794849/result-getting-unexpected-type-argument", "title": "Result getting unexpected type argument", "body": "<p>I am attempting to read values from a file in order to create a struct, and I'm getting a weird pair of errors. A super basic implementation of my code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate itertools;\n\nuse itertools::Itertools;\nuse std::io::{self, prelude::*, BufReader};\nuse std::fs::{self, File};\n\n// The struct I will unpack into\nstruct BasicExample {\n    a: String,\n    b: String,\n    c: String,\n    d: String,\n}\n\nimpl BasicExample {\n    pub fn new(a: String, b: String, c: String, d: String} -&gt; Self {\n        BasicExample {\n            a, b, c, d\n        }\n    }\n\n    // I'm expecting that reading from the config file might fail, so\n    // I want to return a Result that can be unwrapped. Otherwise an Err\n    // will be returned with contained value being &amp;'static str\n    pub fn from_config(filename: &amp;str) -&gt; io::Result&lt;Self, &amp;'static str&gt; {\n        let file = File::open(filename).expect(\"Could not open file\");\n\n        // read args into a Vec&lt;String&gt;, consuming file\n        let args: Vec&lt;String&gt; = read_config(file);\n\n        // I transfer ownership away from args here\n        let params: Option&lt;(String, String, String, String)&gt; = args.drain(0..4).tuples().next();\n\n        // Then I want to match and return, I could probably do if-let here\n        // but I don't have my hands around the base concept yet, so I'll \n        // leave that for later\n        match params {\n            Some((a, b, c, d)) =&gt; Ok(BasicExample::new(a, b, c, d)),\n            _ =&gt; Err(\"Could not read values into struct\")\n        }\n    }\n\n    fn read_config(file: File) -&gt; Vec&lt;String&gt; {\n        let buf = BufReader::new(file);\n\n        buf.lines()\n            .map(|l| l.expect(\"Could not parse line\"))\n            .collect()\n    }\n}\n</code></pre>\n\n<p>Running <code>cargo check</code> to make sure I didn't miss anything, I get the following error:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>error[E0107]: wrong number of type arguments: expected 1, found 2\n  --&gt; src/lib.rs:37:60\n   |\n37 |     pub fn from_config(filename: &amp;str) -&gt; io::Result&lt;Self, &amp;'static str&gt; {\n   |                                                            ^^^^^^^^^^^^ unexpected type argument\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0107`.\n</code></pre>\n\n<p>Seems a bit odd. <code>io::Result</code> should take <code>&lt;T, E&gt;</code>, and I've given it <code>E</code>, so let's remove that type argument and see what happens:</p>\n\n<pre class=\"lang-sh prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/lib.rs:54:22\n   |\n54 |             _ =&gt; Err(\"Could not read values into AzureAuthentication struct\"),\n   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected struct `std::io::Error`, found reference\n   |\n   = note: expected type `std::io::Error`\n              found type `&amp;'static str`\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0308`.\n</code></pre>\n\n<p>For some reason it is really not happy with the <code>E</code> I provided. I'm a complete beginner with rust, so maybe I'm just not sure what I'm looking at. What am I doing wrong here? The <code>itertools</code> ownership trick was borrowed (ha) from <a href=\"https://stackoverflow.com/a/43658017/7867968\">this wonderful answer</a>.</p>\n\n<h2>System Details:</h2>\n\n<ul>\n<li>macOS 10.13.6</li>\n<li>rustc 1.36.0 (a53f9df32 2019-07-03)</li>\n<li>cargo 1.36.0 (c4fcfb725 2019-05-15)</li>\n</ul>\n"}, {"tags": ["rust", "rust-cargo"], "comments": [{"owner": {"reputation": 7096, "user_id": 3990767, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0a5741a212e3b0e6bd46a8a1e6d76a4a?s=128&d=identicon&r=PG", "display_name": "SOFe", "link": "https://stackoverflow.com/users/3990767/sofe"}, "edited": false, "score": 0, "creation_date": 1567643715, "post_id": 57792943, "comment_id": 102027045, "body": "No, cargo doesn&#39;t pass it directly. But you&#39;re the one controlling the presence of a dependency, aren&#39;t you?"}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567675298, "post_id": 57792943, "comment_id": 102036473, "body": "It&#39;s not optimal, I wouldn&#39;t call it <i>a workaround</i>, it&#39;s the recommended approach for now. I&#39;d also remove the <code>bin-</code> prefix and use just <code>some-feature = [&quot;my-lib&#47;some-feature&quot;]</code>."}], "owner": {"reputation": 147, "user_id": 7400966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/6bb4f033405681004c456114b5ce9261?s=128&d=identicon&r=PG&f=1", "display_name": "davidMcneil", "link": "https://stackoverflow.com/users/7400966/davidmcneil"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 483, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1567616627, "creation_date": 1567616627, "question_id": 57792943, "link": "https://stackoverflow.com/questions/57792943/can-you-test-if-the-feature-of-a-dependency-is-set-using-the-cfg-macro", "title": "Can you test if the feature of a dependency is set using the `cfg!` macro?", "body": "<p>I am trying to test if a feature of one of my dependencies has been set using the <code>cfg!</code> macro.</p>\n\n<p>Below is an example:</p>\n\n<p>my-lib/Cargo.toml</p>\n\n<pre><code>[package]\nname = \"my-lib\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[features]\nsome-feature = []\n</code></pre>\n\n<p>my-lib/lib.rs</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn some_function() {\n    if cfg!(feature = \"some-feature\") {\n        println!(\"SET\");\n    } else {\n        println!(\"NOT SET\");\n    }\n}\n\n</code></pre>\n\n<p>my-bin/Cargo.toml</p>\n\n<pre><code>[package]\nname = \"my-bin\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[dependencies]\nmy-lib = { path = \"../my-lib\" }\n</code></pre>\n\n<p>my-bin/main.rs</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use my_lib;\n\nfn main() {\n    my_lib::some_function();\n\n    if cfg!(feature = \"my-lib/some-feature\") {\n        println!(\"is SET in bin\");\n    } else {\n        println!(\"is NOT SET in bin\");\n    }\n}\n</code></pre>\n\n<p>Below shows the output given different run conditions. I would expect the second scenario to show <code>is SET in bin</code>.</p>\n\n<pre><code>&gt; cargo run --features \"\"\nNOT SET\nis NOT SET in bin\n</code></pre>\n\n<pre><code>&gt; cargo run --features \"my-lib/some-feature\"\nSET\nis NOT SET in bin\n</code></pre>\n\n<p>A workaround is to add <code>bin-some-feature = [\"my-lib/some-feature\"]</code> to \"my-bin/Cargo.toml\" and change the check in \"my-bin/main.rs\" to <code>cfg!(feature = \"bin-some-feature\")</code>. This produces the desired output.</p>\n\n<pre><code>&gt; cargo run --features \"bin-some-feature\"\nSET\nis SET in bin\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 3, "creation_date": 1567597950, "post_id": 57787739, "comment_id": 102008902, "body": "Hi there! I think your question is answered by <a href=\"https://stackoverflow.com/questions/47992959/impl-add-for-type-alias-tuple-f64-f64\">this Q&amp;A</a>. Summary: a <code>type</code> alias does not create a new type; it&#39;s just an alias. That means writing an <code>impl</code> is like writing an impl for the aliased type and is subject to <a href=\"https://stackoverflow.com/questions/25413201/how-do-i-implement-a-trait-i-dont-own-for-a-type-i-dont-own\">orphan rules</a>. Please let us know if this answers your question!"}, {"owner": {"reputation": 332774, "user_id": 263525, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/ec289925069b35f18f1230b90dc654e5?s=128&d=identicon&r=PG", "display_name": "Denys S&#233;guret", "link": "https://stackoverflow.com/users/263525/denys-s%c3%a9guret"}, "edited": false, "score": 0, "creation_date": 1567598073, "post_id": 57787739, "comment_id": 102008972, "body": "You can&#39;t add an implementation for Object. You should define a trait and define a trait implementation. It&#39;s not much more work, you mainly have to add the method declarations."}, {"owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567598200, "post_id": 57787739, "comment_id": 102009047, "body": "thanks! @Lukas Kalbertodt"}], "owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 436, "favorite_count": 1, "closed_date": 1567598225, "answer_count": 0, "score": 1, "last_activity_date": 1567598239, "creation_date": 1567597631, "last_edit_date": 1567597978, "question_id": 57787739, "link": "https://stackoverflow.com/questions/57787739/why-do-i-get-an-error-cannot-define-inherent-impl-for-a-type-outside-of-the-c", "closed_reason": "Duplicate", "title": "Why do I get an error &quot;cannot define inherent `impl` for a type outside of the crate where the type is defined&quot; when writing an impl for a type alias?", "body": "<p>I hope to implement the function for type <code>OpResource</code>.</p>\n\n<pre><code>type OpResource = Object&lt;OC, Status&gt;;\n\nimpl OpResource {\n    pub fn get_parameter_values(&amp;self) -&gt; Vec&lt;ParameterValue&gt; {\n        self.spec\n            .parameter_values\n            .clone()\n            .or_else(|| Some(vec![]))\n            .unwrap()\n    }\n}\n</code></pre>\n\n<p>Then I got an error </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0116]: cannot define inherent `impl` for a type outside of the crate where the type is defined\n   |\n35 | / impl OpResource {\n36 | |     pub fn get_parameter_values(&amp;self) -&gt; Vec&lt;ParameterValue&gt; {\n37 | |         self.spec\n38 | |             .parameter_values\n...  |\n42 | |     }\n43 | | }\n   | |_^ impl for type defined outside of crate.\n   |\n   = note: define and implement a trait or new type instead\n</code></pre>\n\n<p>I can't understand where am I wrong, I just implement the function below the type, why it said I'm out of crate?</p>\n"}, {"tags": ["rust", "borrow-checker"], "answers": [{"tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 7, "last_activity_date": 1567597778, "last_edit_date": 1567597778, "creation_date": 1567597407, "answer_id": 57787673, "question_id": 57787483, "link": "https://stackoverflow.com/questions/57787483/understanding-immutable-borrows-in-loops/57787673#57787673", "title": "Understanding immutable borrows in loops", "body": "<p>You are not actually making an immutable borrow in the first case, or rather, it ends after the call to <code>len()</code> returns (as <code>len</code> returns a primitive type not holding a reference to what it was used on). This means that your loop is perfectly fine, since you hold the one and only mutable object.</p>\n\n<p>On the second one, you are creating a type that implements <code>Iterator&lt;Item = &amp;u32&gt;</code> and then iterating on that iterator. The iterator has an immutable borrow to your collection (how else could you call <code>next()</code> on it otherwise?). This is a bit hidden, but that's where the immutable borrow is and why you cannot do what you did.</p>\n\n<p>Typically, when working with iterators, and when you need to modify an element being iterated on, <code>iter_mut</code> is the way to go, for obvious reasons :-) </p>\n"}], "owner": {"reputation": 2932, "user_id": 7212809, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-VlOyJEUeeSc/AAAAAAAAAAI/AAAAAAAAAAA/AGDgw-jExBae7iJ2ALFtcMj_6BCoHGTMgw/mo/photo.jpg?sz=128", "display_name": "nz_21", "link": "https://stackoverflow.com/users/7212809/nz-21"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 127, "favorite_count": 0, "accepted_answer_id": 57787673, "answer_count": 1, "score": 3, "last_activity_date": 1567597778, "creation_date": 1567596678, "last_edit_date": 1567597273, "question_id": 57787483, "link": "https://stackoverflow.com/questions/57787483/understanding-immutable-borrows-in-loops", "title": "Understanding immutable borrows in loops", "body": "<p>I can't quite understand why this compiles:</p>\n\n<pre><code>fn main() {\n    let mut v = vec![1,2,3];\n\n    for i in 1..v.len() {\n            v[i] = 20;\n    }\n}\n</code></pre>\n\n<p>...and this doesn't:</p>\n\n<pre><code>fn main() {\n    let mut v = vec![1,2,3];\n\n    for (i,_) in v.iter().enumerate() {\n            v[i] = 20;\n    }\n}\n</code></pre>\n\n<p>Error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `v` as mutable because it is also borrowed as immutable\n --&gt; src/main.rs:6:13\n  |\n4 |     for (i,_) in v.iter().enumerate() {\n  |                  --------------------\n  |                  |\n  |                  immutable borrow occurs here\n  |                  immutable borrow later used here\n5 | \n6 |             v[i] = 20;\n  |             ^ mutable borrow occurs here\n</code></pre>\n\n<p>In both cases we make an immutable borrow (one when call <code>len()</code>, other when we call <code>iter()</code>).</p>\n\n<p>Thus, my expectation was that the 1st snippet should NOT compile -- we're making an mutable borrow when doing the assignment, when an immutable borrow exists. </p>\n\n<p>What am I misunderstanding?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 6673, "user_id": 777689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/19JOo.jpg?s=128&g=1", "display_name": "PeterT", "link": "https://stackoverflow.com/users/777689/petert"}, "edited": false, "score": 0, "creation_date": 1567596462, "post_id": 57787096, "comment_id": 102008106, "body": "you seem to be specifying a return type but not returning anything"}, {"owner": {"reputation": 35, "user_id": 8102039, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb9e02299a1a362cc48e8e1e63596347?s=128&d=identicon&r=PG&f=1", "display_name": "sambia39", "link": "https://stackoverflow.com/users/8102039/sambia39"}, "reply_to_user": {"reputation": 6673, "user_id": 777689, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/19JOo.jpg?s=128&g=1", "display_name": "PeterT", "link": "https://stackoverflow.com/users/777689/petert"}, "edited": false, "score": 0, "creation_date": 1567596857, "post_id": 57787096, "comment_id": 102008334, "body": "even if I send back _img_load which is supposed to be the right type I still have the same mistake"}], "answers": [{"tags": [], "owner": {"reputation": 3029, "user_id": 1060004, "user_type": "registered", "accept_rate": 69, "profile_image": "https://i.stack.imgur.com/ZOBMa.jpg?s=128&g=1", "display_name": "ustulation", "link": "https://stackoverflow.com/users/1060004/ustulation"}, "is_accepted": false, "score": 1, "last_activity_date": 1567597961, "creation_date": 1567597961, "answer_id": 57787839, "question_id": 57787096, "link": "https://stackoverflow.com/questions/57787096/how-to-correct-the-error-wrong-number-of-type-arguments-expected-1-found-0-o/57787839#57787839", "title": "how to correct the error &quot;wrong number of type arguments: expected 1, found 0&quot; on sdl2::render::Canvas", "body": "<p>The context is not very clear here, but from what is given it seems <code>Canvas</code> is a generic type and thus should be supplied a type on which it's going to be specialised (implicit template specialisation).</p>\n\n<p>So <code>Canvas</code> probably is similar to: <code>struct Canvas&lt;T&gt; { .. }</code></p>\n\n<p>To use it either your function needs to be a template or <code>Canvas</code> needs to take a type parameter for it's template:</p>\n\n<pre><code>fn load_image&lt;T&gt;(... Canvas&lt;T&gt;)-&gt; Canvas&lt;T&gt; where T: ...{\n</code></pre>\n\n<p>or</p>\n\n<pre><code>fn load_image(... Canvas&lt;SomeSpecificType&gt;)-&gt; Canvas&lt;SomeSpecificType&gt; {\n</code></pre>\n\n<p>The call site (probably in <code>main</code> from the {unformatted and difficult to follow - please use some formatting} error message) then should instantiate <code>Canvas</code> accordingly:</p>\n\n<pre><code>let c = Canvas&lt;SomeSpecificType&gt; {  ... };\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 35, "user_id": 8102039, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb9e02299a1a362cc48e8e1e63596347?s=128&d=identicon&r=PG&f=1", "display_name": "sambia39", "link": "https://stackoverflow.com/users/8102039/sambia39"}, "edited": false, "score": 1, "creation_date": 1567872834, "post_id": 57788139, "comment_id": 102099320, "body": "Indeed, you are right and it works, thank you very much and I will try to be more careful next time ;)"}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 1, "last_activity_date": 1567599074, "creation_date": 1567599074, "answer_id": 57788139, "question_id": 57787096, "link": "https://stackoverflow.com/questions/57787096/how-to-correct-the-error-wrong-number-of-type-arguments-expected-1-found-0-o/57788139#57788139", "title": "how to correct the error &quot;wrong number of type arguments: expected 1, found 0&quot; on sdl2::render::Canvas", "body": "<p><a href=\"https://docs.rs/sdl2/0.32.2/sdl2/render/struct.Canvas.html\" rel=\"nofollow noreferrer\"><code>sdl2::render::Canvas</code></a> is defined as (as one can see in the documentation I linked):</p>\n\n<pre><code>struct Canvas&lt;T: RenderTarget&gt; { /* fields omitted */ }\n</code></pre>\n\n<p>This means it is generic over a <code>T</code>. As such you cannot use <code>sdl2::render::Canvas</code> just like that as it isn't a full type yet. You have to supply a generic parameter like <code>sdl2::render::Canvas&lt;WindowContext&gt;</code>. Without more context we cannot help you more than that.</p>\n\n<hr>\n\n<p>Apart from that, some general hints:</p>\n\n<ul>\n<li>Please use standard Rust formatting, including spacing and line breaks. You can use <code>rustfmt</code> to easily format your code. At the very least, format your code with <code>rustfmt</code> before asking on StackOverflow. You can use <a href=\"https://play.rust-lang.org/\" rel=\"nofollow noreferrer\">the Playground</a> to format your code with <code>rustfmt</code>. I edited your question to fix this.</li>\n<li>It is a very bad idea to start all variable names with <code>_</code> as this disables unused variable warnings. Those warnings have a purpose. And even if you don't like those warnings, rather use <code>#![allow(unused_variable)]</code> instead of adding an underscore to each variable name. To be clear: I still <strong>do not recommend</strong> ignoring these warnings!</li>\n<li><code>return</code> should be omitted in Rust when possible. In your case it's the last statement so just write <code>img_load</code>.</li>\n<li>Please at least try to make your StackOverflow question readable by formatting your code and error message. If you don't care, you can't expect others to care.</li>\n</ul>\n"}], "owner": {"reputation": 35, "user_id": 8102039, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb9e02299a1a362cc48e8e1e63596347?s=128&d=identicon&r=PG&f=1", "display_name": "sambia39", "link": "https://stackoverflow.com/users/8102039/sambia39"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 489, "favorite_count": 0, "accepted_answer_id": 57788139, "answer_count": 2, "score": 0, "last_activity_date": 1567599074, "creation_date": 1567595192, "last_edit_date": 1567598623, "question_id": 57787096, "link": "https://stackoverflow.com/questions/57787096/how-to-correct-the-error-wrong-number-of-type-arguments-expected-1-found-0-o", "title": "how to correct the error &quot;wrong number of type arguments: expected 1, found 0&quot; on sdl2::render::Canvas", "body": "<p>I am testing SDL2 under rust and I have written a function that is supposed to load an image how can I load my image and not have the following error \"wrong number of type arguments: expected 1, found 0\n\" on the second parameter of my function?</p>\n\n<pre><code> fn load_image(dtLoad: &amp;str, canva: sdl2::render::Canvas) -&gt; sdl2::render::Canvas {\n\n    let _img_load = {\n        let _x = match canva.texture_creator() {\n            Ok(_x) =&gt; _x, \n            Err(_) =&gt; panic!(\"Error create canva\"),\n        };\n        let _load = match _x.load_texture(dtLoad) {\n            Ok(_load) =&gt; _load,\n            Err(_) =&gt; panic!(\"Error load texture\\t:{}\", dtLoad),\n        };\n        canva.copy(&amp;_load, None, None);\n    };\n    return _img_load;\n}\n</code></pre>\n\n<p>I expect the function to load images with SDL Image into an <code>SDL_Surface</code> and return them to the caller. Except I get this error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0107]: wrong number of type arguments: expected 1, found 0\n --&gt; src/main.rs:4:60\n  |\n4 | fn load_image(dtLoad: &amp;str, canva: sdl2::render::Canvas) -&gt; sdl2::render::Canvas {\n  |                                                             ^^^^^^^^^^^^^^^^^^^^ expected 1 type argument\n</code></pre>\n"}, {"tags": ["loops", "rust", "iterator", "idioms"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567599027, "post_id": 57786566, "comment_id": 102009522, "body": "What do you want to do with the reminder? Can you edit the question with that?"}], "answers": [{"comments": [{"owner": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1567595768, "post_id": 57786907, "comment_id": 102007762, "body": "Thank you. I had <code>chunks_exact</code> and <code>zip</code> but couldn&#39;t achieve what I wanted with <code>chunks_exact_mut</code>. I&#39;ve accepted your answer because it does do exactly what I asked for... but I see that I simplified my example too far. I do want to deal with remainders. <code>ChunksExactMut</code> does have an <code>into_remainder</code> method but I don&#39;t know how to use it: the iterator is moved when it is passed into <code>zip</code> and it doesn&#39;t have a <code>clone</code> method. How can I call <code>into_remainder</code> and use the iterator in the for loop?"}, {"owner": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1567596820, "post_id": 57786907, "comment_id": 102008304, "body": "On second thoughts, I suppose I want something like <code>last()</code> or <code>rev().next()</code> rather than <code>into_remainder()</code> for the destination vector - but the problem remains. Given that <code>ChunksExactMut</code> does not have a <code>clone</code> method, how do I call a method on it after using it in the for loop? Or do I have to create a new iterator?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1567598218, "post_id": 57786907, "comment_id": 102009057, "body": "You can use <code>chunks</code> instead of <code>chunks_exact</code>, but you will need to check the length of the slice in each case, to avoid going out of bounds. In my experience, using <code>into_remainder</code>  is usually tricky!"}, {"owner": {"reputation": 9443, "user_id": 3616050, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/yQfMD.png?s=128&g=1", "display_name": "bluss", "link": "https://stackoverflow.com/users/3616050/bluss"}, "reply_to_user": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1567638048, "post_id": 57786907, "comment_id": 102026061, "body": "@c-- You can lend the iterator to the .zip - and then access it afterwards. Like  <code>let myiter = ... ; for ... in ... .zip(&amp;mut myiter) { ... }   &#47;* Now do something with myiter *&#47;</code>"}, {"owner": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "reply_to_user": {"reputation": 9443, "user_id": 3616050, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/yQfMD.png?s=128&g=1", "display_name": "bluss", "link": "https://stackoverflow.com/users/3616050/bluss"}, "edited": false, "score": 0, "creation_date": 1567676118, "post_id": 57786907, "comment_id": 102036921, "body": "@bluss thank you very much! That&#39;s what I was missing."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 3, "last_activity_date": 1567594424, "creation_date": 1567594424, "answer_id": 57786907, "question_id": 57786566, "link": "https://stackoverflow.com/questions/57786566/how-can-this-loop-be-turned-into-idiomatic-rust/57786907#57786907", "title": "How can this loop be turned into idiomatic Rust?", "body": "<p>What is \"idiomatic\" can be a matter of opinion, but you can make use of more iterator methods, like <code>zip</code> and <code>chunks_exact_mut</code>:</p>\n\n<pre><code>fn foo(src: &amp;[u8]) -&gt; Vec&lt;u8&gt; {\n    let dst_len = (src.len() / 3) * 4;\n    let mut dst = vec![0 as u8; dst_len];\n    for (s, d) in src.chunks_exact(3).zip(dst.chunks_exact_mut(4)) {\n        let v = bar(s[0], s[1], s[2]);\n        d[0] = baz(v, 0);\n        d[1] = baz(v, 1);\n        d[2] = baz(v, 2);\n        d[3] = baz(v, 3);\n    }\n    dst\n}\n</code></pre>\n\n<p>I used <code>chunks_exact</code> and <code>chunks_exact_mut</code> rather than <code>chunks</code> because it guarantees that the slice has the requested length, making them available separately if you need them. This seems to match your original code, which rounds off the length to an exact number of steps.</p>\n"}, {"comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1567601519, "post_id": 57787659, "comment_id": 102010850, "body": "Note that <a href=\"https://rust.godbolt.org/z/ETCeSs\" rel=\"nofollow noreferrer\">looking at the assembly</a>, the first version <i>seems</i> to be better optimized, but someone good at interpreting the assembly could confirm, or not."}, {"owner": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1569591279, "post_id": 57787659, "comment_id": 102657949, "body": "Thank you - this is great! Thanks also for the links to the Compiler Explorer. I didn&#39;t know that it supports Rust. Looking at the assembly, I can see that these versions are much less performant than the for loop ones: there&#39;s a lot of unnecessary memory allocation going on. It&#39;s a pity that the higher-level, functional-style code results in worse object code."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "edited": false, "score": 0, "creation_date": 1569591625, "post_id": 57787659, "comment_id": 102658100, "body": "@c-- Unfortunately, the &quot;zero cost abstraction&quot; claim isn&#39;t always true. There is a lot of work remaining to optimize the iterators, but I don&#39;t know if the team is on this issue currently."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 1, "last_activity_date": 1567613031, "last_edit_date": 1567613031, "creation_date": 1567597359, "answer_id": 57787659, "question_id": 57786566, "link": "https://stackoverflow.com/questions/57786566/how-can-this-loop-be-turned-into-idiomatic-rust/57787659#57787659", "title": "How can this loop be turned into idiomatic Rust?", "body": "<p>I would go with that:</p>\n\n<pre><code>fn foo(src: &amp;[u8]) -&gt; Vec&lt;u8&gt; {\n    src.chunks_exact(3)\n        .map(|s| bar(s[0], s[1], s[2]))\n        .flat_map(|v| (0..4).map(move |i| baz(v, i)))\n        .collect()\n}\n</code></pre>\n\n<p>Or if you prefer:</p>\n\n<pre><code>fn foo(src: &amp;[u8]) -&gt; Vec&lt;u8&gt; {\n    src.chunks_exact(3)\n        .map(|s| bar(s[0], s[1], s[2]))\n        .flat_map(|v| vec![baz(v, 0), baz(v, 1), baz(v, 2), baz(v, 3)])\n        .collect()\n}\n</code></pre>\n\n<p>Not sure if you find one of them better.</p>\n"}], "owner": {"reputation": 368, "user_id": 9328044, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/892ab608aa12dbf3a63c8e376efc72da?s=128&d=identicon&r=PG&f=1", "display_name": "c--", "link": "https://stackoverflow.com/users/9328044/c"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 251, "favorite_count": 0, "accepted_answer_id": 57786907, "answer_count": 2, "score": 1, "last_activity_date": 1567613031, "creation_date": 1567593107, "last_edit_date": 1567598023, "question_id": 57786566, "link": "https://stackoverflow.com/questions/57786566/how-can-this-loop-be-turned-into-idiomatic-rust", "title": "How can this loop be turned into idiomatic Rust?", "body": "<p>Here is a working Rust function:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn foo(src: &amp;[u8]) -&gt; Vec&lt;u8&gt; {\n    let dst_len = (src.len() / 3) * 4;\n    let mut dst = vec![0 as u8; dst_len];\n\n    let mut si = 0;\n    let mut di = 0;\n    let n = (src.len() / 3) * 3;\n    for _ in (0 .. n).step_by(3) {\n        let v = bar(src[si], src[si+1], src[si+2]);\n        dst[di+0] = baz(v, 0);\n        dst[di+1] = baz(v, 1);\n        dst[di+2] = baz(v, 2);\n        dst[di+3] = baz(v, 3);\n        si += 3;\n        di += 4;\n    }\n\n    dst\n}\n</code></pre>\n\n<p>It works but that loop doesn't seem like idiomatic Rust. It indexes into arrays using manually managed indices, pretty much like a <code>for</code> loop in C.</p>\n\n<p>Is there a way to achieve the same result using Rust iterators? I think <code>chunked_exact</code> would work for iterating over <code>src</code>, but what about <code>dst</code>? What iterator could I <code>zip</code> with <code>src.chunked_exact</code> to write into <code>dst</code> in chunks?</p>\n"}, {"tags": ["rust", "future", "rust-actix", "actix-web"], "comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1567591038, "post_id": 57785707, "comment_id": 102005375, "body": "For the current compilation error, <code>fu.unit_error()</code> you are consuming error and mapping it into a  Unit <code>()</code> in here, so function needs to return <code>impl Future&lt;Item=HttpResponse, Error=()&gt;</code> , or you need to return your future without consuming <code>Error</code> from future"}, {"owner": {"reputation": 10595, "user_id": 325320, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/23bc4a16f6a4bac91accd76c8078cd35?s=128&d=identicon&r=PG", "display_name": "Mr.Wang from Next Door", "link": "https://stackoverflow.com/users/325320/mr-wang-from-next-door"}, "reply_to_user": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1567635912, "post_id": 57785707, "comment_id": 102025625, "body": "Thanks @&#214;merErden, yep, error type <code>()</code> is defined in <a href=\"https://github.com/rust-lang-nursery/futures-rs/blob/ded685d55f2b64a4c790f260b1aa001945ead508/futures-util/src/future/unit_error.rs#L30\" rel=\"nofollow noreferrer\">github.com/rust-lang-nursery/futures-rs/blob/&hellip;</a>.  The key question actually is how to overcome it. It seems futures.rs does not provide such a way?"}, {"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1567636519, "post_id": 57785707, "comment_id": 102025769, "body": "Why are you calling unit_error() ?"}], "answers": [{"tags": [], "owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "is_accepted": true, "score": 3, "last_activity_date": 1572369779, "last_edit_date": 1572369779, "creation_date": 1567674113, "answer_id": 57801958, "question_id": 57785707, "link": "https://stackoverflow.com/questions/57785707/how-do-i-convert-an-async-standard-library-future-to-futures-0-1/57801958#57801958", "title": "How do I convert an async / standard library future to futures 0.1?", "body": "<p><code>std::future</code> -> <code>future@0.1</code> conversion steps:</p>\n\n<ul>\n<li>The future needs to be <code>TryFuture</code> (<code>Output = Result&lt;T, E&gt;</code>)</li>\n<li>The future needs to be <code>Unpin</code> (you can use <code>boxed</code> combinator)</li>\n<li>Finally, you can call the <code>compat</code> combinator</li>\n</ul>\n\n<p>Your <code>inbound</code> function:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn inbound(\n    req: HttpRequest,\n    stream: web::Payload,\n) -&gt; impl Future&lt;Item = HttpResponse, Error = Error&gt; {\n    let fut = async_inbound(&amp;req, &amp;stream);\n    fut.unit_error().boxed_local().compat()\n}\n</code></pre>\n\n<p>The <code>inbound</code> function signature is fine, but the conversion isn't.</p>\n\n<p>The <code>async_inbound</code> function isn't <code>TryFuture</code> (because of <code>-&gt; HttpResponse</code>). You're trying to convert it with the <code>unit_error</code> combinator, but the result is <code>Result&lt;HttpResponse, ()&gt;</code> and you want <code>Result&lt;HttpResponse, Error&gt;</code>. Fixed <code>inbound</code> function:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn inbound(\n    req: HttpRequest,\n    stream: web::Payload,\n) -&gt; impl Future&lt;Item = HttpResponse, Error = Error&gt; {\n    let fut = async_inbound(req, stream);\n    fut.boxed_local().compat()\n}\n</code></pre>\n\n<p>Your <code>async_inbound</code> function:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>async fn async_inbound(req: &amp;HttpRequest, stream: &amp;web::Payload) -&gt; HttpResponse {\n    // ...\n}\n</code></pre>\n\n<p>The first issue here is to replace <code>-&gt; HttpResponse</code> with <code>-&gt; Result&lt;HttpResponse&gt;</code>. Another problem is that you're passing <code>reg</code> and <code>stream</code> by reference. Move them as there's no need to take a reference and you'll need <code>'static</code>. Fixed <code>async_inbound</code> function:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>async fn async_inbound(req: HttpRequest, stream: web::Payload) -&gt; Result&lt;HttpResponse&gt; {\n    let mut compat_stream = stream.compat();\n\n    while let Some(data) = compat_stream.try_next().await? {\n        println!(\"{:?}\", data);\n    }\n\n    Ok(HttpResponse::Ok().content_type(\"text/html\").body(\"RESP\"))\n}\n</code></pre>\n"}], "owner": {"reputation": 10595, "user_id": 325320, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/23bc4a16f6a4bac91accd76c8078cd35?s=128&d=identicon&r=PG", "display_name": "Mr.Wang from Next Door", "link": "https://stackoverflow.com/users/325320/mr-wang-from-next-door"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1585, "favorite_count": 0, "accepted_answer_id": 57801958, "answer_count": 1, "score": 3, "last_activity_date": 1572369959, "creation_date": 1567590191, "last_edit_date": 1572369959, "question_id": 57785707, "link": "https://stackoverflow.com/questions/57785707/how-do-i-convert-an-async-standard-library-future-to-futures-0-1", "title": "How do I convert an async / standard library future to futures 0.1?", "body": "<p>I want to use the <code>async</code> function to parse the inbound stream progressively, but actix-web requires <code>impl Future&lt;Item = HttpResponse, Error = Error&gt;</code> as the return value.</p>\n\n<p>How can I convert the future returned by <code>async</code> function to what actix-web requires?</p>\n\n<p>I'm using Rust 1.39 nightly and actix-web 1.0.7.</p>\n\n<p><strong>http_srv.rs</strong> :</p>\n\n<pre><code>use futures::compat::Stream01CompatExt;\nuse futures::future::{FutureExt, TryFutureExt};\nuse futures::stream::TryStreamExt;\nuse futures01::future::Future;\nuse futures01::stream::Stream;\nuse futures01::sync::mpsc; // for `try_next`\n\nuse actix_web::*;\nuse bytes::Bytes;\nuse futures_timer::Delay;\nuse std::time::Duration;\n\nfn inbound(\n    req: HttpRequest,\n    stream: web::Payload,\n) -&gt; impl Future&lt;Item = HttpResponse, Error = Error&gt; {\n    let fut = async_inbound(&amp;req, &amp;stream);\n\n    fut.unit_error().boxed_local().compat() // &lt;--- compliation error here.\n}\n\nasync fn async_inbound(req: &amp;HttpRequest, stream: &amp;web::Payload) -&gt; HttpResponse {\n    let mut compat_stream = stream.compat();\n    loop {\n        let result = compat_stream.try_next().await;\n        if let Err(e) = result {\n            warn!(\"Failed to read stream from {} : {}\", req.path(), e);\n            break;\n        }\n\n        if let Ok(option) = result {\n            match option {\n                None =&gt; {\n                    info!(\"Request ends\");\n                    break;\n                }\n                Some(data) =&gt; {\n                    println!(\"{:?}\", data);\n                }\n            }\n        }\n    }\n    HttpResponse::Ok().content_type(\"text/html\").body(\"RESP\")\n}\n\npub fn start(port: u16) {\n    info!(\"Starting HTTP server listening at port {} ...\", port);\n\n    let _ = HttpServer::new(|| {\n        App::new()\n            .wrap(middleware::DefaultHeaders::new().header(http::header::CACHE_CONTROL, \"no-cache\"))\n            .wrap(middleware::Logger::default())\n            .service(web::resource(\"/\").route(web::put().to_async(inbound)))\n    })\n    .bind(format!(\"0.0.0.0:{}\", port))\n    .expect(&amp;format!(\"Unable to bind on port {}\", port))\n    .run()\n    .expect(\"Failed to start HTTP server\");\n}\n</code></pre>\n\n<p><strong>Cargo.toml</strong>:</p>\n\n<pre><code>dependencies]\nlog = \"0.4.8\"\nenv_logger = \"0.6.2\"\nchrono = \"0.4.8\"\nactix = \"0.8.3\"\nbytes = \"0.4.12\"\nactix-utils = \"0.4.5\"\nfutures-timer = \"0.3\"\nfutures01 = { package = \"futures\", version = \"0.1\", optional = false }\n\n[dependencies.actix-web]\nversion = \"1.0.7\"\nfeatures = [\"ssl\"]\n\n# https://rust-lang-nursery.github.io/futures-rs/blog/2019/04/18/compatibility-layer.html\n# Rust\u2019s futures ecosystem is currently split in two: \n# On the one hand we have the vibrant ecosystem built around futures@0.1 with its many libraries working on stable Rust \n# and on the other hand there\u2019s std::future ecosystem with support for the ergonomic and powerful async/await language feature. \n# To bridge the gap between these two worlds we have introduced a compatibility layer as part of the futures@0.3 extension to std::future. \n[dependencies.futures-preview]\nversion = \"0.3.0-alpha.18\"\ndefault-features = false\nfeatures = [\"compat\", \"async-await\", \"nightly\"]\n</code></pre>\n\n<p><strong>Compilation Error</strong>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0271]: type mismatch resolving `&lt;std::pin::Pin&lt;std::boxed::Box&lt;dyn core::future::future::Future&lt;Output = std::result::Result&lt;actix_http::response::Response, ()&gt;&gt;&gt;&gt; as core::future::future::Future&gt;::Output == std::result::Result&lt;_, actix_http::error::Error&gt;`\n  --&gt; src/http_server.rs:39:55\n   |\n39 | fn inbound(req: HttpRequest, stream: web::Payload) -&gt; impl Future&lt;Item=HttpResponse, Error=Error&gt; {\n   |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected (), found struct `actix_http::error::Error`\n   |\n   = note: expected type `std::result::Result&lt;actix_http::response::Response, ()&gt;`\n              found type `std::result::Result&lt;_, actix_http::error::Error&gt;`\n   = note: required because of the requirements on the impl of `futures_core::future::TryFuture` for `std::pin::Pin&lt;std::boxed::Box&lt;dyn core::future::future::Future&lt;Output = std::result::Result&lt;actix_http::response::Response, ()&gt;&gt;&gt;&gt;`\n   = note: the return type of a function must have a statically known size\n</code></pre>\n"}, {"tags": ["mongodb", "rust", "actix-web"], "answers": [{"tags": [], "owner": {"reputation": 2589, "user_id": 2597447, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/897978470ac2d52fe71d4071c53d6579?s=128&d=identicon&r=PG", "display_name": "arve0", "link": "https://stackoverflow.com/users/2597447/arve0"}, "is_accepted": false, "score": 1, "last_activity_date": 1577657177, "last_edit_date": 1577657177, "creation_date": 1577656863, "answer_id": 59523674, "question_id": 57782519, "link": "https://stackoverflow.com/questions/57782519/how-to-store-actix-web-json-to-mongodb/59523674#59523674", "title": "How to store actix_web Json to mongodb?", "body": "<p>The <a href=\"https://docs.rs/mongodb/0.9.0/mongodb/struct.Collection.html#method.insert_one\" rel=\"nofollow noreferrer\">signature for <code>insert_one</code></a> is:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn insert_one(\n    &amp;self, \n    doc: Document, \n    options: impl Into&lt;Option&lt;InsertOneOptions&gt;&gt;\n) -&gt; Result&lt;InsertOneResult&gt;\n</code></pre>\n\n<p><code>Document</code> is <code>bson::Document</code>, an alias for <a href=\"https://docs.rs/bson/0.14.0/bson/ordered/struct.OrderedDocument.html\" rel=\"nofollow noreferrer\"><code>bson::ordered::OrderedDocument</code></a>.</p>\n\n<p>Your type <code>Weight</code> does not implement the trait <code>Into&lt;Document&gt;</code>, which is required for <code>weight::into()</code>. You could implement it, but a more idiomatic way would be using the <code>Serialize</code> trait with <code>bson::to_bson</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn store_weights(weights: Vec&lt;Weight&gt;) -&gt; Result&lt;&amp;'static str, Box&lt;dyn std::error::Error&gt;&gt; {\n    let conn = db.get()?;\n    let coll = conn.collection(\"weights\");\n\n    for weight in weights.iter() {\n        let document = match bson::to_bson(weight)? {\n            Document(doc) =&gt; doc,\n            _ =&gt; unreachable!(), // Weight should always serialize to a document\n        };\n        coll.insert_one(document, None)?;\n    }\n\n    Ok(\"ok\")\n}\n</code></pre>\n\n<p><strong>Notes:</strong></p>\n\n<ol>\n<li><p><code>to_bson</code> returns an enum, <a href=\"https://docs.rs/bson/0.14.0/bson/enum.Bson.html\" rel=\"nofollow noreferrer\"><code>Bson</code></a>, which can be <code>Array</code>, <code>Boolean</code>, <code>Document</code>, etc. We use <code>match</code> to make sure it is <code>Document</code>.</p></li>\n<li><p>I've used <code>?</code> instead of unwrap, to make use of the <code>Result</code> return type. Make sure the errors are <code>Into&lt;Error&gt;</code> for your <code>Result</code> type.</p></li>\n<li><p>Returning <code>&amp;'static str</code> instead of allocating a new <code>String</code> for each request.</p></li>\n</ol>\n"}], "owner": {"reputation": 390, "user_id": 417766, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/8b05e529ac72879fa692197f422a6af0?s=128&d=identicon&r=PG", "display_name": "Choumarin", "link": "https://stackoverflow.com/users/417766/choumarin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 266, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1577657177, "creation_date": 1567577987, "question_id": 57782519, "link": "https://stackoverflow.com/questions/57782519/how-to-store-actix-web-json-to-mongodb", "title": "How to store actix_web Json to mongodb?", "body": "<p>Trying to store incomming data into mongo using r2d2-mongodb and actix_web.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(Serialize, Deserialize, Debug)]\nstruct Weight {\n    desc: String,\n    grams: u32,\n}\n\nfn store_weights(weights: web::Json&lt;Vec&lt;Weight&gt;&gt;, db: web::Data&lt;Pool&lt;MongodbConnectionManager&gt;&gt;) -&gt; Result&lt;String&gt; {\n    let conn = db.get().unwrap();\n    let coll = conn.collection(\"weights\");\n    for weight in weights.iter() {\n        coll.insert_one(weight.into(), None).unwrap();\n    }\n    Ok(String::from(\"ok\"))\n}\n</code></pre>\n\n<p>I can't seem to understand what/how I need to convert weight into to use with <code>insert_one</code>.\nThe above code errors into <code>error[E0277]: the trait bound 'bson::ordered::OrderedDocument: std::convert::From&lt;&amp;api::weight::Weight&gt;' is not satisfied</code></p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567579923, "post_id": 57781630, "comment_id": 101999643, "body": "Two questions - do you particularly care about every byte of RAM, or can you live with having regions unused but not immediately deallocated? And can you roughly tell what part of your graph will be deallocated at the same time?"}, {"owner": {"reputation": 5358, "user_id": 1932452, "user_type": "registered", "accept_rate": 84, "profile_image": "https://www.gravatar.com/avatar/7dfca62a1e4eb69f39ce00152862c70e?s=128&d=identicon&r=PG", "display_name": "wyer33", "link": "https://stackoverflow.com/users/1932452/wyer33"}, "reply_to_user": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567609752, "post_id": 57781630, "comment_id": 102015757, "body": "@S&#233;bastienRenauld In my case, it&#39;s not necessary for the graph to be deallocated immediately.  Though, it can be quite large, so certainly before becoming a problem.  As far as what part of the graph needs to be deallocated, it really comes down to the references.  If one node is no longer required and it&#39;s the only connection between the rest of the graph and the subgraph beneath it, then the entire subgraph goes as well.  Outside of looking at the incoming edges, or Rc count, I&#39;m not sure how to tell this."}], "answers": [{"tags": [], "owner": {"reputation": 1213, "user_id": 544707, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/LVoaL.jpg?s=128&g=1", "display_name": "Anler", "link": "https://stackoverflow.com/users/544707/anler"}, "is_accepted": true, "score": 8, "last_activity_date": 1567589113, "creation_date": 1567589113, "answer_id": 57785382, "question_id": 57781630, "link": "https://stackoverflow.com/questions/57781630/how-to-prevent-a-stack-overflow-from-a-recursive-deallocation-when-using-rc-in-r/57785382#57785382", "title": "How to prevent a stack overflow from a recursive deallocation when using Rc in Rust?", "body": "<p>You can prevent the stack overflow by switching from recursive deallocation to iterative deallocation. In your concrete example, use this <code>Drop</code> impl instead:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// Show that we're freeing\nimpl Drop for MyGraph {\n    fn drop(&amp;mut self) {\n        let mut prev = self.previous.take();\n\n        while let Some(rc) = prev {\n            if let Ok(mut graph) = Rc::try_unwrap(rc) {\n                prev = graph.previous.take();\n            } else {\n                break;\n            }\n        }\n    }\n}\n</code></pre>\n\n<p>That is, drop every previous graph that can be freed (only has one reference) but before dropping it set its <code>previous</code> field to <code>None</code> (that's what <code>previous.take()</code> does) and proceed to drop the one returned by <code>previous.take()</code>.</p>\n\n<p>I recommend you to take a look to the tutorial <a href=\"https://rust-unofficial.github.io/too-many-lists/\" rel=\"noreferrer\">Learn Rust With Entirely Too Many Linked Lists</a> if you haven't, it touches the common hazards with linked structures including this one of recursive deallocation.</p>\n"}], "owner": {"reputation": 5358, "user_id": 1932452, "user_type": "registered", "accept_rate": 84, "profile_image": "https://www.gravatar.com/avatar/7dfca62a1e4eb69f39ce00152862c70e?s=128&d=identicon&r=PG", "display_name": "wyer33", "link": "https://stackoverflow.com/users/1932452/wyer33"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 313, "favorite_count": 0, "accepted_answer_id": 57785382, "answer_count": 1, "score": 6, "last_activity_date": 1567589113, "creation_date": 1567572234, "question_id": 57781630, "link": "https://stackoverflow.com/questions/57781630/how-to-prevent-a-stack-overflow-from-a-recursive-deallocation-when-using-rc-in-r", "title": "How to prevent a stack overflow from a recursive deallocation when using Rc in Rust?", "body": "<p>Is there a good way to prevent a stack overflow from a recursive deallocation when using Rc in Rust?  In my case, I have a kind of graph that can grow to be pretty large.  When part of the graph is no longer used, I expect it to be freed.  However, that can create a cascade of deallocations that eventually overflow the stack.  As an example, consider the code:</p>\n\n<pre class=\"lang-rs prettyprint-override\"><code>// This is a test to see how long of a DAG that we can make before we have a \n// problem freeing the graph due to a stack overflow from the memory frees.\n\n// External libraries\nuse std::rc::Rc;              \n\n// Graph that contains integers\nstruct MyGraph {    \n\n    // Random data\n    data : u32,               \n\n    // Previous link                                  \n    previous : Option &lt;Rc &lt;MyGraph&gt;&gt;,            \n} \n\n// Show that we're freeing    \nimpl Drop for MyGraph {\n    fn drop(&amp;mut self) {\n        println!(\"{}\",self.data);\n    }   \n}   \n\n\n// Create a long graph of things\nfn main() {\n\n    // Set the size of the problem.  This should crash things.\n    let m:u32 = 100000;      \n\n    // Create the first node\n    let mut node = Rc::new(MyGraph {                           \n        data : 0,                              \n        previous : None});\n\n    // Add a bunch of additional nodes\n    for i in 1..m {             \n        node = Rc::new(MyGraph {            \n            data : i,                                   \n            previous : Some(node.clone())});            \n    }\n\n    // Zip through the nodes to make sure we created the graph\n    {   \n        let mut node_p = node.clone();           \n        while node_p.previous.is_some() {\n            print!(\"{} \",node_p.data);    \n            node_p = node_p.previous.as_ref().unwrap().clone()\n        }\n    }\n    println!(\"\");\n\n    // Free the memory in the graph by constructing a new single element\n    node = Rc::new(MyGraph {                \n        data : 0,    \n        previous : None});    \n\n    // Denote we finished  \n    println!(\"Fin\");\n}   \n</code></pre>\n\n<p>It may depend on the underlying computer, but on mine it eventually crashes with</p>\n\n<pre><code>52418\n52417\n\nthread 'main' has overflowed its stack\nfatal runtime error: stack overflow\nAborted\n</code></pre>\n\n<p>If the size of the graph was smaller, say 3, the program would return    </p>\n\n<pre><code>2 1 \n2\n1\n0\nFin\n0\n</code></pre>\n\n<p>Now, this isn't unexpected.  The exact same thing happens in C++.  In C++, I can work around this problem by implementing my own kind of reference counting that deallocates iteratively.  My question is whether there's a better option in Rust for handling these deallocations.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 507143, "user_id": 1048572, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/7f2c4de95e8f4f8f5a71c3aaf0ed312a?s=128&d=identicon&r=PG", "display_name": "Bergi", "link": "https://stackoverflow.com/users/1048572/bergi"}, "edited": false, "score": 4, "creation_date": 1567558991, "post_id": 57780244, "comment_id": 101995134, "body": "<code>|</code> is not an argument in bash"}, {"owner": {"reputation": 1031, "user_id": 10919715, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d33ede762e1f928b26db57583853a772?s=128&d=identicon&r=PG&f=1", "display_name": "SmushyTaco", "link": "https://stackoverflow.com/users/10919715/smushytaco"}, "reply_to_user": {"reputation": 507143, "user_id": 1048572, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/7f2c4de95e8f4f8f5a71c3aaf0ed312a?s=128&d=identicon&r=PG", "display_name": "Bergi", "link": "https://stackoverflow.com/users/1048572/bergi"}, "edited": false, "score": 0, "creation_date": 1567559109, "post_id": 57780244, "comment_id": 101995154, "body": "@Bergi how do I use <code>|</code> then? Also I&#39;m using zsh lol"}, {"owner": {"reputation": 116, "user_id": 6866742, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-bp4nEbmAWYY/AAAAAAAAAAI/AAAAAAAAApk/S6wZ-LzdZ6w/photo.jpg?sz=128", "display_name": "Matt W", "link": "https://stackoverflow.com/users/6866742/matt-w"}, "edited": false, "score": 1, "creation_date": 1567559771, "post_id": 57780244, "comment_id": 101995281, "body": "Why do you need the pipe (<code>|</code>)?  The <code>less</code> command is usually used for pagination within the terminal. Most likely you want the entire output from the <code>unbuffer apt list</code> command to be parsed by Rust, no? If so, leave off the pipe and everything after it."}, {"owner": {"reputation": 507143, "user_id": 1048572, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/7f2c4de95e8f4f8f5a71c3aaf0ed312a?s=128&d=identicon&r=PG", "display_name": "Bergi", "link": "https://stackoverflow.com/users/1048572/bergi"}, "edited": false, "score": 0, "creation_date": 1567559779, "post_id": 57780244, "comment_id": 101995283, "body": "I&#39;ll guess you have to use <a href=\"https://docs.rs/os_pipe/0.8.1/os_pipe/fn.pipe.html\" rel=\"nofollow noreferrer\">the <code>pipe</code> crate</a> for that."}, {"owner": {"reputation": 507143, "user_id": 1048572, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/7f2c4de95e8f4f8f5a71c3aaf0ed312a?s=128&d=identicon&r=PG", "display_name": "Bergi", "link": "https://stackoverflow.com/users/1048572/bergi"}, "edited": false, "score": 1, "creation_date": 1567559959, "post_id": 57780244, "comment_id": 101995312, "body": "A hack would be to just <a href=\"https://stackoverflow.com/a/38551671/1048572\">send the entire script to a bash command</a> :-)"}, {"owner": {"reputation": 507143, "user_id": 1048572, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/7f2c4de95e8f4f8f5a71c3aaf0ed312a?s=128&d=identicon&r=PG", "display_name": "Bergi", "link": "https://stackoverflow.com/users/1048572/bergi"}, "edited": false, "score": 2, "creation_date": 1567560077, "post_id": 57780244, "comment_id": 101995334, "body": "Or maybe it&#39;s much easier: <a href=\"https://doc.rust-lang.org/std/process/index.html#handling-io\" rel=\"nofollow noreferrer\">doc.rust-lang.org/std/process/index.html#handling-io</a>"}], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 3, "last_activity_date": 1567590317, "creation_date": 1567590317, "answer_id": 57785738, "question_id": 57780244, "link": "https://stackoverflow.com/questions/57780244/why-isnt-this-command-running-properly/57785738#57785738", "title": "Why isn&#39;t this command running properly?", "body": "<p>Spawning a process via <code>Command</code> uses the system's native functionality to create a process. This is a low level feature and has little to do with your shell/terminal that you are used to. In particular, your shell (e.g. <code>bash</code> or <code>zsh</code>, running inside of your terminal) offers a lot more features. For example, piping via <code>|</code> is such a feature. <code>Command</code> does not support these features as the low level system's API doesn't. </p>\n\n<p>Luckily, the low level interface offers other means of achieving a lot of stuff. Piping for example is mostly just redirecting the standard inputs and outputs. You can do that with <code>Command::{stdin, stdout, sterr}</code>. Please see <a href=\"https://doc.rust-lang.org/std/process/index.html#handling-io\" rel=\"nofollow noreferrer\">this part of the documentation</a> for more information. </p>\n\n<p>There are a few very similar questions, which are not similar enough to warrent closing this as a dupe though:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/31666936/execute-a-shell-command\">Execute a shell command</a></li>\n<li><a href=\"https://stackoverflow.com/questions/49928601/why-does-the-compgen-command-work-in-the-linux-terminal-but-not-with-processco\">Why does the compgen command work in the Linux terminal but not with process::Command?</a>: mentions shell built-in commands that do not work with <code>Command</code>.</li>\n<li><a href=\"https://stackoverflow.com/questions/38847641/executing-find-using-stdprocesscommand-on-cygwin-does-not-work\">Executing <code>find</code> using <code>std::process::Command</code> on cygwin does not work</a></li>\n</ul>\n"}], "owner": {"reputation": 1031, "user_id": 10919715, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d33ede762e1f928b26db57583853a772?s=128&d=identicon&r=PG&f=1", "display_name": "SmushyTaco", "link": "https://stackoverflow.com/users/10919715/smushytaco"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 334, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1567590317, "creation_date": 1567558888, "last_edit_date": 1567589405, "question_id": 57780244, "link": "https://stackoverflow.com/questions/57780244/why-isnt-this-command-running-properly", "title": "Why isn&#39;t this command running properly?", "body": "<p>So I'm making a better command-line frontend for APT and I'm putting on some finishing touches and when the code below runs.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>Command::new(\"unbuffer\")\n    .arg(\"apt\")\n    .arg(\"list\")\n    .arg(\"|\")\n    .arg(\"less\")\n    .arg(\"-r\")\n    .status()\n    .expect(\"Something went wrong.\");\n</code></pre>\n\n<p>it spits out:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>E: Command line option 'r' [from -r] is not understood in combination with the other options.\n</code></pre>\n\n<p>but when I just run <code>unbuffer apt list | less -r</code> manually in my terminal it works perfectly. How do I get it to run properly when calling it in Rust?</p>\n"}, {"tags": ["rust", "rust-actix", "actix-web"], "answers": [{"tags": [], "owner": {"reputation": 1213, "user_id": 544707, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/LVoaL.jpg?s=128&g=1", "display_name": "Anler", "link": "https://stackoverflow.com/users/544707/anler"}, "is_accepted": false, "score": 0, "last_activity_date": 1568009340, "creation_date": 1568009340, "answer_id": 57848642, "question_id": 57779414, "link": "https://stackoverflow.com/questions/57779414/error-handling-and-conditional-chaining-of-actix-actors/57848642#57848642", "title": "Error handling and conditional chaining of Actix actors", "body": "<p>What I usually do is to have an <code>Error</code> type that agglomerates all different errors, the coercion to this type can be achieved implicitly by declaring the appropriate <code>From</code> implementations and what you are doing <code>from_err()</code> but here I am being explicit:</p>\n\n<p>I haven't tested this code snippet but this is how I have done it in projects I'm working on that use Actix:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>data.dal.send(m)\n    .map_err(Error::Mailbox)\n    .and_then(|res| res.map_err(Error::Service))\n    .and_then(move |invite| {\n        let email_input = email::SendLoginLink {\n            from: \"from_email\".to_string(),\n            to: \"to_email\".to_string(),\n        };\n        data.email_service.send(email_input)\n            .map_err(Error::Mailbox)\n            .and_then(|res| res.map_err(Error::Service))\n            .and_then(move |res| HttpResponse::Ok().json(EmailInvitationOutput { expires_at: invite.expires_at }))\n    })\n    .or_else(|err| {\n        debug!(\"{:#?}\", err);\n        ServiceError::InternalServerError.error_response()\n    })\n</code></pre>\n\n<p>(I'm assuming <code>ServiceError</code> implements <code>IntoFuture</code> just like <code>HttpResponse</code> does)</p>\n"}], "owner": {"reputation": 540, "user_id": 1374935, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/dd9b8e9ca7b3002b125a165e0e378b51?s=128&d=identicon&r=PG", "display_name": "States", "link": "https://stackoverflow.com/users/1374935/states"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 338, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1568009340, "creation_date": 1567549507, "question_id": 57779414, "link": "https://stackoverflow.com/questions/57779414/error-handling-and-conditional-chaining-of-actix-actors", "title": "Error handling and conditional chaining of Actix actors", "body": "<p>This is my first attempt at writing a small webservice with rust, using actix-web. </p>\n\n<p>The code below is a request handler that is intended to do three things, insert an entry in the database, send an email if that db call was successful, and then return a json payload as the response. </p>\n\n<p><code>data.dal</code> (database call) and <code>data.email_service</code> are references to Actors. </p>\n\n<p>The issue: is I am unable to capture the error returned by <code>data.dal</code>. Any attempt to reconfigure the below code seems to give me an error stating the compiler wasn't able to find a conversion from Actix Mailbox to [Type].</p>\n\n<p>Is there an alternate/better way to rewrite this? Basically when the request is issued, I'd like to be able to call Actor A. And if the result from A is Ok then call Actor B. If the results from both are okay return a JSON payload. If either A or B return an error (can have different error types), return an custom error message.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn register_email(\n    invitation: Json&lt;EmailInvitationInput&gt;,\n    data: web::Data&lt;AppState&gt;,\n) -&gt; impl Future&lt;Item=HttpResponse, Error=Error&gt; {\n    let m = dal::queries::CreateEmailInvitation { email: invitation.email.clone() };\n    data.dal.send(m)\n        .from_err()\n        .and_then(move |res| {\n            let invite = res.unwrap();\n            let email_input = email::SendLoginLink {\n                from: \"from_email\".to_string(),\n                to: \"to_email\".to_string(),\n            };\n            data.email_service.send(email_input)\n                .from_err()\n                .and_then(move |res| match res {\n                    Ok(_) =&gt; {\n                        Ok(HttpResponse::Ok().json(EmailInvitationOutput { expires_at: invite.expires_at }))\n                    }\n                    Err(err) =&gt; {\n                        debug!(\"{:#?}\", err);\n                        Ok(ServiceError::InternalServerError.error_response())\n                    }\n                })\n        })\n}\n</code></pre>\n"}, {"tags": ["c#", "rust", "interop"], "comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567520959, "post_id": 57773532, "comment_id": 101982670, "body": "Can you check whether the pointer addresses are actually the same going across the boundary?"}, {"owner": {"reputation": 43, "user_id": 12014867, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-XwZiLeIfWuI/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcboea77IvMTlj0mFPggtWo1SZXtA/photo.jpg?sz=128", "display_name": "MiBa", "link": "https://stackoverflow.com/users/12014867/miba"}, "reply_to_user": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567522035, "post_id": 57773532, "comment_id": 101983298, "body": "@S&#233;bastienRenauld resultPtr is 0x000002404d35d480 in C# and <code>println!(&quot;Pointer address {:p}&quot;,result)</code>; prints &quot;Pointer address 0x410437d650&quot; - not the same, or do i have to obtain the values differently? But result_data has the same as in c#."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567522737, "post_id": 57773532, "comment_id": 101983710, "body": "Yeah, it had nothing to do with that, I think. Writing up a solution."}, {"owner": {"reputation": 2943, "user_id": 9014308, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2b6e0464313ca63c239f5d973213daf9?s=128&d=identicon&r=PG&f=1", "display_name": "kunif", "link": "https://stackoverflow.com/users/9014308/kunif"}, "edited": false, "score": 0, "creation_date": 1567523942, "post_id": 57773532, "comment_id": 101984357, "body": "It looks different from the question, but is this article helpful? <a href=\"http://jakegoulding.com/rust-ffi-omnibus/slice_arguments/\" rel=\"nofollow noreferrer\">The Rust FFI Omnibus</a>"}], "answers": [{"comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 43, "user_id": 12014867, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-XwZiLeIfWuI/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcboea77IvMTlj0mFPggtWo1SZXtA/photo.jpg?sz=128", "display_name": "MiBa", "link": "https://stackoverflow.com/users/12014867/miba"}, "edited": false, "score": 0, "creation_date": 1567528631, "post_id": 57775177, "comment_id": 101986527, "body": "Perfect. glad to have helped! :-)"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 3, "creation_date": 1567530046, "post_id": 57775177, "comment_id": 101987055, "body": "You should use <code>result_slice.into_raw()</code> instead of <code>as_mut_ptr</code>, which means you can&#39;t forget to <code>mem::forget</code> <code>result_slice</code>."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1567530165, "post_id": 57775177, "comment_id": 101987094, "body": "@trentcl I wanted to highlight the issue and deliberately kept the <code>mem::forget</code> call as a result, as that&#39;s where the issue was. I will add a small disclaimer, though"}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 4, "last_activity_date": 1567530245, "last_edit_date": 1567530245, "creation_date": 1567526444, "answer_id": 57775177, "question_id": 57773532, "link": "https://stackoverflow.com/questions/57773532/how-to-create-an-array-in-rust-in-parallel-and-return-it-to-c/57775177#57775177", "title": "How to create an array in Rust in parallel and return it to C#?", "body": "<p>First off, apologies, the second half of the FFI barrier will be C. I have no suitable environment to showcase my C# skills.</p>\n\n<p>Let's start by summarizing your code a bit, and drop all the threading (since it does nothing but confuse us when the issue isn't there)</p>\n\n<p>The rust half is effectively this:</p>\n\n<pre><code>#[no_mangle]\npub extern \"C\" fn create_array(len: libc::c_int, result:*mut *mut libc::c_int){ // You're passing a pointer to a collection\n    let mut result_vec: Vec&lt;i32&gt; = vec![];  // You create a Vec&lt;&gt;\n    for i in 0..(len){\n        result_vec.push(i); // You fill it...\n    }\n    let result_data = result_vec.as_mut_ptr(); // You then get a *mut ptr to it\n    unsafe{\n        *result=result_data; // You then assign the content of the pointer-to-a-pointer of what you received to the result ptr you just acquired\n    }\n    std::mem::forget(result_data); // And then you forget your data, because it is referenced elsewhere\n}\n</code></pre>\n\n<p>This is before any changes. I've added comments to summarize what you ended up doing.</p>\n\n<p>And sure enough, I can reproduce the bug with this code when FFIing from C:</p>\n\n<p><a href=\"https://i.stack.imgur.com/IuU10.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/IuU10.png\" alt=\"enter image description here\"></a></p>\n\n<p>Here is the \"fixed\" version:</p>\n\n<pre><code>pub extern \"C\" fn create_array(len: libc::c_int,result:*mut *mut libc::c_int){\n    let mut results_vec: Vec&lt;i32&gt; = vec![];\n    for i in 0..(len) {\n      results_vec.push(i);\n    }\n\n    let mut result_slice = results_vec.into_boxed_slice(); // Change #1: Vec -&gt; Box&lt;[i32]&gt;\n    let result_data = result_slice.as_mut_ptr(); // We then get a *mut out of it\n    unsafe {\n        *result = result_data; // Same step as yours, we then overwrite the old pointer with its address\n        // Do note that you may have leaked memory there if the pointer is not null.\n        for i in 0..10 as isize{\n            println!(\"{}:{}\",i,ptr::read((*result).offset(i)));\n        }\n    }\n    // We then forget *the boxed slice*. This is the important bit.\n    std::mem::forget(result_slice);\n}\n</code></pre>\n\n<p>This works, at least with a small amount of test code written in C. The reason it works and the original version doesn't is that you were not forgetting the right thing, primarily - you were forgetting the <strong>pointer</strong> to the <code>Vec</code>, not the <code>Vec</code> itself. As a result, the entire chunk of memory was technically uninitialized and evidently used for something else in between the FFI usage and your printing out of the data.</p>\n\n<p>In practice, instead of calling <code>result_slice.as_mut_ptr()</code>, you'll be calling <code>Box::into_raw(result_slice)</code>, which has the advantage of not making you have to remember to <code>forget</code> the slice.</p>\n"}], "owner": {"reputation": 43, "user_id": 12014867, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-XwZiLeIfWuI/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcboea77IvMTlj0mFPggtWo1SZXtA/photo.jpg?sz=128", "display_name": "MiBa", "link": "https://stackoverflow.com/users/12014867/miba"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 250, "favorite_count": 2, "accepted_answer_id": 57775177, "answer_count": 1, "score": 4, "last_activity_date": 1567530245, "creation_date": 1567520011, "last_edit_date": 1567521076, "question_id": 57773532, "link": "https://stackoverflow.com/questions/57773532/how-to-create-an-array-in-rust-in-parallel-and-return-it-to-c", "title": "How to create an array in Rust in parallel and return it to C#?", "body": "<p>I try to create an array in parallel in Rust and return it to C# via DLL bindings. The first 4 elements are invalid. </p>\n\n<p>Without <code>ThreadPool</code> and synchronization, I get the right results. The real calculation is more complex, but the following code is a simplified version without real calculation.\nI have also tried <code>int*</code> instead of <code>IntPtr</code> but got the same invalid results.</p>\n\n<p>Finally, I am new to Rust and do welcome any suggestions to improve the code.</p>\n\n<p>Simplified Rust calculation</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub extern \"C\" fn create_array(len: libc::c_int, result:*mut *mut libc::c_int){\n    let mut result_vec: Vec&lt;libc::c_int&gt; = vec![0;len as usize];\n    let sync_result=Arc::new(Mutex::new(result_vec));\n    let pool=ThreadPool::new(6);\n\n    println!(\"From Thread\");\n    for i in 0..(len){\n        pool.execute({\n            let clone = Arc::clone(&amp;sync_result);\n            move||{\n            let mut result_vec = clone.lock().unwrap();\n            result_vec[i as usize]=i;\n            if i&lt;10{\n                println!(\"{}:{}\",i,result_vec[i as usize]);\n            }\n        }});\n    } \n    pool.join();\n\n    let  mut result_vec = Arc::try_unwrap(sync_result).unwrap().into_inner().unwrap();\n\n    println!(\"Unwrapped Vector\");\n    for i in 0..10{\n        println!(\"{}:{}\",i,result_vec[i as usize]);\n    }\n    let result_data = result_vec.as_mut_ptr();\n    unsafe{\n        println!(\"Raw data\");\n        *result=result_data;\n        for i in 0..10 as isize{\n            println!(\"{}:{}\",i,ptr::read(result_data.offset(i)));\n        }\n    }\n    std::mem::forget(result_data);\n}\n</code></pre>\n\n<p>C# Binding and function call</p>\n\n<pre><code>[DllImport(@\"libs\\OptimizationRust.dll\", CallingConvention = CallingConvention.Cdecl)]\nprivate static extern void create_array(int len, out IntPtr result);\npublic void RustCpuSerial()\n{\n    IntPtr resultPtr;\n    int len = 10000;\n    create_array(len,out resultPtr);\n\n    int[] results = new int[len];\n    Marshal.Copy(resultPtr, results, 0, results.Length);\n}\n</code></pre>\n\n<p>Rust output:</p>\n\n<pre><code>From Thread\n0:0\n5:5\n7:7\n8:8\n9:9\n1:1\n3:3\n4:4\n6:6\n2:2\n\nUnwrapped Vector\n0:0\n1:1\n2:2\n3:3\n4:4\n5:5\n6:6\n7:7\n8:8\n9:9\n\nRaw data\n0:0\n1:1\n2:2\n3:3\n4:4\n5:5\n6:6\n7:7\n8:8\n9:9\n</code></pre>\n\n<p>C# Output:</p>\n\n<pre><code>0:-314008176\n1:672\n2:-314139296\n3:672\n4:4\n5:5\n6:6\n7:7\n8:8\n9:9\n</code></pre>\n\n<p>Any ideas, what causes this behaviour?</p>\n"}, {"tags": ["rust", "borrow-checker", "ownership", "borrowing"], "comments": [{"owner": {"reputation": 847, "user_id": 5580553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/54ef1b5ab609a00c87909b5187cbca3f?s=128&d=identicon&r=PG&f=1", "display_name": "Fynn Becker", "link": "https://stackoverflow.com/users/5580553/fynn-becker"}, "edited": false, "score": 0, "creation_date": 1567518238, "post_id": 57772806, "comment_id": 101981074, "body": "I believe this is either the proposed duplicate or the compiler just throwing/optimizing that <code>s1 = s1 + &quot;World&quot;;</code> away. I mean, why would it even care about that line if you never read from <code>s1</code> afterwards. There is no need to mutate it if it does not affect any code that follows it."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 847, "user_id": 5580553, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/54ef1b5ab609a00c87909b5187cbca3f?s=128&d=identicon&r=PG&f=1", "display_name": "Fynn Becker", "link": "https://stackoverflow.com/users/5580553/fynn-becker"}, "edited": false, "score": 1, "creation_date": 1567518462, "post_id": 57772806, "comment_id": 101981206, "body": "@FynnBecker The all compiler checks (like type checking, borrow checking, ..) work on the unoptimized version. But yes, the fact that &quot;something is not used later&quot; is a big part why NLL work."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567518549, "post_id": 57772806, "comment_id": 101981255, "body": "Shreyas: if the linked duplicate does not answer your question in your opinion, please let us know. But yes, the answer to your question is basically &quot;NLL is smart about stuff&quot;. In your code, since <code>s2</code> isn&#39;t used after the first print, the compiler can treat it as dropped, thus <code>s1</code> is not considered borrowed anymore."}, {"owner": {"reputation": 31, "user_id": 4410772, "user_type": "registered", "profile_image": "https://graph.facebook.com/100003878147376/picture?type=large", "display_name": "Shreyas Shankar Srinivas", "link": "https://stackoverflow.com/users/4410772/shreyas-shankar-srinivas"}, "edited": false, "score": 1, "creation_date": 1567519203, "post_id": 57772806, "comment_id": 101981683, "body": "Lukas: It seems to. I guess NLL is the answer. But it also appears to break program semantics of mutable borrows at a glance. It becomes much harder to track lifetimes of a borrow in large functions if they are not defined by scope. All it takes is for one line of code to be commented in or out, to change the lifetime of a borrow. Would it be a good idea to raise an issue on rust&#39;s repo to add a warning for modifying a mutable reference when another mutable borrow exists as in my example?"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567520539, "post_id": 57772806, "comment_id": 101982433, "body": "I don&#39;t think it&#39;s correct to say &quot;it breaks semantics&quot;. Rust will always reject some safe programs, as rejecting only exactly unsafe programs is basically halting problem yada yada. NLL tries to reduce the number of safe programs Rust rejects. I am pretty sure some Rust experts thought really hard about why NLL is sound (i.e. does not allow unsafe programs to compile). Maybe I also misunderstood what you meant by &quot;break semantics&quot;. But I guess this is not a discussion for SO comments. <a href=\"https://chat.stackoverflow.com/rooms/62927/rust\">The chat</a> or the users forum might be more appropriate."}, {"owner": {"reputation": 31, "user_id": 4410772, "user_type": "registered", "profile_image": "https://graph.facebook.com/100003878147376/picture?type=large", "display_name": "Shreyas Shankar Srinivas", "link": "https://stackoverflow.com/users/4410772/shreyas-shankar-srinivas"}, "edited": false, "score": 0, "creation_date": 1567521650, "post_id": 57772806, "comment_id": 101983098, "body": "I am new here, so I don&#39;t have the reputation for joining the chat. Formally if one re-defines the borrow rules using lifetimes instead of scope and explains lifetimes properly (in the rust-book chapter 4), then there is no problem, at least formally. But this hasn&#39;t actually been mentioned in that chapter in the book. This is likely to create borrow checker issues that take a long time to trace when maintaining and modifying code with large lexical scopes. It breaks semantics in the user&#39;s head, especially if they are migrating from the 2015 edition and read the book as it is."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1567532524, "post_id": 57772806, "comment_id": 101987963, "body": "The book doesn&#39;t (as far as I am aware) discuss lifetimes in terms of <i>scope</i> at all. Where lifetimes are introduced in the book, they are introduced in terms of how they <i>disallow unsound code</i> (probably because the precise semantics are quite complex). The code in your question is not unsound, so there&#39;s no reason to assume (based on what&#39;s in the book) that it should be rejected. If there is (still) something in the book that led you to believe that lifetimes are based on scope, you should file an issue to improve it, since that&#39;s not true of Rust today."}, {"owner": {"reputation": 31, "user_id": 4410772, "user_type": "registered", "profile_image": "https://graph.facebook.com/100003878147376/picture?type=large", "display_name": "Shreyas Shankar Srinivas", "link": "https://stackoverflow.com/users/4410772/shreyas-shankar-srinivas"}, "edited": false, "score": 0, "creation_date": 1567536990, "post_id": 57772806, "comment_id": 101989663, "body": "True. But in chapter 4, the book essentially conflates scope with lifetime. In chapter 4-01: &quot;the memory is automatically returned once the variable that owns it goes out of scope&quot;. In chapter 4-02: &quot;mutable references have one big restriction: you can have only one mutable reference to a particular piece of data in a particular <i>scope</i>&quot;. Further in a code listing below, it is suggested that a block can be used to limit the <i>scope</i>. There is no indication that there is any difference between the lifetime and block scope of a borrow anywhere. A word on lifetimes and NLL is needed in 4-02."}, {"owner": {"reputation": 31, "user_id": 4410772, "user_type": "registered", "profile_image": "https://graph.facebook.com/100003878147376/picture?type=large", "display_name": "Shreyas Shankar Srinivas", "link": "https://stackoverflow.com/users/4410772/shreyas-shankar-srinivas"}, "edited": false, "score": 1, "creation_date": 1567600330, "post_id": 57772806, "comment_id": 102010248, "body": "I have raised an issue on the repository for the book : <a href=\"https://github.com/rust-lang/book/issues/2077\" rel=\"nofollow noreferrer\">github.com/rust-lang/book/issues/2077</a>"}], "owner": {"reputation": 31, "user_id": 4410772, "user_type": "registered", "profile_image": "https://graph.facebook.com/100003878147376/picture?type=large", "display_name": "Shreyas Shankar Srinivas", "link": "https://stackoverflow.com/users/4410772/shreyas-shankar-srinivas"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 100, "favorite_count": 0, "closed_date": 1567518380, "answer_count": 0, "score": 3, "last_activity_date": 1567517552, "creation_date": 1567517552, "question_id": 57772806, "link": "https://stackoverflow.com/questions/57772806/why-does-modifying-a-mutably-borrowed-variable-and-keeping-it-unused-not-throw-a", "closed_reason": "Duplicate", "title": "Why does modifying a mutably borrowed variable and keeping it unused not throw an error", "body": "<p>I have a piece of sample code here</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut s1: String = String :: from(\"Hello 2\");\nlet s2 = &amp;mut s1;\nprintln!(\"This is s2: {}\", s2);\ns1  = s1 + \"World\";\n//println!(\"This is s1 : {} and s2: {}\",s1,s2);\n</code></pre>\n\n<p>Please note that I have commented out the <code>println!()</code> statement. From my understanding of rust ownership and borrowing rules, rust does not permit more than one mutable reference to a mutable object at a time. Since s2 has borrowed mutably from s1, I understand that the compiler must throw an error. Yet this is what I get:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>warning: value assigned to `s1` is never read\n --&gt; src/main.rs:5:5\n  |\n5 |     s1  = s1 + \"World\";\n  |     ^^\n  |\n  = note: #[warn(unused_assignments)] on by default\n  = help: maybe it is overwritten before being read?\n\n    Finished dev [unoptimized + debuginfo] target(s) in 0.55s\n</code></pre>\n\n<p>When I uncomment the <code>println</code> line, I immediately get three errors. The error messages are as follows:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>error[E0506]: cannot assign to `s1` because it is borrowed\n --&gt; src/main.rs:5:5\n  |\n3 |     let s2 = &amp;mut s1;\n  |              ------- borrow of `s1` occurs here\n4 |     println!(\"This is s2: {}\", s2);\n5 |     s1  = s1 + \"World\";\n  |     ^^ assignment to borrowed `s1` occurs here\n6 |     println!(\"This is s1 : {}, s2 : {}\", s1, s2);\n  |                                              -- borrow later used here\n\nerror[E0505]: cannot move out of `s1` because it is borrowed\n --&gt; src/main.rs:5:11\n  |\n3 |     let s2 = &amp;mut s1;\n  |              ------- borrow of `s1` occurs here\n4 |     println!(\"This is s2: {}\", s2);\n5 |     s1  = s1 + \"World\";\n  |           ^^ move out of `s1` occurs here\n6 |     println!(\"This is s1 : {}, s2 : {}\", s1, s2);\n  |                                              -- borrow later used here\n\nerror[E0502]: cannot borrow `s1` as immutable because it is also borrowed as mutable\n --&gt; src/main.rs:6:42\n  |\n3 |     let s2 = &amp;mut s1;\n  |              ------- mutable borrow occurs here\n...\n6 |     println!(\"This is s1 : {}, s2 : {}\", s1, s2);\n  |                                          ^^  -- mutable borrow later used here\n  |                                          |\n  |                                          immutable borrow occurs here\n\nerror: aborting due to 3 previous errors\n</code></pre>\n\n<p>What is even more confusing is that no error is thrown and cargo builds without a hitch if I only println! <code>s1</code>, instead of both <code>s1</code> and <code>s2</code> at the end. The error remains if I only print <code>s2</code>.</p>\n\n<p>From my understanding of rust, shouldn't there be an error at <code>s1 = s1 + \"World\"</code> regardless of what I print after this assignment, since <code>s2</code> has already mutably borrowed <code>s1</code>? </p>\n"}, {"tags": ["python", "django", "redis", "rust", "django-redis"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567517373, "post_id": 57772373, "comment_id": 101980579, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/6731450/accents-stored-in-redis-not-being-readable\">Accents stored in Redis not being readable</a>"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567520062, "post_id": 57772373, "comment_id": 101982168, "body": "It&#39;s more complicated than that, and is honestly more of a <code>django-redis</code> question than a <code>rust</code> question as the culprit here is the data serialization done by django under the hood in order to be able to store variable types."}, {"owner": {"reputation": 3885, "user_id": 652528, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/a580420b66f89e76e1fb9a368f785b3f?s=128&d=identicon&r=PG", "display_name": "geckos", "link": "https://stackoverflow.com/users/652528/geckos"}, "edited": false, "score": 0, "creation_date": 1567573423, "post_id": 57772373, "comment_id": 101997495, "body": "Why not use json?"}, {"owner": {"reputation": 27, "user_id": 2025997, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4e8a28c9ea9ae0fe44d5f905cc26120e?s=128&d=identicon&r=PG", "display_name": "Rishav Banka", "link": "https://stackoverflow.com/users/2025997/rishav-banka"}, "reply_to_user": {"reputation": 3885, "user_id": 652528, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/a580420b66f89e76e1fb9a368f785b3f?s=128&d=identicon&r=PG", "display_name": "geckos", "link": "https://stackoverflow.com/users/652528/geckos"}, "edited": false, "score": 0, "creation_date": 1567577429, "post_id": 57772373, "comment_id": 101998657, "body": "@geckos django uses pickle by default. I am going to try and use JSON serializer as S&#233;bastien Renauld mentioned in the replies."}], "answers": [{"comments": [{"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 1, "creation_date": 1567548157, "post_id": 57773658, "comment_id": 101993320, "body": "I&#39;m not really advocating to use the Python pickle format for interoperability between Python and Rust, but if you want to, you can use <a href=\"https://github.com/birkenfeld/serde-pickle\" rel=\"nofollow noreferrer\"><code>serde-pickle</code></a> \u2013 no need to spend an unreasonable amount of time to get there."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 0, "creation_date": 1567548804, "post_id": 57773658, "comment_id": 101993444, "body": "I didn&#39;t know that existed! Adding it to the answer"}, {"owner": {"reputation": 27, "user_id": 2025997, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4e8a28c9ea9ae0fe44d5f905cc26120e?s=128&d=identicon&r=PG", "display_name": "Rishav Banka", "link": "https://stackoverflow.com/users/2025997/rishav-banka"}, "edited": false, "score": 0, "creation_date": 1567577526, "post_id": 57773658, "comment_id": 101998696, "body": "Thanks. I will try and add a cache with the same redis location using JSON serializer and use that across python and rust."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567598081, "post_id": 57773658, "comment_id": 102008978, "body": "Let me know if you get stuck, I may be able to help you further :-)"}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 2, "last_activity_date": 1567548917, "last_edit_date": 1567548917, "creation_date": 1567520500, "answer_id": 57773658, "question_id": 57772373, "link": "https://stackoverflow.com/questions/57772373/how-to-store-and-read-common-data-in-redis-from-python-and-rust/57773658#57773658", "title": "How to store and read common data in redis from python and rust?", "body": "<p>Ah, the joys of trying to throw data across environments. The thing you're being bitten by right now is called <a href=\"https://docs.python.org/3/library/pickle.html\" rel=\"nofollow noreferrer\"><code>Pickle</code></a> and is the default serializer of <code>django-redis</code>. What a serializer does in this case (in python) is the transformation of your data between python and redis so you can store it, regardless of the type, but more importantly so you can retrieve it <em>with the type it came in</em>.</p>\n\n<h1>The python side</h1>\n\n<p>Obviously, if you had infinite time and effort, you could rewrite <code>pickle</code> in rust and you'd then be able to read this format. I'm pretty sure you have neither, and depending on the data you're storing, you might not even want to do so.</p>\n\n<p>Instead, what I'm going to suggest is to change the serializer from <code>pickle</code> to <code>json</code>. The description of what to change in the config is located at <a href=\"https://django-redis-cache.readthedocs.io/en/latest/advanced_configuration.html#pluggable-serializers\" rel=\"nofollow noreferrer\">https://django-redis-cache.readthedocs.io/en/latest/advanced_configuration.html#pluggable-serializers</a> , and in particular, I'm pretty sure the class name you want to use is <code>django_redis.serializers.JSONSerializer</code>.</p>\n\n<p>This comes with drawbacks. In particular, there will be some object types you will no longer be able to store on the python side, but if you do really intend to read data on the rust side, this should not concern you.</p>\n\n<p><a href=\"https://stackoverflow.com/users/279627/sven-marnach\">Sven Marnach</a> mentioned in one of the comments that the <a href=\"https://github.com/birkenfeld/serde-pickle\" rel=\"nofollow noreferrer\"><code>serde-pickle</code></a> crate exists. I have not used it myself, but it does look promising and might save you a ton of interop work if it does function.</p>\n\n<h1>The rust side</h1>\n\n<p>To read stuff, now that every key is going to be json, you'll be decoding types with either <a href=\"https://serde.rs\" rel=\"nofollow noreferrer\"><code>serde</code></a> or <a href=\"https://github.com/dtolnay/miniserde\" rel=\"nofollow noreferrer\"><code>miniserde</code></a>. This should be pretty straightforward; do bear in mind that you will not get native types out of this; instead, you'll get members of the <code>serde::Value</code> enum (<code>Boolean</code>, <code>Number</code>, <code>Object</code>, etc), which you will then have to filter through.</p>\n\n<p>Edit your question to indicate what you are trying to store, and I'll happily expand on how to do this on here!</p>\n"}], "owner": {"reputation": 27, "user_id": 2025997, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4e8a28c9ea9ae0fe44d5f905cc26120e?s=128&d=identicon&r=PG", "display_name": "Rishav Banka", "link": "https://stackoverflow.com/users/2025997/rishav-banka"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 455, "favorite_count": 0, "accepted_answer_id": 57773658, "answer_count": 1, "score": 1, "last_activity_date": 1567572958, "creation_date": 1567515888, "last_edit_date": 1567572958, "question_id": 57772373, "link": "https://stackoverflow.com/questions/57772373/how-to-store-and-read-common-data-in-redis-from-python-and-rust", "title": "How to store and read common data in redis from python and rust?", "body": "<p>I have some data being stored in redis cache which will be read by my application in Rust. The data is being stored by python. Whenever I am storing a string or an array, it stores it in a weird form which I was not able to read into Rust. Vice versa, I want to write from Rust and be able to read it in python.</p>\n\n<p>Using django shell:</p>\n\n<pre><code>In [0]: cache.set(\"test\",\"abc\")\nIn [1]: cache.get(\"test\")\nOut[1]:'abc'\n</code></pre>\n\n<p>Using redis-cli:</p>\n\n<pre><code>127.0.0.1:6379&gt; GET :1:test\n\"\\x80\\x04\\x95\\a\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x03abc\\x94.\"\n</code></pre>\n\n<p>Output from Rust:</p>\n\n<pre><code>Err(Invalid UTF-8)\n</code></pre>\n\n<p>Rust code read data using redis-rs library:</p>\n\n<pre><code>    let client = redis::Client::open(\"redis://127.0.0.1:6379\")?;\n    let mut con = client.get_connection()?;\n    let q:Result&lt;String, redis::RedisError&gt; = con.get(\":1:test\");\n    println!(\"{:?}\",q);\n</code></pre>\n\n<p>I want to be able to read a string or array into Rust as it was written in Python and vice-versa.\nAlso, data in one key will only be ever written by either Rust or Python, not both.</p>\n\n<p>This question is not a duplicate of <a href=\"https://stackoverflow.com/questions/6731450/accents-stored-in-redis-not-being-readable\">this</a> as that deals specifically for accent encoding, however, I want to solve my problem for arrays as well. Moreover, the value being set in redis by django for a string is not simply the UTF encoding for the string.</p>\n"}, {"tags": ["rust", "equality"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567512865, "post_id": 57771512, "comment_id": 101978024, "body": "What did you try? A simple comparison works well! <code>record1 == record2</code>"}, {"owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567513032, "post_id": 57771512, "comment_id": 101978103, "body": "In fact, my custom type is more complicated then that, let me modify my question , thanks"}], "answers": [{"comments": [{"owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "edited": false, "score": 0, "creation_date": 1567514159, "post_id": 57771655, "comment_id": 101978743, "body": "how could I implement <code>Option&lt;Vec&lt;PValue&gt;&gt;</code> PartialEq?"}, {"owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "edited": false, "score": 1, "creation_date": 1567514939, "post_id": 57771655, "comment_id": 101979215, "body": "I have figured it out, just add PartialEq on top of the type PValue"}], "tags": [], "owner": {"reputation": 4491, "user_id": 1264974, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/6558cf06df3ccf1c49329f38fd843b7d?s=128&d=identicon&r=PG", "display_name": "justinas", "link": "https://stackoverflow.com/users/1264974/justinas"}, "is_accepted": true, "score": 6, "last_activity_date": 1567513261, "creation_date": 1567513261, "answer_id": 57771655, "question_id": 57771512, "link": "https://stackoverflow.com/questions/57771512/binary-operation-cannot-be-applied-to-type-x/57771655#57771655", "title": "Binary operation `==` cannot be applied to type X", "body": "<p><code>BTreeMap</code> implements:</p>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/std/collections/struct.BTreeMap.html#impl-Eq\" rel=\"noreferrer\">Eq</a> when both key and value types implement <code>Eq</code>.</li>\n<li><a href=\"https://doc.rust-lang.org/std/collections/struct.BTreeMap.html#impl-PartialEq%3CBTreeMap%3CK%2C%20V%3E%3E\" rel=\"noreferrer\">PartialEq</a> when both key and value types implement <code>PartialEq</code>.</li>\n</ul>\n\n<p>If all fields of your type implement <code>PartialEq</code>, you can easily derive <code>PartialEq</code> for the entire struct:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[derive(PartialEq)]\npub struct ComponentRecord {\n    config: String,\n    version: String,\n}\n</code></pre>\n\n<p>Then you'll be able to simply use the <code>==</code> operator on your maps:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub type RecordAnnotation = BTreeMap&lt;String, ComponentRecord&gt;;\n\nfn compare (a: &amp;RecordAnnotation, b: &amp;RecordAnnotation) -&gt; bool {\n    a == b\n}\n</code></pre>\n"}], "owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3326, "favorite_count": 0, "accepted_answer_id": 57771655, "answer_count": 1, "score": 4, "last_activity_date": 1567515682, "creation_date": 1567512661, "last_edit_date": 1567515682, "question_id": 57771512, "link": "https://stackoverflow.com/questions/57771512/binary-operation-cannot-be-applied-to-type-x", "title": "Binary operation `==` cannot be applied to type X", "body": "<p>I have a custom type:</p>\n\n<pre><code>pub struct PValue {\n    pub name: String,\n    pub value: Option&lt;serde_json::Value&gt;,\n    pub from: Option&lt;String&gt;,\n}\npub struct CC {\n    pub name: String,\n    pub inst_name: String,\n    pub pv: Option&lt;Vec&lt;PValue&gt;&gt;,\n}\n\npub struct ComponentRecord {\n    config: CC,\n    version: String,\n}\n\nlet cr = ComponentRecord {\n        version: \"123\".to_string(),\n        config: CC {\n            name: \"n123\".to_string(),\n            instance_name: \"inst123\".to_string(),\n            pv: None,\n        },\n    };\nlet newcr = ComponentRecord {\n        version: \"123\".to_string(),\n        config: ComponentConfiguration {\n            name: \"n123\".to_string(),\n            instance_name: \"inst123\".to_string(),\n            pv: None,\n        },\n    };\nassert_eq!(crgot, cr);\n</code></pre>\n\n<p>Then I got error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0369]: binary operation `==` cannot be applied to type `&amp;ComponentRecord`\n  --&gt; src/xxx_test.rs:39:5\n   |\n39 |     assert_eq!(crgot, cr);\n   |     ^^^^^^^^^^^^^^^^^^^^^^\n   |     |\n   |     ComponentRecord\n   |     ComponentRecord\n   |\n  = note: an implementation of `std::cmp::PartialEq` might be missing for `&amp;ComponentRecord`\n</code></pre>\n\n<p>How could I test two <code>RecordAnnotation</code> instance is equal?</p>\n\n<p>I was writing test for that, so I won't mind whether the performance is ok.</p>\n\n<p>In golang, I can use <a href=\"https://golang.org/pkg/reflect/#DeepEqual\" rel=\"nofollow noreferrer\">reflect.DeepEqual</a> to do that. I hope to find a common way to do in rust.</p>\n"}, {"tags": ["sqlite", "rust", "rust-cargo"], "comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 2, "creation_date": 1567513600, "post_id": 57771398, "comment_id": 101978397, "body": "If <code>sqlite3.dll</code> itself isn&#39;t, then all bets are off, essentially, or at least it would be if it was linux. I&#39;m not entirely sure about static linking on windows as I&#39;ve never had to need it, so there may still be a way forward, but it&#39;s looking very unlikely."}], "answers": [{"tags": [], "owner": {"reputation": 22505, "user_id": 1411457, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/XqssD.png?s=128&g=1", "display_name": "harmic", "link": "https://stackoverflow.com/users/1411457/harmic"}, "is_accepted": true, "score": 3, "last_activity_date": 1567580109, "creation_date": 1567580109, "answer_id": 57782994, "question_id": 57771398, "link": "https://stackoverflow.com/questions/57771398/how-to-link-sqlite3-statically-in-cargo-toml/57782994#57782994", "title": "How to link sqlite3 statically in Cargo.toml", "body": "<p>The <a href=\"https://crates.io/crates/sqlite\" rel=\"nofollow noreferrer\">sqlite</a> crate depends on the <a href=\"https://github.com/stainless-steel/sqlite3-sys\" rel=\"nofollow noreferrer\">sqlite3-sys</a> crate to provide the FFI towards SQLite. This crate in turn depends on the <a href=\"https://github.com/stainless-steel/sqlite3-src\" rel=\"nofollow noreferrer\">sqlite3-src</a> crate, which includes an optional feature called <code>bundle</code> - if you specify this feature then it bundles a copy of SQLite into your rust binary.</p>\n\n<p>To do this, specify the dependency on this package manually like this:</p>\n\n<pre><code>[dependencies.sqlite3-src]\nversion=\"0.2\"\nfeatures=[\"bundled\"]\n</code></pre>\n\n<p>After doing this the generated binary should not link towards <code>sqlite3.dll</code>. I couldn't test that for Windows, but it worked for Linux:</p>\n\n<pre><code>$ ldd target/debug/so_sqlite\n        linux-vdso.so.1 =&gt;  (0x00007ffcf7972000)\n        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f1781fb9000)\n        librt.so.1 =&gt; /lib64/librt.so.1 (0x00007f1781db1000)\n        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f1781b95000)\n        libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f178197f000)\n        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f17815b2000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007f17824d3000)\n</code></pre>\n"}], "owner": {"reputation": 1983, "user_id": 939280, "user_type": "registered", "accept_rate": 83, "profile_image": "https://i.stack.imgur.com/luAYh.jpg?s=128&g=1", "display_name": "Ka\u011fan Kayal", "link": "https://stackoverflow.com/users/939280/ka%c4%9fan-kayal"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 337, "favorite_count": 1, "accepted_answer_id": 57782994, "answer_count": 1, "score": 1, "last_activity_date": 1568811494, "creation_date": 1567512207, "last_edit_date": 1568811494, "question_id": 57771398, "link": "https://stackoverflow.com/questions/57771398/how-to-link-sqlite3-statically-in-cargo-toml", "title": "How to link sqlite3 statically in Cargo.toml", "body": "<p>I have created a rust application, which uses the <a href=\"https://crates.io/crates/sqlite\" rel=\"nofollow noreferrer\">sqlite</a> crate from crates.io</p>\n\n<p>I am just using this crate as is and when I run my application with <code>cargo run</code>, I do get what I want. However, it seems my application has now a dependency to <code>sqlite3.dll</code> , which needs to be in my path.</p>\n\n<p>From the Cargo docs that I read, my understanding is that the sqlite crate itself is linked statically, but not the C Library that it depends on.</p>\n\n<p>On my own computer, I solved this by simply copying the sqlite3.dll into a folder in my path or to the same directory, where cargo has created my executable.</p>\n\n<p>But, I realised that this didn't work with any sqlite3.dll file, but it worked with the one I found somewhere deep under the <code>.multirust</code> folder.</p>\n\n<p>Additionally, when I give this application to someone else, I would also have to make sure that the DLL is also there.</p>\n\n<p>So, I would like to avoid these complications by statically linking this DLL to my executable.</p>\n\n<p>Is there a way to tell Cargo link this C Library statically without diving into custom build scripts?</p>\n"}, {"tags": ["rust", "dbf", "dbase"], "comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567501649, "post_id": 57768327, "comment_id": 101972079, "body": "I don&#39;t actually think it&#39;s down to a <code>^M</code> symbol but an <code>M</code> (Memo) field type itself. Is there a chance you could throw that <code>dbf</code> file somewhere, or at least just the field definition? <code>dbase-rs</code> <a href=\"https://github.com/tmontaigu/dbase-rs/blob/master/src/record/field.rs#L55\" rel=\"nofollow noreferrer\">does not handle this type</a>"}, {"owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "reply_to_user": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567502585, "post_id": 57768327, "comment_id": 101972543, "body": "@S&#233;bastienRenauld here is the db file on dropbox. Can you please have a look. <a href=\"https://www.dropbox.com/s/zyp4bx82z1yb2wc/calls1.dbf?dl=0\" rel=\"nofollow noreferrer\">dropbox.com/s/zyp4bx82z1yb2wc/calls1.dbf?dl=0</a>"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567502829, "post_id": 57768327, "comment_id": 101972689, "body": "Writing a deep dive answer. I was right, but the bad news is that short of stripping the Memo field and replacing it with an inline text field there&#39;s no solution as no <code>dbase</code> library in rust that I know of handles this field type"}, {"owner": {"reputation": 51, "user_id": 9967360, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4030bccf4e988d1206707fcf2cd265d3?s=128&d=identicon&r=PG", "display_name": "J&#228;lv", "link": "https://stackoverflow.com/users/9967360/j%c3%a4lv"}, "edited": false, "score": 0, "creation_date": 1572282913, "post_id": 57768327, "comment_id": 103503763, "body": "Hi, I am the author of the dbase-rs library, i found this stackoverflow randomly. The &#39;M&#39; data type is not implemented because i do not have access to files that contains this type (and the dBase &#39;documentation&#39; il almost non existant), i would have liked an issue on the <a href=\"https://github.com/tmontaigu/dbase-rs\" rel=\"nofollow noreferrer\">github repo</a>"}], "answers": [{"comments": [{"owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567505355, "post_id": 57769207, "comment_id": 101974066, "body": "Thanks a lot. As a rust learner (day 2) i am not sure yet how i will proceed to solve the issue, but your explanation really helped me understanding the problem i am facing. Thank you for your time and efforts again."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567505670, "post_id": 57769207, "comment_id": 101974231, "body": "If I had a use for a proper dbase parsing library I&#39;d help you patch it, but sadly, I don&#39;t and it&#39;s not exactly something one can do quickly :-( I&#39;d just fix the file, tbh, unless your notes really are big."}, {"owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567506016, "post_id": 57769207, "comment_id": 101974386, "body": "Thank you. I will appreciate if you let me know how can i fix the file as i have almost 100 files and most of them contains the Memo field. If i know the conversion i will do it by myself."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567553411, "post_id": 57769207, "comment_id": 101994256, "body": "@Shahzeb So, I may have gotten bored today, and <a href=\"https://github.com/srenauld/dbase\" rel=\"nofollow noreferrer\">made a thing</a>. I&#39;ll implement <code>MEMO</code> tomorrow, I&#39;ve done every other field and I have the right structure to open the <code>dbt</code> file (where the memo data is stored)"}, {"owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567588059, "post_id": 57769207, "comment_id": 102003647, "body": "I am not able to run it. On execution &quot;cargo test&quot; getting errors <code>error: enum variants on type aliases are experimental</code> even after executing rustup update nightly"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 1, "creation_date": 1567593668, "post_id": 57769207, "comment_id": 102006720, "body": "I&#39;m still working on it, although that error is weird. it is stable on rust 1.37. I&#39;m on the move atm, but I&#39;ve hit another small hitch - there are two memo file formats. I&#39;ve implemented the dBase 3 format, implementing the foxpro one."}, {"owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567594252, "post_id": 57769207, "comment_id": 102006989, "body": "Thanks for response. I upgraded to 1.37, the error is gone now. Before i had version 1.36"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567597166, "post_id": 57769207, "comment_id": 102008469, "body": "the good news is, I have fox pro fpt format fully working. the bad news is I don&#39;t have a dBase III/IV reference file yet and advanced DBF viewer refuses to insert memos. the search continues..."}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "edited": false, "score": 0, "creation_date": 1567605480, "post_id": 57769207, "comment_id": 102013212, "body": "Let us <a href=\"https://chat.stackoverflow.com/rooms/198943/discussion-between-sebastien-renauld-and-shahzeb\">continue this discussion in chat</a>."}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 5, "last_activity_date": 1567504308, "creation_date": 1567504308, "answer_id": 57769207, "question_id": 57768327, "link": "https://stackoverflow.com/questions/57768327/reading-dfb-file-with-rust-throws-invalid-character-error/57769207#57769207", "title": "Reading .dfb file with rust throws invalid character error", "body": "<p>The short answer to your question is no, you will not be able to read this file with <code>dbase-rs</code> (or any current library) and you'll most likely have to rework this file to not contain a memo field.</p>\n\n<hr>\n\n<h1>A deep dive into the DBF file format</h1>\n\n<p>The <code>InvalidFieldType</code> error points at a structural feature of the file that your library cannot handle - a Memo field. We're going to deep-dive into the file to figure out why that is, and whether there is anything we can do to fix it.</p>\n\n<p>This is the header definition:</p>\n\n<p><a href=\"https://i.stack.imgur.com/oIJCJ.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/oIJCJ.png\" alt=\"enter image description here\"></a></p>\n\n<p>Of particular importance is byte 28 (offset 0000010, byte 0C), which is a bitmask indicating if the table contains a bunch of possible things, most notably:</p>\n\n<ul>\n<li><code>0x01</code> if the file comes with an associated .cdx file</li>\n<li><code>0x02</code> if it contains a memo</li>\n<li><code>0x04</code> if the file is actually a .dbc file (a database)</li>\n</ul>\n\n<p>At <code>0x03</code>, your file comes with both an associated .cdx file and contains a memo. As we know (ahead of time) that <code>dbase-rs</code> does not handle that, that's looking increasingly more likely.</p>\n\n<p>Let's keep looking. From here on, each field is 32 bytes long.</p>\n\n<p>Here are your fields:</p>\n\n<p><a href=\"https://i.stack.imgur.com/YVSzs.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/YVSzs.png\" alt=\"enter image description here\"></a></p>\n\n<p>Bytes 0-10 contain the field name, byte 11 is the type. Due to how the library you wanted to use can only parse certain fields, we only really care about byte 11.</p>\n\n<p>In order of appearance by what the library can parse:</p>\n\n<ul>\n<li>[x] CALL_ID (integer)</li>\n<li>[x] CONTACT_ID (integer)</li>\n<li>[x] CALL_DATE (DateTime)</li>\n<li>[x] SUBJECT (char[])</li>\n<li>[ ] NOTES (memo)</li>\n</ul>\n\n<p>The last field is the problematic one. Looking into the library itself, <a href=\"https://github.com/tmontaigu/dbase-rs/blob/master/src/record/field.rs#L55\" rel=\"noreferrer\">this field type is not supported</a> and will therefore yield an <code>Error</code>, which you are trying to <code>unwrap()</code>. This is the source of your error.</p>\n\n<p>There are <strike>two</strike> three ways around it:</p>\n\n<ul>\n<li>The \"long\" way is to patch the library to handle memo fields. This sounds easy, but in practice it really isn't. As the memos are stored in another file (typically a <code>dbt</code> file in the same folder), you're going to have to make that library read both files and reference both. The point of the memo type itself is to store more than 255 bytes of data in a field. You are the only one able to evaluate whether this work is worth the effort.</li>\n<li>If your data is less than 255 bytes in size, you can replace that memo field with a char field, and dbfview should allow you to do this</li>\n<li>If your field is longer than 255 bytes and you have access to the ability to run sub-processes (i.e. <code>Command::run</code>), you can sneak-convert it using a library that <strong>can</strong> process Memo fields in another language. <a href=\"https://github.com/yortus/DBFFile\" rel=\"noreferrer\">this nodeJS library can, but read-only</a>, for example.</li>\n</ul>\n"}], "owner": {"reputation": 3114, "user_id": 743982, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/53b0ac77c37f30fd4561fafaa00d2a1b?s=128&d=identicon&r=PG&f=1", "display_name": "Shahzeb Khan", "link": "https://stackoverflow.com/users/743982/shahzeb-khan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 259, "favorite_count": 0, "accepted_answer_id": 57769207, "answer_count": 1, "score": 2, "last_activity_date": 1567504308, "creation_date": 1567501149, "question_id": 57768327, "link": "https://stackoverflow.com/questions/57768327/reading-dfb-file-with-rust-throws-invalid-character-error", "title": "Reading .dfb file with rust throws invalid character error", "body": "<p>I am new to rust and creating a POC to convert <code>dbf</code> file to <code>csv</code>. I am reading a <code>.dbf</code> file using rust library <a href=\"https://docs.rs/dbase/0.0.2/dbase/\" rel=\"nofollow noreferrer\">dbase</a>. </p>\n\n<p>The issue is, when i crate a sample <code>.dbf</code> file using <a href=\"https://dbfview.com/\" rel=\"nofollow noreferrer\">dbfview</a> the code works fine. But when i use <code>.dbf</code>  file which i will be using in real time. I am getting the following error.</p>\n\n<pre><code>thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: InvalidFieldType('M')', src/libcore/result.rs:999:5\n</code></pre>\n\n<p>Here is the code i am using from the given link.</p>\n\n<pre><code>use dbase::FieldValue;\nlet records = dbase::read(\"tests/data/line.dbf\").unwrap();\nfor record in records {\n    for (name, value) in record {\n        println!(\"{} -&gt; {:?}\", name, value);\n        match value {\n            FieldValue::Character(string) =&gt; println!(\"Got string: {}\", string),\n            FieldValue::Numeric(value) =&gt; println!(\"Got numeric value of  {}\", value),\n            _ =&gt; {}\n        }\n    }\n}\n</code></pre>\n\n<p>I think the <code>^M</code> shows the character appended by <code>windows</code>. \nWhat can i do to handle this error and read the file successfully.\nAny help will be much appreciated. </p>\n"}, {"tags": ["json", "vector", "rust", "serde", "borrowing"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1567496041, "post_id": 57766918, "comment_id": 101969288, "body": "Hi there! Does <a href=\"https://stackoverflow.com/questions/35873497/getting-value-from-a-collection-without-using-the-clone-trait\">this</a> or <a href=\"https://stackoverflow.com/questions/45803990/how-can-i-take-an-item-from-a-vec-in-rust\">this</a> answer your question? Summary: you are trying to get an element from a <code>Vec</code> by value, but that is not possible without cloning or removing it entirely from the <code>Vec</code>."}, {"owner": {"reputation": 157, "user_id": 8072279, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6bacbd7a11c2855e6b4ad32648fc903e?s=128&d=identicon&r=PG&f=1", "display_name": "mertselimb", "link": "https://stackoverflow.com/users/8072279/mertselimb"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567496237, "post_id": 57766918, "comment_id": 101969382, "body": "I am new to rust. I don&#39;t understand the error. If cloning helps it will be my answer."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1567496272, "post_id": 57766918, "comment_id": 101969399, "body": "If you throw the vector away, you don&#39;t need to clone the item. Just consume it: <code>n_arr.into_iter().next().unwrap()</code>"}, {"owner": {"reputation": 157, "user_id": 8072279, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6bacbd7a11c2855e6b4ad32648fc903e?s=128&d=identicon&r=PG&f=1", "display_name": "mertselimb", "link": "https://stackoverflow.com/users/8072279/mertselimb"}, "edited": false, "score": 0, "creation_date": 1567496394, "post_id": 57766918, "comment_id": 101969447, "body": "Please explain how it works in a answer so i can accept it. It solved the problem."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567497118, "post_id": 57766918, "comment_id": 101969760, "body": "I just now also found <a href=\"https://stackoverflow.com/questions/27904864/what-does-cannot-move-out-of-indexed-content-mean\">this Q&amp;A</a> which probably fits your question more closely!"}, {"owner": {"reputation": 157, "user_id": 8072279, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6bacbd7a11c2855e6b4ad32648fc903e?s=128&d=identicon&r=PG&f=1", "display_name": "mertselimb", "link": "https://stackoverflow.com/users/8072279/mertselimb"}, "edited": false, "score": 0, "creation_date": 1567497388, "post_id": 57766918, "comment_id": 101969905, "body": "I should have seen that. Thanks."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567497468, "post_id": 57766918, "comment_id": 101969944, "body": "Don&#39;t worry! Your question now serves as signpost and will be easier found by people who formulate the problem like you do."}], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 2, "last_activity_date": 1567511865, "last_edit_date": 1567511865, "creation_date": 1567496856, "answer_id": 57767189, "question_id": 57766918, "link": "https://stackoverflow.com/questions/57766918/cant-use-locally-created-vector-because-borrowed/57767189#57767189", "title": "Can&#39;t use locally created vector because &quot;borrowed&quot;", "body": "<p>I assume in this answer that the ownership system of Rust is known. Your vector owns the items, so if you ask for the first one, you can only borrow it because the vector is composed of items contiguous in memory. You cannot randomly remove an item from it with the index notation.</p>\n\n<p>If you want to take the first one, you have 3 choices:</p>\n\n<ul>\n<li><p>You don't care about the remaining of the vector: you can transform it into an iterator and take the first item iterated:</p>\n\n<pre><code>vector\n    .into_iter() // consume the vector to get an iterator\n    .next() // get the first iterated item\n    .unwrap()\n</code></pre></li>\n<li><p>You care about the remaining, but you don't care about the ordering, use <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.swap_remove\" rel=\"nofollow noreferrer\"><code>swap_remove</code></a>:</p>\n\n<pre><code>vector.swap_remove(0)\n</code></pre></li>\n<li><p>You care about the remaining and the ordering: don't use a vector. I you don't have that choice, you can use <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.remove\" rel=\"nofollow noreferrer\"><code>remove</code></a>, but that's a O(n) function.</p></li>\n</ul>\n\n<hr>\n\n<p>By the way, the return in last position is not idiomatic:</p>\n\n<pre><code>#[wasm_bindgen]\npub fn toCollection(arr: js_sys::Array, r_type: String) -&gt; JsValue {\n    let n_arr: Vec&lt;ExtrudeGeometry&gt; = arr.into_serde().unwrap();\n\n    if r_type == \"GeometryCollection\" {\n        JsValue::from_serde(&amp;OutputGeometryCollection {\n            collection: n_arr,\n            r#type: r_type,\n        })\n        .unwrap()\n    } else {\n        let ex = n_arr.into_iter().next().unwrap();\n\n        JsValue::from_serde(&amp;OutputObject {\n            data: ex,\n            r#type: r_type,\n        })\n        .unwrap();\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 157, "user_id": 8072279, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6bacbd7a11c2855e6b4ad32648fc903e?s=128&d=identicon&r=PG&f=1", "display_name": "mertselimb", "link": "https://stackoverflow.com/users/8072279/mertselimb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 87, "favorite_count": 0, "closed_date": 1567497417, "accepted_answer_id": 57767189, "answer_count": 1, "score": 0, "last_activity_date": 1567511865, "creation_date": 1567495739, "last_edit_date": 1567497031, "question_id": 57766918, "link": "https://stackoverflow.com/questions/57766918/cant-use-locally-created-vector-because-borrowed", "closed_reason": "Duplicate", "title": "Can&#39;t use locally created vector because &quot;borrowed&quot;", "body": "<p>I can't get first element of the vector because of the error and can't change struct design either. I tried borrowing but struct expects a ExtrudeGeometry.</p>\n\n<pre><code>#[wasm_bindgen]\npub fn toCollection(arr: js_sys::Array, r_type: String) -&gt; JsValue {\n    let n_arr: Vec&lt;ExtrudeGeometry&gt; = arr.into_serde().unwrap();\n    if r_type == \"GeometryCollection\" {\n        return JsValue::from_serde(&amp;OutputGeometryCollection {\n            collection: n_arr,\n            r#type: r_type,\n        })\n        .unwrap();\n    } else {\n        let ex: ExtrudeGeometry = n_arr[0];\n        return JsValue::from_serde(&amp;OutputObject {\n            data: ex,\n            r#type: r_type,\n        })\n        .unwrap();\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of borrowed content\n   --&gt; src/lib.rs:308:39\n    |\n308 |             let ex: ExtrudeGeometry = n_arr[0];\n    |                                       ^^^^^^^^\n    |                                       |\n    |        cannot move out of borrowed content\n    |        help: consider borrowing here: `&amp;n_arr[0]`\n</code></pre>\n"}, {"tags": ["asynchronous", "rust", "settimeout", "requestanimationframe", "wasm-bindgen"], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 2, "last_activity_date": 1567495534, "creation_date": 1567495534, "answer_id": 57766864, "question_id": 57765987, "link": "https://stackoverflow.com/questions/57765987/when-compiling-rust-to-wasm-web-assembly-how-can-i-sleep-for-10-milliseconds/57766864#57766864", "title": "When compiling Rust to wasm (web assembly), how can I sleep for 10 milliseconds?", "body": "<blockquote>\n  <p>I'm effectively looking for the Rust equivalent of JavaScript's <code>setTimeout(renderNext, 11)</code> when compiling out to the wasm target.</p>\n</blockquote>\n\n<p>There are several Rust crates that have bindings to the JavaScript web API, most notably <code>web-sys</code>. Take a look at <a href=\"https://docs.rs/web-sys/0.3.27/web_sys/struct.Window.html#method.set_timeout_with_callback_and_timeout_and_arguments_0\" rel=\"nofollow noreferrer\">the documentation for one of the <code>setTimeout</code> overloads</a>.</p>\n\n<p>This is not really a Rust equivalent though, as it pretty directly calls the JS function. But you won't be able to get around that: sleeping or getting the current time are both functions that the host environment has to offer. They cannot be implemented in the raw language alone.</p>\n\n<blockquote>\n  <p>One option would be to have JavaScript call into Rust on every <code>requestAnimationFrame</code> and use that as the driver, but I'm curious to keep it all in Rust if possible.</p>\n</blockquote>\n\n<p>Yes, you should use <code>requestAnimationFrame</code> (<a href=\"https://docs.rs/web-sys/0.3.27/web_sys/struct.Window.html#method.request_animation_frame\" rel=\"nofollow noreferrer\">link to <code>web-sys</code> docs</a>). This is much preferred over timing it yourself. In particular, this method will also pause calling your code when the tab is not active and stuff like that. In a desktop environment you would do the same: ask the host environment (i.e. the operating system, often via OpenGL or so) to synchronize your program to screen refreshes.</p>\n"}, {"tags": [], "owner": {"reputation": 364, "user_id": 297468, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/776cbe4c8aea34b07ac3598cd9a56521?s=128&d=identicon&r=PG", "display_name": "Daniel", "link": "https://stackoverflow.com/users/297468/daniel"}, "is_accepted": false, "score": 2, "last_activity_date": 1603196694, "last_edit_date": 1603196694, "creation_date": 1598763938, "answer_id": 63654124, "question_id": 57765987, "link": "https://stackoverflow.com/questions/57765987/when-compiling-rust-to-wasm-web-assembly-how-can-i-sleep-for-10-milliseconds/63654124#63654124", "title": "When compiling Rust to wasm (web assembly), how can I sleep for 10 milliseconds?", "body": "<p>In your <code>requestAnimationFrame</code> callback, call <code>setTimeout</code>, and have that in turn make the next call to <code>requestAnimationFrame</code>. You can see the JS version of this <a href=\"https://stackoverflow.com/a/39135659/297468\">here</a>.</p>\n<p>Based on <a href=\"https://rustwasm.github.io/docs/wasm-bindgen/examples/request-animation-frame.html#srclibrs\" rel=\"nofollow noreferrer\">the example in the <code>wasm-bindgen</code> book</a>, here's how I do this in Rust:</p>\n<pre><code>fn animate_limited(mut draw_frame: impl FnMut() + 'static, max_fps: i32) {\n    // Based on:\n    // https://rustwasm.github.io/docs/wasm-bindgen/examples/request-animation-frame.html#srclibrs\n\n    // https://doc.rust-lang.org/book/ch15-05-interior-mutability.html\n    let animate_cb = Rc::new(RefCell::new(None));\n    let animate_cb2 = animate_cb.clone();\n\n    let timeout_cb = Rc::new(RefCell::new(None));\n    let timeout_cb2 = timeout_cb.clone();\n\n    let w = window();\n    *timeout_cb2.borrow_mut() = Some(Closure::wrap(Box::new(move || {\n        request_animation_frame(&amp;w, animate_cb.borrow().as_ref().unwrap());\n    }) as Box&lt;dyn FnMut()&gt;));\n\n    let w2 = window();\n    *animate_cb2.borrow_mut() = Some(Closure::wrap(Box::new(move || {\n        draw_frame();\n\n        set_timeout(&amp;w2, timeout_cb.borrow().as_ref().unwrap(), 1000 / max_fps);\n    }) as Box&lt;dyn FnMut()&gt;));\n\n    request_animation_frame(&amp;window(), animate_cb2.borrow().as_ref().unwrap());\n}\n\nfn window() -&gt; web_sys::Window {\n    web_sys::window().expect(&quot;no global `window` exists&quot;)\n}\n\nfn request_animation_frame(window: &amp;web_sys::Window, f: &amp;Closure&lt;dyn FnMut()&gt;) -&gt; i32 {\n    window\n        .request_animation_frame(f.as_ref().unchecked_ref())\n        .expect(&quot;should register `requestAnimationFrame` OK&quot;)\n}\n\nfn set_timeout(window: &amp;web_sys::Window, f: &amp;Closure&lt;dyn FnMut()&gt;, timeout_ms: i32) -&gt; i32 {\n    window\n        .set_timeout_with_callback_and_timeout_and_arguments_0(\n            f.as_ref().unchecked_ref(),\n            timeout_ms,\n        )\n        .expect(&quot;should register `setTimeout` OK&quot;)\n}\n</code></pre>\n<p>Then you simply pass <code>animate_limited</code> a function to do your drawing (a closure like <code>move || { /* drawing logic here */ }</code> will do the trick), and the maximum framerate you want.</p>\n<p>There are almost certainly improvements to be made, there. I'm very new to Rust and just spent far too long figuring out how to make this work. Hopefully this makes it quicker for someone else in the future.</p>\n"}], "owner": {"reputation": 1079, "user_id": 610345, "user_type": "registered", "accept_rate": 46, "profile_image": "https://www.gravatar.com/avatar/556043dbd5327fe67068f42fba8a6802?s=128&d=identicon&r=PG", "display_name": "sgrove", "link": "https://stackoverflow.com/users/610345/sgrove"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 976, "favorite_count": 0, "accepted_answer_id": 57766864, "answer_count": 2, "score": 5, "last_activity_date": 1603196694, "creation_date": 1567491527, "last_edit_date": 1598827165, "question_id": 57765987, "link": "https://stackoverflow.com/questions/57765987/when-compiling-rust-to-wasm-web-assembly-how-can-i-sleep-for-10-milliseconds", "title": "When compiling Rust to wasm (web assembly), how can I sleep for 10 milliseconds?", "body": "<p>My rust program is managing memory for a 2d html canvas context, and I'm trying to hit ~60fps. I can calculate the delta between each frame easily, and it turns out to be roughly ~5ms.</p>\n\n<p>I'm unclear on how to put my Rust webassembly program to sleep for the remaining 11ms. One option would be to have JavaScript call into Rust on every <code>requestAnimationFrame</code> and use that as the driver, but I'm curious to keep it all in Rust if possible.</p>\n\n<p>I'm effectively looking for the Rust equivalent of JavaScript's <code>setTimeout(renderNext, 11)</code> when compiling out to the wasm target.</p>\n"}, {"tags": ["rust", "rust-cargo", "rustup"], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 3, "last_activity_date": 1567495356, "creation_date": 1567495356, "answer_id": 57766821, "question_id": 57765424, "link": "https://stackoverflow.com/questions/57765424/overriding-rust-installation-default-paths-home-cargo-and-home-rustup/57766821#57766821", "title": "Overriding Rust installation default paths `$HOME/.cargo` and `$HOME/.rustup`", "body": "<p>This is explained <a href=\"https://github.com/rust-lang/rustup.rs#choosing-where-to-install\" rel=\"nofollow noreferrer\">in the documentation</a>:</p>\n\n<blockquote>\n  <p><code>rustup</code> allows you to customise your installation by setting the environment variables <code>CARGO_HOME</code> and <code>RUSTUP_HOME</code> before running the <code>rustup-init</code> executable. As mentioned in the Environment Variables section, <code>RUSTUP_HOME</code> sets the root rustup folder, which is used for storing installed toolchains and configuration options. <code>CARGO_HOME</code> contains cache files used by cargo.</p>\n</blockquote>\n\n<p>Don't forget to update the <code>$PATH</code> or you won't be able to use the binaries. Also, if you want that setup to be permanent, export those variables from your shell configuration (<em>e.g.</em> <code>.bashrc</code> or <code>.zshrc</code>):</p>\n\n<blockquote>\n  <p>Note that you will need to ensure these environment variables are always set and that <code>CARGO_HOME/bin</code> is in the <code>$PATH</code> environment variable when using the toolchain.</p>\n</blockquote>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1594234994, "post_id": 62801744, "comment_id": 111058777, "body": "This appears to be the same as the <a href=\"https://stackoverflow.com/a/57766821/155423\">accepted answer</a>, which also says you should set <code>CARGO_HOME</code> and <code>CARGO_HOME</code>. Please <a href=\"https://stackoverflow.com/posts/62801744/edit\">edit</a> this answer to clarify what new information is provided."}], "tags": [], "owner": {"reputation": 31, "user_id": 9804038, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-c8ST2mDwdcU/AAAAAAAAAAI/AAAAAAAAAaA/cqYYDEAwQAI/photo.jpg?sz=128", "display_name": "HAPPY ", "link": "https://stackoverflow.com/users/9804038/happy"}, "is_accepted": false, "score": -1, "last_activity_date": 1594234929, "last_edit_date": 1594234929, "creation_date": 1594234380, "answer_id": 62801744, "question_id": 57765424, "link": "https://stackoverflow.com/questions/57765424/overriding-rust-installation-default-paths-home-cargo-and-home-rustup/62801744#62801744", "title": "Overriding Rust installation default paths `$HOME/.cargo` and `$HOME/.rustup`", "body": "<p>Set up the environment variables <code>$RUSTUP_HOME</code> and <code>$CARGO_HOME</code>, open ~/.bashrc, and add these lines below.</p>\n<pre class=\"lang-sh prettyprint-override\"><code>export RUST_HOME=/path/to/your/custom/location\nexport CARGO_HOME=/path/to/your/custom/location\n</code></pre>\n<p>run</p>\n<pre class=\"lang-none prettyprint-override\"><code>source ~/.bashrc\n</code></pre>\n<p>Then proceed with the installation of Rust with installer.exe or <code>curl</code> for Linux.</p>\n"}], "owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1153, "favorite_count": 0, "accepted_answer_id": 57766821, "answer_count": 2, "score": 4, "last_activity_date": 1594234929, "creation_date": 1567487762, "last_edit_date": 1567495692, "question_id": 57765424, "link": "https://stackoverflow.com/questions/57765424/overriding-rust-installation-default-paths-home-cargo-and-home-rustup", "title": "Overriding Rust installation default paths `$HOME/.cargo` and `$HOME/.rustup`", "body": "<p>In Rust, by default, files are placed in <code>$HOME/.cargo</code> and <code>$HOME/.rustup</code>. Is there any way to override these defaults?</p>\n\n<p>I am trying to debug an obscure issue and I want to try changing the file locations. </p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1567474054, "post_id": 57763852, "comment_id": 101963842, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=328eebfe8b273d707e6fb38af735dcbb\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>, the explanation is out of my skill. It&#39;s a sort of limitation I think. Could compile in future"}, {"owner": {"reputation": 10345, "user_id": 4131059, "user_type": "registered", "accept_rate": 91, "profile_image": "https://i.stack.imgur.com/uDaBr.jpg?s=128&g=1", "display_name": "Alexander Huszagh", "link": "https://stackoverflow.com/users/4131059/alexander-huszagh"}, "edited": false, "score": 0, "creation_date": 1567474174, "post_id": 57763852, "comment_id": 101963866, "body": "The error is the compiler is simply not smart enough to realize that only one mutable borrow could occur at a time."}, {"owner": {"reputation": 105, "user_id": 6761826, "user_type": "registered", "profile_image": "https://graph.facebook.com/1667998723520368/picture?type=large", "display_name": "Jack Bishop", "link": "https://stackoverflow.com/users/6761826/jack-bishop"}, "edited": false, "score": 1, "creation_date": 1567475835, "post_id": 57763852, "comment_id": 101964102, "body": "Thanks for the explanation and the link. The entry fix works perfectly and is much more concise than my original solution."}, {"owner": {"reputation": 22505, "user_id": 1411457, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/XqssD.png?s=128&g=1", "display_name": "harmic", "link": "https://stackoverflow.com/users/1411457/harmic"}, "edited": false, "score": 0, "creation_date": 1567476161, "post_id": 57763852, "comment_id": 101964153, "body": "For future visitors ... see <a href=\"https://stackoverflow.com/a/28512504/1411457\">stackoverflow.com/a/28512504/1411457</a> for an example of the using the Entry API"}, {"owner": {"reputation": 105, "user_id": 6761826, "user_type": "registered", "profile_image": "https://graph.facebook.com/1667998723520368/picture?type=large", "display_name": "Jack Bishop", "link": "https://stackoverflow.com/users/6761826/jack-bishop"}, "edited": false, "score": 0, "creation_date": 1567477300, "post_id": 57763852, "comment_id": 101964331, "body": "From what I&#39;ve read on this issue, shouldn&#39;t it have been fixed by the introduction of non-lexical lifetimes? I&#39;m using the 2018 edition."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1567497224, "post_id": 57763852, "comment_id": 101969823, "body": "@JackBishop As explained in the answer, current implementation of NLL doesn&#39;t yet support this."}], "owner": {"reputation": 105, "user_id": 6761826, "user_type": "registered", "profile_image": "https://graph.facebook.com/1667998723520368/picture?type=large", "display_name": "Jack Bishop", "link": "https://stackoverflow.com/users/6761826/jack-bishop"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 51, "favorite_count": 0, "closed_date": 1567476685, "answer_count": 0, "score": 1, "last_activity_date": 1567473716, "creation_date": 1567472003, "last_edit_date": 1567473716, "question_id": 57763852, "link": "https://stackoverflow.com/questions/57763852/conditionally-returning-immutable-value-preventing-mutable-borrow", "closed_reason": "Duplicate", "title": "Conditionally returning immutable value preventing mutable borrow", "body": "<p>I've been working through the book and am stuck on an exercise. In chapter 13.1, I'm trying to add generic types and the ability to cache multiple values to the memoization cacher. However, I'm getting a borrow error I don't understand.</p>\n\n<p>It seems to me that the immutable borrow within the if let statement should go out of scope before the mutable borrow happens. I've tried enclosing the whole thing in a block but still no cigar. Could someone explain to me the error and recommend a solution?</p>\n\n<p>Thanks in advance.</p>\n\n<p>The code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::collections::HashMap;\nuse std::hash::Hash;\n\nstruct Cacher&lt;T, I, O&gt;\nwhere\n    T: Fn(&amp;I) -&gt; O,\n    I: Hash + Eq + Clone,\n{\n    func: T,\n    values: HashMap&lt;I, O&gt;,\n}\n\nimpl&lt;T, I, O&gt; Cacher&lt;T, I, O&gt;\nwhere\n    T: Fn(&amp;I) -&gt; O,\n    I: Hash + Eq + Clone,\n{\n    fn new(func: T) -&gt; Cacher&lt;T, I, O&gt; {\n        Cacher {\n            func,\n            values: HashMap::new(),\n        }\n    }\n\n    fn get(&amp;mut self, arg: I) -&gt; &amp;O {\n        if let Some(res) = self.values.get(&amp;arg) {\n            return &amp;res;\n        }\n\n        self.values.insert(arg.clone(), (self.func)(&amp;arg));\n        self.values.get(&amp;arg).unwrap()\n    }\n}\n</code></pre>\n\n<p>And the error:<br></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `self.values` as mutable because it is also borrowed as immutable\n  --&gt; src/lib.rs:30:9\n   |\n25 |     fn get(&amp;mut self, arg: I) -&gt; &amp;O {\n   |            - let's call the lifetime of this reference `'1`\n26 |         if let Some(res) = self.values.get(&amp;arg) {\n   |                            ----------- immutable borrow occurs here\n27 |             return &amp;res;\n   |                    ---- returning this value requires that `self.values` is borrowed for `'1`\n...\n30 |         self.values.insert(arg.clone(), (self.func)(&amp;arg));\n   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ mutable borrow occurs here\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 4, "last_activity_date": 1567462823, "creation_date": 1567462823, "answer_id": 57763169, "question_id": 57762843, "link": "https://stackoverflow.com/questions/57762843/how-to-create-instances-from-array-values/57763169#57763169", "title": "How to create instances from Array values", "body": "<p>Since all of your slices happen to be unary, you can use <a href=\"https://doc.rust-lang.org/std/slice/fn.from_ref.html\" rel=\"nofollow noreferrer\"><code>std::slice::from_ref</code></a> to create them, pointing to the bytes from your <code>bytes</code> vector:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let bytes = vec![0x7F, 0x55, ...];\n\nlet segments = bytes.iter().map(|byte| {\n    let buffer = std::slice::from_ref(byte);\n    let mut segment = Segment::with_write(buffer);\n    segment.set_delay(20);\n    segment\n});\n\nlet segments: Vec&lt;_&gt; = segments.collect().\n\nlet written = self.spi.transfer_segments(&amp;segments)\n    .expect(\"Could not write to SPI bus\");\n</code></pre>\n"}], "owner": {"reputation": 307, "user_id": 3189988, "user_type": "registered", "accept_rate": 25, "profile_image": "https://i.stack.imgur.com/Vxc3I.gif?s=128&g=1", "display_name": "fragsalat", "link": "https://stackoverflow.com/users/3189988/fragsalat"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 56, "favorite_count": 0, "accepted_answer_id": 57763169, "answer_count": 1, "score": 2, "last_activity_date": 1567463388, "creation_date": 1567459758, "last_edit_date": 1567463388, "question_id": 57762843, "link": "https://stackoverflow.com/questions/57762843/how-to-create-instances-from-array-values", "title": "How to create instances from Array values", "body": "<p>I'm quite new to rust and used to write code in other languages like JavaScript. My project is to code a program to control a cc2500 chip from my raspberry pi via rppal crate in Rust. So far it works but I'm searching for the right way.</p>\n\n<p><strong>Given</strong>: I have a list of unsigned 8bit integers and need a list of <a href=\"https://docs.rs/rppal/0.11.3/rppal/spi/struct.Segment.html\" rel=\"nofollow noreferrer\">Segments</a> with delay 20.</p>\n\n<p><strong>In JavaScript</strong> I would do it like this</p>\n\n<pre><code>let bytes = [0x7F, 0x55, ...]\n\nlet segments = bytes.map(byte =&gt; {\n    let segment = Segment.with_write([byte]);\n    segment.set_delay(20);\n    return segment;\n});\n\nthis.spi.transfer_segments(segments);\n</code></pre>\n\n<p><strong>In rust</strong> I tried it like this</p>\n\n<pre><code>let bytes = vec![0x7F, 0x55, ...];\n\nlet mut segments:Vec&lt;Segment&gt; = vec![];\nfor (i, byte) in bytes.iter().enumerate() {\n    let buffer = [byte.clone()];\n    segments[i] = Segment::with_write(&amp;buffer);\n    segments[i].set_delay(20);\n}\n\nlet written = self.spi.transfer_segments(&amp;segments)\n    .expect(\"Could not write to SPI bus\");\n</code></pre>\n\n<p>But I always struggle with the ownership rules. <strong>How would you do this or what is the best practice?</strong></p>\n"}, {"tags": ["macos", "rust", "dtrace", "ebpf", "smartos"], "comments": [{"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 2, "creation_date": 1567454467, "post_id": 57761863, "comment_id": 101960242, "body": "I was chalking up an answer but I&#39;ll ask you here instead - how are you running into <code>SIP</code>? It is only enabled on common &quot;protected&quot; directories (<code>Applications</code>, <code>private</code>, <code>System</code> and a couple of others). Are you trying to profile something you&#39;ve moved there?"}, {"owner": {"reputation": 762, "user_id": 4949386, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/a4f78608dae9e9cf14a732e366ea016a?s=128&d=identicon&r=PG&f=1", "display_name": "zino", "link": "https://stackoverflow.com/users/4949386/zino"}, "reply_to_user": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567456109, "post_id": 57761863, "comment_id": 101960683, "body": "<code>sudo dtrace -s script.d -c &quot;.&#47;t.sh&quot;</code> results in <code>dtrace: failed to execute .&#47;t.sh: dtrace cannot control executables signed with restricted entitlements</code>...  <code>sudo dtrace -s script.d -c &quot;cargo test test_name  --package runtime -- --nocapture --test-threads=1&quot;</code> results in <code>dtrace: script &#39;b.d&#39; matched 258 probes</code>, but does not print the output. The test starts OS threads, and I want to trace those too. I think perhaps the <code>-c</code> of dtrace runs cargo as root, so it does not read the workspace, but I cannot see the output of the <code>-c</code>?"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567457213, "post_id": 57761863, "comment_id": 101960943, "body": "Let me guess. Does <code>t.sh</code> invoke anything in any of the protected folders? (I forgot <code>&#47;usr</code> in my little list)"}, {"owner": {"reputation": 762, "user_id": 4949386, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/a4f78608dae9e9cf14a732e366ea016a?s=128&d=identicon&r=PG&f=1", "display_name": "zino", "link": "https://stackoverflow.com/users/4949386/zino"}, "reply_to_user": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "edited": false, "score": 0, "creation_date": 1567458991, "post_id": 57761863, "comment_id": 101961358, "body": "<code>t.sh</code> does not work because it is invoked via <code>&#47;bin&#47;bash</code> which is protected, I think. I did get it working with <code>sudo dtrace -s b.d -c &quot;.&#47;target&#47;debug&#47;deps&#47;runtime-069474f52c940449 test_name --nocapture --test-threads=1&quot; -o out.txt</code>, but I have only tested the <code>pid$target:::entry</code> probe so far."}, {"owner": {"reputation": 83109, "user_id": 1312143, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9d64f50f989e564c337a8a8bd653b8e6?s=128&d=identicon&r=PG", "display_name": "Ken Thomases", "link": "https://stackoverflow.com/users/1312143/ken-thomases"}, "edited": false, "score": 2, "creation_date": 1567464987, "post_id": 57761863, "comment_id": 101962455, "body": "Just to make sure you&#39;re aware: you can re-enable DTrace and leave the rest of SIP enabled. <code>csrutil enable --without dtrace</code>"}], "owner": {"reputation": 762, "user_id": 4949386, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/a4f78608dae9e9cf14a732e366ea016a?s=128&d=identicon&r=PG&f=1", "display_name": "zino", "link": "https://stackoverflow.com/users/4949386/zino"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 115, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1567452565, "creation_date": 1567452565, "question_id": 57761863, "link": "https://stackoverflow.com/questions/57761863/dtrace-like-function-tracing-of-rust-program-on-macos", "title": "DTrace-like function tracing of Rust program on macOS", "body": "<p>I have a Rust program that uses a C FFI, and I would like to instrument any time a function from that C FFI is called, and the arguments passed to it.</p>\n\n<p>Im developing on macOS, and it seems like DTrace is a good fit, but <a href=\"https://apple.stackexchange.com/a/208185/321571\">with the macOS SIP enabled DTrace does not work well</a>. I do not want to disable SIP.</p>\n\n<p>I was looking at using this DTrace provider:\n<code>pid$target:::entry</code></p>\n\n<p><strong>Questions:</strong></p>\n\n<ul>\n<li><p>Is there a better way to do this on macOS/Rust?</p></li>\n<li><p>What is the best OS to run as a VM in order to use DTrace/eBPF on my Rust program?</p></li>\n</ul>\n"}, {"tags": ["random", "rust"], "comments": [{"owner": {"reputation": 28567, "user_id": 815724, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a514cd424088a3ba3012f5d77f2e334?s=128&d=identicon&r=PG", "display_name": "Peter O.", "link": "https://stackoverflow.com/users/815724/peter-o"}, "edited": false, "score": 0, "creation_date": 1567449848, "post_id": 57760843, "comment_id": 101958973, "body": "Why can&#39;t you use the IDs you have generated as is, as opposed to obfuscating them in an insecure way?"}, {"owner": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "reply_to_user": {"reputation": 28567, "user_id": 815724, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a514cd424088a3ba3012f5d77f2e334?s=128&d=identicon&r=PG", "display_name": "Peter O.", "link": "https://stackoverflow.com/users/815724/peter-o"}, "edited": false, "score": 0, "creation_date": 1567450286, "post_id": 57760843, "comment_id": 101959118, "body": "Aesthetics, otherwise every ID starts with the same sequence of characters."}, {"owner": {"reputation": 28567, "user_id": 815724, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a514cd424088a3ba3012f5d77f2e334?s=128&d=identicon&r=PG", "display_name": "Peter O.", "link": "https://stackoverflow.com/users/815724/peter-o"}, "edited": false, "score": 0, "creation_date": 1567451682, "post_id": 57760843, "comment_id": 101959500, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/54973990/reversible-math-function-that-looks-random\">Reversible math function that looks random</a>"}, {"owner": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "reply_to_user": {"reputation": 28567, "user_id": 815724, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a514cd424088a3ba3012f5d77f2e334?s=128&d=identicon&r=PG", "display_name": "Peter O.", "link": "https://stackoverflow.com/users/815724/peter-o"}, "edited": false, "score": 0, "creation_date": 1567466132, "post_id": 57760843, "comment_id": 101962611, "body": "That question only appears to address 32 bit values, but I need an approach for 128 bit values."}, {"owner": {"reputation": 28567, "user_id": 815724, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a514cd424088a3ba3012f5d77f2e334?s=128&d=identicon&r=PG", "display_name": "Peter O.", "link": "https://stackoverflow.com/users/815724/peter-o"}, "edited": false, "score": 0, "creation_date": 1567467111, "post_id": 57760843, "comment_id": 101962749, "body": "The approaches described in the possible duplicate question can be adapted to values of arbitrary size, not just 32 bits.  In general, a reversible operation from N-bit integers to N-bit integers is called a <i>permutation</i>, and as a comment to that question states, &quot;there are a zillion ways&quot; of specifying that permutation."}, {"owner": {"reputation": 15136, "user_id": 4044696, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/54xyv.jpg?s=128&g=1", "display_name": "Severin Pappadeux", "link": "https://stackoverflow.com/users/4044696/severin-pappadeux"}, "edited": false, "score": 0, "creation_date": 1567471320, "post_id": 57760843, "comment_id": 101963389, "body": "What platform/language do you have in mind? Not all of them support 128bit math"}, {"owner": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "edited": false, "score": 0, "creation_date": 1567472489, "post_id": 57760843, "comment_id": 101963584, "body": "The current platform is Rust but I imagine needing to adapt this to JavaScript. I recognize there are a bunch of ways to write the function and I\u2019m struggling to explore the options which is why I\u2019m asking on SO."}], "answers": [{"comments": [{"owner": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "edited": false, "score": 0, "creation_date": 1567472624, "post_id": 57763843, "comment_id": 101963609, "body": "Would this require the space for 2^128 values? Since this will be used on many nodes in a distributed system I need it to be fast and space efficient."}, {"owner": {"reputation": 15136, "user_id": 4044696, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/54xyv.jpg?s=128&g=1", "display_name": "Severin Pappadeux", "link": "https://stackoverflow.com/users/4044696/severin-pappadeux"}, "reply_to_user": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "edited": false, "score": 0, "creation_date": 1567476806, "post_id": 57763843, "comment_id": 101964248, "body": "@Calebmer No, what you see is what you get. Space requirements are quite limited, circa 3 128 bit values per mapper."}], "tags": [], "owner": {"reputation": 15136, "user_id": 4044696, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/54xyv.jpg?s=128&g=1", "display_name": "Severin Pappadeux", "link": "https://stackoverflow.com/users/4044696/severin-pappadeux"}, "is_accepted": false, "score": 1, "last_activity_date": 1567538495, "last_edit_date": 1567538495, "creation_date": 1567471909, "answer_id": 57763843, "question_id": 57760843, "link": "https://stackoverflow.com/questions/57760843/generate-a-deterministic-random-number-from-a-timestamp/57763843#57763843", "title": "Generate a deterministic random number from a timestamp", "body": "<p>Well, you could construct 128bit <a href=\"https://en.wikipedia.org/wiki/Linear_congruential_generator\" rel=\"nofollow noreferrer\">LCG</a>. With proper constants (see <a href=\"https://www.ams.org/journals/mcom/1999-68-225/S0025-5718-99-00996-5/S0025-5718-99-00996-5.pdf\" rel=\"nofollow noreferrer\">here</a> for details) it would map one 128bit value into another. Also, LCG support bijective mapping, so from result you could recover previous value.</p>\n\n<p>Some (untested) C code, GCC or Clang</p>\n\n<pre><code>const unsigned __int128 a = 52583122484843402430317208685168068605;\nconst unsigned __int128 c = 1;\n\nunsigned __int128 next(unsigned __int128 xprev) {\n    return a*xprev + c;\n}\n</code></pre>\n\n<p>Mapping guaranteed to be unique and bijective. If this is what you want, I'll dig out and post my reversal code.</p>\n\n<p>In Javascript, 128bit LCG as direct mapper would look like </p>\n\n<pre><code>const WIDTH = 2n ** 128n;\nconst MASK  = WIDTH - 1n; // to keep things as 128bit values\nconst a     = 52583122484843402430317208685168068605n; // see L'Ecuyer paper\nconst c     =                                      1n; // see L'Ecuyer paper\n\nfunction direct(xprev) { // takes BigInt argument\n    return (a*xprev + c) &amp; MASK; // same as % WIDTH\n}\n\nconsole.log(direct(BigInt('0x16CF304F7B3D5CBED3977C90DD6F5')))\nconsole.log(direct(BigInt('0x16CF30578DCBCF35A0585A4FF6DE0')))\nconsole.log(direct(BigInt('0x16CF30599F53BB7E61791824D6345')))\n</code></pre>\n\n<p>which produced the output (Win 10 x64, Node 12.7)</p>\n\n<pre><code>128874473614597675792465454982924903202n                                                                             \n316384656665826187699254518510547678817n\n104036942349128451345253863137794883122n\n</code></pre>\n\n<p>UPDATE</p>\n\n<p>Digged out my skip code and converted it to Javascript</p>\n\n<pre><code>const WIDTH = 2n ** 128n;\nconst MASK  = WIDTH - 1n; // to keep things as 128bit values\nconst a     = 52583122484843402430317208685168068605n; // see L'Ecuyer paper\nconst c     =                                      1n; // see L'Ecuyer paper\n\nfunction direct(xprev) { // takes BigInt argument\n    return (a*xprev + c) &amp; MASK; // same as % WIDTH\n}\n\n// Signed argument - skip forward as well as backward\n\n// The algorithm here to determine the parameters used to skip ahead is\n// described in the paper F. Brown, \"Random Number Generation with Arbitrary Stride,\"\n// Trans. Am. Nucl. Soc. (Nov. 1994). This algorithm is able to skip ahead in\n// O(log2(N)) operations instead of O(N). It computes parameters\n// A and C which can then be used to find x_N = A*x_0 + C mod 2^M.\nfunction skip(x, ns) { // takes BigInt argument\n\n    let nskip = BigInt(ns);\n\n    let aa = a;\n    let cc = c;\n\n    let a_next = 1n;\n    let c_next = 0n;\n\n    while (nskip &gt; 0n)\n    {\n        if ((nskip &amp; 1n) != 0n) {\n            a_next = (a_next * aa) &amp; MASK;\n            c_next = (c_next * aa + cc) &amp; MASK;\n        }\n\n        cc = ((aa + 1n) * cc) &amp; MASK;\n        aa = (aa * aa) &amp; MASK;\n\n        nskip = nskip &gt;&gt; 1n;\n    }\n\n    return (a_next * BigInt(x) + c_next) &amp; MASK;\n}\n\nfunction inverse(x) {\n    return skip(x, MASK);\n}\n\n\nconsole.log(direct(BigInt('0x16CF304F7B3D5CBED3977C90DD6F5')));\nconsole.log(direct(BigInt('0x16CF30578DCBCF35A0585A4FF6DE0')));\nconsole.log(direct(BigInt('0x16CF30599F53BB7E61791824D6345')));\n\nconsole.log('\\n');\nq = BigInt('0x16CF304F7B3D5CBED3977C90DD6F5');\nconsole.log(q);\nr = direct(q);\nconsole.log(r);\nt = inverse(r);\nconsole.log(t);\n</code></pre>\n\n<p>Last three prints produced</p>\n\n<pre><code>7402051076614138449931424144152309n                                                                                                                    \n128874473614597675792465454982924903202n                                                                                                               \n7402051076614138449931424144152309n      \n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 3, "last_activity_date": 1567492799, "creation_date": 1567492799, "answer_id": 57766240, "question_id": 57760843, "link": "https://stackoverflow.com/questions/57760843/generate-a-deterministic-random-number-from-a-timestamp/57766240#57766240", "title": "Generate a deterministic random number from a timestamp", "body": "<p>Since the lowest bits are random, here's a very fast solution:</p>\n\n<pre><code>fn mix (x: u128) -&gt; u128 {\n    (x &lt;&lt; 64) ^ x\n}\n</code></pre>\n\n<p><a href=\"https://play.integer32.com/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=bcb91a62f0636810c9601be9276a7c3b\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>The function is its own reverse, so <code>mix (mix (x)) == x</code>.</p>\n"}], "owner": {"reputation": 2197, "user_id": 1568890, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/e1743a48fc43aeab957da6d5d53e36c5?s=128&d=identicon&r=PG", "display_name": "Calebmer", "link": "https://stackoverflow.com/users/1568890/calebmer"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 125, "favorite_count": 0, "accepted_answer_id": 57766240, "answer_count": 2, "score": 0, "last_activity_date": 1567538495, "creation_date": 1567445427, "last_edit_date": 1567474183, "question_id": 57760843, "link": "https://stackoverflow.com/questions/57760843/generate-a-deterministic-random-number-from-a-timestamp", "title": "Generate a deterministic random number from a timestamp", "body": "<p>I\u2019m generating IDs with a timestamp part (48 bits) and a random part (80 bits) so that the IDs are ordered but don\u2019t clash. When serializing the IDs to a human readable format I want the IDs to <em>appear</em> random. The serialization will need to be reversible since I need to deserialize an ID back into its ordered timestamp/random form.</p>\n\n<p>I don\u2019t need the serialization to be secure, it\u2019s ok if it\u2019s easily reverse-engineered, I just want the appearance of a randomly generated ID.</p>\n\n<p>Example of some IDs in hexadecimal that I want to encode:</p>\n\n<pre><code>16CF304F7B3D5CBED3977C90DD6F5\n16CF30578DCBCF35A0585A4FF6DE0\n16CF30599F53BB7E61791824D6345\n</code></pre>\n\n<p>Because of the ID format, I need an approach that will work on 128 bit values.</p>\n"}, {"tags": ["rust", "rust-cargo", "tera"], "answers": [{"comments": [{"owner": {"reputation": 21030, "user_id": 15619, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/2f169a510b7cba5a57e86d520b268447?s=128&d=identicon&r=PG", "display_name": "Riduidel", "link": "https://stackoverflow.com/users/15619/riduidel"}, "edited": false, "score": 0, "creation_date": 1567448281, "post_id": 57760754, "comment_id": 101958472, "body": "Well, I was thinking including other dirs could be done at cargo level using <code>include</code> directive, isn&#39;t it possible ? (or does it imply some oddities I didn&#39;t understood) ?"}, {"owner": {"reputation": 2692, "user_id": 625791, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/996a20b9eae1def21e8db462e9bf1cf7?s=128&d=identicon&r=PG", "display_name": "theduke", "link": "https://stackoverflow.com/users/625791/theduke"}, "reply_to_user": {"reputation": 21030, "user_id": 15619, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/2f169a510b7cba5a57e86d520b268447?s=128&d=identicon&r=PG", "display_name": "Riduidel", "link": "https://stackoverflow.com/users/15619/riduidel"}, "edited": false, "score": 3, "creation_date": 1567450202, "post_id": 57760754, "comment_id": 101959092, "body": "That only specifies what files get included in the archive that gets built when you publish the crate, not the binary."}], "tags": [], "owner": {"reputation": 2692, "user_id": 625791, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/996a20b9eae1def21e8db462e9bf1cf7?s=128&d=identicon&r=PG", "display_name": "theduke", "link": "https://stackoverflow.com/users/625791/theduke"}, "is_accepted": true, "score": 3, "last_activity_date": 1567448567, "last_edit_date": 1567448567, "creation_date": 1567444867, "answer_id": 57760754, "question_id": 57760236, "link": "https://stackoverflow.com/questions/57760236/why-cant-my-rust-code-load-a-tera-template/57760754#57760754", "title": "Why can&#39;t my rust code load a tera template?", "body": "<p>Your program can't find the template file. </p>\n\n<p>You have two options:</p>\n\n<ul>\n<li><p>Ship the templates directory together with the binary and put them on the server, in the location where the binary loads the templates from. </p></li>\n<li><p>Statically include your templates into your binary with <a href=\"https://doc.rust-lang.org/std/macro.include_str.html\" rel=\"nofollow noreferrer\">include_str</a>, and then load them with <a href=\"https://docs.rs/tera/1.0.0-beta.14/tera/struct.Tera.html#method.add_raw_template\" rel=\"nofollow noreferrer\">Tera::add_raw_template</a>.</p></li>\n</ul>\n\n<p>PS: you can also embed whole directories into your app with crates like <a href=\"https://github.com/Michael-F-Bryan/include_dir\" rel=\"nofollow noreferrer\">include_dir</a>.</p>\n"}], "owner": {"reputation": 21030, "user_id": 15619, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/2f169a510b7cba5a57e86d520b268447?s=128&d=identicon&r=PG", "display_name": "Riduidel", "link": "https://stackoverflow.com/users/15619/riduidel"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 453, "favorite_count": 1, "accepted_answer_id": 57760754, "answer_count": 1, "score": 1, "last_activity_date": 1567448567, "creation_date": 1567441839, "question_id": 57760236, "link": "https://stackoverflow.com/questions/57760236/why-cant-my-rust-code-load-a-tera-template", "title": "Why can&#39;t my rust code load a tera template?", "body": "<p>I have a rust application (<a href=\"https://github.com/Riduidel/rrss2imap\" rel=\"nofollow noreferrer\">https://github.com/Riduidel/rrss2imap</a>) which, when run on my raspberry, fails with the following error message</p>\n\n<pre><code>pi@raspberrypi-server:~/rrss2imap $ ./rrss2imap-armv7-unknown-linux-gnueabihf-debug run\n[2019-09-02 11:46:08.847444 +02:00] INFO [rrss2imap::feed] src/feed.rs:74: Reading feed from http://tontof.net/?rss\n[2019-09-02 11:46:09.203357 +02:00] INFO [rrss2imap::feed] src/feed.rs:138: Feed date is 2019-09-02 09:46:09 while previous read date is 2019-07-11 17:03:36\n[2019-09-02 11:46:09.203874 +02:00] INFO [rrss2imap::feed] src/feed.rs:143: There should be new entries, parsing HTML content\n[2019-09-02 11:46:09.211703 +02:00] INFO [rrss2imap::feed] src/feed.rs:74: Reading feed from https://www.brothers-brick.com/feed/\n[2019-09-02 11:46:10.897497 +02:00] INFO [rrss2imap::feed] src/feed.rs:138: Feed date is 2019-09-02 02:00:37 while previous read date is 2019-07-11 14:40:44\n[2019-09-02 11:46:10.898026 +02:00] INFO [rrss2imap::feed] src/feed.rs:143: There should be new entries, parsing HTML content\nthread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Error(Msg(\"Template \\'message.html\\' not found\"), State { next_error: None, backtrace: InternalBacktrace { backtrace: None } })', src/libcore/result.rs:999:5\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n</code></pre>\n\n<p>What is really weird is that when I run the same code from <code>cargo run</code> it works like a charm.</p>\n\n<p>So what is going wrong ? How can I fix it ?</p>\n"}, {"tags": ["tcp", "error-handling", "redis", "io", "rust"], "answers": [{"comments": [{"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "edited": false, "score": 0, "creation_date": 1567437132, "post_id": 57759087, "comment_id": 101954688, "body": "I think this would include <code>io::ErrorKind::TimedOut</code> (since it <code>is_io_error()</code> but not <code>is_connection_refusal()</code>). Is that the correct way to deal with time outs? I have no idea... :-)"}, {"owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "reply_to_user": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "edited": false, "score": 0, "creation_date": 1567437426, "post_id": 57759087, "comment_id": 101954823, "body": "<code>TimedOut</code> is considered an <a href=\"https://mitsuhiko.github.io/redis-rs/src/redis/types.rs.html#274\" rel=\"nofollow noreferrer\">IO error</a> and one of the cases you should re-attempt."}], "tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": false, "score": 0, "last_activity_date": 1567436803, "last_edit_date": 1567436803, "creation_date": 1567436269, "answer_id": 57759087, "question_id": 57758814, "link": "https://stackoverflow.com/questions/57758814/how-to-determine-if-i-need-a-new-tcp-connection-from-a-rust-ioerror/57759087#57759087", "title": "How to determine if I need a new TCP connection from a Rust io::Error?", "body": "<p>You should ideally be working off the <code>RedisError</code> itself to figure out what happened and if you need to reconnect. There are a bunch of useful methods defined on that type to help you figure out what you need to do:</p>\n\n<ul>\n<li><code>is_io_error()</code> will return <code>true</code> if the error was due to I/O, and <code>is_timeout()</code> will return <code>true</code> if the cause was I/O timeout</li>\n<li><code>is_connection_dropped()</code> returns <code>true</code> if your connection was dropped</li>\n<li><code>is_connection_refusal()</code> returns <code>true</code> if your connection was actively refused (or if the server flat-out does not exist)</li>\n</ul>\n\n<p>These methods will allow you to pinpoint which type of connection error it was without having to enumerate every possible variant. In particular, to cover most cases, you'll be interested in combining them. In this situation, I'd honestly go <code>(error.is_io_error() || error.is_connection_dropped()) &amp;&amp; !error.is_connection_refusal()</code>. That covers every accidental I/O failure case, while making sure to avoid cases such as invalid credentials.</p>\n"}], "owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 73, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1567436803, "creation_date": 1567435063, "question_id": 57758814, "link": "https://stackoverflow.com/questions/57758814/how-to-determine-if-i-need-a-new-tcp-connection-from-a-rust-ioerror", "title": "How to determine if I need a new TCP connection from a Rust io::Error?", "body": "<p>I'm using the <a href=\"https://docs.rs/redis/0.12.0/redis/\" rel=\"nofollow noreferrer\">redis crate</a> to talk to a Redis server over TCP from Rust. If the TCP connection for some reason goes down (e.g. server crash), I want to try to reconnect (with some backoff so as not to clog the server) by creating a new <a href=\"https://docs.rs/redis/0.12.0/redis/struct.Connection.html\" rel=\"nofollow noreferrer\"><code>Connection</code></a>.</p>\n\n<p>My problem is how to determine when to reconnect? The redis crate throws <a href=\"https://docs.rs/redis/0.12.0/redis/struct.RedisError.html\" rel=\"nofollow noreferrer\"><code>RedisError</code></a>'s, and some of these contain an <a href=\"https://doc.rust-lang.org/std/io/struct.Error.html#method.kind\" rel=\"nofollow noreferrer\"><code>io::Error</code></a>. How do I determine which <code>io::Error</code>'s require a new connection, and which don't? I guess I will have to match on <a href=\"https://doc.rust-lang.org/std/io/struct.Error.html#method.kind\" rel=\"nofollow noreferrer\"><code>io::Error::kind()</code></a> along the lines of this:</p>\n\n<pre><code>use std::io;\n\nfn needs_new_connection(error: &amp;io::Error) -&gt; bool {\n    match error.kind() {\n        io::ErrorKind::ConnectionReset |\n        io::ErrorKind::ConnectionAborted =&gt; true,\n        _ =&gt; false,\n    }\n}\n</code></pre>\n\n<p>But what <a href=\"https://doc.rust-lang.org/std/io/enum.ErrorKind.html\" rel=\"nofollow noreferrer\"><code>ErrorKind</code></a>'s should be in there? Should I add <code>NotConnected</code>? <code>TimedOut</code>? Others? Or should I use some completely different approach?</p>\n\n<p>While I am using Redis, I think it should be fine to treat this as a question purely about TCP. I'm not supporting Unix sockets.</p>\n"}, {"tags": ["module", "rust"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567427496, "post_id": 57756927, "comment_id": 101950380, "body": "What do you want to do? If bar needs foo to work, how do you want to use bar in the binary without foo?"}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567428465, "post_id": 57756927, "comment_id": 101950827, "body": "What&#39;s in your <code>Cargo.toml</code>? Do you have <a href=\"https://stackoverflow.com/questions/26946646/rust-package-with-both-a-library-and-a-binary\">a library and a binary</a> in one project or not? Seems that you&#39;re mixing things together a bit."}], "answers": [{"tags": [], "owner": {"reputation": 3836, "user_id": 3003401, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7f2de9e3bd27825488f4cf0a1dd86ac0?s=128&d=identicon&r=PG&f=1", "display_name": "Cerberus", "link": "https://stackoverflow.com/users/3003401/cerberus"}, "is_accepted": false, "score": 5, "last_activity_date": 1567484580, "creation_date": 1567484580, "answer_id": 57765009, "question_id": 57756927, "link": "https://stackoverflow.com/questions/57756927/rust-modules-confusion-when-there-is-main-rs-and-lib-rs/57765009#57765009", "title": "Rust modules confusion when there is main.rs and lib.rs", "body": "<p>The <code>lib.rs</code> and <code>main.rs</code> files are two independent entry points for your package.</p>\n\n<p>When you use <code>cargo run</code> (or build the binary and run it explicitly), the entry point to be used is <code>main.rs</code>, and the <code>crate</code> keyword refer to the <strong>binary crate</strong>. It doesn't even have to know that there is something in <code>lib.rs</code>: the binary will treat the library as it would any other external crate, and it must be imported, through <code>extern crate hello_world</code> or, for example, <code>use hello_world::foo</code>.</p>\n\n<p>When you import the library, however, the entry point is <code>lib.rs</code>, and the <code>crate</code> is the <strong>library crate</strong>. In this case, yes, all that you've added to <code>lib.rs</code> is exposed to the whole crate.</p>\n\n<p>The usual worksflow in this case is to make the binary something like a thin wrapper around the library - in some extreme cases the <code>main.rs</code> would only contain something like</p>\n\n<pre><code>use library;\nfn main() {\n    library::main();\n}\n</code></pre>\n\n<p>and the whole logic (and all the project structure) goes into the library crate. One of the reasons is exactly what you've run into: the possible confusion whether this concrete module is imported in each crate in the package.</p>\n"}, {"comments": [{"owner": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567518302, "post_id": 57767413, "comment_id": 101981117, "body": "&quot;<code>crate</code> refers to <code>src&#47;lib.rs</code>, because we&#39;re in the context of our library here.&quot; But hang on though, aren&#39;t <code>foo</code> and <code>bar</code> both in the same crate context, since they&#39;re both modules within <code>lib.rs</code>? Why would <code>bar</code> have to refer to <code>foo</code> as if it were external?"}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "reply_to_user": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567521360, "post_id": 57767413, "comment_id": 101982926, "body": "You mean <code>use crate::foo;</code>? Why do you think it&#39;s an external reference, it&#39;s not. The <code>crate</code> keyword refers to <a href=\"https://doc.rust-lang.org/edition-guide/rust-2018/module-system/path-clarity.html#the-crate-keyword-refers-to-the-current-crate\" rel=\"nofollow noreferrer\">the current crate</a>, which is the library itself. You can use <code>use super::foo;</code> if you wish."}, {"owner": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567521680, "post_id": 57767413, "comment_id": 101983116, "body": "Hi, I believe there might have been some confusion because OP wasn&#39;t clear in the question. The <code>bar</code> module was declared in <code>lib.rs</code> and not in <code>main.rs</code>.   Please see my answer to OP below for a more detailed response."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "reply_to_user": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567521797, "post_id": 57767413, "comment_id": 101983170, "body": "No, the OP edited the question and tried to fix it by: <i>Adding mod foo to main.rs fixes the issue</i>."}, {"owner": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567521799, "post_id": 57767413, "comment_id": 101983171, "body": "Actually never mind, I might have made a mistake myself \ud83d\ude05"}, {"owner": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "edited": false, "score": 0, "creation_date": 1567522385, "post_id": 57767413, "comment_id": 101983510, "body": "Right it does appear that I was confused. Because OP was claiming that adding <code>mod bar</code> to <code>main.rs</code> solved the issue when in fact removing it is what will allow the code to compile since then <code>bar</code> will be properly declared as a module of <code>lib.rs</code> and <code>use crate::foo</code> can then properly refer to the <code>foo</code> module in <code>lib.rs</code>."}, {"owner": {"reputation": 2135, "user_id": 1786712, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/35762c76db3c7edd59c4c0589af6570c?s=128&d=identicon&r=PG", "display_name": "simbro", "link": "https://stackoverflow.com/users/1786712/simbro"}, "edited": false, "score": 0, "creation_date": 1601382134, "post_id": 57767413, "comment_id": 113385110, "body": "That&#39;s a great answer!"}, {"owner": {"reputation": 743, "user_id": 409461, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/d792b8d5a8caa2e8de80a0bd87bc8f44?s=128&d=identicon&r=PG", "display_name": "decades", "link": "https://stackoverflow.com/users/409461/decades"}, "edited": false, "score": 1, "creation_date": 1603438255, "post_id": 57767413, "comment_id": 114042877, "body": "Your post is confusing in the end. You are referring a src/lib.rs in your Cargo.toml while it was already renamed to utils.rs..."}, {"owner": {"reputation": 1676, "user_id": 3982143, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/8a710e31e51a9930156dc975d5bb8609?s=128&d=identicon&r=PG&f=1", "display_name": "Vidy Videni", "link": "https://stackoverflow.com/users/3982143/vidy-videni"}, "edited": false, "score": 0, "creation_date": 1618369924, "post_id": 57767413, "comment_id": 118578445, "body": "@zrzka, thanks for this very details explanation, I create an example following the <code>Same package layout</code> part, still got the same error, <a href=\"https://github.com/videni/rust-package-layout-demo\" rel=\"nofollow noreferrer\">github.com/videni/rust-package-layout-demo</a>"}], "tags": [], "owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "is_accepted": false, "score": 104, "last_activity_date": 1567497651, "creation_date": 1567497651, "answer_id": 57767413, "question_id": 57756927, "link": "https://stackoverflow.com/questions/57756927/rust-modules-confusion-when-there-is-main-rs-and-lib-rs/57767413#57767413", "title": "Rust modules confusion when there is main.rs and lib.rs", "body": "<p>Let's start from the beginning. Look at the <a href=\"https://doc.rust-lang.org/cargo/guide/project-layout.html\" rel=\"noreferrer\">Package Layout</a> chapter in <a href=\"https://doc.rust-lang.org/cargo/index.html\" rel=\"noreferrer\">The Cargo Book</a>. As you can see, your package can contain lot of stuff:</p>\n\n<ul>\n<li>a binary (something you can run) or multiple binaries,</li>\n<li>a single library (shared code),</li>\n<li>example(s),</li>\n<li>benchmark(s),</li>\n<li>integration tests.</li>\n</ul>\n\n<h1>Package layout</h1>\n\n<p>Not all of the possibilities are listed here, just the binary / library combinations.</p>\n\n<h2>A binary</h2>\n\n<p>This is an example of a package with single binary. Entry point is the <code>main</code> function in the <code>src/main.rs</code>.</p>\n\n<p><code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n</code></pre>\n\n<p><code>src/main.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    println!(\"Hallo, Rust here!\")\n}\n</code></pre>\n\n<pre class=\"lang-sh prettyprint-override\"><code>$ cargo run\nHallo, Rust here!\n</code></pre>\n\n<h2>A library</h2>\n\n<p>This is an example of a package with a library. Libraries don't have entry points, you can't run them. They're used for functionality sharing.</p>\n\n<p><code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n</code></pre>\n\n<p><code>src/lib.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn foo() {\n    println!(\"Hallo, Rust library here!\")\n}\n</code></pre>\n\n<pre class=\"lang-sh prettyprint-override\"><code>$ cargo run\nerror: a bin target must be available for `cargo run`\n</code></pre>\n\n<p>Do you see anything in the <code>Cargo.toml</code> file about a binary or a library? No. The reason is that I've followed the <a href=\"https://doc.rust-lang.org/cargo/guide/project-layout.html\" rel=\"noreferrer\">Package Layout</a> and the <code>cargo</code> knows where to look for things.</p>\n\n<h2>A binary and a library</h2>\n\n<p>This is an example of a package with a binary and a library.</p>\n\n<p><code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n</code></pre>\n\n<p><code>src/lib.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub const GREETING: &amp;'static str = \"Hallo, Rust library here!\";\n</code></pre>\n\n<p><code>src/main.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use hallo::GREETING;\n\nfn main() {\n    println!(\"{}\", GREETING);\n}\n</code></pre>\n\n<p>Same question, do you see anything in the <code>Cargo.toml</code> file about a binary or a library? No.</p>\n\n<p>This package contains two things:</p>\n\n<ul>\n<li>a binary (root <code>src/main.rs</code>, entry point <code>src/main.rs::main</code>),</li>\n<li>a library (root <code>src/lib.rs</code>, shared code).</li>\n</ul>\n\n<p>A library can be referenced from the binary via <code>use hallo::...</code> where the <code>hallo</code> is this package name (<code>Cargo.toml</code> -> <code>[package]</code> -> <code>name</code>).</p>\n\n<h1>Your problem</h1>\n\n<p><code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n</code></pre>\n\n<h2>Same package layout</h2>\n\n<h3>A library part</h3>\n\n<p><code>src/lib.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub mod bar;\npub mod foo;\n</code></pre>\n\n<p><code>src/foo.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn say_foo() {\n    println!(\"Foo\");\n}\n</code></pre>\n\n<p><code>src/bar.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use crate::foo;\n\npub fn bar() {\n    foo::say_foo();\n}\n</code></pre>\n\n<p><code>crate</code> refers to <code>src/lib.rs</code>, because we're in the context of our library here.</p>\n\n<p>Treat it as a standalone unit and refer to it via <code>use hallo::...;</code> from the outside world.</p>\n\n<h3>A binary part</h3>\n\n<p><code>src/main.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use hallo::bar::bar;\n\nfn main() {\n    bar();\n}\n</code></pre>\n\n<p>Here we're just using our library.</p>\n\n<h2>Without a library</h2>\n\n<p>Same code, but <code>lib.rs</code> was renamed to <code>utils.rs</code> and <code>(foo|bar).rs</code> files were moved to the <code>src/utils/</code> folder.</p>\n\n<p><code>src/utils.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub mod bar;\npub mod foo;\n</code></pre>\n\n<p><code>src/utils/foo.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn say_foo() {\n    println!(\"Foo\");\n}\n</code></pre>\n\n<p><code>src/utils/bar.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use super::foo;\n// or use crate::utils::foo;\n\npub fn bar() {\n    foo::say_foo();\n}\n</code></pre>\n\n<p>We can use <code>crate</code> here as well, but because we're in the context of our binary, the path differs.</p>\n\n<p><code>src/main.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use utils::bar::bar;\n\nmod utils;\n\nfn main() {\n    bar();\n}\n</code></pre>\n\n<p>Here we just declared another module (<code>utils</code>) and we're using it.</p>\n\n<h1>Summary</h1>\n\n<p><code>Cargo.toml</code> content:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n</code></pre>\n\n<p>If there's a <code>src/main.rs</code> file, you're basically saying this:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[[bin]]\nname = \"hallo\"\nsrc = \"src/main.rs\"\n</code></pre>\n\n<p>If there's a <code>src/lib.rs</code> file, you're basically saying this:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[lib]\nname = \"hallo\"\npath = \"src/lib.rs\"\n</code></pre>\n\n<p>If there're both of them, you're basically saying this:</p>\n\n<pre><code>[package]\nname = \"hallo\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[[bin]]\nname = \"hallo\"\npath = \"src/main.rs\"\n\n[lib]\nname = \"hallo\"\npath = \"src/lib.rs\"\n</code></pre>\n\n<h1>Documentation</h1>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/cargo/guide/project-layout.html\" rel=\"noreferrer\">Package Layout</a></li>\n<li><a href=\"https://doc.rust-lang.org/cargo/reference/manifest.html\" rel=\"noreferrer\">The Manifest Format</a></li>\n<li><a href=\"https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html\" rel=\"noreferrer\">Managing Growing Projects with Packages, Crates, and Modules</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 370, "user_id": 7228880, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/AtKAB.jpg?s=128&g=1", "display_name": "L.Y. Sim", "link": "https://stackoverflow.com/users/7228880/l-y-sim"}, "is_accepted": false, "score": 16, "last_activity_date": 1567526470, "last_edit_date": 1567526470, "creation_date": 1567519222, "answer_id": 57773297, "question_id": 57756927, "link": "https://stackoverflow.com/questions/57756927/rust-modules-confusion-when-there-is-main-rs-and-lib-rs/57773297#57773297", "title": "Rust modules confusion when there is main.rs and lib.rs", "body": "<p>In short <a href=\"https://doc.rust-lang.org/book/ch07-01-packages-and-crates.html\" rel=\"noreferrer\">the official Rust book</a> has this to say:</p>\n\n<blockquote>\n  <p>If a package contains <code>src/main.rs</code> and <code>src/lib.rs</code>, it has two crates: a library and a binary, both with the same name as the package.</p>\n</blockquote>\n\n<p>Furthermore <a href=\"https://doc.rust-lang.org/reference/paths.html#crate\" rel=\"noreferrer\">the Rust reference</a> says this:</p>\n\n<blockquote>\n  <p><code>crate</code> resolves the path relative to the current crate</p>\n</blockquote>\n\n<p>So there are actually two crates in your project, and to which crate the <code>crate</code> qualifier resolves to depends on where you call it.</p>\n\n<p>Now in your code example, if you want things to compile <em>you have to remove</em> <code>mod bar;</code> from <code>src/main.rs</code>. Otherwise you'll be declaring that <code>bar</code> is a module within two crates. </p>\n\n<p>After you remove that, then because in <code>src/lib.rs</code> you had:</p>\n\n<pre><code>pub mod foo;\npub mod bar;\n</code></pre>\n\n<p><code>bar</code> would now be a module within <code>src/lib.rs</code>'s crate, so the <code>crate</code> qualifier in <code>bar.rs</code> would then refer to <code>src/lib.rs</code>'s <code>hello-world</code> crate, which is what you want.</p>\n\n<hr>\n\n<p>One more thing, if you wanted to access items that are exposed in <code>src/lib.rs</code> from <code>src/main.rs</code>, you have to do as @zrzka said, which is to name the name of the crate that both <code>src/lib.rs</code> and <code>src/main.rs</code> share. For example, in your project which is named <code>hello-world</code>:</p>\n\n<pre><code>use hello_world::foo;\nfn main() {\n    foo::say_foo();\n}\n</code></pre>\n\n<p>is how you import the <code>foo</code> module declared  in <code>src/lib.rs</code> into <code>src/main.rs</code>.</p>\n\n<p>However it does appear that the importing behavior doesn't work the other way. I.e. if you declare some public module in <code>src/main.rs</code>, you can't import it into the <code>src/lib.rs</code> crate even when you specify the name of the crate. I couldn't find documentation describing this behavior but by testing it in Rust 1.37.0, it does appear to be the case.</p>\n"}], "owner": {"reputation": 2932, "user_id": 7212809, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-VlOyJEUeeSc/AAAAAAAAAAI/AAAAAAAAAAA/AGDgw-jExBae7iJ2ALFtcMj_6BCoHGTMgw/mo/photo.jpg?sz=128", "display_name": "nz_21", "link": "https://stackoverflow.com/users/7212809/nz-21"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 18152, "favorite_count": 27, "answer_count": 3, "score": 51, "last_activity_date": 1616485288, "creation_date": 1567427220, "last_edit_date": 1584889610, "question_id": 57756927, "link": "https://stackoverflow.com/questions/57756927/rust-modules-confusion-when-there-is-main-rs-and-lib-rs", "title": "Rust modules confusion when there is main.rs and lib.rs", "body": "<p>I have 4 files:</p>\n\n<p><strong><code>main.rs</code></strong></p>\n\n<pre><code>mod bar;\n\nfn main() {\n    let v = vec![1, 2, 3];\n    println!(\"Hello, world!\");\n}\n</code></pre>\n\n<p><strong><code>lib.rs</code></strong></p>\n\n<pre><code>pub mod foo;\npub mod bar;\n\n</code></pre>\n\n<p><strong><code>foo.rs</code></strong></p>\n\n<pre><code>pub fn say_foo() {\n\n}\n\n</code></pre>\n\n<p><strong><code>bar.rs</code></strong></p>\n\n<pre><code>use crate::foo;\n\nfn bar() {\n    foo::say_foo();\n}\n\n</code></pre>\n\n<p>When I run <code>cargo run</code> I get an error saying: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0432]: unresolved import `crate::foo`\n --&gt; src/bar.rs:1:5\n  |\n1 | use crate::foo;\n  |     ^^^^^^^^^^ no `foo` in the root\n</code></pre>\n\n<p>Could someone explain to me how to fix this? A bit more broadly: how does module lookup work when there's a <code>main.rs</code> and a <code>lib.rs</code>? </p>\n\n<p>Edit: Adding <code>mod foo</code> to <code>main.rs</code> fixes the issue. But I don't understand this -- I was under the impression the <code>lib.rs</code> was the place that \"exposed\" all of my modules? Why do I have to declare the module in <code>main.rs</code> as well?</p>\n\n<p>My <code>Cargo.toml</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[package]\nname = \"hello-world\"\nversion = \"0.1.0\"\nauthors = [\"me@mgail.com&gt;\"]\nedition = \"2018\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\n</code></pre>\n"}, {"tags": ["pointers", "rust"], "comments": [{"owner": {"reputation": 335867, "user_id": 2988, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ed181f8c80df53d2b67a4f4fff088ed4?s=128&d=identicon&r=PG", "display_name": "J&#246;rg W Mittag", "link": "https://stackoverflow.com/users/2988/j%c3%b6rg-w-mittag"}, "edited": false, "score": 8, "creation_date": 1567487914, "post_id": 57754901, "comment_id": 101966214, "body": "The term itself is not Rust-specific, BTW. <i>Fat pointer</i> generally refers to a pointer that stores some extra data besides just the address of the object being pointed to. If the pointer contains some <i>tag bits</i> and depending on those tag bits, the pointer sometimes isn&#39;t a pointer at all, it is called a <i>tagged pointer representation</i>. (E.g. on many Smalltalks VMs, pointers that end with a 1 bit are actually 31/63-bit integers, since pointers are word-aligned and thus never end in 1.) The HotSpot JVM calls its fat pointers <i>OOP</i>s (Object-Oriented Pointers)."}, {"owner": {"reputation": 90550, "user_id": 5768908, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/wf0PS.jpg?s=128&g=1", "display_name": "Gerardo Furtado", "link": "https://stackoverflow.com/users/5768908/gerardo-furtado"}, "edited": false, "score": 2, "creation_date": 1567492120, "post_id": 57754901, "comment_id": 101967543, "body": "Just a suggestion: when I post a Q&amp;A pair I normally write a small note explaining that it is a self-answered question, and why I decided to post it. Have a look at the footnote in the question here: <a href=\"https://stackoverflow.com/q/46147231/5768908\">stackoverflow.com/q/46147231/5768908</a>"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 90550, "user_id": 5768908, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/wf0PS.jpg?s=128&g=1", "display_name": "Gerardo Furtado", "link": "https://stackoverflow.com/users/5768908/gerardo-furtado"}, "edited": false, "score": 1, "creation_date": 1567496662, "post_id": 57754901, "comment_id": 101969569, "body": "@GerardoFurtado I initially posted a comment here explaining exactly that. But it was removed now (not by me). But yes, I agree, often such a note is useful!"}, {"owner": {"reputation": 27749, "user_id": 591495, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/74a70bd517ad39fc6512f6d02c6f4ae9?s=128&d=identicon&r=PG", "display_name": "obataku", "link": "https://stackoverflow.com/users/591495/obataku"}, "reply_to_user": {"reputation": 335867, "user_id": 2988, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ed181f8c80df53d2b67a4f4fff088ed4?s=128&d=identicon&r=PG", "display_name": "J&#246;rg W Mittag", "link": "https://stackoverflow.com/users/2988/j%c3%b6rg-w-mittag"}, "edited": false, "score": 0, "creation_date": 1567898981, "post_id": 57754901, "comment_id": 102104388, "body": "@J&#246;rg W Mittag <a href=\"https://docs.oracle.com/javase/7/docs/technotes/guides/vm/performance-enhancements-7.html\" rel=\"nofollow noreferrer\">\u2018ordinary object pointers\u2019, in fact</a>"}], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 123, "last_activity_date": 1567494663, "last_edit_date": 1592644375, "creation_date": 1567418219, "answer_id": 57754902, "question_id": 57754901, "link": "https://stackoverflow.com/questions/57754901/what-is-a-fat-pointer/57754902#57754902", "title": "What is a &quot;fat pointer&quot;?", "body": "<p><strong>The term &quot;fat pointer&quot; is used to refer to references and raw pointers to <em>dynamically sized types</em> (DSTs) \u2013 slices or trait objects.</strong> A fat pointer contains a pointer plus some information that makes the DST &quot;complete&quot; (e.g. the length).</p>\n<p>Most commonly used types in Rust are <em>not</em> DSTs, but have a fixed size known at compile time. These types implement <a href=\"https://doc.rust-lang.org/stable/std/marker/trait.Sized.html\" rel=\"noreferrer\">the <code>Sized</code> trait</a>. Even types that manage a heap buffer of dynamic size (like <code>Vec&lt;T&gt;</code>) are <code>Sized</code> as the compiler knows the exact number of bytes a <code>Vec&lt;T&gt;</code> instance will take up on the stack. There are currently four different kinds of DSTs in Rust.</p>\n<br>\n<h2>Slices (<code>[T]</code> and <code>str</code>)</h2>\n<p>The type <code>[T]</code> (for any <code>T</code>) is dynamically sized (so is the special &quot;string slice&quot; type <code>str</code>). That's why you usually only see it as <code>&amp;[T]</code> or <code>&amp;mut [T]</code>, i.e. behind a reference. This reference is a so-called &quot;fat pointer&quot;. Let's check:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>dbg!(size_of::&lt;&amp;u32&gt;());\ndbg!(size_of::&lt;&amp;[u32; 2]&gt;());\ndbg!(size_of::&lt;&amp;[u32]&gt;());\n</code></pre>\n<p>This prints (with some cleanup):</p>\n<pre class=\"lang-none prettyprint-override\"><code>size_of::&lt;&amp;u32&gt;()      = 8\nsize_of::&lt;&amp;[u32; 2]&gt;() = 8\nsize_of::&lt;&amp;[u32]&gt;()    = 16\n</code></pre>\n<p>So we see that a reference to a normal type like <code>u32</code> is 8 bytes large, as is a reference to an array <code>[u32; 2]</code>. Those two types are not DSTs. But as <code>[u32]</code> is a DST, the reference to it is twice as large. <strong>In the case of slices, the additional data that &quot;completes&quot; the DST is simply the length.</strong> So one could say the representation of <code>&amp;[u32]</code> is something like this:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>struct SliceRef { \n    ptr: *const u32, \n    len: usize,\n}\n</code></pre>\n<br>\n<h2>Trait objects (<code>dyn Trait</code>)</h2>\n<p>When using traits as trait objects (i.e. type erased, dynamically dispatched), these trait objects are DSTs. Example:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>trait Animal {\n    fn speak(&amp;self);\n}\n\nstruct Cat;\nimpl Animal for Cat {\n    fn speak(&amp;self) {\n        println!(&quot;meow&quot;);\n    }\n}\n\ndbg!(size_of::&lt;&amp;Cat&gt;());\ndbg!(size_of::&lt;&amp;dyn Animal&gt;());\n</code></pre>\n<p>This prints (with some cleanup):</p>\n<pre class=\"lang-none prettyprint-override\"><code>size_of::&lt;&amp;Cat&gt;()        = 8\nsize_of::&lt;&amp;dyn Animal&gt;() = 16\n</code></pre>\n<p>Again, <code>&amp;Cat</code> is only 8 bytes large because <code>Cat</code> is a normal type. But <code>dyn Animal</code> is a trait object and therefore dynamically sized. As such, <code>&amp;dyn Animal</code> is 16 bytes large.</p>\n<p><strong>In the case of trait objects, the additional data that completes the DST is a pointer to the vtable (the vptr).</strong> I cannot fully explain the concept of vtables and vptrs here, but they are used to call the correct method implementation in this virtual dispatch context. The vtable is a static piece of data that basically only contains a function pointer for each method. With that, a reference to a trait object is basically represented as:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>struct TraitObjectRef {\n    data_ptr: *const (),\n    vptr: *const (),\n}\n</code></pre>\n<p>(This is different from C++, where the vptr for abstract classes is stored within the object. Both approaches have advantages and disadvantages.)</p>\n<br>\n<h2>Custom DSTs</h2>\n<p>It's actually possible to create your own DSTs by having a struct where the last field is a DST. This is rather rare, though. One prominent example is <code>std::path::Path</code>.</p>\n<p>A reference or pointer to the custom DST is also a fat pointer. The additional data depends on the kind of DST inside the struct.</p>\n<br>\n<h2>Exception: Extern types</h2>\n<p>In <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1861-extern-types.md\" rel=\"noreferrer\">RFC 1861</a>, the <code>extern type</code> feature was introduced. Extern types are also DSTs, but pointers to them are <em>not</em> fat pointers. Or more exactly, as the RFC puts it:</p>\n<blockquote>\n<p>In Rust, pointers to DSTs carry metadata about the object being pointed to. For strings and slices this is the length of the buffer, for trait objects this is the object's vtable. For extern types the metadata is simply <code>()</code>. This means that a pointer to an extern type has the same size as a <code>usize</code> (ie. it is not a &quot;fat pointer&quot;).</p>\n</blockquote>\n<p>But if you are not interacting with a C interface, you probably won't ever have to deal with these extern types.</p>\n<br>\n<br>\n<hr />\n<p>Above, we've seen the sizes for immutable references. Fat pointers work the same for mutable references, immutable raw pointers and mutable raw pointers:</p>\n<pre><code>size_of::&lt;&amp;[u32]&gt;()       = 16\nsize_of::&lt;&amp;mut [u32]&gt;()   = 16\nsize_of::&lt;*const [u32]&gt;() = 16\nsize_of::&lt;*mut [u32]&gt;()   = 16\n</code></pre>\n"}], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 8620, "favorite_count": 18, "accepted_answer_id": 57754902, "answer_count": 1, "score": 103, "last_activity_date": 1610032935, "creation_date": 1567418219, "last_edit_date": 1610032935, "question_id": 57754901, "link": "https://stackoverflow.com/questions/57754901/what-is-a-fat-pointer", "title": "What is a &quot;fat pointer&quot;?", "body": "<p>I've read the term \"fat pointer\" in several contexts already, but I'm not sure what exactly it means and when it is used in Rust. The pointer seems to be twice as large as a normal pointer, but I don't understand why. It also seems to have something to do with trait objects.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 36513, "user_id": 752976, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/j7Uis.jpg?s=128&g=1", "display_name": "Bartek Banachewicz", "link": "https://stackoverflow.com/users/752976/bartek-banachewicz"}, "edited": false, "score": 1, "creation_date": 1567418319, "post_id": 57754857, "comment_id": 101946336, "body": "Your examples aren&#39;t nearly clear enough. Both <code>a</code> and <code>b</code> in first example have the <code>b</code> letter, so I&#39;d expect the difference to be <code>a</code>, but that&#39;s really just a guess. How would that work with e.g. <code>baaabaaaa</code> and <code>baaaa</code>? What about <code>cd</code> and <code>dc</code>?"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1567418386, "post_id": 57754857, "comment_id": 101946365, "body": "Please also show us in your question what you tried already and where you failed. StackOverflow is not a &quot;write this code for me please&quot; website. Thanks!"}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "edited": false, "score": 0, "creation_date": 1567418487, "post_id": 57754857, "comment_id": 101946412, "body": "Sort of characters is not important, so <code>baaabaaaa - baaaa = baaa</code>"}, {"owner": {"reputation": 36513, "user_id": 752976, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/j7Uis.jpg?s=128&g=1", "display_name": "Bartek Banachewicz", "link": "https://stackoverflow.com/users/752976/bartek-banachewicz"}, "edited": false, "score": 0, "creation_date": 1567418706, "post_id": 57754857, "comment_id": 101946513, "body": "@ademcaglin If the order is not important, why don&#39;t you simply count the number of occurences of each character?"}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "reply_to_user": {"reputation": 36513, "user_id": 752976, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/j7Uis.jpg?s=128&g=1", "display_name": "Bartek Banachewicz", "link": "https://stackoverflow.com/users/752976/bartek-banachewicz"}, "edited": false, "score": 0, "creation_date": 1567418780, "post_id": 57754857, "comment_id": 101946538, "body": "@BartekBanachewicz i am new to rust, so i don&#39;t know how to write. You might give an answer."}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567419830, "post_id": 57754857, "comment_id": 101946983, "body": "@LukasKalbertodt I know StackOverflow is not a &quot;write this code for me please&quot; website. But my question is about specific case(maybe it is not clear enough), but it is not off topic or broad."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567420023, "post_id": 57754857, "comment_id": 101947052, "body": "Thanks for adding your code to the question. What is the problem with the code? Does it fail to compile? Is it not doing what you expect it to do? How so? Would be great if you could also explain this. And something else: please check your first example. Shouldn&#39;t the result be <code>&quot;a&quot;</code>? If not, I absolutely don&#39;t understand what your function is supposed to be doing :/"}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567420276, "post_id": 57754857, "comment_id": 101947166, "body": "@LukasKalbertodt my code works expected, but i am not sure it is right way or not. Also i am sorry, result should be &quot;a&quot;, you are right(fixed)."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567429063, "post_id": 57754857, "comment_id": 101951090, "body": "<a href=\"https://codereview.stackexchange.com\">codereview.stackexchange.com</a> ?"}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "reply_to_user": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567431730, "post_id": 57754857, "comment_id": 101952260, "body": "@zrzka Thanks, i added my code to clarify problem. I want to learn a solution for the question."}, {"owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "reply_to_user": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567433011, "post_id": 57754857, "comment_id": 101952815, "body": "@zrzka maybe you are right, i asked the question at codereview.stackexchange.com."}], "answers": [{"tags": [], "owner": {"reputation": 6367, "user_id": 6914441, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/bbc12c764b93fa915b8e5384f521fe12?s=128&d=identicon&r=PG&f=1", "display_name": "jferard", "link": "https://stackoverflow.com/users/6914441/jferard"}, "is_accepted": true, "score": 1, "last_activity_date": 1568055101, "last_edit_date": 1568055101, "creation_date": 1568054816, "answer_id": 57859654, "question_id": 57754857, "link": "https://stackoverflow.com/questions/57754857/how-can-i-write-a-rust-function-to-find-different-characters-between-two-strings/57859654#57859654", "title": "How can I write a Rust function to find different characters between two strings?", "body": "<p>The usual technique is to create a function that counts the number of occurrences of each char, like <a href=\"https://docs.python.org/3/library/collections.html?highlight=counter#collections.Counter\" rel=\"nofollow noreferrer\"><code>collections.Counter</code> in Python</a>, and to compare these numbers for strings <code>a</code> and <code>b</code>. </p>\n\n<p>The Rust standard library documentation contains a <a href=\"https://doc.rust-lang.org/std/collections/struct.HashMap.html#method.entry\" rel=\"nofollow noreferrer\">snippet</a> that does the job. This is an adaptation that accepts any iterator:</p>\n\n<pre><code>use std::collections::HashMap;\nuse std::hash::Hash;\nuse std::iter::Iterator;\n\nfn counter&lt;T, I&gt;(it: I) -&gt; HashMap&lt;T, usize&gt;\nwhere\n    T: Eq + Hash,\n    I: Iterator&lt;Item = T&gt;,\n{\n    let mut count_by_element = HashMap::new();\n    for e in it {\n        *count_by_element.entry(e).or_insert(0) += 1;\n    }\n    count_by_element\n}\n</code></pre>\n\n<p>Now that we know how to build a map <code>char -&gt; count</code>, we just have to compare the counts of the string <code>a</code> and <code>b</code>:</p>\n\n<pre><code>use std::iter;\n\nfn diff(a: &amp;str, b: &amp;str) -&gt; String {\n    let mut v: Vec&lt;char&gt; = vec![];\n    let counter_a = counter(a.chars());\n    let counter_b = counter(b.chars());\n    for (c, n_a) in &amp;counter_a {\n        let n_b = counter_b.get(c).unwrap_or(&amp;0); // how many `c` in `b`?\n        if n_a &gt; n_b {\n            v.extend(iter::repeat(c).take(n_a - n_b)); // add `n_a - n_b` `c`s\n        }\n    }\n    v.into_iter().collect::&lt;String&gt;() // build the String\n}\n</code></pre>\n\n<p>If you want a \"one shot\" function, you can forget the <code>counter</code> function and use a more direct approach:</p>\n\n<pre><code>fn diff_one_shot(a: &amp;str, b: &amp;str) -&gt; String {\n    let mut counter = HashMap::new();\n    for c in a.chars() {\n        *counter.entry(c).or_insert(0) += 1; // one more\n    }\n    for c in b.chars() {\n        *counter.entry(c).or_insert(0) -= 1; // one less\n    }\n    counter\n        .iter()\n        .filter(|(_c, &amp;n)| n &gt; 0) // only if more `c` in `a` than in `b`\n        .flat_map(|(c, &amp;n)| iter::repeat(c).take(n)) // `n` times `c`\n        .collect::&lt;String&gt;()\n}\n</code></pre>\n\n<p>Examples:</p>\n\n<pre><code>fn main() {\n    println!(\"{:?}\", counter(\"aaabbc\".chars()));\n    // {'b': 2, 'c': 1, 'a': 3}\n    println!(\"{}\", diff(\"aaabbc\", \"ab\"));\n    //aabc\n    println!(\"{}\", diff_one_shot(\"aaabbc\", \"ab\"));\n    //aacb\n}\n</code></pre>\n"}], "owner": {"reputation": 17479, "user_id": 5426333, "user_type": "registered", "accept_rate": 64, "profile_image": "https://i.stack.imgur.com/GtTDC.jpg?s=128&g=1", "display_name": "adem caglin", "link": "https://stackoverflow.com/users/5426333/adem-caglin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 126, "favorite_count": 0, "accepted_answer_id": 57859654, "answer_count": 1, "score": 0, "last_activity_date": 1568055101, "creation_date": 1567418075, "last_edit_date": 1568055014, "question_id": 57754857, "link": "https://stackoverflow.com/questions/57754857/how-can-i-write-a-rust-function-to-find-different-characters-between-two-strings", "title": "How can I write a Rust function to find different characters between two strings?", "body": "<p>The order of the characters is not important but the count is. I mean <code>aaabaaa</code> equals to <code>6a + b</code> and the function is like math subtraction. For example:</p>\n\n<pre><code>fn diff(a: String, b: String) -&gt; String {}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>diff(\"aabbac\", \"accba\") =&gt; \"ab\"\n---------------------------------\n\"aabbac\" = (3a+2b+c)\n\"accba\" = (2a+b+2c)\n(3a+2b+c) - (2a+b+2c) = a+b // -c is ignored\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 3, "creation_date": 1567415179, "post_id": 57754067, "comment_id": 101944936, "body": "How have you tried <code>.trim()</code>? Could you <a href=\"https://stackoverflow.com/posts/57754067/edit\">edit</a> your question and tell us? Also: did you notice the &quot;warning: unused return value of <code>core::str::&lt;impl str&gt;::trim</code> that must be used&quot;?"}, {"owner": {"reputation": 327, "user_id": 11180444, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/PwV4h.jpg?s=128&g=1", "display_name": "Muhammad Areeb Siddiqui", "link": "https://stackoverflow.com/users/11180444/muhammad-areeb-siddiqui"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567415357, "post_id": 57754067, "comment_id": 101945014, "body": "I have edited the question and no i didn&#39;t get this warning."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1567415475, "post_id": 57754067, "comment_id": 101945059, "body": "Thanks for editing! Are you sure about the warning? I copied your code <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=eb5f249babe05520e6746b4a95155219\" rel=\"nofollow noreferrer\">into Playground</a> and compiling it there produces the warning. Which Rust version are you using (<code>rustc -V</code>)? Have you disabled warnings somehow?"}, {"owner": {"reputation": 327, "user_id": 11180444, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/PwV4h.jpg?s=128&g=1", "display_name": "Muhammad Areeb Siddiqui", "link": "https://stackoverflow.com/users/11180444/muhammad-areeb-siddiqui"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567415690, "post_id": 57754067, "comment_id": 101945161, "body": "Yes you are right I also get this warning on Rust Playground. But there is no warning on my rust version 1.35.0 and i havenot disabled any warnings."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567416326, "post_id": 57754067, "comment_id": 101945435, "body": "Very interesting. I just installed 1.35 locally and get that warning with that compiler version. So something&#39;s fishy in your setup (maybe check the <code>RUST_FLAGS</code> env variable?). In any case, as you probably learned from the warning, <code>trim</code> does not modify the original string. You probably want to use <code>pop()</code> or <code>truncate()</code>. See <a href=\"https://stackoverflow.com/q/37888042/2408867\">this</a> Q&amp;A for more information. Would you be fine with closing your question as a dupe of the linked one?"}, {"owner": {"reputation": 327, "user_id": 11180444, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/PwV4h.jpg?s=128&g=1", "display_name": "Muhammad Areeb Siddiqui", "link": "https://stackoverflow.com/users/11180444/muhammad-areeb-siddiqui"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567416787, "post_id": 57754067, "comment_id": 101945632, "body": "Thanks Lukas Kalbertodt !  I solved this by &quot;s.pop()&quot;."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567416828, "post_id": 57754067, "comment_id": 101945647, "body": "Glad we could help!"}], "owner": {"reputation": 327, "user_id": 11180444, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/PwV4h.jpg?s=128&g=1", "display_name": "Muhammad Areeb Siddiqui", "link": "https://stackoverflow.com/users/11180444/muhammad-areeb-siddiqui"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 43, "favorite_count": 0, "closed_date": 1567416810, "answer_count": 0, "score": 1, "last_activity_date": 1567416878, "creation_date": 1567414639, "last_edit_date": 1567416878, "question_id": 57754067, "link": "https://stackoverflow.com/questions/57754067/output-showing-in-different-lines-on-taking-user-input", "closed_reason": "Duplicate", "title": "Output Showing in different lines. On taking user input", "body": "<p>I am taking a user input and then concatenating that user input with a String.\nBut output is showing in two different lines. Any method to be placed so that \"\\n\" gets removed and the both prints on the same line. I have tried <code>.trim()</code> but it's not working.</p>\n\n<pre><code>fn main () {\n    let mut s = String::new();\n    std::io::stdin().read_line(&amp;mut s).expect(\"_\");\n    s.trim();\n    s.push_str(\",World\");\n    println!(\"{}\",s);\n}\n</code></pre>\n\n<p>Output I am getting.</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>hello      \nhello\n,World\n</code></pre>\n\n<p>Output I want.</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>hello      \nhello,World\n</code></pre>\n\n<p>Solved: </p>\n\n<pre><code>fn main () {\n    let mut s = String::new();\n    std::io::stdin().read_line(&amp;mut s).expect(\"_\");\n    s.pop();\n    s.push_str(\",World\");\n    println!(\"{}\",s);\n}\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 1, "last_activity_date": 1567414868, "creation_date": 1567414868, "answer_id": 57754125, "question_id": 57753976, "link": "https://stackoverflow.com/questions/57753976/how-to-use-generic-function-to-reduce-this-duplicate-code/57754125#57754125", "title": "How to use generic function to reduce this duplicate code", "body": "<p>You cannot. Such a proposition has been made -- to have a virtual field inside a trait -- but nothing has been accepted for now. You can use a getter, though, and do some polymorphism:</p>\n\n<pre><code>struct Apple;\n\nstruct Orange;\n\ntrait Named {\n    fn name(&amp;self) -&gt; &amp;str;\n}\n\nimpl Named for Apple {\n    fn name(&amp;self) -&gt; &amp;str {\n        \"Golden\"\n    }\n}\n\nimpl Named for Orange {\n    fn name(&amp;self) -&gt; &amp;str {\n        \"Orange\"\n    }\n}\n\nfn get_name&lt;T&gt;(named: T) -&gt; String where T: Named {\n    named.name().to_owned()\n}\n\nfn main() {\n    assert_eq!(get_name(Apple), \"Golden\");\n    assert_eq!(get_name(Orange), \"Orange\");\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 3, "last_activity_date": 1567415030, "creation_date": 1567415030, "answer_id": 57754157, "question_id": 57753976, "link": "https://stackoverflow.com/questions/57753976/how-to-use-generic-function-to-reduce-this-duplicate-code/57754157#57754157", "title": "How to use generic function to reduce this duplicate code", "body": "<p>When introducing a generic type <code>T</code> like you do, you cannot do anything with it: you cannot call methods, cannot access fields and so on. You just don't know anything about the type. The only way to add \"features\" to the type is via trait bounds, e.g. <code>&lt;T: Foo&gt;</code> if <code>Foo</code> is a trait. </p>\n\n<p>So if you want to abstract over behavior, you have to write a trait that captures this behavior. The problem with your case: <strong>traits do not allow to specify fields</strong>. In other word: you cannot say \"all types implementing this trait need to have the field <code>name</code>). However, you can of course just create <strong>a getter method</strong> (in Rust it's usually called like the field, without the <code>get</code>):</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait HasName {\n    fn name(&amp;self) -&gt; &amp;str;\n}\n\nfn get_meta&lt;T: HasName&gt;(args: T) -&gt; Option&lt;meta::ObjectMeta&gt; {\n   Some(meta::ObjectMeta {\n       name: Some(args.name().clone()),\n   })\n}\n</code></pre>\n\n<p>Using a getter method instead of a field should work in basically all situations.</p>\n\n<hr>\n\n<p>As a side note: there are <a href=\"https://github.com/nikomatsakis/fields-in-traits-rfc/blob/master/0000-fields-in-traits.md\" rel=\"nofollow noreferrer\">some early considerations</a> about adding fields to traits. This discussion is in very early stages, though. There is not even an official RFC, so don't expect this feature anytime soon.</p>\n"}], "owner": {"reputation": 425, "user_id": 1609999, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/a9ed3aba567b518c4750e7581cc89d82?s=128&d=identicon&r=PG", "display_name": "wonderflow", "link": "https://stackoverflow.com/users/1609999/wonderflow"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 57, "favorite_count": 0, "accepted_answer_id": 57754157, "answer_count": 2, "score": 0, "last_activity_date": 1567415030, "creation_date": 1567414246, "last_edit_date": 1567414487, "question_id": 57753976, "link": "https://stackoverflow.com/questions/57753976/how-to-use-generic-function-to-reduce-this-duplicate-code", "title": "How to use generic function to reduce this duplicate code", "body": "<p>I have lots of code similar to below\uff1a</p>\n\n<pre><code>let metadata = Some(meta::ObjectMeta {\n    name: Some(apple.name.clone()),\n}),\n</code></pre>\n\n<pre><code>let metadata = Some(meta::ObjectMeta {\n    name: Some(orange.name.clone()),\n}),\n</code></pre>\n\n<p>I hope to write a generic function something like:</p>\n\n<pre><code>fn get_meta&lt;T&gt;(args: T) -&gt; Option&lt;meta::ObjectMeta&gt; {\n   Some(meta::ObjectMeta {\n       name: Some(args.name.clone()),\n   })\n}\nlet metadata = get_meta(self);\n</code></pre>\n\n<p>But how could I make sure that the generic type T has the field <code>name</code>?</p>\n"}, {"tags": ["rust", "move"], "comments": [{"owner": {"reputation": 1214, "user_id": 2507567, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/ae46f1011962d615214aeef23306619c?s=128&d=identicon&r=PG", "display_name": "Rom&#225;rio", "link": "https://stackoverflow.com/users/2507567/rom%c3%a1rio"}, "edited": false, "score": 0, "creation_date": 1567380564, "post_id": 57750116, "comment_id": 101937551, "body": "Does is_some take self by value?"}, {"owner": {"reputation": 8378, "user_id": 124538, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/82159aeb57c52bc0c7bfe6e9c832c3ea?s=128&d=identicon&r=PG", "display_name": "Wesley Wiser", "link": "https://stackoverflow.com/users/124538/wesley-wiser"}, "edited": false, "score": 0, "creation_date": 1567385051, "post_id": 57750116, "comment_id": 101938013, "body": "Another thing to consider is that there is a <code>impl&lt;T&gt; Copy for Option&lt;T&gt; where T: Copy</code> and the integer primitives are all <code>Copy</code>. Therefore, <code>Option&lt;{integer}&gt;</code> is also <code>Copy</code>."}], "answers": [{"tags": [], "owner": {"reputation": 3595, "user_id": 234658, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19439b09bfe5d5c63096ff104c825d2f?s=128&d=identicon&r=PG&f=1", "display_name": "dkim", "link": "https://stackoverflow.com/users/234658/dkim"}, "is_accepted": false, "score": 4, "last_activity_date": 1567387229, "last_edit_date": 1567387229, "creation_date": 1567384701, "answer_id": 57750414, "question_id": 57750116, "link": "https://stackoverflow.com/questions/57750116/understanding-move-semantics-for-enums-rust/57750414#57750414", "title": "Understanding move semantics for enums Rust", "body": "<p><code>*self</code> in <code>match *self { ... }</code> does not move (or copy) what <code>self</code> points to. From \"<a href=\"https://doc.rust-lang.org/reference/expressions/match-expr.html\" rel=\"nofollow noreferrer\">The Rust Reference</a>\" (emphasis mine),</p>\n\n<blockquote>\n  <p>A <code>match</code> behaves differently depending on whether or not the scrutinee expression is a place expression or value expression. <strong>If the scrutinee expression is a value expression, it is first evaluated into a temporary location,</strong> ...</p>\n  \n  <p><strong>When the scrutinee expression is a place expression, the match does not allocate a temporary location;</strong> however, a by-value binding may copy or move from the memory location. ...</p>\n</blockquote>\n\n<p><code>*self</code> is a place expression. From \"<a href=\"https://doc.rust-lang.org/reference/expressions.html#place-expressions-and-value-expressions\" rel=\"nofollow noreferrer\">The Rust Reference</a>\" (emphasis mine),</p>\n\n<blockquote>\n  <p>Expressions are divided into two main categories: place expressions and value expressions. ...</p>\n  \n  <p><strong>A <em>place expression</em> is an expression that represents a memory location.</strong> These expressions are paths which refer to local variables, static variables, <strong>dereferences (<code>*expr</code>)</strong>, array indexing expressions (<code>expr[expr]</code>), field references (<code>expr.f</code>) and parenthesized place expressions. All other expressions are value expressions.</p>\n  \n  <p>A <em>value expression</em> is an expression that represents an actual value.</p>\n</blockquote>\n\n<hr>\n\n<p>You might also be interested to know that the <code>Some(_) =&gt; true</code> arm in the <code>match</code> body does not bind anything. From \"<a href=\"https://doc.rust-lang.org/reference/patterns.html#wildcard-pattern\" rel=\"nofollow noreferrer\">The Rust Reference</a>\",</p>\n\n<blockquote>\n  <p>Unlike identifier patterns, it does not copy, move or borrow the value it matches.</p>\n</blockquote>\n\n<p>where \"it\" means the wildcard pattern (<code>_</code>).</p>\n"}, {"tags": [], "owner": {"reputation": 7096, "user_id": 3990767, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0a5741a212e3b0e6bd46a8a1e6d76a4a?s=128&d=identicon&r=PG", "display_name": "SOFe", "link": "https://stackoverflow.com/users/3990767/sofe"}, "is_accepted": false, "score": 2, "last_activity_date": 1567408651, "last_edit_date": 1567408651, "creation_date": 1567385116, "answer_id": 57750440, "question_id": 57750116, "link": "https://stackoverflow.com/questions/57750116/understanding-move-semantics-for-enums-rust/57750440#57750440", "title": "Understanding move semantics for enums Rust", "body": "<p>(See the @dkim's answer for a more official and cited answer)</p>\n\n<p>If the signature of the function accepts by reference, it does not take ownership of the value. Option.is_some() actually takes &amp;self not self.</p>\n\n<p>The interesting part is how <code>*self</code> is allowed to be used in a function that receives <code>&amp;self</code> when <code>Self: Copy</code> is not bounded.</p>\n\n<p>To test this, let's create a minimal example containing something similar: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d7b137b74b5cd8f8bb57398ae01bf4e3\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d7b137b74b5cd8f8bb57398ae01bf4e3</a></p>\n\n<pre><code>#[derive(Debug)]\npub enum A {\n    X(String),\n    Y(i32),\n}\npub fn f(a: &amp;A) {\n    match *a {\n        A::X(_) =&gt; {\n            //  dbg!(s);\n        }\n        A::Y(_i) =&gt; {\n            //  dbg!(i);\n        }\n    };\n}\n</code></pre>\n\n<p>This compiles fine. But let's change the <code>A::X(_)</code> pattern to <code>A::X(_s)</code>: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=93030e5c3f84532532c5db966c798bd6\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=93030e5c3f84532532c5db966c798bd6</a></p>\n\n<pre><code>#[derive(Debug)]\npub enum A {\n    X(String),\n    Y(i32),\n}\npub fn f(a: &amp;A) {\n    match *a {\n        A::X(_s) =&gt; {\n            //  dbg!(s);\n        }\n        A::Y(_i) =&gt; {\n            //  dbg!(i);\n        }\n    };\n}\n</code></pre>\n\n<p>This fails to compile:</p>\n\n<pre><code>error[E0507]: cannot move out of `a.0` which is behind a shared reference\n --&gt; src/lib.rs:7:11\n  |\n7 |     match *a {\n  |           ^^ help: consider borrowing here: `&amp;*a`\n8 |         A::X(_s) =&gt; {\n  |              --\n  |              |\n  |              data moved here\n  |              move occurs because `_s` has type `std::string::String`, which does not implement the `Copy` trait\n</code></pre>\n\n<p>So it appears that dereferencing a non-Copy enum is perfectly fine, as long as it wouldn't be used for moving inner non-Copy values. <code>_</code> is fine because it guarantees that the underlying value would never be used, while <code>_s</code> does not compile because it is just a normal allow(unused) variable.</p>\n\n<p>This also makes sense because it allows the same match arm to work on both Copy and non-Copy types, as long as no usages violate the ownership rules </p>\n"}], "owner": {"reputation": 2932, "user_id": 7212809, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-VlOyJEUeeSc/AAAAAAAAAAI/AAAAAAAAAAA/AGDgw-jExBae7iJ2ALFtcMj_6BCoHGTMgw/mo/photo.jpg?sz=128", "display_name": "nz_21", "link": "https://stackoverflow.com/users/7212809/nz-21"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 229, "favorite_count": 0, "answer_count": 2, "score": 1, "last_activity_date": 1567408651, "creation_date": 1567379759, "question_id": 57750116, "link": "https://stackoverflow.com/questions/57750116/understanding-move-semantics-for-enums-rust", "title": "Understanding move semantics for enums Rust", "body": "<p>So I'm looking at the impl for <code>is_some()</code> for <code>Option</code> and I noticed that it uses <code>match *self {}</code> under the hood...so it moves it internally.</p>\n\n<p>My question is, if it gets moved, how am I able to do something like this? <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f094da12290b77bad526674467e51043\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f094da12290b77bad526674467e51043</a> </p>\n\n<pre><code>fn main() {\n    let x = Option::Some(3);\n    x.is_some();\n    x.is_some();\n}\n</code></pre>\n\n<p>My expectation is that I should be able to  call <code>is_some()</code> only once, and the next time I call it I should get some sort of error saying it's been moved...but no, it all compiles fine.</p>\n\n<p>What am I misunderstanding?</p>\n"}, {"tags": ["rust", "epoll"], "comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1567379795, "post_id": 57750028, "comment_id": 101937451, "body": "What exactly is your problem?"}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1567379989, "post_id": 57750028, "comment_id": 101937483, "body": "@mcarton How do I define the events array?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1567405324, "post_id": 57750028, "comment_id": 101941191, "body": "What happens with the code you have shown? Does it fail to compile? With what message? Does it fail to run? With what message? Does it run but not do what you expected? What did you expect and what does it do?"}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567417041, "post_id": 57750028, "comment_id": 101945732, "body": "@Jmb See updated answer"}, {"owner": {"reputation": 66560, "user_id": 9072753, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/EPmGy.jpg?s=128&g=1", "display_name": "KamilCuk", "link": "https://stackoverflow.com/users/9072753/kamilcuk"}, "edited": false, "score": 0, "creation_date": 1567417634, "post_id": 57750028, "comment_id": 101946003, "body": "<code>as it is a bitflag</code> - it is not a bitflag, it is a structure. Did you check out the <a href=\"https://docs.rs/epoll/4.1.0/epoll/struct.Events.html\" rel=\"nofollow noreferrer\">reference</a>?"}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "reply_to_user": {"reputation": 66560, "user_id": 9072753, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/EPmGy.jpg?s=128&g=1", "display_name": "KamilCuk", "link": "https://stackoverflow.com/users/9072753/kamilcuk"}, "edited": false, "score": 0, "creation_date": 1567418040, "post_id": 57750028, "comment_id": 101946207, "body": "@KamilCuk yes I saw it but if I look at my source code it looks like this: <code>bitflags! { pub struct Events: u32 { ...</code>"}], "answers": [{"comments": [{"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "edited": false, "score": 0, "creation_date": 1567451018, "post_id": 57755376, "comment_id": 101959321, "body": "Doesn&#39;t work for me I get a <code>function or associated item not found in &#39;epoll::Event&#39;</code> on <code>Event::empty()</code>"}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "edited": false, "score": 0, "creation_date": 1567464084, "post_id": 57755376, "comment_id": 101962332, "body": "ok found the solution now: <code>let mut events = [Event::new(Events::empty(), 0); 10];</code> Thanks for your support :)"}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 0, "last_activity_date": 1567420170, "creation_date": 1567420170, "answer_id": 57755376, "question_id": 57750028, "link": "https://stackoverflow.com/questions/57750028/how-to-use-epoll-in-rust/57755376#57755376", "title": "How to use epoll in rust", "body": "<p>Since <code>events</code> is an output parameter for <code>epoll::wait</code> you can put anything in there, but you need to put a valid value. A sensible default would be an empty event set:</p>\n\n<pre><code>let mut events = [Event::empty(); 10];\n</code></pre>\n\n<p><code>Events</code> is a struct generated by the <code>bitflags</code> macro, so looking at the source code won't help much in understanding how to use it, but luckily <code>bitflags</code> also generates quite comprehensive <a href=\"https://docs.rs/epoll/4.1.0/epoll/struct.Events.html\" rel=\"nofollow noreferrer\">documentation</a> for the generated structs.</p>\n"}], "owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 434, "favorite_count": 0, "closed_date": 1567422479, "accepted_answer_id": 57755376, "answer_count": 1, "score": -1, "last_activity_date": 1567420170, "creation_date": 1567378528, "last_edit_date": 1567419386, "question_id": 57750028, "link": "https://stackoverflow.com/questions/57750028/how-to-use-epoll-in-rust", "closed_reason": "Needs details or clarity", "title": "How to use epoll in rust", "body": "<p>I came across <a href=\"https://docs.rs/epoll/4.1.0/epoll/\" rel=\"nofollow noreferrer\">this</a> library to support <code>epoll</code> in rust but I'm not sure how to properly use the <code>epoll:wait</code> function:</p>\n\n<pre><code>let mut events = [Event; 10];\nrc = epoll::wait(self.vfio_epoll_fd, timeout, &amp;mut events)?;\n</code></pre>\n\n<p>Would be nice if someone could provide me with some examples to get started :) Thanks in advance for your support.</p>\n\n<p>I get the following error when compiling the above code:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0423]: expected value, found struct `Event`\n   --&gt; src/interrupts.rs:132:27\n    |\n132 |         let mut events = [Event; 10];\n    |                           ^^^^^ did you mean `Event { /* fields */ }`?\n</code></pre>\n\n<p>Event structure looks like this:</p>\n\n<pre><code>pub struct Event {\n    pub events: Events,\n    pub data: u64,\n}\n</code></pre>\n\n<p>The problem is I don't know what <code>Events</code> as it is a bitflag.</p>\n"}, {"tags": ["rust", "associated-types"], "answers": [{"comments": [{"owner": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 0, "creation_date": 1567377482, "post_id": 57749870, "comment_id": 101937174, "body": "It&#39;s still on whoever is writing the concrete operation to obey the specification. I thought about something like this with a trait InitData that defines a get() -&gt; Option&lt;i32&gt;. And exposing concrete types that implement the trait and convey the logic. Wasn&#39;t happy with it :D"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 0, "creation_date": 1567377648, "post_id": 57749870, "comment_id": 101937199, "body": "@AntonioDropuli\u0107 So all types that implement <code>Operation</code> should in fact <i>either</i> be constructible from nothing <i>or</i> from an <code>i32</code>? No other choices?"}, {"owner": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 0, "creation_date": 1567377705, "post_id": 57749870, "comment_id": 101937206, "body": "That is the how the task was worded. It is not a real world assigment. Just practice :D"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 0, "creation_date": 1567378613, "post_id": 57749870, "comment_id": 101937309, "body": "@AntonioDropuli\u0107 I edited my answer to include a general solution to what you are asking. Sorry for the quick&#39;n&#39;dirty writing style right now!"}, {"owner": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 0, "creation_date": 1567773530, "post_id": 57749870, "comment_id": 102074402, "body": "@ LukasKalbertodt It is not trivial for me to understand your answer, so please correct me if I&#39;m wrong. Each concrete operation now implements the operation trait, implementing both <code>init</code> and <code>init_from</code>, but thanks to the <code>InitData</code> only one can method can ever be used. Further <code>UnparametrizedInit</code> and <code>ParametrizedInit</code> will be implemented automaticaly for those types allowing me to easily disambiguate them - I don&#39;t see the other use. Thanks. Sorry for the late reply. Wanted to find the time to study your answer fairly before i ask anything :D"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "edited": false, "score": 1, "creation_date": 1567775961, "post_id": 57749870, "comment_id": 102075739, "body": "Exactly! <code>UnparametrizedInit</code> and <code>ParametrizedInit</code> are more or less just for convenience. Instead of them you could also just use <code>Operation&lt;InitData = &#47;* ... *&#47;&gt;</code> as trait bound. The two traits are the mutually exclusive traits (the title of your question). And yes, the need to implement both <code>init</code> and <code>init_from</code> despite only one being callable is annoying (see <a href=\"https://stackoverflow.com/q/55521669/2408867\">there Q&amp;A</a>). I use this trick in a method of mine and have a bunch of methods with <code>unreachable!()</code> body because of that :/ But it will likely be improved soon."}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 4, "last_activity_date": 1567378564, "last_edit_date": 1567378564, "creation_date": 1567376457, "answer_id": 57749870, "question_id": 57749827, "link": "https://stackoverflow.com/questions/57749827/mutually-exclusive-traits/57749870#57749870", "title": "Mutually exclusive traits", "body": "<p>How about you use an associated type to define the initialization data?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait Operation {\n    type InitData;\n    fn init(data: Self::InitData) -&gt; Self;\n\n    fn evaluate(&amp;self, operand: i32) -&gt; i32;\n}\n\nimpl Operation for Id {\n    type InitData = ();\n    fn init(_: Self::InitData) -&gt; Self {\n        Id {}\n    }\n\n    fn evaluate(&amp;self, operand: i32) -&gt; i32 {\n        operand\n    }\n}\n\nimpl Operation for Sum {\n    type InitData = i32;\n    fn init(augend: Self::InitData) -&gt; Self {\n        Sum { augend }\n    }\n\n    fn evaluate(&amp;self, addend: i32) -&gt; i32 {\n        augend + addend\n    }\n}\n</code></pre>\n\n<p>For the <code>Id</code> case you specify <code>()</code> to say that the initialization does not need data. It's still a bit meh to call <code>Operation::init(())</code>, but I think the trait at least captures the logic fairly well.</p>\n\n<hr>\n\n<p>To actually get mutually exclusive traits (which is apparently what you want), you have to use some workaround. The Rust language does not support mutually exclusive traits per-se. But you can use associated types and some marker types to get something similar. This is a bit strange, but works for now.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait InitMarker {}\n\nenum InitFromNothingMarker {}\nenum InitFromI32Marker {}\n\nimpl InitMarker for InitFromNothingMarker {}\nimpl InitMarker for InitFromI32Marker {}\n\ntrait Operation {\n    type InitData: InitMarker;\n\n    fn init() -&gt; Self\n    where\n        Self: Operation&lt;InitData = InitFromNothingMarker&gt;;\n    fn init_from(v: i32) -&gt; Self\n    where\n        Self: Operation&lt;InitData = InitFromI32Marker&gt;;\n}\n\ntrait UnparametrizedInit: Operation&lt;InitData = InitFromNothingMarker&gt; {}\ntrait ParametrizedInit: Operation&lt;InitData = InitFromI32Marker&gt; {}\n\nimpl&lt;T: Operation&lt;InitData = InitFromNothingMarker&gt;&gt; UnparametrizedInit for T {}\nimpl&lt;T: Operation&lt;InitData = InitFromI32Marker&gt;&gt; ParametrizedInit for T {}\n</code></pre>\n\n<p>(Ideally you want to have a <code>Sealed</code> trait that is defined in a private submodule of your crate. That way, no one (except for you) can implement the trait. And then make <code>Sealed</code> a super trait for <code>InitMarker</code>.)</p>\n\n<p>This is quite a bit of code, but at least you can make sure that implementors of <code>Operation</code> implement exactly one of <code>ParametrizedInit</code> and <code>UnparametrizedInit</code>.</p>\n\n<p>In the future, you will likely be able to replace the marker types with an enum and the associated type with an associated const. But currently, \"const generics\" are not finished enough, so we have to take the ugly route by using marker types. I'm actually discussing these solutions in <a href=\"https://github.com/LukasKalbertodt/master-thesis\" rel=\"nofollow noreferrer\">my master's thesis (section 4.2, just search for \"mutually exclusive\")</a>. </p>\n"}], "owner": {"reputation": 301, "user_id": 5872842, "user_type": "registered", "accept_rate": 75, "profile_image": "https://graph.facebook.com/581227132031007/picture?type=large", "display_name": "Antonio Dropuli\u0107", "link": "https://stackoverflow.com/users/5872842/antonio-dropuli%c4%87"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 513, "favorite_count": 0, "accepted_answer_id": 57749870, "answer_count": 1, "score": 1, "last_activity_date": 1567395919, "creation_date": 1567375884, "last_edit_date": 1567395919, "question_id": 57749827, "link": "https://stackoverflow.com/questions/57749827/mutually-exclusive-traits", "title": "Mutually exclusive traits", "body": "<p>I need to create operations for an operation sequence. The operations share the following behaviour. They can be evaluated, and at construction they can either be parametrized by a single i32 (eg. Sum) or not parametrized at all (eg. Id).</p>\n\n<p>I create a trait Operation. The evaluate part is trivial. </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait Operation {\n    fn evaluate(&amp;self, operand: i32) -&gt; i32;\n}\n</code></pre>\n\n<p>But I don't know how to describe the second demand. The first option is to simply let concrete implementations of Operation handle that behaviour. </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct Id {}\n\nimpl Id {\n    pub fn new() -&gt; Id {\n        Id {}\n    }\n}\n\nimpl Operation for Id {\n    fn evaluate(&amp;self, operand: i32) -&gt; i32 {\n        operand\n    }\n}\n\npub struct Sum {\n    augend: i32,\n}\n\nimpl Sum {\n    pub fn new(augend: i32) -&gt; Sum {\n        Sum { augend }\n    }\n}\n\nimpl Operation for Sum {\n    fn evaluate(&amp;self, addend: i32) -&gt; i32 {\n        augend + addend\n    }\n}\n</code></pre>\n\n<p>Second option is a new function that takes an optional i32. Then the concrete implementations deal with the possibly redundant input. I find this worse than the first option.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait Operation {\n    fn evaluate(&amp;self, operand: i32) -&gt; i32;\n    fn new(parameter: std::Option&lt;i32&gt;)\n}\n</code></pre>\n\n<p>Google has lead me to mutually exclusive traits: <a href=\"https://github.com/rust-lang/rust/issues/51774\" rel=\"nofollow noreferrer\">https://github.com/rust-lang/rust/issues/51774</a>. It seems promising, but it doesn't quite solve my problem.</p>\n\n<p>Is there a way to achieve this behaviour?</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait Operation = Evaluate + (ParametrizedInit or UnparametrizedInit)\n</code></pre>\n"}, {"tags": ["c", "rust", "ioctl"], "comments": [{"owner": {"reputation": 10345, "user_id": 4131059, "user_type": "registered", "accept_rate": 91, "profile_image": "https://i.stack.imgur.com/uDaBr.jpg?s=128&g=1", "display_name": "Alexander Huszagh", "link": "https://stackoverflow.com/users/4131059/alexander-huszagh"}, "edited": false, "score": 0, "creation_date": 1567373196, "post_id": 57749559, "comment_id": 101936550, "body": "They&#39;re not going to have the same layout. Flexible data members should be in contiguous memory with the rest of the structure, and should only take the required space needed to store the data. Your example does not do that. A pointer always takes space, takes a fixed amount of space, and any data pointed to it is not contiguous with the rest of the struct."}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 2, "creation_date": 1567373433, "post_id": 57749559, "comment_id": 101936597, "body": "Also, <code>&amp;[event_fd as u8] as *const u8</code> is likely unsafe: the array is temporary and doesn&#39;t live long enough."}, {"owner": {"reputation": 10345, "user_id": 4131059, "user_type": "registered", "accept_rate": 91, "profile_image": "https://i.stack.imgur.com/uDaBr.jpg?s=128&g=1", "display_name": "Alexander Huszagh", "link": "https://stackoverflow.com/users/4131059/alexander-huszagh"}, "edited": false, "score": 0, "creation_date": 1567373533, "post_id": 57749559, "comment_id": 101936608, "body": "You&#39;re also going to lose size information, so it has no way to safely read that data even if the data wasn&#39;t temporary."}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "edited": false, "score": 1, "creation_date": 1567374066, "post_id": 57749559, "comment_id": 101936702, "body": "Yes, you are both right this was just a desperate way to solve this. I&#39;m quite new to rust and this is something I have never seen before :)"}], "answers": [{"comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567373245, "post_id": 57749615, "comment_id": 101936561, "body": "What do you think about <a href=\"https://stackoverflow.com/questions/51005645/how-to-implement-the-c-flexible-array-member-pattern-in-rust\">this question</a>? It does not have an answer yet. Do you think this question should be closed as a dupe? Do you want to move your answer then? What about the comments of the linked question: are they up to date yet?"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567373891, "post_id": 57749615, "comment_id": 101936667, "body": "@LukasKalbertodt you seem to be right. I answered the other question, although I can&#39;t make this one as duplicate yet at my answer hasn&#39;t been upvoted."}, {"owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "edited": false, "score": 0, "creation_date": 1567373998, "post_id": 57749615, "comment_id": 101936688, "body": "@mcarton Thank you so much for your reply this worked :) I searched for almost 2 hours but didn&#39;t find the other one so sorry to asked a duplicate here :)"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "edited": false, "score": 1, "creation_date": 1567375080, "post_id": 57749615, "comment_id": 101936845, "body": "@tzwickl Don&#39;t worry about asking duplicates! It&#39;s always useful to have a few other questions with different formulations that link to the original one. That way, people can find the original answer more easily."}], "tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 1, "last_activity_date": 1567373170, "creation_date": 1567373170, "answer_id": 57749615, "question_id": 57749559, "link": "https://stackoverflow.com/questions/57749559/how-to-use-c-array-in-a-rust-structure/57749615#57749615", "title": "How to use C array in a Rust structure", "body": "<p>In C, a struct whose last field is an array with no specified size is a dynamically typed struct. The data is present at the end of the struct with no extra level of indirection.</p>\n\n<p>The Rust equivalent isn't a pointer (which has a fixed size), but a slice. Your struct would be in Rust:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[allow(non_camel_case_types)]\n#[repr(C)]\nstruct vfio_irq_set {\n    argsz: u32,\n    flags: u32,\n    index: u32,\n    start: u32,\n    count: u32,\n    data: [u8],\n}\n</code></pre>\n\n<p>However those types are not really usable right now, and a more practical equivalent would be:</p>\n\n<pre><code>#[allow(non_camel_case_types)]\n#[repr(C)]\nstruct vfio_irq_set&lt;T: ?Sized&gt; {\n    argsz: u32,\n    flags: u32,\n    index: u32,\n    start: u32,\n    count: u32,\n    data: T,\n}\n</code></pre>\n\n<p>where you have to make sure that <code>T</code> is a properly sized array or slice.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/nomicon/exotic-sizes.html#dynamically-sized-types-dsts\" rel=\"nofollow noreferrer\">Dynamically Sized Types (DSTs) on the nomicon</a></li>\n</ul>\n"}], "owner": {"reputation": 1183, "user_id": 2372782, "user_type": "registered", "accept_rate": 36, "profile_image": "https://www.gravatar.com/avatar/ceed5b998d60e328a1a33bd6f1d5f4d1?s=128&d=identicon&r=PG", "display_name": "tzwickl", "link": "https://stackoverflow.com/users/2372782/tzwickl"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 301, "favorite_count": 0, "closed_date": 1567375016, "accepted_answer_id": 57749615, "answer_count": 1, "score": 2, "last_activity_date": 1567373170, "creation_date": 1567372514, "question_id": 57749559, "link": "https://stackoverflow.com/questions/57749559/how-to-use-c-array-in-a-rust-structure", "closed_reason": "Duplicate", "title": "How to use C array in a Rust structure", "body": "<p>I'm programming a driver in rust and I have the following C struct which I need to convert to something equivalent in Rust:</p>\n\n<pre><code>struct vfio_irq_set {\n    __u32   argsz;\n    __u32   flags;\n    __u32   index;\n    __u32   start;\n    __u32   count;\n    __u8    data[];\n};\n</code></pre>\n\n<p>The only variable that causes me some problems is the data array. So far I have the following rust structure:</p>\n\n<pre><code>#[allow(non_camel_case_types)]\n#[repr(C)]\nstruct vfio_irq_set {\n    argsz: u32,\n    flags: u32,\n    index: u32,\n    start: u32,\n    count: u32,\n    data: *const u8,\n}\n</code></pre>\n\n<p>The rust code to initialize the structure and make the <code>ioctl</code> call looks the following:</p>\n\n<pre><code>let irq_set: vfio_irq_set = vfio_irq_set {\n    argsz: (mem::size_of::&lt;vfio_irq_set&gt;() + mem::size_of::&lt;RawFd&gt;() * (MAX_INTERRUPT_VECTORS + 1) as usize) as u32,\n    count: interrupt_vector,\n    flags: VFIO_IRQ_SET_DATA_EVENTFD | VFIO_IRQ_SET_ACTION_TRIGGER,\n    index: VFIO_PCI_MSIX_IRQ_INDEX as u32,\n    start: 0,\n    data: &amp;[event_fd as u8] as *const u8,\n};\n\nif unsafe { libc::ioctl(device_fd, VFIO_DEVICE_SET_IRQS, &amp;irq_set) } == -1 {\n    return Err(format!(\n        \"failed to VFIO_DEVICE_SET_IRQS. Errno: {}\",\n        unsafe { *libc::__errno_location() }\n    ).into());\n}\n</code></pre>\n\n<p>But I always get back a <code>\"failed to VFIO_DEVICE_SET_IRQS. Errno: 22\"</code>.</p>\n\n<p>Does someone have an idea on what I'm doing wrong?</p>\n"}, {"tags": ["rust", "glibc", "rust-cargo"], "comments": [{"owner": {"reputation": 5513, "user_id": 2718801, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9d4b144cdafa73e1d470362ed8d7c3a9?s=128&d=identicon&r=PG", "display_name": "jhpratt", "link": "https://stackoverflow.com/users/2718801/jhpratt"}, "edited": false, "score": 1, "creation_date": 1567368642, "post_id": 57749127, "comment_id": 101935734, "body": "Something like <a href=\"https://redbeardlab.com/2019/05/07/rust-and-glibc-version/\" rel=\"nofollow noreferrer\">this</a>?"}, {"owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "reply_to_user": {"reputation": 5513, "user_id": 2718801, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9d4b144cdafa73e1d470362ed8d7c3a9?s=128&d=identicon&r=PG", "display_name": "jhpratt", "link": "https://stackoverflow.com/users/2718801/jhpratt"}, "edited": false, "score": 0, "creation_date": 1567369783, "post_id": 57749127, "comment_id": 101935932, "body": "@jhpratt Thanks but <code>musl</code> doesn&#39;t work for me because I also use other system libraries such as <code>openssl</code>."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 2, "creation_date": 1567409766, "post_id": 57749127, "comment_id": 101942726, "body": "Google? <a href=\"https://github.com/rust-lang/libc/issues/1412\" rel=\"nofollow noreferrer\">Minimum Supported glibc version</a>, <a href=\"https://users.rust-lang.org/t/how-to-compile-rust-with-a-specific-glibc-version-for-gnueabihf-architecture/6680\" rel=\"nofollow noreferrer\">How to compile rust with a specific GLIBC version</a>, <a href=\"https://github.com/rust-lang/rust/issues/57497\" rel=\"nofollow noreferrer\">Rust binaries require a too recent glibc</a>, ..."}], "owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 1353, "favorite_count": 1, "answer_count": 0, "score": 7, "last_activity_date": 1568811507, "creation_date": 1567368453, "last_edit_date": 1568811507, "question_id": 57749127, "link": "https://stackoverflow.com/questions/57749127/how-can-i-specify-the-glibc-version-in-cargo-build-for-rust", "title": "How can I specify the GLIBC version in cargo build for Rust?", "body": "<p>I use rust 1.34 and 1.35. Currently it links to <code>GLIBC_2.18</code>.</p>\n\n<p>How can I limit <code>cargo build</code> to link <code>GLIBC</code> up to version <code>2.14</code>?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 3, "last_activity_date": 1567372938, "creation_date": 1567372938, "answer_id": 57749595, "question_id": 57749069, "link": "https://stackoverflow.com/questions/57749069/thread-main-panicked-at-index-out-of-bounds-the-len-is-2-but-the-index-is-2/57749595#57749595", "title": "thread &#39;main&#39; panicked at &#39;index out of bounds: the len is 2 but the index is 2&#39; crash", "body": "<p>Your immediate problem is that after you called <code>remove</code> three times, your loop continues to run. The loop range (<code>0..repository_urls.len() - 1</code>) is only evaluated at the very beginning of the loop. But now the vector length has changed and accessing the vector via <code>repository_urls[i + 1]</code> then fails. You can fix this by adding a <code>break</code> after your <code>remove</code>s.</p>\n\n<p>For command line argument parsing, it's usually advisable to use a crate. Doing it manually usually leads to spaghetti code and subtle bugs. I can very much recommend <a href=\"https://crates.io/crates/structopt\" rel=\"nofollow noreferrer\"><code>structopt</code></a>. It's really easy to add it to your application.</p>\n"}, {"tags": [], "owner": {"reputation": 1113, "user_id": 1426842, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/GU6Z5.jpg?s=128&g=1", "display_name": "Micha\u0142 Fita", "link": "https://stackoverflow.com/users/1426842/micha%c5%82-fita"}, "is_accepted": false, "score": 0, "last_activity_date": 1567429153, "creation_date": 1567429153, "answer_id": 57757373, "question_id": 57749069, "link": "https://stackoverflow.com/questions/57749069/thread-main-panicked-at-index-out-of-bounds-the-len-is-2-but-the-index-is-2/57757373#57757373", "title": "thread &#39;main&#39; panicked at &#39;index out of bounds: the len is 2 but the index is 2&#39; crash", "body": "<p>Above the advice from @lukas-kalbertodt in idiomatic Rust you normally create iterator over existing vector, then using filtering techniques you collect data to the new vector. Please avoid very inefficient removal from vectors.</p>\n"}], "owner": {"reputation": 1031, "user_id": 10919715, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d33ede762e1f928b26db57583853a772?s=128&d=identicon&r=PG&f=1", "display_name": "SmushyTaco", "link": "https://stackoverflow.com/users/10919715/smushytaco"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1621, "favorite_count": 0, "answer_count": 2, "score": 1, "last_activity_date": 1567429153, "creation_date": 1567368012, "question_id": 57749069, "link": "https://stackoverflow.com/questions/57749069/thread-main-panicked-at-index-out-of-bounds-the-len-is-2-but-the-index-is-2", "title": "thread &#39;main&#39; panicked at &#39;index out of bounds: the len is 2 but the index is 2&#39; crash", "body": "<pre class=\"lang-rust prettyprint-override\"><code>use std::env;\nuse std::process;\n\nfn main(){\n    let mut repository_urls: Vec&lt;String&gt; = env::args().collect();\n    if repository_urls.len() == 1 {\n        eprintln!(\"You have to enter at least one repository url!\");\n        process::exit(1);\n    } else {\n        for i in 0 .. repository_urls.len() - 1 {\n            if repository_urls[i + 1] == \"--advanced\" &amp;&amp; repository_urls.len() &gt;= i + 5 {\n                repository_urls.remove(i + 4);\n                repository_urls.remove(i + 3);\n                repository_urls.remove(i + 2);\n            } else {\n\n            }\n        }\n        //Ends the process normally\n        process::exit(0);\n    }\n}\n\n</code></pre>\n\n<p>If you were to have <code>--advanced 1 2 3</code> for the arguments for this it would do everything and execute all the logic as intended but when it finishes it ends up crashing with:</p>\n\n<pre><code>thread 'main' panicked at 'index out of bounds: the len is 2 but the index is 2', /rustc/a53f9df32fbb0b5f4382caaad8f1a46f36ea887c/src/libcore/slice/mod.rs:2695:10\nnote: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n</code></pre>\n\n<p>How would I get my program but exit normally without a crash?</p>\n"}, {"tags": ["rust", "closures", "lifetime"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567362802, "post_id": 57748424, "comment_id": 101934457, "body": "Hi there! I think your question is answered by my answer <a href=\"https://stackoverflow.com/q/52752259/2408867\">here</a>. The reasons for why this doesn&#39;t work are subtle, so please take your time to understand the answer I linked. I hope this helps! Please let us know if the linked answer indeed answers your question. Thanks!"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 1, "creation_date": 1567362963, "post_id": 57748424, "comment_id": 101934494, "body": "In particular, regarding your <code>HandClosure</code> code: you use <code>fn call_mut(&amp;&#39;a mut self)</code>, but that&#39;s not the same signature as in <code>FnMut</code>. There, it&#39;s <code>fn call_mut(&amp;mut self, ...)</code> meaning that the <code>self</code> object gets a new, anonymous lifetime and not the same lifetime as the reference the closure is storing. This lifetime difference is why your small example compiles. Remove the <code>&#39;a</code> and you will get an error as well."}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567418492, "post_id": 57748424, "comment_id": 101946417, "body": "We&#39;ve closed this as dupe now. If you disagree that the linked answer answers your question, let us know."}, {"owner": {"reputation": 765, "user_id": 7246614, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/83eccd212e4687fc66e13aad21796b0b?s=128&d=identicon&r=PG", "display_name": "timotree", "link": "https://stackoverflow.com/users/7246614/timotree"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1567434283, "post_id": 57748424, "comment_id": 101953366, "body": "@LukasKalbertodt I agree that it&#39;s a duplicate. I just wish that there was another trait besides <code>FnMut</code> that relaxed the lifetime requirements. I&#39;m sure that the iterator method I&#39;m calling would be happy to use that instead."}], "owner": {"reputation": 765, "user_id": 7246614, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/83eccd212e4687fc66e13aad21796b0b?s=128&d=identicon&r=PG", "display_name": "timotree", "link": "https://stackoverflow.com/users/7246614/timotree"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 62, "favorite_count": 0, "closed_date": 1567418455, "answer_count": 0, "score": 4, "last_activity_date": 1567361673, "creation_date": 1567361673, "question_id": 57748424, "link": "https://stackoverflow.com/questions/57748424/why-cant-i-create-a-closure-that-produces-mutable-references-to-what-it-closes", "closed_reason": "Duplicate", "title": "Why can&#39;t I create a closure that produces mutable references to what it closes on?", "body": "<p>I want to create a closure which closes upon a mutable reference to something, and then returns mutable references with created from the original one.</p>\n\n<p>I've minimized my code to this function (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c4b979ec0d6fc402909dc4a55f70c0cc\" rel=\"nofollow noreferrer\">playground</a>):</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn produce_closure&lt;'a&gt;(string: &amp;'a mut String) -&gt; impl FnMut() -&gt; &amp;'a mut String + 'a {\n    move || &amp;mut *string\n}\n</code></pre>\n\n<p>When I try to compile the above code, I get this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime for borrow expression due to conflicting requirements\n --&gt; src/lib.rs:2:13\n  |\n2 |     move || &amp;mut *string\n  |             ^^^^^^^^^^^^\n  |\nnote: first, the lifetime cannot outlive the lifetime '_ as defined on the body at 2:5...\n --&gt; src/lib.rs:2:5\n  |\n2 |     move || &amp;mut *string\n  |     ^^^^^^^^^^^^^^^^^^^^\nnote: ...so that reference does not outlive borrowed content\n --&gt; src/lib.rs:2:13\n  |\n2 |     move || &amp;mut *string\n  |             ^^^^^^^^^^^^\nnote: but, the lifetime must be valid for the lifetime 'a as defined on the function body at 1:20...\n --&gt; src/lib.rs:1:20\n  |\n1 | fn produce_closure&lt;'a&gt;(string: &amp;'a mut String) -&gt; impl FnMut() -&gt; &amp;'a mut String + 'a {\n  |                    ^^\nnote: ...so that reference does not outlive borrowed content\n --&gt; src/lib.rs:2:13\n  |\n2 |     move || &amp;mut *string\n  |             ^^^^^^^^^^^^\n</code></pre>\n\n<p>In order to figure out if this kind of a closure was possible, I tried writing it by hand (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=3461605659c4d908e6311844cf6c8f08\" rel=\"nofollow noreferrer\">playground</a>):</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct HandClosure&lt;'a&gt;(&amp;'a mut String);\n\nimpl&lt;'a&gt; HandClosure&lt;'a&gt; {\n    fn produce(capture: &amp;'a mut String) -&gt; Self {\n        Self(capture)\n    }\n\n    fn call_mut(&amp;'a mut self) -&gt; &amp;'a mut String {\n        self.0\n    }\n\n    fn call_once(self) -&gt; &amp;'a mut String {\n        self.0\n    }\n}\n</code></pre>\n\n<p>And that code compiles fine. Is this a compiler bug? What am I missing?</p>\n"}, {"tags": ["rust", "type-level-computation"], "answers": [{"comments": [{"owner": {"reputation": 211, "user_id": 3986895, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/8ac3ee54f310a1af6998e44ffacaa4fc?s=128&d=identicon&r=PG&f=1", "display_name": "E Y", "link": "https://stackoverflow.com/users/3986895/e-y"}, "edited": false, "score": 0, "creation_date": 1568190449, "post_id": 57752224, "comment_id": 102192513, "body": "Just in case somebody is interested; I used this heterogeneous list in my case to register types with a container that stores instances of these types via dynamic typing (through <code>std::any::Any</code>). This allows me to keep the container open to adding external types, while enabling (de)-serialization of the entire structure."}], "tags": [], "owner": {"reputation": 211, "user_id": 3986895, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/8ac3ee54f310a1af6998e44ffacaa4fc?s=128&d=identicon&r=PG&f=1", "display_name": "E Y", "link": "https://stackoverflow.com/users/3986895/e-y"}, "is_accepted": true, "score": 0, "last_activity_date": 1567405715, "last_edit_date": 1567405715, "creation_date": 1567405211, "answer_id": 57752224, "question_id": 57748291, "link": "https://stackoverflow.com/questions/57748291/how-can-i-obtain-the-individual-elements-of-a-heterogeneous-list-without-knowing/57752224#57752224", "title": "How can I obtain the individual elements of a heterogeneous list without knowing their type?", "body": "<p>I have found a reasonable recursive solution, but it only works out if I can modify the <code>HList</code> trait based on the trait requirements of the work to be done. This is fine for my use case, even if it's not as generic as I would have liked it to be.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::fmt::Debug;\n\npub trait MyCustomTrait&lt;'a&gt;: Debug {}\n\nimpl&lt;'a&gt; MyCustomTrait&lt;'a&gt; for () {}\n\nimpl&lt;'a&gt; MyCustomTrait&lt;'a&gt; for usize {}\n\nimpl&lt;'a&gt; MyCustomTrait&lt;'a&gt; for String {}\n\npub trait HList: Sized {\n    const LEN: usize;\n\n    type Head: for&lt;'a&gt; MyCustomTrait&lt;'a&gt;;\n    type Tail: HList;\n\n    fn push&lt;E&gt;(self, element: E) -&gt; Element&lt;E, Self&gt;\n    where\n        E: for&lt;'a&gt; MyCustomTrait&lt;'a&gt;,\n    {\n        Element::new(element, self)\n    }\n\n    fn head(&amp;self) -&gt; &amp;Self::Head;\n\n    fn tail(&amp;self) -&gt; &amp;Self::Tail;\n\n    fn len(&amp;self) -&gt; usize {\n        Self::LEN\n    }\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Eq, Hash)]\npub struct Element&lt;H, T&gt;(H, T);\n\nimpl&lt;H, T: HList&gt; Element&lt;H, T&gt; {\n    pub fn new(head: H, tail: T) -&gt; Self {\n        Element(head, tail)\n    }\n}\n\nimpl&lt;H, T&gt; HList for Element&lt;H, T&gt;\nwhere\n    H: for&lt;'a&gt; MyCustomTrait&lt;'a&gt;,\n    T: HList,\n{\n    const LEN: usize = 1 + &lt;T as HList&gt;::LEN;\n\n    type Head = H;\n    type Tail = T;\n\n    fn head(&amp;self) -&gt; &amp;Self::Head {\n        &amp;self.0\n    }\n\n    fn tail(&amp;self) -&gt; &amp;Self::Tail {\n        &amp;self.1\n    }\n}\n\n#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Hash)]\npub struct End;\n\nimpl HList for End {\n    const LEN: usize = 0;\n\n    type Head = ();\n    type Tail = End;\n\n    fn head(&amp;self) -&gt; &amp;Self::Head {\n        &amp;()\n    }\n\n    fn tail(&amp;self) -&gt; &amp;Self::Tail {\n        &amp;End\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn artbitrary_recursive() {\n        let h = End\n            .push(0usize)\n            .push(String::from(\"Hello, World\"));\n\n        fn eval&lt;H: HList&gt;(list: &amp;H) {\n            if H::LEN &gt; 0 {\n                let head = list.head();\n                // Do work here, like print the debug representation of `head`.\n                eprintln!(\"{:?}\", head);\n\n                eval(list.tail());\n            }\n        }\n\n        eval(&amp;h);\n        assert!(false);\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 211, "user_id": 3986895, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/8ac3ee54f310a1af6998e44ffacaa4fc?s=128&d=identicon&r=PG&f=1", "display_name": "E Y", "link": "https://stackoverflow.com/users/3986895/e-y"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 79, "favorite_count": 0, "accepted_answer_id": 57752224, "answer_count": 1, "score": 2, "last_activity_date": 1567405715, "creation_date": 1567360517, "question_id": 57748291, "link": "https://stackoverflow.com/questions/57748291/how-can-i-obtain-the-individual-elements-of-a-heterogeneous-list-without-knowing", "title": "How can I obtain the individual elements of a heterogeneous list without knowing their type?", "body": "<p>Given an implementation of a heterogeneous list in <code>rust</code> (for example like the one from <code>frunk</code>), how can I obtain a reference to an element within the list without knowing the concrete type of the element? The length of the list is known statically, but cannot be hard-coded as numeric literal.</p>\n\n<p>I have tried to obtain the individual elements by popping each element off the list sequentially (as shown in the code example) and by writing an indexing method that accepts a <code>usize</code> index as argument. Neither attempts even compile. The posted example is what I would <em>like</em> to do.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait HList: Sized {\n    const LEN: usize;\n\n    type Head;\n    type Tail: HList;\n\n    fn push&lt;E&gt;(self, element: E) -&gt; Element&lt;E, Self&gt; {\n        Element { head: element, tail: self }\n    }\n\n    fn pop(self) -&gt; Option&lt;(Self::Head, Self::Tail)&gt;;\n\n    fn len(&amp;self) -&gt; usize {\n        Self::LEN\n    }\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Eq, Hash)]\npub struct Element&lt;H, T&gt; {\n    pub head: H,\n    pub tail: T,\n}\n\nimpl&lt;H, T: HList&gt; HList for Element&lt;H, T&gt; {\n    const LEN: usize = 1 + &lt;T as HList&gt;::LEN;\n\n    type Head = H;\n    type Tail = T;\n\n    fn pop(self) -&gt; Option&lt;(H, T)&gt; {\n        Some((self.head, self.tail))\n    }\n}\n\n#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Hash)]\npub struct End;\n\nimpl HList for End {\n    const LEN: usize = 0;\n\n    type Head = End;\n    type Tail = End;\n\n    fn pop(self) -&gt; Option&lt;(Self::Head, Self::Tail)&gt; {\n        None\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn pop_two_for() {\n        let h = End\n            .push(0usize)\n            .push(String::from(\"Hello, World\"));\n\n        fn eval&lt;H: HList&gt;(l: H) {\n            for _ in 0usize..H::LEN {\n                let (e, l) = l.pop().unwrap();\n                // Do work with `e`.\n            }\n        }\n\n        eval(h);\n    }\n}\n</code></pre>\n"}, {"tags": ["postgresql", "rust"], "answers": [{"tags": [], "owner": {"reputation": 84, "user_id": 12006518, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/a-/AAuE7mBGNrILhdG16KoQeOr69hoQyrIZxha1x9c8DEREdg=k-s128", "display_name": "Andrea Proone", "link": "https://stackoverflow.com/users/12006518/andrea-proone"}, "is_accepted": false, "score": 1, "last_activity_date": 1567351574, "creation_date": 1567351574, "answer_id": 57747263, "question_id": 57747246, "link": "https://stackoverflow.com/questions/57747246/diesel-rust-library-doesnt-allow-me-to-make-update-statements/57747263#57747263", "title": "Diesel (rust library) doesn&#39;t allow me to make update statements", "body": "<p>I forgot to borrow user in <code>diesel::update(user).set(profile.eq(None));</code></p>\n"}], "owner": {"reputation": 84, "user_id": 12006518, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/a-/AAuE7mBGNrILhdG16KoQeOr69hoQyrIZxha1x9c8DEREdg=k-s128", "display_name": "Andrea Proone", "link": "https://stackoverflow.com/users/12006518/andrea-proone"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 192, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1567351574, "creation_date": 1567351394, "question_id": 57747246, "link": "https://stackoverflow.com/questions/57747246/diesel-rust-library-doesnt-allow-me-to-make-update-statements", "title": "Diesel (rust library) doesn&#39;t allow me to make update statements", "body": "<p>The struct is</p>\n\n<pre><code>#[derive(Identifiable, Queryable, Debug)]\n#[table_name = \"users\"]\npub struct QueryableUser {\n    pub id: i32,\n    pub username: String,\n    pub password: String,\n    pub sex: bool,\n    pub profile: Option&lt;String&gt;,\n    pub birth: chrono::NaiveDate,\n}\n</code></pre>\n\n<p>when I try to update the struct</p>\n\n<pre><code>diesel::update(&amp;queryable_user).set(...);\n</code></pre>\n\n<p>it gives me this error</p>\n\n<pre><code>error[E0277]: the trait bound `user::QueryableUser: diesel::Identifiable` is not satisfied\n  --&gt; src\\message_handler\\set_profile.rs:36:13\n   |\n36 |             diesel::update(user).set(profile.eq(None));\n   |             ^^^^^^^^^^^^^^ the trait `diesel::Identifiable` is not implemented for `user::QueryableUser`\n   |\n   = help: the following implementations were found:\n             &lt;&amp;'ident user::QueryableUser as diesel::Identifiable&gt;\n   = note: required because of the requirements on the impl of `diesel::query_builder::IntoUpdateTarget` for `user::QueryableUser`\n   = note: required by `diesel::update`\n</code></pre>\n\n<p>It's really confusing because I derived Identifiable in my struct</p>\n"}, {"tags": ["rust", "stack", "lock-free"], "answers": [{"tags": [], "owner": {"reputation": 36, "user_id": 9519747, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2b0bba1a7b0fc49d1a345b7c5ae04725?s=128&d=identicon&r=PG&f=1", "display_name": "mciantyre", "link": "https://stackoverflow.com/users/9519747/mciantyre"}, "is_accepted": false, "score": 0, "last_activity_date": 1567458546, "creation_date": 1567458546, "answer_id": 57762687, "question_id": 57746675, "link": "https://stackoverflow.com/questions/57746675/lock-free-stack-replace-acquire-in-is-empty-with-relaxed/57762687#57762687", "title": "lock-free stack, replace Acquire in is_empty() with Relaxed", "body": "<blockquote>\n  <p>My question is: Can I replace (7)'s Acquire with 'Relaxed'? It seems that Atomicity at (7) is sufficient enough to make it work.</p>\n</blockquote>\n\n<p>Suppose we used <code>Relaxed</code> instead of <code>Acquire</code> as proposed. The <code>Release</code> at (3) does not guarantee that <code>is_empty()</code> would see the memory access of the thread calling <code>push()</code>. It might become particularly important for a consumer thread that used the Treiber stack like</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>if !my_stack.is_empty() {\n  let elem = my_stack.pop().unwrap();\n  // Do things with elem...\n} else {\n  // Do something expensive...\n}\n</code></pre>\n\n<blockquote>\n  <p>[...] the other thread will see the outcome of store eventually.</p>\n</blockquote>\n\n<p>You're correct. However, I'd like to minimize the amount of time I do expensive operations. In the above snippet, I would expect <code>is_empty()</code> and <code>pop()</code> to consistently indicate that my stack is in the same state. We lose that guarantee if the methods use different atomic orderings, and we might end up doing more expensive work just because <code>is_empty()</code> didn't synchronize yet.</p>\n\n<p>Additionally, Treiber's lock-free stack is usable in multi-consumers, multi-producer contexts. Suppose one thread is calling <code>push()</code>, a second thread is calling <code>pop()</code>, and a third thread observes the stack's state via <code>is_empty()</code>. Without an <code>Acquire</code> memory order, the third thread has no guarantee of observing the same state that the pushing or popping threads observe.</p>\n"}], "owner": {"reputation": 2337, "user_id": 930169, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/be36a036900e8c4a2d810db772e43280?s=128&d=identicon&r=PG", "display_name": "JACK M", "link": "https://stackoverflow.com/users/930169/jack-m"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 97, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1567458546, "creation_date": 1567346991, "question_id": 57746675, "link": "https://stackoverflow.com/questions/57746675/lock-free-stack-replace-acquire-in-is-empty-with-relaxed", "title": "lock-free stack, replace Acquire in is_empty() with Relaxed", "body": "<p>There is a lock-free stack <a href=\"https://github.com/crossbeam-rs/crossbeam/blob/master/crossbeam-epoch/examples/treiber_stack.rs\" rel=\"nofollow noreferrer\">here</a> based on epoch based reclamation from Crossbeam.</p>\n\n<p>I add some notes to help me understand this implementation.</p>\n\n<pre><code>#[derive(Debug)] \npub struct TreiberStack&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0head: Atomic&lt;Node&lt;T&gt;&gt;, \n} \n\n\n#[derive(Debug)] \nstruct Node&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0data: ManuallyDrop&lt;T&gt;, \n\u00a0\u00a0\u00a0\u00a0next: Atomic&lt;Node&lt;T&gt;&gt;, \n} \n\n\nimpl&lt;T&gt; TreiberStack&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0pub fn new() -&gt; TreiberStack&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0TreiberStack { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0head: Atomic::null(), \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0} \n\n\n\u00a0\u00a0\u00a0\u00a0pub fn push(&amp;self, t: T) { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let mut n = Owned::new(Node { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data: ManuallyDrop::new(t), \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0next: Atomic::null(), \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}); \n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let guard = epoch::pin(); \n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0loop { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let head = self.head.load(Relaxed, &amp;guard); \u00a0 // (1) \u2019Relaxed\u2019 only provides atomicity\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0n.next.store(head, Relaxed);  // (2) \u2018Relaxed\u2019 only provides atomicity\n        // (2) uses \u2018head\u2019 from (1). so (2) and (1)\u2019s partial order won\u2019t be rotated by CPU and compiler\n\n\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0 \u00a0 //\u00a0it seems that compare_and_set behaves just like compare_and_swap.\n\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0 \u00a0 //\u00a0It guarantees that all\n\u00a0\u00a0\u00a0\u00a0        // memory operations before the RELEASE operation will appear to happen\n\u00a0\u00a0\u00a0\u00a0        // before the RELEASE operation with respect to the other components of the system.\n       //  So (1) and (2) always execute before (3)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0match self.head.compare_and_set(head, n, Release, &amp;guard) {\u00a0  // (3)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Ok(_) =&gt; break, \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Err(e) =&gt; n = e.new, \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0} \n\n\n\n\u00a0\u00a0\u00a0\u00a0pub fn pop(&amp;self) -&gt; Option&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let guard = epoch::pin();  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0loop { \n\n\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0 \u00a0 // It guarantees that all memory\n\u00a0\u00a0\u00a0\u00a0        // operations after the ACQUIRE operation will appear to happen after the\n\u00a0\u00a0\u00a0\u00a0        // ACQUIRE operation with respect to the other components of the system.\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let head = self.head.load(Acquire, &amp;guard); \u00a0\u00a0 // (4)\n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0match unsafe { head.as_ref() } { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Some(h) =&gt; { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let next = h.next.load(Relaxed, &amp;guard); // (5) \u2019Relaxed\u2019 only provides atomicity\n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if self \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.head \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.compare_and_set(head, next, Release, &amp;guard) \u00a0 \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.is_ok() // (6)\n\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0\u00a0 \u00a0\u00a0 \u00a0 // This RELEASE matches the ACQUIRE in (4). Code between them won\u2019t be reordered by CPU and compiler\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{ \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0unsafe { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0guard.defer_destroy(head); \u00a0\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return Some(ManuallyDrop::into_inner(ptr::read(&amp;(*h).data))); \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0None =&gt; return None, \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0} \n\u00a0\u00a0\u00a0\u00a0} \n\n\n\u00a0\u00a0\u00a0\u00a0// Returns `true` if the stack is empty. \n\u00a0\u00a0\u00a0\u00a0pub fn is_empty(&amp;self) -&gt; bool { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0let guard = epoch::pin(); \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.head.load(Acquire, &amp;guard).is_null() \u00a0 // (7)\n\u00a0\u00a0\u00a0\u00a0} \n} \n\n\nimpl&lt;T&gt; Drop for TreiberStack&lt;T&gt; { \n\u00a0\u00a0\u00a0\u00a0fn drop(&amp;mut self) { \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while self.pop().is_some() {} \n\u00a0\u00a0\u00a0\u00a0} \n} \n</code></pre>\n\n<p>My question is: Can I replace (7)'s <code>Acquire</code> with 'Relaxed'? It seems that Atomicity at (7) is sufficient enough to make it work. <code>Acquire</code> is usually pairs with <code>Release</code> to provide <code>Visibility</code>:</p>\n\n<blockquote>\n  <p>after\n       an ACQUIRE on a given variable, all memory accesses preceding any prior\n       RELEASE on that same variable are guaranteed to be visible.  In other\n       words, within a given variable's critical section, all accesses of all\n       previous critical sections for that variable are guaranteed to have\n       completed. </p>\n</blockquote>\n\n<p>What role does <code>Visibility</code> play in this code? It looks like the ordering of code and atomicity is the only guarantee I need to make this code work. Without <code>Visibility</code> the other thread will see the outcome of <code>store</code> eventually. So the code still works correctly. </p>\n\n<p>I learned lock-free majorly from Linux Kernel's Doc <a href=\"https://www.kernel.org/doc/Documentation/memory-barriers.txt\" rel=\"nofollow noreferrer\">here</a></p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 44559, "user_id": 411022, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9905bf9a7b8d5a587c1bdff07ef2e801?s=128&d=identicon&r=PG", "display_name": "Ilmari Karonen", "link": "https://stackoverflow.com/users/411022/ilmari-karonen"}, "edited": false, "score": 1, "creation_date": 1567345881, "post_id": 57746448, "comment_id": 101930716, "body": "(Specifically, <code>ReadFrames&lt;&lt;Self as FrameBuffer&gt;::Frame&gt; + WriteFrames&lt;&lt;Self as FrameBuffer&gt;::Frame&gt;</code> <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=be9199a71784619716b29a6cd1c8348e\" rel=\"nofollow noreferrer\">seems to compile</a>.)"}], "owner": {"reputation": 43, "user_id": 11197688, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-CXktZD4h8bw/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rfHyWmyDJSugPB3WnouHKD-xfSCgA/mo/photo.jpg?sz=128", "display_name": "user330199", "link": "https://stackoverflow.com/users/11197688/user330199"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 52, "favorite_count": 0, "closed_date": 1567359562, "answer_count": 0, "score": 3, "last_activity_date": 1593027054, "creation_date": 1567345016, "last_edit_date": 1593027054, "question_id": 57746448, "link": "https://stackoverflow.com/questions/57746448/how-do-i-get-around-supertrait-computation-cycle", "closed_reason": "Duplicate", "title": "How do I get around supertrait computation cycle?", "body": "<p>With this code:</p>\n<pre class=\"lang-rust prettyprint-override\"><code>use std::io::Result;\n\npub trait Frame {\n    type Sample;\n}\n\npub trait WriteFrames&lt;F: Frame&gt; {\n    fn write_frames(&amp;mut self, frames: &amp;[F]) -&gt; Result&lt;usize&gt;;\n}\n\npub trait ReadFrames&lt;F: Frame&gt; {\n    fn read_frames(&amp;mut self, frames: &amp;mut [F]) -&gt; Result&lt;usize&gt;;\n}\n\npub trait FrameBuffer: ReadFrames&lt;Self::Frame&gt; + WriteFrames&lt;Self::Frame&gt; {\n    type Frame: Frame;\n}\n</code></pre>\n<p>I get this error:</p>\n<pre><code>   Compiling playground v0.0.1 (/playground)\nerror[E0391]: cycle detected when computing the supertraits of `FrameBuffer`\n  --&gt; src/lib.rs:15:1\n   |\n15 | pub trait FrameBuffer: ReadFrames&lt;Self::Frame&gt; + WriteFrames&lt;Self::Frame&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   |\n   = note: ...which again requires computing the supertraits of `FrameBuffer`, completing the cycle\nnote: cycle used when collecting item types in top-level module\n  --&gt; src/lib.rs:15:1\n   |\n15 | pub trait FrameBuffer: ReadFrames&lt;Self::Frame&gt; + WriteFrames&lt;Self::Frame&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0391`.\nerror: Could not compile `playground`.\n\nTo learn more, run the command again with --verbose.\n</code></pre>\n<p>How should I model my code to get around this error?</p>\n<p>I want to have a <code>FrameBuffer</code> trait that specified a <code>Frame</code> type, and requires <code>WriteFrames</code> and <code>ReadFrames</code> for that <code>Frame</code> type.</p>\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f6cc9a150e0c3be057a20cb931bc691d\" rel=\"nofollow noreferrer\">Playground link</a></p>\n"}, {"tags": ["linux", "rust", "redhat", "glibc"], "answers": [{"comments": [{"owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 0, "creation_date": 1567342256, "post_id": 57745334, "comment_id": 101930007, "body": "Yes, this is about getting Rust to work on RHEL. Unfortunately I am not able to get Rust Toolset. Is there another way around? Can I avoid using <code>GLIBC_2.18</code> by downgrading my Rust?"}, {"owner": {"reputation": 26934, "user_id": 8316315, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44d833a8a46fea39d7bfca1540ea9c07?s=128&d=identicon&r=PG&f=1", "display_name": "Florian Weimer", "link": "https://stackoverflow.com/users/8316315/florian-weimer"}, "reply_to_user": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 1, "creation_date": 1567343435, "post_id": 57745334, "comment_id": 101930235, "body": "Isn&#39;t Rust Toolset part of the free developer subscription? Or is the problem that you cannot install any RPM packages on the host?"}, {"owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 0, "creation_date": 1567343510, "post_id": 57745334, "comment_id": 101930246, "body": "The rust dev toolset is not blessed by my admin. I can&#39;t install it. Need to find a way to work around."}, {"owner": {"reputation": 26934, "user_id": 8316315, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44d833a8a46fea39d7bfca1540ea9c07?s=128&d=identicon&r=PG&f=1", "display_name": "Florian Weimer", "link": "https://stackoverflow.com/users/8316315/florian-weimer"}, "reply_to_user": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 0, "creation_date": 1567343724, "post_id": 57745334, "comment_id": 101930282, "body": "You need to work with your administrator towards a solution. Rust Toolset <i>is</i> the proper way to install the Rust compiler on Red Hat Enterprise Linux."}, {"owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 1, "creation_date": 1567343849, "post_id": 57745334, "comment_id": 101930304, "body": "But I don&#39;t need a rust compiler. I can cross-compile on another machine and ship the binary to RHEL. I just have missing libraries. <code>GLIBC_2.18</code> is not available on RHEL7 (<a href=\"https://access.redhat.com/solutions/3643072\" rel=\"nofollow noreferrer\">access.redhat.com/solutions/3643072</a>), so I am looking for a way to downgrade my Rust cross-compiler."}, {"owner": {"reputation": 26934, "user_id": 8316315, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44d833a8a46fea39d7bfca1540ea9c07?s=128&d=identicon&r=PG&f=1", "display_name": "Florian Weimer", "link": "https://stackoverflow.com/users/8316315/florian-weimer"}, "reply_to_user": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "edited": false, "score": 0, "creation_date": 1567344153, "post_id": 57745334, "comment_id": 101930356, "body": "The Rust compiler in Rust Toolset will produce compatible binaries. Just use that. Install Red Hat Enterprise Linux in a VM, or talk to your administrator to provide it to you."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 1, "creation_date": 1567410150, "post_id": 57745334, "comment_id": 101942907, "body": "New question as a follow up of these comments: <a href=\"https://stackoverflow.com/questions/57749127/how-can-i-specify-the-glibc-version-in-cargo-build-for-rust\">How can I specify the GLIBC version in cargo build for Rust?</a>."}], "tags": [], "owner": {"reputation": 26934, "user_id": 8316315, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44d833a8a46fea39d7bfca1540ea9c07?s=128&d=identicon&r=PG&f=1", "display_name": "Florian Weimer", "link": "https://stackoverflow.com/users/8316315/florian-weimer"}, "is_accepted": false, "score": 2, "last_activity_date": 1567334967, "creation_date": 1567334967, "answer_id": 57745334, "question_id": 57743479, "link": "https://stackoverflow.com/questions/57743479/how-to-find-which-part-of-my-rust-project-uses-glibc-2-18/57745334#57745334", "title": "How to find which part of my Rust project uses GLIBC 2.18", "body": "<p>To see which symbols reference <code>GLIBC_2.18</code>, you can use <code>eu-readelf</code>:</p>\n\n<pre><code>$ eu-readelf -s /usr/bin/cargo  | grep -F @GLIBC_2.18\n  157: 0000000000000000      0 FUNC    WEAK   DEFAULT    UNDEF __cxa_thread_atexit_impl@GLIBC_2.18 (19)\n</code></pre>\n\n<p>This symbol is used by the Rust runtime itself to implement destructors (the <code>Drop</code> trait) for TLS variables.</p>\n\n<p>If this is about getting Rust to work on Red Hat Enterprise Linux, you should be using <a href=\"https://access.redhat.com/documentation/en-us/red_hat_developer_tools/2019.3/html/using_rust_toolset/index\" rel=\"nofollow noreferrer\">Rust Toolset</a>. It is regularly rebased against the latest upstream version, so its Rust version is fairly current most of the time.</p>\n"}], "owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 695, "favorite_count": 0, "answer_count": 1, "score": 3, "last_activity_date": 1567334967, "creation_date": 1567316248, "question_id": 57743479, "link": "https://stackoverflow.com/questions/57743479/how-to-find-which-part-of-my-rust-project-uses-glibc-2-18", "title": "How to find which part of my Rust project uses GLIBC 2.18", "body": "<p>With <code>cargo-tree</code>, I can see my project depends on <code>libc v0.2.62</code></p>\n\n<pre><code>$ cargo tree -p libc -i | grep libc\nlibc v0.2.62\n</code></pre>\n\n<p>But it actually requires two versions <code>GLIB_2.14</code> and <code>GLIBC2.18</code>. \n<code>ldd</code> error messages are as follows:</p>\n\n<pre><code>/lib64/libc.so.6: version `GLIBC_2.18' not found\n/lib64/libc.so.6: version `GLIBC_2.14' not found\n</code></pre>\n\n<p>I am able to get <code>GLIBC_2.14</code> but not <code>GLIBC_2.18</code>. So I plan to switch to older versions of Rust or some crates I use. I need to find out which one depends on <code>GLIBC_2.18</code> first. Can anyone help me?</p>\n"}, {"tags": ["rust", "borrow-checker"], "comments": [{"owner": {"reputation": 10506, "user_id": 5520354, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/QgGFm.jpg?s=128&g=1", "display_name": "C14L", "link": "https://stackoverflow.com/users/5520354/c14l"}, "edited": false, "score": 1, "creation_date": 1567329710, "post_id": 57743044, "comment_id": 101927668, "body": "If you wrap the last two lines in a <code>while false { *y += 1; println!(&quot;{}&quot;, x); }</code> you get the expected error. Because now Rust can&#39;t predict anymore, if it can safely drop the mutable reference."}], "owner": {"reputation": 36788, "user_id": 272520, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/SDKM1.jpg?s=128&g=1", "display_name": "Mark Hildreth", "link": "https://stackoverflow.com/users/272520/mark-hildreth"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 54, "favorite_count": 0, "closed_date": 1567310249, "answer_count": 0, "score": 1, "last_activity_date": 1567309430, "creation_date": 1567309430, "question_id": 57743044, "link": "https://stackoverflow.com/questions/57743044/what-changed-in-rust-that-allows-this-borrow-after-a-mutable-borrow", "closed_reason": "Duplicate", "title": "What changed in Rust that allows this borrow after a mutable borrow?", "body": "<p>In reading <a href=\"https://www.packtpub.com/application-development/hands-concurrency-rust\" rel=\"nofollow noreferrer\">Hands-On Concurrency with Rust</a>, I came across an example which is similar to an example that was shown in the <a href=\"https://doc.rust-lang.org/1.8.0/book/references-and-borrowing.html#mut-references\" rel=\"nofollow noreferrer\">old Rust book</a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let mut x = 5;\n    let y = &amp;mut x;\n    *y += 1;\n    println!(\"{}\", x);\n}\n</code></pre>\n\n<p>In both books, they explain that this would not compile. Both books say that the <code>println!</code> macro is implicitly borrowing from <code>x</code>. The old Rust book said the following:</p>\n\n<blockquote>\n  <p>We have a &amp;mut T pointing to x, and so we aren\u2019t allowed to create any\n  &amp;Ts</p>\n</blockquote>\n\n<p>\"Hands-On Concurrency\" added this:</p>\n\n<blockquote>\n  <p>Were this program to compile, we would be subject to a race between\n  the update of y and the read of x, depending on the CPU and memory\n  ordering.</p>\n</blockquote>\n\n<p>Both of these explanations seem to make sense, however if I compile and run this code on the latest versions of Rust stable (both 1.36 and 1.37) the code compiles and runs fine.</p>\n\n<p>What has changed in Rust that allows this to compile while still avoiding the potential issues that caused older versions of Rust to produce compiler errors?</p>\n"}, {"tags": ["rust", "cross-compiling", "rust-cargo"], "comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 1, "creation_date": 1567335350, "post_id": 57742368, "comment_id": 101928748, "body": "Actually, the <code>lib{ssl,crypto}.so.6</code> are quite older than the <code>*.so.1.0.0</code> counterparts. My guess is that your compiler system is much more modern than the target system. If you cannot upgrade the target maybe you can downgrade the cross-compiler?"}], "answers": [{"tags": [], "owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "is_accepted": true, "score": 1, "last_activity_date": 1567374000, "creation_date": 1567374000, "answer_id": 57749689, "question_id": 57742368, "link": "https://stackoverflow.com/questions/57742368/alternative-solutions-to-missing-shared-libraries-after-cross-compilation/57749689#57749689", "title": "Alternative solutions to missing shared libraries after cross compilation?", "body": "<p>According to <a href=\"https://access.redhat.com/solutions/3643072\" rel=\"nofollow noreferrer\">this</a>, <code>GLIBC_2.18</code> can't be installed to <code>RHEL7</code>. I gave up dynamically linked libraries.</p>\n\n<p>This <a href=\"https://github.com/sfackler/rust-openssl/issues/980\" rel=\"nofollow noreferrer\">post</a> helped me out. The solution is:</p>\n\n<pre><code>[dependencies]\nnats = \"*\"\nprotobuf = { version = \"~2.0\" }\n# Add openssl-sys as a direct dependency so it can be cross compiled to\n# x86_64-unknown-linux-musl using the \"vendored\" feature below\nopenssl-sys = \"*\"\n\n[features]\n# Force openssl-sys to staticly link in the openssl library. Necessary when\n# cross compiling to x86_64-unknown-linux-musl.\nvendored = [\"openssl-sys/vendored\"]\n</code></pre>\n\n<p>This way I can compile to a single executable with no library dependencies using:</p>\n\n<pre><code>cargo build --target=x86_64-unknown-linux-musl --features vendored\n</code></pre>\n"}], "owner": {"reputation": 1589, "user_id": 5380414, "user_type": "registered", "accept_rate": 56, "profile_image": "https://i.stack.imgur.com/FGXKX.jpg?s=128&g=1", "display_name": "Yixing Liu", "link": "https://stackoverflow.com/users/5380414/yixing-liu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 349, "favorite_count": 0, "accepted_answer_id": 57749689, "answer_count": 1, "score": 0, "last_activity_date": 1568811501, "creation_date": 1567296453, "last_edit_date": 1568811501, "question_id": 57742368, "link": "https://stackoverflow.com/questions/57742368/alternative-solutions-to-missing-shared-libraries-after-cross-compilation", "title": "Alternative solutions to missing shared libraries after cross compilation?", "body": "<p>I first cross compile my Rust project to linux target</p>\n\n<pre><code>cargo build --target x86_64-unknown-linux-gnu\n</code></pre>\n\n<p>Then run <code>ldd</code> on my local ubuntu and the linker works fine.</p>\n\n<pre><code>linux-vdso.so.1 (0x00007fffddc62000)\nlibssl.so.1.0.0 =&gt; /usr/lib/x86_64-linux-gnu/libssl.so.1.0.0 (0x00007f6d34500000)\nlibcrypto.so.1.0.0 =&gt; /usr/lib/x86_64-linux-gnu/libcrypto.so.1.0.0 (0x00007f6d340b0000)\nlibdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f6d33ea0000)\nlibrt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f6d33c90000)\nlibpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f6d33a70000)\n        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f6d33850000)\nlibc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f6d33440000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f6d35a00000)\nlibm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f6d330a0000)\n</code></pre>\n\n<p>But on my target os, <code>ldd</code> fails to find the libraries</p>\n\n<pre><code>libssl.so.1.0.0 =&gt; not found\nlibcrypto.so.1.0.0 =&gt; not found\n/lib64/libc.so.6 =&gt; version `GLIBC_2.18' not found\n</code></pre>\n\n<p>Actually I have <code>libssl.so.10</code> and <code>libcrypto.so.10</code> installed under <code>LD_LIBRARY_PATH</code>. Unfortunately I am not able to install shared libraries of version <code>1.0.0</code> required by Rust.</p>\n\n<p>I have read <a href=\"https://github.com/japaric/rust-cross\" rel=\"nofollow noreferrer\">Rust Cross</a> and the recommended solution is to install the missing shared libraries. Unfortunately that's not possible for me. So I am looking for alternative solutions to missing libraries. </p>\n\n<p><code>libssl.so.1.0.0</code> and <code>libcrypto.so.1.0.0</code> sound ancient. How can I tell <code>cargo</code> to use a later version?</p>\n\n<p>How can I deal with <code>/lib64/libc.so.6 =&gt; version GLIBC_2.18 not found</code>?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 765, "user_id": 7246614, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/83eccd212e4687fc66e13aad21796b0b?s=128&d=identicon&r=PG", "display_name": "timotree", "link": "https://stackoverflow.com/users/7246614/timotree"}, "edited": false, "score": 0, "creation_date": 1567349975, "post_id": 57741820, "comment_id": 101931641, "body": "I know this may seem like an overly simple question, but I actually did spend like 10 minutes searching for this because I assumed the default was round towards nearest even."}], "answers": [{"comments": [{"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567411663, "post_id": 57741821, "comment_id": 101943505, "body": "Mark this as an answer, so it disappears from the list of unanswered questions, thanks!"}], "tags": [], "owner": {"reputation": 765, "user_id": 7246614, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/83eccd212e4687fc66e13aad21796b0b?s=128&d=identicon&r=PG", "display_name": "timotree", "link": "https://stackoverflow.com/users/7246614/timotree"}, "is_accepted": true, "score": 2, "last_activity_date": 1567411613, "last_edit_date": 1567411613, "creation_date": 1567288481, "answer_id": 57741821, "question_id": 57741820, "link": "https://stackoverflow.com/questions/57741820/how-to-get-the-floored-quotient-of-two-integers/57741821#57741821", "title": "How to get the floored quotient of two integers?", "body": "<p><a href=\"https://doc.rust-lang.org/std/primitive.i32.html#impl-Div%3Ci32%3E\" rel=\"nofollow noreferrer\">impl Div&lt;i32&gt; for i32</a> documentation says:</p>\n\n<blockquote>\n  <p>This operation rounds towards zero, truncating any fractional part of the exact result.</p>\n</blockquote>\n\n<p>It applies to all integer types:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>macro_rules! div_impl_integer {\n    ($($t:ty)*) =&gt; ($(\n        /// This operation rounds towards zero, truncating any\n        /// fractional part of the exact result.\n        #[stable(feature = \"rust1\", since = \"1.0.0\")]\n        impl Div for $t {\n            type Output = $t;\n\n            #[inline]\n            fn div(self, other: $t) -&gt; $t { self / other }\n        }\n\n        forward_ref_binop! { impl Div, div for $t, $t }\n    )*)\n}\n\ndiv_impl_integer! { usize u8 u16 u32 u64 u128 isize i8 i16 i32 i64 i128 }\n</code></pre>\n\n<p>Therefore, all you need to do is divide normally.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>assert_eq!(3/2, 1);\nassert_eq!(9/4, 2);\n</code></pre>\n"}], "owner": {"reputation": 765, "user_id": 7246614, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/83eccd212e4687fc66e13aad21796b0b?s=128&d=identicon&r=PG", "display_name": "timotree", "link": "https://stackoverflow.com/users/7246614/timotree"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 67, "favorite_count": 0, "accepted_answer_id": 57741821, "answer_count": 1, "score": 0, "last_activity_date": 1567411613, "creation_date": 1567288481, "question_id": 57741820, "link": "https://stackoverflow.com/questions/57741820/how-to-get-the-floored-quotient-of-two-integers", "title": "How to get the floored quotient of two integers?", "body": "<p>I have two <code>u64</code>s and I would like to divide them and take the floor of the result. (Since these are unsigned, floor and round towards zero is the same.)</p>\n\n<p>How can I do this?</p>\n"}, {"tags": ["regex", "rust"], "answers": [{"comments": [{"owner": {"reputation": 1338, "user_id": 1306877, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fUlRo.jpg?s=128&g=1", "display_name": "tlo", "link": "https://stackoverflow.com/users/1306877/tlo"}, "edited": false, "score": 3, "creation_date": 1567283545, "post_id": 57741383, "comment_id": 101921866, "body": "I&#39;m a little bit embarrassed now... \ud83d\ude33 Thanks a lot!"}], "tags": [], "owner": {"reputation": 10100, "user_id": 619216, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/c07104de771c3b6f6c30be8f592ef8f7?s=128&d=identicon&r=PG", "display_name": "BurntSushi5", "link": "https://stackoverflow.com/users/619216/burntsushi5"}, "is_accepted": true, "score": 10, "last_activity_date": 1567283179, "creation_date": 1567283179, "answer_id": 57741383, "question_id": 57741244, "link": "https://stackoverflow.com/questions/57741244/how-to-count-regex-matches-in-rust/57741383#57741383", "title": "How to count regex matches in Rust?", "body": "<p>You already have the iterator, so just count the number of elements in the iterator:</p>\n\n<pre><code>re.find_iter(\"This is foo and FOO foo as well as FoO.\").count()\n</code></pre>\n"}], "owner": {"reputation": 1338, "user_id": 1306877, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/fUlRo.jpg?s=128&g=1", "display_name": "tlo", "link": "https://stackoverflow.com/users/1306877/tlo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 615, "favorite_count": 0, "accepted_answer_id": 57741383, "answer_count": 1, "score": 6, "last_activity_date": 1567283525, "creation_date": 1567281538, "last_edit_date": 1567283525, "question_id": 57741244, "link": "https://stackoverflow.com/questions/57741244/how-to-count-regex-matches-in-rust", "title": "How to count regex matches in Rust?", "body": "<p>I'd like to count the matches of a regex in a string with Rust. I managed to  print all matches:</p>\n\n<pre><code>let re = Regex::new(r\"(?i)foo\").unwrap();\nlet result = re.find_iter(\"This is foo and FOO foo as well as FoO.\");\nfor i in result {\n    println!(\"{}\", i.as_str())\n}\n</code></pre>\n\n<p>But I fail to simply get the number of matches. I can't find any function that gives me the count. I also tried <code>size_hint()</code>, but that does not work as well. Any way I can do that?</p>\n\n<p><a href=\"https://www.rosettacode.org/wiki/Count_occurrences_of_a_substring#Using_Regular_Expressions\" rel=\"noreferrer\">Here</a> is the Scala version of what I'm looking for.</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1567270958, "post_id": 57739841, "comment_id": 101919133, "body": "C will surely <i>not</i> let you multiply a pointer by an integer."}, {"owner": {"reputation": 1476, "user_id": 9383219, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/97fabe5d903589acb1dfdf17fe4e405e?s=128&d=identicon&r=PG&f=1", "display_name": "cyclaminist", "link": "https://stackoverflow.com/users/9383219/cyclaminist"}, "edited": false, "score": 0, "creation_date": 1567302712, "post_id": 57739841, "comment_id": 101924171, "body": "Yeah, GCC throws an error for that code unless I add a cast: <code>int var = 5; int newvar = (int) &amp;var * 4;</code>."}], "tags": [], "owner": {"reputation": 2427, "user_id": 4983398, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fbc9ed33d775a17d6965fd2efbfe4b52?s=128&d=identicon&r=PG", "display_name": "Gardener", "link": "https://stackoverflow.com/users/4983398/gardener"}, "is_accepted": false, "score": 2, "last_activity_date": 1616856534, "last_edit_date": 1616856534, "creation_date": 1567269298, "answer_id": 57739841, "question_id": 57739755, "link": "https://stackoverflow.com/questions/57739755/how-could-rust-multiply-i32-with-i32/57739841#57739841", "title": "How could rust multiply &amp;i32 with i32?", "body": "<p>I think you may be confusing <code>&amp;i32</code> from rust with <code>&amp;var</code> from C.</p>\n<p>In C,</p>\n<pre><code>int var = 5;\nint newvar = &amp;var * 4;  /* this would be bad code, \n                           should not multiply an address by an integer!\n                           Of course, C will let you. */\n</code></pre>\n<p>the '&amp;' operator returns the address of the variable 'var'.</p>\n<p>However, in rust, the '&amp;' operator borrows use of the variable var.</p>\n<p>In Rust,</p>\n<pre><code>let var: i32 = 5;\nassert_eq!(&amp;var * 8, 40);\n</code></pre>\n<p>This works, because <code>&amp;var</code> refers to <code>5</code>, not to the address of <code>var</code>.  Note that in C, the <code>&amp;</code> is an operator.  In Rust, the <code>&amp;</code> is acting as part of the type of the variable.  Hence, the type is <code>&amp;i32</code>.</p>\n<p>This is very confusing.  If there were more characters left on standard keyboard, i am sure the designers would have used a different one.</p>\n<p>Please see the <a href=\"https://doc.rust-lang.org/stable/book/ch04-02-references-and-borrowing.html\" rel=\"nofollow noreferrer\">book</a> and carefully follow the diagrams.  The examples in the book use String, which is allocated on the heap.  Primitives, like <code>i32</code> are normally allocated on the stack and may be completely optimized away by the compiler.  Also, primitives are frequently copied even when reference notation is used, so that gets confusing.  Still, I think it is easier to look at the heap examples using String first and then to consider how this would apply to primitives.  The logic is the same, but the actual storage and optimization my be different.</p>\n"}, {"comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1567269895, "post_id": 57739873, "comment_id": 101918879, "body": "This is not universally true. In some situations, references are in fact automatically dereferenced; in some others it&#39;s not done by the language but by a library feature (like an impl for reference types); in yet other cases, references are not automatically dereferenced."}], "tags": [], "owner": {"reputation": 1552, "user_id": 3145469, "user_type": "registered", "accept_rate": 40, "profile_image": "https://www.gravatar.com/avatar/40ef74077e497553ad7a6ce20a1fc38b?s=128&d=identicon&r=PG&f=1", "display_name": "MrMobster", "link": "https://stackoverflow.com/users/3145469/mrmobster"}, "is_accepted": false, "score": -1, "last_activity_date": 1567269546, "creation_date": 1567269546, "answer_id": 57739873, "question_id": 57739755, "link": "https://stackoverflow.com/questions/57739755/how-could-rust-multiply-i32-with-i32/57739873#57739873", "title": "How could rust multiply &amp;i32 with i32?", "body": "<p>It\u2019s very simple actually: Rust will automatically dereference references for you. It\u2019s not like C where you have to dereference a pointer yourself. Rust references are very similar to C++ references in this regard. </p>\n"}, {"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 11, "last_activity_date": 1567334921, "last_edit_date": 1567334921, "creation_date": 1567269807, "answer_id": 57739913, "question_id": 57739755, "link": "https://stackoverflow.com/questions/57739755/how-could-rust-multiply-i32-with-i32/57739913#57739913", "title": "How could rust multiply &amp;i32 with i32?", "body": "<blockquote>\n  <p>Did the compiler implement the operation between <code>&amp;i32</code> and <code>i32</code>?</p>\n</blockquote>\n\n<p>Yes. Well, not the compiler, but rather the standard library. You can see the impl <a href=\"https://doc.rust-lang.org/stable/std/ops/trait.Mul.html#impl-Mul%3C%26%27_%20i32%3E\" rel=\"nofollow noreferrer\">in the documentation</a>.</p>\n\n<blockquote>\n  <p>If yes, how is this operation justified in such a type safe language?</p>\n</blockquote>\n\n<p>\"Type safe\" is not a Boolean property, but rather a spectrum. Most C++ programmers would say that C++ is type safe. Yet, C++ has many features that automatically cast between types (constructors, <code>operator T</code>, taking references of values, ...). When designing a programming language, one has to balance the risk of bugs (when introducing convenient type conversions) with the inconvenience (when not having them). </p>\n\n<p>As an extreme example: consider if <code>Option&lt;T&gt;</code> would deref to <code>T</code> and panic if it was <code>None</code>. That's the behavior of most languages that have <code>null</code>. I think it's pretty clear that this \"feature\" has led to numerous bugs in the real world (search term \"billion dollar mistake\"). On the other hand, let's consider what bugs could be caused by having <code>&amp;i32 * i32</code> compile. I honestly can't think of any. <em>Maaaybe</em> someone wanted to multiply the raw pointer of one value with an integer? Rather unlikely in Rust. So since the chance of introducing bugs with this feature is very low, but it is convenient, it was decided to be implemented. </p>\n\n<p>This is always something the designers have to balance. Different languages are in a different position on this spectrum. Rust would likely be considered \"more typesafe\" than C++, but not doubt, there are even \"more typesafe\" languages than Rust out there. In this context, \"more typesafe\" just meant: decisions leaned more towards \"inconvenience instead of potential bugs\".</p>\n"}], "owner": {"reputation": 1769, "user_id": 3151330, "user_type": "registered", "accept_rate": 63, "profile_image": "https://i.stack.imgur.com/osBeZ.jpg?s=128&g=1", "display_name": "manikawnth", "link": "https://stackoverflow.com/users/3151330/manikawnth"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1020, "favorite_count": 0, "accepted_answer_id": 57739913, "answer_count": 3, "score": 4, "last_activity_date": 1616856534, "creation_date": 1567268668, "last_edit_date": 1567269230, "question_id": 57739755, "link": "https://stackoverflow.com/questions/57739755/how-could-rust-multiply-i32-with-i32", "title": "How could rust multiply &amp;i32 with i32?", "body": "<p>Consider this example:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let v: Vec&lt;i32&gt; = vec![1, 2, 3, 4, 5];\n    let b: i32 = (&amp;v[2]) * 4.0;\n    println!(\"product of third value with 4 is {}\", b);\n}\n</code></pre>\n\n<p>This fails as expected as <code>float</code> can't be multiplied with <code>&amp;i32</code>.</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: cannot multiply `{float}` to `&amp;i32`\n --&gt; src\\main.rs:3:23\n  |\n3 |   let b: i32 = (&amp;v[2]) * 4.0;\n  |                        ^ no implementation for `&amp;i32 * {float}`\n  |\n  = help: the trait `std::ops::Mul&lt;{float}&gt;` is not implemented for `&amp;i32`\n</code></pre>\n\n<p>But when I change the float to int, it works fine.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main() {\n    let v: Vec&lt;i32&gt; = vec![1, 2, 3, 4, 5];\n    let b: i32 = (&amp;v[2]) * 4;\n    println!(\"product of third value with 4 is {}\", b);\n}\n</code></pre>\n\n<p>Did the compiler implement the operation between <code>&amp;i32</code> and <code>i32</code>?\nIf yes, how is this operation justified in such a type safe language?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 2692, "user_id": 625791, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/996a20b9eae1def21e8db462e9bf1cf7?s=128&d=identicon&r=PG", "display_name": "theduke", "link": "https://stackoverflow.com/users/625791/theduke"}, "edited": false, "score": 1, "creation_date": 1567262101, "post_id": 57738854, "comment_id": 101916962, "body": "The problem is that rusqlite::Rows references the liftime of the Statement which you create by <code>.prepare()</code> and then immediately discard. This works if you only keep working with the query rows inside the same function, but not if you try to return it. One solution would be to construct the statement outside the function and pass it in as a parameter."}, {"owner": {"reputation": 21, "user_id": 12003327, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-N6C-k5kCHAk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdSqI6aXR5BJVAmoy19bx_JHf5FSA/photo.jpg?sz=128", "display_name": "tcn", "link": "https://stackoverflow.com/users/12003327/tcn"}, "reply_to_user": {"reputation": 2692, "user_id": 625791, "user_type": "registered", "accept_rate": 53, "profile_image": "https://www.gravatar.com/avatar/996a20b9eae1def21e8db462e9bf1cf7?s=128&d=identicon&r=PG", "display_name": "theduke", "link": "https://stackoverflow.com/users/625791/theduke"}, "edited": false, "score": 0, "creation_date": 1567525185, "post_id": 57738854, "comment_id": 101984964, "body": "If anyone else runs into this problem before someone provides a suitable answer, the <code>sqlite</code> crate has a nice <code>sqlite::Cursor</code> type that is nice and easy to wrap and provide and iterator for."}], "owner": {"reputation": 21, "user_id": 12003327, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-N6C-k5kCHAk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdSqI6aXR5BJVAmoy19bx_JHf5FSA/photo.jpg?sz=128", "display_name": "tcn", "link": "https://stackoverflow.com/users/12003327/tcn"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 146, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1567261677, "creation_date": 1567261677, "question_id": 57738854, "link": "https://stackoverflow.com/questions/57738854/boxing-a-rusqlite-rows-iterator", "title": "Boxing a rusqlite Rows iterator", "body": "<p>I am having trouble figuring out how to return an Iterator (<code>impl</code> or <code>Box</code>) when using <code>prepare</code> and <code>query</code>.</p>\n\n<p>Here is what I have tried:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn foo&lt;'a&gt;(\n    conn: &amp;'a mut rusqlite::Connection\n) -&gt; Box&lt;impl 'a + fallible_streaming_iterator::FallibleStreamingIterator&lt;Item=rusqlite::Row&lt;'a&gt;&gt;&gt; {\n    Box::new(\n        conn\n            .prepare(\"SELECT a, b FROM t\")\n            .unwrap()\n            .query(rusqlite::NO_PARAMS)\n            .unwrap()\n    )\n}\n</code></pre>\n\n<p>The problem is the prepared statement is a temporary variable owned by the function scope. (<code>error[E0515]: cannot return value referencing temporary value</code>).</p>\n"}, {"tags": ["module", "rust", "traits"], "answers": [{"tags": [], "owner": {"reputation": 9958, "user_id": 2188562, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/DMWEc.png?s=128&g=1", "display_name": "Peter Varo", "link": "https://stackoverflow.com/users/2188562/peter-varo"}, "is_accepted": true, "score": 4, "last_activity_date": 1567246403, "last_edit_date": 1567246403, "creation_date": 1567244863, "answer_id": 57736922, "question_id": 57735610, "link": "https://stackoverflow.com/questions/57735610/how-to-split-an-implementation-of-a-trait-into-multiple-files/57736922#57736922", "title": "How to split an implementation of a trait into multiple files?", "body": "<p>Although you can have multiple <code>impl</code> blocks for the same <em>object</em>, you can't have two which are exactly the same, hence the error of <em>conflicting implementations</em> indicated by <a href=\"https://doc.rust-lang.org/error-index.html#E0119\" rel=\"nofollow noreferrer\"><code>E0119</code></a>:</p>\n\n<blockquote>\n  <p>Since a trait cannot be implemented multiple times, this is an error.</p>\n</blockquote>\n\n<p>(If the trait could be <em>specialised</em> because it takes any number of generic type arguments the situation would be very much different because every specialisation would be a different <code>impl</code> block.  However even then you wouldn't be able to have the same specialisation implemented more than once.)</p>\n\n<p>If you would like to split the <em>functionality</em> into separate files, you could do that, but in a slightly different way than you originally thought.  You could split the <code>Client</code>'s <code>impl</code> block instead of the <code>Handler</code> implementation as the following minimal and compilable example  demonstrates.  (Try it in the <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1ccfeae4fc3ea1a393244cd204cbbb39\" rel=\"nofollow noreferrer\">playground</a>!)</p>\n\n<p>As you can see, the <code>Handler</code> trait is implemented for <code>Client</code> in one place, but all the implementations of <code>Client</code> are split into multiple files/modules and the <code>Handler</code> implementation is just <em>referencing</em> those:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>mod handler\n{\n    pub type Result&lt;T&gt; = ::std::result::Result&lt;T, HandlerError&gt;;\n\n    pub struct HandlerError;\n\n    pub trait Handler\n    {\n        fn on_open(&amp;mut self, h: usize) -&gt; Result&lt;()&gt;;\n        fn on_message(&amp;mut self, m: bool) -&gt; Result&lt;()&gt;;\n    }\n}\n\nmod client\n{\n    use super::handler::{ self, Handler };\n\n    struct Client\n    {\n        h: usize,\n        m: bool,\n    }\n\n    impl Handler for Client\n    {\n        fn on_open(&amp;mut self, h: usize) -&gt; handler::Result&lt;()&gt;\n        {\n            self.handle_on_open(h)\n        }\n\n        fn on_message(&amp;mut self, m: bool) -&gt; handler::Result&lt;()&gt;\n        {\n            self.handle_on_message(m)\n        }\n    }\n\n    mod open\n    {\n        use super::super::handler;\n        use super::Client;\n\n        impl Client\n        {\n            pub fn handle_on_open(&amp;mut self, h: usize) -&gt; handler::Result&lt;()&gt;\n            {\n                self.h = h;\n                Ok(())\n            }\n        }\n    }\n\n    mod message\n    {\n        use super::super::handler;\n        use super::Client;\n\n        impl Client\n        {\n            pub fn handle_on_message(&amp;mut self, m: bool) -&gt; handler::Result&lt;()&gt;\n            {\n                self.m = m;\n                Ok(())\n            }\n        }\n    }\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 15416, "user_id": 2441637, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/Z8fpp.jpg?s=128&g=1", "display_name": "Hasan A Yousef", "link": "https://stackoverflow.com/users/2441637/hasan-a-yousef"}, "is_accepted": false, "score": 0, "last_activity_date": 1567249304, "creation_date": 1567249304, "answer_id": 57737445, "question_id": 57735610, "link": "https://stackoverflow.com/questions/57735610/how-to-split-an-implementation-of-a-trait-into-multiple-files/57737445#57737445", "title": "How to split an implementation of a trait into multiple files?", "body": "<p>Thanks for @Peter's answer, I re-wrote my code as below, and it is working fine:\n<code>socket.rs</code></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use ws::Handler;\nuse crate::models::client::Client;\nuse ws::{Message, Request, Response, Result, CloseCode, Handshake};\n\nimpl Handler for Client {\n    fn on_open(&amp;mut self, hs: Handshake) -&gt; Result&lt;()&gt; {\n        self.handle_on_open(hs)\n    }\n\n    fn on_message(&amp;mut self, msg: Message) -&gt; Result&lt;()&gt; {\n        self.handle_on_message(msg)\n    }\n\n    fn on_close(&amp;mut self, code: CloseCode, reason: &amp;str) {\n        self.handle_on_close(code, reason)\n    }\n\n    fn on_request(&amp;mut self, req: &amp;Request) -&gt; Result&lt;(Response)&gt; {\n        self.handle_on_request(req)\n    }\n}\n</code></pre>\n\n<p><code>sockets/on_open.rs</code></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use crate::models::client::Client;\n\nuse crate::CLIENTS;\nuse crate::models::{truck::Truck};\nuse ws::{Result, Handshake};\n\nimpl Client {\n    pub fn handle_on_open(&amp;mut self, _: Handshake) -&gt; Result&lt;()&gt; {\n        println!(\"socket is opened\");\n        Ok(())\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 15416, "user_id": 2441637, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/Z8fpp.jpg?s=128&g=1", "display_name": "Hasan A Yousef", "link": "https://stackoverflow.com/users/2441637/hasan-a-yousef"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 754, "favorite_count": 1, "accepted_answer_id": 57736922, "answer_count": 2, "score": 2, "last_activity_date": 1567249304, "creation_date": 1567231772, "last_edit_date": 1567246735, "question_id": 57735610, "link": "https://stackoverflow.com/questions/57735610/how-to-split-an-implementation-of-a-trait-into-multiple-files", "title": "How to split an implementation of a trait into multiple files?", "body": "<p>I started working with <a href=\"https://crates.io/crates/ws\" rel=\"nofollow noreferrer\">ws</a>, and I would like to split the <a href=\"https://ws-rs.org/api_docs/ws/trait.Handler.html\" rel=\"nofollow noreferrer\">Handler</a> trait implementation into multiple files.</p>\n\n<p>So I wrote this in one file, <code>on_open.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Handler for Client {\n    fn on_open(&amp;mut self, _: Handshake) -&gt; Result&lt;()&gt; {\n        println!(\"Socket opened\");\n        Ok(())\n    }\n}\n</code></pre>\n\n<p>And this in another file, <code>on_message.rs</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl Handler for Client {\n    fn on_message(&amp;mut self, msg: Message) -&gt; Result&lt;()&gt; {\n        println!(\"Server got message '{}'. \", msg);\n        Ok(())\n    }\n}\n</code></pre>\n\n<p>While compiling it I got the following error:</p>\n\n<pre><code>error[E0119]: conflicting implementations of trait `ws::handler::Handler` for type `models::client::Client`:\n --&gt; src\\sockets\\on_message.rs:9:1\n  |\n9 | impl Handler for Client {\n  | ^^^^^^^^^^^^^^^^^^^^^^^ conflicting implementation for `models::client::Client`\n  |\n ::: src\\sockets\\on_open.rs:8:1\n  |\n8 | impl Handler for Client {\n  | ----------------------- first implementation here\n</code></pre>\n\n<p>I'd like to have the files to be separated so that each developer can work on a separate one.  Is there a way to achieve this or am I forced to have the full trait implementation in a single file?</p>\n"}, {"tags": ["android", "rust", "java-native-interface"], "comments": [{"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567412689, "post_id": 57734729, "comment_id": 101943889, "body": "Use another crate which does support Android or send a PR which adds Android support. But it seems that the first option is a no go because the last update is 3 years old. It&#39;s also worth to mention this: <i>Rust-Crypto has not been thoroughly audited for correctness, so any use where security is important is not recommended at this time.</i>"}, {"owner": {"reputation": 1, "user_id": 11999814, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/aff1a623c760f305b4c2fb64edd5b882?s=128&d=identicon&r=PG&f=1", "display_name": "tae am choi", "link": "https://stackoverflow.com/users/11999814/tae-am-choi"}, "reply_to_user": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567503335, "post_id": 57734729, "comment_id": 101972965, "body": "Thank you for your recommendation. I fixed the problem using the information as follows. <a href=\"https://github.com/DaGenix/rust-crypto/pull/384\" rel=\"nofollow noreferrer\">github.com/DaGenix/rust-crypto/pull/384</a>"}], "owner": {"reputation": 1, "user_id": 11999814, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/aff1a623c760f305b4c2fb64edd5b882?s=128&d=identicon&r=PG&f=1", "display_name": "tae am choi", "link": "https://stackoverflow.com/users/11999814/tae-am-choi"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 88, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1580890180, "creation_date": 1567217856, "last_edit_date": 1580890180, "question_id": 57734729, "link": "https://stackoverflow.com/questions/57734729/cant-referenced-function-of-shared-library-which-made-by-rust-for-android-app", "title": "can&#39;t referenced function of shared library which made by rust for android app", "body": "<p>I made a shared library using rust for an android app. When the Android app loads the library, make an error as following:</p>\n\n<pre><code>java.lang.UnsatisfiedLinkError: dlopen failed: cannot locate symbol \n\"rust_crypto_util_fixed_time_eq_asm\" referenced by \"/data/app/com.kt.ktcrypto-4fggQbbTPHo3WulOyE1JIw ==\n/lib/arm64/libE2eCryptoLib.so\"..\n</code></pre>\n\n<p>When I look the source the function <code>rust_crypto_util_fixed_time_eq_asm</code> , I found the <code>fixed_time_eq_asm</code> function support only target_arch <code>x86, x86_64, arm</code>.</p>\n\n<p><code>fixed_time_eq_asm</code> is in <code>rust-crypto-working/src/rust-crypto/cryptoutil.rs</code>.</p>\n\n<p>How can I fix the problem?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 17581, "user_id": 2167834, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9699e22406fb8e57a0c90f576c610b1c?s=128&d=identicon&r=PG", "display_name": "S&#233;bastien Renauld", "link": "https://stackoverflow.com/users/2167834/s%c3%a9bastien-renauld"}, "is_accepted": true, "score": 0, "last_activity_date": 1567257305, "creation_date": 1567257305, "answer_id": 57738316, "question_id": 57732378, "link": "https://stackoverflow.com/questions/57732378/what-to-pass-to-reqwestmultipartpartreader/57738316#57738316", "title": "What to pass to reqwest::multipart::Part::reader", "body": "<p>Careful with the lifetimes. <code>request::multipart::Part::reader</code>'s <code>'static</code> lifetime isn't on the <strong>argument borrow</strong> but on the <strong>type</strong>. The requirement is that the type definition will still exist for the lifetime of the function, which is a really easy requirement to fulfill. No part in the usage of <code>reqwest::multipart</code> actually borrows anything from the outside without making a copy of it internally.</p>\n\n<p>In practice, any instance of <code>Read</code> will satisfy reqwest's multipart <code>reader</code> method, allowing you to pass arbitrary readers, even those you generate yourself.</p>\n\n<p>In your specific case, you'll be uploading a large file. I'm going to deliberately pretend you are passing a reader (as you're specifically requesting to see how to use this method) as opposed to just using <code>Part::file</code>, which does exactly what I'm about to show you under the hood.</p>\n\n<p>First, we're going to be opening our file:</p>\n\n<pre><code>let reader = std::fs::File::open(\"test.txt\")?;\n</code></pre>\n\n<p>Nothing surprising there, it's worth noticing that <code>File</code> implements <code>Read</code>.</p>\n\n<p>We then create our <code>Part</code>:</p>\n\n<pre><code>let part = reqwest::multipart::Part::reader(reader).file_name(\"foobar\");\n</code></pre>\n\n<p>I've set the file name along the way. From here, we create our <code>Form</code>, because that's what we'll be sending. Note that the <code>Part</code> we created earlier is moved into this struct:</p>\n\n<pre><code>let form = reqwest::multipart::Form::new();\nlet form = form.part(\"test\", part);\n</code></pre>\n\n<p>And then we send the request:</p>\n\n<pre><code>let client = reqwest::Client::new();\nlet resp = client\n    .post(\"http://localhost/foobar\")\n    .multipart(form)\n    .send().map_err(|e| io::Error::new(io::ErrorKind::InvalidData, \"Invalid server return\"))?;\n</code></pre>\n\n<p>And, sure enough, it worked!</p>\n\n<p><a href=\"https://i.stack.imgur.com/nS7sM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/nS7sM.png\" alt=\"enter image description here\"></a></p>\n\n<p>The file contained <code>foobar</code> (6 bytes, as seen on the screenshot).</p>\n"}], "owner": {"reputation": 128, "user_id": 6938528, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9e47378d6ec9953eef195f56b30fcef1?s=128&d=identicon&r=PG&f=1", "display_name": "jonathan-dev", "link": "https://stackoverflow.com/users/6938528/jonathan-dev"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 438, "favorite_count": 0, "accepted_answer_id": 57738316, "answer_count": 1, "score": 1, "last_activity_date": 1567263912, "creation_date": 1567193762, "last_edit_date": 1567263912, "question_id": 57732378, "link": "https://stackoverflow.com/questions/57732378/what-to-pass-to-reqwestmultipartpartreader", "title": "What to pass to reqwest::multipart::Part::reader", "body": "<p>I'm trying to upload a file (the name is dynamicly retrieved from the command line args) usind the <code>reqwest</code> crate.\nI need to use the multipart form to upload the file. And since I want to upload large files in chunks I'm guessing that I need to use either <code>reqwest::multipart::Part::reader</code> or <code>reqwest::multipart::Part::bytes</code>. But both of the expect values with a <code>'static</code> lifetime.\nHow do I get my file into into the fitting format to use these methods and get the expected lifetime? </p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1567227241, "post_id": 57732239, "comment_id": 101910033, "body": "look like it&#39;s almost impossible to do, I advice you to create a issue asking for <code>try_map()</code> implementation"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1567227486, "post_id": 57732239, "comment_id": 101910060, "body": "The closest thing I come up to is <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=413ae1a6e8e05fc93ee9cbba1b294704\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 1, "creation_date": 1567234398, "post_id": 57732239, "comment_id": 101910927, "body": "A <code>try_map</code> implementation is the way to go. Short of that, I came up with: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d13538a717bd4bee9890961f6f9d5c27\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 772, "user_id": 880987, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/42c8c4ab92de3390bcd2f637ef6ca16c?s=128&d=identicon&r=PG", "display_name": "kmsquire", "link": "https://stackoverflow.com/users/880987/kmsquire"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1567541488, "post_id": 57732239, "comment_id": 101991240, "body": "@Stargateur thanks for the input.  I&#39;ll open an issue in <code>ndarray</code> about adding <code>.try_map</code>"}, {"owner": {"reputation": 772, "user_id": 880987, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/42c8c4ab92de3390bcd2f637ef6ca16c?s=128&d=identicon&r=PG", "display_name": "kmsquire", "link": "https://stackoverflow.com/users/880987/kmsquire"}, "reply_to_user": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 0, "creation_date": 1567541556, "post_id": 57732239, "comment_id": 101991268, "body": "@edwardw, thank you!  For now, I&#39;ll probably go with your solution (and open an issue regarding <code>try_map</code>).  Do you want to type it up as an answer so I can accept it?"}], "answers": [{"tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 1, "last_activity_date": 1567599412, "last_edit_date": 1567599412, "creation_date": 1567578556, "answer_id": 57782654, "question_id": 57732239, "link": "https://stackoverflow.com/questions/57732239/how-can-i-replace-unwrap-with-when-mapping-over-an-ndarrayarray/57782654#57782654", "title": "How can I replace `.unwrap()` with `?` when mapping over an `ndarray::Array`?", "body": "<p>A native <code>try_map</code> implementation from <code>ndarray</code> would be ideal. It can short-circuit the computation and return as soon as an error occurs. It is also more composable.</p>\n\n<p>Short of that, nothing wrong with a good old mutable sentinel variable:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate ndarray;\n\nuse ndarray::prelude::*;\nuse std::convert::TryFrom;\nuse std::error::Error;\nuse std::num::TryFromIntError;\n\nfn get_data() -&gt; Result&lt;Array2&lt;usize&gt;, TryFromIntError&gt; {\n    let mut err = None;\n    let a: Array2&lt;i32&gt; = arr2(&amp;[[1, 2, 3], [4, 5, 6]]);\n    let b: Array2&lt;usize&gt; = a.map(|&amp;x| {\n        usize::try_from(x).unwrap_or_else(|e| {\n            err = Some(e);\n            Default::default()\n        })\n    });\n\n    err.map_or(Ok(b), Err)\n}\n\nfn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {\n    let a = get_data()?;\n    println!(\"{:?}\", a);\n\n    Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 772, "user_id": 880987, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/42c8c4ab92de3390bcd2f637ef6ca16c?s=128&d=identicon&r=PG", "display_name": "kmsquire", "link": "https://stackoverflow.com/users/880987/kmsquire"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 370, "favorite_count": 1, "accepted_answer_id": 57782654, "answer_count": 1, "score": 1, "last_activity_date": 1567599412, "creation_date": 1567193008, "last_edit_date": 1567225280, "question_id": 57732239, "link": "https://stackoverflow.com/questions/57732239/how-can-i-replace-unwrap-with-when-mapping-over-an-ndarrayarray", "title": "How can I replace `.unwrap()` with `?` when mapping over an `ndarray::Array`?", "body": "<p>I'd like to remove the use of <code>.unwrap()</code> from code which maps over an <code>ndarray::Array</code> and use a <code>Result</code> type for <code>get_data()</code> instead.  </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate ndarray;\n\nuse ndarray::prelude::*;\nuse std::convert::TryFrom;\nuse std::error::Error;\n\nfn get_data() -&gt; Array2&lt;usize&gt; {\n    // In actual code, \"a\" comes from an external source, and the type\n    // is predetermined\n    let a: Array2&lt;i32&gt; = arr2(&amp;[[1, 2, 3], [4, 5, 6]]);\n    let b: Array2&lt;usize&gt; = a.map(|x| usize::try_from(*x).unwrap());\n    b\n}\n\nfn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {\n    let a = get_data();\n    println!(\"{:?}\", a);\n\n    Ok(())\n}\n</code></pre>\n\n<p>For <code>Vec</code>, I've found this trick: <a href=\"https://stackoverflow.com/questions/26368288/how-do-i-stop-iteration-and-return-an-error-when-iteratormap-returns-a-result\">How do I stop iteration and return an error when Iterator::map returns a Result::Err?</a>.  </p>\n\n<p>However, this does not work with <code>Array</code>s (<code>collect</code> isn't defined, and the semantics don't quite match up, since <code>ndarray::Array</code> defines a block of primitive types, which (AFAIU) can't hold <code>Result</code>s).</p>\n\n<p>Is there a nice way to handle this?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 5, "creation_date": 1567185439, "post_id": 57730832, "comment_id": 101901967, "body": "<code>filter()</code> that very basic, <code>.filter(|c| c.is_alphanumeric() || c.is_whitespace())</code>, if you want you can use <code>filter_map</code> to replace with space"}, {"owner": {"reputation": 1750, "user_id": 1262568, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/b7850546eac0298026dc778445fddcdc?s=128&d=identicon&r=PG", "display_name": "whd", "link": "https://stackoverflow.com/users/1262568/whd"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1567186358, "post_id": 57730832, "comment_id": 101902355, "body": "@Stargateur i updated code a little bit. <code>filter</code> will not do what i wan&#39;t because will get rid off apostrophe also."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 4, "creation_date": 1567187254, "post_id": 57730832, "comment_id": 101902641, "body": "<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=1b7d008979d710f8104b07b15d8fb352\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 10345, "user_id": 4131059, "user_type": "registered", "accept_rate": 91, "profile_image": "https://i.stack.imgur.com/uDaBr.jpg?s=128&g=1", "display_name": "Alexander Huszagh", "link": "https://stackoverflow.com/users/4131059/alexander-huszagh"}, "edited": false, "score": 0, "creation_date": 1567191678, "post_id": 57730832, "comment_id": 101903987, "body": "The reason why it&#39;s an error is because there is no such thing as an empty character literal. You&#39;re saying, return a 32-bit character and then out-of-the-blue saying, oh wait, this value won&#39;t even exist. You want <code>filter</code>/<code>filter_map</code>, not <code>map</code>."}], "owner": {"reputation": 1750, "user_id": 1262568, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/b7850546eac0298026dc778445fddcdc?s=128&d=identicon&r=PG", "display_name": "whd", "link": "https://stackoverflow.com/users/1262568/whd"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 232, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1567187588, "creation_date": 1567185270, "last_edit_date": 1567187588, "question_id": 57730832, "link": "https://stackoverflow.com/questions/57730832/map-empty-character-literal-as-a-return-value", "title": "Map empty character literal as a return value", "body": "<p>I have simple piece of code. I want to remove non alphanumeric characters from a string. But i don't want to replace apostrophe with space i want to remove it. But that code doesn't compile saying it is illegal to return empty character literal. How can this be achived? </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn remove_non_chars(input: &amp;str) -&gt; String {\n    input\n        .chars()\n        .map(|c| {\n            if c.is_alphanumeric() || c.is_whitespace() {\n                c\n            } else if c == '\\'' {\n                ''\n            } else {\n                ' '\n            }\n        })\n        .collect()\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: empty character literal\n --&gt; src/lib.rs:9:18\n  |\n8 |                 ''\n  |                  ^\n</code></pre>\n"}, {"tags": ["rust", "lifetime"], "answers": [{"tags": [], "owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "is_accepted": true, "score": 1, "last_activity_date": 1567194138, "last_edit_date": 1567194138, "creation_date": 1567193579, "answer_id": 57732341, "question_id": 57730654, "link": "https://stackoverflow.com/questions/57730654/how-does-one-restrict-a-lifetime-to-a-closure-environment-in-rust/57732341#57732341", "title": "How does one restrict a lifetime to a closure environment in rust?", "body": "<p>You need <a href=\"https://doc.rust-lang.org/nomicon/hrtb.html\" rel=\"nofollow noreferrer\">higher-rank trait bounds</a> for your closure types:</p>\n\n<pre><code>fn clone_slice_borrows_into_vec() -&gt; impl for&lt;'a&gt; Fn(&amp;[&amp;'a HoldStr]) -&gt; Vec&lt;&amp;'a HoldStr&lt;'a&gt;&gt; {\n...\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f823df4d8d239347872de1fbee0a4a63\" rel=\"nofollow noreferrer\">Full code in the playground</a>)</p>\n\n<p>The lifetime <code>'a</code> isn't fixed for your closure. It should return a vector of references with lifetime <code>'a</code> for <em>any</em> input slice with references of this lifetime. Your code used an externally fixed lifetime instead, which could be chosen by the caller of <code>clone_slice_borrows_into_vec()</code>.</p>\n\n<p>If you have a funciton definition like</p>\n\n<pre><code>fn foo&lt;'a&gt;() -&gt; &amp;'a Foo\n</code></pre>\n\n<p>then it's basically always a mistake. This lets the <em>caller</em> request an <em>arbitrary</em> lifetime, and the function promises to create a reference of this lifetime out of thin air, which is only possible if it gets static references from some global storage, in which case it should simply return <code>&amp;'static Foo</code>.</p>\n"}], "owner": {"reputation": 43, "user_id": 1502122, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2b81e00cdbf0a4ace7acc85241e832ce?s=128&d=identicon&r=PG", "display_name": "tomjw64", "link": "https://stackoverflow.com/users/1502122/tomjw64"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 167, "favorite_count": 1, "accepted_answer_id": 57732341, "answer_count": 1, "score": 2, "last_activity_date": 1567194138, "creation_date": 1567184397, "question_id": 57730654, "link": "https://stackoverflow.com/questions/57730654/how-does-one-restrict-a-lifetime-to-a-closure-environment-in-rust", "title": "How does one restrict a lifetime to a closure environment in rust?", "body": "<p>I am calling closures with a fold function inside another closure. While I am intending for nothing in this <code>some_closure</code> function to live outside the closure environment, I am receiving an error that I am dropping a value while it is still borrowed.</p>\n\n<p>I have tried removing all lifetime specifiers from <code>some_closure</code>, because I find the compiler is much smarter than myself at figuring out lifetimes, but I'm also finding no success in this (the compiler will always ask for lifetime specifiers leading up to the point of the shown example).</p>\n\n<p>What I would desire to do here is to specify a lifetime restricted to the length of the closure inside the function, rather than the function itself. But I have a feeling that what I think is the problem may not actually be my problem, and that there is some gap in my understanding of lifetimes in closures.</p>\n\n<p>I've tried to minimize the example as much as possible:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct HoldStr&lt;'a&gt;(&amp;'a str);\n\nfn clone_slice_borrows_into_vec&lt;'a&gt;() -&gt; impl Fn(&amp;[&amp;'a HoldStr]) -&gt; Vec&lt;&amp;'a HoldStr&lt;'a&gt;&gt; {\n  |slice| {\n    let mut temp = vec![];\n    temp.clone_from_slice(slice);\n    temp\n  }\n}\n\nfn clone_slice_borrows_into_vec_same&lt;'a&gt;() -&gt; impl Fn(&amp;[&amp;'a HoldStr]) -&gt; Vec&lt;&amp;'a HoldStr&lt;'a&gt;&gt; {\n  // Same as last function for the sake of example, but one can assume it does something else\n}\n\nfn some_closure&lt;'a&gt;() -&gt; impl Fn() {\n  || {\n    let my_vec = vec![HoldStr(\"one\"), HoldStr(\"two\")];\n    let my_vec_holding_borrow: Vec&lt;&amp;'a HoldStr&gt; = my_vec.iter().collect();\n\n    let called_closures: [Box&lt;dyn Fn(&amp;[&amp;'a HoldStr]) -&gt; Vec&lt;&amp;'a HoldStr&lt;'a&gt;&gt;&gt;; 2] = [\n      Box::new(clone_slice_borrows_into_vec()),\n      Box::new(clone_slice_borrows_into_vec_same())\n    ];\n\n    let _result = called_closures\n      .iter()\n      .fold(my_vec_holding_borrow, |acc, closure| closure(&amp;acc));\n  }\n}\n</code></pre>\n\n<p>I would expect everything to be dropped by the end of the closure inside <code>some_closure</code> and for this to be fine, especially since I am specifying that lifetime <code>'a</code> does not relate to anything the function itself returns. But it seems that the borrowed value is expected to live until the end of the function itself. I get this error:</p>\n\n<pre><code>error[E0597]: `my_vec` does not live long enough\n  --&gt; src/lib.rs:61:51\n   |\n## | fn some_closure&lt;'a&gt;() -&gt; impl Fn() {\n   |                 -- lifetime `'a` defined here\n...\n## |     let my_vec_holding_borrow: Vec&lt;&amp;'a HoldStr&gt; = my_vec.iter().collect();\n   |                                ----------------   ^^^^^^ borrowed value does not live long enough\n   |                                |\n   |                                type annotation requires that `my_vec` is borrowed for `'a`\n...\n## |   }\n   |   - `my_vec` dropped here while still borrowed\n</code></pre>\n\n<p>I'd be happy to hear anything from how to resolve the error, to that I've been going about this the wrong way in the first place.</p>\n"}, {"tags": ["mysql", "rust"], "comments": [{"owner": {"reputation": 332774, "user_id": 263525, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/ec289925069b35f18f1230b90dc654e5?s=128&d=identicon&r=PG", "display_name": "Denys S&#233;guret", "link": "https://stackoverflow.com/users/263525/denys-s%c3%a9guret"}, "edited": false, "score": 2, "creation_date": 1567180140, "post_id": 57729460, "comment_id": 101899930, "body": "Is is announced to support multi statements ? Most drivers prevent them (to prevent injections, mostly) or allow them through special methods."}, {"owner": {"reputation": 143, "user_id": 3130203, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cf377e17251b83550c5adb524c60647a?s=128&d=identicon&r=PG&f=1", "display_name": "CodexAres", "link": "https://stackoverflow.com/users/3130203/codexares"}, "reply_to_user": {"reputation": 332774, "user_id": 263525, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/ec289925069b35f18f1230b90dc654e5?s=128&d=identicon&r=PG", "display_name": "Denys S&#233;guret", "link": "https://stackoverflow.com/users/263525/denys-s%c3%a9guret"}, "edited": false, "score": 0, "creation_date": 1567184103, "post_id": 57729460, "comment_id": 101901446, "body": "Not explicitly, however you can see here, that other people have used them: <a href=\"https://github.com/blackbeam/rust-mysql-simple/issues/37\" rel=\"nofollow noreferrer\">github.com/blackbeam/rust-mysql-simple/issues/37</a>"}, {"owner": {"reputation": 332774, "user_id": 263525, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/ec289925069b35f18f1230b90dc654e5?s=128&d=identicon&r=PG", "display_name": "Denys S&#233;guret", "link": "https://stackoverflow.com/users/263525/denys-s%c3%a9guret"}, "edited": false, "score": 0, "creation_date": 1567184370, "post_id": 57729460, "comment_id": 101901564, "body": "That was for prepared statements, I think. BTW why are you using format! instead of PS ? This is an antipattern"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 332774, "user_id": 263525, "user_type": "registered", "accept_rate": 85, "profile_image": "https://www.gravatar.com/avatar/ec289925069b35f18f1230b90dc654e5?s=128&d=identicon&r=PG", "display_name": "Denys S&#233;guret", "link": "https://stackoverflow.com/users/263525/denys-s%c3%a9guret"}, "edited": false, "score": 0, "creation_date": 1567185050, "post_id": 57729460, "comment_id": 101901810, "body": "@DenysS&#233;guret the linked github issue says that it doesn&#39;t work with <code>prep_exec</code>, but the issue was fixed by the poster changing to use <code>query</code>."}], "owner": {"reputation": 143, "user_id": 3130203, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cf377e17251b83550c5adb524c60647a?s=128&d=identicon&r=PG&f=1", "display_name": "CodexAres", "link": "https://stackoverflow.com/users/3130203/codexares"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 91, "favorite_count": 1, "answer_count": 0, "score": 1, "last_activity_date": 1567179581, "creation_date": 1567178582, "last_edit_date": 1567179581, "question_id": 57729460, "link": "https://stackoverflow.com/questions/57729460/mysql-crate-conn-query-multi-statement-sql-query-not-returning-queryresult", "title": "Mysql crate conn.query multi-statement SQL query not returning QueryResult", "body": "<p>I'm using the <a href=\"https://docs.rs/mysql/16.1.0/mysql/index.html\" rel=\"nofollow noreferrer\">mysql</a> crate, to perform a multi-statement SQL query (put a record into a table) and return a value with a select statement. However the <code>QueryResult</code> returned is <code>None</code>. Performing this on a <code>mysql</code> terminal the statement works fine.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut row_iter = self\n    .pool\n    .get_conn()\n    .unwrap()\n    .query(format!(\n        r#\"\n        SET @next_j_id = (SELECT IFNULL(MAX(j_id), 0) + 1 FROM people);\n        INSERT INTO people (j_id, name, email)\n        VALUES (@next_j_id, \"{name}\", \"{email}\");\n        SELECT @next_j_id;\n        \"#,\n        username = &amp;name,\n        email = &amp;email\n    ))\n    .unwrap();\nlet row_option = row_iter.next();\nmatch row_option {\n    Some(result_row) =&gt; {\n        let row = result_row.unwrap();\n        let j_id: u64 = row.get(\"@next_j_id\").unwrap();\n        Ok(j_id)\n    }\n    None =&gt; {\n        debug!(\"Errored\");\n        Err(Error)\n    }\n}\n</code></pre>\n\n<p>I expect <code>row_option</code> to be <code>Some(j_id)</code>, but the actual output is <code>None</code>.</p>\n"}, {"tags": ["linux", "rust", "travis-ci"], "comments": [{"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 3, "creation_date": 1567170344, "post_id": 57727066, "comment_id": 101894719, "body": "<code>alsa.pc</code> should have been installed by package <code>libasound2-dev</code> in <code>&#47;usr&#47;lib&#47;x86_64-linux-gnu&#47;pkgconfig&#47;alsa.pc</code>. Is the <code>libasound2-dev</code> package installed, and is the file present?"}, {"owner": {"reputation": 41, "user_id": 11999416, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/96fcf81624fc4fe60573c1b32ef715f4?s=128&d=identicon&r=PG&f=1", "display_name": "prixt", "link": "https://stackoverflow.com/users/11999416/prixt"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567175743, "post_id": 57727066, "comment_id": 101897718, "body": "@Jmb thank you! I added the <code>libasound2-dev</code> package <code>before_install</code>, and that fixed the issue."}], "answers": [{"comments": [{"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567413025, "post_id": 57728808, "comment_id": 101944011, "body": "Glad you have it sorted, please, mark this as an answer, so it disappears from the list of unanswered questions."}], "tags": [], "owner": {"reputation": 41, "user_id": 11999416, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/96fcf81624fc4fe60573c1b32ef715f4?s=128&d=identicon&r=PG&f=1", "display_name": "prixt", "link": "https://stackoverflow.com/users/11999416/prixt"}, "is_accepted": true, "score": 1, "last_activity_date": 1567175857, "creation_date": 1567175857, "answer_id": 57728808, "question_id": 57727066, "link": "https://stackoverflow.com/questions/57727066/how-can-i-install-and-connect-the-alsa-pc-when-building-the-alsa-sys-crate-as/57728808#57728808", "title": "How can I install and connect the alsa.pc when building the &#39;alsa-sys&#39; crate as a dependency?", "body": "<p>Following the advice by @Jmb, I added some package installing commands during the before_install step:</p>\n\n<pre><code>before_install:\n  - if [[ \"$TRAVIS_OS_NAME\" == \"linux\" ]]; then sudo apt-get install -y libasound2-dev ; sudo apt-get install -y libwebkit2gtk-4.0 ; fi\n</code></pre>\n\n<p>(I also needed to install the libwebkit2gtk package for another dependency)\nThis solved the issue.</p>\n"}], "owner": {"reputation": 41, "user_id": 11999416, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/96fcf81624fc4fe60573c1b32ef715f4?s=128&d=identicon&r=PG&f=1", "display_name": "prixt", "link": "https://stackoverflow.com/users/11999416/prixt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 561, "favorite_count": 0, "accepted_answer_id": 57728808, "answer_count": 1, "score": 3, "last_activity_date": 1567177530, "creation_date": 1567169306, "last_edit_date": 1567177530, "question_id": 57727066, "link": "https://stackoverflow.com/questions/57727066/how-can-i-install-and-connect-the-alsa-pc-when-building-the-alsa-sys-crate-as", "title": "How can I install and connect the alsa.pc when building the &#39;alsa-sys&#39; crate as a dependency?", "body": "<p>I'm trying to build a rust binary using travis-ci. I managed to get the windows and osx build working, but the linux build keeps failing.</p>\n\n<p>It seems the 'alsa-sys' crate, one of the dependencies, cannot locate the alsa.pc in the linux-vm.</p>\n\n<p>.travis.yml:</p>\n\n<pre><code>language: rust\ncache: cargo\nrust:\n- stable\n\nmatrix:\n  allow_failures:\n  - rust: nightly\n  fast_finish: true\nos:\n- osx\n- windows\n- linux\n\nscript:\n  - cargo build --verbose --release\n\nbefore_deploy:\n- if [[ -f target/release/soundsense-rs ]]; then mv target/release/soundsense-rs \"target/release/soundsense-rs-$TRAVIS_TAG-$TRAVIS_OS_NAME\"; fi\n- if [[ -f target/release/soundsense-rs.exe ]]; then mv target/release/soundsense-rs.exe \"target/release/soundsense-rs-$TRAVIS_TAG-$TRAVIS_OS_NAME.exe\"; fi\n\ndeploy:\n- provider: releases\n  skip_cleanup: true\n  on:\n    tags: true\n    condition: \"$TRAVIS_RUST_VERSION = stable\"\n    branch: release\n  file_glob: true\n  file:\n  - target/release/soundsense-rs-*\n  api_key:\n    secure: IRdsT0enLWr2qaa63GPnITLaYdar4vDKcKfo9Fm1PlDoWi1gigTZ2elegApdBQmWzcgdHEtiEayg9KtQw76R/l7bH2Yst3kvZPyd635g6Cwj9XUp70opApLeKdVGQhnvGA2fMehYXNfcLi8wn65th3katabvJhuU26C1ICAFt1ExVu2iDbIjUYPmg5O4f3BAvHYlGe5BNyA3C20sakD25ocp+Z/KaI1gfRdYvm3cwVuci63N2O0c+j2IHkaUg/bfA7XHRUqzxO1U4MNrRyYAwRRiIJ+wgKVh9qISt4N0Uw8IZR8ZmBkeK4OPkh+ggb05ONoOpCuOVDGKqMzbEG0SNKbDpwXdxfCkmbtNeXrORX6ZSlNPJOGaPhrD36WYZdRGOZMNC4lSgev/O2lZ/TfJc1Qj9kXlD7kbmG/vKrSkQYs4i/5p4a93E0zgBfyWiK1wiUYCc01PF5YKjbc0n7aymSO3z3CzGijwykH6MKFnInk1JtJ2aUjBM722oKVuCaW/JDikN4wMgPrlIMUY+dLrXBJZLXra89B/RS6un1NsTO0IPyMDQYKRgp6yTkvWJHux0m0Gwexnc+S/dPhb9Z023UDA0pb504XNc7ggpo9xtb5sUa/z/xQRoX3fKFSUEOoNLI3Kw/DE4QwHmnvVSdOGF4+s3Kj2JqnKSZusq3yycnw=\n</code></pre>\n\n<p>error message:</p>\n\n<pre><code>     Running `/home/travis/build/prixt/soundsense-rs/target/release/build/alsa-sys-9e3efef5874a428f/build-script-build`\n\nerror: failed to run custom build command for `alsa-sys v0.1.2`\n\nCaused by:\n\n  process didn't exit successfully: `/home/travis/build/prixt/soundsense-rs/target/release/build/alsa-sys-9e3efef5874a428f/build-script-build` (exit code: 101)\n\n--- stderr\n\nthread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: \"`\\\"pkg-config\\\" \\\"--libs\\\" \\\"--cflags\\\" \\\"alsa\\\"` did not exit successfully: exit code: 1\\n--- stderr\\nPackage alsa was not found in the pkg-config search path.\\nPerhaps you should add the directory containing `alsa.pc\\'\\nto the PKG_CONFIG_PATH environment variable\\nNo package \\'alsa\\' found\\n\"', src/libcore/result.rs:999:5\n\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n\nwarning: build failed, waiting for other jobs to finish...\n\nerror: build failed\n\nThe command \"cargo build --verbose --release\" exited with 101.\n</code></pre>\n\n<p>What commands do I need to add to solve this?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 101, "user_id": 3528393, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/305ee9e8e76edd4550f4c76c04d649d4?s=128&d=identicon&r=PG&f=1", "display_name": "Maxime", "link": "https://stackoverflow.com/users/3528393/maxime"}, "edited": false, "score": 0, "creation_date": 1567391755, "post_id": 57723354, "comment_id": 101938806, "body": "I have simplified code example following comment from Pavel Arnold."}], "answers": [{"comments": [{"owner": {"reputation": 101, "user_id": 3528393, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/305ee9e8e76edd4550f4c76c04d649d4?s=128&d=identicon&r=PG&f=1", "display_name": "Maxime", "link": "https://stackoverflow.com/users/3528393/maxime"}, "edited": false, "score": 0, "creation_date": 1567391299, "post_id": 57724781, "comment_id": 101938729, "body": "thank you for having a look. You playground example produces different error from Rust compiler. I have modified it to return the very same error I get in my code: <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=53411b5bb5807079ff6bb07adb61819a\" rel=\"nofollow noreferrer\">playground</a>. So the question is why Rust compiler do not see that StryctA have TraitA implemented and satisfy requirements for field <code>r</code> of <code>StructC</code> ?"}, {"owner": {"reputation": 183, "user_id": 5019531, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/21b6a4e99e6e1b47d32090ad238de5de?s=128&d=identicon&r=PG&f=1", "display_name": "Pavel Arnold", "link": "https://stackoverflow.com/users/5019531/pavel-arnold"}, "reply_to_user": {"reputation": 101, "user_id": 3528393, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/305ee9e8e76edd4550f4c76c04d649d4?s=128&d=identicon&r=PG&f=1", "display_name": "Maxime", "link": "https://stackoverflow.com/users/3528393/maxime"}, "edited": false, "score": 0, "creation_date": 1567405328, "post_id": 57724781, "comment_id": 101941192, "body": "You can have trait with method taking reference to associated type. If you could do this cast, then instead of expected concrete type you would be allowed to pass reference any trait implementor. Then, inside the implementation of this method, call to any method that specific to the struct, but not trait would be illegal."}], "tags": [], "owner": {"reputation": 183, "user_id": 5019531, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/21b6a4e99e6e1b47d32090ad238de5de?s=128&d=identicon&r=PG&f=1", "display_name": "Pavel Arnold", "link": "https://stackoverflow.com/users/5019531/pavel-arnold"}, "is_accepted": false, "score": 1, "last_activity_date": 1567159803, "creation_date": 1567159803, "answer_id": 57724781, "question_id": 57723354, "link": "https://stackoverflow.com/questions/57723354/reference-to-generic-trait-with-asscociated-type-as-struct-field/57724781#57724781", "title": "Reference to generic trait with asscociated type as struct field", "body": "<h3>About posted compiler error</h3>\n\n<p>The problem caused be the fact that <code>TCPtransport</code> does not implement \n<code>Transport&lt;.., Configuration=(dyn TransportConfiguration&lt;SyncReq&gt;&gt;</code>, \ninstead it implements\n<code>Transport&lt;.., Configuration=TcpTranportCfg&gt;</code>, and later one cannot be casted to former:</p>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=185e9a73e5fb9a336e8f786eee610e1e\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>Possible solution: Add new trait (Basically to strip associated type info):</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait SyncReqTransport{\n    ...\n}\n\nimpl&lt;T&gt; SyncReqTransport&lt;SyncReq&gt; for T \n    where \n        T: Transport&lt;SyncReq&gt;, // I Removed other parameters for simplicity\n        &lt;T as Transport&lt;SyncReq&gt;&gt;::Config: TransportConfiguration&lt;SyncReq&gt;\n{\n    ...\n}\n</code></pre>\n\n<p>And change <code>DAG</code> to</p>\n\n<pre><code>pub struct DAG&lt;'a, T&gt; {\n    request_transport: &amp;'a (dyn SyncReqTransport + 'a),\n}\n</code></pre>\n\n<h3>Another problem</h3>\n\n<p><code>sr_transport</code> being created on stack, and later reference to it being returned from \nthe function it is created, which is illegal.</p>\n"}], "owner": {"reputation": 101, "user_id": 3528393, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/305ee9e8e76edd4550f4c76c04d649d4?s=128&d=identicon&r=PG&f=1", "display_name": "Maxime", "link": "https://stackoverflow.com/users/3528393/maxime"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 134, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1567391683, "creation_date": 1567154368, "last_edit_date": 1567391683, "question_id": 57723354, "link": "https://stackoverflow.com/questions/57723354/reference-to-generic-trait-with-asscociated-type-as-struct-field", "title": "Reference to generic trait with asscociated type as struct field", "body": "<p>I am struggling to convince Rust to accept a reference to an instance implementing a generic trait with associated type as a value of struct field. Could you please give some clues what is wrong in the code below. </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait TraitA{}\n\ntrait TraitB{\n    type As: TraitA;\n}\n\nstruct StructA;\n\nimpl TraitA for StructA{}\n\nstruct StructB;\n\nimpl TraitB for StructB{\n    type As = StructA;\n}\n\nstruct StructC&lt;'a&gt; {\n    r: &amp;'a (dyn TraitB&lt;As = (dyn TraitA)&gt; + 'a),\n}\n\n\nfn main(){\n    let x = StructB;\n    let z = StructC {\n        r: &amp;x,\n    };\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=53411b5bb5807079ff6bb07adb61819a\" rel=\"nofollow noreferrer\">Playground</a></p>\n"}, {"tags": ["concurrency", "rust", "immutability", "shared-memory", "unsafe"], "answers": [{"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 0, "last_activity_date": 1567146096, "creation_date": 1567146096, "answer_id": 57721480, "question_id": 57721159, "link": "https://stackoverflow.com/questions/57721159/how-to-share-an-immutable-reference-of-a-struct-among-multiple-threads-in-rust/57721480#57721480", "title": "How to share an Immutable reference of a struct among multiple threads in Rust?", "body": "<p><a href=\"https://doc.rust-lang.org/stable/std/marker/trait.Send.html\" rel=\"nofollow noreferrer\"><code>Send</code></a> and <a href=\"https://doc.rust-lang.org/stable/std/marker/trait.Sync.html\" rel=\"nofollow noreferrer\"><code>Sync</code></a> are implemented automatically by the compiler when it is safe to do so. Both documentations state that:</p>\n\n<blockquote>\n  <p>This trait is automatically implemented when the compiler determines it's appropriate.</p>\n</blockquote>\n\n<p>The <a href=\"https://doc.rust-lang.org/stable/nomicon/send-and-sync.html\" rel=\"nofollow noreferrer\">nomicon</a> contains more details about what makes a type <code>Send</code> or <code>Sync</code>, but most types are <code>Send</code> except:</p>\n\n<blockquote>\n  <p>Major exceptions include:</p>\n  \n  <ul>\n  <li>raw pointers are neither <code>Send</code> nor <code>Sync</code> (because they have no safety guards).</li>\n  <li><code>UnsafeCell</code> isn't <code>Sync</code> (and therefore <code>Cell</code> and <code>RefCell</code> aren't).</li>\n  <li><code>Rc</code> isn't <code>Send</code> or <code>Sync</code> (because the refcount is shared and unsynchronized).</li>\n  </ul>\n</blockquote>\n\n<p>Plus, all types that contain only <code>Send</code> fields are automatically <code>Send</code> too. So all you need is for your custom structs to only contain <code>Send</code> fields and you should be fine.</p>\n"}], "owner": {"reputation": 11, "user_id": 5400874, "user_type": "registered", "profile_image": "https://graph.facebook.com/1664960427051056/picture?type=large", "display_name": "RaviSri ThammayyaBabu", "link": "https://stackoverflow.com/users/5400874/ravisri-thammayyababu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 514, "favorite_count": 0, "closed_date": 1567152558, "answer_count": 1, "score": 1, "last_activity_date": 1567146096, "creation_date": 1567144384, "question_id": 57721159, "link": "https://stackoverflow.com/questions/57721159/how-to-share-an-immutable-reference-of-a-struct-among-multiple-threads-in-rust", "closed_reason": "Duplicate", "title": "How to share an Immutable reference of a struct among multiple threads in Rust?", "body": "<p>I have a struct which I want to share as an Immutable reference among multiple threads.\nI am Using  \"Arc\" to do that but for Arc to work I have to Implement Send &amp; Sync traits for my struct.\nhere is the problem, it is written in the Rust Book that Implementing Send and Sync Manually Is Unsafe.</p>\n\n<p>What is the solution for this?</p>\n\n<p>Are there any alternatives to share an Immutable reference among multiple threads?</p>\n"}, {"tags": ["rust", "rust-tokio"], "answers": [{"comments": [{"owner": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "edited": false, "score": 0, "creation_date": 1567176724, "post_id": 57720605, "comment_id": 101898292, "body": "thanks for link to the ticket -- I added a suggestion <a href=\"https://github.com/rust-lang/rust/issues/54771#issuecomment-526631724\" rel=\"nofollow noreferrer\">github.com/rust-lang/rust/issues/54771#issuecomment-52663172&zwnj;&#8203;4</a>"}], "tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": false, "score": 1, "last_activity_date": 1567140943, "last_edit_date": 1567140943, "creation_date": 1567140140, "answer_id": 57720605, "question_id": 57720321, "link": "https://stackoverflow.com/questions/57720321/understanding-error-trait-futuresfuturefuture-is-not-implemented-for/57720605#57720605", "title": "understanding error: trait `futures::future::Future` is not implemented for `()`", "body": "<p>Basically the closure you pass to <a href=\"https://docs.rs/futures/0.1.28/futures/future/trait.Future.html#method.and_then\" rel=\"nofollow noreferrer\"><code>and_then</code></a> has the wrong type. It expects:</p>\n\n<blockquote>\n  <p><code>F: FnOnce(Self::Item) -&gt; B</code></p>\n</blockquote>\n\n<p>But you give it a closure of unit type, i.e. returns no value. Hence the error. </p>\n\n<p>That said, the <code>rustc</code> error message isn't optimal here. It would be much better if it reads:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let client = TcpStream::connect(&amp;addr).and_then(|stream| {\n    println!(\"created stream\");\n    // error: mismatched types: expected `IntoFuture` but found `()`\n});\n</code></pre>\n\n<p>The rust-lang project has this <a href=\"https://github.com/rust-lang/rust/issues/54771\" rel=\"nofollow noreferrer\">ticket</a> to track the progress on said diagnostics issue.</p>\n"}, {"comments": [{"owner": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "edited": false, "score": 0, "creation_date": 1567174737, "post_id": 57721593, "comment_id": 101897153, "body": "Thank you for this good explanation!  The key missing piece for me was that IntoFuture is implemented for Result.  Another part that I forgot (and can&#39;t find anywhere in docs) is that returning &quot;nothing&quot; in Rust, returns <code>()</code>"}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": true, "score": 4, "last_activity_date": 1567177004, "last_edit_date": 1567177004, "creation_date": 1567146703, "answer_id": 57721593, "question_id": 57720321, "link": "https://stackoverflow.com/questions/57720321/understanding-error-trait-futuresfuturefuture-is-not-implemented-for/57721593#57721593", "title": "understanding error: trait `futures::future::Future` is not implemented for `()`", "body": "<p>The docs for <a href=\"https://docs.rs/futures/0.1.28/futures/future/trait.Future.html#method.and_then\" rel=\"nofollow noreferrer\"><code>and_then</code></a> state that:</p>\n\n<blockquote>\n<pre><code>fn and_then&lt;F, B&gt;(self, f: F) -&gt; AndThen&lt;Self, B, F&gt; where\n    F: FnOnce(Self::Item) -&gt; B,\n    B: IntoFuture&lt;Error = Self::Error&gt;,\n    Self: Sized, \n</code></pre>\n</blockquote>\n\n<p>This means that:</p>\n\n<ul>\n<li>Your closure must accept an argument of type <code>Self::Item</code> and return some type <code>B</code></li>\n<li>The type <code>B</code> returned by your closure must be convertible into a future.</li>\n<li>And if that future returns an error, then that error must have type <code>Self::Error</code>.</li>\n</ul>\n\n<p>Moreover, if you look at the doc for <a href=\"https://docs.rs/futures/0.1.28/futures/future/trait.IntoFuture.html\" rel=\"nofollow noreferrer\"><code>IntoFuture</code></a>, you will see that it is <a href=\"https://docs.rs/futures/0.1.28/futures/future/trait.IntoFuture.html#impl-IntoFuture-for-Result%3CT%2C%20E%3E\" rel=\"nofollow noreferrer\">implemented for <code>Result</code></a>, so it works for <code>Ok(())</code>, but that it is not implemented for <code>()</code>, so it doesn't work if your closure returns nothing.</p>\n"}], "owner": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3452, "favorite_count": 0, "accepted_answer_id": 57721593, "answer_count": 2, "score": 4, "last_activity_date": 1567177004, "creation_date": 1567137570, "last_edit_date": 1567175305, "question_id": 57720321, "link": "https://stackoverflow.com/questions/57720321/understanding-error-trait-futuresfuturefuture-is-not-implemented-for", "title": "understanding error: trait `futures::future::Future` is not implemented for `()`", "body": "<p>This question is about how to read the Rust documentation and improve my understanding of Rust so as to understand how to address this specific compiler error.</p>\n\n<p>I've read the <a href=\"https://tokio.rs/docs\" rel=\"noreferrer\">tokio docs</a> and experimented with many of the <a href=\"https://github.com/tokio-rs/tokio/tree/master/tokio/examples\" rel=\"noreferrer\">examples</a>.  In writing my own code, I frequently run into compiler errors that I don't understand and often found I can fix the code, but don't understand <em>why</em> specific syntax is needed.</p>\n\n<p>I reproduced with a very simple example based on tokio's <a href=\"https://tokio.rs/docs/getting-started/hello-world/\" rel=\"noreferrer\">hello world</a>:</p>\n\n<pre><code>use futures::Future;\nuse tokio::net::TcpStream;\nuse tokio::prelude::*;\n\nfn main() {\n  let addr = \"127.0.0.1:6142\".parse().unwrap();\n\n  let client = TcpStream::connect(&amp;addr).and_then(|stream| {\n      println!(\"created stream\");\n      // Process stream here.\n\n      // Ok(())\n  });\n\n}\n</code></pre>\n\n<p>The above code is incorrect, requiring the commented out <code>Ok()</code>.  I know that this is true, but not exactly why.  This is perhaps the other half of a prior question <a href=\"https://stackoverflow.com/questions/56402818/how-do-i-interpret-the-signature-of-read-until-and-what-is-asyncread-bufread-i\">How do I interpret the signature of read_until and what is AsyncRead + BufRead in Tokio?</a> -- now I understand closures better, but can't quite parse the docs to understand the expected return value.</p>\n\n<p>When I attempt to compile the incorrect code above, I get the following error:</p>\n\n<pre><code>error[E0277]: the trait bound `(): futures::future::Future` is not satisfied\n --&gt; tokio-chat-client/src/main.rs:8:42\n  |\n8 |   let client = TcpStream::connect(&amp;addr).and_then(|stream| {\n  |                                          ^^^^^^^^ the trait `futures::future::Future` is not implemented for `()`\n  |\n  = note: required because of the requirements on the impl of `futures::future::IntoFuture` for `()`\n</code></pre>\n\n<p>There are two parts to my question:</p>\n\n<ol>\n<li>What is the error message trying to tell me?  </li>\n<li>How would I use the docs for <a href=\"https://docs.rs/futures/0.1.28/futures/future/trait.Future.html#method.and_then\" rel=\"noreferrer\">and_then</a> to understand the expected return value?</li>\n</ol>\n"}, {"tags": ["rust", "wasm-bindgen"], "comments": [{"owner": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "edited": false, "score": 0, "creation_date": 1567138724, "post_id": 57720248, "comment_id": 101881963, "body": "FYI -- when I try to build from full source code (linked in the example), I get a lot of different errors, including &quot;error: Could not compile <code>futures-core-preview</code>&quot;"}, {"owner": {"reputation": 893, "user_id": 6277384, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b6172ff7a5d08eb58a7bbcc7dd99a08c?s=128&d=identicon&r=PG", "display_name": "yumetodo", "link": "https://stackoverflow.com/users/6277384/yumetodo"}, "reply_to_user": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "edited": false, "score": 1, "creation_date": 1567139361, "post_id": 57720248, "comment_id": 101882065, "body": "@Ultrasaurus  Really!? All of the changes are committed and pushd. $rustup --version rustup 1.18.3 (435397f48 2019-05-22) $cargo --version cargo 1.37.0 (9edd08916 2019-08-02) $rustc --version rustc 1.37.0 (eae3437df 2019-08-13)"}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 2, "creation_date": 1567169376, "post_id": 57720248, "comment_id": 101894189, "body": "<code>get_replaced</code> needs to be <code>get_replaced(...) -&gt; Result&lt;JsValue, JsValue&gt;</code>. And then you&#39;ll get bunch of lifetime errors. Oh boy, good luck with that."}, {"owner": {"reputation": 893, "user_id": 6277384, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b6172ff7a5d08eb58a7bbcc7dd99a08c?s=128&d=identicon&r=PG", "display_name": "yumetodo", "link": "https://stackoverflow.com/users/6277384/yumetodo"}, "edited": false, "score": 0, "creation_date": 1567176303, "post_id": 57720248, "comment_id": 101898054, "body": "I apply your feedback: <a href=\"https://github.com/yumetodo/markdown_img_url_editor/commit/692b2acee4c15ca28eeb29e54dbd5964e96839c7\" rel=\"nofollow noreferrer\">github.com/yumetodo/markdown_img_url_editor/commit/&hellip;</a>"}, {"owner": {"reputation": 2420, "user_id": 682349, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/20ee0d23c969c7740d3c936a4675bb23?s=128&d=identicon&r=PG", "display_name": "Ultrasaurus", "link": "https://stackoverflow.com/users/682349/ultrasaurus"}, "edited": false, "score": 0, "creation_date": 1567177499, "post_id": 57720248, "comment_id": 101898711, "body": "@yumetodo I did <code>rustup update</code> and was able to reproduce your error.  rustup --version.  Good to know what versions you were add -- thanks!  For the record, I had been running a slightly older version: rustup 1.18.3 (435397f48 2019-05-22) cargo --version cargo 1.34.0 (6789d8a0a 2019-04-01) rustc --version rustc 1.34.1 (fc50f328b 2019-04-24)"}], "answers": [{"tags": [], "owner": {"reputation": 893, "user_id": 6277384, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b6172ff7a5d08eb58a7bbcc7dd99a08c?s=128&d=identicon&r=PG", "display_name": "yumetodo", "link": "https://stackoverflow.com/users/6277384/yumetodo"}, "is_accepted": true, "score": 0, "last_activity_date": 1567357533, "creation_date": 1567357533, "answer_id": 57747963, "question_id": 57720248, "link": "https://stackoverflow.com/questions/57720248/type-mismatch-resolving-future-to-promise/57747963#57747963", "title": "type mismatch resolving future_to_promise", "body": "<p>Finally, I gave up to fight and decide to refactor API. <code>future_to_promise</code> request static lifetime <code>&amp;str</code> and <code>pulldown_cmark</code> only accept <code>&amp;'a str</code> is a critical problem.</p>\n\n<p>ref: <a href=\"https://qiitadon.com/web/statuses/102710559203790261\" rel=\"nofollow noreferrer\">https://qiitadon.com/web/statuses/102710559203790261</a>(written in Japanese)</p>\n\n<p>To refactor API, I made a bold assumption that the parser will produce the same result for the same input. So, I can decide not to hold parser.</p>\n\n<p>As a result, I make such API</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[wasm_bindgen]\npub struct MarkdownImgUrlEditor {\n    markdown_text: String,\n    string_generators: Vec&lt;Function&gt;,\n    initial_capacity: usize,\n}\n#[wasm_bindgen]\nimpl MarkdownImgUrlEditor {\n    #[wasm_bindgen(constructor)]\n    pub fn new(text: String, converter: &amp;Function) -&gt; Result&lt;MarkdownImgUrlEditor, JsValue&gt; {\n    }\n    pub fn replace(&amp;mut self) -&gt; Result&lt;String, JsValue&gt; {\n    }\n}\n</code></pre>\n\n<p>the process that <code>before_collect_callback</code> do will be executed between calling <code>new</code> and <code>replace</code>.</p>\n\n<p><a href=\"https://github.com/yumetodo/markdown_img_url_editor/pull/13\" rel=\"nofollow noreferrer\">https://github.com/yumetodo/markdown_img_url_editor/pull/13</a></p>\n\n<hr>\n\n<p>BTW, I noticed that <code>pulldown_cmark</code> is broken. I cannot get image alt.</p>\n\n<p>So, I created an issue. </p>\n\n<p><a href=\"https://github.com/raphlinus/pulldown-cmark/issues/394\" rel=\"nofollow noreferrer\">https://github.com/raphlinus/pulldown-cmark/issues/394</a></p>\n"}], "owner": {"reputation": 893, "user_id": 6277384, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b6172ff7a5d08eb58a7bbcc7dd99a08c?s=128&d=identicon&r=PG", "display_name": "yumetodo", "link": "https://stackoverflow.com/users/6277384/yumetodo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 257, "favorite_count": 0, "accepted_answer_id": 57747963, "answer_count": 1, "score": 0, "last_activity_date": 1567357533, "creation_date": 1567136815, "last_edit_date": 1567140474, "question_id": 57720248, "link": "https://stackoverflow.com/questions/57720248/type-mismatch-resolving-future-to-promise", "title": "type mismatch resolving future_to_promise", "body": "<p>I'm trying to do below:</p>\n\n<ol>\n<li>Receive function via argument</li>\n<li>Execute the function that returns Promise</li>\n<li>Wait Promise to be resolved</li>\n<li>Execute something</li>\n<li>return Promise</li>\n</ol>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn get_replaced(parser: Parser, string_generators: Vec&lt;Function&gt;, initial_capacity: usize) -&gt; Result&lt;JsString, JsValue&gt; {\n    // do something\n}\n#[wasm_bindgen]\npub fn markdown_img_url_editor(markdown_text: &amp;str, converter: &amp;Function, before_collect_callback: JsValue) -&gt; Promise {\n\n// do something\n    if before_collect_callback.is_null() || before_collect_callback.is_undefined() {\n        // do something\n    } else {\n        match before_collect_callback.dyn_into::&lt;Function&gt;() {\n            Ok(callback) =&gt; {\n                match callback.call0(&amp;JsValue::NULL) {\n                    Ok(maybe_promise) =&gt; {\n                        if let Ok(p) = maybe_promise.dyn_into::&lt;Promise&gt;() {\n\n                            // return p.then(&amp;Closure::wrap(Box::new(move |_| get_replaced_wrap(parser, string_generators, markdown_text.len() + 128))));\n                            let future = JsFuture::from(p).compat().then(|_| future::ready(get_replaced(parser, string_generators, markdown_text.len() + 128)));\n                            let ff = future.compat();\n                            return future_to_promise(ff);\n\n</code></pre>\n\n<p>At first, I want to call <a href=\"https://rustwasm.github.io/wasm-bindgen/api/js_sys/struct.Promise.html#method.then\" rel=\"nofollow noreferrer\"><code>js_sys::Promise#then</code></a>. However, there is no way to return something from the closure passed to <code>js_sys::Promise#then</code>.</p>\n\n<p>So, I'm trying to convert <code>js_sys::Promise</code> to <code>wasm_bindgen_futures::JsFuture</code>, call <a href=\"https://rust-lang-nursery.github.io/futures-api-docs/0.3.0-alpha.18/futures/future/trait.TryFutureExt.html#method.and_then\" rel=\"nofollow noreferrer\"><code>futures::future::TryFutureExt#and_then</code></a> and convert <code>wasm_bindgen_futures::JsFuture</code> to <code>js_sys::Promise</code> using <code>future_to_promise</code>.</p>\n\n<p>Now, I get compile error shown below:</p>\n\n<pre><code>$cargo build\n   Compiling markdown_img_url_editor_rust v0.1.0 (C:\\msys64\\home\\yumetodo\\markdown_img_url_editor\\markdown_img_url_editor_rust)\nwarning: unused import: `futures::future::Future`\n --&gt; src\\lib.rs:6:5\n  |\n6 | use futures::future::Future;\n  |     ^^^^^^^^^^^^^^^^^^^^^^^\n  |\n  = note: #[warn(unused_imports)] on by default\n\nerror[E0271]: type mismatch resolving `&lt;futures_util::future::then::Then&lt;futures_util::compat::compat01as03::Compat01As03&lt;wasm_bindgen_futures::legacy_shared::JsFuture&gt;, futures_util::future::ready::Ready&lt;std::result::Result&lt;js_sys::JsString, wasm_bindgen::JsValue&gt;&gt;, [closure@src\\lib.rs:116:74: 116:159 parser:_, string_generators:_, markdown_text:_]&gt; as core::future::future::Future&gt;::Output == std::result::Result&lt;wasm_bindgen::JsValue, _&gt;`\n   --&gt; src\\lib.rs:118:36\n    |\n118 |                             return future_to_promise(ff);\n    |                                    ^^^^^^^^^^^^^^^^^ expected struct `js_sys::JsString`, found struct `wasm_bindgen::JsValue`\n    |\n    = note: expected type `std::result::Result&lt;js_sys::JsString, wasm_bindgen::JsValue&gt;`\n               found type `std::result::Result&lt;wasm_bindgen::JsValue, _&gt;`\n    = note: required because of the requirements on the impl of `futures_core::future::TryFuture` for `futures_util::future::then::Then&lt;futures_util::compat::compat01as03::Compat01As03&lt;wasm_bindgen_futures::legacy_shared::JsFuture&gt;, futures_util::future::ready::Ready&lt;std::result::Result&lt;js_sys::JsString, wasm_bindgen::JsValue&gt;&gt;, [closure@src\\lib.rs:116:74: 116:159 parser:_, string_generators:_, markdown_text:_]&gt;`\n    = note: required by `wasm_bindgen_futures::legacy::future_to_promise`\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0271`.\nerror: Could not compile `markdown_img_url_editor_rust`.\n</code></pre>\n\n<blockquote>\n  <p>found type <code>std::result::Result&lt;wasm_bindgen::JsValue, _&gt;</code></p>\n</blockquote>\n\n<p>I cannot understand the reason these error was occered. <code>get_replaced</code> returns <code>Result&lt;JsString, JsValue&gt;</code>. Why error meesage says that found type <code>std::result::Result&lt;wasm_bindgen::JsValue, _&gt;</code>????</p>\n\n<p>Please tell me how to resolve this error or anthoer solution.</p>\n\n<hr>\n\n<p><code>Cargo.toml</code></p>\n\n<pre><code>[package]\nname = \"markdown_img_url_editor_rust\"\nversion = \"0.1.0\"\nauthors = [\"yumetodo &lt;yume-wikijp@live.jp&gt;\"]\nedition = \"2018\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\npulldown-cmark = \"0.5.3\"\npulldown-cmark-to-cmark = \"1.2.2\"\nwasm-bindgen = \"0.2.50\"\n# wasm-bindgen-futures = \"0.3.27\"\nwasm-bindgen-futures = { version=\"0.3.27\", features=[\"futures_0_3\"] }\njs-sys = \"0.3.27\"\nfutures-preview = { version=\"0.3.0-alpha\", features=[\"compat\"] }\n# futures-preview=\"0.3.0-alpha\"\n\n[lib]\ncrate-type = [\"cdylib\"]\n</code></pre>\n\n<p>full source code is below:<br>\n<a href=\"https://github.com/yumetodo/markdown_img_url_editor/tree/refaactor/by_rust/markdown_img_url_editor_rust\" rel=\"nofollow noreferrer\">https://github.com/yumetodo/markdown_img_url_editor/tree/refaactor/by_rust/markdown_img_url_editor_rust</a></p>\n\n<p>My build env is below:</p>\n\n<pre><code>$rustup --version\nrustup 1.18.3 (435397f48 2019-05-22)\n$cargo --version\ncargo 1.37.0 (9edd08916 2019-08-02)\n$rustc --version\nrustc 1.37.0 (eae3437df 2019-08-13)\n</code></pre>\n\n<p>OS: Windows 10 1809, Ubuntu 18.04</p>\n"}, {"tags": ["c++", "compiler-errors", "rust"], "owner": {"reputation": 98, "user_id": 7246469, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-_py1EGFzRnk/AAAAAAAAAAI/AAAAAAAABn4/dCyIzriTunY/photo.jpg?sz=128", "display_name": "Dyspro", "link": "https://stackoverflow.com/users/7246469/dyspro"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 232, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1567127775, "creation_date": 1567127775, "question_id": 57719344, "link": "https://stackoverflow.com/questions/57719344/duplicate-symbols-from-libm-and-libstdc", "title": "Duplicate symbols from libm and libstdc++", "body": "<p>I am having issues with using Rust and Bindgen with C++ to compile a Rust program that uses C++ libraries.</p>\n\n<p>Compiling for target armv7r-none-eabi using Cargo, on 64 bit Ubuntu 18.04. I've tried using newlib instead of gcc-arm-embedded, but that didn't help, so I switched back.</p>\n\n<p>Here is my build script:</p>\n\n<pre><code>#[allow(non_snake_case)]\n\nextern crate bindgen;\n\nuse std::env;\nuse std::path::PathBuf;\n\nfn main() {\n    // Tell cargo to tell rustc to link the v5rt library\n    // shared library\n    println!(\"cargo:rustc-link-search=libraries/\");\n    //println!(\"cargo:rustc-link-search=/usr/lib/gcc/arm-none-eabi/7.3.1/\");\n    println!(\"cargo:rustc-link-search=/usr/arm-none-eabi/lib\");\n    //println!(\"cargo:rustc-link-search=/usr/lib/arm-none-eabi/newlib/\");\n\n\n    println!(\"cargo:rustc-link-lib=static=v5rt\");\n    println!(\"cargo:rustc-link-lib=static=stdc++\");\n    println!(\"cargo:rustc-link-lib=static=c\");\n    println!(\"cargo:rustc-link-lib=static=m\");\n    //println!(\"cargo:rustc-link-lib=static=gcc\");\n    println!(\"cargo:rustc-link-lib=static=supc++\");\n\n    // The bindgen::Builder is the main entry point\n    // to bindgen, and lets you build up options for\n    // the resulting bindings.\n    let bindings = bindgen::Builder::default()\n\n        // The input header we would like to generate\n        // bindings for.\n        .header(\"vex/include/v5.h\")\n\n        .clang_arg(\"-I'$(TOOLCHAIN)/$(PLATFORM)/include'\")\n\n        .use_core()\n\n        .ctypes_prefix(\"cty\")\n        // Finish the builder and generate the bindings.\n        .generate()\n        // Unwrap the Result and panic on failure.\n        .expect(\"Unable to generate bindings\");\n\n    // Write the bindings to the $OUT_DIR/bindings.rs file.\n    let out_path = PathBuf::from(env::var(\"OUT_DIR\").unwrap());\n    bindings\n        .write_to_file(out_path.join(\"bindings.rs\"))\n        .expect(\"Couldn't write bindings!\");\n}\n</code></pre>\n\n<p>I can't share the contents of v5.h, but it includes some std headers. This should be fine, since the errors make no mention of libv5rt.</p>\n\n<p>The expected result of this is that I end up with a statically linked binary that calls C++ functions from within Rust, but instead, I get the following errors:</p>\n\n<pre><code>warning: unused manifest key: build\n   Compiling Monolith v0.1.0 (/home/nottherootaccount/pRust/project)\nerror: linking with `rust-lld` failed: exit code: 1\n  |\n  = note: \"rust-lld\" \"-flavor\" \"gnu\" \"-L\" \"/home/nottherootaccount/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7r-none-eabi/lib\" \"/home/nottherootaccount/pRust/project/target/armv7r-none-eabi/debug/deps/Monolith-1f0e2a190ceafaf5.2g6qot1433lhmu8x.rcgu.o\" \"-o\" \"/home/nottherootaccount/pRust/project/target/armv7r-none-eabi/debug/deps/Monolith-1f0e2a190ceafaf5\" \"--gc-sections\" \"-L\" \"/home/nottherootaccount/pRust/project/target/armv7r-none-eabi/debug/deps\" \"-L\" \"/home/nottherootaccount/pRust/project/target/debug/deps\" \"-L\" \"libraries/\" \"-L\" \"/usr/arm-none-eabi/lib\" \"-L\" \"/home/nottherootaccount/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7r-none-eabi/lib\" \"-Bstatic\" \"--whole-archive\" \"-lv5rt\" \"--no-whole-archive\" \"--whole-archive\" \"-lstdc++\" \"--no-whole-archive\" \"--whole-archive\" \"-lc\" \"--no-whole-archive\" \"--whole-archive\" \"-lm\" \"--no-whole-archive\" \"--whole-archive\" \"-lsupc++\" \"--no-whole-archive\" \"/home/nottherootaccount/pRust/project/target/armv7r-none-eabi/debug/deps/libcty-d94d348a8ecb57da.rlib\" \"/home/nottherootaccount/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7r-none-eabi/lib/librustc_std_workspace_core-02da144480cd28a7.rlib\" \"/home/nottherootaccount/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7r-none-eabi/lib/libcore-562f601a6298b539.rlib\" \"/home/nottherootaccount/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/armv7r-none-eabi/lib/libcompiler_builtins-2aa2db429e3347eb.rlib\" \"-Bdynamic\"\n  = note: rust-lld: error: duplicate symbol: __aeabi_atexit\n          &gt;&gt;&gt; defined at atexit_arm.cc\n          &gt;&gt;&gt;            atexit_arm.o:(__aeabi_atexit) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at aeabi_atexit.c\n          &gt;&gt;&gt;            lib_a-aeabi_atexit.o:(.text.__aeabi_atexit+0x0) in archive /usr/arm-none-eabi/lib/libc.a\n\n          rust-lld: error: duplicate symbol: acosl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(acosl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at acosl.c\n          &gt;&gt;&gt;            lib_a-acosl.o:(.text.acosl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: asinl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(asinl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at asinl.c\n          &gt;&gt;&gt;            lib_a-asinl.o:(.text.asinl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: atan2l\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(atan2l) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at atan2l.c\n          &gt;&gt;&gt;            lib_a-atan2l.o:(.text.atan2l+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: atanl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(atanl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at atanl.c\n          &gt;&gt;&gt;            lib_a-atanl.o:(.text.atanl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: ceill\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(ceill) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at ceill.c\n          &gt;&gt;&gt;            lib_a-ceill.o:(.text.ceill+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: coshl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(coshl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at coshl.c\n          &gt;&gt;&gt;            lib_a-coshl.o:(.text.coshl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: cosl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(cosl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at cosl.c\n          &gt;&gt;&gt;            lib_a-cosl.o:(.text.cosl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: expl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(expl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at expl.c\n          &gt;&gt;&gt;            lib_a-expl.o:(.text.expl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: fabsl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(fabsl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at fabsl.c\n          &gt;&gt;&gt;            lib_a-fabsl.o:(.text.fabsl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: floorl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(floorl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at floorl.c\n          &gt;&gt;&gt;            lib_a-floorl.o:(.text.floorl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: fmodl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(fmodl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at fmodl.c\n          &gt;&gt;&gt;            lib_a-fmodl.o:(.text.fmodl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: frexpl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(frexpl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at frexpl.c\n          &gt;&gt;&gt;            lib_a-frexpl.o:(.text.frexpl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: hypotl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(hypotl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at hypotl.c\n          &gt;&gt;&gt;            lib_a-hypotl.o:(.text.hypotl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: ldexpl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(ldexpl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at ldexpl.c\n          &gt;&gt;&gt;            lib_a-ldexpl.o:(.text.ldexpl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: log10l\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(log10l) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at log10l.c\n          &gt;&gt;&gt;            lib_a-log10l.o:(.text.log10l+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: logl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(logl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at logl.c\n          &gt;&gt;&gt;            lib_a-logl.o:(.text.logl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: modfl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(modfl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at modfl.c\n          &gt;&gt;&gt;            lib_a-modfl.o:(.text.modfl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: powl\n          &gt;&gt;&gt; defined at math_stubs_long_double.cc\n          &gt;&gt;&gt;            math_stubs_long_double.o:(powl) in archive /usr/arm-none-eabi/lib/libstdc++.a\n          &gt;&gt;&gt; defined at powl.c\n          &gt;&gt;&gt;            lib_a-powl.o:(.text.powl+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: duplicate symbol: copysign\n          &gt;&gt;&gt; defined at s_copysign.c\n          &gt;&gt;&gt;            lib_a-s_copysign.o:(copysign) in archive /usr/arm-none-eabi/lib/libc.a\n          &gt;&gt;&gt; defined at s_copysign.c\n          &gt;&gt;&gt;            lib_a-s_copysign.o:(.text.copysign+0x0) in archive /usr/arm-none-eabi/lib/libm.a\n\n          rust-lld: error: too many errors emitted, stopping now (use -error-limit=0 to see all errors)\n\n\nerror: aborting due to previous error\n\nerror: Could not compile `Monolith`.\n\nTo learn more, run the command again with --verbose.\n</code></pre>\n"}, {"tags": ["multidimensional-array", "rust", "copy", "borrowing", "nalgebra"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567155986, "post_id": 57717133, "comment_id": 101888040, "body": "Why don&#39;t you write a for loop?"}, {"owner": {"reputation": 25199, "user_id": 237105, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/a6e329efbf7cdfd89d8f1f5b5d05896d?s=128&d=identicon&r=PG", "display_name": "Antony Hatchkins", "link": "https://stackoverflow.com/users/237105/antony-hatchkins"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567193600, "post_id": 57717133, "comment_id": 101904677, "body": "@FrenchBoiethios just one for loop wont solve all the aliasing problems that might arise (eg left-to-right vs right-to-left copying). Also I&#39;d expect the library do that for me, or at least help me with that. Otherwise I&#39;d resort to plain C."}], "answers": [{"comments": [{"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567147163, "post_id": 57718147, "comment_id": 101884088, "body": "Note that there is no guaranty that this code will work: the order in which <code>assign</code> moves elements is not defined, so a future version of Rust or <code>ndarray</code> could break your code."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1567147210, "post_id": 57718147, "comment_id": 101884106, "body": "It also wouldn&#39;t work if you wanted to move data to the right instead of moving them to the left\u2026"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1567150399, "post_id": 57718147, "comment_id": 101885457, "body": "This program leads to undefined behavior."}, {"owner": {"reputation": 25199, "user_id": 237105, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/a6e329efbf7cdfd89d8f1f5b5d05896d?s=128&d=identicon&r=PG", "display_name": "Antony Hatchkins", "link": "https://stackoverflow.com/users/237105/antony-hatchkins"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567192816, "post_id": 57718147, "comment_id": 101904398, "body": "@Jmb yes, it needs some logic similar to memmove implementation: reverse the slice if the moving to the left"}], "tags": [], "owner": {"reputation": 25199, "user_id": 237105, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/a6e329efbf7cdfd89d8f1f5b5d05896d?s=128&d=identicon&r=PG", "display_name": "Antony Hatchkins", "link": "https://stackoverflow.com/users/237105/antony-hatchkins"}, "is_accepted": false, "score": -2, "last_activity_date": 1567128701, "last_edit_date": 1567128701, "creation_date": 1567115681, "answer_id": 57718147, "question_id": 57717133, "link": "https://stackoverflow.com/questions/57717133/is-there-a-good-way-to-do-an-overlapping-copy-in-ndarray-in-rust/57718147#57718147", "title": "Is there a good way to do an overlapping copy in ndarray in rust?", "body": "<p>Ok, got it</p>\n\n<pre><code>use ndarray::{arr2, s,Array};\n\nlet mut a = arr2(&amp;[[1, 2, 3],\n                   [4, 5, 6]]);\nunsafe{\n    let b = a.as_mut_ptr();\n    let c = Vec::&lt;i32&gt;::from_raw_parts(b, 6, 6);\n    let mut d = Array::from_shape_vec((2, 3), c).unwrap();\n    a.slice_mut(s![.., ..2]).assign(&amp;d.slice_mut(s![.., 1..]));\n    std::mem::forget(d);\n}\nprintln!(\"{:?}\",a);\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 25199, "user_id": 237105, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/a6e329efbf7cdfd89d8f1f5b5d05896d?s=128&d=identicon&r=PG", "display_name": "Antony Hatchkins", "link": "https://stackoverflow.com/users/237105/antony-hatchkins"}, "is_accepted": false, "score": 0, "last_activity_date": 1567196323, "last_edit_date": 1567196323, "creation_date": 1567193402, "answer_id": 57732312, "question_id": 57717133, "link": "https://stackoverflow.com/questions/57717133/is-there-a-good-way-to-do-an-overlapping-copy-in-ndarray-in-rust/57732312#57732312", "title": "Is there a good way to do an overlapping copy in ndarray in rust?", "body": "<p>In master branch of ndarray there's a special macro for that, more convenient than <code>split_at_mut()</code> in that it supports arbitrary slices - but it panics when the slices overlap:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use ndarray::multislice;\nuse ndarray::prelude::*;\nlet mut arr: Array1&lt;_&gt; = (0..4).collect();\nlet (mut a, mut b) = multislice!(arr, mut [..;2], mut [1..;2]);\na.assign(&amp;b);\n</code></pre>\n\n<p>gives <code>[1,1,3,3]</code></p>\n\n<p>They even solve a Diophantine equation to check it. It happens at runtime as opposed to compile-time <code>split_at_mut</code>.</p>\n"}], "owner": {"reputation": 25199, "user_id": 237105, "user_type": "registered", "accept_rate": 52, "profile_image": "https://www.gravatar.com/avatar/a6e329efbf7cdfd89d8f1f5b5d05896d?s=128&d=identicon&r=PG", "display_name": "Antony Hatchkins", "link": "https://stackoverflow.com/users/237105/antony-hatchkins"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 210, "favorite_count": 0, "answer_count": 2, "score": 0, "last_activity_date": 1567196323, "creation_date": 1567109307, "last_edit_date": 1567146931, "question_id": 57717133, "link": "https://stackoverflow.com/questions/57717133/is-there-a-good-way-to-do-an-overlapping-copy-in-ndarray-in-rust", "title": "Is there a good way to do an overlapping copy in ndarray in rust?", "body": "<p>Here's what I tried</p>\n\n<pre><code>use ndarray::{arr2, s};\nlet mut a = arr2(&amp;[[1, 2, 3],\n                   [4, 5, 6]]);\nlet b = arr2(&amp;[[2, 3, 3],\n               [5, 6, 6]]);\n\na.slice_mut(s![.., ..2]).assign(&amp;a.slice_mut(s![.., 1..]));\n</code></pre>\n\n<p>which obviously fails because of the borrowing rules (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d62ba7d22f3e304382c5e2148be7ee36\" rel=\"nofollow noreferrer\">playround link</a>):</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0499]: cannot borrow `a` as mutable more than once at a time\n  --&gt; src/main.rs:13:38\n   |\n13 |     a.slice_mut(s![.., ..2]).assign(&amp;a.slice_mut(s![.., 1..]));\n   |     -                        ------  ^ second mutable borrow occurs here\n   |     |                        |\n   |     |                        first borrow later used by call\n   |     first mutable borrow occurs here\n</code></pre>\n\n<p>Here <code>a</code> is what I have and <code>b</code> is what I'm trying to get.</p>\n\n<p>In numpy it is as easy as <code>a[:, :2] = a[:, 1:]</code>. </p>\n\n<p>PS Maybe there's a simple solution in <code>nalgebra</code> crate?</p>\n"}, {"tags": ["optimization", "rust"], "comments": [{"owner": {"reputation": 10345, "user_id": 4131059, "user_type": "registered", "accept_rate": 91, "profile_image": "https://i.stack.imgur.com/uDaBr.jpg?s=128&g=1", "display_name": "Alexander Huszagh", "link": "https://stackoverflow.com/users/4131059/alexander-huszagh"}, "edited": false, "score": 1, "creation_date": 1567089560, "post_id": 57711186, "comment_id": 101867386, "body": "Honestly, I honestly think it&#39;s just oversight/a lot of work to implement correctly. Rust recently got <code>NonNull</code> (and <code>NonZero</code>) to minimize the storage required to optimize <code>Optional</code> so it&#39;s as efficient as a raw pointer. Unlike Optional, this only works for certain data types (NonNull or unsaturated enumerations), so it likely hasn&#39;t been a priority yet. (This is a guess, but...)."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1567091777, "post_id": 57711186, "comment_id": 101868622, "body": "It&#39;s just not clever enough (yet). Currently the <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L921\" rel=\"nofollow noreferrer\">code</a> basically falls back to normal tagged union layout whenever more than one <code>enum</code> variant is non-zero-sized, even if one of them has a niche that could replace the tag. <code>Result&lt;u64, MyError&gt;</code> has two dataful variants, so the compiler just gives up."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1567092811, "post_id": 57711186, "comment_id": 101869161, "body": "If you were to use <code>Result&lt;Result&lt;u64, NotSoBad&gt;, BadError&gt;</code> you would find the compiler happy to optimize it -- it handles nesting just fine. I tried to demonstrate this in the playground but was stymied by the optimizer deleting and deduplicating most of my code, even with <code>inline(never)</code>."}], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 94, "favorite_count": 0, "closed_date": 1567093695, "answer_count": 0, "score": 5, "last_activity_date": 1567087687, "creation_date": 1567084939, "question_id": 57711186, "link": "https://stackoverflow.com/questions/57711186/why-isnt-rust-able-to-optimise-a-match-on-a-specific-error-as-well-as-it-does-f", "closed_reason": "Duplicate", "title": "Why isn&#39;t Rust able to optimise a match on a specific error as well as it does for is_err()?", "body": "<p>Consider this code:</p>\n\n<pre><code>enum MyError {\n    BadError, NotSoBad,\n}\n\n#[inline(never)]\nfn do_stuff1&lt;T&gt;(m: Result&lt;T, MyError&gt;) -&gt; bool {\n    m.is_err()\n}\n\n#[inline(never)]\nfn do_stuff2&lt;T&gt;(m: Result&lt;T, MyError&gt;) -&gt; bool {\n    if let Err(MyError::BadError) = m {\n        true\n    } else {\n        false\n    }\n}\n</code></pre>\n\n<p>The resulting assembly (see <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2018&amp;gist=0537efb6aff12caf563d0150a02f61cc\" rel=\"nofollow noreferrer\">playground</a>):</p>\n\n<pre><code>playground::do_stuff1:\n    cmpb    $1, %dil\n    sete    %al\n    retq\n\nplayground::do_stuff2:\n    testb   %dil, %dil\n    setne   %cl\n    testb   %sil, %sil\n    sete    %al\n    andb    %cl, %al\n    retq\n</code></pre>\n\n<p>Testing <code>result.is_err()</code> results in just one byte comparison, which seems reasonable but pattern-matching for the specific error results in a few more instructions.</p>\n\n<p>This is because the error type is actually encoded as a separate byte from the error flag. A <code>Result&lt;u64, MyError&gt;</code> is laid out like this:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>    .--- is error?\n   /\n  /  .--- error variant \n /  /\n01 01 XX XX XX XX XX XX 00 00 00 00 00 00 00 01\n      \\               / \\                     /\n       `-- padding --'   `---- data (u64) ---'\n</code></pre>\n\n<p>My expectation was that a single byte would be used to encode both the fact that there is an error and which variant the error is, which would allow for simpler assembly.</p>\n\n<p>Is there a reason why this optimisation isn't possible, or are there some tradeoffs that would make it undesirable?</p>\n"}, {"tags": ["datetime", "rust"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 2, "creation_date": 1567074320, "post_id": 57707966, "comment_id": 101858345, "body": "See also <a href=\"https://doc.rust-lang.org/std/time/struct.Instant.html#method.now\" rel=\"nofollow noreferrer\"><code>Instant::now</code></a> and <a href=\"https://doc.rust-lang.org/std/time/struct.SystemTime.html#method.now\" rel=\"nofollow noreferrer\"><code>SystemTime::now</code></a>"}], "answers": [{"tags": [], "owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "is_accepted": true, "score": 14, "last_activity_date": 1567084576, "last_edit_date": 1567084576, "creation_date": 1567074280, "answer_id": 57708129, "question_id": 57707966, "link": "https://stackoverflow.com/questions/57707966/how-to-get-timestamp-of-the-current-date-and-time-in-rust/57708129#57708129", "title": "How to get Timestamp of the current Date and time in Rust", "body": "<p>Use rust, use it <code>now</code>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use chrono;\n\nfn main() {\n    println!(\"{:?}\", chrono::offset::Local::now());\n    println!(\"{:?}\", chrono::offset::Utc::now());\n}\n</code></pre>\n"}], "owner": {"reputation": 611, "user_id": 11378334, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-AXysP46Cwk8/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3re2btjvnca9ztWrTvGV5IDe69sgKg/mo/photo.jpg?sz=128", "display_name": "Samuel Dressel", "link": "https://stackoverflow.com/users/11378334/samuel-dressel"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 5522, "favorite_count": 1, "accepted_answer_id": 57708129, "answer_count": 1, "score": 12, "last_activity_date": 1567084576, "creation_date": 1567073676, "question_id": 57707966, "link": "https://stackoverflow.com/questions/57707966/how-to-get-timestamp-of-the-current-date-and-time-in-rust", "title": "How to get Timestamp of the current Date and time in Rust", "body": "<p>I simply want to retrieve the current Time and Date and store it in a variable.\nFor this I tried to use the chrono::DateTime.</p>\n\n<p>In the documentation I found this:</p>\n\n<pre><code>use chrono::{DateTime, TimeZone, NaiveDateTime, Utc};\n\nlet dt = DateTime::&lt;Utc&gt;::from_utc(NaiveDate::from_ymd(2016, 7, 8).and_hms(9, 10, 11), Utc);    \n</code></pre>\n\n<p>This lets me store a specific Date and Time but I couldnt figure how to retrieve the actual current date and time and put it in my DateTime-Variable.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1567069419, "post_id": 57704830, "comment_id": 101855742, "body": "@FrenchBoiethios: Pointining to <code>retain</code> is appropriate (though an answer rather than a comment); the snark is really unnecessary :/"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1567069741, "post_id": 57704830, "comment_id": 101855902, "body": "@MatthieuM. My intent wasn&#39;t to be snarky. When searching for a feature, it&#39;s better (self-formation) and even faster to have a lookup at the doc rather than asking online."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1567094300, "post_id": 57704830, "comment_id": 101869864, "body": "&quot;I want to maintain only the alive ones&quot; one element ?"}, {"owner": {"reputation": 193, "user_id": 1742297, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/e605fc8808fe1f7dda86aa86548dd21d?s=128&d=identicon&r=PG", "display_name": "ericcire", "link": "https://stackoverflow.com/users/1742297/ericcire"}, "edited": false, "score": 0, "creation_date": 1567097981, "post_id": 57704830, "comment_id": 101871503, "body": "Yes, I should have read the docs before asking but I am already done with my change and moved on to the next thing on my todo lists. I just thought maybe there is something in the code I just wrote that can be improved. So I posted my question, wrote another 300 lines of code and came back. Voila, the exact answer I am looking for (a slightly condescending comment? still worth it). Isn&#39;t that the whole point of stackoverflow?  &quot;alive ones&quot; -&gt; [0, N] elements"}], "answers": [{"comments": [{"owner": {"reputation": 1476, "user_id": 9383219, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/97fabe5d903589acb1dfdf17fe4e405e?s=128&d=identicon&r=PG&f=1", "display_name": "cyclaminist", "link": "https://stackoverflow.com/users/9383219/cyclaminist"}, "edited": false, "score": 1, "creation_date": 1567135139, "post_id": 57705314, "comment_id": 101881424, "body": "Parenthesis in <code>for</code> loop is an error: should be <code>for x in numbers.drain_filter(...) {}</code>."}, {"owner": {"reputation": 2452, "user_id": 5082427, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b04ffa64c1eeae620048e1ed31dab54f?s=128&d=identicon&r=PG&f=1", "display_name": "Wazner", "link": "https://stackoverflow.com/users/5082427/wazner"}, "reply_to_user": {"reputation": 1476, "user_id": 9383219, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/97fabe5d903589acb1dfdf17fe4e405e?s=128&d=identicon&r=PG&f=1", "display_name": "cyclaminist", "link": "https://stackoverflow.com/users/9383219/cyclaminist"}, "edited": false, "score": 0, "creation_date": 1567150227, "post_id": 57705314, "comment_id": 101885369, "body": "@cyclaminist Thanks for the heads up, I edited the question. Althought it&#39;s a warning instead of an error, it shouldn&#39;t have those parenthesis."}, {"owner": {"reputation": 1476, "user_id": 9383219, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/97fabe5d903589acb1dfdf17fe4e405e?s=128&d=identicon&r=PG&f=1", "display_name": "cyclaminist", "link": "https://stackoverflow.com/users/9383219/cyclaminist"}, "edited": false, "score": 0, "creation_date": 1567207614, "post_id": 57705314, "comment_id": 101908036, "body": "Huh, I get an error, not a warning, for <code>for (x in 1..10) {}</code> in the playground."}, {"owner": {"reputation": 2452, "user_id": 5082427, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b04ffa64c1eeae620048e1ed31dab54f?s=128&d=identicon&r=PG&f=1", "display_name": "Wazner", "link": "https://stackoverflow.com/users/5082427/wazner"}, "reply_to_user": {"reputation": 1476, "user_id": 9383219, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/97fabe5d903589acb1dfdf17fe4e405e?s=128&d=identicon&r=PG&f=1", "display_name": "cyclaminist", "link": "https://stackoverflow.com/users/9383219/cyclaminist"}, "edited": false, "score": 1, "creation_date": 1567247129, "post_id": 57705314, "comment_id": 101913402, "body": "Oh! You&#39;re right. If-statements generate warnings, but for-statements generate errors. I did not know that. I should check my facts before I say something like that, my apologies."}], "tags": [], "owner": {"reputation": 2452, "user_id": 5082427, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b04ffa64c1eeae620048e1ed31dab54f?s=128&d=identicon&r=PG&f=1", "display_name": "Wazner", "link": "https://stackoverflow.com/users/5082427/wazner"}, "is_accepted": true, "score": 5, "last_activity_date": 1567150259, "last_edit_date": 1567150259, "creation_date": 1567064322, "answer_id": 57705314, "question_id": 57704830, "link": "https://stackoverflow.com/questions/57704830/is-vector-into-iter-filtersome-non-trivial-function-collect-acceptable/57705314#57705314", "title": "is vector.into_iter().filter(some_non_trivial_function).collect() acceptable", "body": "<p>A new <code>Vec</code> will be allocated using the code you provided. There are a few possible ways to do this without allocations depending on your constraints (time-wise and stability)</p>\n\n<p><strong>Vec.retain</strong><br>\nPretty much the most easy way is to use <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.retain\" rel=\"nofollow noreferrer\"><code>Vec.retain</code></a>.</p>\n\n<blockquote>\n  <p>Retains only the elements specified by the predicate.</p>\n</blockquote>\n\n<p>You can use it like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut vec = vec![1, 2, 3, 4];\nvec.retain(|&amp;x| non_trivial_function_returning_a_result(x).is_ok());\nassert_eq!(vec, [2, 4]);\n</code></pre>\n\n<p><strong>Vec.drain_filter</strong><br>\nIf you want to do something with the removed elements that requires ownership, you can use the <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#method.drain_filter\" rel=\"nofollow noreferrer\"><code>Vec.drain_filter</code></a> method. This method is only available in nightly rust at the time of writing.</p>\n\n<p>You can use it like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(drain_filter)]\n\nlet mut numbers = vec![1, 2, 3, 4, 5, 6, 8, 9, 11, 13, 14, 15];\nfor x in numbers.drain_filter(|x| non_trivial_function_returning_a_result(x).is_ok()) {\n  // Do something with x\n}\n</code></pre>\n\n<p>If you require ownership, but do not want to use nightly rust you can do it manually.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut i = 0;\nwhile i != vec.len() {\n    if non_trivial_function_returning_a_result(&amp;vec[i]).is_ok() {\n        let val = vec.remove(i);\n        // do something with val\n    } else {\n        i += 1;\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 193, "user_id": 1742297, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/e605fc8808fe1f7dda86aa86548dd21d?s=128&d=identicon&r=PG", "display_name": "ericcire", "link": "https://stackoverflow.com/users/1742297/ericcire"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 153, "favorite_count": 0, "accepted_answer_id": 57705314, "answer_count": 1, "score": 1, "last_activity_date": 1567150259, "creation_date": 1567062552, "question_id": 57704830, "link": "https://stackoverflow.com/questions/57704830/is-vector-into-iter-filtersome-non-trivial-function-collect-acceptable", "title": "is vector.into_iter().filter(some_non_trivial_function).collect() acceptable", "body": "<p>So if I have a <code>mut v: Vec&lt;Foo&gt;</code> and I want to maintain only the alive ones</p>\n\n<p>I would do</p>\n\n<pre><code>v = v.into_iter().filter(|&amp;foo| non_trivial_function_returning_a_result(foo).is_ok()).collect()\n</code></pre>\n\n<p>Will there be a new vector being allocated and then the original one destroyed?\nWhat would be a better way to do this?</p>\n"}, {"tags": ["rust", "lifetime"], "answers": [{"comments": [{"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567068255, "post_id": 57705884, "comment_id": 101855165, "body": "<i>Which means that the result is either <code>()</code> or an <code>Error</code></i> No: it means that the result is either <code>T</code> or an <code>Error</code>, and that the default is <code>T = ()</code> if not specified. The OP is specifying that <code>T = i64</code>, which is perfectly valid."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1567068458, "post_id": 57705884, "comment_id": 101855271, "body": "Ooops, don&#39;t answer in the morning. Going to fix it."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1567070916, "post_id": 57705884, "comment_id": 101856505, "body": "@Jmb thanks, fixed. Did update the answer and I also found that it&#39;s impossible to use <code>WVResult&lt;i64&gt;</code>. <code>()</code> must be used, because of the <code>where</code> constraints like <code>I: FnMut(&amp;mut WebView&lt;T&gt;, &amp;str) -&gt; WVResult + &#39;a</code>."}, {"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1567071843, "post_id": 57705884, "comment_id": 101856939, "body": "I have added a new version on the end of the original post as it did not fit in a comment. Presumably, there is some issue with visibility in derived types.... Maybe I need to raise an issue against the crate."}, {"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1567072360, "post_id": 57705884, "comment_id": 101857230, "body": ".... Maybe I should change my strategy to use <code>WebView().user_data_mut()</code> for passing data (back) into the <code>WebView</code> instead of a return value from the invoke handler."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 1, "creation_date": 1567072497, "post_id": 57705884, "comment_id": 101857328, "body": "It&#39;s not about visibility. The implementation says <code>I: FnMut(&amp;mut WebView&lt;T&gt;, &amp;str) -&gt; WVResult + &#39;a</code>. It means that your handler must return <code>WVResult</code>, not <code>WVResult&lt;i64&gt;</code>. I&#39;d recommend to look at <a href=\"https://github.com/Boscop/web-view/tree/master/examples\" rel=\"nofollow noreferrer\">examples</a>."}, {"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1567074911, "post_id": 57705884, "comment_id": 101858668, "body": "It seems that the user_data is not visible from the JavaScript, so that won&#39;t work either... The go version has some code to Bind a Go object to the JavaScript, but that does not appear to be visible from C++ or Rust. Sorry, I seem to be getting off my original topic. I need to pursue this on a web_view issue somewhere."}], "tags": [], "owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "is_accepted": true, "score": 2, "last_activity_date": 1567070788, "last_edit_date": 1567070788, "creation_date": 1567066454, "answer_id": 57705884, "question_id": 57704706, "link": "https://stackoverflow.com/questions/57704706/i-am-getting-a-rust-compile-error-with-lifetimes/57705884#57705884", "title": "I am getting a rust compile error with lifetimes", "body": "<h2>Issues</h2>\n\n<h3><code>TestView</code></h3>\n\n<p>Your definition:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>type TestView = WebView&lt;UserData&gt;;\n</code></pre>\n\n<p><code>WebView</code> is defined as:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct WebView&lt;'a, T: 'a&gt; {\n    inner: *mut CWebView,\n    _phantom: PhantomData&lt;&amp;'a mut T&gt;,\n}\n</code></pre>\n\n<p>It expects lifetime and <code>T</code>, which must live as long as the lifetime. Fixed definition:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>type TestView&lt;'a&gt; = WebView&lt;'a, UserData&gt;;\n</code></pre>\n\n<h3><code>TestBuilder</code></h3>\n\n<p>Your definition:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>type TestBuilder&lt;'a&gt; = WebViewBuilder&lt; UserData: 'a,'a, \n         FnMut(&amp;mut TestView, &amp;str) -&gt; TestResult, String&gt;;\n</code></pre>\n\n<p><code>WebViewBuilder</code> is defined as:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct WebViewBuilder&lt;'a, T: 'a, I, C&gt;\n    pub title: &amp;'a str,\n    pub content: Option&lt;Content&lt;C&gt;&gt;,\n    pub width: i32,\n    pub height: i32,\n    pub resizable: bool,\n    pub debug: bool,\n    pub invoke_handler: Option&lt;I&gt;,\n    pub user_data: Option&lt;T&gt;,\n}\n</code></pre>\n\n<ul>\n<li><code>'a</code> lifetime must be first, you have it after <code>UserData</code></li>\n<li><code>UserData</code> expects lifetime -> <code>UserData&lt;'a&gt;</code>, not <code>UserData: 'a</code></li>\n<li><code>FnMut(...)</code> is a trait, which means that the size is not known at compile time, you have to wrap it with <code>Box</code>, use <code>fn</code>, ...</li>\n<li><code>C</code> is a <code>String</code> in your case, which means that you can't use <code>.content(\"hello\")</code>, because a) it expects <code>Content&lt;C&gt;</code>, b) even if you use <code>Content::Html(\"hello\")</code> it won't work, because it's <code>Content&lt;&amp;'static str&gt;</code> and you said that you want <code>Content&lt;String&gt;</code> -> <code>Content::Html(\"hello\".to_string())</code></li>\n</ul>\n\n<p>Fixed definition:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>type TestBuilder&lt;'a&gt; =\n    WebViewBuilder&lt;'a, UserData, Box&lt;dyn FnMut(&amp;mut TestView, &amp;str) -&gt; TestResult&gt;, String&gt;;\n</code></pre>\n\n<h3><code>WebViewBuilder</code></h3>\n\n<p>But even if you fix all these things, it won't work. Look at the <code>WebViewBuilder</code> implementations:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;'a, T: 'a, I, C&gt; Default for WebViewBuilder&lt;'a, T, I, C&gt;\nwhere\n    I: FnMut(&amp;mut WebView&lt;T&gt;, &amp;str) -&gt; WVResult + 'a,\n    C: AsRef&lt;str&gt;\n{...}\n</code></pre>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;'a, T: 'a, I, C&gt; WebViewBuilder&lt;'a, T, I, C&gt;\nwhere\n    I: FnMut(&amp;mut WebView&lt;T&gt;, &amp;str) -&gt; WVResult + 'a,\n    C: AsRef&lt;str&gt;,\n{...}\n</code></pre>\n\n<p>Especially this line:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>I: FnMut(&amp;mut WebView&lt;T&gt;, &amp;str) -&gt; WVResult + 'a\n</code></pre>\n\n<p>It expects <code>WVResult</code> (-> <code>Result&lt;(), Error&gt;</code>), which means that you can't use your <code>TestResult</code> (-> <code>WVResult&lt;i64&gt;</code> -> <code>Result&lt;i64, Error&gt;</code>). There're no other implementations in the source code.</p>\n\n<h2>An example</h2>\n\n<p>Working code, which does use your types, but the <code>TestResult</code> is just <code>WVResult</code> (<code>i64</code> -> <code>()</code>).</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use web_view::*;\n\nstruct UserData {}\n\ntype TestResult = WVResult;\n\ntype TestView&lt;'a&gt; = WebView&lt;'a, UserData&gt;;\n\ntype TestBuilder&lt;'a&gt; =\n    WebViewBuilder&lt;'a, UserData, Box&lt;dyn FnMut(&amp;mut TestView, &amp;str) -&gt; TestResult&gt;, String&gt;;\n\nfn main() {\n    let p = UserData {};\n\n    let wvb: TestBuilder = WebViewBuilder::new();\n    let webview: TestView = wvb\n        .title(\"Progress\")\n        .content(Content::Url(\n            \"https://en.m.wikipedia.org/wiki/Main_Page\".to_string(),\n        ))\n        .size(640, 960)\n        .resizable(true)\n        .debug(false)\n        .user_data(p)\n        .invoke_handler(Box::new(handler))\n        .build()\n        .unwrap();\n    let _res = webview.run().unwrap();\n}\n\nfn handler(_webview: &amp;mut TestView, _arg: &amp;str) -&gt; TestResult {\n    Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 117, "favorite_count": 0, "accepted_answer_id": 57705884, "answer_count": 1, "score": 1, "last_activity_date": 1567071341, "creation_date": 1567062061, "last_edit_date": 1567071341, "question_id": 57704706, "link": "https://stackoverflow.com/questions/57704706/i-am-getting-a-rust-compile-error-with-lifetimes", "title": "I am getting a rust compile error with lifetimes", "body": "<p>I am trying to get some rust code to compile, but I keep getting errors about types and lifetimes. Can anyone explain what I am doing wrong?</p>\n\n<p>I am getting an error in the compile: <code>associated type bindings must be declared after generic parameters</code>. I have tried, I think, all combinations of parameters and none of them seem to work.</p>\n\n<p>Here is a simplified version of my code.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>/*! test of lifetimes for compile */\nextern crate web_view;\nuse web_view::*;\nstruct UserData {}\n\ntype TestResult = WVResult&lt;i64&gt;;\ntype TestView = WebView&lt;UserData&gt;;\ntype TestBuilder&lt;'a&gt; = WebViewBuilder&lt; UserData: 'a,'a, \n         FnMut(&amp;mut TestView, &amp;str) -&gt; TestResult, String&gt;; // compile error\n\nfn main() {\n    let mut p = UserData {};\n    let wvb: TestBuilder = WebViewBuilder::new();\n    let mut webview: TestView = wvb\n        .title(\"Progress\")\n        .content(\"hello\")\n        .size(640, 960)\n        .resizable(true)\n        .debug(false)\n        .user_data(p)\n        .invoke_handler(handler)\n        .build()\n        .unwrap();\n    let _res = webview.run().unwrap();\n}\nfn handler(webview: &amp;mut TestView, arg: &amp;str) -&gt; TestResult {\n    Ok(1)\n}\n</code></pre>\n\n<p><em>This should be a comment, but it is too long to fit in a comment. I've used @zizka's answer, but restored my original version of TestResult. Now I am getting errors that \"function or associated item not found\" and \"no method named <code>title</code> found for type\"</em></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use web_view::*;\n\nstruct UserData {}\n\ntype TestResult = WVResult&lt;i64&gt;;\ntype TestView&lt;'a&gt; = WebView&lt;'a, UserData&gt;;\ntype TestBuilder&lt;'a&gt; =\n    WebViewBuilder&lt;'a, UserData, fn(&amp;mut TestView, &amp;str) -&gt; TestResult, &amp;'static str&gt;;\n\nfn main() {\n    let p = UserData {};\n\n    let builder: TestBuilder = TestBuilder::new(); // error here\n    let webview = builder\n        .title(\"Progress\") // error here\n        .content(Content::Url(\"https://en.m.wikipedia.org/wiki/Main_Page\"))\n        .size(640, 960)\n        .resizable(true)\n        .debug(false)\n        .user_data(p)\n        .invoke_handler(handler)\n        .build()\n        .unwrap();\n    webview.run().unwrap();\n}\n\nfn handler(_webview: &amp;mut TestView, _arg: &amp;str) -&gt; TestResult {\n    Ok(17 as i64)\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 7096, "user_id": 3990767, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0a5741a212e3b0e6bd46a8a1e6d76a4a?s=128&d=identicon&r=PG", "display_name": "SOFe", "link": "https://stackoverflow.com/users/3990767/sofe"}, "edited": false, "score": 1, "creation_date": 1567055877, "post_id": 57702434, "comment_id": 101849896, "body": "How do you expect Rust to know how you want to display the slice? Remember this is Display not Debug, and the display rules aren&#39;t just up to the compiler."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 7096, "user_id": 3990767, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0a5741a212e3b0e6bd46a8a1e6d76a4a?s=128&d=identicon&r=PG", "display_name": "SOFe", "link": "https://stackoverflow.com/users/3990767/sofe"}, "edited": false, "score": 1, "creation_date": 1567056720, "post_id": 57702434, "comment_id": 101850093, "body": "@SOFe read twice the question, the OP didn&#39;t talk blame std to not implement it"}], "owner": {"reputation": 2014, "user_id": 2138219, "user_type": "registered", "accept_rate": 71, "profile_image": "https://i.stack.imgur.com/KNoxN.jpg?s=128&g=1", "display_name": "francium", "link": "https://stackoverflow.com/users/2138219/francium"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 691, "favorite_count": 0, "closed_date": 1567060743, "answer_count": 0, "score": 1, "last_activity_date": 1567047799, "creation_date": 1567047799, "question_id": 57702434, "link": "https://stackoverflow.com/questions/57702434/how-do-you-implment-fmtdisplay-for-an-array-or-slice-of-type-t-in-rust", "closed_reason": "Duplicate", "title": "How do you Implment fmt::Display for an array or slice of type T in Rust?", "body": "<p>How do I implement <code>Display</code> for <code>[&amp;MyStruct]</code>?</p>\n\n<p>I've implemented <code>Display</code> for <code>MyStruct</code>,</p>\n\n<pre><code>impl fmt::Display for MyStruct {\n    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {\n        write!(f, ..., ...)\n    }\n}\n</code></pre>\n\n<p>This issue I'm running into is when I return a <code>[&amp;MyStruct]</code>, I can't print it,</p>\n\n<pre><code>11 |     println!(\"{}\", sliceOfMyStructs);\n   |                               ^^^^^^^^^ `[&amp;MyStruct]` cannot be formatted with the default formatter\n   |\n   = help: the trait `std::fmt::Display` is not implemented for `[&amp;MyStruct]`\n   = note: in format strings you may be able to use `{:?}` (or {:#?} for pretty-print) instead\n   = note: required because of the requirements on the impl of `std::fmt::Display` for `&amp;[&amp;MyStruct]`\n   = note: required by `std::fmt::Display::fmt`\n</code></pre>\n\n<p>What I've ready tried is (<code>MyStruct</code> is defined in my crate),</p>\n\n<pre><code>17 | impl fmt::Display for [MyStruct] {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ impl doesn't use types inside crate\n   |\n   = note: the impl does not reference only types defined in this crate\n   = note: define and implement a trait or new type instead\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 7096, "user_id": 3990767, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/0a5741a212e3b0e6bd46a8a1e6d76a4a?s=128&d=identicon&r=PG", "display_name": "SOFe", "link": "https://stackoverflow.com/users/3990767/sofe"}, "edited": false, "score": 2, "creation_date": 1567056323, "post_id": 57701914, "comment_id": 101849989, "body": "The number of generic arguments required by a struct is not known to the trait."}, {"owner": {"reputation": 9280, "user_id": 794457, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/2d564695b517c0a1080a887633a40b1e?s=128&d=identicon&r=PG", "display_name": "edwardw", "link": "https://stackoverflow.com/users/794457/edwardw"}, "edited": false, "score": 1, "creation_date": 1567074824, "post_id": 57701914, "comment_id": 101858612, "body": "<code>fn transform&lt;S&gt;(&amp;self, data: S) -&gt; impl Transformable&lt;S&gt;;</code> would be pretty close to what you want. But <code>impl Trait</code> can&#39;t be used in trait definition yet. I&#39;m not sure it will ever be supported either."}, {"owner": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567084831, "post_id": 57701914, "comment_id": 101864444, "body": "It&#39;s not possible to achieve this with <code>Self&lt;T&gt;</code>, <code>impl Transformable&lt;S&gt;</code>, <code>Box&lt;dyn Transformable&lt;S&gt;&gt;</code>, etc. I wrote quite a long answer and I discarded it, because you already know it.  What&#39;s wrong with associated types, like <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=62db48fffbf995277d9dc7d763526a59\" rel=\"nofollow noreferrer\">this playground</a>? Maybe you can elaborate more on the usage, how this is going to be used in the whole project and there can be another way how to achieve what you want?"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1567086967, "post_id": 57701914, "comment_id": 101865772, "body": "If <code>Self</code> is a type that isn&#39;t generic, what on earth would <code>Self&lt;S&gt;</code> mean?"}, {"owner": {"reputation": 41, "user_id": 2464047, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a5bc8ae210b5cc05d3d1ade518075648?s=128&d=identicon&r=PG", "display_name": "Craig D.", "link": "https://stackoverflow.com/users/2464047/craig-d"}, "reply_to_user": {"reputation": 17135, "user_id": 581190, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/a503f14866aaa083332c81264860ac8e?s=128&d=identicon&r=PG", "display_name": "zrzka", "link": "https://stackoverflow.com/users/581190/zrzka"}, "edited": false, "score": 0, "creation_date": 1567101418, "post_id": 57701914, "comment_id": 101872957, "body": "Thanks all for the comments noting that the trait doesn&#39;t know whether <code>Self</code> is generic - that makes total sense.  @zrzka I&#39;m trying something related to your playground&#39;s solution.  Thanks for the suggestion."}], "owner": {"reputation": 41, "user_id": 2464047, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a5bc8ae210b5cc05d3d1ade518075648?s=128&d=identicon&r=PG", "display_name": "Craig D.", "link": "https://stackoverflow.com/users/2464047/craig-d"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 911, "favorite_count": 0, "answer_count": 0, "score": 4, "last_activity_date": 1567042870, "creation_date": 1567042870, "question_id": 57701914, "link": "https://stackoverflow.com/questions/57701914/trait-method-which-returns-self-type-with-a-different-type-and-or-lifetime-par", "title": "Trait method which returns `Self`-type with a different type and/or lifetime parameter", "body": "<p>The Rust compiler doesn't allow specifying new type parameters on <code>Self</code> in the return types of trait methods.  That is, a trait method can return <code>Self</code>, but not <code>Self&lt;T&gt;</code>.  I'm interested in what the proper way is to accomplish the following; or if it's fundamentally impossible, then why that's the case.</p>\n\n<p>Suppose we have two structs as follows:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub struct SomeStruct&lt;T&gt; {\n    id: usize,\n    description: String,\n    extra_data: T,\n}\n\npub struct OtherStruct&lt;T&gt; {\n    permit_needed: bool,\n    registration_number: usize,\n    extra_data: T,\n}\n</code></pre>\n\n<p>Both of these structs have an <code>extra_data</code> field of type <code>T</code>, where <code>T</code> is a generic type parameter.  We can implement methods such as <code>get_extra_data()</code>, and more interestingly, <code>transform()</code>, on both structs:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>impl&lt;T&gt; SomeStruct&lt;T&gt; {\n    pub fn get_extra_data(&amp;self) -&gt; &amp;T {\n        &amp;self.extra_data\n    }\n\n    pub fn transform&lt;S&gt;(&amp;self, data: S) -&gt; SomeStruct&lt;S&gt; {\n        SomeStruct {\n            id: self.id,\n            description: self.description.clone(),\n            extra_data: data,\n        }\n    }\n}\n\nimpl&lt;T&gt; OtherStruct&lt;T&gt; {\n    pub fn get_extra_data(&amp;self) -&gt; &amp;T {\n        &amp;self.extra_data\n    }\n\n    pub fn transform&lt;S&gt;(&amp;self, data: S) -&gt; OtherStruct&lt;S&gt; {\n        OtherStruct {\n            permit_needed: self.permit_needed,\n            registration_number: self.registration_number,\n            extra_data: data,\n        }\n    }\n}\n</code></pre>\n\n<p>But I'm having trouble creating a trait <code>Transformable</code> that unifies these two types with respect to these operations:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>\ntrait Transformable&lt;T&gt; {\n    fn get_extra_data(&amp;self) -&gt; &amp;T;\n    fn transform&lt;S&gt;(&amp;self, data: S) -&gt; Self&lt;S&gt;;\n}\n</code></pre>\n\n<p>The <code>transform()</code> function needs to return something of the same type as <code>Self</code>, just with a different type parameter.  Unfortunately, the rust compiler rejects this with the error message <code>E0109: type arguments are not allowed for this type</code>.</p>\n\n<p>Even the weaker signature <code>fn transform&lt;S&gt;(&amp;self, data: S) -&gt; impl Transformable&lt;S&gt;</code> is rejected, with error <code>E0562: impl Trait not allowed outside of function and inherent method return types</code>. The traditional solution here, to my knowledge, would be to return an associated type instead of an <code>impl</code>, but that would require generic associated types in this case.  And at any rate that would seem much more roundabout than the stronger <code>Self&lt;S&gt;</code> signature which is what we really want.</p>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b1d13b0a172119e90d59d026eef709b8\" rel=\"nofollow noreferrer\">Playground link with the above code</a></p>\n\n<p>An analogous problem happens exactly the same way with lifetime parameters.  I'm actually more interested in the lifetime parameters case, but I thought the type parameters case might be easier to understand and talk about, and also make it clear that the issue isn't lifetime-specific.</p>\n"}]