[{"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1528904261, "post_id": 50841088, "comment_id": 88685955, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/50841088/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Specifically, we don&#39;t know what <code>Config</code> is. Does it need to be a custom type, or can you use something built in to the language? What is <code>content</code>, could it just be a string literal? Ideally, produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a>."}], "answers": [{"comments": [{"owner": {"reputation": 1787, "user_id": 1822033, "user_type": "registered", "accept_rate": 45, "profile_image": "https://www.gravatar.com/avatar/53b51a609d2156118fcd08e2a7caebd3?s=128&d=identicon&r=PG", "display_name": "Pascal", "link": "https://stackoverflow.com/users/1822033/pascal"}, "edited": false, "score": 1, "creation_date": 1528905583, "post_id": 50841367, "comment_id": 88686695, "body": "Thank you for your detailed answer. I don&#39;t know why you are unsatisfied with my question and at the same time you answered it perfectly!"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "reply_to_user": {"reputation": 1787, "user_id": 1822033, "user_type": "registered", "accept_rate": 45, "profile_image": "https://www.gravatar.com/avatar/53b51a609d2156118fcd08e2a7caebd3?s=128&d=identicon&r=PG", "display_name": "Pascal", "link": "https://stackoverflow.com/users/1822033/pascal"}, "edited": false, "score": 5, "creation_date": 1528906302, "post_id": 50841367, "comment_id": 88687144, "body": "@Pascal Because Shep guess your problem that doesn&#39;t make your question good."}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1528937584, "post_id": 50841367, "comment_id": 88699638, "body": "@Stargateur This comment isn&#39;t helpful to the OP; other people please don&#39;t upvote &#39;telling people off&#39; comments like this. Come on people; constructive feedback. &#39;Your question was bad&#39; contributes nothing."}, {"owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "reply_to_user": {"reputation": 1787, "user_id": 1822033, "user_type": "registered", "accept_rate": 45, "profile_image": "https://www.gravatar.com/avatar/53b51a609d2156118fcd08e2a7caebd3?s=128&d=identicon&r=PG", "display_name": "Pascal", "link": "https://stackoverflow.com/users/1822033/pascal"}, "edited": false, "score": 0, "creation_date": 1528937712, "post_id": 50841367, "comment_id": 88699658, "body": "@Pascal it&#39;s very difficult to guess what exactly you were asking in this question; see shepmasters comment on it; in general questions with a bit more detail are much easier to answer. A rust play pen example would have made answering it a lot easier."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "edited": false, "score": 2, "creation_date": 1528940086, "post_id": 50841367, "comment_id": 88700056, "body": "@Doug I don&#39;t think this was a &quot;telling off&quot; comment, it feels like a direct response to &quot;why you are unsatisfied with my question and at the same time you answered it&quot;. It&#39;s true: just because a person could build a MCVE from the original question in order to answer it doesn&#39;t make the original question good. OP already has some suggestions on how to improve their question and has chosen to ignore those suggestions."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 1787, "user_id": 1822033, "user_type": "registered", "accept_rate": 45, "profile_image": "https://www.gravatar.com/avatar/53b51a609d2156118fcd08e2a7caebd3?s=128&d=identicon&r=PG", "display_name": "Pascal", "link": "https://stackoverflow.com/users/1822033/pascal"}, "edited": false, "score": 3, "creation_date": 1528940127, "post_id": 50841367, "comment_id": 88700068, "body": "@Pascal and downvotes can always be removed when the underlying cause of the downvoting is removed; it&#39;s rarely too late to improve a question."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1528904896, "creation_date": 1528904896, "answer_id": 50841367, "question_id": 50841088, "link": "https://stackoverflow.com/questions/50841088/how-do-i-specify-a-type-that-cannot-be-inferred-when-using-if-let/50841367#50841367", "title": "How do I specify a type that cannot be inferred when using if let?", "body": "<p>This has nothing to do with the <code>match</code> or the <code>if let</code>; the type specification is provided by the assignment to <code>result</code>. This version with <code>if let</code> works:</p>\n\n<pre><code>extern crate toml;\n\nfn main() {\n    let result: Result&lt;i32, _&gt; = toml::from_str(\"\");\n    if let Ok(config) = result {\n        // ... \n    }\n}\n</code></pre>\n\n<p>This version with <code>match</code> does not:</p>\n\n<pre><code>extern crate toml;\n\nfn main() {\n    match toml::from_str(\"\") {\n        Ok(config) =&gt; {}\n        _ =&gt; {}\n    }\n}\n</code></pre>\n\n<p>In most cases, you'll actually <em>use</em> the success value. Based on the usage, the compiler can infer the type and you don't need any type specification:</p>\n\n<pre><code>fn something(_: i32) {}\n\nmatch toml::from_str(\"\") {\n    Ok(config) =&gt; something(config),\n    _ =&gt; {}\n}\n\nif let Ok(config) = toml::from_str(\"\") {\n    something(config);\n}\n</code></pre>\n\n<p>If for some reason you need to perform the conversion but not use the value, you can use the <em>turbofish</em> on the function call:</p>\n\n<pre><code>match toml::from_str::&lt;i32&gt;(\"\") {\n//                  ^^^^^^^\n    Ok(config) =&gt; {},\n    _ =&gt; {}\n}\n\nif let Ok(config) = toml::from_str::&lt;i32&gt;(\"\") {\n    //                            ^^^^^^^\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/41882151/155423\">How do I imply the type of the value when there are no type parameters or ascriptions?</a></li>\n</ul>\n"}], "owner": {"reputation": 1787, "user_id": 1822033, "user_type": "registered", "accept_rate": 45, "profile_image": "https://www.gravatar.com/avatar/53b51a609d2156118fcd08e2a7caebd3?s=128&d=identicon&r=PG", "display_name": "Pascal", "link": "https://stackoverflow.com/users/1822033/pascal"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1285, "favorite_count": 0, "accepted_answer_id": 50841367, "answer_count": 1, "score": 0, "last_activity_date": 1528904959, "creation_date": 1528903945, "last_edit_date": 1528904959, "question_id": 50841088, "link": "https://stackoverflow.com/questions/50841088/how-do-i-specify-a-type-that-cannot-be-inferred-when-using-if-let", "title": "How do I specify a type that cannot be inferred when using if let?", "body": "<p>I want to write the following with <code>if let</code> but <code>Ok(config)</code> does not provide the type for <code>toml::from_str</code></p>\n\n<pre><code>let result: Result&lt;Config, _&gt; = toml::from_str(content.as_str());\nmatch result {\n    Ok(config) =&gt; {}\n    _ =&gt; {}\n}\n\n// if let Ok(config) = toml::from_str(content.as_str()) {\n//    \n// }\n</code></pre>\n\n<p>I tried <code>Ok(config: Config)</code> without luck. The success type is not inferred.</p>\n"}, {"tags": ["rust", "rust-diesel"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528900827, "post_id": 50838572, "comment_id": 88683738, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/49092437/155423\">How do I implement Queryable and Insertable for custom field types in Diesel?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50838572/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1, "user_id": 6903282, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9c47ca1cbac0809bef1b1474e0047b24?s=128&d=identicon&r=PG&f=1", "display_name": "emunMuc", "link": "https://stackoverflow.com/users/6903282/emunmuc"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528902492, "post_id": 50838572, "comment_id": 88684886, "body": "Thanks a lot for bringing me back to this post ;). I tried it before, but came across the the post from one of the maintainers. It seem that I was missing the <code>#[sql_type = &quot;Integer&quot;]</code> tag in my code. Can anyone elaborate on what it is used for ?  @Shepmaster please mark it as answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528903141, "post_id": 50838572, "comment_id": 88685285, "body": "I added some links to the duplicate answer about <code>sql_type</code>. TL;DR, that&#39;s how Diesel knows what underlying format to store the data in the database."}], "owner": {"reputation": 1, "user_id": 6903282, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9c47ca1cbac0809bef1b1474e0047b24?s=128&d=identicon&r=PG&f=1", "display_name": "emunMuc", "link": "https://stackoverflow.com/users/6903282/emunmuc"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 160, "favorite_count": 0, "closed_date": 1528902671, "answer_count": 0, "score": 0, "last_activity_date": 1528900716, "creation_date": 1528896725, "last_edit_date": 1528900716, "question_id": 50838572, "link": "https://stackoverflow.com/questions/50838572/implement-asexpression-and-fromsqlrow-for-a-custom-type", "closed_reason": "Duplicate", "title": "Implement AsExpression and FromSqlRow for a custom type", "body": "<p>I am using:</p>\n\n<pre><code>diesel = { version = \"1.3.0\", features = [\"postgres\", \"chrono\"] }\n</code></pre>\n\n<p>The struct <code>Payment</code> contains a custom type <code>CentAmount</code>. To make the containing struct insertable, I have implemented </p>\n\n<ul>\n<li><code>AsExpression</code></li>\n<li><code>FromSqlRow</code></li>\n</ul>\n\n<p>as described in <a href=\"https://github.com/diesel-rs/diesel/pull/429#issuecomment-278367893\" rel=\"nofollow noreferrer\">Simplify the support of custom types</a>:</p>\n\n<pre><code>use diesel::expression::AsExpression;\nuse diesel::helper_types::AsExprOf;\nuse diesel::pg::Pg;\nuse diesel::row::Row;\nuse diesel::sql_types::{Integer, Nullable};\nuse diesel::types::FromSqlRow;\nuse std::error::Error;\n\n#[derive(Serialize, Deserialize, Debug, PartialEq, Clone, Copy)]\npub struct CentAmount {\n    cents: i32,\n}\n\nimpl CentAmount {\n    pub fn new(cents: i32) -&gt; Self {\n        assert!(cents &gt;= 0);\n        CentAmount { cents: cents }\n    }\n}\n\nimpl&lt;'a&gt; AsExpression&lt;Nullable&lt;Integer&gt;&gt; for &amp;'a CentAmount {\n    type Expression = AsExprOf&lt;i32, Nullable&lt;Integer&gt;&gt;;\n\n    fn as_expression(self) -&gt; Self::Expression {\n        AsExpression::&lt;Nullable&lt;Integer&gt;&gt;::as_expression(self.cents)\n    }\n}\n\nimpl FromSqlRow&lt;Integer, Pg&gt; for CentAmount {\n    fn build_from_row&lt;R: Row&lt;Pg&gt;&gt;(row: &amp;mut R) -&gt; Result&lt;Self, Box&lt;Error + Send + Sync&gt;&gt; {\n        let cents = i32::build_from_row(row)?;\n        Ok(CentAmount { cents })\n    }\n}\n</code></pre>\n\n<p>The struct is used here</p>\n\n<pre><code>#[derive(Queryable, Debug, Getters, Serialize, Deserialize, PartialEq, Insertable)]\n#[table_name = \"payments\"]\npub struct Payment {\n    pub id: Option&lt;i32&gt;,\n    amount: CentAmount,\n    leistung_id: i32,\n    beschaeftiger_id: i32,\n    payment_state: PaymentState,\n    approval_date: Option&lt;DateTime&lt;Local&gt;&gt;,\n}\n</code></pre>\n\n<p>I still get the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>the trait `diesel::Expression` is not implemented for `model::cent_amount::CentAmount`\n</code></pre>\n\n<p>What am I missing?</p>\n"}, {"tags": ["docker", "rust", "rust-cargo"], "comments": [{"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 1, "creation_date": 1528878394, "post_id": 50832375, "comment_id": 88668942, "body": "Please provide more details (system, configuration, a reproducible and minimal example). Cargo usually caches crate downloads globally and builds per project(crate); at least on the systems I have been working on."}, {"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "reply_to_user": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 0, "creation_date": 1528878783, "post_id": 50832375, "comment_id": 88669163, "body": "Ok then. My builds are on dockers which must be causing the downloads again and again."}, {"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 0, "creation_date": 1528878851, "post_id": 50832375, "comment_id": 88669196, "body": "This sounds plausible. I have no experience with docker, though."}, {"owner": {"reputation": 655, "user_id": 2494631, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/DCC31.jpg?s=128&g=1", "display_name": "vijoc", "link": "https://stackoverflow.com/users/2494631/vijoc"}, "edited": false, "score": 4, "creation_date": 1528882461, "post_id": 50832375, "comment_id": 88671444, "body": "This is not an issue with Cargo, but Docker. You should provide the relevant bits of your <code>Dockerfile</code> for further context."}, {"owner": {"reputation": 2865, "user_id": 171520, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/3da837d1227e7df8153c68d502f64994?s=128&d=identicon&r=PG", "display_name": "Dave Challis", "link": "https://stackoverflow.com/users/171520/dave-challis"}, "edited": false, "score": 0, "creation_date": 1528883636, "post_id": 50832375, "comment_id": 88672269, "body": "This question has some useful/relevant info which might help: <a href=\"https://stackoverflow.com/questions/42130132/can-cargo-download-and-build-dependencies-without-also-building-the-application\" title=\"can cargo download and build dependencies without also building the application\">stackoverflow.com/questions/42130132/&hellip;</a>"}], "owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 659, "favorite_count": 0, "closed_date": 1528897673, "answer_count": 0, "score": 4, "last_activity_date": 1528898730, "creation_date": 1528878033, "last_edit_date": 1528898730, "question_id": 50832375, "link": "https://stackoverflow.com/questions/50832375/how-do-i-cache-rust-crates-locally-when-using-docker", "closed_reason": "Duplicate", "title": "How do I cache Rust crates locally when using Docker?", "body": "<p>When using Cargo to build my Rust project, it downloads and compiles all the crates each time I trigger  <code>cargo build</code>.</p>\n\n<p>Is there no way to cache these libraries and speedup my build process?</p>\n\n<p>I am running this on an Ubuntu 16.04 machine and using Docker to run my builds in. I guess there needs to be some mounted directory to share across builds which could solve my problem. </p>\n"}, {"tags": ["rust", "abi"], "comments": [{"owner": {"reputation": 60956, "user_id": 8922, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/f1634a09333f7b391db92e1d2bea6253?s=128&d=identicon&r=PG", "display_name": "Sebastian Redl", "link": "https://stackoverflow.com/users/8922/sebastian-redl"}, "edited": false, "score": 0, "creation_date": 1528880473, "post_id": 50831171, "comment_id": 88670155, "body": "Why do you need your Windows version to be stdcall? You can just use cdecl (i.e. &quot;C&quot;) in 32-bit without issues if the C-side declaration matches. And under 64-bit, stdcall doesn&#39;t do anything anymore."}, {"owner": {"reputation": 565, "user_id": 4134285, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dd7fa06bc906a5f0ce87225388bb7140?s=128&d=identicon&r=PG&f=1", "display_name": "xakdog", "link": "https://stackoverflow.com/users/4134285/xakdog"}, "reply_to_user": {"reputation": 60956, "user_id": 8922, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/f1634a09333f7b391db92e1d2bea6253?s=128&d=identicon&r=PG", "display_name": "Sebastian Redl", "link": "https://stackoverflow.com/users/8922/sebastian-redl"}, "edited": false, "score": 0, "creation_date": 1528881547, "post_id": 50831171, "comment_id": 88670815, "body": "It\u2019s a 32bit binary and I have no acces to source code. It expecting stdcall and crashes on cdecl."}, {"owner": {"reputation": 60956, "user_id": 8922, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/f1634a09333f7b391db92e1d2bea6253?s=128&d=identicon&r=PG", "display_name": "Sebastian Redl", "link": "https://stackoverflow.com/users/8922/sebastian-redl"}, "edited": false, "score": 0, "creation_date": 1528886958, "post_id": 50831171, "comment_id": 88674373, "body": "So you&#39;re writing a plugin for an existing program?"}, {"owner": {"reputation": 565, "user_id": 4134285, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dd7fa06bc906a5f0ce87225388bb7140?s=128&d=identicon&r=PG&f=1", "display_name": "xakdog", "link": "https://stackoverflow.com/users/4134285/xakdog"}, "reply_to_user": {"reputation": 60956, "user_id": 8922, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/f1634a09333f7b391db92e1d2bea6253?s=128&d=identicon&r=PG", "display_name": "Sebastian Redl", "link": "https://stackoverflow.com/users/8922/sebastian-redl"}, "edited": false, "score": 0, "creation_date": 1528891467, "post_id": 50831171, "comment_id": 88677283, "body": "Yes, it\u2019s plugin for existing program"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528899551, "post_id": 50831171, "comment_id": 88682832, "body": "TL;DR: more macros."}, {"owner": {"reputation": 565, "user_id": 4134285, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dd7fa06bc906a5f0ce87225388bb7140?s=128&d=identicon&r=PG&f=1", "display_name": "xakdog", "link": "https://stackoverflow.com/users/4134285/xakdog"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528918536, "post_id": 50831171, "comment_id": 88693359, "body": "@Shepmaster funny, but not clean."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528918653, "post_id": 50831171, "comment_id": 88693430, "body": "@xakdog no humor intended \u2014 macros are a primary solution to avoid repetition when existing abstractions aren&#39;t powerful enough."}, {"owner": {"reputation": 565, "user_id": 4134285, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dd7fa06bc906a5f0ce87225388bb7140?s=128&d=identicon&r=PG&f=1", "display_name": "xakdog", "link": "https://stackoverflow.com/users/4134285/xakdog"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1531117366, "post_id": 50831171, "comment_id": 89457284, "body": "@Shepmaster finally I found a <code>&quot;system&quot;</code> convention that will interpreted as &quot;stdcall&quot; on win32 <a href=\"https://doc.rust-lang.org/book/first-edition/ffi.html#foreign-calling-conventions\" rel=\"nofollow noreferrer\">doc.rust-lang.org/book/first-edition/&hellip;</a>  May be it&#39;s not an duplicate?"}], "owner": {"reputation": 565, "user_id": 4134285, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/dd7fa06bc906a5f0ce87225388bb7140?s=128&d=identicon&r=PG&f=1", "display_name": "xakdog", "link": "https://stackoverflow.com/users/4134285/xakdog"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 74, "favorite_count": 0, "closed_date": 1528899527, "answer_count": 0, "score": 3, "last_activity_date": 1528899513, "creation_date": 1528874129, "last_edit_date": 1528899513, "question_id": 50831171, "link": "https://stackoverflow.com/questions/50831171/how-can-i-change-a-functions-abi-based-on-the-target-operating-system", "closed_reason": "Duplicate", "title": "How can I change a functions ABI based on the target operating system?", "body": "<p>I am writing a cross-platform library in Rust where I need to use specific ABI strings for Windows and Unix. My current solution is:</p>\n\n<pre><code>#[macro_export]\nmacro_rules! create_plugin {\n    (@internal $name:ident) =&gt; {\n        #[no_mangle]\n        #[cfg(target_os = \"windows\")]\n        pub unsafe extern \"stdcall\" fn Test(data: *const *const u32) -&gt; bool {\n            // Source 1\n        }\n\n        #[no_mangle]\n        #[cfg(not(target_os = \"windows\"))]\n        pub unsafe extern \"C\" fn Test(data: *const *const u32) -&gt; bool {\n            // Source 1 (duplicate)\n        }\n    }\n\n    // ...\n}\n</code></pre>\n\n<p>Is there any way to reduce the copy-and-pasted code in definitions?</p>\n"}, {"tags": ["rust", "rust-tokio"], "comments": [{"owner": {"reputation": 113, "user_id": 1257888, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/66f5dee76de2cb83b24c7e3dad8f294d?s=128&d=identicon&r=PG", "display_name": "a1ien", "link": "https://stackoverflow.com/users/1257888/a1ien"}, "edited": false, "score": 1, "creation_date": 1528842832, "post_id": 50825350, "comment_id": 88658177, "body": "Hmm... Very odd. I play with code. if I remove <code>bytes.reserve(1024);</code> then periodically I get a full message. It is very likely that we need to add some condition to check message size"}, {"owner": {"reputation": 608, "user_id": 1907543, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/7597ff99ee5f0704208709c3d17d9f33?s=128&d=identicon&r=PG", "display_name": "daboross", "link": "https://stackoverflow.com/users/1907543/daboross"}, "edited": false, "score": 0, "creation_date": 1528843001, "post_id": 50825350, "comment_id": 88658224, "body": "I have 90% an answer, will post it shortly. I think I was wrong in my previous comment, which is why I deleted it."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528855399, "post_id": 50825350, "comment_id": 88660798, "body": "Please do not put <i>answers</i> in your <i>question</i>. You are welcome to answer your own question below and even accept that answer. This is better because it allows additional answers and those answers to be voted on by the community."}], "answers": [{"comments": [{"owner": {"reputation": 113, "user_id": 1257888, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/66f5dee76de2cb83b24c7e3dad8f294d?s=128&d=identicon&r=PG", "display_name": "a1ien", "link": "https://stackoverflow.com/users/1257888/a1ien"}, "edited": false, "score": 1, "creation_date": 1528844024, "post_id": 50826808, "comment_id": 88658460, "body": "read_exact solves another problem. So we always wait for the exact size. And here&#39;s how to read exactly what&#39;s going on when reading as in blocking mode. As far as I know it is the message of empty can not be (in any case, they do not get into the user space)"}], "tags": [], "owner": {"reputation": 608, "user_id": 1907543, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/7597ff99ee5f0704208709c3d17d9f33?s=128&d=identicon&r=PG", "display_name": "daboross", "link": "https://stackoverflow.com/users/1907543/daboross"}, "is_accepted": false, "score": 0, "last_activity_date": 1528843225, "creation_date": 1528843225, "answer_id": 50826808, "question_id": 50825350, "link": "https://stackoverflow.com/questions/50825350/how-do-i-read-a-single-packet-from-tcpstream-using-tokio/50826808#50826808", "title": "How do I read a single packet from TcpStream using Tokio?", "body": "<p>If your goal is really to receive one packet, I think you've succeeded!</p>\n\n<p>I've tested the program a few times, and I get a response. I'm testing with:</p>\n\n<pre><code>nc 127.0.0.1 8080 &lt;&lt;&lt; hello\n</code></pre>\n\n<p>After running that a few times, I get the following output:</p>\n\n<pre><code>Listening on: 0.0.0.0:8080\nbytes: [104, 101, 108, 108, 111, 10]\nbytes: []\nbytes: [104, 101, 108, 108, 111, 10]\nbytes: []\nbytes: [104, 101, 108, 108, 111, 10]\nbytes: []\nbytes: [104, 101, 108, 108, 111, 10]\nbytes: [104, 101, 108, 108, 111, 10]\n</code></pre>\n\n<p>As you can see, sometimes we have data ready, and sometimes we don't. I think in your testing you've just been unlucky and only gotten TCP responses before any data has been sent?</p>\n\n<p>I'm about 90% sure that TCP streams can include empty packets, and this is what we're seeing. (if someone has more knowledge here, feel free to edit the answer or comment).</p>\n\n<hr>\n\n<p>To fix your program you might want to reconsider your goal.</p>\n\n<p>Reading one TCP packet seems rarely helpful. Instead, generally, you want to read some amount of bytes and process the data as it comes. My understanding of TCP is as a stream of bytes, not really a stream of packets. The packets are just a way to get bytes from one place to another, and they could be any length without breaking compatibility. \"One packet\" is a fairly nebulous concept.</p>\n\n<p>Here's an example reading the first 16 bytes of the stream using the <a href=\"https://docs.rs/tokio/0/tokio/io/fn.read_exact.html\" rel=\"nofollow noreferrer\"><code>tokio::io::read_exact</code></a> function:</p>\n\n<pre><code>extern crate tokio;\n\nuse tokio::net::TcpListener;\nuse tokio::prelude::*;\n\nuse std::net::SocketAddr;\n\nfn main() {\n    let addr = \"0.0.0.0:8080\".parse::&lt;SocketAddr&gt;().unwrap();\n    let socket = TcpListener::bind(&amp;addr).unwrap();\n    println!(\"Listening on: {}\", addr);\n\n    let done = socket\n        .incoming()\n        .map_err(|e| println!(\"failed to accept socket; error = {:?}\", e))\n        .for_each(move |mut socket| {\n            // this function deals with bytes a bit differently and will just fill the\n            // buffer exactly rather than adding onto the end.\n            let mut bytes = vec![0; 16];\n            let processor = tokio::io::read_exact(socket, bytes)\n                .and_then(move |(socket, bytes)| {\n                    println!(\"bytes: {:?}\", bytes);\n                    Ok(())\n                })\n                .map_err(|_| ());\n            tokio::spawn(processor)\n        });\n    tokio::run(done);\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 113, "user_id": 1257888, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/66f5dee76de2cb83b24c7e3dad8f294d?s=128&d=identicon&r=PG", "display_name": "a1ien", "link": "https://stackoverflow.com/users/1257888/a1ien"}, "is_accepted": false, "score": 1, "last_activity_date": 1528873023, "creation_date": 1528873023, "answer_id": 50830844, "question_id": 50825350, "link": "https://stackoverflow.com/questions/50825350/how-do-i-read-a-single-packet-from-tcpstream-using-tokio/50830844#50830844", "title": "How do I read a single packet from TcpStream using Tokio?", "body": "<p>For myself, I almost found the answer. Very helpful <a href=\"https://stackoverflow.com/questions/46836933/how-can-i-read-from-a-tokio-tcp-connection-without-using-the-tokio-proto-crate\">Similar question</a>.\n</p>\n\n<pre><code>struct AsWeGetIt&lt;R&gt;(R);\n\nimpl&lt;R&gt; Stream for AsWeGetIt&lt;R&gt;\n    where\n        R: AsyncRead,\n{\n    type Item = BytesMut;\n    type Error = std::io::Error;\n\n    fn poll(&amp;mut self) -&gt; Poll&lt;Option&lt;Self::Item&gt;, Self::Error&gt; {\n        let mut buf = BytesMut::with_capacity(1000);\n\n        self.0\n            .read_buf(&amp;mut buf)\n            .map(|async| async.map(|_| Some(buf)))\n    }\n}\n....\nlet processor = AsWeGetIt(socket).into_future()\n.and_then(|(bytes,_)|  {\n    println!(\"bytes: {:?}\", bytes);\n    Ok(())\n}).map_err(|_| ());\n</code></pre>\n\n<p>But for a better understanding how to do without a separate structure ...\nAnd why and what is the map using?</p>\n"}], "owner": {"reputation": 113, "user_id": 1257888, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/66f5dee76de2cb83b24c7e3dad8f294d?s=128&d=identicon&r=PG", "display_name": "a1ien", "link": "https://stackoverflow.com/users/1257888/a1ien"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2189, "favorite_count": 0, "answer_count": 2, "score": 0, "last_activity_date": 1528873023, "creation_date": 1528835189, "last_edit_date": 1528872998, "question_id": 50825350, "link": "https://stackoverflow.com/questions/50825350/how-do-i-read-a-single-packet-from-tcpstream-using-tokio", "title": "How do I read a single packet from TcpStream using Tokio?", "body": "<p>I'm trying to receive a single data packet using tokio:</p>\n\n<pre><code>extern crate tokio;\nextern crate tokio_io;\n\nuse tokio::net::{TcpListener};\nuse tokio::prelude::*;\n\nuse std::net::SocketAddr;\nfn main() {\n    let addr = \"0.0.0.0:8080\".parse::&lt;SocketAddr&gt;().unwrap();\n    let socket = TcpListener::bind(&amp;addr).unwrap();\n    println!(\"Listening on: {}\", addr);\n\n    let done = socket\n        .incoming()\n        .map_err(|e| println!(\"failed to accept socket; error = {:?}\", e))\n        .for_each(move |mut socket| {\n            let mut bytes = vec![];\n            bytes.reserve(1024);\n            let processor = socket.read_buf(&amp;mut bytes).into_future()\n                .and_then(move |_size| {\n                    println!(\"bytes: {:?}\", bytes);\n                    Ok(())\n                })\n                .map_err(|_| ());;\n            tokio::spawn(processor)\n        });\n    tokio::run(done);\n}\n</code></pre>\n\n<p>This code prints an empty packet. How do I change this code to print the received packet with data?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528833561, "post_id": 50824801, "comment_id": 88654745, "body": "I believe your first question is answered by the question and answers of <a href=\"https://stackoverflow.com/q/28799372/155423\">When should I not implement a trait for references to implementors of that trait?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50824801/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528834323, "post_id": 50824801, "comment_id": 88655091, "body": "Thanks, the second question is solved by your first comment! I&#39;ll edit out that part of the question, but I&#39;m still not sure how to solve the first part, even with that suggestion you linked."}], "answers": [{"comments": [{"owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "edited": false, "score": 0, "creation_date": 1528837324, "post_id": 50825693, "comment_id": 88656391, "body": "Thanks, I&#39;ve just tried this, but it still doesn&#39;t seem to work. <code>AwesomeTrait + std::marker::Send does not have a constant size known at compile-time</code>."}], "tags": [], "owner": {"reputation": 211, "user_id": 3324584, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/513bd5a12e7f8383e8af652dd3a3114d?s=128&d=identicon&r=PG&f=1", "display_name": "Ki Chjang", "link": "https://stackoverflow.com/users/3324584/ki-chjang"}, "is_accepted": false, "score": 0, "last_activity_date": 1528836844, "creation_date": 1528836844, "answer_id": 50825693, "question_id": 50824801, "link": "https://stackoverflow.com/questions/50824801/sending-vecboxtrait-over-channel/50825693#50825693", "title": "Sending Vec&lt;Box&lt;Trait&gt;&gt; over channel", "body": "<p>You'll most likely want to dereference the <code>Box&lt;Trait&gt;</code> in order to get back out a <code>Trait</code>, but this is obviously an unsized type, so you'll immediately need to make a reference out of it like so:</p>\n\n<pre><code>K::abc(&amp;*something)\n</code></pre>\n\n<p>But wait! <code>iter()</code> does not consume ownership of the <code>Vec&lt;Box&lt;Trait&gt;&gt;</code>, and so every element is of type <code>&amp;Box&lt;Trait&gt;</code>. To solve this, we'll need to call <code>into_iter()</code> instead:</p>\n\n<pre><code>for something in somethings.list.into_iter() {\n    K::abc(&amp;*something);\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 211, "user_id": 3324584, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/513bd5a12e7f8383e8af652dd3a3114d?s=128&d=identicon&r=PG&f=1", "display_name": "Ki Chjang", "link": "https://stackoverflow.com/users/3324584/ki-chjang"}, "edited": false, "score": 1, "creation_date": 1528839650, "post_id": 50825879, "comment_id": 88657198, "body": "Heh, I was missing the ?Sized bound on my answer, thanks for including that!"}, {"owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "edited": false, "score": 0, "creation_date": 1528846483, "post_id": 50825879, "comment_id": 88659045, "body": "Wow, thank you for the awesome explanation, it works and makes a lot of sense! Out of curiosity, is this something that comes naturally after using Rust for a longer period of time? It seems kinda hard to remember all these things. It feels like I have to check the docs for every 2nd function I would like to use."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "edited": false, "score": 1, "creation_date": 1528846715, "post_id": 50825879, "comment_id": 88659084, "body": "@Andrew: Yes, I&#39;ve struggled for some time with Rust, but then, one day it clicked into place in my head and suddenly it all made sense. Now when I program in any other language I find them clumsy and unreliable ;-). Mind you, I still have to check the stdlib docs every 2nd function, but now what I read totally makes sense to me."}], "tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 3, "last_activity_date": 1528958290, "last_edit_date": 1528958290, "creation_date": 1528837884, "answer_id": 50825879, "question_id": 50824801, "link": "https://stackoverflow.com/questions/50824801/sending-vecboxtrait-over-channel/50825879#50825879", "title": "Sending Vec&lt;Box&lt;Trait&gt;&gt; over channel", "body": "<p>Let me comment on the types of this expression:</p>\n\n<pre><code>for s in somethings.list.iter() {\n    K::abc(&amp;s);\n}\n</code></pre>\n\n<p>(I've renamed the iterator variable, to avoid confussion).</p>\n\n<ul>\n<li><code>something</code> is of type: <code>Something</code>.</li>\n<li><code>something.list</code> is of type: <code>Vec&lt;Box&lt;AwesomeTrait + Send&gt;&gt;</code>.</li>\n<li><code>somethings.list.iter()</code> is of type <code>std::slice::Iter&lt;...&gt;</code> (not important).</li>\n<li><code>s</code> is of type <code>&amp;Box&lt;AwesomeTrait + Send&gt;</code>. It is important to note that it is a <em>reference</em> to a box, because you are using <code>iter()</code> instead of <code>into_iter()</code>.</li>\n</ul>\n\n<p>To get the actual <code>AwesomeTrait</code> you need to dereference <code>s</code> to get the <code>Box</code>, and then dereference again to get to the inner object: <code>**s</code>.</p>\n\n<p>But <code>**s</code> is of type <code>AwesomeTrait</code>, and you need a reference to that, so you must take get the address with <code>&amp;**s</code>, which is of type <code>&amp;AwesomeTrait</code>.</p>\n\n<p>The resulting code will be:</p>\n\n<pre><code>for s in somethings.list.iter() {\n    K::abc(&amp;**s);\n}\n</code></pre>\n\n<p>Or if you are willing to consume the list:</p>\n\n<pre><code>for s in somethings.list.into_iter() {\n    K::abc(&amp;*s);\n}\n</code></pre>\n\n<p>If you don't want to think about how many <code>*</code> to use you can use the <code>AsRef</code> trait, implemented by <code>Box</code>, and trust the autoreferencing by the compiler:</p>\n\n<pre><code>for s in somethings.list.iter() {\n    K::abc(s.as_ref());\n}\n</code></pre>\n\n<p>Note: The <code>.into_iter()</code> can also be ellided. As can <code>.iter()</code> if you iterate a reference to the <code>Vec</code>:</p>\n\n<pre><code>for s in somethings.list { //consume the list\n    K::abc(&amp;*s);\n}\n</code></pre>\n\n<p>or:</p>\n\n<pre><code>for s in &amp;somethings.list { //do not consume the list\n    K::abc(&amp;**s);\n}\n</code></pre>\n\n<p>You think you are done, but not yet... this code throws this compiler error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `AwesomeTrait + std::marker::Send: std::marker::Sized` is not satisfied\n  --&gt; src/main.rs:12:13\n   |\n12 |             K::abc(&amp;**s);\n   |             ^^^^^^ `AwesomeTrait + std::marker::Send` does not have a constant size known at compile-time\n   |\n   = help: the trait `std::marker::Sized` is not implemented for `AwesomeTrait + std::marker::Send`\nnote: required by `K::abc`\n  --&gt; src/main.rs:57:5\n   |\n57 |     pub fn abc&lt;T: AwesomeTrait&gt;(something: &amp;T) {\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>Why is that? Well, your <code>K::abc</code> requires a reference to a type that implements <code>AwesomeTrait</code> and <code>&amp;AwesomeTrait</code> certainly qualifies. But a trait is an unsized type (DST), and all generic function type parameters require a <code>Sized</code> type by default.</p>\n\n<p>The solution is to add a <code>?Sized</code> no-requirement to <code>K::abc</code>:</p>\n\n<pre><code>impl K {\n    pub fn abc&lt;T: AwesomeTrait + ?Sized&gt;(something: &amp;T) {\n        something.func();\n    }\n}\n</code></pre>\n\n<p>(You have an <code>&amp;</code> in this function that does nothing, I've removed it).</p>\n\n<p>The limitation with that <code>?Sized</code> is that you cannot declare variables or parameters of type <code>T</code>, only of <code>&amp;T</code>, <code>&amp;mut T</code>, <code>Box&lt;T&gt;</code>... but your current code does nothing forbidden, so no problem.</p>\n"}], "owner": {"reputation": 1789, "user_id": 4056372, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/285fed6a5df00f048a00732292105729?s=128&d=identicon&r=PG&f=1", "display_name": "Andrew", "link": "https://stackoverflow.com/users/4056372/andrew"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 465, "favorite_count": 0, "accepted_answer_id": 50825879, "answer_count": 2, "score": 4, "last_activity_date": 1528958290, "creation_date": 1528832926, "last_edit_date": 1528834396, "question_id": 50824801, "link": "https://stackoverflow.com/questions/50824801/sending-vecboxtrait-over-channel", "title": "Sending Vec&lt;Box&lt;Trait&gt;&gt; over channel", "body": "<p>I'm trying to send <code>Vec&lt;Box&lt;Trait&gt;&gt;</code> over a channel. The sending part sort of works, I guess. After <code>recv()</code>ing the <code>Vec</code> I'm trying to iterate over it and pass the inner value's reference to a function, which fails with an error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `&amp;std::boxed::Box&lt;AwesomeTrait + std::marker::Send&gt;: AwesomeTrait` is not satisfied\n  --&gt; src/main.rs:12:13\n   |\n12 |             K::abc(&amp;something);\n   |             ^^^^^^ the trait `AwesomeTrait` is not implemented for `&amp;std::boxed::Box&lt;AwesomeTrait + std::marker::Send&gt;`\n   |\nnote: required by `K::abc`\n  --&gt; src/main.rs:57:5\n   |\n57 |     pub fn abc&lt;T: AwesomeTrait&gt;(something: &amp;T) {\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>Is there a way to get the inner value out of the <code>Box</code> somehow?</p>\n\n<p><a href=\"http://play.rust-lang.org/?gist=280d2ff379ec84d0f0c685bb90641d13&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Here's a minimal reproduction.</a>:</p>\n\n<pre><code>use std::sync::mpsc;\nuse std::thread;\n\nfn main() {\n    let (tx, rx) = mpsc::channel::&lt;Request&gt;();\n    let s = Something::new();\n    tx.send(Request::Do(s)).unwrap();\n\n    let z = thread::spawn(move || match rx.recv().unwrap() {\n        Request::Do(somethings) =&gt; for something in somethings.list.iter() {\n            K::abc(&amp;something);\n        },\n    });\n\n    z.join();\n}\n\npub enum Request {\n    Do(Something),\n}\n\npub struct Something {\n    list: Vec&lt;Box&lt;AwesomeTrait + Send&gt;&gt;,\n}\n\nimpl Something {\n    pub fn new() -&gt; Self {\n        Self { list: Vec::new() }\n    }\n\n    pub fn from&lt;T: AwesomeTrait + Send + 'static&gt;(something: T) -&gt; Self {\n        let mut list = Vec::with_capacity(1);\n        list.push(Box::new(something));\n        // Self { list }\n        Self { list: Vec::new() }\n    }\n\n    pub fn push&lt;T: AwesomeTrait + Send + 'static&gt;(&amp;mut self, something: T) {\n        self.list.push(Box::new(something));\n    }\n}\n\npub trait AwesomeTrait {\n    fn func(&amp;self);\n}\n\npub struct X {}\n\nimpl AwesomeTrait for X {\n    fn func(&amp;self) {}\n}\n\npub struct K {}\n\nimpl K {\n    pub fn abc&lt;T: AwesomeTrait&gt;(something: &amp;T) {\n        &amp;something.func();\n    }\n}\n</code></pre>\n"}, {"tags": ["stream", "rust", "future", "traits"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 3, "last_activity_date": 1528856005, "creation_date": 1528856005, "answer_id": 50828193, "question_id": 50824737, "link": "https://stackoverflow.com/questions/50824737/returning-a-future-of-a-stream-trait-object/50828193#50828193", "title": "Returning a Future of a Stream trait object", "body": "<p>Your question greatly confuses me. You seem to understand that you need<sup>1</sup> to box the future, so why didn't you apply the <em>exact same logic</em> to the stream?</p>\n\n<pre><code>type BoxedStream = Box&lt;Stream&lt;Item = bool, Error = io::Error&gt;&gt;;\n\nfn stream_future() -&gt; Box&lt;Future&lt;Item = BoxedStream, Error = io::Error&gt;&gt; {\n    let s: BoxedStream = Box::new(stream::empty());\n    Box::new(future::ok(s))\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/27535289/155423\">What is the correct way to return an Iterator (or any other trait)?</a></li>\n</ul>\n\n<hr>\n\n<p><sup>1</sup> This isn't actually always needed in modern Rust. In certain locations, you can use <code>impl Trait</code> to return a value implementing a trait without boxing it:</p>\n\n<pre><code>fn stream_future() -&gt; impl Future&lt;Item = impl Stream&lt;Item = bool, Error = io::Error&gt;, Error = io::Error&gt; {\n    future::ok(stream::empty())\n}\n</code></pre>\n"}], "owner": {"reputation": 480, "user_id": 291228, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6112e4a7810b26f22762e5f5edf2abf0?s=128&d=identicon&r=PG", "display_name": "Chris Pick", "link": "https://stackoverflow.com/users/291228/chris-pick"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1226, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1528856005, "creation_date": 1528832645, "last_edit_date": 1528855494, "question_id": 50824737, "link": "https://stackoverflow.com/questions/50824737/returning-a-future-of-a-stream-trait-object", "title": "Returning a Future of a Stream trait object", "body": "<p>I'm using the <code>futures = \"0.1.21\"</code> crate and I'm trying to write a function that returns a trait object that is a \"<code>Future</code> of a <code>Stream</code> of <code>bool</code>s\".  In the real program, I'm establishing a connection to a server that periodically streams the status of its operations.</p>\n\n<h1>Futures</h1>\n\n<p>I've been able to return a \"<code>Future</code> of a <code>bool</code>\" trait object like so:</p>\n\n<pre><code>extern crate futures;\nuse futures::{future, Future};\n\nfn future() -&gt; Box&lt;Future&lt;Item = bool, Error = std::io::Error&gt;&gt; {\n    Box::new(future::ok(true))\n}\n\nfn main() { future(); }\n</code></pre>\n\n<p>Now I'd like to return a \"<code>Future</code> of a <code>Stream</code> of <code>bool</code>s\", but if I try:</p>\n\n<pre><code>extern crate futures;\nuse futures::{future, stream, Future, Stream};\n\nfn stream_future() -&gt; Box&lt;Future&lt;Item = Stream&lt;Item = bool, Error = std::io::Error&gt;, Error = std::io::Error&gt;&gt; {\n    Box::new(future::ok(stream::empty::&lt;bool, std::io::Error&gt;()))\n}\n\nfn main() { stream_future(); }\n</code></pre>\n\n<p>It fails to compile with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0271]: type mismatch resolving `&lt;futures::FutureResult&lt;futures::stream::Empty&lt;bool, std::io::Error&gt;, std::io::Error&gt; as futures::Future&gt;::Item == futures::Stream&lt;Item=bool, Error=std::io::Error&gt;`\n --&gt; src/main.rs:5:5\n  |\n5 |     Box::new(future::ok(stream::empty::&lt;bool, std::io::Error&gt;()))\n  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected struct `futures::stream::Empty`, found trait futures::Stream\n  |\n  = note: expected type `futures::stream::Empty&lt;bool, std::io::Error&gt;`\n             found type `futures::Stream&lt;Item=bool, Error=std::io::Error&gt;`\n  = note: required for the cast to the object type `futures::Future&lt;Item=futures::Stream&lt;Item=bool, Error=std::io::Error&gt;, Error=std::io::Error&gt;`\n</code></pre>\n\n<h1>Iterators</h1>\n\n<p>I run into a similar problem if I try to return a nested <code>Iterator</code>, eg:</p>\n\n<pre><code>fn iter2() -&gt; Box&lt;Iterator&lt;Item = Iterator&lt;Item = bool&gt;&gt;&gt; {\n    Box::new(vec![vec![true].into_iter()].into_iter())\n}\n</code></pre>\n\n<p>Fails with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0271]: type mismatch resolving `&lt;std::vec::IntoIter&lt;std::vec::IntoIter&lt;bool&gt;&gt; as std::iter::Iterator&gt;::Item == std::iter::Iterator&lt;Item=bool&gt;`\n --&gt; src/main.rs:2:5\n  |\n2 |     Box::new(vec![vec![true].into_iter()].into_iter())\n  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected struct `std::vec::IntoIter`, found trait std::iter::Iterator\n  |\n  = note: expected type `std::vec::IntoIter&lt;bool&gt;`\n             found type `std::iter::Iterator&lt;Item=bool&gt;`\n  = note: required for the cast to the object type `std::iter::Iterator&lt;Item=std::iter::Iterator&lt;Item=bool&gt;&gt;`\n</code></pre>\n\n<h1>Other options?</h1>\n\n<p>I suspect that either it isn't possible to \"nest\" traits like this or I haven't been able to figure out the syntax.</p>\n\n<p>If it's not possible, is there another design/pattern I should look into to accomplish something like this?</p>\n"}, {"tags": ["assembly", "x86", "rust", "inline-assembly"], "comments": [{"owner": {"reputation": 240669, "user_id": 224132, "user_type": "registered", "accept_rate": 83, "profile_image": "https://i.stack.imgur.com/N4ivW.png?s=128&g=1", "display_name": "Peter Cordes", "link": "https://stackoverflow.com/users/224132/peter-cordes"}, "edited": false, "score": 0, "creation_date": 1528825601, "post_id": 50822889, "comment_id": 88650906, "body": "BIOS calls are typically made by putting a value in a register and running <code>int 0x10</code> or some other interrupt.  e.g. <a href=\"https://en.wikipedia.org/wiki/INT_10H\" rel=\"nofollow noreferrer\">en.wikipedia.org/wiki/INT_10H</a> lists the different AH values.  These values are &quot;function codes&quot;, like system call numbers for Linux system calls where you set <code>eax=__NR_write</code> before running <code>syscall</code>."}, {"owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "reply_to_user": {"reputation": 240669, "user_id": 224132, "user_type": "registered", "accept_rate": 83, "profile_image": "https://i.stack.imgur.com/N4ivW.png?s=128&g=1", "display_name": "Peter Cordes", "link": "https://stackoverflow.com/users/224132/peter-cordes"}, "edited": false, "score": 0, "creation_date": 1528826410, "post_id": 50822889, "comment_id": 88651310, "body": "@PeterCordes Oh, I did see some stuff about <code>int 0x10</code> in the article. So, if I <code>mov ax, 0x004f</code>, run <code>int 0x10</code>, then it should work? Do I need to set <code>ES:DI</code>?"}, {"owner": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 1, "creation_date": 1528831890, "post_id": 50822889, "comment_id": 88654004, "body": "Yes. You need to set <code>ES:DI</code> to point to a 512 byte variable space starting with the four bytes <code>VBE2</code> as defined above before calling <code>int 10h</code>. After calling <code>int 10h</code> the structure will be filled with the data."}, {"owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "reply_to_user": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 0, "creation_date": 1528832396, "post_id": 50822889, "comment_id": 88654205, "body": "@zx485 Do I put the variable space in <code>.bss</code>?"}, {"owner": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 0, "creation_date": 1528832782, "post_id": 50822889, "comment_id": 88654372, "body": "You can use the <code>.bss</code> if you manually put the <code>VBE2</code> there (and possiblity init to zero!?) before calling <code>int 10h</code>. Or use the <code>.data</code> segment as defined above."}, {"owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "reply_to_user": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 0, "creation_date": 1528833479, "post_id": 50822889, "comment_id": 88654714, "body": "@zx485 I tried to put my <code>vbe_info_structure</code> in my bootcode, but it throws an error: <code>error: operation size not specified      src&#47;arch&#47;x86_64&#47;boot.asm:143: warning: uninitialized space declared in non-BSS section </code>.rodata&#39;: zeroing`"}, {"owner": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 0, "creation_date": 1528833965, "post_id": 50822889, "comment_id": 88654938, "body": "<code>.rodata</code> is the wrong section for sure, because the area will be written to. Try putting it in <code>.data</code>."}, {"owner": {"reputation": 33092, "user_id": 5801661, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/D8ENZ.jpg?s=128&g=1", "display_name": "Margaret Bloom", "link": "https://stackoverflow.com/users/5801661/margaret-bloom"}, "edited": false, "score": 0, "creation_date": 1528836994, "post_id": 50822889, "comment_id": 88656262, "body": "If you are already in long mode, beware. The VBE has a protected mode interface that requires you to create some 16-bit code/data segments. It may be easier to gather all the information and set the mode <i>before</i> leaving real mode. Anyway, <a href=\"http://www.petesqbsite.com/sections/tutorials/tuts/vbe3.pdf\" rel=\"nofollow noreferrer\">here</a> you can find the detailed instruction on how to call VBE functions from compatibility mode."}, {"owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "reply_to_user": {"reputation": 33092, "user_id": 5801661, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/D8ENZ.jpg?s=128&g=1", "display_name": "Margaret Bloom", "link": "https://stackoverflow.com/users/5801661/margaret-bloom"}, "edited": false, "score": 0, "creation_date": 1528866540, "post_id": 50822889, "comment_id": 88663085, "body": "@MargaretBloom thanks! @zx485, I put the data in a <code>section.data</code> section, but it still throws an error. <a href=\"https://gist.github.com/nebrelbug/5a0042d4de32f942bb72e71fe282bdd2\" rel=\"nofollow noreferrer\">Here&#39;s my code.</a> What am I doing wrong?"}, {"owner": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "reply_to_user": {"reputation": 33092, "user_id": 5801661, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/D8ENZ.jpg?s=128&g=1", "display_name": "Margaret Bloom", "link": "https://stackoverflow.com/users/5801661/margaret-bloom"}, "edited": false, "score": 0, "creation_date": 1528893980, "post_id": 50822889, "comment_id": 88678952, "body": "It&#39;s the problem @MargaretBloom wrote about. You&#39;re using 16-bit code in a 32-bit code segment. The tutorials you mentioned above refer to 16-bit <i>Real Mode</i>, but you&#39;re in 32-bit <i>Protected Mode</i>. I don&#39;t know about VESA <i>Protected Mode</i> functions, I&#39;ve never used them, so I can&#39;t help you with that."}, {"owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "reply_to_user": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 0, "creation_date": 1529003444, "post_id": 50822889, "comment_id": 88731147, "body": "@zx485 ok, thanks. I&#39;m probably going to try and remake my kernel with UEFI support and use that for graphics. Any good tutorials for that? :)"}, {"owner": {"reputation": 23944, "user_id": 1305969, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/wlo8z.png?s=128&g=1", "display_name": "zx485", "link": "https://stackoverflow.com/users/1305969/zx485"}, "edited": false, "score": 1, "creation_date": 1529003971, "post_id": 50822889, "comment_id": 88731412, "body": "No tutorial, but <a href=\"https://blog.fpmurphy.com/\" rel=\"nofollow noreferrer\">fpmurphy is a good blog on UEFI development</a>."}, {"owner": {"reputation": 41564, "user_id": 3857942, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/hXLnN.jpg?s=128&g=1", "display_name": "Michael Petch", "link": "https://stackoverflow.com/users/3857942/michael-petch"}, "edited": false, "score": 0, "creation_date": 1533931010, "post_id": 50822889, "comment_id": 90544153, "body": "<code>section.data:</code> Ithink was meant to be <code>section .data</code>"}], "answers": [{"comments": [{"owner": {"reputation": 1724, "user_id": 10112322, "user_type": "registered", "profile_image": "https://graph.facebook.com/272533323503817/picture?type=large", "display_name": "memo", "link": "https://stackoverflow.com/users/10112322/memo"}, "reply_to_user": {"reputation": 41564, "user_id": 3857942, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/hXLnN.jpg?s=128&g=1", "display_name": "Michael Petch", "link": "https://stackoverflow.com/users/3857942/michael-petch"}, "edited": false, "score": 0, "creation_date": 1533554948, "post_id": 51706141, "comment_id": 90373798, "body": "@MichaelPetch Good points. WRT protected mode: he could call get_vesa_info before entering protected mode, to make things easier."}, {"owner": {"reputation": 872, "user_id": 8077259, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/E1wSe.jpg?s=128&g=1", "display_name": "caylee", "link": "https://stackoverflow.com/users/8077259/caylee"}, "edited": false, "score": 0, "creation_date": 1533555099, "post_id": 51706141, "comment_id": 90373884, "body": "To inform yourself about the VESA BIOS, you should have a look at RBIL (<a href=\"http://www.ctyme.com/intr/rb-0273.htm\" rel=\"nofollow noreferrer\">ctyme.com/intr/rb-0273.htm</a>)"}], "tags": [], "owner": {"reputation": 1724, "user_id": 10112322, "user_type": "registered", "profile_image": "https://graph.facebook.com/272533323503817/picture?type=large", "display_name": "memo", "link": "https://stackoverflow.com/users/10112322/memo"}, "is_accepted": false, "score": 2, "last_activity_date": 1533554428, "last_edit_date": 1533554428, "creation_date": 1533553417, "answer_id": 51706141, "question_id": 50822889, "link": "https://stackoverflow.com/questions/50822889/how-to-get-vesa-bios-information/51706141#51706141", "title": "How to get VESA BIOS Information", "body": "<p>In your boot.asm file, you have:</p>\n\n<pre><code>get_vesa_info:\n    mov ax, 0x4f00\n    mov [es:di], vbe_info_structure\n    int 0x10\n    ret\n</code></pre>\n\n<p>The third line must be replaced by</p>\n\n<pre><code>    mov di, vbe_info_structure\n</code></pre>\n\n<p>Explanation: as it is now, it attempts to write the constant vbe_info_structure at the address pointed to by es:di (which is undefined in your case). What you want instead, is to load the address vbe_info_structure into di, and thus pass it to the int 0x10 routine.</p>\n\n<p>By the way, int 0x10 performs several functions. In order to tell it which one you want to call, you pass the \"function code\" in the ax register. Think of the function code as the name of the function (there are no names in assembly, just numbers and addresses).</p>\n\n<p>Also, you need to setup es correctly. Either do</p>\n\n<pre><code>push ds\npop es\n</code></pre>\n\n<p>assuming that ds already points to section.data, or by using an assembler directive (<code>assume es section.data</code> ? -- not sure about this, it's been a long time since I've used an assembler).\nOr maybe like this:</p>\n\n<pre><code>mov ax, @section.data\nmov es, ax\n</code></pre>\n\n<p>which should be done before loading 0x4f00 into ax, of course.</p>\n"}], "owner": {"reputation": 1051, "user_id": 7983596, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/1d5148aeced685c36901188ede736d85?s=128&d=identicon&r=PG&f=1", "display_name": "Ben Gubler", "link": "https://stackoverflow.com/users/7983596/ben-gubler"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 832, "favorite_count": 4, "answer_count": 1, "score": 13, "last_activity_date": 1533554428, "creation_date": 1528825326, "last_edit_date": 1528866639, "question_id": 50822889, "link": "https://stackoverflow.com/questions/50822889/how-to-get-vesa-bios-information", "title": "How to get VESA BIOS Information", "body": "<p>I'm following through the <a href=\"https://os.phil-opp.com/\" rel=\"noreferrer\">Phil-Opp Tutorials</a> about writing an OS in Rust, and, after playing around with it a little bit, I want to fiddle with displaying real graphics on the screen.</p>\n\n<p>I've figured out that I should probably start out by using the Linear Frame Buffer, with VESA. I found some tutorials on osdev.org <a href=\"https://wiki.osdev.org/User:Omarrx024/VESA_Tutorial\" rel=\"noreferrer\">here</a> and <a href=\"https://wiki.osdev.org/Getting_VBE_Mode_Info\" rel=\"noreferrer\">here</a>, but they keep on talking about \"function codes\" and <code>es:di</code>. The second link says this:</p>\n\n<blockquote>\n  <p>FUNCTION: Get VESA BIOS information</p>\n  \n  <p>Function code: 0x4F00</p>\n  \n  <p>Description: Returns the VESA BIOS information, including manufacturer, supported modes, available video memory, etc... Input: AX = 0x4F00</p>\n  \n  <p>Input: ES:DI = Segment:Offset pointer to where to store VESA BIOS information structure.</p>\n  \n  <p>Output: AX = 0x004F on success, other values indicate that VESA BIOS is not supported.</p>\n  \n  <p>Anyway, the above function returns the following structure and stores it in ES:DI as they were on entry. On entry, ES:DI should contain a pointer to the following structure:</p>\n  \n  <p><code>vbe_info_structure:\n      .signature      db \"VBE2\"   ; indicate support for VBE 2.0+\n      .table_data:        resb 512-4  ; reserve space for the table below</code></p>\n</blockquote>\n\n<p>Though I've looked at some assembly language tutorials, I have no idea what a \"function code\" is. From what I understand, if I <code>mov ax, 0x4f00</code>, and create a structure like the one above, it will magically overwrite the structure, which I could then pass as a parameter to my Rust Code? How do I, or do I need to, set my <code>es:di</code>? (From researching, I thought that it was just automatically set on modern processors)</p>\n\n<p>Should I do all of this stuff in Inline Assembly instead? Should I just use UEFI and rewrite my kernel? I would love if you could give an example of how to access the vbe_info_structure in Rust code (I'm running in <code>long mode</code>).</p>\n\n<p>Here's my <code>boot.asm</code> file so far, but it doesn't work yet: <a href=\"https://gist.github.com/nebrelbug/5a0042d4de32f942bb72e71fe282bdd2\" rel=\"noreferrer\">https://gist.github.com/nebrelbug/5a0042d4de32f942bb72e71fe282bdd2</a>. Thanks!</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1528823375, "post_id": 50822267, "comment_id": 88649728, "body": "Please provide a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> of the problem, including which definitions were imported into the code. It is also worth explaining what happens when you follow exactly what was proposed in that error message."}, {"owner": {"reputation": 517, "user_id": 7312355, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/57ce505140904fd60f4e0d002b9a842e?s=128&d=identicon&r=PG&f=1", "display_name": "599644", "link": "https://stackoverflow.com/users/7312355/599644"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1528823984, "post_id": 50822267, "comment_id": 88650001, "body": "Same error. <code>use futures::future::Future;</code> is already there. I am stupid when it comes to Rust, but not <i>that</i> stupid to not be able to follow compiler suggestions :D"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1528824105, "post_id": 50822267, "comment_id": 88650066, "body": "It might be worth also including the installed dependencies&#39; versions."}, {"owner": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "edited": false, "score": 1, "creation_date": 1528824471, "post_id": 50822267, "comment_id": 88650278, "body": "Try setting <code>futures = &quot;0.1&quot;</code>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528824517, "post_id": 50822267, "comment_id": 88650315, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/44437123/155423\">Why is a trait not implemented for a type that clearly has it implemented?</a>. You have both futures 0.1 and 0.2 present. If you disagree, please <a href=\"https://stackoverflow.com/posts/50822267/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 517, "user_id": 7312355, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/57ce505140904fd60f4e0d002b9a842e?s=128&d=identicon&r=PG&f=1", "display_name": "599644", "link": "https://stackoverflow.com/users/7312355/599644"}, "edited": false, "score": 0, "creation_date": 1528824629, "post_id": 50822267, "comment_id": 88650374, "body": "Where do I have &quot;futures 0.1&quot;?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528824873, "post_id": 50822267, "comment_id": 88650518, "body": "As shown in the duplicate question, actix-web pulls in actix which pulls in futures 0.1."}, {"owner": {"reputation": 517, "user_id": 7312355, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/57ce505140904fd60f4e0d002b9a842e?s=128&d=identicon&r=PG&f=1", "display_name": "599644", "link": "https://stackoverflow.com/users/7312355/599644"}, "edited": false, "score": 0, "creation_date": 1528825176, "post_id": 50822267, "comment_id": 88650695, "body": "I see. Yeah looks like the same issue."}], "owner": {"reputation": 517, "user_id": 7312355, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/57ce505140904fd60f4e0d002b9a842e?s=128&d=identicon&r=PG&f=1", "display_name": "599644", "link": "https://stackoverflow.com/users/7312355/599644"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 309, "favorite_count": 0, "closed_date": 1528825800, "answer_count": 0, "score": 1, "last_activity_date": 1528824212, "creation_date": 1528822957, "last_edit_date": 1528824212, "question_id": 50822267, "link": "https://stackoverflow.com/questions/50822267/how-can-i-call-and-then-on-a-boxed-future", "closed_reason": "Duplicate", "title": "How can I call `and_then` on a boxed Future?", "body": "<p>According to <a href=\"https://actix.rs/docs/extractors/\" rel=\"nofollow noreferrer\">Actix-Web Extractors</a> I can use <code>extract()</code> on the <code>HttpRequest</code> to convert the JSON-encoded body to a struct.</p>\n\n<p>However <code>Json::&lt;LoginData&gt;::extract(&amp;req);</code> returns a <code>Box&lt;Future&lt;...&gt;&gt;</code> which I cannot call <code>and_then</code> on.</p>\n\n<p>How can I convert the <code>Box&lt;Future&lt;...&gt;&gt;</code> to just <code>Future&lt;...&gt;</code>?</p>\n\n<p>Complete file:</p>\n\n<pre><code>extern crate actix_web;\nextern crate serde;\nextern crate serde_json;\nextern crate futures;\n#[macro_use] extern crate serde_derive;\nextern crate json;\n\nuse actix_web::http::{Method};\nuse actix_web::{server, App, HttpRequest, HttpResponse, Error, Json, FromRequest};\n\nuse futures::future::Future;\n\n#[derive(Debug, Deserialize)]\nstruct LoginData {\n    email: String,\n    password: String,\n}\n\nfn login_handler(item: Json&lt;LoginData&gt;) -&gt; Result&lt;&amp;'static str, Error&gt; {\n    Ok(\"hmmm\")\n}\n\nfn login_handler2(req: HttpRequest) -&gt; Box&lt;Future&lt;Item = HttpResponse, Error = Error&gt;&gt; {\n    let info = Json::&lt;LoginData&gt;::extract(&amp;req);\n    info.and_then(|f| { f })\n}\n\nfn main() {\n    server::new(\n        || App::new()\n            .route(\"/login\", Method::POST, login_handler))\n        .bind(\"127.0.0.1:8080\").unwrap()\n        .run();\n}\n</code></pre>\n\n<p>Error:</p>\n\n<pre><code>Compiling hello_world v0.1.0 (file:///Users/stavros/projects/test-rust/hello_world_so/hello_world)\nerror: the `and_then` method cannot be invoked on a trait object\n  --&gt; src/main.rs:25:10\n   |\n25 |     info.and_then(|f| { f })\n   |          ^^^^^^^^\nhelp: another candidate was found in the following trait, perhaps add a `use` for it:\n   |\n8  | use futures::future::Future;\n   |\n\nerror: aborting due to previous error\n\nerror: Could not compile `hello_world`.\n</code></pre>\n\n<p>My Cargo.toml:</p>\n\n<pre><code>[package]\nname = \"hello_world\"\nversion = \"0.1.0\"\nauthors = [\"docker\"]\n\n[dependencies]\nactix-web = \"0.6.10\"\nenv_logger = \"0.5.10\"\nfutures = \"0.2.1\"\nmysql = \"13.1.0\"\nserde = \"1.0.66\"\nserde_derive = \"1.0.66\"\nserde_json = \"1.0.20\"\ntokio = \"0.1\"\njson = \"*\"\n</code></pre>\n"}, {"tags": ["rust", "rust-cargo"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1528822354, "last_edit_date": 1528822354, "creation_date": 1528821995, "answer_id": 50822054, "question_id": 50821346, "link": "https://stackoverflow.com/questions/50821346/is-it-possible-to-run-cargo-install-with-a-specific-date-instead-of-version-numb/50822054#50822054", "title": "Is it possible to run cargo install with a specific date instead of version numbers?", "body": "<p>No, this is not possible.</p>\n\n<p>Your best options are:</p>\n\n<ol>\n<li><p>Upgrade the compiler. If you \"can't\" do this, evaluate why you can't and decide how much benefit you are getting from that.</p></li>\n<li><p>Add the dependencies to your own Cargo.toml pinned to an older version that does work.</p></li>\n<li><p>You can try <a href=\"https://stackoverflow.com/q/42979096/155423\">forking the crate index</a> and rolling it back, but there's no guarantee that will work either.</p></li>\n</ol>\n\n<blockquote>\n  <p>seems to pull the latest version of some dependencies</p>\n</blockquote>\n\n<p>Yes, most libraries specify dependencies with a semver-compatible range, such as <code>my-library = \"1.0\"</code>. This will allow any version from 1.0.0 to 1.x.y.</p>\n\n<p>Unfortunately, there's no consensus on whether requiring a new version of Rust constitutes a semver-breaking change yet.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/41185023/155423\">What exactly is considered a breaking change to a library crate?</a></li>\n<li><a href=\"https://stackoverflow.com/q/42979096/155423\">How to generate Cargo.lock based on last month&#39;s crates.io?</a></li>\n</ul>\n"}], "owner": {"reputation": 912, "user_id": 3327135, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/37lq4.jpg?s=128&g=1", "display_name": "ktorn", "link": "https://stackoverflow.com/users/3327135/ktorn"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 316, "favorite_count": 0, "accepted_answer_id": 50822054, "answer_count": 1, "score": 1, "last_activity_date": 1528822354, "creation_date": 1528818999, "last_edit_date": 1528822143, "question_id": 50821346, "link": "https://stackoverflow.com/questions/50821346/is-it-possible-to-run-cargo-install-with-a-specific-date-instead-of-version-numb", "title": "Is it possible to run cargo install with a specific date instead of version numbers?", "body": "<p>I want to install a package and all its dependencies as they were at a specific date and time in the past.</p>\n\n<p>I need to use a slightly older version of <code>rustc-nightly</code>, and therefore I need to make sure that all dependencies pulled by <code>cargo install</code> compile against that old version of the compiler.</p>\n\n<p>Currently, when I specify the version of the top-level package to install, it still seems to pull the latest version of some dependencies, which don't build with the old compiler.</p>\n"}, {"tags": ["rust", "visual-studio-code", "lldb"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1528819497, "post_id": 50821127, "comment_id": 88648117, "body": "It looks like something is out of sync, and it is printing a different value than you intended. I&#39;m not familiar with that debugging set up, but it could just be that you are debugging slightly different code than you are running."}, {"owner": {"reputation": 3, "user_id": 9846792, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/41c69cc68510f476d56d2bdacc71e086?s=128&d=identicon&r=PG&f=1", "display_name": "Harold", "link": "https://stackoverflow.com/users/9846792/harold"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1528879586, "post_id": 50821127, "comment_id": 88669609, "body": "I don&#39;t think it is the problem: when the enum is Call(Address) correct values are shown. I edited the post with new information."}], "owner": {"reputation": 3, "user_id": 9846792, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/41c69cc68510f476d56d2bdacc71e086?s=128&d=identicon&r=PG&f=1", "display_name": "Harold", "link": "https://stackoverflow.com/users/9846792/harold"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 166, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1528878951, "creation_date": 1528818370, "last_edit_date": 1528878951, "question_id": 50821127, "link": "https://stackoverflow.com/questions/50821127/strange-output-when-examing-variables-with-lldb", "title": "Strange output when examing variables with LLDB", "body": "<p>I am debugging the Parity Ethereum client with LLDB in VSCode and I am trying to access a value through several references.</p>\n\n<p>Here is the code with relevant parts only (full code <a href=\"https://github.com/paritytech/parity/blob/master/ethcore/transaction/src/transaction.rs\" rel=\"nofollow noreferrer\">here</a>)</p>\n\n<pre><code>pub struct SignedTransaction {\n    transaction: UnverifiedTransaction,\n    sender: Address,\n    public: Option&lt;Public&gt;,\n}\n\nimpl Deref for SignedTransaction {\n    type Target = UnverifiedTransaction;\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        &amp;self.transaction\n    }\n}\n\npub struct UnverifiedTransaction {\n    unsigned: Transaction,\n    v: u64,\n    r: U256,\n    s: U256,\n    hash: H256,\n}\n\nimpl Deref for UnverifiedTransaction {\n    type Target = Transaction;\n\n    fn deref(&amp;self) -&gt; &amp;Self::Target {\n        &amp;self.unsigned\n    }\n}\n\npub struct Transaction {\n    pub nonce: U256,\n    pub gas_price: U256,\n    pub gas: U256,\n    pub action: Action,\n    pub value: U256,\n    pub data: Bytes,\n}\n\npub enum Action {\n    Create,\n    Call(Address),\n}\n</code></pre>\n\n<hr>\n\n<p>I have <code>&amp;SignedTransaction t</code> with a value <code>t.action = Action::Create</code> (verified by manual print).</p>\n\n<p>I am looking to get <code>action</code> value as VSCode shows a misleading value: </p>\n\n<p><a href=\"https://i.stack.imgur.com/bfZG4.png\" rel=\"nofollow noreferrer\">VSCode showing misleading value</a></p>\n\n<p>I cannot manage to print only <code>action</code> value but the command <code>p t.transaction</code> outputs this (truncated) :</p>\n\n<pre><code>(ethcore_transaction::transaction::UnverifiedTransaction) $2 = {\nunsigned = {\n    action = Call(((20) ['\\', '!', '\\xf6', '\\xff', '\\x7f', '\\0', ...])) {\n    = Call(((20) ['\\', '!', '\\xf6', '\\xff', '\\x7f', '\\0', ...])) {\n        RUST$ENUM$DISR = Create {...}\n</code></pre>\n\n<p>In the case where <code>t.action = Action::Call()</code> the value is correctly shown.</p>\n\n<p>Why does it not show <code>action = Create</code> ? How can I print more cleanly <code>action</code> value ?</p>\n\n<p>EDIT: the command <code>fr v t-&gt;transaction.unsigned.action.RUST$ENUM$DISR</code> shows the correct enum value. However I still don't know why <code>fr v t-&gt;transaction.unsigned.action</code> displays wrong values (which are also shown in the graphical interface).</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 12516, "user_id": 302268, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/c3985dffcdc646b67ed0699a364639e2?s=128&d=identicon&r=PG", "display_name": "Mad Wombat", "link": "https://stackoverflow.com/users/302268/mad-wombat"}, "edited": false, "score": 1, "creation_date": 1528834237, "post_id": 50821290, "comment_id": 88655051, "body": "I will try your first suggestion, thanks. I am trying to do OpenGL in Rust and working on loading a texture into a buffer. As far as I can tell I need to point the GL API call to a buffer with RGB bytes."}], "tags": [], "owner": {"reputation": 8378, "user_id": 124538, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/82159aeb57c52bc0c7bfe6e9c832c3ea?s=128&d=identicon&r=PG", "display_name": "Wesley Wiser", "link": "https://stackoverflow.com/users/124538/wesley-wiser"}, "is_accepted": true, "score": 6, "last_activity_date": 1587239235, "last_edit_date": 1587239235, "creation_date": 1528818833, "answer_id": 50821290, "question_id": 50821070, "link": "https://stackoverflow.com/questions/50821070/how-do-i-get-a-vector-of-u8-rgb-values-when-using-the-image-crate/50821290#50821290", "title": "How do I get a vector of u8 RGB values when using the image crate?", "body": "<p>Well, if you just want the raw data itself, you can just call <a href=\"https://docs.rs/image/0.19.0/image/enum.DynamicImage.html#method.raw_pixels\" rel=\"nofollow noreferrer\"><code>DynamicImage::raw_pixels</code></a>:</p>\n\n<pre><code>let im = image::open(\"wall.jpg\").unwrap().to_rgb();\nlet rgb: Vec&lt;u8&gt; = im.raw_pixels();\n</code></pre>\n\n<p>If all you're actually interested in is the first pixel though, I'd recommend calling <a href=\"https://docs.rs/image/0.19.0/image/trait.GenericImage.html#tymethod.get_pixel\" rel=\"nofollow noreferrer\"><code>GenericImage::get_pixel</code></a>:</p>\n\n<pre><code>let im = image::open(\"wall.jpg\").unwrap();\nlet first_pixel = im.get_pixel(0, 0);\n</code></pre>\n\n<p>Which you can then turn into a <code>[u8; 3]</code> array of RGB data:</p>\n\n<pre><code>let rgb = first_pixel.to_rbg();\nprintln!(\"First Pixel: {} {} {}\", rgb.data[0], rgb.data[1], rgb.data[2]);\n</code></pre>\n"}], "owner": {"reputation": 12516, "user_id": 302268, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/c3985dffcdc646b67ed0699a364639e2?s=128&d=identicon&r=PG", "display_name": "Mad Wombat", "link": "https://stackoverflow.com/users/302268/mad-wombat"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1323, "favorite_count": 1, "accepted_answer_id": 50821290, "answer_count": 1, "score": 5, "last_activity_date": 1587239235, "creation_date": 1528818195, "last_edit_date": 1528822543, "question_id": 50821070, "link": "https://stackoverflow.com/questions/50821070/how-do-i-get-a-vector-of-u8-rgb-values-when-using-the-image-crate", "title": "How do I get a vector of u8 RGB values when using the image crate?", "body": "<p>I need to take an image and get a list of RGB byte values. I am using <a href=\"https://crates.io/crates/image\" rel=\"noreferrer\">the image crate</a>. This is what I have:</p>\n\n<pre><code>extern crate image;\n\nfn main() {\n    let im = image::open(\"wall.jpg\").unwrap().to_rgb();\n    let data: Vec&lt;[u8; 3]&gt; = im.pixels().flat_map(|p| vec![p.data]).collect();\n    let rgb: Vec&lt;&amp;u8&gt; = data.iter().flat_map(|p| p.iter()).collect();\n    println!(\"First Pixel: {} {} {}\", rgb[0], rgb[1], rgb[2]);\n}\n</code></pre>\n\n<p>This seems pretty ugly. I have to introduce an intermediate variable and I get a vector of pointers to the values I really need, so before I can do something else, I would have to map over it again to get the actual values.</p>\n\n<p>All I want is a vector of <code>u8</code>. How do I get that?</p>\n"}, {"tags": ["rust", "rust-actix"], "comments": [{"owner": {"reputation": 1470, "user_id": 2075745, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/6f9a084d236381e1882c4e28edb5151f?s=128&d=identicon&r=PG", "display_name": "user25064", "link": "https://stackoverflow.com/users/2075745/user25064"}, "edited": false, "score": 2, "creation_date": 1528813682, "post_id": 50819571, "comment_id": 88644488, "body": "See the example regarding application shared state <a href=\"https://actix.rs/docs/application/#state\" rel=\"nofollow noreferrer\">in the actix documentation</a>"}], "answers": [{"comments": [{"owner": {"reputation": 5087, "user_id": 2942471, "user_type": "registered", "accept_rate": 57, "profile_image": "https://graph.facebook.com/100000008666513/picture?type=large", "display_name": "manonthemat", "link": "https://stackoverflow.com/users/2942471/manonthemat"}, "edited": false, "score": 0, "creation_date": 1528929447, "post_id": 50820552, "comment_id": 88697918, "body": "state is not a field, but a method, so in this case it should be <code>req.state().my_big_heavy_object</code> instead of <code>req.state.my_big_heavy_object</code>"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 2, "last_activity_date": 1528817055, "last_edit_date": 1528817055, "creation_date": 1528816507, "answer_id": 50820552, "question_id": 50819571, "link": "https://stackoverflow.com/questions/50819571/use-precomputed-big-object-in-actix-web-route-handler/50820552#50820552", "title": "Use precomputed big object in actix-web route handler", "body": "<p>First, create a struct which is the shared state for your application:</p>\n\n<pre><code>struct AppState {\n    my_big_heavy_object: HeavyObject,\n}\n</code></pre>\n\n<p>It's better to create a context wrapper like this, rather than just using <code>HeavyObject</code>, so you can add other fields to it later if necessary.</p>\n\n<p>A few objects in Actix will now need to interact with this, so you can make them aware of it by overriding the application state parameter in those types, for example <code>HttpRequest&lt;AppState&gt;</code>.</p>\n\n<p>Your <code>index</code> handler can access the state through the <code>HttpRequest</code>'s <code>state</code> property, and now looks like this:</p>\n\n<pre><code>fn index(req: HttpRequest&lt;AppState&gt;) -&gt; HttpResponse {\n    let result = do_something_with(req.state.my_big_heavy_object);\n    HttpResponse::Ok()\n        .content_type(\"application/json\")\n        .body(result)\n}\n</code></pre>\n\n<p>When building the <code>App</code>, use the <code>with_state</code> constructor instead of <code>new</code>:</p>\n\n<pre><code>server::new(|| {\n        let app_state = AppState { my_big_heavy_object: compute_big_heavy_object() };\n        App::with_state(app_state).resource(\"/\", |r| r.f(index))\n    })\n    .bind(\"127.0.0.1:8088\")\n    .unwrap()\n    .run();\n</code></pre>\n\n<p>Note that the application state is assumed to be immutable. It sounds like you don't need any handlers to mutate it but if you did then you would have to use something like <code>Cell</code> or <code>RefCell</code> for interior mutability.</p>\n"}], "owner": {"reputation": 15633, "user_id": 2091169, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/MT8tZ.jpg?s=128&g=1", "display_name": "Jivan", "link": "https://stackoverflow.com/users/2091169/jivan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 317, "favorite_count": 0, "accepted_answer_id": 50820552, "answer_count": 1, "score": 2, "last_activity_date": 1528817055, "creation_date": 1528813509, "question_id": 50819571, "link": "https://stackoverflow.com/questions/50819571/use-precomputed-big-object-in-actix-web-route-handler", "title": "Use precomputed big object in actix-web route handler", "body": "<p>Is there a way to make an <code>actix-web</code> route handler aware of a pre-computed heavy object, that is needed for the computation of <code>result</code>?</p>\n\n<p>What I intend to do, in the end, is to avoid having to recompute <code>my_big_heavy_object</code> each time a request comes along, and instead compute it once and for all in <code>main</code>, there access it from the <code>index</code> method.</p>\n\n<pre><code>extern crate actix_web;\nuse actix_web::{server, App, HttpRequest};\n\nfn index(_req: HttpRequest) -&gt; HttpResponse {\n    // how can I access my_big_heavy_object from here?\n    let result = do_something_with(my_big_heavy_object);\n    HttpResponse::Ok()\n        .content_type(\"application/json\")\n        .body(result)\n}\n\nfn main() {\n    let my_big_heavy_object = compute_big_heavy_object();\n\n    server::new(|| App::new().resource(\"/\", |r| r.f(index)))\n        .bind(\"127.0.0.1:8088\")\n        .unwrap()\n        .run();\n}\n</code></pre>\n"}, {"tags": ["rust", "unix-socket"], "comments": [{"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528811649, "post_id": 50818660, "comment_id": 88643045, "body": "Hey @Shepmaster, thanks for the prompt response as always. I believe the questions are similar but different and the details are already in the question. The one you pointed me to has the same problem as me but with<code>read_to_string</code> which waits for EOF, while <code>read_to_end</code> would call read multiple times until it reads <code>Ok(0)</code>, so for an example like mine, it should read the entire message in the first read and then read <code>Ok(0)</code> and return. It seems to not be doing that last bit."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528811899, "post_id": 50818660, "comment_id": 88643214, "body": "No, <code>read_to_end</code> and <code>read_to_string</code> have the exact same behavior \u2014 <b>both</b> read the entire stream until EOF; in fact <code>read_to_string</code> and <code>read_to_end</code> call the same core function internally. I&#39;ve added the quote from the <code>read_to_end</code> documentation to the other answer to make it more obvious."}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528812079, "post_id": 50818660, "comment_id": 88643327, "body": "If that&#39;s the case, the documentation is wrong. Check the documentation for <code>read_to_end</code> here: <a href=\"https://doc.rust-lang.org/std/io/trait.Read.html#method.read_to_end\" rel=\"nofollow noreferrer\">doc.rust-lang.org/std/io/trait.Read.html#method.read_to_end</a> it points to the behaviour I mention."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528812323, "post_id": 50818660, "comment_id": 88643481, "body": "The very first line of the documentation you just linked: <i>Read <b>all bytes until EOF</b> in this source, placing them into <code>buf</code></i>. It will read available data into the buffer. When there&#39;s no data, <i>it will block,</i> waiting for more data to arrive. The only time it returns <code>Some(0)</code> is when the remote socket is closed (a.k.a. End Of File)."}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528812882, "post_id": 50818660, "comment_id": 88643881, "body": "Shit, you are right, I don&#39;t know how I skimmed over that one very important line. In that case, you are right, this is the same as the TcpStream question and we can close this one as a duplicate. Thanks for your help!"}], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 397, "favorite_count": 0, "closed_date": 1528812954, "answer_count": 0, "score": 1, "last_activity_date": 1528812175, "creation_date": 1528810737, "last_edit_date": 1528812175, "question_id": 50818660, "link": "https://stackoverflow.com/questions/50818660/read-to-end-method-never-returns-for-unixstream", "closed_reason": "Duplicate", "title": "read_to_end method never returns for UnixStream", "body": "<p>I'm working in an application that uses Unix domain sockets to communicate processes. For this purpose, I'm using the <code>UnixListener</code> and <code>UnixStream</code> types in the standard library.</p>\n\n<p>I found that depending on how I read the data, the process could hang. After debugging I found that it depends on whether I use <code>read</code> or <code>read_to_end</code> to retrieve the data from the socket. Using <code>read</code> works fine, while using <code>read_to_end</code> makes the calling process to hang until I kill the other process (at which point the data is actually read). It almost seems like a problem with flushing the buffer, although the documentation doesn't mention anything of the sort.</p>\n\n<p>This is a working example of the problem:</p>\n\n<pre><code>use std::env;\nuse std::io::{Read, Write};\nuse std::os::unix::net::{UnixListener, UnixStream};\nuse std::thread;\n\nfn handle_client(mut stream: UnixStream) {\n    loop {\n        let mut read = [0; 1028];\n        match stream.read(&amp;mut read) {\n            Ok(n) =&gt; {\n                if n == 0 {\n                    // connection was closed\n                    break;\n                }\n                let msg = String::from_utf8(read.to_vec()).unwrap();\n                println!(\"SERVER: {} received from remote client.\", msg);\n                stream.write(&amp;read[0..n]).unwrap();\n            }\n            Err(err) =&gt; {\n                panic!(err);\n            }\n        }\n    }\n    println!(\"SERVER: Ending connection with client.\");\n}\n\nfn start_server(address: String) {\n    let listener = UnixListener::bind(&amp;address).unwrap();\n\n    // accept connections and process them, spawning a new thread for each one\n    for connection in listener.incoming() {\n        match connection {\n            Ok(stream) =&gt; {\n                /* connection succeeded */\n                thread::spawn(|| handle_client(stream));\n            }\n            Err(err) =&gt; {\n                /* connection failed */\n                println!(\"Error connecting to client: {}\", err);\n                break;\n            }\n        }\n    }\n}\n\nfn start_client(address: String, msg: String) {\n    let mut socket = match UnixStream::connect(&amp;address) {\n        Ok(sock) =&gt; sock,\n        Err(e) =&gt; {\n            println!(\"Couldn't connect! {}.\", e);\n            return;\n        }\n    };\n    let request = msg.into_bytes();\n    match socket.write_all(&amp;request) {\n        Ok(_) =&gt; {}\n        Err(e) =&gt; println!(\"Error writing to socket: {}\", e),\n    }\n\n    // This variant works\n    // let mut read = [0; 1028];\n    // match socket.read(&amp;mut read) {\n\n    // This variant does not work.\n    let mut read = Vec::with_capacity(1024); //Comment this to make it work\n    match socket.read_to_end(&amp;mut read) {\n        // Comment this to make it work\n        Ok(n) =&gt; {\n            if n == 0 {\n                // connection was closed\n            }\n            let msg = String::from_utf8(read.to_vec()).unwrap();\n            println!(\"CLIENT: {} received from server.\", msg);\n        }\n        Err(err) =&gt; {\n            panic!(err);\n        }\n    }\n}\n\nfn main() {\n    let args: Vec&lt;String&gt; = env::args().collect();\n\n    if args.len() &gt; 2 {\n        let operation_mode = args[1].clone();\n        let address = args[2].clone();\n\n        if operation_mode == \"server\" {\n            start_server(address);\n        } else {\n            let msg = args[3].clone();\n            start_client(address, msg);\n        }\n    } else {\n        println!(\"not enough parameters\");\n    }\n}\n</code></pre>\n\n<p>To reproduce the problem, run the server process like this: <code>rm /tmp/sock &amp; RUST_BACKTRACE=1 cargo run server /tmp/sock</code> and the client process afterwards like this: <code>cargo run client /tmp/sock hello_world</code></p>\n\n<p>The expected output when the problem reproduces is that the server process prints its output as expected: <code>SERVER: hello_world received from remote client.</code> but the client process prints nothing, until the server process is killed, at which point it prints its expected output: <code>CLIENT: hello_world received from server.</code></p>\n\n<p>To confirm this problem is localized to the <code>read_to_end</code> method, uncomment the lines that are marked as the working variant and comment the ones marked for the example to work.</p>\n\n<p>What's the problem with this code? Am I using <code>read_to_end</code> wrong?</p>\n"}, {"tags": ["rust", "lifetime"], "owner": {"reputation": 73, "user_id": 5357514, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15542f29a2cdf117aa113f1481849c5b?s=128&d=identicon&r=PG&f=1", "display_name": "SK.Chen", "link": "https://stackoverflow.com/users/5357514/sk-chen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 334, "favorite_count": 0, "closed_date": 1528797901, "answer_count": 0, "score": 1, "last_activity_date": 1528797172, "creation_date": 1528792311, "last_edit_date": 1528797172, "question_id": 50812648, "link": "https://stackoverflow.com/questions/50812648/confused-by-temporary-value-dropped-here-while-still-borrowed", "closed_reason": "Duplicate", "title": "Confused by &quot;temporary value dropped here while still borrowed&quot;", "body": "<p>I'm confused by this error message about the type <code>&amp;str</code>:</p>\n\n<pre><code>let a = &amp;String::from(\"abcdefg\"); // ok!\nlet a = String::from(\"abcdefg\").as_str(); // compile error\n</code></pre>\n\n<p>The error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>let a = String::from(\"abcdefg\").as_str();\n^^^^^^^^^^^^^^^^^^^^^^^         - temporary value dropped here while still borrowed\ntemporary value does not live long enough\n</code></pre>\n\n<p>I understand that in the second line, the <code>String</code> object is a temporary object, it drops when the line is over. But why does the first line run ok?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528753165, "post_id": 50806286, "comment_id": 88618705, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/33687447/155423\">How to get a struct reference from a boxed trait?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50806286/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 195, "user_id": 1411900, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/9c247a2820a8fbb9db5b21e87a7f4e78?s=128&d=identicon&r=PG", "display_name": "user1411900", "link": "https://stackoverflow.com/users/1411900/user1411900"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528779446, "post_id": 50806286, "comment_id": 88624542, "body": "@Shepmaster: I actually meant to return the downcasted reference, so getting a reference to MyStruct with non-static lifetime is not sufficient."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1528811145, "post_id": 50806286, "comment_id": 88642703, "body": "This is surprisingly difficult, because you can&#39;t cross-cast from <code>Rc&lt;RefCell&lt;MyTrait&gt;&gt;</code> to <code>Rc&lt;RefCell&lt;Any&gt;&gt;</code>, and you can&#39;t use an <code>as_any</code> method on <code>MyTrait</code> because <code>Rc&lt;RefCell&lt;Self&gt;&gt;</code> isn&#39;t a valid receiver. <code>transmute</code> would appear to be your only option."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1528811312, "post_id": 50806286, "comment_id": 88642812, "body": "But what should <code>some_fn&lt;i32&gt;</code> do when the <code>HashMap</code> contains an <code>Rc&lt;RefCell&lt;String&gt;&gt;</code>? You have to account for failure somehow (e.g. by panicking, or returning an <code>Option</code>)."}, {"owner": {"reputation": 195, "user_id": 1411900, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/9c247a2820a8fbb9db5b21e87a7f4e78?s=128&d=identicon&r=PG", "display_name": "user1411900", "link": "https://stackoverflow.com/users/1411900/user1411900"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1528911226, "post_id": 50806286, "comment_id": 88689747, "body": "@trentcl: if the type does not match, it&#39;s fine to just panic.   Regarding transmuting, is there a recommended way to do that?   Are they bit-compatible?"}], "owner": {"reputation": 195, "user_id": 1411900, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/9c247a2820a8fbb9db5b21e87a7f4e78?s=128&d=identicon&r=PG", "display_name": "user1411900", "link": "https://stackoverflow.com/users/1411900/user1411900"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 276, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1528779498, "creation_date": 1528752487, "last_edit_date": 1528779498, "question_id": 50806286, "link": "https://stackoverflow.com/questions/50806286/is-it-possible-to-downcast-rcrefcellmytrait-to-a-generic-rcrefcellmystruct", "title": "Is it possible to downcast Rc&lt;RefCell&lt;MyTrait&gt;&gt; to a generic Rc&lt;RefCell&lt;MyStruct&lt;T&gt;&gt;&gt;?", "body": "<p>I have defined these:</p>\n\n<pre><code>struct MyStruct&lt;T&gt; { /* ... */ }\n\ntrait MyTrait: Any { /* ... */ }\n\nimpl&lt;T&gt; MyTrait for MyStruct&lt;T&gt; { /* ... */ }\n</code></pre>\n\n<p>Is it possible to downcast <code>Rc&lt;RefCell&lt;MyTrait&gt;&gt;</code> to <code>Rc&lt;RefCell&lt;MyStruct&lt;T&gt;&gt;&gt;</code> (in the context of a function generic on <code>T</code>)?</p>\n\n<pre><code>fn some_fn&lt;T&gt;(h: &amp;HashMap&lt;String, Rc&lt;RefCell&lt;MyTrait&gt;&gt;&gt;, key: &amp;str) -&gt; Rc&lt;RefCell&lt;MyStruct&lt;T&gt;&gt;&gt; {\n    let x: Rc&lt;RefCell&lt;MyTrait&gt;&gt; = h.get(key).unwrap().clone();\n    /* what goes here ??? */ (x)\n}\n</code></pre>\n"}, {"tags": ["c", "linux", "bash", "unix", "rust"], "comments": [{"owner": {"reputation": 32690, "user_id": 3266847, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/U0oyt.png?s=128&g=1", "display_name": "Benjamin W.", "link": "https://stackoverflow.com/users/3266847/benjamin-w"}, "edited": false, "score": 4, "creation_date": 1528724306, "post_id": 50798885, "comment_id": 88604043, "body": "Cross-site duplicate: <a href=\"https://unix.stackexchange.com/questions/164107/why-does-bash-process-substitution-not-work-with-some-commands\" title=\"why does bash process substitution not work with some commands\">unix.stackexchange.com/questions/164107/&hellip;</a>"}, {"owner": {"reputation": 51929, "user_id": 1084774, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/13403db744d8aa130bb317576cc1df30?s=128&d=identicon&r=PG", "display_name": "PSkocik", "link": "https://stackoverflow.com/users/1084774/pskocik"}, "edited": false, "score": 2, "creation_date": 1528731725, "post_id": 50798885, "comment_id": 88608853, "body": "Gcc is a Compiler Collection. If you don&#39;t specify the language with <code>-x c</code> (for C or with something else), it doesn&#39;t know what backend to use since there&#39;s no file extension to tell it, so it has to inspect the file. It does it by seeking, because read-ing might irreversibly consume a single shot stream and seeking fails on single shot streams (bash process substitution creates FIFO -- single-shot streams) and so it fails."}, {"owner": {"reputation": 233489, "user_id": 14122, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/5e2861b08f37fa306fbf5384994af688?s=128&d=identicon&r=PG", "display_name": "Charles Duffy", "link": "https://stackoverflow.com/users/14122/charles-duffy"}, "edited": false, "score": 0, "creation_date": 1528767542, "post_id": 50798885, "comment_id": 88621987, "body": "Ahh -- invoking <code>ld</code> (treating it as an object file) does explain things."}, {"owner": {"reputation": 199706, "user_id": 1566221, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/ce3ea4ffd1023d4382f397312352726d?s=128&d=identicon&r=PG", "display_name": "rici", "link": "https://stackoverflow.com/users/1566221/rici"}, "reply_to_user": {"reputation": 233489, "user_id": 14122, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/5e2861b08f37fa306fbf5384994af688?s=128&d=identicon&r=PG", "display_name": "Charles Duffy", "link": "https://stackoverflow.com/users/14122/charles-duffy"}, "edited": false, "score": 0, "creation_date": 1528776157, "post_id": 50798885, "comment_id": 88623685, "body": "@CharlesDuffy: Yeah, I used strace to track down the error, and it is indeed coming from <code>ld</code> (via <code>collect2</code>). The logic is that <code>ld</code> tries various ways to interpret the file, falling back on &quot;linker script&quot;. But since it can&#39;t rewind the file, it doesn&#39;t actually manage to do the tests."}], "answers": [{"comments": [{"owner": {"reputation": 51929, "user_id": 1084774, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/13403db744d8aa130bb317576cc1df30?s=128&d=identicon&r=PG", "display_name": "PSkocik", "link": "https://stackoverflow.com/users/1084774/pskocik"}, "reply_to_user": {"reputation": 233489, "user_id": 14122, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/5e2861b08f37fa306fbf5384994af688?s=128&d=identicon&r=PG", "display_name": "Charles Duffy", "link": "https://stackoverflow.com/users/14122/charles-duffy"}, "edited": false, "score": 0, "creation_date": 1528731370, "post_id": 50801156, "comment_id": 88608635, "body": "@CharlesDuffy <code>gcc -c some-fifo.c</code> does work. Try <code>rm -f some-fifo.c &amp;&amp; mkfifo some-fifo.c; echo &#39;#include&lt;stdio.h&gt; int main(){ printf(&quot;Hello world!\\n&quot;); return 0;}&#39; &gt; some-fifo.c &amp; gcc some-fifo.c &amp;&amp; .&#47;a.out</code> (or with <code>-c</code> )."}, {"owner": {"reputation": 233489, "user_id": 14122, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/5e2861b08f37fa306fbf5384994af688?s=128&d=identicon&r=PG", "display_name": "Charles Duffy", "link": "https://stackoverflow.com/users/14122/charles-duffy"}, "edited": false, "score": 0, "creation_date": 1528731428, "post_id": 50801156, "comment_id": 88608670, "body": "...hmm. Think I was actually running on a platform where the gcc binary is a wrapper, not real GCC. Does make sense that we&#39;d only scan file contents if/when the name isn&#39;t dispositive."}, {"owner": {"reputation": 16538, "user_id": 6770384, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/kXCNG.png?s=128&g=1", "display_name": "Socowi", "link": "https://stackoverflow.com/users/6770384/socowi"}, "edited": false, "score": 0, "creation_date": 1528731634, "post_id": 50801156, "comment_id": 88608801, "body": "Thank you both for the investigations. I shouldn&#39;t have made any assumptions for the reasons, therefore I removed my guess.  We should try with bigger and more complicated c programs. Maybe process substitution works only in some cases."}, {"owner": {"reputation": 199706, "user_id": 1566221, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/ce3ea4ffd1023d4382f397312352726d?s=128&d=identicon&r=PG", "display_name": "rici", "link": "https://stackoverflow.com/users/1566221/rici"}, "edited": false, "score": 0, "creation_date": 1528777687, "post_id": 50801156, "comment_id": 88624048, "body": "@Socowi: Process substitution works precisely in the case that you use <code>-x</code> to tell GCC which component to use to process the file. GCC is always a wrapper; which is why it is called a &quot;compiler collection&quot;."}], "tags": [], "owner": {"reputation": 16538, "user_id": 6770384, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/kXCNG.png?s=128&g=1", "display_name": "Socowi", "link": "https://stackoverflow.com/users/6770384/socowi"}, "is_accepted": false, "score": 2, "last_activity_date": 1528731984, "last_edit_date": 1528731984, "creation_date": 1528730580, "answer_id": 50801156, "question_id": 50798885, "link": "https://stackoverflow.com/questions/50798885/how-is-rustc-able-to-compile-source-code-from-bash-process-substitution-but-gcc/50801156#50801156", "title": "How is rustc able to compile source code from bash process substitution but gcc cannot?", "body": "<p>At least in your case, you can use process substition when specifying the input language manually, using <code>-xc</code>. However, you should put a newline after the include statement.</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ gcc -xc &lt;(echo '#include&lt;stdio.h&gt;\nint main(){ printf(\"Hello world!\\n\"); return 0;}')\n$ ls\na.out\n$ ./a.out \nHello world!\n</code></pre>\n\n<p>For a possible reason why this works, see Charles' answer and the comments on this answer.</p>\n"}, {"tags": [], "owner": {"reputation": 199706, "user_id": 1566221, "user_type": "registered", "accept_rate": 86, "profile_image": "https://www.gravatar.com/avatar/ce3ea4ffd1023d4382f397312352726d?s=128&d=identicon&r=PG", "display_name": "rici", "link": "https://stackoverflow.com/users/1566221/rici"}, "is_accepted": true, "score": 5, "last_activity_date": 1528777553, "creation_date": 1528777553, "answer_id": 50809234, "question_id": 50798885, "link": "https://stackoverflow.com/questions/50798885/how-is-rustc-able-to-compile-source-code-from-bash-process-substitution-but-gcc/50809234#50809234", "title": "How is rustc able to compile source code from bash process substitution but gcc cannot?", "body": "<p>The <code>gcc</code> command is mostly a dispatch engine. For each input file, it determines what sort of file it is <em>from the filename's extension</em>, and then passes the file on to an appropriate processor. So <code>.c</code> files are compiled by the C compiler, <code>.h</code> files are assembled into precompiled headers, <code>.go</code> files are sent to the cgo compiler, and so on. </p>\n\n<p>If the filename has no extension or the extension is not recognised, <code>gcc</code> assumes that it is some kind of object file which should participate in the final link step. These files are passed to the <code>collect2</code> utility, which then invokes <code>ld</code>, possibly twice. This will be the case with process substitution, which produces filenames like <code>/dev/fd/63</code>, which do not include extensions.</p>\n\n<p><code>ld</code> does not rely on the filename to identify the object file format. It is generally built with several different object file recognisers, each of which depends on some kind of \"magic number\" (that is, a special pattern at or near the beginning of the file). It calls these recognisers one at a time until it finds one which is happy to interpret the file. If the file is not recognised as a binary format, <code>ld</code> assumes that it is a linker script (which is a plain text file) and attempts to parse it as such.</p>\n\n<p>Naturally, between attempts <code>ld</code> needs to rewind the file, and since process substitution arranges for a pipe to be passed instead of a file, the seek will fail. (The same thing would happen if you attempted to pass the file through redirection of stdin to a pipe, which you can do: gcc will process <code>stdin</code> as a file if you specify <code>-</code> as a filename. But it insists that you tell it what kind of file it is. See below.)</p>\n\n<p>Since <code>ld</code> can't rewind the file, it will fail after the file doesn't match its first guess. Hence the error message from <code>ld</code>, which is a bit misleading since you might think that the file has already been compiled and the subsequent failure was in the link step. That's not the case; because the filename had no extension, <code>gcc</code> skipped directly to the link phase and almost immediately failed.</p>\n\n<p>In the case of process substitution, pipes, stdin, and badly-named files, you can still manually tell <code>gcc</code> what the file is. You do that with the <code>-x</code> option, which is documented in the <a href=\"https://gcc.gnu.org/onlinedocs/gcc-8.1.0/gcc/Overall-Options.html\" rel=\"noreferrer\">GCC manual section on options controlling the kind of output</a> (although in this case, the option actually controls the kind of input).</p>\n\n<p>There are a number of answers to questions like this floating around the Internet, including various answers here on StackOverflow, which claim that GCC attempts to detect the language of input files. It does not do that, and it never has. (And I doubt that it ever will, since some of the languages it compiles are sufficiently similar to each other that accurate detection would be impossible.) The only component which does automatic detection is <code>ld</code>, and it only does that once GCC has irrevocably decided to treat the input file as an object file or linker script.</p>\n"}], "owner": {"reputation": 31, "user_id": 8620270, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b9f7efaab54afa17b627cf3158f644f0?s=128&d=identicon&r=PG&f=1", "display_name": "Tom&#225;\u0161 Janeck&#253;", "link": "https://stackoverflow.com/users/8620270/tom%c3%a1%c5%a1-janeck%c3%bd"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 208, "favorite_count": 0, "accepted_answer_id": 50809234, "answer_count": 2, "score": 2, "last_activity_date": 1528777553, "creation_date": 1528723744, "last_edit_date": 1528726237, "question_id": 50798885, "link": "https://stackoverflow.com/questions/50798885/how-is-rustc-able-to-compile-source-code-from-bash-process-substitution-but-gcc", "title": "How is rustc able to compile source code from bash process substitution but gcc cannot?", "body": "<pre class=\"lang-none prettyprint-override\"><code>$ rustc &lt;(echo 'fn main(){ print!(\"Hello world!\");}')\n$ ls\n63\n$ gcc &lt;(echo '#include&lt;stdio.h&gt; int main(){ printf(\"Hello world!\\n\"); return 0;}')\n/dev/fd/63: file not recognized: Illegal seek\ncollect2: error: ld returned 1 exit status\n</code></pre>\n\n<p>Why can't <code>ld</code> link the program?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 309, "user_id": 3765143, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/520556fa20508660ada4b66e9fa598a3?s=128&d=identicon&r=PG&f=1", "display_name": "JuNijland", "link": "https://stackoverflow.com/users/3765143/junijland"}, "reply_to_user": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 2, "creation_date": 1528706048, "post_id": 50793089, "comment_id": 88592898, "body": "Thanks, I updated my question and hope it is clearer now"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1528706393, "post_id": 50793089, "comment_id": 88593084, "body": "Yes, much better. Thanks! :)"}], "answers": [{"comments": [{"owner": {"reputation": 309, "user_id": 3765143, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/520556fa20508660ada4b66e9fa598a3?s=128&d=identicon&r=PG&f=1", "display_name": "JuNijland", "link": "https://stackoverflow.com/users/3765143/junijland"}, "edited": false, "score": 0, "creation_date": 1528706020, "post_id": 50793296, "comment_id": 88592874, "body": "This is what I was looking for! The only problem left is that MessageWrite has a <code>Sized</code> bound, thus cannot be made into a object with <code>Box::new()</code>. Is there a solution for this?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 309, "user_id": 3765143, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/520556fa20508660ada4b66e9fa598a3?s=128&d=identicon&r=PG&f=1", "display_name": "JuNijland", "link": "https://stackoverflow.com/users/3765143/junijland"}, "edited": false, "score": 0, "creation_date": 1528706366, "post_id": 50793296, "comment_id": 88593074, "body": "@JuNijland Then you can call directly <code>write_file</code>"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 4, "last_activity_date": 1528706374, "last_edit_date": 1528706374, "creation_date": 1528705381, "answer_id": 50793296, "question_id": 50793089, "link": "https://stackoverflow.com/questions/50793089/how-do-i-call-a-trait-method-on-one-of-two-results-when-the-trait-is-not-object/50793296#50793296", "title": "How do I call a trait method on one of two Results when the trait is not object safe?", "body": "<p>You can use pattern-matching. See this example:</p>\n\n<pre><code>trait MessageWrite: Sized {}\n\nstruct Foo;\nstruct Bar;\n\nimpl MessageWrite for Foo {}\nimpl MessageWrite for Bar {}\n\nfn main() {\n    let f: Result&lt;Foo, ()&gt; = Ok(Foo{});\n    let b: Result&lt;Bar, ()&gt; = Err(());\n\n    match (f, b) {\n        (Ok(f), _) =&gt; write_file(f),\n        (_, Ok(b)) =&gt; write_file(b),\n        _ =&gt; panic!(),\n    };\n}\n\nfn write_file&lt;M: MessageWrite&gt;(msg: M) -&gt; std::io::Result&lt;()&gt; { Ok(()) }\n</code></pre>\n"}], "owner": {"reputation": 309, "user_id": 3765143, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/520556fa20508660ada4b66e9fa598a3?s=128&d=identicon&r=PG&f=1", "display_name": "JuNijland", "link": "https://stackoverflow.com/users/3765143/junijland"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 93, "favorite_count": 0, "accepted_answer_id": 50793296, "answer_count": 1, "score": 4, "last_activity_date": 1528726024, "creation_date": 1528704635, "last_edit_date": 1528726024, "question_id": 50793089, "link": "https://stackoverflow.com/questions/50793089/how-do-i-call-a-trait-method-on-one-of-two-results-when-the-trait-is-not-object", "title": "How do I call a trait method on one of two Results when the trait is not object safe?", "body": "<p>I want a variable <code>model</code> to either be a <code>Model1</code> or a <code>Model2</code>, dependent on the actual model that is encoded in <code>bytes</code>. How do I merge the two model <code>Result</code>s, from which only one is <code>Ok()</code>?</p>\n\n<pre><code>let model1 = Model1::from_reader(&amp;mut reader, &amp;bytes);\nlet model2 = Model2::from_reader(&amp;mut reader, &amp;bytes);\nlet model = /* ??? */;\nwrite_file(model).unwrap();\n</code></pre>\n\n<p>They both implement <code>MessageWrite</code>, which is the only trait that I need from this point on. Here is the prototype for <code>write_file()</code></p>\n\n<pre><code>fn write_file&lt;M: MessageWrite&gt;(msg: M) -&gt; io::Result&lt;()&gt;\n</code></pre>\n\n<p>I am using the quick-protobuf crate for the models. The <code>from_reader</code> prototype:</p>\n\n<pre><code>impl&lt;'a&gt; MessageRead&lt;'a&gt; for Model1&lt;'a&gt; {\n    fn from_reader(r: &amp;mut BytesReader, bytes: &amp;'a [u8]) -&gt; Result&lt;Self&gt; {\n        // ...\n    }\n}\n</code></pre>\n\n<p>And the <code>MessageWrite</code> trait. Note that is has a <code>Sized</code> bound.</p>\n\n<pre><code>pub trait MessageWrite: Sized {\n     // ...\n}\n</code></pre>\n"}, {"tags": ["rust", "hyper"], "answers": [{"comments": [{"owner": {"reputation": 33, "user_id": 8234291, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b7cbffe2b0d779b9f7d12624b1d1a582?s=128&d=identicon&r=PG&f=1", "display_name": "chuck", "link": "https://stackoverflow.com/users/8234291/chuck"}, "edited": false, "score": 0, "creation_date": 1528729219, "post_id": 50789925, "comment_id": 88607289, "body": "Thanks, that helped a lot!"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1528727911, "last_edit_date": 1528727911, "creation_date": 1528685462, "answer_id": 50789925, "question_id": 50788434, "link": "https://stackoverflow.com/questions/50788434/how-do-i-configure-a-hyper-0-11-x-client-variable-that-is-polymorphic-over-the-c/50789925#50789925", "title": "How do I configure a hyper 0.11.x client variable that is polymorphic over the connector?", "body": "<p>This solution is not pretty, but it does work.</p>\n\n<p>We start by creating an enum to handle the two cases:</p>\n\n<pre><code>enum ProxyOrNotConnector {\n    Proxy(ProxyConnector&lt;HttpConnector&gt;),\n    Not(HttpConnector),\n}\n</code></pre>\n\n<p>This enum can be a single type representing both cases. Constructing it is straightforward with a <code>match</code> statement:</p>\n\n<pre><code>let http_connector = HttpConnector::new(4, &amp;handle);\n\nlet connector = match (proxy_uri, use_proxy) {\n    (Some(proxy_uri), true) =&gt; {\n        println!(\"Using proxy: {}\", proxy_uri);\n        let proxy_uri = proxy_uri.parse().unwrap();\n        let mut proxy = Proxy::new(Intercept::All, proxy_uri);\n        let proxy_connector = ProxyConnector::from_proxy(http_connector, proxy).unwrap();\n        ProxyOrNotConnector::Proxy(proxy_connector)\n    }\n    _ =&gt; ProxyOrNotConnector::Not(http_connector),\n};\n</code></pre>\n\n<p>We can then create a <code>Client</code> using this connector:</p>\n\n<pre><code>let client = Config::default().connector(connector).build(&amp;handle);\n</code></pre>\n\n<p>This won't work until we've implemented <code>Connect</code> for our enum. There's a blanket implementation of <code>Connect</code> for any type that implements <code>Service</code> in the correct manner, so we go that route:</p>\n\n<pre><code>impl Service for ProxyOrNotConnector {\n    type Request = Uri;\n    type Response = Box&lt;AsyncRw&gt;;\n    type Error = io::Error;\n\n    type Future = Box&lt;Future&lt;Item = Self::Response, Error = Self::Error&gt;&gt;;\n\n    fn call(&amp;self, req: Self::Request) -&gt; Self::Future {\n        match self {\n            ProxyOrNotConnector::Proxy(p) =&gt; {\n                let x = p.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n            ProxyOrNotConnector::Not(n) =&gt; {\n                let x = n.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n        }\n    }\n}\n</code></pre>\n\n<p>We use multiple trait objects to perform runtime polymorphism: one for the future returned by connecting and another for each value yielded by that future.</p>\n\n<p>Complete code:</p>\n\n<pre><code>extern crate futures;\nextern crate hyper;\nextern crate hyper_proxy;\nextern crate tokio_core;\nextern crate tokio_io;\n\nuse futures::Future;\nuse hyper::{\n    client::{Config, HttpConnector, Service},\n    Uri,\n};\nuse hyper_proxy::{Intercept, Proxy, ProxyConnector};\nuse std::io;\nuse tokio_core::reactor::Core;\nuse tokio_io::{AsyncRead, AsyncWrite};\n\ntrait AsyncRw: AsyncWrite + AsyncRead {}\nimpl&lt;T&gt; AsyncRw for T where T: AsyncWrite + AsyncRead {}\n\nenum ProxyOrNotConnector {\n    Proxy(ProxyConnector&lt;HttpConnector&gt;),\n    Not(HttpConnector),\n}\n\nimpl Service for ProxyOrNotConnector {\n    type Request = Uri;\n    type Response = Box&lt;AsyncRw&gt;;\n    type Error = io::Error;\n\n    type Future = Box&lt;Future&lt;Item = Self::Response, Error = Self::Error&gt;&gt;;\n\n    fn call(&amp;self, req: Self::Request) -&gt; Self::Future {\n        match self {\n            ProxyOrNotConnector::Proxy(p) =&gt; {\n                let x = p.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n            ProxyOrNotConnector::Not(n) =&gt; {\n                let x = n.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n        }\n    }\n}\n\nfn main() {\n    let mut core = Core::new().unwrap();\n    let handle = core.handle();\n\n    let proxy_uri = Some(\"http://127.0.0.1\");\n    let use_proxy = true;\n\n    let http_connector = HttpConnector::new(4, &amp;handle);\n\n    let connector = match (proxy_uri, use_proxy) {\n        (Some(proxy_uri), true) =&gt; {\n            println!(\"Using proxy: {}\", proxy_uri);\n            let proxy_uri = proxy_uri.parse().unwrap();\n            let mut proxy = Proxy::new(Intercept::All, proxy_uri);\n            let proxy_connector = ProxyConnector::from_proxy(http_connector, proxy).unwrap();\n            ProxyOrNotConnector::Proxy(proxy_connector)\n        }\n        _ =&gt; ProxyOrNotConnector::Not(http_connector),\n    };\n\n    let client = Config::default().connector(connector).build(&amp;handle);\n    let g = client.get(\"http://127.0.0.1/\".parse().unwrap());\n\n    let x = core.run(g).unwrap();\n    println!(\"{:?}\", x);\n}\n</code></pre>\n\n<p>I don't actually have a proxy lying around to test with, but it does compile and report a reasonable error about not being able to connect.</p>\n"}, {"tags": [], "owner": {"reputation": 33, "user_id": 8234291, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b7cbffe2b0d779b9f7d12624b1d1a582?s=128&d=identicon&r=PG&f=1", "display_name": "chuck", "link": "https://stackoverflow.com/users/8234291/chuck"}, "is_accepted": false, "score": 0, "last_activity_date": 1528729111, "creation_date": 1528729111, "answer_id": 50800701, "question_id": 50788434, "link": "https://stackoverflow.com/questions/50788434/how-do-i-configure-a-hyper-0-11-x-client-variable-that-is-polymorphic-over-the-c/50800701#50800701", "title": "How do I configure a hyper 0.11.x client variable that is polymorphic over the connector?", "body": "<p>Building on @Shepmaster's answer, the code below has been tested using Privoxy.</p>\n\n<p>We use the double if let clauses to first extract the type hidden by ProxyOrNotConnector and then modify the http request to use the proxy.</p>\n\n<pre><code>if let ProxyOrNotConnector::Proxy(x) = connector.clone() {\n    if let Some(headers) = x.http_headers(&amp;uri) {\n        req.headers_mut().extend(headers.iter());\n        req.set_proxy(true);\n    }\n}\n</code></pre>\n\n<p>Complete code:</p>\n\n<pre><code>extern crate futures;\nextern crate hyper;\nextern crate hyper_proxy;\nextern crate tokio_core;\nextern crate tokio_io;\n\nuse futures::{Future, Stream};\nuse hyper::{Chunk, Method, Request, Uri, client::{Config, HttpConnector, Service}};\nuse hyper_proxy::{Intercept, Proxy, ProxyConnector};\nuse std::io;\nuse tokio_core::reactor::Core;\nuse tokio_io::{AsyncRead, AsyncWrite};\n\ntrait AsyncRw: AsyncWrite + AsyncRead {}\nimpl&lt;T&gt; AsyncRw for T\nwhere\n    T: AsyncWrite + AsyncRead,\n{\n}\n\n#[derive(Clone)]\nenum ProxyOrNotConnector {\n    Proxy(ProxyConnector&lt;HttpConnector&gt;),\n    Not(HttpConnector),\n}\n\nimpl Service for ProxyOrNotConnector {\n    type Request = Uri;\n    type Response = Box&lt;AsyncRw&gt;;\n    type Error = io::Error;\n\n    type Future = Box&lt;Future&lt;Item = Self::Response, Error = Self::Error&gt;&gt;;\n\n    fn call(&amp;self, req: Self::Request) -&gt; Self::Future {\n        match self {\n            ProxyOrNotConnector::Proxy(p) =&gt; {\n                let x = p.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n            ProxyOrNotConnector::Not(n) =&gt; {\n                let x = n.call(req);\n                let y = x.map(|y| Box::new(y) as Box&lt;AsyncRw&gt;);\n                Box::new(y)\n            }\n        }\n    }\n}\n\nfn main() {\n    let proxy_uri = Some(\"http://localhost:8118\");\n    let use_proxy = true;\n    let uri: Uri = \"http://httpbin.org/ip\".parse().unwrap();\n\n    let mut core = Core::new().unwrap();\n    let handle = core.handle();\n    let http_connector = HttpConnector::new(4, &amp;handle);\n\n    let connector = match (proxy_uri, use_proxy) {\n        (Some(proxy_uri), true) =&gt; {\n            println!(\"Using proxy: {}\", proxy_uri);\n            let proxy_uri = proxy_uri.parse().unwrap();\n            let proxy = Some(Proxy::new(Intercept::All, proxy_uri));\n            let proxy_connector =\n                ProxyConnector::from_proxy(http_connector, proxy.unwrap()).unwrap();\n            ProxyOrNotConnector::Proxy(proxy_connector)\n        }\n        _ =&gt; ProxyOrNotConnector::Not(http_connector),\n    };\n\n    let client = Config::default().connector(connector.clone()).build(&amp;handle);\n    let mut req: hyper::Request;\n    match use_proxy {\n        true =&gt; {\n            req = Request::new(Method::Get, uri.clone());\n            if let ProxyOrNotConnector::Proxy(x) = connector.clone() {\n                if let Some(headers) = x.http_headers(&amp;uri) {\n                    req.headers_mut().extend(headers.iter());\n                    req.set_proxy(true);\n                }\n            }\n        }\n        false =&gt; req = Request::new(Method::Get, uri.clone()),\n    }\n\n    let future_http = client\n        .request(req)\n        .and_then(|res| res.body().concat2())\n        .map(move |body: Chunk| ::std::str::from_utf8(&amp;body).unwrap().to_string());\n\n    let x = core.run(future_http).unwrap();\n    println!(\"{:?}\", x);\n}\n</code></pre>\n"}], "owner": {"reputation": 33, "user_id": 8234291, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b7cbffe2b0d779b9f7d12624b1d1a582?s=128&d=identicon&r=PG&f=1", "display_name": "chuck", "link": "https://stackoverflow.com/users/8234291/chuck"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 199, "favorite_count": 1, "accepted_answer_id": 50789925, "answer_count": 2, "score": 3, "last_activity_date": 1528729111, "creation_date": 1528668019, "last_edit_date": 1528683690, "question_id": 50788434, "link": "https://stackoverflow.com/questions/50788434/how-do-i-configure-a-hyper-0-11-x-client-variable-that-is-polymorphic-over-the-c", "title": "How do I configure a hyper 0.11.x client variable that is polymorphic over the connector?", "body": "<p>I can't seem to figure out how to get Rust to accept a client and proxied client in the same variable. While I am still new to Rust, I have a basic understanding of programming. So far I have tried structs (but no impl's though), type casting, uninitialized variables, but nothing is working.</p>\n\n<pre><code>extern crate futures;\nextern crate hyper;\nextern crate hyper_proxy;\nextern crate stopwatch;\nextern crate tokio_core;\n\nuse futures::{Future, Stream};\nuse hyper::client::HttpConnector;\nuse hyper::Client;\nuse hyper_proxy::{Intercept, Proxy, ProxyConnector};\nuse tokio_core::reactor::Core;\n\nfn main() {\n    let use_proxy = true;\n    let proxy_uri: Option&lt;String&gt; = Some(\"http://localhost:8118\".to_owned());\n\n    let mut core = Core::new().unwrap();\n    let handle = core.handle();\n    let mut proxy = None;\n    // looking for polymorphic variable that works with both proxyed and unproxyed hyper clients\n    let mut client: hyper::Client&lt;hyper::client::HttpConnector, hyper::Body&gt;;\n\n    if use_proxy &amp;&amp; proxy_uri.is_some() {\n        println!(\"Using proxy: {}\", proxy_uri.unwrap().as_str());\n        proxy = Some({\n            let proxy_uri = proxy_uri.unwrap().parse().unwrap();\n            let mut proxy = Proxy::new(Intercept::All, proxy_uri);\n            let connector = HttpConnector::new(4, &amp;handle);\n            let proxy_connector = ProxyConnector::from_proxy(connector, proxy).unwrap();\n            proxy_connector\n        });\n        client = Client::configure()\n            .connector(proxy.clone().unwrap())\n            .build(&amp;handle);\n    } else {\n        client = Client::configure()\n            .connector(HttpConnector::new(4, &amp;handle))\n            .build(&amp;handle);\n    }\n\n    // use hyper client below\n}\n</code></pre>\n\n<pre><code>[dependencies]\nfutures = \"0.1.21\"\nhyper = \"0.11.27\"\ntokio-core = \"0.1.17\"\nhyper-proxy = \"0.4.1\"\nstopwatch = \"0.0.7\"\n</code></pre>\n\n<p>I have made <a href=\"https://github.com/dbchuck/hyper_stackoverflow\" rel=\"nofollow noreferrer\">a GitHub repo of all the files</a>.</p>\n\n<p>I get this error when trying to compile:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code> error[E0308]: mismatched types\n  --&gt; src/main.rs:32:18\n   |\n32 |           client = Client::configure()\n   |  __________________^\n33 | |             .connector(proxy.clone().unwrap())\n34 | |             .build(&amp;handle);\n   | |___________________________^ expected struct `hyper::client::HttpConnector`, found struct `hyper_proxy::ProxyConnector`\n   |\n   = note: expected type `hyper::Client&lt;hyper::client::HttpConnector, _&gt;`\n              found type `hyper::Client&lt;hyper_proxy::ProxyConnector&lt;hyper::client::HttpConnector&gt;, _&gt;`\n</code></pre>\n\n<p>If there is a better approach to this, I would also like to know about it.</p>\n"}, {"tags": ["file", "vector", "io", "rust"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 3, "last_activity_date": 1583765047, "last_edit_date": 1583765047, "creation_date": 1528665775, "answer_id": 50788166, "question_id": 50788009, "link": "https://stackoverflow.com/questions/50788009/how-do-i-get-a-random-line-from-a-file/50788166#50788166", "title": "How do I get a random line from a file?", "body": "<p>Use <a href=\"https://docs.rs/rand/0.7.3/rand/seq/trait.IteratorRandom.html#method.choose\" rel=\"nofollow noreferrer\"><code>IteratorRandom::choose</code></a> to randomly sample from an iterator using <a href=\"https://en.wikipedia.org/wiki/Reservoir_sampling\" rel=\"nofollow noreferrer\">reservoir sampling</a>. This will scan through the entire file once, creating <code>String</code>s for each line, but it will not create a giant vector for every line:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use rand::seq::IteratorRandom; // 0.7.3\nuse std::{\n    fs::File,\n    io::{BufRead, BufReader},\n};\n\nconst FILENAME: &amp;str = \"/etc/hosts\";\n\nfn find_word() -&gt; String {\n    let f = File::open(FILENAME)\n        .unwrap_or_else(|e| panic!(\"(;_;) file not found: {}: {}\", FILENAME, e));\n    let f = BufReader::new(f);\n\n    let lines = f.lines().map(|l| l.expect(\"Couldn't read line\"));\n\n    lines\n        .choose(&amp;mut rand::thread_rng())\n        .expect(\"File had no lines\")\n}\n</code></pre>\n\n<hr>\n\n<p>Your original problem is that:</p>\n\n<ol>\n<li><p><a href=\"https://doc.rust-lang.org/std/primitive.slice.html#method.get\" rel=\"nofollow noreferrer\"><code>slice::get</code></a> returns an optional reference into the vector. </p>\n\n<p>You can either clone this or take ownership of the value:</p>\n\n<pre><code>let line = lines[n].cloned()\n</code></pre>\n\n<pre><code>let line = lines.swap_remove(n)\n</code></pre>\n\n<p>Both of these panic if <code>n</code> is out-of-bounds, which is reasonable here as you know that you are in bounds.</p></li>\n<li><p><a href=\"https://doc.rust-lang.org/std/io/struct.Lines.html\" rel=\"nofollow noreferrer\"><code>BufRead::lines</code></a> returns <code>io::Result&lt;String&gt;</code>, so you have to handle that error case.</p></li>\n</ol>\n\n<p>Additionally, don't use <code>format!</code> with <code>expect</code>:</p>\n\n<blockquote>\n<pre><code>expect(&amp;format!(\"...\"))\n</code></pre>\n</blockquote>\n\n<p>This will <em>unconditionally allocate memory</em>. When there's no failure, that allocation is wasted. Use <code>unwrap_or_else</code> as shown.</p>\n"}, {"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 1, "last_activity_date": 1528700518, "creation_date": 1528700518, "answer_id": 50792034, "question_id": 50788009, "link": "https://stackoverflow.com/questions/50788009/how-do-i-get-a-random-line-from-a-file/50792034#50792034", "title": "How do I get a random line from a file?", "body": "<blockquote>\n  <p>Is there a better way to get a random line from a file that doesn't involve collecting the whole file in a <code>Vec</code>?</p>\n</blockquote>\n\n<p>You will always need to read the whole file, if only to know the number of lines. However, you don't need to store everything in memory, you can read lines one by one and discard them as you go so that you only keep one in the end. Here is how it goes:</p>\n\n<ul>\n<li>Read and store the first line;</li>\n<li>Read the second line, draw a random choice and either:\n\n<ul>\n<li>keep the first line with a probability of 50%,</li>\n<li>or discard the first line and store the second line with a probability of 50%,</li>\n</ul></li>\n<li>Keep reading lines from the file and for line number <code>n</code>, draw a random choice and:\n\n<ul>\n<li>keep the currently stored line with a probability of <code>(n-1)/n</code>,</li>\n<li>or replace the currently stored line with the current line with a probability of <code>1/n</code>.</li>\n</ul></li>\n</ul>\n\n<p>Note that this is more or less what <a href=\"https://docs.rs/rand/0.5.1/rand/seq/fn.sample_iter.html\" rel=\"nofollow noreferrer\"><code>sample_iter</code></a> does, except that <code>sample_iter</code> is more generic since it can work on any iterator and it can pick samples of any size (eg. it can choose <code>k</code> items randomly).</p>\n"}], "owner": {"reputation": 37, "user_id": 9565348, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/db76d4498401f886a29512a1f2b489e0?s=128&d=identicon&r=PG&f=1", "display_name": "J. Smith", "link": "https://stackoverflow.com/users/9565348/j-smith"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 333, "favorite_count": 0, "accepted_answer_id": 50788166, "answer_count": 2, "score": 2, "last_activity_date": 1583765047, "creation_date": 1528664478, "last_edit_date": 1528665920, "question_id": 50788009, "link": "https://stackoverflow.com/questions/50788009/how-do-i-get-a-random-line-from-a-file", "title": "How do I get a random line from a file?", "body": "<p>I'm trying to get a random line from a file:</p>\n\n<pre><code>extern crate rand;\n\nuse rand::Rng;\nuse std::{\n    fs::File,\n    io::{prelude::*, BufReader},\n};\n\nconst FILENAME: &amp;str = \"/etc/hosts\";\n\nfn find_word() -&gt; String {\n    let f = File::open(FILENAME).expect(&amp;format!(\"(;_;) file not found: {}\", FILENAME));\n    let f = BufReader::new(f);\n\n    let lines: Vec&lt;_&gt; = f.lines().collect();\n\n    let n = rand::thread_rng().gen_range(0, lines.len());\n    let line = lines\n        .get(n)\n        .expect(&amp;format!(\"(;_;) Couldn't get {}th line\", n))\n        .unwrap_or(String::from(\"\"));\n\n    line\n}\n</code></pre>\n\n<p>This code doesn't work:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of borrowed content\n  --&gt; src/main.rs:18:16\n   |\n18 |       let line = lines\n   |  ________________^\n19 | |         .get(n)\n20 | |         .expect(&amp;format!(\"(;_;) Couldn't get {}th line\", n))\n   | |____________________________________________________________^ cannot move out of borrowed content\n</code></pre>\n\n<p>I tried adding <code>.clone()</code> before <code>.expect(...)</code> and before <code>.unwrap_or(...)</code> but it gave the same error.</p>\n\n<p>Is there a better way to get a random line from a file that doesn't involve collecting the whole file in a <code>Vec</code>?</p>\n"}, {"tags": ["rust", "borrow-checker"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528666514, "post_id": 50787230, "comment_id": 88582812, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/50787230/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Ideally, produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a>. Note that you can probably <b>remove</b> unneeded code from your question, <i>reducing</i> the problem to a very small test case."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528666548, "post_id": 50787230, "comment_id": 88582820, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/37986640/155423\">Cannot obtain a mutable reference when iterating a recursive structure: cannot borrow as mutable more than once at a time</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50787230/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 26154, "user_id": 5436257, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/iGuaK.jpg?s=128&g=1", "display_name": "Joe Clay", "link": "https://stackoverflow.com/users/5436257/joe-clay"}, "edited": false, "score": 0, "creation_date": 1528705052, "post_id": 50787230, "comment_id": 88592353, "body": "Recommended reading on this topic, in case you&#39;ve not already stumbled across these: <a href=\"https://rust-leipzig.github.io/architecture/2016/12/20/idiomatic-trees-in-rust/\" rel=\"nofollow noreferrer\">rust-leipzig.github.io/architecture/2016/12/20/&hellip;</a> and <a href=\"http://smallcultfollowing.com/babysteps/blog/2015/04/06/modeling-graphs-in-rust-using-vector-indices/\" rel=\"nofollow noreferrer\">smallcultfollowing.com/babysteps/blog/2015/04/06/&hellip;</a>"}, {"owner": {"reputation": 1351, "user_id": 2129181, "user_type": "registered", "accept_rate": 38, "profile_image": "https://i.stack.imgur.com/ZzNsf.jpg?s=128&g=1", "display_name": "Araz Abishov", "link": "https://stackoverflow.com/users/2129181/araz-abishov"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528741071, "post_id": 50787230, "comment_id": 88613593, "body": "Thanks a lot for replies. @Shepmaster Valid points, I have updated my question with a simplified example and created a gist on rust playground. The question you have linked involves only iteration over recursive data structure, but doesn&#39;t consider building a data structure (array) consisting of visited nodes. That&#39;s exactly where I am facing issues.   If you comment out lines 108 and 109 in the playground sample, borrow-checker will be happy, but that&#39;s what I actually need to solve."}, {"owner": {"reputation": 1351, "user_id": 2129181, "user_type": "registered", "accept_rate": 38, "profile_image": "https://i.stack.imgur.com/ZzNsf.jpg?s=128&g=1", "display_name": "Araz Abishov", "link": "https://stackoverflow.com/users/2129181/araz-abishov"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528741565, "post_id": 50787230, "comment_id": 88613819, "body": "I just to want to emphasize, that iterating over data structure is <i>not</i> an issue. I am following similar approach as in the accepted answer to the question @Shepmaster has linked. Building an array of visited nodes <i>while</i> iterating over data structure, that&#39;s where the problem lies."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528755190, "post_id": 50787230, "comment_id": 88619379, "body": "@ArazAbishov <i>Questions seeking debugging help (&quot;why isn&#39;t this code working?&quot;) must include the desired behavior, a specific problem or error and <b>the shortest code</b> necessary to reproduce it <b>in the question itself</b>.</i> \u2014 If you don&#39;t care to put the effort in to create this <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, then this question is off-topic for Stack Overflow."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528757433, "post_id": 50787230, "comment_id": 88619917, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/49057270/155423\">Is there a way to iterate over a mutable tree to get a random node?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50787230/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 1351, "user_id": 2129181, "user_type": "registered", "accept_rate": 38, "profile_image": "https://i.stack.imgur.com/ZzNsf.jpg?s=128&g=1", "display_name": "Araz Abishov", "link": "https://stackoverflow.com/users/2129181/araz-abishov"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528879421, "post_id": 50787230, "comment_id": 88669519, "body": "@Shepmaster I have updated the question again to include more details. I have taken a look into the question you have linked, and it seems that the answer is that in a tree like data structure you can&#39;t have a mutable iter (or a collection of mutable references). I will try to investigate this further, but I still don&#39;t have a firm answer to my own problem. Thanks."}, {"owner": {"reputation": 60956, "user_id": 8922, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/f1634a09333f7b391db92e1d2bea6253?s=128&d=identicon&r=PG", "display_name": "Sebastian Redl", "link": "https://stackoverflow.com/users/8922/sebastian-redl"}, "edited": false, "score": 1, "creation_date": 1528880269, "post_id": 50787230, "comment_id": 88670018, "body": "You cannot achieve this without unsafe code or internal mutability."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1528887338, "post_id": 50787230, "comment_id": 88674633, "body": "A more accurate way to put it might be that you can&#39;t have a collection of mutable references to <i>overlapping subtrees</i>. With internal mutability (<code>RefCell</code>), simultaneous mutable references to distinct nodes would be fine and safe."}, {"owner": {"reputation": 1351, "user_id": 2129181, "user_type": "registered", "accept_rate": 38, "profile_image": "https://i.stack.imgur.com/ZzNsf.jpg?s=128&g=1", "display_name": "Araz Abishov", "link": "https://stackoverflow.com/users/2129181/araz-abishov"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1528887942, "post_id": 50787230, "comment_id": 88674960, "body": "@trentcl Thanks a bunch! The point regarding overlapping subtrees makes so much sense now. I will try to experiment with RefCell and report back if it works."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1528890139, "post_id": 50787230, "comment_id": 88676366, "body": "If you are able to get it working (and you agree that this question is a duplicate of the other one), please consider writing an answer to the other question using <code>RefCell</code>! Keeping related answers together may help future readers who have similar questions."}], "owner": {"reputation": 1351, "user_id": 2129181, "user_type": "registered", "accept_rate": 38, "profile_image": "https://i.stack.imgur.com/ZzNsf.jpg?s=128&g=1", "display_name": "Araz Abishov", "link": "https://stackoverflow.com/users/2129181/araz-abishov"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 98, "favorite_count": 0, "closed_date": 1528899350, "answer_count": 0, "score": 0, "last_activity_date": 1528876305, "creation_date": 1528658318, "last_edit_date": 1528876305, "question_id": 50787230, "link": "https://stackoverflow.com/questions/50787230/fighting-borrow-checker-and-lexical-lifetimes", "closed_reason": "Duplicate", "title": "Fighting borrow-checker and lexical lifetimes", "body": "<p>I am trying to build a path from the root to leaf nodes in a tree-like data structure. The path is represented by an array (<code>path</code>) of mutable references to nodes:</p>\n\n<pre><code>fn build_path(&amp;mut self, index: Index, shift: Shift) {\n    debug_assert!(shift.0 &gt;= BITS_PER_LEVEL);\n\n    let mut path: [Option&lt;&amp;mut Node&lt;T&gt;&gt;; MAX_HEIGHT] = new_path!();\n    let mut path_i = 0;\n\n    let mut node = self;\n    let mut shift = shift;\n\n    while shift.0 != BITS_PER_LEVEL {\n        let cnode = node;\n\n        let child = match *cnode {\n            Node::Leaf { .. } =&gt; unreachable!(),\n            Node::RelaxedBranch { .. } =&gt; unreachable!(),\n            Node::Branch { ref mut children, len: _ } =&gt; {\n                let i = index.child(shift);\n                children[i].as_mut().unwrap()\n            }\n        };\n\n        path[path_i] = Some(cnode);\n        path_i = path_i + 1;\n\n        node = Arc::make_mut(child);\n        shift = shift.dec();\n    }\n}\n</code></pre>\n\n<p>The borrow-checker spits out a compilation error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0499]: cannot borrow `*cnode` as mutable more than once at a time\n   --&gt; src/main.rs:108:33\n    |\n102 | Node::Branch { ref mut children, len: _ } =&gt; {\n    |                ---------------- first mutable borrow occurs here\n...\n108 | path[path_i] = Some(cnode);\n    |                     ^^^^^ second mutable borrow occurs here\n...\n113 | }\n    | - first borrow ends here\n</code></pre>\n\n<p>How should I approach this problem? I have tried various workarounds, but unfortunately none of them worked. </p>\n\n<hr>\n\n<h2><strong>Edit #1</strong></h2>\n\n<p>Here is a link to the rust playground with an executable code snippet: <a href=\"https://play.rust-lang.org/?gist=0e2a208a5fe5472229db30ac3d44c60d&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?gist=0e2a208a5fe5472229db30ac3d44c60d&amp;version=nightly&amp;mode=debug</a></p>\n\n<hr>\n\n<h2><strong>Edit #2</strong></h2>\n\n<p>I just to want to emphasize, that iterating over the data structure itself is not an issue. What I want to achieve is to have an array (see variable path in the build_path method) of mutable references to the nodes of a tree. </p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1528654907, "creation_date": 1528654907, "answer_id": 50786779, "question_id": 50786312, "link": "https://stackoverflow.com/questions/50786312/how-can-i-provide-a-custom-test-attribute/50786779#50786779", "title": "How can I provide a custom test attribute?", "body": "<blockquote>\n  <p>How do I add something like <code>#[test]</code></p>\n</blockquote>\n\n<p>You don't, at least not yet.</p>\n\n<p>In nightly Rust, you could <a href=\"https://stackoverflow.com/q/25561137/155423\">write a compiler plugin</a> that would allow you to add such an attribute, but the attribute isn't the important part. </p>\n\n<p>The collection of all the annotated functions and generation of the testing harness are all <a href=\"https://github.com/rust-lang/rust/blob/1.26.2/src/librustc_driver/driver.rs#L816-L823\" rel=\"nofollow noreferrer\">hardcoded into the <code>rustc</code> executable</a>. There are no user-facing hooks to do the same operations.</p>\n\n<p><a href=\"https://github.com/rust-lang/rfcs/blob/master/text/2318-custom-test-frameworks.md\" rel=\"nofollow noreferrer\">Experimental RFC 2318</a> aims to rectify this by making it possible to create custom test frameworks with the same ergonomics as the built in framework.</p>\n\n<p>Existing custom test frameworks use macros / procedural macros / syntax extensions to expand their code to fit into the built in test framework.</p>\n"}], "owner": {"reputation": 1434, "user_id": 3691554, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/2479edc9e2237ac67d4df87105fbc656?s=128&d=identicon&r=PG&f=1", "display_name": "SoniEx2", "link": "https://stackoverflow.com/users/3691554/soniex2"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 78, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1528654907, "creation_date": 1528651874, "question_id": 50786312, "link": "https://stackoverflow.com/questions/50786312/how-can-i-provide-a-custom-test-attribute", "title": "How can I provide a custom test attribute?", "body": "<p>I have a library for writing hexchat plugins. I'd like to be able to write unit tests for those. How do I add something like <code>#[test]</code>, but for testing plugins from within hexchat?</p>\n"}, {"tags": ["rust", "memory-layout"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1528648034, "post_id": 50785070, "comment_id": 88577940, "body": "You can sacrifice an entire byte and then store your number in the remaining 3 bytes as <code>[u8; 3]</code> and use accessors to use the value. But then you are limited to maximum values of 0x1000000. it will be a little fiddly still, to get the endianness right etc when reading and writing. To get the full range of values, you&#39;d have to use a smaller type as the first value, and then manually preserve the first byte, <i>in case</i> it has been used in an <code>Option</code>. This seems like a crazy amount of effort though, and you&#39;ll have no guarantees that it won&#39;t break in the future, if a different bit is used."}, {"owner": {"reputation": 466742, "user_id": 224671, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/c90de868a7e95d75bdfd6a906dfedac7?s=128&d=identicon&r=PG", "display_name": "kennytm", "link": "https://stackoverflow.com/users/224671/kennytm"}, "edited": false, "score": 0, "creation_date": 1528648502, "post_id": 50785070, "comment_id": 88578075, "body": "Would your <code>u32</code> be zero? Or just never <code>u32::max_value()</code>? What is the valid range of <code>Foo</code>?"}, {"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "reply_to_user": {"reputation": 466742, "user_id": 224671, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/c90de868a7e95d75bdfd6a906dfedac7?s=128&d=identicon&r=PG", "display_name": "kennytm", "link": "https://stackoverflow.com/users/224671/kennytm"}, "edited": false, "score": 0, "creation_date": 1528648793, "post_id": 50785070, "comment_id": 88578165, "body": "@kennytm I edited my question. So in my real application, <code>u32::max_value()</code> is the only value not used by <code>Foo</code>. But I&#39;d also be interested in the two other cases I added at the end. @Peter Hall 2^24 values are sadly not enough for me :/"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528650674, "post_id": 50785070, "comment_id": 88578700, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/30414068/155423\">Can I use the \u201cnull pointer optimization\u201d for my own non-pointer types?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50785070/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 53, "favorite_count": 0, "closed_date": 1528651040, "answer_count": 0, "score": 3, "last_activity_date": 1528648728, "creation_date": 1528643473, "last_edit_date": 1528648728, "question_id": 50785070, "link": "https://stackoverflow.com/questions/50785070/can-i-make-size-ofoptionmytype-size-ofmytype-by-telling-the-com", "closed_reason": "Duplicate", "title": "Can I make size_of::&lt;Option&lt;MyType&gt;&gt;() == size_of::&lt;MyType&gt;() by telling the compiler which values are never inhabited by `MyType`?", "body": "<p>I have this type:</p>\n\n<pre><code>struct Foo(u32);\n</code></pre>\n\n<p>The way I use <code>Foo</code>, I know that the <code>u32</code> inside can never hold the value <code>u32::max_value()</code> (but all other values of <code>u32</code>). In my application, I need to store <em>many</em> instances of <code>Option&lt;Foo&gt;</code>. Thus, it would be really helpful if <code>Option&lt;Foo&gt;</code> would only occupy 32 bits of memory, and not 64 <a href=\"https://play.rust-lang.org/?gist=32758247e0c3d8b126e98fd5610767f5&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">as <code>Option&lt;u32&gt;</code> does</a>.</p>\n\n<p>I know that Rust performs this optimization for types like <code>Option&lt;&amp;T&gt;</code> where it knows that <code>&amp;T</code> can never have the value zero. And I also heard about some nice memory layout optimizations that were merged some time ago. </p>\n\n<p><strong>Can I somehow inform the compiler about this possible memory layout optimization?</strong></p>\n\n<hr>\n\n<p>If this is not possible in my exact scenario, would it be possible, if ...</p>\n\n<ul>\n<li>... <code>Foo</code>'s <code>u32</code> would never be <code>0</code>? (Maybe it's possible because this is closer to the <code>Option&lt;&amp;T&gt;</code> case?)</li>\n<li>... <code>Foo</code>'s <code>u32</code> would only use 31 bits? (Maybe we can at least tell Rust that a bit is unused?)</li>\n</ul>\n"}, {"tags": ["rust", "associated-types"], "comments": [{"owner": {"reputation": 466742, "user_id": 224671, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/c90de868a7e95d75bdfd6a906dfedac7?s=128&d=identicon&r=PG", "display_name": "kennytm", "link": "https://stackoverflow.com/users/224671/kennytm"}, "edited": false, "score": 4, "creation_date": 1528630499, "post_id": 50782704, "comment_id": 88573016, "body": "Not compressible now, but there&#39;s an open RFC for this. <a href=\"https://github.com/rust-lang/rfcs/pull/2289\" rel=\"nofollow noreferrer\">github.com/rust-lang/rfcs/pull/2289</a>"}], "answers": [{"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 1, "last_activity_date": 1572609759, "creation_date": 1572609759, "answer_id": 58658934, "question_id": 50782704, "link": "https://stackoverflow.com/questions/50782704/is-it-possible-to-combine-bounds-of-nested-associated-types/58658934#58658934", "title": "Is it possible to combine bounds of nested associated types?", "body": "<p>This is now possible with the <strong>unstable feature <code>associated_type_bounds</code></strong> (<a href=\"https://github.com/rust-lang/rust/issues/52662\" rel=\"nofollow noreferrer\">tracking issue</a>).</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(associated_type_bounds)]\n\nfn do_the_thing&lt;T&gt;(_: T)\nwhere\n    T: Foo&lt;FooType: Bar&lt;BarType: Baz&lt;BazType: Clone&gt;&gt;&gt;,\n{}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=2a3c241c77174e3716bdcc9682f51c69\" rel=\"nofollow noreferrer\">Playground</a>)</p>\n"}], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 158, "favorite_count": 0, "accepted_answer_id": 58658934, "answer_count": 1, "score": 4, "last_activity_date": 1572609759, "creation_date": 1528626096, "question_id": 50782704, "link": "https://stackoverflow.com/questions/50782704/is-it-possible-to-combine-bounds-of-nested-associated-types", "title": "Is it possible to combine bounds of nested associated types?", "body": "<p>I work with several traits that have associated types:</p>\n\n<pre><code>trait Foo {\n    type FooType;\n}\n\ntrait Bar {\n    type BarType;\n}\n\ntrait Baz {\n    type BazType;\n}\n</code></pre>\n\n<p>I have a function where I need to bound those associated types. I can do it like this (<a href=\"https://play.rust-lang.org/?gist=53f84c9c28ec9f9a2ebac47f5ff13313&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a>):</p>\n\n<pre><code>fn do_the_thing&lt;T&gt;(_: T)\nwhere\n    T: Foo,\n    T::FooType: Bar,\n    &lt;T::FooType as Bar&gt;::BarType: Baz,\n    &lt;&lt;T::FooType as Bar&gt;::BarType as Baz&gt;::BazType: Clone,\n{}\n</code></pre>\n\n<p>This works, but it's very verbose. One problem is that I need to use the <code>&lt;Type as Trait&gt;</code> syntax to disambiguate a few paths, although that shouldn't be necessary. This issue has already been reported <a href=\"https://github.com/rust-lang/rust/issues/38078\" rel=\"nofollow noreferrer\">here</a>.</p>\n\n<p>I wonder if it's possible to shorten the definition of the above function. I thought, maybe it's possible to combine all bounds into one:</p>\n\n<pre><code>fn do_the_thing&lt;T&gt;(_: T)\nwhere\n    T: Foo&lt;FooType: Bar&lt;BarType: Baz&lt;BazType: Clone&gt;&gt;&gt;,\n{}\n</code></pre>\n\n<p>But this results in a syntax error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: expected one of `!`, `(`, `+`, `,`, `::`, `&lt;`, or `&gt;`, found `:`\n  --&gt; src/main.rs:16:19\n   |\n16 |     T: Foo&lt;FooType: Bar&lt;BarType: Baz&lt;BazType: Clone&gt;&gt;&gt;,\n   |                   ^ expected one of 7 possible tokens here\n</code></pre>\n\n<p><strong>Is there a way to compress the bounds somehow?</strong></p>\n"}, {"tags": ["string", "rust"], "answers": [{"tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": true, "score": 6, "last_activity_date": 1528617332, "creation_date": 1528617332, "answer_id": 50781657, "question_id": 50781561, "link": "https://stackoverflow.com/questions/50781561/how-to-find-the-starting-offset-of-a-string-slice-of-another-string/50781657#50781657", "title": "How to find the starting offset of a string slice of another string?", "body": "<p>Rust actually used to have an unstable method for doing exactly this, but <a href=\"https://github.com/rust-lang/rust/commit/b3aa1a6d4ac88f68e036a05fdf19be63b522b65d\" rel=\"noreferrer\">it was removed due to being obsolete</a>, which was a bit odd considering <a href=\"https://doc.rust-lang.org/std/str/pattern/trait.Pattern.html\" rel=\"noreferrer\">the replacement didn't remotely have the same functionality</a>.</p>\n\n<p>That said, the implementation isn't that big, so you can just add the following to your code somewhere:</p>\n\n<pre><code>pub trait SubsliceOffset {\n    /**\n    Returns the byte offset of an inner slice relative to an enclosing outer slice.\n\n    Examples\n\n    ```ignore\n    let string = \"a\\nb\\nc\";\n    let lines: Vec&lt;&amp;str&gt; = string.lines().collect();\n    assert!(string.subslice_offset_stable(lines[0]) == Some(0)); // &amp;\"a\"\n    assert!(string.subslice_offset_stable(lines[1]) == Some(2)); // &amp;\"b\"\n    assert!(string.subslice_offset_stable(lines[2]) == Some(4)); // &amp;\"c\"\n    assert!(string.subslice_offset_stable(\"other!\") == None);\n    ```\n    */\n    fn subslice_offset_stable(&amp;self, inner: &amp;Self) -&gt; Option&lt;usize&gt;;\n}\n\nimpl SubsliceOffset for str {\n    fn subslice_offset_stable(&amp;self, inner: &amp;str) -&gt; Option&lt;usize&gt; {\n        let self_beg = self.as_ptr() as usize;\n        let inner = inner.as_ptr() as usize;\n        if inner &lt; self_beg || inner &gt; self_beg.wrapping_add(self.len()) {\n            None\n        } else {\n            Some(inner.wrapping_sub(self_beg))\n        }\n    }\n}\n</code></pre>\n\n<p>You can remove the <code>_stable</code> suffix if you don't need to support old versions of Rust; it's just there to avoid a name conflict with the now-removed <code>subslice_offset</code> method.</p>\n"}, {"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 8, "last_activity_date": 1528638796, "last_edit_date": 1528638796, "creation_date": 1528617522, "answer_id": 50781685, "question_id": 50781561, "link": "https://stackoverflow.com/questions/50781561/how-to-find-the-starting-offset-of-a-string-slice-of-another-string/50781685#50781685", "title": "How to find the starting offset of a string slice of another string?", "body": "<p>As long as all of your string slices borrow from the same string buffer, you can calculate offsets with simple pointer arithmetic. You need the following methods:</p>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/stable/std/primitive.str.html#method.as_ptr\" rel=\"noreferrer\"><code>str::as_ptr()</code></a>: Returns the pointer to the start of the string slice</li>\n<li>A way to get the difference between two pointers. Right now, the easiest way is to just cast both pointers to <code>usize</code> (which is always a no-op) and then subtract those. On nightly, there is an unstable method <a href=\"https://doc.rust-lang.org/stable/std/primitive.pointer.html#method.offset_to\" rel=\"noreferrer\"><code>offset_from()</code></a> which is slightly nicer. </li>\n</ul>\n\n<p>Here is working code (<a href=\"https://play.rust-lang.org/?gist=4aa7de302fa2d8f8fe80d507677ad586&amp;version=stable&amp;mode=debug\" rel=\"noreferrer\">Playground</a>):</p>\n\n<pre><code>fn get_range(whole_buffer: &amp;str, part: &amp;str) -&gt; (usize, usize) {\n    let start = part.as_ptr() as usize - whole_buffer.as_ptr() as usize;\n    let end = start + part.len();\n    (start, end)\n}\n\nfn main() {\n    let input = \"Everyone \u2665 \u00dcml\u00e4uts!\";\n\n    let part1 = &amp;input[1..7];\n    println!(\"'{}' has offset {:?}\", part1, get_range(input, part1));\n\n    let part2 = &amp;input[7..16];\n    println!(\"'{}' has offset {:?}\", part2, get_range(input, part2));\n}\n</code></pre>\n"}], "owner": {"reputation": 1601, "user_id": 1617063, "user_type": "registered", "accept_rate": 82, "profile_image": "https://i.stack.imgur.com/zaLum.png?s=128&g=1", "display_name": "sayantankhan", "link": "https://stackoverflow.com/users/1617063/sayantankhan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1468, "favorite_count": 0, "closed_date": 1559955361, "accepted_answer_id": 50781657, "answer_count": 2, "score": 7, "last_activity_date": 1528638796, "creation_date": 1528616573, "last_edit_date": 1528638710, "question_id": 50781561, "link": "https://stackoverflow.com/questions/50781561/how-to-find-the-starting-offset-of-a-string-slice-of-another-string", "closed_reason": "Duplicate", "title": "How to find the starting offset of a string slice of another string?", "body": "<p>Given a string and a slice referring to some substring, is it possible to find the starting and ending index of the slice?</p>\n\n<p>I have a <code>ParseString</code> function which takes in a reference to a string, and tries to parse it according to some grammar:</p>\n\n<pre><code>ParseString(inp_string: &amp;str) -&gt; Result&lt;(), &amp;str&gt;\n</code></pre>\n\n<p>If the parsing is fine, the result is just <code>Ok(())</code>, but if there's some error, it usually is in some substring, and the error instance is <code>Err(e)</code>, where <code>e</code> is a slice of that substring. </p>\n\n<p>When given the substring where the error occurs, I want to say something like \"Error from characters x to y\", where x and y are the starting and ending indices of the erroneous substring.</p>\n\n<p>I don't want to encode the position of the errors directly in <code>Err</code>, because I'm nesting these invocations, and the offsets in the nested slice might not correspond to the some slice in the top level string.</p>\n"}, {"tags": ["rust", "traits", "sfinae"], "comments": [{"owner": {"reputation": 99643, "user_id": 445517, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/57e2ba76e6290c4e9e19821a068bc8c1?s=128&d=identicon&r=PG", "display_name": "CodesInChaos", "link": "https://stackoverflow.com/users/445517/codesinchaos"}, "edited": false, "score": 2, "creation_date": 1528583701, "post_id": 50778678, "comment_id": 88565073, "body": "How is <code>T</code> mutually exclusive? <code>?Sync</code> has no effect, it is not a negative trait bound so every <code>T</code> that is valid for your first function is also valid for the second. As the compiler warning tells you &quot;default bound relaxed for a type parameter, but this does nothing because the given bound is not a default. Only <code>?Sized</code> is supported&quot;"}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528594453, "post_id": 50778759, "comment_id": 88566505, "body": "While I agree that this solves OPs <i>problem</i>, it doesn&#39;t answer their <i>question</i>."}, {"owner": {"reputation": 6960, "user_id": 1611307, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/aac7f9a85388beb45df5ee4366240473?s=128&d=identicon&r=PG", "display_name": "ssb", "link": "https://stackoverflow.com/users/1611307/ssb"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528610126, "post_id": 50778759, "comment_id": 88568621, "body": "Like @Shepmaster said... Is there a way to do something similar on the stable compiler (maybe even if it is a lot more verbose)... I am not looking to specialize implementations, rather have separate implementations for types that have mutually exclusive trait bounds."}, {"owner": {"reputation": 99643, "user_id": 445517, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/57e2ba76e6290c4e9e19821a068bc8c1?s=128&d=identicon&r=PG", "display_name": "CodesInChaos", "link": "https://stackoverflow.com/users/445517/codesinchaos"}, "reply_to_user": {"reputation": 6960, "user_id": 1611307, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/aac7f9a85388beb45df5ee4366240473?s=128&d=identicon&r=PG", "display_name": "ssb", "link": "https://stackoverflow.com/users/1611307/ssb"}, "edited": false, "score": 3, "creation_date": 1528628954, "post_id": 50778759, "comment_id": 88572637, "body": "@ssb Mutually exclusive trait bounds don&#39;t exist in Rust."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 99643, "user_id": 445517, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/57e2ba76e6290c4e9e19821a068bc8c1?s=128&d=identicon&r=PG", "display_name": "CodesInChaos", "link": "https://stackoverflow.com/users/445517/codesinchaos"}, "edited": false, "score": 0, "creation_date": 1528657495, "post_id": 50778759, "comment_id": 88580550, "body": "@CodesInChaos What about <code>Sync</code> and <code>!Sync</code> (that was the OP&#39;s intent, if I understand well)"}, {"owner": {"reputation": 99643, "user_id": 445517, "user_type": "registered", "accept_rate": 43, "profile_image": "https://www.gravatar.com/avatar/57e2ba76e6290c4e9e19821a068bc8c1?s=128&d=identicon&r=PG", "display_name": "CodesInChaos", "link": "https://stackoverflow.com/users/445517/codesinchaos"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528660176, "post_id": 50778759, "comment_id": 88581258, "body": "@Boiethios I think <code>!Sync</code> only exists in the context of implementing a trait (to disable a trait implemented by default) and not as a negative trait bound."}], "tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": false, "score": 4, "last_activity_date": 1528580270, "creation_date": 1528580270, "answer_id": 50778759, "question_id": 50778678, "link": "https://stackoverflow.com/questions/50778678/how-does-one-replicate-cs-template-based-sfinae-pattern-in-rust/50778759#50778759", "title": "How does one replicate C++&#39;s template based SFINAE pattern in Rust?", "body": "<p>What you want is specialization:</p>\n\n<pre><code>#![feature(specialization)]\n\ntrait Runnable {\n    fn run(&amp;self);\n}\n\nstruct Foo&lt;T&gt; {\n    _t: T,\n}\n\nimpl&lt;T&gt; Runnable for Foo&lt;T&gt;\nwhere\n    T: Send + Sync,\n{\n    fn run(&amp;self) {}\n}\n\nimpl&lt;T&gt; Runnable for Foo&lt;T&gt;\nwhere\n    T: Send,\n{\n    default fn run(&amp;self) {}\n//  ^^^^^^^ this is the magic you need\n}\n\nfn main() {}\n</code></pre>\n\n<p>However, as of Rust 1.26.2, specialization is not stable and requires a nightly compiler.</p>\n"}], "owner": {"reputation": 6960, "user_id": 1611307, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/aac7f9a85388beb45df5ee4366240473?s=128&d=identicon&r=PG", "display_name": "ssb", "link": "https://stackoverflow.com/users/1611307/ssb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 473, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1528594396, "creation_date": 1528579439, "last_edit_date": 1528594396, "question_id": 50778678, "link": "https://stackoverflow.com/questions/50778678/how-does-one-replicate-cs-template-based-sfinae-pattern-in-rust", "title": "How does one replicate C++&#39;s template based SFINAE pattern in Rust?", "body": "<p>I have the following:</p>\n\n<pre><code>trait Runnable {\n    fn run(&amp;self);\n}\n\nstruct Foo&lt;T&gt; {\n    // Something\n}\n\nimpl&lt;T&gt; Runnable for Foo&lt;T&gt;\nwhere\n    T: Send + Sync,\n{\n    fn run(&amp;self) {}\n}\n\nimpl&lt;T&gt; Runnable for Foo&lt;T&gt;\nwhere\n    T: Send + ?Sync,\n{\n    fn run(&amp;self) {}\n}\n</code></pre>\n\n<p>The compiler complains about a duplicate <code>impl</code> even though the <code>T</code> is mutually exclusive in both cases:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0119]: conflicting implementations of trait `Runnable` for type `Foo&lt;_&gt;`:\n  --&gt; src/main.rs:16:1\n   |\n9  | / impl&lt;T&gt; Runnable for Foo&lt;T&gt;\n10 | | where\n11 | |     T: Send + Sync,\n12 | | {\n13 | |     fn run(&amp;self) {}\n14 | | }\n   | |_- first implementation here\n15 | \n16 | / impl&lt;T&gt; Runnable for Foo&lt;T&gt;\n17 | | where\n18 | |     T: Send + ?Sync,\n19 | | {\n20 | |     fn run(&amp;self) {}\n21 | | }\n   | |_^ conflicting implementation for `Foo&lt;_&gt;`\n</code></pre>\n"}, {"tags": ["syntax", "rust", "traits", "associated-types"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528560361, "post_id": 50776093, "comment_id": 88559170, "body": "<code>trait Behaviour where Self: FromStr,</code> -&gt; <code>trait Behaviour: FromStr</code>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528560823, "post_id": 50776093, "comment_id": 88559285, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/50090578/155423\">How to write a bound for a reference to an associated type on the trait itself?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/50776093/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 2434, "user_id": 4591251, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/22ad6242d3ca1d772c46a5d00389d925?s=128&d=identicon&r=PG", "display_name": "Ross MacArthur", "link": "https://stackoverflow.com/users/4591251/ross-macarthur"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528561611, "post_id": 50776093, "comment_id": 88559524, "body": "The above edits still don&#39;t seem to work. Is this possible?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528561697, "post_id": 50776093, "comment_id": 88559560, "body": "I edited the answer to be more clear. That syntax is correct (although verbose: <code>Self::Err: Debug</code> is sufficient) but support for it is not implemented."}, {"owner": {"reputation": 2434, "user_id": 4591251, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/22ad6242d3ca1d772c46a5d00389d925?s=128&d=identicon&r=PG", "display_name": "Ross MacArthur", "link": "https://stackoverflow.com/users/4591251/ross-macarthur"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528561793, "post_id": 50776093, "comment_id": 88559589, "body": "Thats disappointing, okay."}], "owner": {"reputation": 2434, "user_id": 4591251, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/22ad6242d3ca1d772c46a5d00389d925?s=128&d=identicon&r=PG", "display_name": "Ross MacArthur", "link": "https://stackoverflow.com/users/4591251/ross-macarthur"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 36, "favorite_count": 0, "closed_date": 1528564211, "answer_count": 0, "score": 1, "last_activity_date": 1528561588, "creation_date": 1528560139, "last_edit_date": 1528561588, "question_id": 50776093, "link": "https://stackoverflow.com/questions/50776093/how-do-i-constrain-associated-types-on-a-non-owned-trait", "closed_reason": "Duplicate", "title": "How do I constrain associated types on a non-owned trait?", "body": "<p><a href=\"https://play.rust-lang.org/?gist=585ba50191529ef423b5310ac16bc214&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Here is a link to this example in Rust playground</a></p>\n\n<p>I am creating two traits. The one trait uses the other as an associated type. The associated trait extends <code>FromStr</code>:</p>\n\n<pre><code>trait Behaviour where Self: FromStr {}\ntrait AnotherBehaviour {\n    type Assoc: Behaviour;\n}\n</code></pre>\n\n<p>I can implement these traits for <code>Derp</code> and <code>AnotherDerp</code> respectively, remembering to implement <code>FromStr</code> for <code>Derp</code>:</p>\n\n<pre><code>struct Error {}\nstruct Derp {}\nstruct AnotherDerp {}\n\nimpl Behaviour for Derp {}\nimpl FromStr for Derp {\n    type Err = Error;\n    fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n        match s { \"derp\" =&gt; Ok(Derp{}), _ =&gt; Err(Error {}) }\n    }\n}\n\nimpl AnotherBehaviour for AnotherDerp {\n    type Assoc = Derp;\n}\n</code></pre>\n\n<p>Now I want to create a generic function that uses the encapsulating trait.</p>\n\n<pre><code>fn run&lt;T: AnotherBehaviour&gt;() {\n    let derp = T::Assoc::from_str(\"derp\").expect(\"expected derp\");\n}\n\nfn main() {\n    run::&lt;AnotherDerp&gt;();\n}\n</code></pre>\n\n<p>I get the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>note: the method `expect` exists but the following trait bounds were not satisfied:\n       `&lt;&lt;T as AnotherBehaviour&gt;::Assoc as std::str::FromStr&gt;::Err : std::fmt::Debug`\n</code></pre>\n\n<p>I implement <code>Debug</code> for my <code>Error</code> type:</p>\n\n<pre><code>#[derive(Debug)]\nstruct Error {}\n</code></pre>\n\n<p>But this won't work because I actually need to constrain the trait.</p>\n\n<p>I know that I can constrain the generic function with </p>\n\n<pre><code>where\n    &lt;T::Assoc as FromStr&gt;::Err: Debug,\n</code></pre>\n\n<p>but how can I constrain the <code>Behaviour</code> or <code>AnotherBehaviour</code> trait to require <code>FromStr::Err</code> to implement <code>Debug</code>? I can't figure out the syntax.</p>\n\n<p>I have tried </p>\n\n<pre><code>trait Behaviour: FromStr\nwhere\n     &lt;Self as FromStr&gt;::Err: Debug\n</code></pre>\n\n<p>and </p>\n\n<pre><code>trait Behaviour: FromStr\nwhere\n    Self::Err: Debug\n</code></pre>\n"}, {"tags": ["rust", "ownership"], "answers": [{"comments": [{"owner": {"reputation": 1132, "user_id": 2076220, "user_type": "registered", "accept_rate": 21, "profile_image": "https://i.stack.imgur.com/8xgdw.jpg?s=128&g=1", "display_name": "Robert Simmons Jr.", "link": "https://stackoverflow.com/users/2076220/robert-simmons-jr"}, "edited": false, "score": 0, "creation_date": 1528559006, "post_id": 50775818, "comment_id": 88558804, "body": "Excellent, thanks. I will get these ownership rules down eventually. :)"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 1132, "user_id": 2076220, "user_type": "registered", "accept_rate": 21, "profile_image": "https://i.stack.imgur.com/8xgdw.jpg?s=128&g=1", "display_name": "Robert Simmons Jr.", "link": "https://stackoverflow.com/users/2076220/robert-simmons-jr"}, "edited": false, "score": 0, "creation_date": 1542566652, "post_id": 50775818, "comment_id": 93605123, "body": "@RobertSimmonsJr. please be sure to let me know how I can improve the answer."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1528558975, "last_edit_date": 1528558975, "creation_date": 1528558109, "answer_id": 50775818, "question_id": 50775770, "link": "https://stackoverflow.com/questions/50775770/how-do-i-conditionally-choose-between-two-fields-of-a-struct-and-then-update-the/50775818#50775818", "title": "How do I conditionally choose between two fields of a struct and then update the chosen one?", "body": "<p>Take <a href=\"https://doc.rust-lang.org/book/second-edition/ch04-02-references-and-borrowing.html#mutable-references\" rel=\"nofollow noreferrer\">a mutable reference</a> to the field:</p>\n\n<pre><code>let mut s = if i % 2 == 0 { &amp;mut even } else { &amp;mut odd };\n</code></pre>\n"}], "owner": {"reputation": 1132, "user_id": 2076220, "user_type": "registered", "accept_rate": 21, "profile_image": "https://i.stack.imgur.com/8xgdw.jpg?s=128&g=1", "display_name": "Robert Simmons Jr.", "link": "https://stackoverflow.com/users/2076220/robert-simmons-jr"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 108, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1528558975, "creation_date": 1528557690, "last_edit_date": 1528557969, "question_id": 50775770, "link": "https://stackoverflow.com/questions/50775770/how-do-i-conditionally-choose-between-two-fields-of-a-struct-and-then-update-the", "title": "How do I conditionally choose between two fields of a struct and then update the chosen one?", "body": "<p>I have two structs of the same type inside a larger struct. I will select one of the structs and perform updates using the same code. </p>\n\n<p>A simplified version:</p>\n\n<pre><code>#[derive(Debug)]\nstruct Counts {\n    value: u16,\n    count: u8,\n}\n\n#[derive(Debug)]\nstruct Partitioned {\n    even: Counts,\n    odd: Counts,\n}\n\nfn sort() -&gt; Partitioned {\n    let mut even = Counts { value: 2, count: 0 };\n\n    let mut odd = Counts { value: 3, count: 0 };\n\n    for i in 1..30 {\n        let mut s = if i % 2 == 0 { even } else { odd };\n        s.count = s.count + 1;\n        // ... a lot of other code\n    }\n\n    Partitioned { even, odd }\n}\n\nfn main() {\n    println!(\"{:?}\", sort());\n}\n</code></pre>\n\n<p>This does not compile with complaints about ownership:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0382]: use of moved value: `even`\n  --&gt; src/main.rs:19:37\n   |\n19 |         let mut s = if i % 2 == 0 { even } else { odd };\n   |                                     ^^^^ value moved here in previous iteration of loop\n   |\n   = note: move occurs because `even` has type `Counts`, which does not implement the `Copy` trait\n\nerror[E0382]: use of moved value: `odd`\n  --&gt; src/main.rs:19:51\n   |\n19 |         let mut s = if i % 2 == 0 { even } else { odd };\n   |                                                   ^^^ value moved here in previous iteration of loop\n   |\n   = note: move occurs because `odd` has type `Counts`, which does not implement the `Copy` trait\n\nerror[E0382]: use of moved value: `even`\n  --&gt; src/main.rs:24:19\n   |\n19 |         let mut s = if i % 2 == 0 { even } else { odd };\n   |                                     ---- value moved here\n...\n24 |     Partitioned { even, odd }\n   |                   ^^^^ value used here after move\n   |\n   = note: move occurs because `even` has type `Counts`, which does not implement the `Copy` trait\n\nerror[E0382]: use of moved value: `odd`\n  --&gt; src/main.rs:24:25\n   |\n19 |         let mut s = if i % 2 == 0 { even } else { odd };\n   |                                                   --- value moved here\n...\n24 |     Partitioned { even, odd }\n   |                         ^^^ value used here after move\n   |\n   = note: move occurs because `odd` has type `Counts`, which does not implement the `Copy` trait\n</code></pre>\n\n<p>What is going on here? How can I implement it without copying all the update code to both blocks of the <code>if</code>?</p>\n"}, {"tags": ["enums", "rust", "pattern-matching"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528553629, "post_id": 50775023, "comment_id": 88557206, "body": "<a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec) or Box (&amp;Box) as a function argument?</a>."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 29, "last_activity_date": 1583953936, "last_edit_date": 1583953936, "creation_date": 1528553774, "answer_id": 50775181, "question_id": 50775023, "link": "https://stackoverflow.com/questions/50775023/why-do-i-get-an-error-when-pattern-matching-a-struct-like-enum-variant-with-fiel/50775181#50775181", "title": "Why do I get an error when pattern matching a struct-like enum variant with fields?", "body": "<p>Enum variants have three possible syntaxes:</p>\n\n<ul>\n<li><p>unit</p>\n\n<pre><code>enum A { One }\n</code></pre></li>\n<li><p>tuple</p>\n\n<pre><code>enum B { Two(u8, bool) }\n</code></pre></li>\n<li><p>struct</p>\n\n<pre><code>enum C { Three { a: f64, b: String } }\n</code></pre></li>\n</ul>\n\n<p>You have to use the same syntax when pattern matching as the syntax the variant was defined as:</p>\n\n<ul>\n<li><p>unit</p>\n\n<pre><code>match something {\n    A::One =&gt; { /* Do something */ }\n}\n</code></pre></li>\n<li><p>tuple</p>\n\n<pre><code>match something {\n    B::Two(x, y) =&gt; { /* Do something */ }\n}\n</code></pre></li>\n<li><p>struct</p>\n\n<pre><code>match something {\n    C::Three { a: another_name, b } =&gt; { /* Do something */ }\n}\n</code></pre></li>\n</ul>\n\n<p>Beyond that, you can use various patterns that allow ignoring a value, such as <code>_</code> or <code>..</code>. In this case, you need curly braces and the <code>..</code> catch-all:</p>\n\n<pre><code>OperationMode::CBC { .. } =&gt; { /* Do something */ }\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/book/ch18-03-pattern-syntax.html#ignoring-values-in-a-pattern\" rel=\"noreferrer\">Ignoring Values in a Pattern in <em>The Rust Programming Language</em></a></li>\n<li><a href=\"https://doc.rust-lang.org/book/appendix-02-operators.html\" rel=\"noreferrer\">Appendix B: Operators and Symbols in <em>The Rust Programming Language</em></a></li>\n<li><a href=\"https://stackoverflow.com/questions/41390457/how-to-match-struct-fields-in-rust\">How to match struct fields in Rust?</a></li>\n</ul>\n"}], "owner": {"reputation": 135, "user_id": 9119674, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/3TAr9.jpg?s=128&g=1", "display_name": "Antoxyde", "link": "https://stackoverflow.com/users/9119674/antoxyde"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 5775, "favorite_count": 2, "accepted_answer_id": 50775181, "answer_count": 1, "score": 11, "last_activity_date": 1583953936, "creation_date": 1528552571, "last_edit_date": 1528553430, "question_id": 50775023, "link": "https://stackoverflow.com/questions/50775023/why-do-i-get-an-error-when-pattern-matching-a-struct-like-enum-variant-with-fiel", "title": "Why do I get an error when pattern matching a struct-like enum variant with fields?", "body": "<p>I can't get rid of an error on this code:</p>\n\n<pre><code>#[derive(PartialEq, Copy, Clone)]\npub enum OperationMode {\n    ECB,\n    CBC { iv: [u8; 16] },\n}\n\npub struct AES {\n    key: Vec&lt;u8&gt;,\n    nr: u8,\n    mode: OperationMode,\n}\n\nimpl AES {\n    pub fn decrypt(&amp;mut self, input: &amp;Vec&lt;u8&gt;) {\n        match self.mode {\n            OperationMode::ECB =&gt; {},\n            OperationMode::CBC(_) =&gt; {},\n        };\n    }\n}\n</code></pre>\n\n<p>The pattern matching at the end of the <code>decrypt</code> function gives an error: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0532]: expected tuple struct/variant, found struct variant `OperationMode::CBC`\n  --&gt; src/main.rs:17:13\n   |\n17 |             OperationMode::CBC(_) =&gt; {},\n   |             ^^^^^^^^^^^^^^^^^^ did you mean `OperationMode::CBC { /* fields */ }`?\n</code></pre>\n\n<p>It tells me to look at the output of <code>rustc --explain E0532</code> for help, which I did.</p>\n\n<p>They show this example of wrong code:</p>\n\n<blockquote>\n<pre><code>enum State {\n    Succeeded,\n    Failed(String),\n}\n\nfn print_on_failure(state: &amp;State) {\n    match *state {\n        // error: expected unit struct/variant or constant, found tuple\n        //        variant `State::Failed`\n        State::Failed =&gt; println!(\"Failed\"),\n        _ =&gt; ()\n    }\n}\n</code></pre>\n</blockquote>\n\n<p>In this example, the error occurs because <code>State::Failed</code> has a field which isn't matched. It should be <code>State::Failed(ref msg)</code>.</p>\n\n<p>In my case I'm matching the field of my enum because I'm doing  <code>OperationMode::CBC(_)</code>. Why does the error happen?</p>\n"}, {"tags": ["generics", "rust"], "answers": [{"comments": [{"owner": {"reputation": 25, "user_id": 9917656, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/88922354422bed119aefef4558cce7ab?s=128&d=identicon&r=PG&f=1", "display_name": "recsubbu", "link": "https://stackoverflow.com/users/9917656/recsubbu"}, "edited": false, "score": 0, "creation_date": 1528551336, "post_id": 50773837, "comment_id": 88556558, "body": "Liked your native version better, Peter.  Thanks much."}, {"owner": {"reputation": 25, "user_id": 9917656, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/88922354422bed119aefef4558cce7ab?s=128&d=identicon&r=PG&f=1", "display_name": "recsubbu", "link": "https://stackoverflow.com/users/9917656/recsubbu"}, "edited": false, "score": 0, "creation_date": 1528716548, "post_id": 50773837, "comment_id": 88599218, "body": "Got that, Peter.  Liked the native version because it seems to have an edge when it comes to modulo by a larger number instead of 2.  First version means <code>one + one + ... + one</code> n times."}, {"owner": {"reputation": 1470, "user_id": 2075745, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/6f9a084d236381e1882c4e28edb5151f?s=128&d=identicon&r=PG", "display_name": "user25064", "link": "https://stackoverflow.com/users/2075745/user25064"}, "reply_to_user": {"reputation": 25, "user_id": 9917656, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/88922354422bed119aefef4558cce7ab?s=128&d=identicon&r=PG&f=1", "display_name": "recsubbu", "link": "https://stackoverflow.com/users/9917656/recsubbu"}, "edited": false, "score": 0, "creation_date": 1528718703, "post_id": 50773837, "comment_id": 88600494, "body": "@recsubbu The <code>num</code> crate has the trait <a href=\"https://rust-num.github.io/num/num/trait.FromPrimitive.html\" rel=\"nofollow noreferrer\"><code>FromPrimitive</code></a> that you may find interesting"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 3, "last_activity_date": 1528631014, "last_edit_date": 1528631014, "creation_date": 1528543999, "answer_id": 50773837, "question_id": 50773343, "link": "https://stackoverflow.com/questions/50773343/rust-generics-on-arithmetic-operation/50773837#50773837", "title": "Rust generics on arithmetic operation", "body": "<p>You are making a lot more assumptions about your <code>T</code> than you are expressing in the types. You have correctly constrained <code>T</code> to <code>Rem</code> and <code>PartialEq</code>, so you can use the <code>%</code> and <code>==</code> operators, but you are also assuming that there are special values <code>0</code> and <code>2</code> which are of that type.</p>\n\n<p>There is no trait for the existence of <code>2</code>, but you can use the <code>num-traits</code> crate to find a trait for types that have a <code>0</code> and a <code>1</code>. Assuming that the generic type also has addition, you can ensure that it has <code>2</code> as well by adding <code>one</code> to itself.</p>\n\n<pre><code>extern crate num_traits;\n\nuse num_traits::{Zero, One};\nuse std::ops::{Rem, Add};\n\nfn main() {\n    let x: u16 = 31;\n    let y: u32 = 40;\n\n    println!(\"x = {}, y = {}\", is_even(x), is_even(y));\n}\n\nfn is_even&lt;T&gt; (n: T) -&gt; bool \nwhere\n    T: Rem&lt;Output = T&gt; + PartialEq + One + Zero + Add + Copy\n{\n    let one: T = One::one();\n    n % (one + one) == Zero::zero()\n}\n</code></pre>\n\n<p>Note, I also made <code>T: Copy</code> so that it didn't require references in the addition expression. This is a reasonable assumption for most numeric types.</p>\n\n<hr>\n\n<p>Without using a third party crate, you can also use the values of <code>0</code> and <code>2</code> from another type, for example <code>u8</code>, and just ensure that your generic type can be converted to from that.</p>\n\n<pre><code>fn is_even&lt;T&gt; (n: T) -&gt; bool \nwhere\n    T: Rem&lt;Output = T&gt; + PartialEq + From&lt;u8&gt;\n{\n    let two: T = 2u8.into();\n    let zero: T = 0u8.into();\n    n % two == zero\n}\n</code></pre>\n\n<p>I like this version less because the constraint <code>T: From&lt;u8&gt;</code> doesn't really communicate anything useful about what the function is doing. It ties the type to an esoteric implementation detail, while the first version's constraints precisely describe the arithmetic operations that need to be supported.</p>\n"}], "owner": {"reputation": 25, "user_id": 9917656, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/88922354422bed119aefef4558cce7ab?s=128&d=identicon&r=PG&f=1", "display_name": "recsubbu", "link": "https://stackoverflow.com/users/9917656/recsubbu"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 610, "favorite_count": 0, "closed_date": 1528549003, "accepted_answer_id": 50773837, "answer_count": 1, "score": 2, "last_activity_date": 1528631014, "creation_date": 1528540530, "last_edit_date": 1528549093, "question_id": 50773343, "link": "https://stackoverflow.com/questions/50773343/rust-generics-on-arithmetic-operation", "closed_reason": "Duplicate", "title": "Rust generics on arithmetic operation", "body": "<p>I wrote a generic function to check if a given number is even or not:</p>\n\n<pre><code>use std::ops::Rem;\n\nfn main() {\n    let x: u16 = 31;\n    let y: u32 = 40;\n\n    println!(\"x = {}, y = {}\", is_even(x), is_even(y));\n}\n\nfn is_even&lt;T: Rem&lt;Output = T&gt; + PartialEq&gt;(n: T) -&gt; bool {\n    n % 2 == 0\n}\n</code></pre>\n\n<p>It produces the compiler error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:11:9\n   |\n11 |     n % 2 == 0\n   |         ^ expected type parameter, found integral variable\n   |\n   = note: expected type `T`\n              found type `{integer}`\n\nerror[E0308]: mismatched types\n  --&gt; src/main.rs:11:14\n   |\n11 |     n % 2 == 0\n   |              ^ expected type parameter, found integral variable\n   |\n   = note: expected type `T`\n              found type `{integer}`\n</code></pre>\n\n<p>Since this is an error on using <code>T</code> with concrete <code>i32</code> values (2 and 0), I wrote another version of <code>is_even</code> like this:</p>\n\n<pre><code>fn is_even&lt;T: Rem&lt;Output = T&gt; + PartialEq&gt; (n: T, with: T, output: T) -&gt; bool {\n    n % with == output\n}\n</code></pre>\n\n<p>This produces the desired output, but using <code>is_even</code> is convoluted now: <code>is_even(x, 2, 0)</code>.  How to make my original version of <code>is_even</code> work?</p>\n\n<p>I do recognise that the modulo operator is generic enough and works with <code>u16</code> and <code>u32</code> values directly; a function like <code>is_even</code> is not needed - but I wrote it to understand how generics work.</p>\n"}, {"tags": ["iterator", "rust"], "answers": [{"comments": [{"owner": {"reputation": 6621, "user_id": 153092, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/be31b482820bad8292f967e3b9d67352?s=128&d=identicon&r=PG", "display_name": "Athiwat Chunlakhan", "link": "https://stackoverflow.com/users/153092/athiwat-chunlakhan"}, "edited": false, "score": 0, "creation_date": 1528534243, "post_id": 50772500, "comment_id": 88552414, "body": "Sorry if I wasn&#39;t clear. As for your example. The <code>metadata</code> is now missing, what I want is the whole <code>Book</code>. (I kept using <code>None</code> for <code>Err</code>, my mistake I will fix it)"}, {"owner": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "reply_to_user": {"reputation": 6621, "user_id": 153092, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/be31b482820bad8292f967e3b9d67352?s=128&d=identicon&r=PG", "display_name": "Athiwat Chunlakhan", "link": "https://stackoverflow.com/users/153092/athiwat-chunlakhan"}, "edited": false, "score": 0, "creation_date": 1528534857, "post_id": 50772500, "comment_id": 88552585, "body": "Ah I see what you mean. In that case you can&#39;t unwrap the <code>data</code> field in-place since the <code>data</code> field is specifically a <code>Result</code>. One thing you can do is unwrap it and store a copy or reference alongside <code>Book</code> in some wrapper type that would contain both values, such as a tuple. I&#39;ll write an example. Honestly, I get where you&#39;re coming from, but at that point it would be more work and more complexity than it&#39;s worth compared to just keeping the unwrap."}, {"owner": {"reputation": 6621, "user_id": 153092, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/be31b482820bad8292f967e3b9d67352?s=128&d=identicon&r=PG", "display_name": "Athiwat Chunlakhan", "link": "https://stackoverflow.com/users/153092/athiwat-chunlakhan"}, "edited": false, "score": 0, "creation_date": 1528534992, "post_id": 50772500, "comment_id": 88552613, "body": "I had an example with <code>fold</code> working, where I just accumulate it as a tuple and discard the one where the <code>Result</code> is <code>Err</code>, but like you said it gets very long and compare to just <code>unwrap</code>."}, {"owner": {"reputation": 6621, "user_id": 153092, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/be31b482820bad8292f967e3b9d67352?s=128&d=identicon&r=PG", "display_name": "Athiwat Chunlakhan", "link": "https://stackoverflow.com/users/153092/athiwat-chunlakhan"}, "edited": false, "score": 0, "creation_date": 1528536085, "post_id": 50772500, "comment_id": 88552843, "body": "Just in case anyone need to turn it back to just a Book. <a href=\"https://play.rust-lang.org/?gist=60ff77b80e9bc519c7856aaf71b5acad&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a>"}], "tags": [], "owner": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "is_accepted": true, "score": 2, "last_activity_date": 1528535019, "last_edit_date": 1528535019, "creation_date": 1528534112, "answer_id": 50772500, "question_id": 50772412, "link": "https://stackoverflow.com/questions/50772412/is-there-a-way-to-remove-unwrapping-of-items-in-an-iterator-chain-that-filters-a/50772500#50772500", "title": "Is there a way to remove unwrapping of items in an iterator chain that filters and partitions based on a Result?", "body": "<p>I'm not sure exactly what you mean, but it seems like you want to use <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.filter_map\" rel=\"nofollow noreferrer\"><code>Iterator::filter_map()</code></a>. It lets you filter for values that are <code>Some(T)</code>, which then get passed on as unwrapped <code>T</code>s.</p>\n\n<p>So what you can do is convert your <code>Result</code>s to <code>Option</code>s with <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.ok\" rel=\"nofollow noreferrer\"><code>Result::ok()</code></a>, so a <code>Result::Ok(T)</code> will become <code>Some(T)</code> which means it passes the filter as <code>T</code>.</p>\n\n<pre><code>fn main() {\n    let books = vec![\n        Book {\n            data: Ok(\"type1\".to_owned()),\n            metadata: \"meta1\".to_owned(),\n        },\n        Book {\n            data: Err(\"-\".to_owned()),\n            metadata: \"meta2\".to_owned(),\n        },\n        Book {\n            data: Ok(\"type2\".to_owned()),\n            metadata: \"meta2\".to_owned(),\n        },\n    ];\n\n    // metadata without data being error\n    let (book_type_1, book_type_2): (Vec&lt;_&gt;, Vec&lt;_&gt;) = books\n        .iter()\n        .filter_map(|f| {\n            match &amp;f.data {\n                Ok(data) =&gt; Some((f, data)),\n                Err(_) =&gt; None,\n            }\n        })\n        .partition(|(book, data)| *data == \"type1\");\n\n    println!(\"Books {:?}\", books);\n    println!(\"Type 1 {:?}\", book_type_1);\n    println!(\"Type 2 {:?}\", book_type_2);\n}\n\n#[derive(Debug)]\nstruct Book {\n    data: Result&lt;String, String&gt;,\n    metadata: String,\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=26274a259559224b60747a1675491f56&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>I removed the unnecessary reference to the returned partitioned tuple.</p>\n\n<p>Also note that <code>None</code> pertains to <code>Option&lt;T&gt;</code>, but you're using <code>Result&lt;T, E&gt;</code>. I think you knew that but just making sure.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1528551660, "last_edit_date": 1528551660, "creation_date": 1528551316, "answer_id": 50774843, "question_id": 50772412, "link": "https://stackoverflow.com/questions/50772412/is-there-a-way-to-remove-unwrapping-of-items-in-an-iterator-chain-that-filters-a/50774843#50774843", "title": "Is there a way to remove unwrapping of items in an iterator chain that filters and partitions based on a Result?", "body": "<p>I would use <code>flat_map</code> as described <a href=\"https://stackoverflow.com/a/50772500/155423\">in the other answer</a>, but I'd leave the yielded values as a <code>Result</code>. <code>Result</code> <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#impl-IntoIterator\" rel=\"nofollow noreferrer\">implements <code>IntoIterator</code></a>, so you can use it directly in <code>flat_map</code>.</p>\n\n<p>I'd also use <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.as_ref\" rel=\"nofollow noreferrer\"><code>Result::as_ref</code></a> instead of writing out the match explicitly.</p>\n\n<p>I'd then use <a href=\"https://docs.rs/itertools/0.7.8/itertools/trait.Itertools.html#method.partition_map\" rel=\"nofollow noreferrer\"><code>Itertools::partition_map</code></a> to simultaneously select between the types and remove the extra property:</p>\n\n<pre><code>extern crate itertools;\nuse itertools::{Either, Itertools};\n\n// ...\n\nlet (book_type_1, book_type_2): (Vec&lt;_&gt;, Vec&lt;_&gt;) = books\n    .iter()\n    .flat_map(|b| b.data.as_ref().map(|data| (b, data)))\n    .partition_map(|(b, data)| {\n        if data == \"type1\" {\n            Either::Left(b)\n        } else {\n            Either::Right(b)\n        }\n    });\n</code></pre>\n\n<p>Note:</p>\n\n<ul>\n<li>There's no reason to take a reference to the result tuple.</li>\n<li>This only works because you are iterating on references to books. </li>\n</ul>\n\n<p>If you needed to operate on the owned <code>Book</code>s, I'd move the comparison into the <code>flat_map</code> call and pass it along:</p>\n\n<pre><code>let (book_type_1, book_type_2): (Vec&lt;_&gt;, Vec&lt;_&gt;) = books\n    .into_iter()\n    .flat_map(|book| {\n        book.data\n            .as_ref()\n            .ok()\n            .map(|data| data == \"type1\")\n            .map(|is_type1| (is_type1, book))\n    })\n    .partition_map(|(is_type1, book)| {\n        if is_type1 {\n            Either::Left(book)\n        } else {\n            Either::Right(book)\n        }\n    });\n</code></pre>\n\n<p>There's also the pragmatic solution of sorting all errors into the same bin as one of the types. Since you know that there <em>won't</em> be any errors, this has no effect:</p>\n\n<pre><code>let (book_type_1, book_type_2): (Vec&lt;_&gt;, Vec&lt;_&gt;) = books\n    .iter()\n    .filter(|f| f.data.is_ok())\n    .partition(|p| p.data.as_ref().ok().map_or(false, |d| d == \"type1\"));\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/36368843/155423\">What&#39;s the most idiomatic way of working with an Iterator of Results?</a></li>\n</ul>\n"}], "owner": {"reputation": 6621, "user_id": 153092, "user_type": "registered", "accept_rate": 98, "profile_image": "https://www.gravatar.com/avatar/be31b482820bad8292f967e3b9d67352?s=128&d=identicon&r=PG", "display_name": "Athiwat Chunlakhan", "link": "https://stackoverflow.com/users/153092/athiwat-chunlakhan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 398, "favorite_count": 0, "accepted_answer_id": 50772500, "answer_count": 2, "score": 2, "last_activity_date": 1528551660, "creation_date": 1528533411, "last_edit_date": 1528551441, "question_id": 50772412, "link": "https://stackoverflow.com/questions/50772412/is-there-a-way-to-remove-unwrapping-of-items-in-an-iterator-chain-that-filters-a", "title": "Is there a way to remove unwrapping of items in an iterator chain that filters and partitions based on a Result?", "body": "<p>I created this example code:</p>\n\n<pre><code>fn main() {\n    let books = vec![\n        Book {\n            data: Ok(\"type1\".to_owned()),\n            metadata: \"meta1\".to_owned(),\n        },\n        Book {\n            data: Err(\"-\".to_owned()),\n            metadata: \"meta2\".to_owned(),\n        },\n        Book {\n            data: Ok(\"type2\".to_owned()),\n            metadata: \"meta2\".to_owned(),\n        },\n    ];\n\n    // metadata without data being error\n    let (book_type_1, book_type_2): &amp;(Vec&lt;_&gt;, Vec&lt;_&gt;) = &amp;books\n        .iter()\n        .filter(|f| f.data.is_ok())\n        .partition(|p| p.data.as_ref().unwrap() == \"type1\");\n\n    println!(\"Books {:?}\", books);\n    println!(\"Type 1 {:?}\", book_type_1); // Should be the original Vec&lt;Book&gt; with Type 1 filtered.\n    println!(\"Type 2 {:?}\", book_type_2); // Should be the original Vec&lt;Book&gt; with Type 2 filtered.\n}\n\n#[derive(Debug)]\nstruct Book {\n    data: Result&lt;String, String&gt;,\n    metadata: String,\n}\n</code></pre>\n\n<p>On the <code>let (book_type_1, book_type_2)</code> expression, I need to use <code>Book::data</code> twice, but I already filtered it so I know it can't be <code>Err</code>. Is there a way to restructure to remove the use of <code>unwrap</code> here?</p>\n"}, {"tags": ["types", "rust", "closures", "generator"], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528554733, "post_id": 50772781, "comment_id": 88557542, "body": "<i>apparently <code>Box&lt;Generator&lt;...&gt;&gt;</code> also satisfies the constraint <code>G: Generator&lt;...&gt;</code></i> \u2014 <a href=\"https://doc.rust-lang.org/std/ops/trait.Generator.html#implementors\" rel=\"nofollow noreferrer\">yes, as do references to generators</a>, just the same as iterators."}], "tags": [], "owner": {"reputation": 15065, "user_id": 723090, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/ML1tj.png?s=128&g=1", "display_name": "Mark", "link": "https://stackoverflow.com/users/723090/mark"}, "is_accepted": false, "score": 1, "last_activity_date": 1528554624, "last_edit_date": 1528554624, "creation_date": 1528536360, "answer_id": 50772781, "question_id": 50767947, "link": "https://stackoverflow.com/questions/50767947/how-can-i-store-a-generator-in-a-struct/50772781#50772781", "title": "How can I store a generator in a struct?", "body": "<p>I think I found an answer, but if someone has a better one, feel free to post. I'm obviously not super knowledgeable about this yet or I wouldn't have asked.</p>\n\n<p>For completeness: the generic <code>G</code> is needed because generators are like closures, and every closure has a different type (not just every declaration - every instantiation as well) because it captures a different environment.</p>\n\n<p>As <a href=\"https://stackoverflow.com/q/32551177/155423\">&quot;Expected type parameter&quot; error in the constructor of a generic struct</a> pointed out, the first problem was the generic type after <code>impl</code>. That meant that the implementation was for an externally chosen <code>T</code>, but the <code>Self</code> returned instead had a specific value for the type parameter, namely the one of the generator.</p>\n\n<p>As for how to replace it, </p>\n\n<ul>\n<li><p><code>impl Container&lt;G&gt; where G: Generator&lt;Yield = i32, Return = ()&gt;</code></p>\n\n<p>This does not work because although <code>G</code> is bounded (pretty strictly), there is still no one responsible for choosing the specific <code>G</code>.</p></li>\n<li><p><code>impl Container&lt;_&gt;</code></p>\n\n<p>This does not work because type inference does not work for struct implementations. Which probably makes sense - it wouldn't really be logical for anything but 'constructors'.</p></li>\n<li><p><code>impl Container&lt;Generator&lt;Yield = i32, Return = ()&gt;&gt;</code></p>\n\n<p>This does not work because <code>Generator</code> is a trait and trait objects are not sized (whereas this type parameter should be sized).</p></li>\n</ul>\n\n<p>The sizedness thing can be resolved. It took a bit of trying and I'm not sure it's perfect, but adding a <code>Box</code> <em>at the implementation</em> fixed it. Note that the <code>Box</code> is not part of <code>Container</code>; apparently <code>Box&lt;Generator&lt;...&gt;&gt;</code> also satisfies the constraint <code>G: Generator&lt;...&gt;</code>?</p>\n\n<p>I <em>think</em> it also greatly reduces the odds of the generator being moved, which I <em>think</em> should not happen:</p>\n\n<blockquote>\n  <p>The function <code>resume</code> is unsafe because it can be used on an immovable generator. After such a call, the immovable generator must not move again, but this is not enforced by the compiler.</p>\n</blockquote>\n\n<p>The complete code:</p>\n\n<pre><code>#![feature(nll)]\n#![feature(generators, generator_trait)]\n\nuse std::ops::Generator;\n\nstruct Container&lt;G&gt;\nwhere\n    G: Generator&lt;Yield = i32, Return = ()&gt;,\n{\n    generator: G,\n}\n\nimpl Container&lt;Box&lt;Generator&lt;Yield = i32, Return = ()&gt;&gt;&gt; {\n    pub fn new() -&gt; Self {\n        let q = 42;\n        Container {\n            generator: Box::new(move || {\n                yield 1i32 * q;\n                yield 2i32 * q;\n                yield 3i32 * q;\n            }),\n        }\n    }\n}\n\nfn main() {}\n</code></pre>\n\n<p>Playground <a href=\"https://play.rust-lang.org/?gist=0b1ed644c4fca5256b785ac363c54d63&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">for the above</a> and <a href=\"https://play.rust-lang.org/?gist=8504ef8102e6200a1331dc376d7a8589&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">usage example</a>.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 1, "last_activity_date": 1528555226, "creation_date": 1528555226, "answer_id": 50775412, "question_id": 50767947, "link": "https://stackoverflow.com/questions/50767947/how-can-i-store-a-generator-in-a-struct/50775412#50775412", "title": "How can I store a generator in a struct?", "body": "<p>A trick that isn't always applicable is to split the creation of the generator (or iterator, these are amazingly similar concepts) into a separate function. This allows you to use <code>impl Trait</code>:</p>\n\n<pre><code>fn container_core(q: i32) -&gt; impl Generator&lt;Yield = i32, Return = ()&gt; {\n    move || {\n        yield 1 * q;\n        yield 2 * q;\n        yield 3 * q;\n    }\n}\n\nimpl&lt;G&gt; Container&lt;G&gt;\nwhere\n    G: Generator&lt;Yield = i32, Return = ()&gt;,\n{\n    pub fn new(generator: G) -&gt; Self {\n        Container { generator }\n    }\n}\n\nfn main() {\n    let x = Container::new(container_core(42));\n}\n</code></pre>\n\n<p>You still cannot name the type of <code>x</code> so you cannot store it in a struct, so the root problem is unsolved. Of course, you can combine the answers:</p>\n\n<pre><code>impl Container&lt;Box&lt;Generator&lt;Yield = i32, Return = ()&gt;&gt;&gt; {\n    fn new_boxed(q: i32) -&gt; Self {\n        Container::new(Box::new(container_core(q)))\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 15065, "user_id": 723090, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/ML1tj.png?s=128&g=1", "display_name": "Mark", "link": "https://stackoverflow.com/users/723090/mark"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 196, "favorite_count": 0, "answer_count": 2, "score": 0, "last_activity_date": 1528555226, "creation_date": 1528489554, "last_edit_date": 1528554456, "question_id": 50767947, "link": "https://stackoverflow.com/questions/50767947/how-can-i-store-a-generator-in-a-struct", "title": "How can I store a generator in a struct?", "body": "<p>I want to do <a href=\"https://play.rust-lang.org/?gist=9958d96a64bcf526745c0bcc8aca779e&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">this</a>:</p>\n\n<pre><code>#![feature(nll)]\n#![feature(generators, generator_trait)]\nuse std::ops::Generator;\n\nstruct Container&lt;G: Generator&lt;Yield = i32, Return = ()&gt;&gt; {\n    generator: G\n}\n\nimpl&lt;G: Generator&lt;Yield = i32, Return = ()&gt;&gt; Container&lt;G&gt; {\n    pub fn new() -&gt; Self {\n        let q = 42;\n        Container{ generator: || {\n            yield 2i32 * q;\n        } }\n    }\n}\n\nfn main() {}\n</code></pre>\n\n<p>I get this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:12:31\n   |\n   |           Container{ generator: || {\n   |  _______________________________^\n   | |             yield 2i32 * q;\n   | |         } }\n   | |_________^ expected type parameter, found generator\n   |\n   = note: expected type `G`\n              found type `[generator@src/main.rs:12:31: 14:10 q:_ _]`\n</code></pre>\n\n<p>Thanks to <a href=\"https://stackoverflow.com/q/32551177/155423\">&quot;Expected type parameter&quot; error in the constructor of a generic struct</a> I'm a little closer, having removed the generic type after <code>impl</code> (since I'm not implementing the struct for arbitrary <code>G</code>. I tried these variations, none of which work:</p>\n\n<pre><code>impl Container&lt;G&gt; \nwhere\n    G: Generator&lt;Yield = i32, Return = ()&gt;\n{ /* ... */ }\n</code></pre>\n\n\n\n<pre><code>impl Container&lt;Generator&lt;Yield = i32, Return = ()&gt;&gt; { /* ... */ }\n</code></pre>\n\n\n\n<pre><code>impl Container&lt;_&gt; { /* ... */ }\n</code></pre>\n"}, {"tags": ["floating-point", "rust", "traits", "literals"], "answers": [{"tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": false, "score": 1, "last_activity_date": 1528493014, "creation_date": 1528493014, "answer_id": 50768564, "question_id": 50767912, "link": "https://stackoverflow.com/questions/50767912/how-do-i-use-floating-point-number-literals-when-using-generic-types/50768564#50768564", "title": "How do I use floating point number literals when using generic types?", "body": "<p>You can't create a <code>Float</code> from a literal directly. I suggest an approach similar to the <code>FloatConst</code> trait:</p>\n\n<pre><code>trait SomeDomainSpecificScaleFactor {\n    fn factor() -&gt; Self;\n}\n\nimpl SomeDomainSpecificScaleFactor for f32 {\n    fn factor() -&gt; Self {\n        0.54\n    }\n}\n\nimpl SomeDomainSpecificScaleFactor for f64 {\n    fn factor() -&gt; Self {\n        0.54\n    }\n}\n\nfn scale_float&lt;T: Float + SomeDomainSpecificScaleFactor&gt;(x: T) -&gt; T {\n    x * T::factor()\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?gist=ed1f0b6f24295827e86786671bc54508&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">link to playground</a>)</p>\n"}, {"comments": [{"owner": {"reputation": 1743, "user_id": 398021, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/a5a39b5f9de50200406c7a209ff7a121?s=128&d=identicon&r=PG", "display_name": "goertzenator", "link": "https://stackoverflow.com/users/398021/goertzenator"}, "edited": false, "score": 0, "creation_date": 1528553179, "post_id": 50769919, "comment_id": 88557080, "body": "Thanks.  First one works, second one doesn&#39;t due to lack of f64-&gt;f32 conversion.  Fixed on <a href=\"https://play.rust-lang.org/?gist=35c7f1b82aac65be5119001fc586e181&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">playground</a>.  Inspection of assembly shows this is zero cost so I&#39;m happy!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 1743, "user_id": 398021, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/a5a39b5f9de50200406c7a209ff7a121?s=128&d=identicon&r=PG", "display_name": "goertzenator", "link": "https://stackoverflow.com/users/398021/goertzenator"}, "edited": false, "score": 0, "creation_date": 1528553981, "post_id": 50769919, "comment_id": 88557295, "body": "@goertzenator you could go the other way (<code>f32: Into&lt;T&gt;</code>)."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 10, "last_activity_date": 1528504642, "creation_date": 1528504642, "answer_id": 50769919, "question_id": 50767912, "link": "https://stackoverflow.com/questions/50767912/how-do-i-use-floating-point-number-literals-when-using-generic-types/50769919#50769919", "title": "How do I use floating point number literals when using generic types?", "body": "<p>Use the <a href=\"https://docs.rs/num-traits/0.2.4/num_traits/cast/trait.FromPrimitive.html\" rel=\"noreferrer\"><code>FromPrimitive</code> trait</a>:</p>\n\n<pre><code>use num_traits::{cast::FromPrimitive, float::Float};\n\nfn scale_float&lt;T: Float + FromPrimitive&gt;(x: T) -&gt; T {\n    x * T::from_f64(0.54).unwrap()\n}\n</code></pre>\n\n<p>Or the standard library <code>From</code> / <code>Into</code> traits</p>\n\n<pre><code>fn scale_float&lt;T&gt;(x: T) -&gt; T\nwhere\n    T: Float,\n    f64: Into&lt;T&gt;\n{\n    x * 0.54.into()\n}\n</code></pre>\n\n<p>See also: </p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/28565440/155423\">How do I use number literals with the Integer trait from the num crate?</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 0, "last_activity_date": 1555035853, "creation_date": 1555035853, "answer_id": 55643608, "question_id": 50767912, "link": "https://stackoverflow.com/questions/50767912/how-do-i-use-floating-point-number-literals-when-using-generic-types/55643608#55643608", "title": "How do I use floating point number literals when using generic types?", "body": "<p>In certain cases, you can add a restriction that the generic type must be able to be multiplied by the type of the literal. Here, we allow any type that can be multiplied by a <code>f64</code> so long as it produces the output type of <code>T</code> via the trait bound <code>Mul&lt;f64, Output = T&gt;</code>:</p>\n\n<pre><code>use num_traits::float::Float; // 0.2.6\nuse std::ops::Mul;\n\nfn scale_float&lt;T&gt;(x: T) -&gt; T\nwhere\n    T: Float + Mul&lt;f64, Output = T&gt;,\n{\n    x * 0.54\n}\n\nfn main() {\n    let a: f64 = scale_float(1.23);\n}\n</code></pre>\n\n<p>This may not work directly for the original problem, but it might depending on what concrete types you need to work with.</p>\n"}], "owner": {"reputation": 1743, "user_id": 398021, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/a5a39b5f9de50200406c7a209ff7a121?s=128&d=identicon&r=PG", "display_name": "goertzenator", "link": "https://stackoverflow.com/users/398021/goertzenator"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1496, "favorite_count": 4, "accepted_answer_id": 50769919, "answer_count": 3, "score": 6, "last_activity_date": 1555035853, "creation_date": 1528489333, "last_edit_date": 1528549197, "question_id": 50767912, "link": "https://stackoverflow.com/questions/50767912/how-do-i-use-floating-point-number-literals-when-using-generic-types", "title": "How do I use floating point number literals when using generic types?", "body": "<p>Regular float literals do not work:</p>\n\n<pre><code>extern crate num_traits;\n\nuse num_traits::float::Float;\n\nfn scale_float&lt;T: Float&gt;(x: T) -&gt; T {\n    x * 0.54\n}\n\nfn main() {\n    let a: f64 = scale_float(1.23);\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n --&gt; src/main.rs:6:9\n  |\n6 |     x * 0.54\n  |         ^^^^ expected type parameter, found floating-point variable\n  |\n  = note: expected type `T`\n             found type `{float}`\n</code></pre>\n"}, {"tags": ["rust", "lifetime", "borrow-checker"], "answers": [{"tags": [], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "is_accepted": true, "score": 2, "last_activity_date": 1528476829, "creation_date": 1528476829, "answer_id": 50765272, "question_id": 50761494, "link": "https://stackoverflow.com/questions/50761494/lifetime-of-a-value-vs-lifetime-of-a-borrow/50765272#50765272", "title": "Lifetime of a value vs lifetime of a borrow", "body": "<p>Rust builds successufully if the compiler can assure that the fields of a struct <code>T</code> that are references outlive the lifetime of <code>T</code>. </p>\n\n<p>With such <code>Player</code> definition:</p>\n\n<pre><code>struct Player&lt;'a, T&gt;\nwhere\n    T: Runner + 'a,\n{\n    t: &amp;'a T,\n}\n</code></pre>\n\n<ol>\n<li><p>We are naming with <code>'a</code> the lifetime of <code>t</code>.</p></li>\n<li><p>With <code>T: Runner + 'a</code> we are declaring that <code>T</code> implements <code>Runner</code> and that all (eventual) references in <code>T</code> must outlive <code>'a</code></p></li>\n</ol>\n\n<p>For the above considerations if <code>t</code> lifetime is <code>'a</code> then lifetimes of <code>Player</code> values are strictly minor of <code>'a</code>.</p>\n\n<p>Lets name <code>'b</code> such <code>Player</code> value lifetime, then: <code>'b &lt; 'a</code></p>\n\n<p>Avoiding <a href=\"https://doc.rust-lang.org/book/second-edition/ch10-03-lifetime-syntax.html#lifetime-elision\" rel=\"nofollow noreferrer\">lifetime elision</a> we may rewrite <code>as_ref</code> as:</p>\n\n<pre><code>fn as_ref&lt;'b&gt;(&amp;'b self) -&gt; &amp;'b T {\n    self.t\n}\n</code></pre>\n\n<p>The lifetime of borrow to <code>self</code> and of returned <code>&amp;T</code> is some lifetime strictly minor of <code>'a</code>.</p>\n"}], "owner": {"reputation": 3480, "user_id": 2686821, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/5dd46afe4f5a75f2667569582b20ac9b?s=128&d=identicon&r=PG&f=1", "display_name": "soupybionics", "link": "https://stackoverflow.com/users/2686821/soupybionics"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 123, "favorite_count": 0, "accepted_answer_id": 50765272, "answer_count": 1, "score": 0, "last_activity_date": 1528476829, "creation_date": 1528463748, "last_edit_date": 1528464372, "question_id": 50761494, "link": "https://stackoverflow.com/questions/50761494/lifetime-of-a-value-vs-lifetime-of-a-borrow", "title": "Lifetime of a value vs lifetime of a borrow", "body": "<p>I managed to write and compile this code:</p>\n\n<pre><code>trait Runner {}\n\nstruct Human {}\n\nimpl Runner for Human {}\n\nstruct Player&lt;'a, T&gt;\nwhere\n    T: Runner + 'a,\n{\n    t: &amp;'a T,\n}\n\nimpl&lt;'a, T&gt; AsRef&lt;T&gt; for Player&lt;'a, T&gt;\nwhere\n    T: Runner + 'a,\n{\n    fn as_ref(&amp;self) -&gt; &amp;T {\n        self.t\n    }\n}\n\nfn main() {}\n</code></pre>\n\n<p>My understanding is that in <code>struct Player</code>'s definition, <code>T</code> is some concrete type that implements trait <code>Runner</code> and <code>T</code>'s lifetime is <code>'a</code> long. <code>t</code> is borrowing <code>T</code> and the borrow is also <code>'a</code> long. </p>\n\n<p>Is this understanding correct?</p>\n\n<p>In <code>impl AsRef for Player</code>'s definition, how does the compiler know that lifetime of the returned borrow to <code>T</code>  (from <code>as_ref</code>) where <code>T</code>'s lifetime is <code>'a</code> needs to be less than or equal to <code>'a</code>? What is the lifetime of borrow to <code>self</code> ?</p>\n"}, {"tags": ["rust", "lifetime", "borrow-checker"], "answers": [{"comments": [{"owner": {"reputation": 51, "user_id": 9913609, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/38d6e26b4ffd03077caea76c7df60b6a?s=128&d=identicon&r=PG&f=1", "display_name": "Quidrex", "link": "https://stackoverflow.com/users/9913609/quidrex"}, "edited": false, "score": 0, "creation_date": 1528530072, "post_id": 50770050, "comment_id": 88551494, "body": "Got that; when is something like <code>T::IntoIter: &#39;a</code> necessary?"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1528506548, "creation_date": 1528506548, "answer_id": 50770050, "question_id": 50759319, "link": "https://stackoverflow.com/questions/50759319/why-are-these-exact-lifetimes-needed-for-the-code-to-compile/50770050#50770050", "title": "Why are these exact lifetimes needed for the code to compile?", "body": "<p><code>&amp;'a mut Iterator&lt;Item = &amp;'a String&gt;</code> means that the lifetimes of the reference to the iterator and the references returned by the iterator have to be able to be unified (to <code>'a</code>).</p>\n\n<p>Declaring that the iterator and the iterator's references have distinct lifetimes allows the code to compile:</p>\n\n<pre><code>struct Wrapper&lt;'i, 's: 'i&gt; {\n    it: &amp;'i mut Iterator&lt;Item = &amp;'s String&gt;,\n}\n</code></pre>\n\n<p>There's no need to add <code>T::IntoIter: 'a</code>.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/29861388/155423\">When is it useful to define multiple lifetimes in a struct?</a></li>\n</ul>\n"}], "owner": {"reputation": 51, "user_id": 9913609, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/38d6e26b4ffd03077caea76c7df60b6a?s=128&d=identicon&r=PG&f=1", "display_name": "Quidrex", "link": "https://stackoverflow.com/users/9913609/quidrex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 129, "favorite_count": 0, "accepted_answer_id": 50770050, "answer_count": 1, "score": 2, "last_activity_date": 1528506548, "creation_date": 1528456138, "last_edit_date": 1528506109, "question_id": 50759319, "link": "https://stackoverflow.com/questions/50759319/why-are-these-exact-lifetimes-needed-for-the-code-to-compile", "title": "Why are these exact lifetimes needed for the code to compile?", "body": "<p>I am writing a parser and needed a lookahead from an iterator but did not want to use the <code>Peekable</code> trait. Instead, I used a wrapper for the iterator. I came up with something like this, omitting everything unnecessary:</p>\n\n<pre><code>struct Wrapper&lt;'a&gt; {\n    it: &amp;'a mut Iterator&lt;Item = &amp;'a String&gt;,\n}\n\npub trait DoSomething {\n    fn do_something(self);\n}\n\nimpl&lt;'a, T&gt; DoSomething for T\nwhere\n    T: IntoIterator&lt;Item = &amp;'a String&gt;,\n{\n    fn do_something(self) {\n        let mut it = self.into_iter();\n        let throwaway = Wrapper { it: &amp;mut it };\n    }\n}\n</code></pre>\n\n<p>This fails to compile with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0309]: the associated type `&lt;T as std::iter::IntoIterator&gt;::IntoIter` may not live long enough\n  --&gt; src/main.rs:15:39\n   |\n15 |         let throwaway = Wrapper { it: &amp;mut it };\n   |                                       ^^^^^^^\n   |\n   = help: consider adding an explicit lifetime bound `&lt;T as std::iter::IntoIterator&gt;::IntoIter: 'a`...\nnote: ...so that the type `&lt;T as std::iter::IntoIterator&gt;::IntoIter` is not borrowed for too long\n  --&gt; src/main.rs:15:39\n   |\n15 |         let throwaway = Wrapper { it: &amp;mut it };\n   |                                       ^^^^^^^\n\nerror[E0309]: the associated type `&lt;T as std::iter::IntoIterator&gt;::IntoIter` may not live long enough\n  --&gt; src/main.rs:15:39\n   |\n15 |         let throwaway = Wrapper { it: &amp;mut it };\n   |                                       ^^^^^^^\n   |\n   = help: consider adding an explicit lifetime bound `&lt;T as std::iter::IntoIterator&gt;::IntoIter: 'a`...\nnote: ...so that the type `&lt;T as std::iter::IntoIterator&gt;::IntoIter` will meet its required lifetime bounds\n  --&gt; src/main.rs:15:39\n   |\n15 |         let throwaway = Wrapper { it: &amp;mut it };\n   |                                       ^^^^^^^\n</code></pre>\n\n<p>Although I do not understand why this is necessary (question 1), I added <code>T::IntoIter: 'a</code> to the where clause in the <code>impl</code>. This fails with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `it` does not live long enough\n  --&gt; src/main.rs:16:44\n   |\n16 |         let throwaway = Wrapper { it: &amp;mut it };\n   |                                            ^^ borrowed value does not live long enough\n17 |     }\n   |     - borrowed value only lives until here\n   |\nnote: borrowed value must be valid for the lifetime 'a as defined on the impl at 9:1...\n  --&gt; src/main.rs:9:1\n   |\n9  | / impl&lt;'a, T&gt; DoSomething for T\n10 | | where\n11 | |     T: IntoIterator&lt;Item = &amp;'a String&gt;,\n12 | |     T::IntoIter: 'a,\n...  |\n17 | |     }\n18 | | }\n   | |_^\n</code></pre>\n\n<p>I don't understand either why <code>it</code> does not live long enough, as the deallocation order should be <code>throwaway</code> and then <code>it</code>. Using a second lifetime <code>'b</code> also does not work, either with <code>'a: 'b</code> or with <code>'b: 'a</code> (I was frustrated and just tried every combination).</p>\n\n<p>The only thing that helped was to separate the lifetimes of the Iterator reference and its contained references and relating them (no need to specify the lifetime of <code>T::IntoIter</code>):</p>\n\n<pre><code>struct Wrapper&lt;'a, 'b: 'a&gt; {\n    it: &amp;'a mut Iterator&lt;Item = &amp;'b String&gt;,\n}\n</code></pre>\n\n<p>Why?</p>\n\n<p>It makes sense to say \"The item references have to live at least as long as the iterator reference\", but what I don't get is why they can't be the same and why the error messages are hinting at the <code>Wrapper</code> construction instead of the definition, where changing lifetimes did not help at all.</p>\n\n<p>I found the official documentation regarding lifetimes pretty confusing. It doesn't get into if lifetime annotations actually change anything in the compiled code regarding deallocation or if it's just aiding the static analysis without actually changing the real lifetime of a piece of memory.</p>\n"}, {"tags": ["module", "interface", "rust", "private", "public"], "comments": [{"owner": {"reputation": 2513, "user_id": 4725625, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/YwH49.png?s=128&g=1", "display_name": "Kwarrtz", "link": "https://stackoverflow.com/users/4725625/kwarrtz"}, "edited": false, "score": 0, "creation_date": 1528443874, "post_id": 50753923, "comment_id": 88519270, "body": "When I try to compile the code you&#39;ve suggested even without using <code>not_really_public_interface</code> I get the same error. Here&#39;s the <a href=\"https://play.rust-lang.org/?gist=179af72b7f3579e387328978c6a76075\" rel=\"nofollow noreferrer\">playground</a>."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 7, "last_activity_date": 1528449740, "last_edit_date": 1528449740, "creation_date": 1528446914, "answer_id": 50756593, "question_id": 50753923, "link": "https://stackoverflow.com/questions/50753923/private-inner-module-returning-private-item-gives-private-type-in-public-interf/50756593#50756593", "title": "Private inner module returning private item gives &quot;private type in public interface&quot; error", "body": "<p>The function <code>not_really_public_interface</code> <em>is</em> public so it could be used by <em>any</em> other module. But the <code>Private</code> struct can only be accessed by your root and <code>inner</code> modules.</p>\n\n<p>The leak would occur if another module imported <code>not_really_public_interface</code>. Rust is complaining that this <em>could</em> happen because it reports errors locally, rather than taking a \"whole world\" view across all usages in all modules and crates. Ultimately, this approach is more predictable for humans to reason about and faster for the machine.</p>\n\n<p>Rust lets you control the visibility more precisely though. If you tell it that the function is <em>only</em> available to the module one level up (the <code>super</code> module) then it knows there is no possibility of a leak:</p>\n\n<pre><code>mod inner {\n    use super::Private;\n\n    pub(super) fn not_really_public_interface() -&gt; Private { Private }\n}\n</code></pre>\n\n<p>You could also use <code>crate</code> instead of <code>super</code>, to mean any module in the same crate. Or, if the super module had a name, e.g. <code>my_mod</code>, you could use <code>pub(in ::my_mod)</code> to target it specifically.</p>\n"}], "owner": {"reputation": 769, "user_id": 7065821, "user_type": "registered", "accept_rate": 33, "profile_image": "https://i.stack.imgur.com/iLZC7.png?s=128&g=1", "display_name": "Challenger5", "link": "https://stackoverflow.com/users/7065821/challenger5"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 402, "favorite_count": 0, "accepted_answer_id": 50756593, "answer_count": 1, "score": 1, "last_activity_date": 1528449740, "creation_date": 1528435830, "last_edit_date": 1528441075, "question_id": 50753923, "link": "https://stackoverflow.com/questions/50753923/private-inner-module-returning-private-item-gives-private-type-in-public-interf", "title": "Private inner module returning private item gives &quot;private type in public interface&quot; error", "body": "<p>In the below example, the module <code>outer</code> has a private type <code>Private</code> and a private inner module <code>inner</code>. <code>inner</code> is able to access <code>Private</code> (because <strong>child modules can access their parent's private items</strong>, even if they are not parked as public).</p>\n\n<p><code>inner</code> defines a function <code>not_really_public_interface()</code>. While it is marked as public, <strong>it is really only available to <code>outer</code></strong> because <code>inner</code> itself is not public.</p>\n\n<p><em>outer.rs</em></p>\n\n<pre><code>struct Private;\nmod inner {\n  use super::Private;\n  pub fn not_really_public_interface() -&gt; Private {\n    Private\n  }\n}\n</code></pre>\n\n<p>This compiles without any problems.</p>\n\n<p><code>outer</code> should be able to use <code>inner::not_really_public_interface()</code> to obtain <code>Private</code>, as long as it makes sure not to export it. So let's do that:</p>\n\n<pre><code>pub fn main() {\n  let _ = self::inner::not_really_public_interface();\n}\n</code></pre>\n\n<p>Right?</p>\n\n<p><em>stderr</em></p>\n\n<pre><code>error[E0446]: private type `Private` in public interface\n --&gt; src/outer.rs:4:3\n  |\n4 | /   pub fn not_really_public_interface() -&gt; Private {\n5 | |     Private\n6 | |   }\n  | |___^ can't leak private type\n</code></pre>\n\n<p><strong>Wat.</strong> This is counter-intuitive to me for several reasons:</p>\n\n<ul>\n<li>The former code produces no error even though it defines a function with an interface Rust considers to \"leak\". The error only occurs when the <code>outer</code> attempt to <em>use</em> this function.</li>\n<li>The only place <code>inner</code> could possibly \"leak\" <code>Private</code> is to <em>the module that defined it</em>.</li>\n</ul>\n\n<p>So my questions are:</p>\n\n<ul>\n<li>What exactly is going on here that causes Rust to conclude that any part of this interface leaks? It seems like it treats <code>Private</code> as if it were defined in <code>inner</code>.</li>\n<li>Is there a context in which this makes perfect sense? My first thought was that this was a bug in the compiler or oversight in the privacy design, but I doubt that's the case.</li>\n<li>Is there a way to work around this without creating another module? I believe I can create a wrapper module and then just make <code>Private</code> public within <code>outer</code> and <code>inner</code>, but I'd prefer not to do that.</li>\n</ul>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 4, "creation_date": 1528433338, "post_id": 50753528, "comment_id": 88514939, "body": "Re-read the error. <code>&quot;did you mean to use &#39;;&#39; here?&quot;</code>."}, {"owner": {"reputation": 403, "user_id": 5692730, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/3f71ce4263a413f6a57dea5bf6f11996?s=128&d=identicon&r=PG&f=1", "display_name": "Luciano", "link": "https://stackoverflow.com/users/5692730/luciano"}, "reply_to_user": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 0, "creation_date": 1528433471, "post_id": 50753528, "comment_id": 88514974, "body": "@SimonWhitehead realized I had a type in the code block I posted."}, {"owner": {"reputation": 403, "user_id": 5692730, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/3f71ce4263a413f6a57dea5bf6f11996?s=128&d=identicon&r=PG&f=1", "display_name": "Luciano", "link": "https://stackoverflow.com/users/5692730/luciano"}, "reply_to_user": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 0, "creation_date": 1528433485, "post_id": 50753528, "comment_id": 88514976, "body": "Though I still get the same error."}, {"owner": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 2, "creation_date": 1528433611, "post_id": 50753528, "comment_id": 88515014, "body": "I&#39;ll point you to <a href=\"https://doc.rust-lang.org/book/second-edition/ch03-05-control-flow.html#repetition-with-loops\" rel=\"nofollow noreferrer\">the book which has examples on using <code>for...loop</code>s</a> for you to review. There is a very obvious syntactical error in your code."}, {"owner": {"reputation": 403, "user_id": 5692730, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/3f71ce4263a413f6a57dea5bf6f11996?s=128&d=identicon&r=PG&f=1", "display_name": "Luciano", "link": "https://stackoverflow.com/users/5692730/luciano"}, "reply_to_user": {"reputation": 57021, "user_id": 1517578, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/gd070.png?s=128&g=1", "display_name": "Simon Whitehead", "link": "https://stackoverflow.com/users/1517578/simon-whitehead"}, "edited": false, "score": 1, "creation_date": 1528433695, "post_id": 50753528, "comment_id": 88515042, "body": "Ah, I see it. Thank you for your help. @SimonWhitehead"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1528444473, "post_id": 50753528, "comment_id": 88519591, "body": "Too much python?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528462944, "post_id": 50753528, "comment_id": 88529911, "body": "Idiomatic Rust uses <code>snake_case</code> for variables, methods, macros, and fields and <code>UpperCamelCase</code> for types. Use <code>Polir</code> instead, please."}], "answers": [{"tags": [], "owner": {"reputation": 403, "user_id": 5692730, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/3f71ce4263a413f6a57dea5bf6f11996?s=128&d=identicon&r=PG&f=1", "display_name": "Luciano", "link": "https://stackoverflow.com/users/5692730/luciano"}, "is_accepted": false, "score": 2, "last_activity_date": 1528462973, "last_edit_date": 1528462973, "creation_date": 1528433663, "answer_id": 50753591, "question_id": 50753528, "link": "https://stackoverflow.com/questions/50753528/expecting-a-type-here-because-of-type-ascription/50753591#50753591", "title": "&quot;Expecting a type here because of type ascription&quot;", "body": "<p>This error was solved by removing the colon from <code>POLIR::generate_config()</code>:</p>\n\n<pre><code>fn generate_config(&amp;self, args: Vec&lt;String&gt;) {\n    for line in args {\n        println!{\"{}\", line};\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 403, "user_id": 5692730, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/3f71ce4263a413f6a57dea5bf6f11996?s=128&d=identicon&r=PG&f=1", "display_name": "Luciano", "link": "https://stackoverflow.com/users/5692730/luciano"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1554, "favorite_count": 0, "answer_count": 1, "score": -2, "last_activity_date": 1528462973, "creation_date": 1528433235, "last_edit_date": 1528462905, "question_id": 50753528, "link": "https://stackoverflow.com/questions/50753528/expecting-a-type-here-because-of-type-ascription", "title": "&quot;Expecting a type here because of type ascription&quot;", "body": "<p>I have some code that is attempting to read in a list of strings into struct values. With the code below, I am attempting to just print the lines from the <code>input_file</code> vector from inside <code>POLIR::generate_config()</code>. I am getting the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: expected type, found `{`\n --&gt; src/main.rs:5:27\n  |\n5 |         for line in args: {\n  |                           ^ expecting a type here because of type ascription\n</code></pre>\n\n<p>What am I doing wrong here?</p>\n\n<pre><code>struct POLIR {}\n\nimpl POLIR {\n    fn generate_config(&amp;self, args: Vec&lt;String&gt;) {\n        for line in args: {\n            println!{\"{}\", line};\n        }\n    }\n}\n\nfn main() {\n    //other program stuff\n    let input_file = lines_from_file(input_file);\n\n    let system = POLIR {};\n\n    POLIR::generate_config(&amp;system, input_file);\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1528444591, "post_id": 50752778, "comment_id": 88519642, "body": "Maybe you want to have a look at the <a href=\"https://doc.rust-lang.org/book/if-let.html\" rel=\"nofollow noreferrer\">if let</a> Syntax?"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1528452513, "post_id": 50752778, "comment_id": 88523900, "body": "@hellow <code>if let</code> does not support <a href=\"https://doc.rust-lang.org/1.5.0/book/patterns.html#guards\" rel=\"nofollow noreferrer\">Guards</a>."}], "answers": [{"comments": [{"owner": {"reputation": 28653, "user_id": 527288, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/9e175031c4adde62f40456f86a5e91b0?s=128&d=identicon&r=PG", "display_name": "Kurtis Nusbaum", "link": "https://stackoverflow.com/users/527288/kurtis-nusbaum"}, "edited": false, "score": 3, "creation_date": 1528462890, "post_id": 50753185, "comment_id": 88529880, "body": "is cloning really what I want to do here? It seems like I shouldn&#39;t have to. Can&#39;t clones be expensive?"}], "tags": [], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "is_accepted": false, "score": 3, "last_activity_date": 1528444050, "last_edit_date": 1528444050, "creation_date": 1528430574, "answer_id": 50753185, "question_id": 50752778, "link": "https://stackoverflow.com/questions/50752778/how-do-i-not-borrow-an-option-when-matching/50753185#50753185", "title": "How do I not borrow an Option when matching?", "body": "<p>The compiler complains because in the match arm <code>self</code> is still borrowed. You can get around this with cloning the <code>key</code> beforehand:</p>\n\n<pre><code>fn remove_descendent(&amp;mut self, key: &amp;K) -&gt; Option&lt;V&gt; {\n    match self.left.clone() {\n        Some(ref left) if left.key == *key =&gt; self.remove_left(),\n        _ =&gt; None,\n    }\n}\n</code></pre>\n\n<p>You can see this in action <a href=\"https://play.rust-lang.org/?gist=9afdcccd1904dd186acf63194210a409&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">on the Playground</a>.</p>\n\n<p>With <a href=\"https://github.com/rust-lang/rust-roadmap/issues/16\" rel=\"nofollow noreferrer\"><em>Non Lexical Lifetimes</em></a> enabled, your code compiles just fine: <a href=\"https://play.rust-lang.org/?gist=03109b8cfcb6bd8dad88b4be283a6c88&amp;version=nightly&amp;mode=debug\" rel=\"nofollow noreferrer\">Playground</a>.</p>\n"}], "owner": {"reputation": 28653, "user_id": 527288, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/9e175031c4adde62f40456f86a5e91b0?s=128&d=identicon&r=PG", "display_name": "Kurtis Nusbaum", "link": "https://stackoverflow.com/users/527288/kurtis-nusbaum"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 346, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1528464580, "creation_date": 1528427342, "last_edit_date": 1528464580, "question_id": 50752778, "link": "https://stackoverflow.com/questions/50752778/how-do-i-not-borrow-an-option-when-matching", "title": "How do I not borrow an Option when matching?", "body": "<p>I have the following code:</p>\n\n<pre><code>fn remove_descendent(&amp;mut self, key: &amp;K) -&gt; Option&lt;V&gt; {\n    if self.left.is_some() &amp;&amp; self.left.as_ref().unwrap().key == *key {\n        return self.remove_left();\n    }\n\n    // more of the function\n}\n</code></pre>\n\n<p>This feels gross to me. Instead of checking <code>is_some</code> and then unwrapping. I figured what I really should be doing is using a match statement to deconstruct the <code>Option</code> represented by the <code>left</code> variable like so:</p>\n\n<pre><code>fn remove_descendent(&amp;mut self, key: &amp;K) -&gt; Option&lt;V&gt; {\n    match self.left {\n        Some(ref left) if left.key == *key =&gt; self.remove_left(),\n        _ =&gt; None\n    }\n</code></pre>\n\n<p>However, when I do this I get the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `*self` as mutable because `self.left.0` is also borrowed as immutable\n  --&gt; src/lib.rs:29:51\n   |\n29 |             Some(ref left) if left.key == *key =&gt; self.remove_left(),\n   |                  --------                         ^^^^ mutable borrow occurs here\n   |                  |\n   |                  immutable borrow occurs here\n30 |             _ =&gt; None\n31 |         }\n   |         - immutable borrow ends here\n</code></pre>\n\n<p>I guess I get that I can't immutably borrow a structs member and then mutably borrow the struct. But if that's the case, what's the proper way to pattern match my <code>Option</code>? Is there one?</p>\n"}, {"tags": ["rust", "smart-pointers"], "comments": [{"owner": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "edited": false, "score": 1, "creation_date": 1528415650, "post_id": 50751606, "comment_id": 88511056, "body": "Do you mean something like <a href=\"https://doc.rust-lang.org/std/sync/struct.RwLock.html\" rel=\"nofollow noreferrer\"><code>RwLock</code></a>?"}, {"owner": {"reputation": 603, "user_id": 5426649, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/06e8dc32d97b1f0deb88bba090f58e46?s=128&d=identicon&r=PG&f=1", "display_name": "Olivier", "link": "https://stackoverflow.com/users/5426649/olivier"}, "reply_to_user": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "edited": false, "score": 0, "creation_date": 1528429088, "post_id": 50751606, "comment_id": 88513923, "body": "I do not think that RwLock will do the trick. Even though RwLock can be owned in one place, I do not think I can throw around weak references to the value encapsulated by RwLock. What if the original RwLock gets deleted?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1528448112, "post_id": 50751606, "comment_id": 88521419, "body": "Just for information, what is a usecase for this?"}, {"owner": {"reputation": 7287, "user_id": 963864, "user_type": "registered", "accept_rate": 17, "profile_image": "https://www.gravatar.com/avatar/94e2dd813e278309b6281b4a4b7fdddd?s=128&d=identicon&r=PG", "display_name": "curiousguy", "link": "https://stackoverflow.com/users/963864/curiousguy"}, "reply_to_user": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "edited": false, "score": 0, "creation_date": 1528610587, "post_id": 50751606, "comment_id": 88568722, "body": "@JorgeIsraelPe&#241;a RW locks can chose to let more reader enter or more writers. They can have different levels of writers that more or less force readers to wait... The last (or last and only) master_strong owner of a resource could decide to invalidate the weak owners, only letting those who had already upgraded to strong_from_weak, who wouldn&#39;t be able to create more owners. It&#39;s a &quot;we are closing, only those customers in the line can check out&quot; decision."}], "answers": [{"comments": [{"owner": {"reputation": 7287, "user_id": 963864, "user_type": "registered", "accept_rate": 17, "profile_image": "https://www.gravatar.com/avatar/94e2dd813e278309b6281b4a4b7fdddd?s=128&d=identicon&r=PG", "display_name": "curiousguy", "link": "https://stackoverflow.com/users/963864/curiousguy"}, "edited": false, "score": 0, "creation_date": 1528498657, "post_id": 50763746, "comment_id": 88546229, "body": "IOW, a &quot;weak reference&quot; is a strong reference to meta info."}, {"owner": {"reputation": 7287, "user_id": 963864, "user_type": "registered", "accept_rate": 17, "profile_image": "https://www.gravatar.com/avatar/94e2dd813e278309b6281b4a4b7fdddd?s=128&d=identicon&r=PG", "display_name": "curiousguy", "link": "https://stackoverflow.com/users/963864/curiousguy"}, "edited": false, "score": 0, "creation_date": 1528610264, "post_id": 50763746, "comment_id": 88568656, "body": "You could still have a bunch of strong references and weaker strong references that keep the object alive but that don&#39;t keep weak references upgradable. The store is closing, some customers will still be allowed to buy what they have in their cart, other will have to leave... You can prevent some customers from upgrading to close earlier."}], "tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": false, "score": 6, "last_activity_date": 1528471106, "creation_date": 1528471106, "answer_id": 50763746, "question_id": 50751606, "link": "https://stackoverflow.com/questions/50751606/is-there-a-shared-pointer-with-a-single-strong-owner-and-multiple-weak-reference/50763746#50763746", "title": "Is there a shared pointer with a single strong owner and multiple weak references?", "body": "<p>Let's assume it exists with types <code>Strong&lt;T&gt;</code> and <code>Weak&lt;T&gt;</code>.  How do you use <code>Weak&lt;T&gt;</code>?  You need some kind of fallible \"upgrade\" step, so what does <code>Weak&lt;T&gt;</code> upgrade to?  It can't be to a plain reference (as you've stated), because <code>Strong&lt;T&gt;</code> <strong>needs</strong> to know whether or not any \"upgraded\" <code>Weak&lt;T&gt;</code>s exist.  If it didn't, it could deallocate its storage whilst the value is still being accessed.</p>\n\n<p>So <code>Weak&lt;T&gt;</code> must upgrade to some kind of <code>SemiWeak&lt;T&gt;</code> which keeps the underlying allocation alive... which is exactly what shared ownership <em>is</em>.</p>\n\n<p>What if you somehow guaranteed that <code>Strong&lt;T&gt;</code> couldn't be deallocated before all <code>Weak&lt;T&gt;</code>s go away?  Congratulations, you've just re-invented <code>T</code> and <code>&amp;T</code>: you could literally just use those instead.</p>\n\n<p>Alright, so <em>what if</em> you made it so that <code>Weak&lt;T&gt;</code> upgrades into a <code>SemiWeak&lt;'a, T&gt;</code> that is tied to the lifetime of the <code>Weak&lt;T&gt;</code> so that it <em>can't</em> outlive it, and can only be a temporary?  All you're really doing in that case is <em>hiding</em> the fact that you've got shared ownership.  Under the hood, <code>SemiWeak</code> would still need to guarantee the underlying <code>Strong</code> can't go away.  You could trivially build such a type from <code>Rc&lt;T&gt;</code> in perhaps ten minutes.  This would effectively give you a type that is exactly like <code>Rc&lt;T&gt;</code>, with the same performance and memory cost, but less useful.</p>\n\n<p>In addition, that <code>get_mut</code> method can't exist.  There's no way to prevent <code>SemiWeak&lt;T&gt;</code>s from existing.  Unless you use borrowing but, again, that's just using <code>T</code> and <code>&amp;T</code>.</p>\n\n<p>So, no, I don't think this exists, nor do I believe it <em>can</em> in the form you've described.</p>\n\n<hr>\n\n<p>As a final aside, just having <code>Weak&lt;T&gt;</code> <em>at all</em> is a form of shared ownership, because those <code>Weak&lt;T&gt;</code>s <em>need to point to something</em>.  In the case of <code>Rc&lt;T&gt;</code>, the weak counter is stored right alongside the strong counter, so whilst the value can be destroyed, the allocation <em>itself</em> sticks around.  You could split the two, but now you're paying for two allocations <em>and</em> double indirection (probably leading to more cache misses).</p>\n"}], "owner": {"reputation": 603, "user_id": 5426649, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/06e8dc32d97b1f0deb88bba090f58e46?s=128&d=identicon&r=PG&f=1", "display_name": "Olivier", "link": "https://stackoverflow.com/users/5426649/olivier"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 398, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1528471106, "creation_date": 1528415554, "last_edit_date": 1528462780, "question_id": 50751606, "link": "https://stackoverflow.com/questions/50751606/is-there-a-shared-pointer-with-a-single-strong-owner-and-multiple-weak-reference", "title": "Is there a shared pointer with a single strong owner and multiple weak references?", "body": "<p>I am looking for a smart pointer similar to <code>Arc</code>/<code>Rc</code> except that it does not allow shared ownership.</p>\n\n<p>I want to have as many <code>rc::Weak</code> references as I need, but I only want <strong>one</strong> strong reference, a.k.a owner. And I want to enforce that with the type system.</p>\n\n<p><code>Arc</code>/<code>Rc</code> can be cloned, and they can be owned at several places.</p>\n\n<p>Rolling up my own smart pointer would be an option, but I believe such data structure should already exist, even if outside the standard library.</p>\n\n<p>I am looking for a data structure providing this kind of interface:</p>\n\n<pre><code>impl MySmartPointer&lt;T&gt; {\n    fn new(object: T) -&gt; Self;\n    fn weak_ref(&amp;self) -&gt; WeakRef&lt;T&gt;;\n    fn get_mut(&amp;mut self) -&gt; &amp;mut T;\n}\n\nimpl WeakRef&lt;T&gt; {\n    /// If the strong pointer `MySmartPointer` has been dropped,\n    /// return `None`. Else return Some(&amp;T);\n    fn get(&amp;self) -&gt; Option&lt;&amp;T&gt;;\n}\n</code></pre>\n"}, {"tags": ["rust", "udp"], "comments": [{"owner": {"reputation": 10672, "user_id": 321731, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/88e60659e997d36af3ff348b3251e1a6?s=128&d=identicon&r=PG", "display_name": "tshepang", "link": "https://stackoverflow.com/users/321731/tshepang"}, "edited": false, "score": 0, "creation_date": 1528407847, "post_id": 50750568, "comment_id": 88508954, "body": "If it matters, I want to check if openvpn is running on remote, port 1194"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 5, "creation_date": 1528410829, "post_id": 50750568, "comment_id": 88509845, "body": "This is not really specific to Rust. There is no good and reliable way to check whether a UDP port is open because UDP is a send-and-forget protocol. You also won&#39;t get confirmation that messages have actually been received, that&#39;s why all <code>send</code> seem to be successful."}, {"owner": {"reputation": 49065, "user_id": 13422, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/94b309d78a1253a334e9b82643a8dc97?s=128&d=identicon&r=PG", "display_name": "Zan Lynx", "link": "https://stackoverflow.com/users/13422/zan-lynx"}, "edited": false, "score": 1, "creation_date": 1528422969, "post_id": 50750568, "comment_id": 88512595, "body": "see also <a href=\"https://stackoverflow.com/questions/42539898/how-to-check-if-remote-udp-port-is-open-c\" title=\"how to check if remote udp port is open c\">stackoverflow.com/questions/42539898/&hellip;</a>"}, {"owner": {"reputation": 49065, "user_id": 13422, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/94b309d78a1253a334e9b82643a8dc97?s=128&d=identicon&r=PG", "display_name": "Zan Lynx", "link": "https://stackoverflow.com/users/13422/zan-lynx"}, "edited": false, "score": 1, "creation_date": 1528423024, "post_id": 50750568, "comment_id": 88512606, "body": "and <a href=\"https://stackoverflow.com/questions/10886228/checking-open-udp-port-in-c\" title=\"checking open udp port in c\">stackoverflow.com/questions/10886228/&hellip;</a>"}, {"owner": {"reputation": 288867, "user_id": 207421, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=128&d=identicon&r=PG", "display_name": "user207421", "link": "https://stackoverflow.com/users/207421/user207421"}, "edited": false, "score": 0, "creation_date": 1529464337, "post_id": 50750568, "comment_id": 88877351, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/10886228/checking-open-udp-port-in-c\">Checking open UDP Port in C++</a>"}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1529500152, "post_id": 50939609, "comment_id": 88895569, "body": "<i>If the API is written correctly</i> \u2014 Which API? Can you prove this one way or the other for the OPs question?"}, {"owner": {"reputation": 288867, "user_id": 207421, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=128&d=identicon&r=PG", "display_name": "user207421", "link": "https://stackoverflow.com/users/207421/user207421"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1577648604, "post_id": 50939609, "comment_id": 105216390, "body": "@Shepmaster There is no necessity to prove documented behaviour."}], "tags": [], "owner": {"reputation": 288867, "user_id": 207421, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=128&d=identicon&r=PG", "display_name": "user207421", "link": "https://stackoverflow.com/users/207421/user207421"}, "is_accepted": false, "score": -2, "last_activity_date": 1529464165, "creation_date": 1529464165, "answer_id": 50939609, "question_id": 50750568, "link": "https://stackoverflow.com/questions/50750568/how-do-i-check-if-a-remote-udp-port-is-open/50939609#50939609", "title": "How do I check if a remote UDP port is open?", "body": "<p>Contrary to other answers and comments, there is a way. Connect to it with <code>connect()</code> and try a few sends. If the API is written correctly you should eventually get an error corresponding to the underlying ICMP UNREACHABLE message that is sent if the remote port isn't there.</p>\n"}], "owner": {"reputation": 10672, "user_id": 321731, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/88e60659e997d36af3ff348b3251e1a6?s=128&d=identicon&r=PG", "display_name": "tshepang", "link": "https://stackoverflow.com/users/321731/tshepang"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 546, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1529464165, "creation_date": 1528407801, "last_edit_date": 1528421605, "question_id": 50750568, "link": "https://stackoverflow.com/questions/50750568/how-do-i-check-if-a-remote-udp-port-is-open", "title": "How do I check if a remote UDP port is open?", "body": "<p>In order to check if I can reach a particular TCP port, I use:</p>\n\n<pre><code>TcpStream::connect_timeout(&amp;socket, Duration...\n</code></pre>\n\n<p>There is no clear equivalent with UdpSocket, so would like to know what would work similarly. The closest I could find is using the <code>set_write_timeout</code>, then doing a <code>send</code> or <code>send_to</code>, but these yield wrong results in that they show that the connection is successful, when the port is not even open on the other side.</p>\n"}, {"tags": ["dictionary", "generics", "rust"], "answers": [{"comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 2, "creation_date": 1528413263, "post_id": 50751081, "comment_id": 88510489, "body": "The entry API is more efficient. Having to first check if the key exists and then insert will have to lookup in the map twice."}, {"owner": {"reputation": 445, "user_id": 1147211, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2c133f3fd48e1fd4d0e60d96bffc8b3c?s=128&d=identicon&r=PG", "display_name": "rokob", "link": "https://stackoverflow.com/users/1147211/rokob"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1528488776, "post_id": 50751081, "comment_id": 88542980, "body": "Fine then because this is panicing on the value existing, just do the insert and panic if the return value is not <code>None</code>. You get better performance in the normal case, and you shouldn&#39;t care about the performance right before a panic anyway."}], "tags": [], "owner": {"reputation": 445, "user_id": 1147211, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2c133f3fd48e1fd4d0e60d96bffc8b3c?s=128&d=identicon&r=PG", "display_name": "rokob", "link": "https://stackoverflow.com/users/1147211/rokob"}, "is_accepted": false, "score": 0, "last_activity_date": 1528421015, "last_edit_date": 1528421015, "creation_date": 1528411217, "answer_id": 50751081, "question_id": 50750309, "link": "https://stackoverflow.com/questions/50750309/how-do-i-write-a-function-to-work-with-a-generic-map-and-its-entry-type/50751081#50751081", "title": "How do I write a function to work with a generic map and its entry type?", "body": "<p>You could create this trait</p>\n\n<pre><code>trait Map&lt;K: Hash + Eq, V&gt; {\n    fn contains_key&lt;Q&gt;(&amp;self, k: &amp;Q) -&gt; bool;\n    where\n        K: Borrow&lt;Q&gt;,\n        Q: Hash + Eq + Ord + ?Sized,\n\n    fn insert(&amp;mut self, k: K, v: V) -&gt; Option&lt;V&gt;;\n}\n</code></pre>\n\n<p>and then just write your generic <code>insert_or_panic</code> to use <code>contains_key</code> and <code>insert</code> rather than the Entry API.</p>\n\n<p>However, there are only two types of map, and their keys require different things, in particular the <code>BTreeMap</code> requires ordered keys. This sounds like a case where writing a generic function rather than two functions is overkill.</p>\n"}, {"comments": [{"owner": {"reputation": 1453, "user_id": 2018010, "user_type": "registered", "accept_rate": 83, "profile_image": "https://i.stack.imgur.com/fwCYF.gif?s=128&g=1", "display_name": "magras", "link": "https://stackoverflow.com/users/2018010/magras"}, "edited": false, "score": 0, "creation_date": 1528463050, "post_id": 50752179, "comment_id": 88529981, "body": "<code>HashMap</code> and <code>BTreeMap</code> are quite different for the end user, but not for this generic code. Yes, they have different type requirements and operation complexity, but if I could say that K&#39;s type requirements are the same as for K in <code>M&lt;K,V&gt;</code> and complexity is the same as <code>M.entry()</code> it would be totally okay. Maybe I&#39;m too exposed to C++ templates and I need to change the way I&#39;m thinking about problems, but for now this seems to me as a limitation."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 0, "last_activity_date": 1528421560, "creation_date": 1528421560, "answer_id": 50752179, "question_id": 50750309, "link": "https://stackoverflow.com/questions/50750309/how-do-i-write-a-function-to-work-with-a-generic-map-and-its-entry-type/50752179#50752179", "title": "How do I write a function to work with a generic map and its entry type?", "body": "<blockquote>\n  <p>Is it time for another trait?</p>\n</blockquote>\n\n<p>Yes. No one has needed to have this particular generic expression, so you get to abstract across them yourself.</p>\n\n<pre><code>trait InsertOrPanic&lt;K, V&gt; {\n    fn generic_insert_or_panic(&amp;mut self, k: K, v: V);\n}\n\nuse std::collections::HashMap;\nuse std::hash::Hash;\n\nimpl&lt;K, V&gt; InsertOrPanic&lt;K, V&gt; for HashMap&lt;K, V&gt;\nwhere\n    K: Eq + Hash,\n{\n    fn generic_insert_or_panic(&amp;mut self, k: K, v: V) {\n        use std::collections::hash_map::Entry;\n\n        match self.entry(k) {\n            Entry::Vacant(o) =&gt; o.insert(v),\n            Entry::Occupied(_) =&gt; panic!(\"attempt to overwrite entry in dictionary\"),\n        };\n    }\n}\n\nuse std::collections::BTreeMap;\n\nimpl&lt;K, V&gt; InsertOrPanic&lt;K, V&gt; for BTreeMap&lt;K, V&gt;\nwhere\n    K: Ord,\n{\n    fn generic_insert_or_panic(&amp;mut self, k: K, v: V) {\n        use std::collections::btree_map::Entry;\n\n        match self.entry(k) {\n            Entry::Vacant(o) =&gt; o.insert(v),\n            Entry::Occupied(_) =&gt; panic!(\"attempt to overwrite entry in dictionary\"),\n        };\n    }\n}\n</code></pre>\n\n<p>Note that the bounds on the implementations of each is different (<code>Hash + Eq</code> vs. <code>Ord</code>), so they are pretty fundamentally different.</p>\n\n<blockquote>\n  <p>I feel that I'm going wrong direction. How to solve this problem?</p>\n  \n  <p>I just started to learn Rust and some of my problems may look unrealistic and far-fetched, but I'm looking for ways to solve problems</p>\n</blockquote>\n\n<p>You haven't provided enough information to justify your needs, so I'd challenge this statement. Generally you don't need to be generic over two types of maps because a problem domain naturally gravitates to one or the other.</p>\n"}], "owner": {"reputation": 1453, "user_id": 2018010, "user_type": "registered", "accept_rate": 83, "profile_image": "https://i.stack.imgur.com/fwCYF.gif?s=128&g=1", "display_name": "magras", "link": "https://stackoverflow.com/users/2018010/magras"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 60, "favorite_count": 0, "accepted_answer_id": 50752179, "answer_count": 2, "score": 0, "last_activity_date": 1528557939, "creation_date": 1528406361, "last_edit_date": 1528557939, "question_id": 50750309, "link": "https://stackoverflow.com/questions/50750309/how-do-i-write-a-function-to-work-with-a-generic-map-and-its-entry-type", "title": "How do I write a function to work with a generic map and its entry type?", "body": "<p>I need function that protects my <code>HashMap</code> from overwriting already existing values, so I've written a simple function like this:</p>\n\n<pre><code>fn insert_or_panic&lt;K, V&gt;(m: &amp;mut HashMap&lt;K, V&gt;, k: K, v: V)\nwhere\n    K: Hash + Eq,\n{\n    use std::collections::hash_map::Entry;\n    match m.entry(k) {\n        Entry::Vacant(o) =&gt; o.insert(v),\n        Entry::Occupied(_) =&gt; panic!(\"attempt to overwrite entry in dictionary\"),\n    };\n}\n</code></pre>\n\n<p>Now I want to generalize it to work with any kind of map:</p>\n\n<pre><code>fn generic_insert_or_panic&lt;M, K, V&gt;(m: &amp;mut M, k: K, v: V)\nwhere\n    K: Hash + Eq,\n    M: Map&lt;K, V&gt;,\n{\n    use std::collections::hash_map::Entry;\n    match m.entry(k) {\n        Entry::Vacant(o) =&gt; o.insert(v),\n        Entry::Occupied(_) =&gt; panic!(\"attempt to overwrite entry in dictionary\"),\n    };\n}\n</code></pre>\n\n<p>All methods of <code>HashMap</code> that I'm interested in are in its <code>impl</code> block not associated with any trait, so it looks like I have to implement a new trait:</p>\n\n<pre><code>trait Map&lt;K: Hash + Eq, V&gt; {\n    fn entry(&amp;mut self, key: K) -&gt; Entry&lt;K, V&gt;;\n}\n</code></pre>\n\n<p>Every map has it's own <code>Entry</code> type: <code>std::collections::hash_map::Entry</code> or <code>std::collections::btree_map::Entry</code> and I don't see a fitting trait to replace <code>Entry</code>. Is it time for another trait?</p>\n\n<p>I feel that I'm going wrong direction. How to solve this problem?</p>\n\n<hr>\n\n<p>I just started to learn Rust and some of my problems may look unrealistic and far-fetched, but I'm looking for ways to solve problems, not to work around them, or at least to know the limits of the language.</p>\n\n<hr>\n\n<p>FAQ <a href=\"https://www.rust-lang.org/en-US/faq.html#what-are-higher-kinded-types\" rel=\"nofollow noreferrer\">explains</a> that higher-kinded types can solve this problem, but it is a big feature, so rust want to approach it carefully.</p>\n"}, {"tags": ["windows", "rust"], "comments": [{"owner": {"reputation": 1470, "user_id": 2075745, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/6f9a084d236381e1882c4e28edb5151f?s=128&d=identicon&r=PG", "display_name": "user25064", "link": "https://stackoverflow.com/users/2075745/user25064"}, "edited": false, "score": 2, "creation_date": 1528401724, "post_id": 50749050, "comment_id": 88506197, "body": "In the start menu search for <code>developer command prompt</code> and try to execute your command from that console. That handles the <code>vcvars</code> for you."}], "answers": [{"tags": [], "owner": {"reputation": 21030, "user_id": 15619, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/2f169a510b7cba5a57e86d520b268447?s=128&d=identicon&r=PG", "display_name": "Riduidel", "link": "https://stackoverflow.com/users/15619/riduidel"}, "is_accepted": false, "score": 0, "last_activity_date": 1534248651, "creation_date": 1534248651, "answer_id": 51841117, "question_id": 50749050, "link": "https://stackoverflow.com/questions/50749050/cant-install-cargo-tree-couldnt-determine-visual-studio-generator/51841117#51841117", "title": "Can&#39;t install cargo-tree: couldn&#39;t determine visual studio generator", "body": "<p>According to @user25064, this requires installing the command through developer command prompt (and, more specifically, the developer command prompt for your architecture - take attention to x86/x64 architectures)</p>\n"}], "owner": {"reputation": 21030, "user_id": 15619, "user_type": "registered", "accept_rate": 91, "profile_image": "https://www.gravatar.com/avatar/2f169a510b7cba5a57e86d520b268447?s=128&d=identicon&r=PG", "display_name": "Riduidel", "link": "https://stackoverflow.com/users/15619/riduidel"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 400, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1534248651, "creation_date": 1528400438, "last_edit_date": 1528402027, "question_id": 50749050, "link": "https://stackoverflow.com/questions/50749050/cant-install-cargo-tree-couldnt-determine-visual-studio-generator", "title": "Can&#39;t install cargo-tree: couldn&#39;t determine visual studio generator", "body": "<p>I'm trying to install cargo-tree on my Windows machine. It uses Windows 10, Visual Studio build tools 15. This is my active rustup toolchain:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>active toolchain\n----------------\n\nstable-x86_64-pc-windows-msvc (default)\nrustc 1.26.0 (a77568041 2018-05-07)\n</code></pre>\n\n<p>When running <code>cargo install cargo-tree</code>, the build fails. The build log ends with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: failed to run custom build command for `libssh2-sys v0.2.7`\nprocess didn't exit successfully: `C:\\Users\\NICOLA~1\\AppData\\Local\\Temp\\cargo-installt7F5FM\\release\\build\\libssh2-sys-726b9e90a2ed2b95\\build-script-build` (exit code: 101)\n--- stderr\nfatal: not a git repository (or any of the parent directories): .git\nthread 'main' panicked at '\n\ncouldn't determine visual studio generator\nif VisualStudio is installed, however, consider running the appropriate vcvars script before building this crate\n', C:\\Users\\nicolas-delsaux\\.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\cmake-0.1.31\\src\\lib.rs:552:25\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\n\nwarning: build failed, waiting for other jobs to finish...\nerror: failed to compile `cargo-tree v0.18.0`, intermediate artifacts can be found at `C:\\Users\\NICOLA~1\\AppData\\Local\\Temp\\cargo-installt7F5FM`\n</code></pre>\n\n<p>According to some documentation I found on the web, it seems to be related to some <code>vcvars</code> script to invoke, and an older Visual Studio version to install. I don't fully understand what to do so</p>\n\n<ul>\n<li>Should I install an older version of Visual Studio?</li>\n<li>Do I have some script to run?</li>\n</ul>\n"}, {"tags": ["rust", "lifetime"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1528373948, "post_id": 50740632, "comment_id": 88489465, "body": "What do you want to do exactly?"}, {"owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528374610, "post_id": 50740632, "comment_id": 88489923, "body": "@Boiethios exactly what I stated, that function calls another function which requires a static lifetime, so the function itself requires a static lifetime in order to conform to those requirements. I need to call that function from main, which the compiler prevents due to the struct apparently outliving main."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528374676, "post_id": 50740632, "comment_id": 88489967, "body": "What is this function that requires a static lifetime?"}, {"owner": {"reputation": 205, "user_id": 4846418, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/be82940aac7db2359ec9e7b64a9e511b?s=128&d=identicon&r=PG&f=1", "display_name": "raggy", "link": "https://stackoverflow.com/users/4846418/raggy"}, "edited": false, "score": 0, "creation_date": 1528376462, "post_id": 50740632, "comment_id": 88491253, "body": "Your problem is that you require the reference to self to have a static livetime but it is defined in the main function. Try: <a href=\"https://play.rust-lang.org/?gist=0641e22a79898b268dec91e05ac1d160&amp;version=stable&amp;mode=debug\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528376981, "post_id": 50740632, "comment_id": 88491629, "body": "@Boiethios hyper requires a static runtime when running the server and processing each request. What&#39;s worse is it&#39;s actually two layers of static requirements (two closures)."}, {"owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "reply_to_user": {"reputation": 205, "user_id": 4846418, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/be82940aac7db2359ec9e7b64a9e511b?s=128&d=identicon&r=PG&f=1", "display_name": "raggy", "link": "https://stackoverflow.com/users/4846418/raggy"}, "edited": false, "score": 0, "creation_date": 1528377008, "post_id": 50740632, "comment_id": 88491647, "body": "@raggy unfortunately I have tried that, but it doesn&#39;t support dynamically configuring the struct, you have to have a plain struct value."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528377181, "post_id": 50740632, "comment_id": 88491798, "body": "@lyptt Maybe you can use a lazy static"}, {"owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528377635, "post_id": 50740632, "comment_id": 88492178, "body": "@Boiethios That solved it! Can you submit that as an answer so I can accept it?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1528381696, "post_id": 50740632, "comment_id": 88495218, "body": "@lyptt Sorry, I was busy. You can accept one of the answers that suit you"}], "answers": [{"comments": [{"owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "edited": false, "score": 0, "creation_date": 1528385365, "post_id": 50742938, "comment_id": 88497787, "body": "Yeah I&#39;ve got a wrapper class that needs a reference to <code>self</code>, I can pass in an Arc which works around that particular issue but it still has various <code>&#39;static</code> complaints."}, {"owner": {"reputation": 18225, "user_id": 152580, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/34b114b30616ba935061582133cceeb8?s=128&d=identicon&r=PG", "display_name": "Eloff", "link": "https://stackoverflow.com/users/152580/eloff"}, "edited": false, "score": 0, "creation_date": 1600870774, "post_id": 50742938, "comment_id": 113225767, "body": "@Shepmaster from the rust reference &quot;Static items do not call drop at the end of the program&quot; so static and Box::leak are basically identical, except the latter are on the heap. Honestly given how annoying rust is about initializing static variables, Box::leak seems like a superior way to create static variables with runtime initialization."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 18225, "user_id": 152580, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/34b114b30616ba935061582133cceeb8?s=128&d=identicon&r=PG", "display_name": "Eloff", "link": "https://stackoverflow.com/users/152580/eloff"}, "edited": false, "score": 0, "creation_date": 1600873149, "post_id": 50742938, "comment_id": 113227102, "body": "@Eloff I don&#39;t understand what the goal of your comment is. The answer already lists leaking memory as a solution."}, {"owner": {"reputation": 18225, "user_id": 152580, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/34b114b30616ba935061582133cceeb8?s=128&d=identicon&r=PG", "display_name": "Eloff", "link": "https://stackoverflow.com/users/152580/eloff"}, "edited": false, "score": 0, "creation_date": 1600875376, "post_id": 50742938, "comment_id": 113228264, "body": "@Shepmaster You mentioned &quot;This should be discouraged because leaking memory isn&#39;t a good thing&quot;, and indeed it sounds scary. But that&#39;s exactly how rust static works anyway, so I don&#39;t think it should be discouraged for this specific use case."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 12, "last_activity_date": 1528385645, "last_edit_date": 1528385645, "creation_date": 1528379353, "answer_id": 50742938, "question_id": 50740632, "link": "https://stackoverflow.com/questions/50740632/how-do-i-call-a-function-that-requires-a-static-lifetime-with-a-variable-create/50742938#50742938", "title": "How do I call a function that requires a &#39;static lifetime with a variable created in main?", "body": "<p>The <em>primary</em> way to create a reference that has the <code>'static</code> lifetime is to make the variable <code>static</code>. A static variable is one that can be created at <em>compile time</em>:</p>\n\n<pre><code>struct MyStruct;\n\nimpl MyStruct {\n    pub fn do_something(&amp;'static self) {}\n}\n\nstatic OBJ: MyStruct = MyStruct;\n\nfn main() {\n    OBJ.do_something();\n}\n</code></pre>\n\n<p>As Rust's constant evaluation story improves, this will be more common, but it will never allow configuration at runtime.</p>\n\n<p>A far less common method is to deliberately leak memory, producing a reference that will last \"forever\". This should be discouraged because leaking memory isn't a good thing:</p>\n\n<pre><code>fn main() {\n    let obj = Box::leak(Box::new(MyStruct));\n    obj.do_something();\n}\n</code></pre>\n\n<p>There's also the possibility of creating a singleton:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/27791532/155423\">How do I create a global, mutable singleton?</a></li>\n<li><a href=\"https://stackoverflow.com/q/27221504/155423\">How can you make a safe static singleton in Rust?</a></li>\n</ul>\n\n<blockquote>\n  <p>as once <code>main</code> is complete the application should exit.</p>\n</blockquote>\n\n<p>Perhaps, but the compiler doesn't treat <code>main</code> specially for lifetime purposes.</p>\n\n<hr>\n\n<blockquote>\n  <p>hyper requires a static runtime when running the server and processing each request.</p>\n</blockquote>\n\n<p>No, it doesn't. It has a bound of <code>: 'static</code>, which means that any references passed in must be <code>'static</code>, but you don't have to pass in a bare reference at all.</p>\n\n<p>For patterns like this, the most common thing is to pass in something like an <a href=\"https://doc.rust-lang.org/std/sync/struct.Arc.html\" rel=\"noreferrer\"><code>Arc</code></a>. This allows sharing of the underlying resource.</p>\n\n<pre><code>pub fn do_something&lt;F, T&gt;(f: F)\nwhere\n    F: Fn() -&gt; T + 'static,\n    T: 'static,\n{\n    // \"spawn\" 3 threads\n    f();\n    f();\n    f();\n}\n\nstruct MyStruct;\n\nstatic OBJ: MyStruct = MyStruct;\n\nfn main() {\n    // OK\n    do_something(|| &amp;OBJ);\n\n    // Not OK\n    let another = MyStruct;\n    do_something(|| &amp;another);\n\n    // OK\n    use std::sync::Arc;\n    let shared = Arc::new(MyStruct);\n    do_something(move || shared.clone());\n}\n</code></pre>\n\n<p>You can even use <a href=\"https://doc.rust-lang.org/std/cell/#when-to-choose-interior-mutability\" rel=\"noreferrer\">interior mutability</a> if you wanted dynamic reconfiguration.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/30562443/155423\">How do I use static lifetimes with threads?</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 9, "last_activity_date": 1528379754, "creation_date": 1528379754, "answer_id": 50743093, "question_id": 50740632, "link": "https://stackoverflow.com/questions/50740632/how-do-i-call-a-function-that-requires-a-static-lifetime-with-a-variable-create/50743093#50743093", "title": "How do I call a function that requires a &#39;static lifetime with a variable created in main?", "body": "<p>The naive way to do this is with a <code>static</code> variable, but it will require unsafe code if you need to actually set the value inside your <code>main</code> function:</p>\n\n<pre><code>static mut OBJ: MyStruct = MyStruct;\n\nfn main() {\n    unsafe {\n        OBJ = MyStruct {};\n        OBJ.doSomething();\n    }\n}\n</code></pre>\n\n<p>It's also <code>unsafe</code> to do pretty much anything with a mutable static thereafter.</p>\n\n<p>The much better way to do it is to let a library (<a href=\"https://crates.io/crates/lazy_static\" rel=\"noreferrer\"><code>lazy_static</code></a>) take care of the unsafe code.</p>\n\n<pre><code>#[macro_use]\nextern crate lazy_static;\n\nfn main() {\n    lazy_static!{\n        static ref OBJ: MyStruct = MyStruct {};\n    }\n    OBJ.doSomething();\n}\n</code></pre>\n"}], "owner": {"reputation": 983, "user_id": 1282993, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/84fc2b91a9b15b50df25f8c7b2be0bb2?s=128&d=identicon&r=PG", "display_name": "lyptt", "link": "https://stackoverflow.com/users/1282993/lyptt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3259, "favorite_count": 2, "accepted_answer_id": 50743093, "answer_count": 2, "score": 15, "last_activity_date": 1528385645, "creation_date": 1528372682, "last_edit_date": 1528378587, "question_id": 50740632, "link": "https://stackoverflow.com/questions/50740632/how-do-i-call-a-function-that-requires-a-static-lifetime-with-a-variable-create", "title": "How do I call a function that requires a &#39;static lifetime with a variable created in main?", "body": "<p>I've got a struct defined that has a function which defines a static lifetime:</p>\n\n<pre><code>impl MyStruct {\n    pub fn doSomething(&amp;'static self) {\n        // Some code goes here\n    }\n}\n</code></pre>\n\n<p>I'm consuming it from main like so:</p>\n\n<pre><code>fn main() {\n    let obj = MyStruct {};\n    obj.doSomething();\n}\n</code></pre>\n\n<p>It's intended for the <code>doSomething</code> call to block and execute for the lifetime of the application.</p>\n\n<p>I'm running into issues with the lifetime checks where it's stating that it may outlive the <code>main</code> function, which seems strange to me as once <code>main</code> is complete the application should exit.</p>\n\n<p>Is there a way to achieve this?</p>\n"}, {"tags": ["csv", "rust", "nom"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528549393, "post_id": 50740577, "comment_id": 88556008, "body": "Not an answer to your question, but why not just use <a href=\"https://crates.io/crates/csv\" rel=\"nofollow noreferrer\">an existing high-quality CSV parser</a>?"}, {"owner": {"reputation": 6165, "user_id": 1901658, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/95eee89c6704eb4d075c33821c61af72?s=128&d=identicon&r=PG", "display_name": "Fredrick Brennan", "link": "https://stackoverflow.com/users/1901658/fredrick-brennan"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528549509, "post_id": 50740577, "comment_id": 88556044, "body": "@Shepmaster Two reasons: (1) I want to rewrite the CSV example for Nom to one that&#39;s correct to these specifications, thereby helping the community, (2) I have another project where I&#39;m more interested in the PostgreSQL queries than the CSV files."}], "answers": [{"tags": [], "owner": {"reputation": 8789, "user_id": 539465, "user_type": "registered", "accept_rate": 81, "profile_image": "https://www.gravatar.com/avatar/2acba600ecfbe1cc2e7f3c94b686ac84?s=128&d=identicon&r=PG", "display_name": "Valentin Lorentz", "link": "https://stackoverflow.com/users/539465/valentin-lorentz"}, "is_accepted": true, "score": 2, "last_activity_date": 1528586615, "last_edit_date": 1528586615, "creation_date": 1528586247, "answer_id": 50779313, "question_id": 50740577, "link": "https://stackoverflow.com/questions/50740577/how-do-i-match-a-csv-style-quoted-string-in-nom/50779313#50779313", "title": "How do I match a CSV-style quoted string in nom?", "body": "<p>Here is one way of doing it:</p>\n\n<pre><code>use nom::types::CompleteStr;\n\nuse nom::*;\n\nnamed!(csv_style_string&lt;CompleteStr, String&gt;,\n    delimited!(\n        char!('\"'),\n        map!(\n            many0!(\n                alt!(\n                    // Eat a \" delimiter and  the \" that follows it\n                    tag!(\"\\\"\\\"\") =&gt; { |_| '\"' }\n\n                |    // Normal character\n                    none_of!(\"\\\"\")\n                )\n            ),\n             // Make a string from a vector of chars\n            |v| v.iter().collect::&lt;String&gt;()\n        ),\n        char!('\"')\n    )\n);\n\nfn main() {\n    println!(r#\"\"Alo\\\"ha\" = {:?}\"#, csv_style_string(CompleteStr(r#\"\"Alo\"\"ha\"\"#)));\n    println!(r#\"\"\" = {:?}\"#, csv_style_string(CompleteStr(r#\"\"\"\"#)));\n    println!(r#\"bad format: {:?}\"#, csv_style_string(CompleteStr(r#\"\"A\"\"\" e\"\"#)));\n}\n</code></pre>\n\n<p>(I wrote it in full nom, but a solution like yours, based on an external function instead of <code>map!()</code> each character, would work too, and may be more efficient.)</p>\n\n<p>The magic here, that would also solve your regexp issue, is to use CompleteStr. This basically tells <code>nom</code> that nothing will come after that input (otherwise, <code>nom</code> assumes you're doing a streaming parser, so more input may follow).</p>\n\n<p>This is needed because we need to know what to do with a <code>\"</code> if it is the last character fed to <code>nom</code>. Depending on the character that comes after it (another <code>\"</code>, a normal character, or EOF), we have to take a different decision -- hence the <code>Incomplete</code> result, meaning <code>nom</code> does not have enough input to make the decision. Telling <code>nom</code> that EOF comes next solves this indecision.</p>\n\n<p>Further reading on <code>Incomplete</code> on <code>nom</code>'s author's blog: <a href=\"http://unhandledexpression.com/general/2018/05/14/nom-4-0-faster-safer-simpler-parsers.html#dealing-with-incomplete-usage\" rel=\"nofollow noreferrer\">http://unhandledexpression.com/general/2018/05/14/nom-4-0-faster-safer-simpler-parsers.html#dealing-with-incomplete-usage</a></p>\n\n<hr>\n\n<p>You may note that this parser does not actually rejects the invalid input, but parses the beginning and returns the rest. If you use this parser as a subparser in another parser, the latter would then feed the remainder to the next subparser, which would crash as well (because it would expect a comma), causing the overall parser to fail.</p>\n\n<p>If you don't want that, you could make <code>csv_style_string</code> match <code>peek!(alt!(char!(',')|char!('\\n\")|eof!()))</code>.</p>\n"}], "owner": {"reputation": 6165, "user_id": 1901658, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/95eee89c6704eb4d075c33821c61af72?s=128&d=identicon&r=PG", "display_name": "Fredrick Brennan", "link": "https://stackoverflow.com/users/1901658/fredrick-brennan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 611, "favorite_count": 0, "accepted_answer_id": 50779313, "answer_count": 1, "score": 7, "last_activity_date": 1528586615, "creation_date": 1528372515, "last_edit_date": 1528549312, "question_id": 50740577, "link": "https://stackoverflow.com/questions/50740577/how-do-i-match-a-csv-style-quoted-string-in-nom", "title": "How do I match a CSV-style quoted string in nom?", "body": "<p>A CSV style quoted string, for the purposes of this question, is a string in which:</p>\n\n<ol>\n<li>The string starts and ends with exactly one <code>\"</code>.</li>\n<li>Two double quotes inside the string are collapsed to one double quote. <code>\"Alo\"\"ha\"</code>\u2192<code>Alo\"ha</code>.</li>\n<li>\"\" on its own is an empty string.</li>\n<li>Error inputs, such as <code>\"A\"\"\" e\"</code>, cannot be parsed. It's an <code>A\"</code>, followed by junk <code>e\"</code>.</li>\n</ol>\n\n<p>I've tried several things, none of which have worked fully.</p>\n\n<p>The closest I've gotten, thanks to some help from user pinkieval in #nom on the Mozilla IRC:</p>\n\n<pre><code>use std::error as stderror; /* Avoids needing nightly to compile */\n\nnamed!(csv_style_string&lt;&amp;str, String&gt;, map_res!(\n   terminated!(tag!(\"\\\"\"), not!(peek!(char!('\"')))),\n   csv_string_to_string\n));\n\nfn csv_string_to_string(s: &amp;str) -&gt; Result&lt;String, Box&lt;stderror::Error&gt;&gt; {\n   Ok(s.to_string().replace(\"\\\"\\\"\", \"\\\"\"))\n}\n</code></pre>\n\n<p>This does not catch the end of the string correctly.</p>\n\n<p>I've also attempted to use the <code>re_match!</code> macro with <code>r#\"\"([^\"]|\"\")*\"\"#</code>, but that always results in an <code>Err::Incomplete(1)</code>.</p>\n\n<p>I've determined that the <a href=\"https://github.com/GuillaumeGomez/csv-parser\" rel=\"nofollow noreferrer\">given CSV example for Nom 1.0</a> doesn't work for a quoted CSV string as I'm describing it, but I do know implementations differ.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "edited": false, "score": 0, "creation_date": 1528352675, "post_id": 50734058, "comment_id": 88476200, "body": "Could you please provide a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> (meaning: the complete folder structure and the content of the two <code>Cargo.toml</code>s and of the Rust source files)? That would help a lot finding the problem in your setup! Thanks!"}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1528358013, "post_id": 50734058, "comment_id": 88479184, "body": "You&#39;ve got two packages with the exact same name.  Does it still happen if you give them different names?"}, {"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "reply_to_user": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1528360734, "post_id": 50734058, "comment_id": 88480732, "body": "Sorry for that @DK. Updated the code now. The packages are infact different."}, {"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 0, "creation_date": 1528362070, "post_id": 50734058, "comment_id": 88481654, "body": "Are you working on a network drive/mount? (wild idea\u2122)"}, {"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528362778, "post_id": 50734058, "comment_id": 88482123, "body": "No. Its a normal Ubuntu desktop."}, {"owner": {"reputation": 961, "user_id": 1282369, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/LjubZ.jpg?s=128&g=1", "display_name": "tsatiz", "link": "https://stackoverflow.com/users/1282369/tsatiz"}, "edited": false, "score": 0, "creation_date": 1528365166, "post_id": 50734058, "comment_id": 88483906, "body": "What is the version of rust you are using?"}, {"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528365275, "post_id": 50734058, "comment_id": 88483989, "body": "Rust versino is 1.25"}], "answers": [{"comments": [{"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528368846, "post_id": 50739015, "comment_id": 88486247, "body": "No that isn&#39;t solving my problem."}, {"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528370017, "post_id": 50739015, "comment_id": 88486958, "body": "I am using <code>--release</code> with <code>cargo build</code> . Would that be affecting anyhow?"}, {"owner": {"reputation": 5453, "user_id": 827081, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/7893c5231bc7a9d4959d046e2604d939?s=128&d=identicon&r=PG", "display_name": "DanielM", "link": "https://stackoverflow.com/users/827081/danielm"}, "reply_to_user": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528381929, "post_id": 50739015, "comment_id": 88495404, "body": "No, even with <code>--release</code> it shouldn&#39;t rebuild everything, however unless you <i>are</i> readying your code for release, I&#39;d avoid that flag as it takes longer to build (optimising) and removes useful debug information."}, {"owner": {"reputation": 5453, "user_id": 827081, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/7893c5231bc7a9d4959d046e2604d939?s=128&d=identicon&r=PG", "display_name": "DanielM", "link": "https://stackoverflow.com/users/827081/danielm"}, "reply_to_user": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1528382070, "post_id": 50739015, "comment_id": 88495496, "body": "Is there anything else that could be affecting the <code>target</code> directory?"}], "tags": [], "owner": {"reputation": 5453, "user_id": 827081, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/7893c5231bc7a9d4959d046e2604d939?s=128&d=identicon&r=PG", "display_name": "DanielM", "link": "https://stackoverflow.com/users/827081/danielm"}, "is_accepted": false, "score": 0, "last_activity_date": 1528367505, "creation_date": 1528367505, "answer_id": 50739015, "question_id": 50734058, "link": "https://stackoverflow.com/questions/50734058/how-to-stop-recompiling-an-extern-crate-in-rust/50739015#50739015", "title": "How to stop recompiling an extern crate in Rust", "body": "<p>Assuming you're using it, there was <a href=\"https://github.com/rust-lang-nursery/rls/issues/803\" rel=\"nofollow noreferrer\">an issue with RLS that was causing unnecessary rebuilds.</a></p>\n\n<p>This issue has been fixed, to get the latest version of RLS, use </p>\n\n<pre><code>$ rustup update\n</code></pre>\n"}], "owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 179, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1528367505, "creation_date": 1528351926, "last_edit_date": 1528360767, "question_id": 50734058, "link": "https://stackoverflow.com/questions/50734058/how-to-stop-recompiling-an-extern-crate-in-rust", "title": "How to stop recompiling an extern crate in Rust", "body": "<p>I have a local dependency on some SDK. I make use of </p>\n\n<pre><code>extern crate local_sdk; \nuse local_sdk::foo;\n</code></pre>\n\n<p>to use the <code>local_sdk</code> in my implementation. </p>\n\n<p>I am making use of cargo to build. While building, the logs print the following at some stage -</p>\n\n<blockquote>\n  <p>Compiling local_sdk v0.1.0 (file:///project/project-core/sdk/rust)</p>\n</blockquote>\n\n<p>This happens even though I have already compiled the <code>local_sdk</code> earlier.\nHow do I prevent recompiling the <code>local_sdk</code> ? It consumes some significant time.</p>\n\n<p>Contents of the my <code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"service\"\nversion = \"0.1.0\"\nauthors = [\"Rajeev\"]\n\n[dependencies]\nlocal_sdk = { path = \"../../sdk/rust\" }\n</code></pre>\n\n<p>The <code>local_sdk</code> has the following <code>Cargo.toml</code>: </p>\n\n<pre><code>[package]\nname = \"local_sdk\"\nversion = \"0.1.0\"\nauthors = [\"Rajeev\"]\n\n[dependencies]\nhex = \"0.3\"\nprotobuf=\"2.0\"\nrand = \"0.4.2\"\nzmq = { git = \"https://github.com/erickt/rust-zmq\", branch = \"release/v0.8\" }\nuuid = { version = \"0.5\", features = [\"v4\"] }\nlog = \"0.3\"\nlibc = \"0.2\"\nctrlc = { version = \"3.0\", features = [\"termination\"] }\n\n[dev-dependencies]\nenv_logger = \"0.3\"\n\n[build-dependencies]\ncc = \"1.0\"\nglob = \"0.2\"\n</code></pre>\n"}, {"tags": ["generics", "rust", "memory-alignment"], "comments": [{"owner": {"reputation": 1985, "user_id": 2080712, "user_type": "registered", "accept_rate": 93, "profile_image": "https://i.stack.imgur.com/NyaqQ.jpg?s=128&g=1", "display_name": "Bernardo Meurer", "link": "https://stackoverflow.com/users/2080712/bernardo-meurer"}, "reply_to_user": {"reputation": 11157, "user_id": 2777074, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XukTI.png?s=128&g=1", "display_name": "samcarter_is_at_topanswers.xyz", "link": "https://stackoverflow.com/users/2777074/samcarter-is-at-topanswers-xyz"}, "edited": false, "score": 0, "creation_date": 1561242308, "post_id": 50732290, "comment_id": 100000465, "body": "@samcarter I am so confused, why are you commenting here on my beamer question? :P"}, {"owner": {"reputation": 1985, "user_id": 2080712, "user_type": "registered", "accept_rate": 93, "profile_image": "https://i.stack.imgur.com/NyaqQ.jpg?s=128&g=1", "display_name": "Bernardo Meurer", "link": "https://stackoverflow.com/users/2080712/bernardo-meurer"}, "reply_to_user": {"reputation": 11157, "user_id": 2777074, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/XukTI.png?s=128&g=1", "display_name": "samcarter_is_at_topanswers.xyz", "link": "https://stackoverflow.com/users/2777074/samcarter-is-at-topanswers-xyz"}, "edited": false, "score": 0, "creation_date": 1561242396, "post_id": 50732290, "comment_id": 100000483, "body": "Ah, I appreciate it! I think that&#39;ll work! Thanks @samcarter!"}], "answers": [{"tags": [], "owner": {"reputation": 96616, "user_id": 377270, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ce60a64d7650842955b526c3c4e85d0d?s=128&d=identicon&r=PG", "display_name": "sarnold", "link": "https://stackoverflow.com/users/377270/sarnold"}, "is_accepted": true, "score": 1, "last_activity_date": 1528345226, "creation_date": 1528345226, "answer_id": 50732904, "question_id": 50732290, "link": "https://stackoverflow.com/questions/50732290/how-to-statically-enforce-that-a-generic-type-has-a-particular-representation/50732904#50732904", "title": "How to statically enforce that a generic type has a particular representation?", "body": "<p>Perhaps you could make a trait, <code>ReprC</code>, and use it as a trait bound for your methods. It's not enforcement of what really matters but it may be better than documentation.</p>\n"}], "owner": {"reputation": 1985, "user_id": 2080712, "user_type": "registered", "accept_rate": 93, "profile_image": "https://i.stack.imgur.com/NyaqQ.jpg?s=128&g=1", "display_name": "Bernardo Meurer", "link": "https://stackoverflow.com/users/2080712/bernardo-meurer"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 134, "favorite_count": 0, "accepted_answer_id": 50732904, "answer_count": 1, "score": 1, "last_activity_date": 1528345226, "creation_date": 1528339931, "last_edit_date": 1528340361, "question_id": 50732290, "link": "https://stackoverflow.com/questions/50732290/how-to-statically-enforce-that-a-generic-type-has-a-particular-representation", "title": "How to statically enforce that a generic type has a particular representation?", "body": "<p>I have a generic <code>struct Foo&lt;T&gt;</code> that I want to use for FFI. For example, the following could be used for a memory mapping implementation.</p>\n\n<pre><code>use std::marker::PhantomData;\nuse memmap::MmapMut;\n\n#[repr(C)]\nstruct Shared&lt;T&gt; {\n    foo: MmapMut,\n    _marker: PhantomData&lt;T&gt;,\n}\n</code></pre>\n\n<p>I want this to be FFI safe, so I'd like to enforce that <code>T</code> <em>also</em> has to be <code>repr(C)</code>. The issue is that representations aren't traits in Rust, and therefore I don't see a straightforward way of enforcing this statically, something like <code>struct Foo&lt;T: ReprC&gt;</code> would be nice, but as far as I can tell does not exist. Could a macro be used?</p>\n"}, {"tags": ["image", "rust", "rust-piston"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 3, "last_activity_date": 1528340978, "creation_date": 1528340978, "answer_id": 50732394, "question_id": 50731636, "link": "https://stackoverflow.com/questions/50731636/how-do-i-encode-a-rust-piston-image-and-get-the-result-in-memory/50732394#50732394", "title": "How do I encode a Rust Piston image and get the result in memory?", "body": "<blockquote>\n<pre><code>fn getImage() -&gt; image::DynamicImage \n</code></pre>\n</blockquote>\n\n<p>You have a <code>DynamicImage</code>. </p>\n\n<blockquote>\n  <p>image only seems to provide a method to write to a filename</p>\n</blockquote>\n\n<p>I assume you mean <a href=\"https://docs.rs/image/0.19.0/image/enum.DynamicImage.html#method.save\" rel=\"nofollow noreferrer\"><code>DynamicImage::save</code></a>.</p>\n\n<p>The method immediately before <code>save</code> is <a href=\"https://docs.rs/image/0.19.0/image/enum.DynamicImage.html#method.write_to\" rel=\"nofollow noreferrer\"><code>write_to</code></a>:</p>\n\n<pre><code>pub fn write_to&lt;W: Write, F: Into&lt;ImageOutputFormat&gt;&gt;(\n    &amp;self, \n    w: &amp;mut W, \n    format: F\n) -&gt; ImageResult&lt;()&gt;\n</code></pre>\n\n<p>This accepts any generic writer:</p>\n\n<pre><code>let mut buf = Vec::new();\n\nget_image()\n    .write_to(&amp;mut buf, image::ImageOutputFormat::PNG)\n    .expect(\"Unable to write\");\n</code></pre>\n\n<p>There's no need for a <code>Cursor</code>.</p>\n\n<hr>\n\n<blockquote>\n  <p>How do I encode a Piston <code>GenericImage</code> to a format like PNG?</p>\n</blockquote>\n\n<p>I have no idea the best way to do this. I'd probably copy the generic image into a <code>DynamicImage</code> and then follow the above instructions.</p>\n"}, {"comments": [{"owner": {"reputation": 5005, "user_id": 573149, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/Wn0FW.jpg?s=128&g=1", "display_name": "Andrew Mackenzie", "link": "https://stackoverflow.com/users/573149/andrew-mackenzie"}, "edited": false, "score": 1, "creation_date": 1546878063, "post_id": 53137059, "comment_id": 94989444, "body": "Add the <code>use std::io::Write;</code> to get the Write trait in scope and allow the <code>by_ref()</code> to work?"}], "tags": [], "owner": {"reputation": 7106, "user_id": 104261, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/e5ae0d2b7c7ecaf15f87c6e7c0cf2210?s=128&d=identicon&r=PG", "display_name": "Taras Alenin", "link": "https://stackoverflow.com/users/104261/taras-alenin"}, "is_accepted": false, "score": 2, "last_activity_date": 1541295932, "creation_date": 1541295932, "answer_id": 53137059, "question_id": 50731636, "link": "https://stackoverflow.com/questions/50731636/how-do-i-encode-a-rust-piston-image-and-get-the-result-in-memory/53137059#53137059", "title": "How do I encode a Rust Piston image and get the result in memory?", "body": "<p>I've adapted OP's code based on the <code>image</code> crate docs. It looks possible to make the original code to work. There is no need for <code>Cursor</code> but one needs to create a \"by reference\" adaptor for the instance of <code>Write</code> implemented by <code>Vec</code>. </p>\n\n<pre><code>// This code have not been tested or even compiled\nlet v = {\n    let generated = get_image();\n    let mut encoded_image = Vec::new();\n    let (width, height) = generated.dimensions();\n    {\n        image::png::PNGEncoder::new(encoded_image.by_ref())\n            .encode(\n                generated.raw_pixels(), \n                width, \n                height,\n                generated.color()\n            ).expected(\"error encoding pixels as PNG\");\n    }\n    encoded_image\n};\n</code></pre>\n\n<p>Here is the code I actually used in my project. I get a reference to the raw pixels passed in as an <code>&amp;[u8]</code> slice. Each pixel represents an 8 bit grayscale value. Here is a function that encodes the pixels into an in memory PNG image.</p>\n\n<pre><code>pub fn create_png(pixels: &amp;[u8], dimensions: (usize, usize)) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {\n    let mut png_buffer = Vec::new();\n    PNGEncoder::new(png_buffer.by_ref())\n        .encode(\n            pixels,\n            dimensions.0 as u32,\n            dimensions.1 as u32,\n            ColorType::Gray(8),\n        ).expect(\"error encoding pixels as PNG\");\n\n    Ok(png_buffer)\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 32230, "user_id": 119271, "user_type": "registered", "accept_rate": 78, "profile_image": "https://www.gravatar.com/avatar/a6919c8388bc3d388da7806ab415ef54?s=128&d=identicon&r=PG", "display_name": "Douglas", "link": "https://stackoverflow.com/users/119271/douglas"}, "is_accepted": false, "score": 0, "last_activity_date": 1585147262, "last_edit_date": 1585147262, "creation_date": 1585146144, "answer_id": 60850787, "question_id": 50731636, "link": "https://stackoverflow.com/questions/50731636/how-do-i-encode-a-rust-piston-image-and-get-the-result-in-memory/60850787#60850787", "title": "How do I encode a Rust Piston image and get the result in memory?", "body": "<p>Rather than returning a <code>DynamicImage</code> from <code>get_image</code>, it would be easier to return a specific image type, for example a colour RGBA image:</p>\n\n<pre><code>use image::RgbaImage;\n\nfn get_image() -&gt; RgbaImage {\n    RgbaImage::new(512, 512)\n}\n</code></pre>\n\n<p>The <code>RgbaImage</code> implements <code>Deref&lt;[u8]&gt;</code>, which means that the image can be directly dereferenced as a slice of bytes, so <code>&amp;img</code> can be used as the first argument to <code>encode</code>. The height and width are easy, just access <code>img.height()</code> and <code>img.width()</code>. The final argument to <code>encode</code> is the colour type, which is more fiddly as it is stored as an associated constant of the <code>Pixel</code> type parameter on the <code>ImageBuffer</code>. From the generic type it can be accessed as <code>P::COLOR_TYPE</code>, so instead of making <code>encode_png</code> specific to one type of image, I've written it as accepting any <code>ImageBuffer</code> type.</p>\n\n<p>The full example is then:</p>\n\n<pre><code>use std::error::Error;\nuse std::ops::Deref;\nuse image::{png::PNGEncoder, ImageBuffer, ImageError, Pixel, RgbaImage, Rgba};\n\nfn encode_png&lt;P, Container&gt;(img: &amp;ImageBuffer&lt;P, Container&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, ImageError&gt;\nwhere\n    P: Pixel&lt;Subpixel = u8&gt; + 'static,\n    Container: Deref&lt;Target = [P::Subpixel]&gt;,\n{\n    let mut buf = Vec::new();\n    let encoder = PNGEncoder::new(&amp;mut buf);\n    encoder.encode(img, img.width(), img.height(), P::COLOR_TYPE)?;\n    Ok(buf)\n}\n\nfn get_image() -&gt; RgbaImage {\n    let mut img = RgbaImage::new(32, 32);\n\n    // Draw something to show in the final image\n    for i in 0..32 {\n        img.put_pixel(i, i, Rgba([255, 0, 0, 255]));\n    }\n    img\n}\n\nfn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {\n    let img = get_image();\n    let buf = encode_png(&amp;img)?;\n\n    // write out the image using the base64 crate as a data\n    // URL so that it can be copy-pasted into a web browser\n    println!(\"data:image/png;base64,{}\", base64::encode(&amp;buf));\n    Ok(())\n}\n</code></pre>\n\n<p>Playground: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e2611c5ef248667bf984a8dd3cedfec8\" rel=\"nofollow noreferrer\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e2611c5ef248667bf984a8dd3cedfec8</a></p>\n"}], "owner": {"reputation": 1, "user_id": 1114, "user_type": "registered", "accept_rate": 69, "profile_image": "https://i.stack.imgur.com/FFE8V.gif?s=128&g=1", "display_name": "Jeremy", "link": "https://stackoverflow.com/users/1114/jeremy"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1321, "favorite_count": 0, "accepted_answer_id": 50732394, "answer_count": 3, "score": 5, "last_activity_date": 1585147262, "creation_date": 1528333790, "last_edit_date": 1531249454, "question_id": 50731636, "link": "https://stackoverflow.com/questions/50731636/how-do-i-encode-a-rust-piston-image-and-get-the-result-in-memory", "title": "How do I encode a Rust Piston image and get the result in memory?", "body": "<p>I am using <a href=\"https://crates.io/crates/image\" rel=\"noreferrer\">the Piston <code>image</code> package</a> to generate images.</p>\n\n<pre><code>fn get_image() -&gt; image::DynamicImage {\n    image::DynamicImage::ImageRgba8(image::ImageBuffer::new(512, 512))\n}\n</code></pre>\n\n<p>I have a <a href=\"https://crates.io/crates/hyper\" rel=\"noreferrer\"><code>hyper</code> web server</a>, from which I would like to serve dynamically-generated images.</p>\n\n<p>Based on the answer to <em><a href=\"https://stackoverflow.com/questions/41069865/how-to-create-an-in-memory-object-that-can-be-used-as-a-reader-or-writer-in-rust\">How to create an in-memory object that can be used as a Reader or Writer in Rust?</a></em>, I thought I might be able to use a <code>Cursor&lt;Vec&lt;u8&gt;&gt;</code> as the destination. However, <code>image</code> only seems to provide a method to write to a filename, not a <code>Writer</code> like my cursor.</p>\n\n<p>After looking through <code>image</code>'s documentation, I hoped there might be some way to use <a href=\"https://docs.rs/image/0.19.0/image/png/struct.PNGEncoder.html\" rel=\"noreferrer\">the <code>image::png::PNGEncoder</code> struct</a> directly. It provides a public method <code>encode(self, data: &amp;[u8], width: u32, height: u32, color: ColorType) -&gt; Result&lt;()&gt;</code>. However, I wasn't sure what the <code>data</code> argument is supposed to be, and I couldn't find any public declarations of the <code>ColorType</code>s used by <code>ImageBuffer</code>.</p>\n\n<pre><code>(&amp;Get, \"/image.png\") =&gt; {\n    let v = {\n        let generated = get_image();\n        let mut encoded_image = Cursor::new(Vec::new());\n        let (width, heigth) = generated.dimensions();\n        {\n            let encoder = image::png::PNGEncoder::new(&amp;encoded_image);\n            encoder.encode(unimplemented!(\"what goes here?\"));\n        }\n        encoded_image.get_mut()\n    };\n\n    Box::new(futures::future::ok(\n        Response::new()\n            .with_header(ContentLength(v.len() as u64))\n            .with_body(v.clone()),\n    ))\n}\n</code></pre>\n\n<p>How do I encode <a href=\"https://docs.rs/image/0.19.0/image/trait.GenericImage.html\" rel=\"noreferrer\">a Piston <code>GenericImage</code></a> to a format like PNG and get the result in memory?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528340472, "post_id": 50731453, "comment_id": 88472524, "body": "What the heck are you even trying to do? Why do you have arbitrary rlibs lying around that aren&#39;t part of an existing crate?"}, {"owner": {"reputation": 644, "user_id": 7333037, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ab3a4873895bfc709cb4c1725bafc87a?s=128&d=identicon&r=PG&f=1", "display_name": "Laszlo", "link": "https://stackoverflow.com/users/7333037/laszlo"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528386297, "post_id": 50731453, "comment_id": 88498358, "body": "I want to distribute self-contained .rlibs without having to publish the source code."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528386485, "post_id": 50731453, "comment_id": 88498495, "body": "I thought so. You are fighting an uphill battle: <a href=\"https://stackoverflow.com/q/27999559/155423\">Can libraries be distributed as a binary, so the end user cannot see the source code?</a>"}, {"owner": {"reputation": 644, "user_id": 7333037, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ab3a4873895bfc709cb4c1725bafc87a?s=128&d=identicon&r=PG&f=1", "display_name": "Laszlo", "link": "https://stackoverflow.com/users/7333037/laszlo"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1528387521, "post_id": 50731453, "comment_id": 88499094, "body": "Ah, thanks. I get your point after reading the related answer. I&#39;ll experiment further with the &#39;Rust API exposing trait objects only&#39; variant."}], "answers": [{"tags": [], "owner": {"reputation": 1, "user_id": 14363879, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-srlwfDuN1gQ/AAAAAAAAAAI/AAAAAAAAAoA/c5KLLSA3E6E/photo.jpg?sz=128", "display_name": "Vetri Box", "link": "https://stackoverflow.com/users/14363879/vetri-box"}, "is_accepted": false, "score": 0, "last_activity_date": 1601415176, "creation_date": 1601415176, "answer_id": 64127934, "question_id": 50731453, "link": "https://stackoverflow.com/questions/50731453/how-to-statically-link-to-an-existing-rlib/64127934#64127934", "title": "How to statically link to an existing rlib?", "body": "<p>As far as I know, you gotta manually compile with rustc</p>\n<pre><code>rustc main.rs \u2014-extern custom1=path/to/libcustom1.rlib \u2014-extern custom2=path/to/libcustom2.rlib\n</code></pre>\n<p>With every library in the form of .rlib you add \u2018\u2014-extern\u2019 for every single one of \u2018em.</p>\n<p>Refer to <a href=\"https://doc.rust-lang.org/stable/rust-by-example/crates/lib.html\" rel=\"nofollow noreferrer\">this</a></p>\n<p>And to <a href=\"https://doc.rust-lang.org/stable/rust-by-example/crates/link.html\" rel=\"nofollow noreferrer\">this</a></p>\n<p>More than that, the man page for rustc will give you extra leg on more complex things like FFI</p>\n"}], "owner": {"reputation": 644, "user_id": 7333037, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ab3a4873895bfc709cb4c1725bafc87a?s=128&d=identicon&r=PG&f=1", "display_name": "Laszlo", "link": "https://stackoverflow.com/users/7333037/laszlo"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 1059, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1601415176, "creation_date": 1528331844, "last_edit_date": 1528340414, "question_id": 50731453, "link": "https://stackoverflow.com/questions/50731453/how-to-statically-link-to-an-existing-rlib", "title": "How to statically link to an existing rlib?", "body": "<p>I have two independently created <code>libsomelibrary.rlib</code> files at <code>/path/to/deps/debug/</code> and <code>/path/to/deps/release/</code> directories. I also have a project in the <code>/path/to/myproject/</code> directory which needs to link statically to <code>libsomelibrary.rlib</code>. </p>\n\n<p>How can I specify in Cargo.toml (or elsewhere) the references to those .rlibs?  </p>\n\n<p>I have tried to add <code>somelibrary</code> under <code>[dependencies]</code> in Cargo.toml. using a build.rs to specify the search path and file name:</p>\n\n<pre><code>println!(\"cargo:rustc-link-lib=static=somelib\");\nprintln!(\"cargo:rustc-link-search=/path/to/deps/debug/\");\n</code></pre>\n\n<p>then in Cargo.toml:</p>\n\n<pre><code>[package]\nbuild = \"build.rs\"\nlinks = \"somelibrary\"\n</code></pre>\n\n<p>but I still get linkage errors.</p>\n"}, {"tags": ["rust", "monads", "option", "maybe"], "answers": [{"tags": [], "owner": {"reputation": 32558, "user_id": 101090, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/066290971688c0a44cc4159a9f210dcf?s=128&d=identicon&r=PG", "display_name": "Jorge Israel Pe&#241;a", "link": "https://stackoverflow.com/users/101090/jorge-israel-pe%c3%b1a"}, "is_accepted": false, "score": 8, "last_activity_date": 1528334150, "last_edit_date": 1528334150, "creation_date": 1528332300, "answer_id": 50731505, "question_id": 50731439, "link": "https://stackoverflow.com/questions/50731439/whats-the-idiomatic-way-to-handle-multiple-optiont-in-rust/50731505#50731505", "title": "What&#39;s the idiomatic way to handle multiple `Option&lt;T&gt;` in Rust?", "body": "\n\n<p>It seems like you want <a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.and_then\" rel=\"noreferrer\"><code>Option::and_then</code></a>:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub fn and_then&lt;U, F&gt;(self, f: F) -&gt; Option&lt;U&gt; \nwhere\n    F: FnOnce(T) -&gt; Option&lt;U&gt;\n</code></pre>\n\n<p>Examples:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn sq(x: u32) -&gt; Option&lt;u32&gt; { Some(x * x) }\nfn nope(_: u32) -&gt; Option&lt;u32&gt; { None }\n\nassert_eq!(Some(2).and_then(sq).and_then(sq), Some(16));\nassert_eq!(Some(2).and_then(sq).and_then(nope), None);\nassert_eq!(Some(2).and_then(nope).and_then(sq), None);\nassert_eq!(None.and_then(sq).and_then(sq), None);\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 29444, "user_id": 3072788, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/220a45c2fcff7e7358d144551b116205?s=128&d=identicon&r=PG&f=1", "display_name": "Alec", "link": "https://stackoverflow.com/users/3072788/alec"}, "edited": false, "score": 1, "creation_date": 1528334349, "post_id": 50731545, "comment_id": 88471197, "body": "Now that <code>?</code> has been stabilized, I think <code>try!</code> is on its way out. <code>let a = chain(xs.next(), |x| FACES.find(x), Face::from_usize)?;</code> looks a bit better."}, {"owner": {"reputation": 100892, "user_id": 745903, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/50933f6638836741e620669b3940410e?s=128&d=identicon&r=PG", "display_name": "leftaroundabout", "link": "https://stackoverflow.com/users/745903/leftaroundabout"}, "reply_to_user": {"reputation": 29444, "user_id": 3072788, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/220a45c2fcff7e7358d144551b116205?s=128&d=identicon&r=PG&f=1", "display_name": "Alec", "link": "https://stackoverflow.com/users/3072788/alec"}, "edited": false, "score": 0, "creation_date": 1528358727, "post_id": 50731545, "comment_id": 88479538, "body": "Interesting. Is that basically syntactic sugar for the old <code>try!</code>?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1528380623, "post_id": 50731545, "comment_id": 88494351, "body": "@leftaroundabout it&#39;s better, actually, as it&#39;s powered by the <a href=\"https://doc.rust-lang.org/std/ops/trait.Try.html\" rel=\"nofollow noreferrer\"><code>Try</code> trait</a> so it&#39;s more flexible. For example, it works for <code>Option</code> and when it&#39;s stabilized it will be usable for user types."}], "tags": [], "owner": {"reputation": 100892, "user_id": 745903, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/50933f6638836741e620669b3940410e?s=128&d=identicon&r=PG", "display_name": "leftaroundabout", "link": "https://stackoverflow.com/users/745903/leftaroundabout"}, "is_accepted": false, "score": 0, "last_activity_date": 1528334187, "last_edit_date": 1528334187, "creation_date": 1528332794, "answer_id": 50731545, "question_id": 50731439, "link": "https://stackoverflow.com/questions/50731439/whats-the-idiomatic-way-to-handle-multiple-optiont-in-rust/50731545#50731545", "title": "What&#39;s the idiomatic way to handle multiple `Option&lt;T&gt;` in Rust?", "body": "<p><code>Maybe</code>-monadic chaining in Rust's <code>Result</code> is accomplished by <a href=\"https://doc.rust-lang.org/1.17.0/book/error-handling.html#the-try-macro\" rel=\"nofollow noreferrer\">the <code>try!</code> macro</a>. Should look something like</p>\n\n<pre><code>fn from_str(x: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n    let mut xs = x.chars();\n    let a = try!(chain(xs.next(), |x| FACES.find(x), Face::from_usize));\n    let b = try!(chain(xs.next(), |x| SUITS.find(x), Suit::from_usize));\n    Ok(Card::new(face, suit))\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 15, "last_activity_date": 1528380402, "last_edit_date": 1528380402, "creation_date": 1528338969, "answer_id": 50732199, "question_id": 50731439, "link": "https://stackoverflow.com/questions/50731439/whats-the-idiomatic-way-to-handle-multiple-optiont-in-rust/50732199#50732199", "title": "What&#39;s the idiomatic way to handle multiple `Option&lt;T&gt;` in Rust?", "body": "<p>As mentioned, <a href=\"https://doc.rust-lang.org/std/option/enum.Option.html\" rel=\"noreferrer\"><code>Option</code></a> and <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html\" rel=\"noreferrer\"><code>Result</code></a> have <em>tons</em> of utility methods on them. Additionally, the try operator (<code>?</code>) can also be used for the extremely common case of \"return the failure or unwrap the result\"</p>\n\n<p>I'd implement <code>FromStr</code> for <code>Face</code> and <code>Suit</code>. Your code would then look like:</p>\n\n<pre><code>impl FromStr for Card {\n    type Err = ();\n\n    fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n        let face = s[0..1].parse()?;\n        let suit = s[1..2].parse()?;\n\n        Ok(Card { face, suit })\n    }\n}\n</code></pre>\n\n<p>If you didn't / couldn't, you can use the existing methods on <code>Option</code>. You didn't define <code>Foo::from_usize</code>, so I assume to returns <code>Foo</code>, so it would use <code>map</code>:</p>\n\n<pre><code>fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n    let mut c = s.chars();\n\n    let face = c\n        .next()\n        .and_then(|c| FACES.find(c))\n        .map(Face::from_usize)\n        .ok_or(())?;\n    let suit = c\n        .next()\n        .and_then(|c| SUITS.find(c))\n        .map(Suit::from_usize)\n        .ok_or(())?;\n\n    Ok(Card { face, suit })\n}\n</code></pre>\n\n<ul>\n<li><a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.and_then\" rel=\"noreferrer\"><code>Option::and_then</code></a></li>\n<li><a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.map\" rel=\"noreferrer\"><code>Option::map</code></a></li>\n<li><a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.ok_or\" rel=\"noreferrer\"><code>Option::ok_or</code></a></li>\n</ul>\n\n<p>Both of these paths allow you to have <em>useful</em> errors, such as an enum that lets you know if the suit / face was missing / invalid. An error type of <code>()</code> is useless to consumers. </p>\n\n<p>You could also define <code>Suit::from_char</code> and <code>Face::from_char</code> and not leak the implementation of the array out.</p>\n\n<p>Putting it all together:</p>\n\n<pre><code>impl Suit {\n    fn from_char(c: char) -&gt; Option&lt;Self&gt; {\n        use Suit::*;\n\n        [('c', C), ('d', D), ('h', H), ('s', S)]\n            .iter()\n            .cloned()\n            .find(|&amp;(cc, _)| cc == c)\n            .map(|(_, s)| s)\n    }\n}\n\nenum Error {\n    MissingFace,\n    MissingSuit,\n    InvalidFace,\n    InvalidSuit,\n}\n\nimpl FromStr for Card {\n    type Err = Error;\n\n    fn from_str(x: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n        use Error::*;\n\n        let mut xs = x.chars();\n\n        let face = xs.next().ok_or(MissingFace)?;\n        let face = Face::from_char(face).ok_or(InvalidFace)?;\n        let suit = xs.next().ok_or(MissingSuit)?;\n        let suit = Suit::from_char(suit).ok_or(InvalidSuit)?;\n\n        Ok(Card { face, suit })\n    }\n}\n</code></pre>\n\n<hr>\n\n<pre><code>fn join&lt;T&gt;(x: Option&lt;Option&lt;T&gt;&gt;) -&gt; Option&lt;T&gt;\n</code></pre>\n\n<p>This is <code>x.and_then(|y| y)</code></p>\n\n<pre><code>fn bind&lt;A, B, F&gt;(x: Option&lt;A&gt;, f: F) -&gt; Option&lt;B&gt;\nwhere\n    F: FnOnce(A) -&gt; Option&lt;B&gt;,\n</code></pre>\n\n<p>This is <code>x.and_then(f)</code></p>\n\n<pre><code>fn chain&lt;A, B, C, F, G&gt;(x: Option&lt;A&gt;, f: F, g: G) -&gt; Option&lt;C&gt;\nwhere\n    F: FnOnce(A) -&gt; Option&lt;B&gt;,\n    G: FnOnce(B) -&gt; Option&lt;C&gt;,\n</code></pre>\n\n<p>This is <code>x.and_then(f).and_then(g)</code></p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/28566531/155423\">How to implement some convenient methods (e.g., flat_map, flatten) on Option?</a></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 5, "last_activity_date": 1528355222, "creation_date": 1528355222, "answer_id": 50734911, "question_id": 50731439, "link": "https://stackoverflow.com/questions/50731439/whats-the-idiomatic-way-to-handle-multiple-optiont-in-rust/50734911#50734911", "title": "What&#39;s the idiomatic way to handle multiple `Option&lt;T&gt;` in Rust?", "body": "<p>In addition to the other answers, you can also take a look at the monadic expression crates like <a href=\"https://crates.io/crates/mdo\" rel=\"noreferrer\">mdo</a> or <a href=\"https://crates.io/crates/map_for\" rel=\"noreferrer\">map_for</a>. For example with <code>map_for</code>:</p>\n\n<pre><code>fn from_str(x: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n    let mut xs = x.chars();\n    map_for!{\n        ax &lt;- xs.next();\n        f  &lt;- FACES.find(ax);\n        a  &lt;- Face::from_usize(f);\n        bx &lt;- xs.next();\n        s  &lt;- SUITS.find(bx);\n        b  &lt;- Suit::from_usize (s);\n        =&gt; Card::new(a, b) }\n    .ok_or(Err(()))\n}\n</code></pre>\n\n<p>Full disclosure: I am the author of the <code>map_for</code> crate.</p>\n"}], "owner": {"reputation": 634, "user_id": 5093690, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/a3c8f6b503d9ea35c843eda8d891479f?s=128&d=identicon&r=PG&f=1", "display_name": "qwe", "link": "https://stackoverflow.com/users/5093690/qwe"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3298, "favorite_count": 0, "accepted_answer_id": 50732199, "answer_count": 4, "score": 10, "last_activity_date": 1528463943, "creation_date": 1528331664, "last_edit_date": 1528380312, "question_id": 50731439, "link": "https://stackoverflow.com/questions/50731439/whats-the-idiomatic-way-to-handle-multiple-optiont-in-rust", "title": "What&#39;s the idiomatic way to handle multiple `Option&lt;T&gt;` in Rust?", "body": "<p>Since I'm fairly new to Rust, I need guidance on how error handling is done idiomatically. I find the error-handling boilerplate really annoying.</p>\n\n<p>I'm stuck with multiple <code>Option&lt;T&gt;</code>s. It's too verbose to handle each <code>None</code> case manually.</p>\n\n<p>In Haskell, for example, you can chain optional value (<code>Maybe</code>) operations with a variety of operators: <code>fmap</code>, <code>&lt;*&gt;</code>, <code>&gt;&gt;=</code>, etc.:</p>\n\n<pre class=\"lang-hs prettyprint-override\"><code>f x = x * x\ng x = x ++ x\nmain = print $ g &lt;$&gt; show &lt;$&gt; f &lt;$&gt; Just 2\n</code></pre>\n\n<p>The same looks impossible in Rust. I'm trying to parse a two-character card string into a struct <code>Card</code>:</p>\n\n<pre><code>const FACES: &amp;'static str = \"23456789TJQKA\";\nconst SUITS: &amp;'static str = \"CDHS\";\nenum Face { /* ... */ }\nenum Suit { C, D, H, S }\nstruct Card {\n    face: Face,\n    suit: Suit\n}\nimpl FromStr for Card {\n    type Err = ();\n    fn from_str(x: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {\n        let mut xs = x.chars();\n        let a = chain(xs.next(), |x| FACES.find(x), Face::from_usize);\n        let b = chain(xs.next(), |x| SUITS.find(x), Suit::from_usize);\n        if let (Some(face), Some(suit)) = (a, b) {\n            Ok(Card::new(face, suit))\n        } else {\n            Err(())\n        }\n    }\n}\n</code></pre>\n\n<p>This code would look like this in Haskell:</p>\n\n<pre class=\"lang-hs prettyprint-override\"><code>import Data.List (elemIndex)\nx = Just 'C'\nsuits = \"CDHS\"\ndata Suit = C | D | H | S deriving Show\nfromInt 0 = C\nfind = flip elemIndex\nmain = print $ x &gt;&gt;= find suits &gt;&gt;= return . fromInt\n</code></pre>\n\n<p>Thanks to the chaining via <code>&gt;&gt;=</code> Haskell makes it possible (and easy!) to manipulate the inner value of a monad. In order to achieve something close to that I had to write the <code>chain</code> function, which seems strongly unidiomatic:</p>\n\n<pre><code>fn join&lt;T&gt;(x: Option&lt;Option&lt;T&gt;&gt;) -&gt; Option&lt;T&gt; {\n    if let Some(y) = x {\n        y\n    } else {\n        None\n    }\n}\n\nfn bind&lt;A, B, F&gt;(x: Option&lt;A&gt;, f: F) -&gt; Option&lt;B&gt;\nwhere\n    F: FnOnce(A) -&gt; Option&lt;B&gt;,\n{\n    join(x.map(f))\n}\n\nfn chain&lt;A, B, C, F, G&gt;(x: Option&lt;A&gt;, f: F, g: G) -&gt; Option&lt;C&gt;\nwhere\n    F: FnOnce(A) -&gt; Option&lt;B&gt;,\n    G: FnOnce(B) -&gt; Option&lt;C&gt;,\n{\n    bind(bind(x, f), g)\n}\n</code></pre>\n"}]