[{"tags": ["rust"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548289548, "post_id": 54337061, "comment_id": 95492417, "body": "See <a href=\"https://stackoverflow.com/a/53804449/493729\">In what scenarios are APIs that don&#39;t borrow preferred?</a>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548291103, "post_id": 54337061, "comment_id": 95492698, "body": "And <a href=\"https://stackoverflow.com/a/50028001/493729\">When should I use a reference instead of transferring ownership?</a>"}], "answers": [{"tags": [], "owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "is_accepted": false, "score": 5, "last_activity_date": 1548287434, "creation_date": 1548287434, "answer_id": 54337436, "question_id": 54337061, "link": "https://stackoverflow.com/questions/54337061/whats-the-rule-of-thumb-when-dealing-with-passing-args-in-rust/54337436#54337436", "title": "What&#39;s the rule of thumb when dealing with passing args in Rust?", "body": "<p>These are the rules I personally use (in order).</p>\n\n<ol>\n<li><p>Pass by value (<code>T</code>) if the parameter has a generic type and the trait(s) that this generic type implements all take <code>&amp;self</code> or <code>&amp;mut self</code> <em>but</em> there is a blanket <code>impl</code> for <code>&amp;T</code> or <code>&amp;mut T</code> (respectively) for all types <code>T</code> that implement that trait (or these traits). For example, in <a href=\"https://doc.rust-lang.org/stable/std/io/trait.Write.html\" rel=\"noreferrer\"><code>std::io::Write</code></a>, all methods take <code>&amp;mut self</code>, but there is a blanket impl <code>impl&lt;'a, W: Write + ?Sized&gt; Write for &amp;'a mut W</code> provided by the standard library. This means that although you accept a <code>T</code> (where <code>T: Write</code>) by value, one can pass a <code>&amp;mut T</code> because <code>&amp;mut T</code> also implements <code>Write</code>.</p></li>\n<li><p>Pass by value (<code>T</code>) if you must take ownership of the value (for example, because you pass it to another function/method that takes it by value, or because the alternatives would require potentially expensive clones).</p></li>\n<li><p>Pass by mutable reference (<code>&amp;mut T</code>) if you must mutate the object (by calling other functions/methods that take the object by mutable reference, or just by overwriting it and you want the caller to see the new value) but do not need to take ownership of it.</p></li>\n<li><p>Pass by value (<code>T</code>) if the type is <code>Copy</code> and is small (my criterion for small is <code>size_of::&lt;T&gt;() &lt;= size_of::&lt;usize&gt;() * 2</code>, but other people might have slightly different criteria). The primitive integer and floating-point types are examples of such types. Passing values of these types by reference would create an unnecessary indirection in memory, so the caller will have to perform an additional machine instruction to read it. When <code>size_of::&lt;T&gt;() &lt;= size_of::&lt;usize&gt;()</code>, you're usually not saving anything by passing the value by reference because <code>T</code> and <code>&amp;T</code> will usually be both passed in a single register (if the function has few enough parameters).</p></li>\n<li><p>Pass by shared reference (<code>&amp;T</code>) otherwise.</p></li>\n</ol>\n\n<p>In general, prefer passing by shared reference when possible. This avoids potentially expensive clones when the type is large or manages resources other than memory, and gives the most flexibility to the caller in how the value can be used after the call.</p>\n\n<blockquote>\n  <p>E.g., is it a good idea to pass by <code>T</code> if I want to deallocate <code>T</code> after it goes out of scope in my child function (the function I'm passing <code>T</code> to)</p>\n</blockquote>\n\n<p>You'd better have a good reason for that! If you ever decide that you actually need to use the <code>T</code> later in the caller, then you'll have to change the callee's signature and update all call sites (because unlike in C++, where going from <code>T</code> to <code>const T&amp;</code> is mostly transparent, going from <code>T</code> to <code>&amp;T</code> in Rust is not: you must add a <code>&amp;</code> in front of the argument in all call sites).</p>\n\n<p>I recommend you use <a href=\"https://github.com/rust-lang/rust-clippy\" rel=\"noreferrer\">Clippy</a> if you're not already using it. <a href=\"https://rust-lang.github.io/rust-clippy/master/index.html#needless_pass_by_value\" rel=\"noreferrer\">Clippy has a lint that can notify you if you write a function that takes an argument by value but the function doesn't need to take ownership of it</a> (this lint used to warn by default, but it no longer does \ud83d\ude1e, so you have to enable it manually with <code>#[warn(clippy::needless_pass_by_value)]</code>).</p>\n"}], "owner": {"reputation": 351, "user_id": 10946826, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/55ebee3f352a4b3f8d5bca9c2e4b13da?s=128&d=identicon&r=PG&f=1", "display_name": "James Larkin", "link": "https://stackoverflow.com/users/10946826/james-larkin"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 388, "favorite_count": 0, "answer_count": 1, "score": 3, "last_activity_date": 1548287434, "creation_date": 1548284665, "last_edit_date": 1548285607, "question_id": 54337061, "link": "https://stackoverflow.com/questions/54337061/whats-the-rule-of-thumb-when-dealing-with-passing-args-in-rust", "title": "What&#39;s the rule of thumb when dealing with passing args in Rust?", "body": "<p>I read a couple of <a href=\"https://blog.ryanlevick.com/posts/rust-pass-value-or-reference/\" rel=\"nofollow noreferrer\">articles</a> and it's still unclear to me. It looks like <code>T</code> and <code>&amp;T</code> is kinda interchangeable as long as a compiler doesn't show any errors. But after I read an <a href=\"https://doc.rust-lang.org/1.7.0/book/references-and-borrowing.html\" rel=\"nofollow noreferrer\">official doc</a> I want to pass everything by reference to take advantage of borrowing.</p>\n\n<p>Could you provide any simple rule about passing an arg as <code>T</code> against <code>&amp;T</code> when T is an object/string? E.g., in C++ there're 3 options:</p>\n\n<ul>\n<li><code>T</code> \u2013 copy the value, can't mutate the current value</li>\n<li><code>&amp;T</code> \u2013 don't create a copy, can mutate the current value</li>\n<li><code>const &amp;T</code> \u2013 don't create a copy, can't mutate the current value</li>\n</ul>\n\n<p>E.g., is it a good idea to pass by <code>T</code> if I want to deallocate T after it goes out of scope in my <em>child</em> function (the function I'm passing <code>T</code> to); and use <code>&amp;T</code> if I want to use it my child function in a read-only mode and then continue to use it in my current (<em>parent</em>) function.</p>\n\n<p>Thanks!</p>\n"}, {"tags": ["logging", "rust", "rust-cargo"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1548258285, "post_id": 54330249, "comment_id": 95479643, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/34538397/is-it-possible-to-change-the-log-level-for-an-application-at-compile-time\">Is it possible to change the log level for an application at compile time?</a>"}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548264580, "post_id": 54330249, "comment_id": 95483023, "body": "Thanks for the link @PeterHall. Tried the provided solution and it still doesn&#39;t work. Edited my question with further details."}], "answers": [{"comments": [{"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "edited": false, "score": 2, "creation_date": 1548261462, "post_id": 54331741, "comment_id": 95481486, "body": "Thank you for your answer. I think this is not helpful in this instance since it&#39;s the opposite of the behaviour I&#39;m observing (I want the debug calls gone), and this guide is specific to contributing to the rustc compiler."}, {"owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "edited": false, "score": 2, "creation_date": 1548265139, "post_id": 54331741, "comment_id": 95483232, "body": "Indeed, <code>config.toml</code> is specific to rustc&#39;s build system."}], "tags": [], "owner": {"reputation": 1408, "user_id": 8869277, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/ijyzD.jpg?s=128&g=1", "display_name": "Jared Forth", "link": "https://stackoverflow.com/users/8869277/jared-forth"}, "is_accepted": false, "score": 1, "last_activity_date": 1548261180, "creation_date": 1548261180, "answer_id": 54331741, "question_id": 54330249, "link": "https://stackoverflow.com/questions/54330249/removing-debug-macros-in-rust/54331741#54331741", "title": "Removing debug macros in Rust", "body": "<p><a href=\"https://rust-lang.github.io/rustc-guide/compiler-debugging.html#how-to-keep-or-remove-debug-and-trace-calls-from-the-resulting-binary\" rel=\"nofollow noreferrer\">This link</a> might be helpful in your situation. </p>\n\n<p>According to the documentation linked above, </p>\n\n<blockquote>\n  <p>calls to <code>debug!</code> and <code>trace!</code> are only included in the program if <code>debug-assertions=yes</code> is turned on in <strong>config.toml</strong> </p>\n</blockquote>\n\n<p>Have you checked your <strong>config.toml</strong> file to see if <code>debug-assertions</code> is set to yes?</p>\n"}, {"comments": [{"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "edited": false, "score": 0, "creation_date": 1548265266, "post_id": 54332777, "comment_id": 95483284, "body": "Thanks for your answer, @Francis. I tried not passing the flag before as well, just <code>cargo build --release</code>. The <code>debug message</code> still shows."}], "tags": [], "owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "is_accepted": false, "score": 1, "last_activity_date": 1548265694, "last_edit_date": 1548265694, "creation_date": 1548265091, "answer_id": 54332777, "question_id": 54330249, "link": "https://stackoverflow.com/questions/54330249/removing-debug-macros-in-rust/54332777#54332777", "title": "Removing debug macros in Rust", "body": "<p>The <code>slog</code> crate <a href=\"https://docs.rs/slog/1.5.0/src/slog/lib.rs.html#773-808\" rel=\"nofollow noreferrer\">relies on the <code>debug-assertions</code></a> codegen option to distinguish between \"release\" builds and \"debug\" builds. Thus, by enabling <code>debug-assertions</code> (by passing <code>-C debug-assertions</code> to the compiler via <code>RUSTFLAGS</code>), <code>slog</code> doesn't take the <code>release_max_level_*</code> feature flags into account.</p>\n\n<p><code>debug-assertions</code> are disabled by default in release builds, so if you didn't mean to enable <code>debug-assertions</code>, simply don't pass that flag to the compiler. Note also that you can enable or disable <code>debug-assertions</code> via the <a href=\"https://doc.rust-lang.org/cargo/reference/manifest.html#the-profile-sections\" rel=\"nofollow noreferrer\"><code>[profile.*]</code> sections</a> in <code>Cargo.toml</code>.</p>\n"}, {"tags": [], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "is_accepted": true, "score": 2, "last_activity_date": 1548857880, "last_edit_date": 1548857880, "creation_date": 1548856651, "answer_id": 54442260, "question_id": 54330249, "link": "https://stackoverflow.com/questions/54330249/removing-debug-macros-in-rust/54442260#54442260", "title": "Removing debug macros in Rust", "body": "<p>In order to simplify the issue, I made another working example with the current version of slog (2.4.1) that set a global scope logger and the issue <em>still</em> reproduced. This is the code example:</p>\n\n<pre><code>extern crate slog;\nextern crate slog_async;\nextern crate slog_json;\nextern crate slog_term;\nextern crate slog_scope;\nextern crate slog_stdlog;\n#[macro_use]\nextern crate log;\n\nfn complex_logging() -&gt; Result&lt;(), log::SetLoggerError&gt; {\n    //Create the output file\n    let log_path = \"your_log_file_path.log\";\n    let file = OpenOptions::new()\n        .create(true)\n        .write(true)\n        .truncate(true)\n        .open(log_path)\n        .unwrap();\n\n    //Create the terminal drain\n    let decorator = slog_term::TermDecorator::new().build();\n    let d1 = slog_term::FullFormat::new(decorator).build().fuse();\n    let d1 = slog_async::Async::new(d1).build().fuse();\n\n    //Create the file drain\n    let d2 = slog_json::Json::new(file)\n        .add_default_keys()\n        .build()\n        .fuse();\n    let d2 = slog_async::Async::new(d2).build().fuse();\n\n    //Fuse the drains and create the logger\n    let logger = slog::Logger::root(slog::Duplicate::new(d1, d2).fuse(), o!());\n    let _guard = slog_scope::set_global_logger(logger);\n\n    //register slog_stdlog as the log handler with the log crate\n    slog_stdlog::init().unwrap();\n\n\n    trace!(\"logging a trace message\");\n    debug!(\"debug values \\\"x\\\" =&gt; 1, \\\"y\\\" =&gt; -1\");\n    info!(\"some interesting info; where =&gt; right here\");\n    warn!(\"be cautious!; why =&gt; you never know...\");\n    error!(\"wrong, foobar; type =&gt; unknown\");\n\n    Ok(())\n}\n\nfn main() {\n  let _res = complex_logging();    \n}\n</code></pre>\n\n<p>Running the above example after building for release yields this result:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Jan 30 13:53:52.398 TRCE logging a trace message\nJan 30 13:53:52.399 DEBG debug values \"x\" =&gt; 1, \"y\" =&gt; -1\nJan 30 13:53:52.399 INFO some interesting info; where =&gt; right here\nJan 30 13:53:52.399 WARN be cautious!; why =&gt; you never know...\nJan 30 13:53:52.399 ERRO wrong, foobar; type =&gt; unknown\n</code></pre>\n\n<p>However, a new example that passes loggers around fixes the issue. Here's the working example:</p>\n\n<pre><code>#[macro_use]\nextern crate slog;\nextern crate slog_async;\nextern crate slog_json;\nextern crate slog_term;\nextern crate slog_scope;\nextern crate slog_stdlog;\n\nuse slog::Drain;\nuse std::fs::OpenOptions;\nuse std::io;\nuse std::sync::Mutex;\n\nfn duplicate_log() {\n    let plain = slog_term::PlainSyncDecorator::new(std::io::stdout());\n    let d1 = slog_term::FullFormat::new(plain).build().fuse();\n    let d2 = Mutex::new(slog_json::Json::default(io::stdout())).fuse();\n    let log = slog::Logger::root(slog::Duplicate::new(d1, d2).fuse(), o!(\"version\" =&gt; env!(\"CARGO_PKG_VERSION\")));\n\n    trace!(log, \"logging a trace message\");\n    debug!(log, \"debug values\"; \"x\" =&gt; 1, \"y\" =&gt; -1);\n    info!(log, \"some interesting info\"; \"where\" =&gt; \"right here\");\n    warn!(log, \"be cautious!\"; \"why\" =&gt; \"you never know...\");\n    error!(log, \"wrong {}\", \"foobar\"; \"type\" =&gt; \"unknown\");\n    crit!(log, \"abandoning test\");\n}\n\nfn main() {\n   duplicate_log();\n}\n</code></pre>\n\n<p>Running the working example yields the following result:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Jan 30 13:56:30.839 INFO some interesting info, where: right here, version: 0.1.0\n{\"msg\":\"some interesting info\",\"level\":\"INFO\",\"ts\":\"2019-01-30T13:56:30.839762+00:00\",\"version\":\"0.1.0\",\"where\":\"right here\"}\nJan 30 13:56:30.839 WARN be cautious!, why: you never know..., version: 0.1.0\n{\"msg\":\"be cautious!\",\"level\":\"WARN\",\"ts\":\"2019-01-30T13:56:30.839787+00:00\",\"version\":\"0.1.0\",\"why\":\"you never know...\"}\nJan 30 13:56:30.839 ERRO wrong foobar, type: unknown, version: 0.1.0\n{\"msg\":\"wrong foobar\",\"level\":\"ERRO\",\"ts\":\"2019-01-30T13:56:30.839802+00:00\",\"version\":\"0.1.0\",\"type\":\"unknown\"}\nJan 30 13:56:30.839 CRIT abandoning test, version: 0.1.0\n{\"msg\":\"abandoning test\",\"level\":\"CRIT\",\"ts\":\"2019-01-30T13:56:30.839815+00:00\",\"version\":\"0.1.0\"}\n</code></pre>\n\n<p>If you are running into a similar issue as I did, <strong>my problem was setting a global scope logger</strong>. Passing around loggers fixes this issue.</p>\n"}], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1207, "favorite_count": 1, "accepted_answer_id": 54442260, "answer_count": 3, "score": 5, "last_activity_date": 1548857880, "creation_date": 1548256229, "last_edit_date": 1548264553, "question_id": 54330249, "link": "https://stackoverflow.com/questions/54330249/removing-debug-macros-in-rust", "title": "Removing debug macros in Rust", "body": "<p>I'm writing an application that uses slog for logging multiple things during its execution. As such, I make extensive use of the <code>info!</code>, <code>error!</code>, <code>warn!</code> and <code>debug!</code> macros.</p>\n\n<p>However, as expected, the <code>debug!</code> calls are there to help me debug the applications and I don't want those calls polluting the logs when actually using the application.</p>\n\n<p>I've been trying to compile them away without success. This is the line I'm using: <code>RUSTFLAGS=\"$RUSTFLAGS -C debug-assertions\" cargo build --release</code></p>\n\n<p>The compilation goes on smoothly, but on execution I see all the debug calls.</p>\n\n<p>The following is a working example of my issue:</p>\n\n<p>Cargo.toml:</p>\n\n<pre><code>[dependencies]\nslog = { version = \"1.5\", features = [\"max_level_trace\", \"release_max_level_warn\"] }\nslog-stream = \"1.2.0\"\nslog-term = \"1.5.0\"\nslog-json = \"1.2.1\"\nslog-stdlog = \"1.1.0\"\nlog = \"0.3.7\"\n</code></pre>\n\n<p>main.rs:</p>\n\n<pre><code>#[macro_use]\nextern crate slog;\nextern crate slog_stream;\nextern crate slog_term;\nextern crate slog_json;\nextern crate slog_stdlog;\n#[macro_use]\nextern crate log;\n\nuse std::path::Path;\nuse std::fs::OpenOptions;\nuse slog::DrainExt;\n\nfn init_logger(work_dir : &amp;Path) {\n    let mut log_dir_buf = work_dir.to_path_buf();\n    log_dir_buf.push(\"log\");\n\n    if !log_dir_buf.exists() {\n        std::fs::create_dir(log_dir_buf.as_path()).unwrap();\n    }\n\n    log_dir_buf.push(\"the_log_file.log\");\n    let log_file_name = log_dir_buf.to_str().unwrap();\n\n    let log_file = OpenOptions::new()\n                        .create(true)\n                        .write(true)\n                        .truncate(true)\n                        .open(log_file_name).unwrap();\n\n    let console_drain = slog_term::streamer().build();\n    let file_drain = slog_stream::stream(log_file, slog_json::default());\n    let logger = slog::Logger::root(slog::duplicate(console_drain, file_drain).fuse(), o!());\n    slog_stdlog::set_logger(logger).unwrap();\n} \n\nfn main() {\n    init_logger(Path::new(\".\"));\n\n    info!(\"This is an info message\");\n    warn!(\"This is a warn message\");\n    error!(\"This is an error message\");\n    debug!(\"This is a debug message\");\n}\n</code></pre>\n\n<p>Now, building a release version as stated above and running the binary I get the following output:</p>\n\n<pre><code>Jan 23 17:20:56.640 INFO This is an info message\nJan 23 17:20:56.641 WARN This is a warn message\nJan 23 17:20:56.641 ERRO This is an error message\nJan 23 17:20:56.641 DEBG This is a debug message\n</code></pre>\n\n<p>Finally, rust version:\n<code>rustc 1.31.0 (abe02cefd 2018-12-04)</code></p>\n\n<p>I know the version of slog I'm using is old, but upgrading the dependency is not a priority at the moment. However, the <a href=\"https://docs.rs/slog/1.5.0/slog/#notable-details\" rel=\"nofollow noreferrer\">version's documentation</a> states that log filtering should be possible as @shepmaster describes in the <a href=\"https://stackoverflow.com/questions/34538397/is-it-possible-to-change-the-log-level-for-an-application-at-compile-time\">linked answer</a>, it just doesn't seem to work for me. What am I missing?</p>\n"}, {"tags": ["rust", "traits", "lifetime"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 2, "creation_date": 1548253454, "post_id": 54329200, "comment_id": 95476645, "body": "This <b>is</b> mysterious!"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 1, "creation_date": 1548253556, "post_id": 54329200, "comment_id": 95476709, "body": "Since we are talking about traits... <code>&#39;static</code> is probably missing somewhere?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1548254217, "post_id": 54329200, "comment_id": 95477200, "body": "@MatthieuM. Why is a static lifetime required for the argument of <code>partial_cmp</code> but not for <code>cmp</code>?"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548254804, "post_id": 54329200, "comment_id": 95477576, "body": "@PeterHall: I have no idea, but I think that this may be the clue behind the &quot;expected std::cmp::Eq found std::cmp::Eq&quot;, one has a <code>&#39;static</code> lifetime that is not shown, while the other doesn&#39;t. I am certainly looking forward to the answer of this question :D"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548255011, "post_id": 54329200, "comment_id": 95477720, "body": "<code>fn partial_cmp(&amp;self, other: &amp;(dyn SimpleOrder + &#39;static)) -&gt; Option&lt;Ordering&gt;</code> works ;)"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548255219, "post_id": 54329200, "comment_id": 95477866, "body": "A much simpler reproduction of the issue: <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=b9651de4c79c6f68b0d155f4e72dfa97\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548255325, "post_id": 54329200, "comment_id": 95477941, "body": "Using <code>Self</code> instead of <code>dyn SimpleOrder</code> also works. I suspect this has something to do with lifetime elision."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548255416, "post_id": 54329200, "comment_id": 95477993, "body": "@trentcl: Probably. I guess <code>Self</code> is deduced to be <code>dyn SimpleOrder + &#39;static</code>, and <code>dyn SimpleOrder</code>, as an argument, is treated as &quot;potentially something else entirely&quot;."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548257685, "post_id": 54329200, "comment_id": 95479294, "body": "Yes, <code>fn f(&amp;self, o: &amp;dyn Trt)</code> is equal to <code>fn&lt;&#39;a&gt; f(&amp;self, o: &amp;&#39;a (dyn Trt + &#39;a)</code>. But @PeterHall note that your reproduction actually produces a different (albeit similar) issue. The issue in orlp&#39;s code is triggered by rust typechecking against the signature of <code>cmp</code> of the <code>Ord</code> trait instead of the actual implementation. Otherwise his code works perfectly fine."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1548258006, "post_id": 54329200, "comment_id": 95479482, "body": "@Chronial I think it&#39;s the same. What I narrowed in on was the fact that one method calls another. The issue doesn&#39;t occur when they don&#39;t call each other."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548258341, "post_id": 54329200, "comment_id": 95479682, "body": "@PeterHall if you copy the <code>cmp</code> implementation into the <code>SimpleOrder</code> trait, rename it to <code>mycmp</code> and then call that in <code>partial_cmp</code>, the code will compile."}], "answers": [{"comments": [{"owner": {"reputation": 97521, "user_id": 565635, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7b4b3e7c9ac68b7d2c93ad02d0b9c79d?s=128&d=identicon&r=PG", "display_name": "orlp", "link": "https://stackoverflow.com/users/565635/orlp"}, "edited": false, "score": 5, "creation_date": 1548256989, "post_id": 54330388, "comment_id": 95478918, "body": "That makes sense. I do believe that the error message generated by Rust should be improved though - that this is the issue isn&#39;t <i>at all</i> clear from the error message."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1548257004, "post_id": 54330388, "comment_id": 95478932, "body": "&quot;So now we have that self has type &amp;(dyn SimpleOrder + &#39;a) while other has type &amp;(dyn SimpleOrder + &#39;static).&quot; \u2013 this should be the other way round, right?"}, {"owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "reply_to_user": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1548257064, "post_id": 54330388, "comment_id": 95478971, "body": "@Chronial oops, fixed."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 3, "creation_date": 1548257179, "post_id": 54330388, "comment_id": 95479031, "body": "The thing that is surprising to me here is that calling <code>SimpleOrder::cmp(self, other)</code> does not check against the signature of <code>SimpleOrder::cmp</code> (which would succeed), but against the signature of <code>Ord::cmp</code> (which fails)."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 1, "creation_date": 1548258833, "post_id": 54330388, "comment_id": 95479965, "body": "@Chronial: I think this would warrant its own (separate) question; notably, I guess it would be possible to trigger the behavior without <code>dyn Trait</code>, just exploiting sub-typing with regular types containing references."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548260601, "post_id": 54330388, "comment_id": 95481043, "body": "What surprises <i>me</i> is that this doesn&#39;t match the behavior of <code>Box&lt;dyn SimpleOrder&gt;</code> (it&#39;s not treated as a free parameter, but always as <code>&#39;static</code>). There must be something special about references. Did you refer to any particular documentation to write this answer? I can&#39;t find anything that explicitly describes how lifetime parameters on trait objects are inferred."}, {"owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548264571, "post_id": 54330388, "comment_id": 95483019, "body": "@trentcl No, I just experimented in the playground. I noticed in particular that introducing the explicit lifetime in <code>partial_cmp</code>&#39;s signature (as written in my answer) didn&#39;t change the compiler&#39;s behavior, so I assumed both forms were equivalent."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1548305490, "post_id": 54330388, "comment_id": 95495529, "body": "@trentcl I remember reading somewhere that <code>&amp;&#39;a T</code> is equal to <code>&amp;&#39;a (T + &#39;a)</code>. That does also fit the behavior of <code>Box</code> (non-references are <code>&#39;static</code>). Ah, found the reference: <a href=\"https://doc.rust-lang.org/reference/lifetime-elision.html#default-trait-object-lifetimes\" rel=\"nofollow noreferrer\">doc.rust-lang.org/reference/&hellip;</a>"}, {"owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "reply_to_user": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1548366443, "post_id": 54330388, "comment_id": 95526749, "body": "@Chronial Thanks for the reference! I&#39;ve incorporated it into my answer and edited it accordingly."}], "tags": [], "owner": {"reputation": 46065, "user_id": 234590, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/463c0219a51a5d1fd08e1fa280811b57?s=128&d=identicon&r=PG", "display_name": "Francis Gagn&#233;", "link": "https://stackoverflow.com/users/234590/francis-gagn%c3%a9"}, "is_accepted": true, "score": 21, "last_activity_date": 1548366415, "last_edit_date": 1548366415, "creation_date": 1548256668, "answer_id": 54330388, "question_id": 54329200, "link": "https://stackoverflow.com/questions/54329200/mysterious-lifetime-issue-while-implementing-trait-for-dyn-object/54330388#54330388", "title": "Mysterious lifetime issue while implementing trait for dyn object", "body": "<p>Trait object types have an associated lifetime bound, but it can be omitted. A full trait object type is written <code>dyn Trait + 'a</code> (when behind a reference, parentheses must be added around it: <code>&amp;(dyn Trait + 'a)</code>).</p>\n\n<p>The tricky part is that when a lifetime bound is omitted, <a href=\"https://doc.rust-lang.org/reference/lifetime-elision.html#default-trait-object-lifetimes\" rel=\"noreferrer\">the rules are a bit complicated</a>.</p>\n\n<p>First, we have:</p>\n\n<pre><code>impl PartialOrd for dyn SimpleOrder {\n</code></pre>\n\n<p>Here, the compiler infers <code>+ 'static</code>. Lifetime parameters are never introduced on <code>impl</code> blocks (as of Rust 1.32.0).</p>\n\n<p>Next, we have:</p>\n\n<pre><code>    fn partial_cmp(&amp;self, other: &amp;dyn SimpleOrder) -&gt; Option&lt;Ordering&gt; {\n</code></pre>\n\n<p>The type of <code>other</code> is inferred to be <code>&amp;'b (dyn SimpleOrder + 'b)</code>, where <code>'b</code> is an implicit lifetime parameter introduced on <code>partial_cmp</code>.</p>\n\n<pre><code>    fn partial_cmp&lt;'a, 'b&gt;(&amp;'a self, other: &amp;'b (dyn SimpleOrder + 'b)) -&gt; Option&lt;Ordering&gt; {\n</code></pre>\n\n<p>So now we have that <code>self</code> has type <code>&amp;'a (dyn SimpleOrder + 'static)</code> while <code>other</code> has type <code>&amp;'b (dyn SimpleOrder + 'b)</code>. What's the problem?</p>\n\n<p>Indeed, <code>cmp</code> doesn't give any error, because its implementation doesn't require that the lifetime of the two trait objects be equal. Why does <code>partial_cmp</code> care, though?</p>\n\n<p>Because <code>partial_cmp</code> is calling <code>Ord::cmp</code>. When type checking a call to a trait method, the compiler checks against the signature from the trait. Let's review that signature:</p>\n\n<pre><code>pub trait Ord: Eq + PartialOrd&lt;Self&gt; {\n    fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering;\n</code></pre>\n\n<p>The trait requires that <code>other</code> be of type <code>Self</code>. That means that when <code>partial_cmp</code> calls <code>cmp</code>, it tries to pass a <code>&amp;'b (dyn SimpleOrder + 'b)</code> to a parameter that expects a <code>&amp;'b (dyn SimpleOrder + 'static)</code>, because <code>Self</code> is <code>dyn SimpleOrder + 'static</code>. This conversion is not valid (<code>'b</code> cannot be converted to <code>'static</code>), so the compiler gives an error.</p>\n\n<p>So then, why is it valid to set the type of <code>other</code> to <code>&amp;'b (dyn SimpleOrder + 'b)</code> when implementing <code>Ord</code>? Because <code>&amp;'b (dyn SimpleOrder + 'b)</code> is a <a href=\"https://doc.rust-lang.org/nomicon/subtyping.html\" rel=\"noreferrer\">supertype</a> of <code>&amp;'b (dyn SimpleOrder + 'static)</code>, and Rust lets you replace a parameter type with one of its supertypes when implementing a trait method (it makes the method strictly more general, even though it's apparently not used much in type checking).</p>\n\n<hr>\n\n<p>In order to make your implementation as generic as possible, you should introduce a lifetime parameter on the <code>impl</code>s:</p>\n\n<pre><code>use std::cmp::Ordering;\n\npub trait SimpleOrder {\n    fn key(&amp;self) -&gt; u32;\n}\n\nimpl&lt;'a&gt; PartialOrd for dyn SimpleOrder + 'a {\n    fn partial_cmp(&amp;self, other: &amp;Self) -&gt; Option&lt;Ordering&gt; {\n        Some(self.cmp(other))\n    }\n}\n\nimpl&lt;'a&gt; Ord for dyn SimpleOrder + 'a {\n    fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering {\n        self.key().cmp(&amp;other.key())\n    }\n}\n\nimpl&lt;'a&gt; PartialEq for dyn SimpleOrder + 'a {\n    fn eq(&amp;self, other: &amp;Self) -&gt; bool {\n        self.key() == other.key()\n    }\n}\n\nimpl&lt;'a&gt; Eq for dyn SimpleOrder + 'a {}\n</code></pre>\n"}], "owner": {"reputation": 97521, "user_id": 565635, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7b4b3e7c9ac68b7d2c93ad02d0b9c79d?s=128&d=identicon&r=PG", "display_name": "orlp", "link": "https://stackoverflow.com/users/565635/orlp"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1285, "favorite_count": 3, "accepted_answer_id": 54330388, "answer_count": 1, "score": 20, "last_activity_date": 1548366415, "creation_date": 1548252858, "last_edit_date": 1548253481, "question_id": 54329200, "link": "https://stackoverflow.com/questions/54329200/mysterious-lifetime-issue-while-implementing-trait-for-dyn-object", "title": "Mysterious lifetime issue while implementing trait for dyn object", "body": "<p>Consider the following toy example:</p>\n\n<pre><code>use std::cmp::Ordering;\n\npub trait SimpleOrder {\n    fn key(&amp;self) -&gt; u32;\n}\n\nimpl PartialOrd for dyn SimpleOrder {\n    fn partial_cmp(&amp;self, other: &amp;dyn SimpleOrder) -&gt; Option&lt;Ordering&gt; {\n        Some(self.cmp(other))\n    }\n}\n\nimpl Ord for dyn SimpleOrder {\n    fn cmp(&amp;self, other: &amp;dyn SimpleOrder) -&gt; Ordering {\n        self.key().cmp(&amp;other.key())\n    }\n}\n\nimpl PartialEq for dyn SimpleOrder {\n    fn eq(&amp;self, other: &amp;dyn SimpleOrder) -&gt; bool {\n        self.key() == other.key()\n    }\n}\n\nimpl Eq for SimpleOrder {}\n</code></pre>\n\n<p>This doesn't compile. It claims there is a lifetime issue in the implementation for <code>partial_cmp</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime due to conflicting requirements\n --&gt; src/main.rs:9:23\n  |\n9 |         Some(self.cmp(other))\n  |                       ^^^^^\n  |\nnote: first, the lifetime cannot outlive the anonymous lifetime #2 defined on the method body at 8:5...\n --&gt; src/main.rs:8:5\n  |\n8 | /     fn partial_cmp(&amp;self, other: &amp;dyn SimpleOrder) -&gt; Option&lt;Ordering&gt; {\n9 | |         Some(self.cmp(other))\n10| |     }\n  | |_____^\nnote: ...so that the declared lifetime parameter bounds are satisfied\n --&gt; src/main.rs:9:23\n  |\n9 |         Some(self.cmp(other))\n  |                       ^^^^^\n  = note: but, the lifetime must be valid for the static lifetime...\n  = note: ...so that the types are compatible:\n          expected std::cmp::Eq\n             found std::cmp::Eq\n</code></pre>\n\n<p>I really don't understand this error. In particular <em>\"expected <code>std::cmp::Eq</code> found <code>std::cmp::Eq</code>\"</em> is puzzling.</p>\n\n<p>If I inline the call manually it compiles fine:</p>\n\n<pre><code>fn partial_cmp(&amp;self, other: &amp;dyn SimpleOrder) -&gt; Option&lt;Ordering&gt; {\n    Some(self.key().cmp(&amp;other.key()))\n}\n</code></pre>\n\n<p>What's going on here?</p>\n"}, {"tags": ["arrays", "syntax", "rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1548253039, "post_id": 54329194, "comment_id": 95476407, "body": "Either <code>(u32, u32)</code> or <code>[u32; 2]</code>."}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548253101, "post_id": 54329194, "comment_id": 95476440, "body": "@hellow Won\u2019t the latter give me a vector of arrays, rather than a vector of tulles?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548253148, "post_id": 54329194, "comment_id": 95476467, "body": "It will give you an array of two <code>u32</code>s. A <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html\" rel=\"nofollow noreferrer\"><code>Vec is a type</code></a>."}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548253312, "post_id": 54329194, "comment_id": 95476556, "body": "Ok, but I need a vector of tuples (of 2 u32s) a simple two element array won\u2019t work. This is to store the result of collect() on a iterator, it doesn\u2019t store only two values..."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548253520, "post_id": 54329194, "comment_id": 95476690, "body": "IMHO they are interchangeable <a href=\"https://stackoverflow.com/a/52903936/1021920\">stackoverflow.com/a/52903936/1021920</a> also I told you what the correct syntax is ^^"}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548253667, "post_id": 54329194, "comment_id": 95476774, "body": "Oh, fair enough, so you would suggest Vec&lt;[u32, 2]&gt;?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1548254061, "post_id": 54329194, "comment_id": 95477074, "body": "The fun thing is, you don&#39;t need to specify it at all. Your code looks very unrusty and I took a minute to &quot;convert it to more rusty code&quot; <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=712f64ce51a7590039ad560a6783db7a\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a> As you see, you don&#39;t need to specify <code>(u32, u32)</code> at all, because the compiler will deduce the types for you. I recommend you to read <a href=\"https://doc.rust-lang.org/stable/book/\" rel=\"nofollow noreferrer\">the book</a> because as it seems, you are missing some key features coming with rust. Have fun nevertheless!"}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548254195, "post_id": 54329194, "comment_id": 95477188, "body": "@hellow thank you so much for converting it, it\u2019s helpful to look at code from somebody who knows what they\u2019re doing. I am aware that a couple of the type definitions are optional in my code, but I come from python, so I\u2019m not really used to thinking too much about types. I thought that by writing the types explicitly, it would help me to confirm that what I think is happening, is what the compiler is actually doing!"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548254349, "post_id": 54329194, "comment_id": 95477281, "body": "You&#39;re welcome. Btw, your code does not work correctly for e.g. 25 if I understand correctly what you are doing (<code>25 = 16 + 9 = 5&#178; = 4&#178; + 3&#178;</code>)"}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548254726, "post_id": 54329194, "comment_id": 95477522, "body": "@hellow I don\u2019t think that\u2019s what it\u2019s trying to do. I\u2019ll investigate and get back to you. Thanks again!"}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548260564, "post_id": 54329194, "comment_id": 95481011, "body": "@hellow If you&#39;re interested, it does actually work. It takes some number S, and computes a pythagorean triple - a, b, and c such that a + b + c = S. 25 seems to have no solutions for this problem. As an example, 1000 gives 200, 375, 425, which is a pythagorean triple, and whose sum is 1000"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548262198, "post_id": 54329194, "comment_id": 95481885, "body": "But as  already  stated,  25 is a valid triplet."}, {"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548264052, "post_id": 54329194, "comment_id": 95482822, "body": "Yes, 25 is a valid triplet, but 3+4+5 sums to 12, and, indeed, if you run the algorithm on 12, it returns 3,4,5, as expected"}], "owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 2872, "favorite_count": 0, "answer_count": 0, "score": 3, "last_activity_date": 1548259622, "creation_date": 1548252840, "last_edit_date": 1548259622, "question_id": 54329194, "link": "https://stackoverflow.com/questions/54329194/rust-type-definition-of-vector-of-tuples", "title": "Rust, type definition of vector of tuples", "body": "<p>I am following the excism rust track, and I've hit a problem (I'm very, very new to rust)</p>\n\n<p>This is a function to calculate the pythagorean triples of an integer:</p>\n\n<pre><code>use std::collections::HashSet;\nuse rayon::prelude::*;\n\npub fn find(sum: u32) -&gt; HashSet&lt;[u32; 3]&gt; {\n    let a_b_plus_c: Vec&lt;(u32; 2)&gt; = (1_u32..(sum / 3_u32)).into_par_iter()\n        .filter_map(|a| {\n            let b_plus_c: u32 = sum - a;\n\n            let whole_number_check: Option&lt;u32&gt; = (b_plus_c.pow(2) - a.pow(2)).checked_rem(b_plus_c * 2);\n\n            match whole_number_check {\n                Some(0) =&gt; Some((a, b_plus_c)),\n                Some(_) =&gt; None,\n                None =&gt; None,\n            }\n        }).collect::&lt;Vec&lt;(u32; 2)&gt;&gt;();\n\n    a_b_plus_c.into_par_iter().filter_map(|a, b_plus_c| {\n        let b: u32 = (b_plus_c.pow(2) - a.pow(2))/(b_plus_c * 2);\n        let c: u32 = b_plus_c - b;\n\n        match b {\n            b if b &gt; a =&gt; [a, b, c]\n            _ =&gt; None,\n        }}\n        ).collect::&lt;HashSet&lt;[u32; 3]&gt;&gt;();\n\n}\n</code></pre>\n\n<p>Or rather, it would be if it worked... </p>\n\n<p>The current issue is in the line:</p>\n\n<pre><code>let a_b_plus_c: Vec&lt;(u32; 2)&gt; = (1_u32..(sum / 3_u32)).into_par_iter()\n</code></pre>\n\n<p>It says that it expected one of a number of symbols when parsing the type for <code>a_b_plus_c</code>, but found <code>;</code>. From everything that I've seen (not much), this is the correct way to define a vector of tuples, each of which has two elements of type <code>u32</code>.</p>\n\n<p>As I said, this is a learning exercise for me, so if anybody could help me out, I would be grateful for verbose and detailed answers :)</p>\n\n<p>For what it's worth, as it might help you to comment on my code, this is the maths:</p>\n\n<pre><code>a + b + c = sum\na\u00b2 + b\u00b2 = c\u00b2\nRearrange for b:\nb = ((b + c)\u00b2 - a\u00b2) / (2(b + c))\nSo, iterate through a to get b+c, since (b+c) = sum - a\nThen solve the above equation to get a, b+c, and b\nConfirm that a &lt; b\nThen solve for c:\nc = (b + c) - b\n</code></pre>\n\n<p>It should then spit them all out into a HashSet of arrays of <code>a,b,c</code></p>\n"}, {"tags": ["reference", "rust", "lifetime"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548230418, "post_id": 54322391, "comment_id": 95463582, "body": "As a sidenote: In rust 1.34.0 you can use <code>ATOMIC_{U,I}64</code> <a href=\"https://github.com/rust-lang/rust/pull/57425\" rel=\"nofollow noreferrer\">github.com/rust-lang/rust/pull/57425</a>. If you are on nightly you can use them right now :)"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548230671, "post_id": 54322391, "comment_id": 95463701, "body": "Also I&#39;m not sure, what your concern is. Your code works fine. Can you please either expand your question or code to clarify what is not working and what you want to achieve?"}, {"owner": {"reputation": 4177, "user_id": 1710566, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/46df81dc7409d5ba5b66c0d245c9fb97?s=128&d=identicon&r=PG&f=1", "display_name": "chris", "link": "https://stackoverflow.com/users/1710566/chris"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548230858, "post_id": 54322391, "comment_id": 95463793, "body": "it doesn&#39;t work because I don&#39;t know how to use the guard as a struct member. without the guard the timer callback is never called"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 3, "creation_date": 1548231968, "post_id": 54322391, "comment_id": 95464343, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/32300132/why-cant-i-store-a-value-and-a-reference-to-that-value-in-the-same-struct\">Why can&#39;t I store a value and a reference to that value in the same struct?</a>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1548259971, "post_id": 54322391, "comment_id": 95480626, "body": "As @Jmb has pointed out, the problem you are facing is that you can&#39;t store an object and a reference to that object in the same structure. It&#39;s difficult to make suggestions to fix your code though, because it&#39;s really not clear what you are trying to do (except this one impossible thing). Do you need to construct the guard inside <code>new</code>? That would imply that you want to start the timer running - if the timer is not always running, what value do you expect the guard to have when it isn&#39;t?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548260232, "post_id": 54322391, "comment_id": 95480803, "body": "Is <code>tick</code> the callback for the timer?"}, {"owner": {"reputation": 4177, "user_id": 1710566, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/46df81dc7409d5ba5b66c0d245c9fb97?s=128&d=identicon&r=PG&f=1", "display_name": "chris", "link": "https://stackoverflow.com/users/1710566/chris"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548313326, "post_id": 54322391, "comment_id": 95497961, "body": "@PeterHall tick starts the timer, the guard is basically just the reference to the object, and when its dropped the callback doesn&#39;t run either. I see the problem though, I guess this doesn&#39;t work in rust"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548321378, "post_id": 54322391, "comment_id": 95501832, "body": "In that case, just for starters <code>guard</code> needs to be <code>Option&lt;Guard&gt;</code>, so it can be <code>None</code> before you call <code>tick</code>."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 1, "last_activity_date": 1548324695, "creation_date": 1548324695, "answer_id": 54344098, "question_id": 54322391, "link": "https://stackoverflow.com/questions/54322391/retain-reference-to-timerguard-in-struct/54344098#54344098", "title": "Retain reference to timer::guard in struct", "body": "<p>Given that the timer is not always running for the lifetime of <code>GlobalTime</code>, there isn't always a valid value for <code>guard</code>. We usually model that idea with an <code>Option</code>:</p>\n\n<pre><code>struct GlobalTime {\n    tick_count: Arc&lt;Mutex&lt;u64&gt;&gt;,\n    millis: Arc&lt;Mutex&lt;i64&gt;&gt;,\n    timer: timer::Timer,\n    guard: Option&lt;timer::Guard&gt;,\n}\n</code></pre>\n\n<p>Which also solves your problem of what the initial value is, because it's <code>Option::None</code>:</p>\n\n<pre><code>impl GlobalTime {\n    fn new() -&gt; GlobalTime {\n        GlobalTime {\n            tick_count: Arc::new(Mutex::new(0)),\n            millis: Arc::new(Mutex::new(200)),\n            timer: timer::Timer::new(),\n            guard: None,\n        }\n    }\n}\n</code></pre>\n\n<p>The <code>tick</code> method becomes:</p>\n\n<pre><code>fn tick(&amp;mut self) {\n    let global_tick = self.tick_count.clone();\n    let guard = self.timer.schedule_repeating(\n        chrono::Duration::milliseconds(*self.millis.lock().unwrap()),\n        move || {\n            *global_tick.lock().unwrap() += 1;\n            println!(\"timer callback\");\n        },\n    );\n    self.guard = Some(guard);\n}\n</code></pre>\n\n<p>To stop the timer you can just set the guard value to <code>Option::None</code>:</p>\n\n<pre><code>fn stop(&amp;mut self) {\n    self.guard = None;\n}\n</code></pre>\n"}], "owner": {"reputation": 4177, "user_id": 1710566, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/46df81dc7409d5ba5b66c0d245c9fb97?s=128&d=identicon&r=PG&f=1", "display_name": "chris", "link": "https://stackoverflow.com/users/1710566/chris"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 108, "favorite_count": 0, "accepted_answer_id": 54344098, "answer_count": 1, "score": 0, "last_activity_date": 1548425011, "creation_date": 1548230121, "last_edit_date": 1548425011, "question_id": 54322391, "link": "https://stackoverflow.com/questions/54322391/retain-reference-to-timerguard-in-struct", "title": "Retain reference to timer::guard in struct", "body": "<p>I am trying to implement a struct that keeps track of a global tick. In an effort to refactor I moved the <code>timer</code> into the struct but now I am facing the issue of the <code>timer guard</code> losing reference and thus the timer being dropped. My thought was to add the guard as struct member but I am not sure how to do this.</p>\n\n<pre><code>use timer;\nuse chrono;\nuse futures::Future;\nuse std::{process, thread};\nuse std::sync::{Arc, Mutex};\n\nstruct GlobalTime {\n    tick_count: Arc&lt;Mutex&lt;u64&gt;&gt;,\n    millis: Arc&lt;Mutex&lt;i64&gt;&gt;,\n    timer: timer::Timer,\n    guard: timer::Guard,\n}\n\nimpl GlobalTime {\n    fn new() -&gt; GlobalTime {\n        GlobalTime {\n            tick_count: Arc::new(Mutex::new(0)),\n            millis: Arc::new(Mutex::new(200)),\n            timer: timer::Timer::new(),\n            guard: ???, // what do I do here to init the guard??\n        }\n    }\n\n    fn tick(&amp;self) {\n        *self.guard = {\n            let global_tick = self.tick_count.clone();\n            self.timer.schedule_repeating(\n                chrono::Duration::milliseconds(*self.millis.lock().unwrap()),\n                move || {\n                    *global_tick.lock().unwrap() += 1;\n                    println!(\"timer callback\");\n                },\n            );\n        }\n    }\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 165665, "user_id": 721269, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/346ca03edfbde2a468adc289867ab975?s=128&d=identicon&r=PG", "display_name": "David Schwartz", "link": "https://stackoverflow.com/users/721269/david-schwartz"}, "edited": false, "score": 0, "creation_date": 1548220080, "post_id": 54320166, "comment_id": 95459929, "body": "FWIW, the C++ Sudoku solver I wrote to teach people how to solve Sudoku takes about 3 milliseconds to solve this same problem."}, {"owner": {"reputation": 4031, "user_id": 1916721, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/xBXSE.png?s=128&g=1", "display_name": "carloabelli", "link": "https://stackoverflow.com/users/1916721/carloabelli"}, "reply_to_user": {"reputation": 165665, "user_id": 721269, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/346ca03edfbde2a468adc289867ab975?s=128&d=identicon&r=PG", "display_name": "David Schwartz", "link": "https://stackoverflow.com/users/721269/david-schwartz"}, "edited": false, "score": 2, "creation_date": 1548220399, "post_id": 54320166, "comment_id": 95460000, "body": "@DavidSchwartz Cool! It&#39;s definitely not great code as written, but I was mainly curious in the compiler optimization that caused the massive disparity"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548227448, "post_id": 54320166, "comment_id": 95462333, "body": "Very related: <a href=\"https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html\" rel=\"nofollow noreferrer\">gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html</a>"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 2, "creation_date": 1548235903, "post_id": 54320166, "comment_id": 95466598, "body": "You can copy/paste your code into an online compiler, such as godbolt or the Rust playground, which allows you to inspect the LLVM IR or the assembly. godbolt is able to match the assembly statements to the code portion, so can be a bit easier. There you&#39;ll see what clever optimizations the compiler pulled off... if you can recognize them."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 2, "creation_date": 1548236267, "post_id": 54320166, "comment_id": 95466791, "body": "I plugged your example into <a href=\"https://godbolt.org/z/Ylko6t\" rel=\"nofollow noreferrer\">godbolt</a>. Removing <code>print</code> as it bloats the output."}, {"owner": {"reputation": 51497, "user_id": 49246, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/c421b43470bb8d3c099c5a847e588549?s=128&d=identicon&r=PG", "display_name": "starblue", "link": "https://stackoverflow.com/users/49246/starblue"}, "edited": false, "score": 0, "creation_date": 1548275745, "post_id": 54320166, "comment_id": 95487857, "body": "IMHO the main issue is that without optimization all variables are kept on the stack instead of in registers, which adds a lot of instructions which do relatively slow memory accesses. Try optimization level 1, which does simple optimizations but AFAIK doesn&#39;t reorder code."}], "answers": [{"comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548252954, "post_id": 54329064, "comment_id": 95476358, "body": "This only scratches the surface. Optimization does a lot more, e.g. not pushing unneeded register to the stack (caller/callee save register), branch-optimization (or removing a branch completly), optimizing pure functions, alignment and many many more. (I&#39;m not saying that your answer is bad, just that you should link to some documentation that shows what will be done when enabling optimization)"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1548263498, "post_id": 54329064, "comment_id": 95482552, "body": "@hellow: Of course, but I think that the OP is asking what kind of optimization can give a x100 speed boost. Improving calling convention, register renaming and such optimizations will not give such a improvement. Removing bounds checking and inlining the array indexing may do."}], "tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 2, "last_activity_date": 1548252387, "creation_date": 1548252387, "answer_id": 54329064, "question_id": 54320166, "link": "https://stackoverflow.com/questions/54320166/what-optimization-is-making-my-rust-program-so-much-faster/54329064#54329064", "title": "What optimization is making my rust program so much faster?", "body": "<p>It is difficult to be sure without analyzing the generated assembly, but I think that it is related to the combination of these optimizations:</p>\n\n<ul>\n<li>Loop unrolling: the compiler knows that each loop runs 8 times, so instead of a loop it compiles the loop body 8 times with the index as a constant. This is why the <em>godbold</em> link by @MatthieuM in the comments above is so long.</li>\n<li>Range checking: since <code>i</code>, <code>j</code> and <code>k</code> are now constants (in the unrolled loops) and the arrays are of known size, the compiler will omit all range checks.</li>\n<li>Function inlining.</li>\n</ul>\n\n<p>In fact, each time you write <code>board[i][j]</code>:</p>\n\n<ul>\n<li>In debug mode, you are calling two library functions that do checkings and computations.</li>\n<li>In release mode each instance of such code is just a read or write to fixed offset in the stack.</li>\n</ul>\n"}], "owner": {"reputation": 4031, "user_id": 1916721, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/xBXSE.png?s=128&g=1", "display_name": "carloabelli", "link": "https://stackoverflow.com/users/1916721/carloabelli"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 289, "favorite_count": 1, "accepted_answer_id": 54329064, "answer_count": 1, "score": 2, "last_activity_date": 1548252387, "creation_date": 1548218764, "question_id": 54320166, "link": "https://stackoverflow.com/questions/54320166/what-optimization-is-making-my-rust-program-so-much-faster", "title": "What optimization is making my rust program so much faster?", "body": "<p>Frustrated that I could not solve a Sudoku puzzle, I quickly hacked together a simple recursive backtracking solver:</p>\n\n<pre><code>fn is_allowed(board: &amp;[[u8; 9]; 9], row: usize, col: usize, x: u8) -&gt; bool {\n    for i in 0..9 {\n        if board[row][i] == x {\n            return false;\n        }\n        if board[i][col] == x {\n            return false;\n        }\n    }\n\n    let r = row - (row % 3);\n    let c = col - (col % 3);\n    for i in r..(r + 3) {\n        for j in c..(c + 3) {\n            if board[i][j] == x {\n                return false;\n            }\n        }\n    }\n\n    true\n}\n\nfn solve(board: &amp;mut [[u8; 9]; 9]) -&gt; bool {\n    for i in 0..9 {\n        for j in 0..9 {\n            if board[i][j] == 0 {\n                for x in 1..=9 {\n                    if is_allowed(board, i, j, x) {\n                        board[i][j] = x;\n                        if solve(board) {\n                            return true\n                        }\n                        board[i][j] = 0;\n                    }\n                }\n                return false;\n            }\n        }\n    }\n    true\n}\n\nfn main() {\n    let mut board = [\n        [ 0, 0, 8, 0, 0, 4, 0, 0, 0 ],\n        [ 0, 0, 0, 0, 0, 0, 0, 0, 7 ],\n        [ 0, 0, 6, 0, 0, 0, 0, 1, 0 ],\n        [ 0, 0, 0, 0, 0, 0, 5, 0, 9 ],\n        [ 0, 0, 0, 6, 0, 0, 0, 0, 0 ],\n        [ 0, 2, 0, 8, 1, 0, 0, 0, 0 ],\n        [ 9, 4, 0, 0, 0, 0, 0, 0, 0 ],\n        [ 0, 0, 0, 0, 0, 0, 1, 8, 0 ],\n        [ 0, 0, 7, 0, 0, 5, 0, 0, 0 ],\n    ];\n\n    if solve(&amp;mut board) {\n        for i in 0..9 {\n            println!(\"{:?}\", board[i]);\n        }\n    } else {\n        println!(\"no solution\");\n    }\n}\n</code></pre>\n\n<p>When running without optimizations (<code>cargo run</code>), it takes more than 6 minutes to run.</p>\n\n<p>When running with optimizations (<code>cargo run --release</code>), it takes about 7 seconds to run.</p>\n\n<p>What optimization is leading to such a difference?</p>\n"}, {"tags": ["c++", "rust", "bindgen"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548231162, "post_id": 54319681, "comment_id": 95463952, "body": "Question should self include everything to answer the question, a link to github is not enough. If you can&#39;t include it because it&#39;s too big your question is too broad, work on a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>."}, {"owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548243394, "post_id": 54319681, "comment_id": 95470995, "body": "I don&#39;t expect anyone to actually build the thing. I thought someone with bindgen experience would be able to tell me if I&#39;m missing a flag. I&#39;ll see to it."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548244022, "post_id": 54319681, "comment_id": 95471310, "body": "bindgen is not fully compatible with C++, also note that bindgen do &quot;the best guest&quot;, there is a lot of thing not specify in the C or C++ standard, so a lot of thing could be wrong."}, {"owner": {"reputation": 275, "user_id": 1028478, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/80db990e344a0df987e5a6055328f039?s=128&d=identicon&r=PG", "display_name": "Andrew Prentice", "link": "https://stackoverflow.com/users/1028478/andrew-prentice"}, "edited": false, "score": 0, "creation_date": 1548385648, "post_id": 54319681, "comment_id": 95531419, "body": "The layout test might fail but the library compiles. You can generate the bindings without layout tests by passing the proper flag."}, {"owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "edited": false, "score": 0, "creation_date": 1548386795, "post_id": 54319681, "comment_id": 95531624, "body": "The auto-generated tests all passes. It&#39;s a custom test that uses the bindings that fails."}], "answers": [{"tags": [], "owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "is_accepted": false, "score": 0, "last_activity_date": 1549425617, "creation_date": 1549425617, "answer_id": 54546414, "question_id": 54319681, "link": "https://stackoverflow.com/questions/54319681/rust-bindgen-bindings-raise-sigsegv/54546414#54546414", "title": "rust-bindgen bindings raise SIGSEGV", "body": "<p>This is caused by a bug in the rust-bindgen library as such I will close the question.</p>\n"}], "owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 163, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1549425617, "creation_date": 1548214588, "question_id": 54319681, "link": "https://stackoverflow.com/questions/54319681/rust-bindgen-bindings-raise-sigsegv", "title": "rust-bindgen bindings raise SIGSEGV", "body": "<p>I generated bindings to <a href=\"https://github.com/Microsoft/SEAL\" rel=\"nofollow noreferrer\">Microsoft SEAL C++ Library</a> using the <a href=\"https://github.com/rust-lang/rust-bindgen\" rel=\"nofollow noreferrer\">rust-bindgen</a> tool.</p>\n\n<p>My config:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// Generate the bindings\nlet bindings = bindgen::Builder::default()\n    .generate_inline_functions(true)\n    .derive_default(true)\n    .header(\"./seal/src/seal/seal.h\")\n    .clang_arg(\"-I./seal/src/\")\n    .clang_arg(\"-std=c++17\")\n    .clang_arg(\"-x\")\n    .clang_arg(\"c++\")\n    .opaque_type(\"std::.*\")\n    .whitelist_type(\"seal::.*\")\n    .whitelist_function(\"seal::.*\")\n    .generate()\n    .expect(\"Unable to generate bindings\");\n</code></pre>\n\n<p>The SEAL project is compiled using <a href=\"https://github.com/alexcrichton/cc-rs\" rel=\"nofollow noreferrer\">cc-rs</a> using this config:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut build = cc::Build::new();                \n    build.cpp(true);                                 \n    build.flag_if_supported(\"-std=c++17\");           \n    build.flag_if_supported(\"-march=native\");        \n    build.flag_if_supported(\"-fkeep-inline-functions\");                                                   \n    build.flag_if_supported(\"-fno-inline-functions\");\n    let base_path = Path::new(\"./seal/src/seal/\");   \n    let util_base_path = Path::new(\"./seal/src/seal/util/\");                                              \n    add_cpp_files(&amp;mut build, base_path);            \n    add_cpp_files(&amp;mut build, util_base_path);       \n    build.include(\"./seal/src\");                     \n    build.compile(\"seal\"); \n</code></pre>\n\n<p>But afterwards, when creating a new context (this is mostly SEAL-specific) using a <strong>static</strong> method I get a segmentation fault (SIGSEGV: invalid reference) which, I figured after debugging with <code>gdb</code> comes from when a pointer to a memory pool is copied.</p>\n\n<p>I was able to instantiate multiple regular objects (stuff that didn't have a static constructor) but it doesn't seem to work for SEALContext no matter what parameters I try.</p>\n\n<p>You can access my project <a href=\"https://github.com/Belval/seal-rs\" rel=\"nofollow noreferrer\">seal-rs here</a>. The whole thing is in the build script and clones the repo so <code>cargo test</code> should build and reproduce the error.</p>\n\n<p>My OS is Archlinux 64bit, the compiler used is clang 7.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1548207953, "post_id": 54318408, "comment_id": 95457530, "body": "<i>Each variant will have the same fields but will be differentiated by the values set.</i> \u2014 what stops you from just... doing that? <code>enum Foo { Type1 { pub a_symbol: &amp;&#39;static str, pub b_symbol: &amp;&#39;static str }, Type2 { pub a_symbol: &amp;&#39;static str, pub b_symbol: &amp;&#39;static str } }</code>?"}, {"owner": {"reputation": 5800, "user_id": 6163736, "user_type": "registered", "accept_rate": 25, "profile_image": "https://i.stack.imgur.com/TKHBG.jpg?s=128&g=1", "display_name": "stacksonstacks", "link": "https://stackoverflow.com/users/6163736/stacksonstacks"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548213094, "post_id": 54318408, "comment_id": 95458528, "body": "Maybe I&#39;m missing something but I &#39;d like the literal values in the variant declarations. Each type will basically be a constant"}], "answers": [{"tags": [], "owner": {"reputation": 33880, "user_id": 34813, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/16afab0e0815eb7203cda86555fd322a?s=128&d=identicon&r=PG", "display_name": "Esteban K&#252;ber", "link": "https://stackoverflow.com/users/34813/esteban-k%c3%bcber"}, "is_accepted": true, "score": 1, "last_activity_date": 1548207638, "last_edit_date": 1548207638, "creation_date": 1548204221, "answer_id": 54318481, "question_id": 54318408, "link": "https://stackoverflow.com/questions/54318408/is-there-some-mental-model-or-pattern-i-m-missing-to-adapt-a-type-with-various-i/54318481#54318481", "title": "Is there some mental model or pattern I\u2019m missing to adapt a type with various immutable forms which needs more complex fields?", "body": "<p>You will have to rely on composition:</p>\n\n<pre><code>pub struct TypeDataInner {\n    pub a_symbol: &amp;'static str,\n    pub b_symbol: &amp;'static str,\n    pub c_symbol: &amp;'static str,\n}\n\npub enum TypeData {\n    Type1(TypeDataInner),\n    Type2(TypeDataInner),\n}\n\nimpl TypeData {\n    pub fn type1() -&gt; TypeData {\n        TypeData::Type1(TypeDataInner {\n            // ...\n        }\n    }\n\n    pub fn type2() -&gt; TypeData {\n        TypeData::Type2(TypeDataInner {\n            // ...\n        }\n    }\n}\n</code></pre>\n\n<p>Another option is to use <a href=\"https://doc.rust-lang.org/core/marker/struct.PhantomData.html\" rel=\"nofollow noreferrer\"><code>PhantomData</code></a> which <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=367bf0d7c60d481cd0519e79095768f2\" rel=\"nofollow noreferrer\">will encode type information that gets erased after compilation</a>:</p>\n\n<pre><code>pub struct TypeData&lt;Type&gt; {\n    pub a_symbol: &amp;'static str,\n    pub b_symbol: &amp;'static str,\n    pub c_symbol: &amp;'static str,\n    _type: core::marker::PhantomData&lt;Type&gt;,\n}\n\nimpl&lt;T&gt; TypeData&lt;T&gt; {\n    pub fn type_t() -&gt; TypeData&lt;T&gt; {\n        TypeData {\n            a_symbol: \"\",\n            b_symbol: \"\",\n            c_symbol: \"\",\n            _type: core::marker::PhantomData,\n        }\n    }\n}\n\nstruct Tr;\n\nfn main() {\n    TypeData::&lt;Tr&gt;::type_t();\n}\n</code></pre>\n"}], "owner": {"reputation": 5800, "user_id": 6163736, "user_type": "registered", "accept_rate": 25, "profile_image": "https://i.stack.imgur.com/TKHBG.jpg?s=128&g=1", "display_name": "stacksonstacks", "link": "https://stackoverflow.com/users/6163736/stacksonstacks"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 82, "favorite_count": 0, "closed_date": 1548244031, "accepted_answer_id": 54318481, "answer_count": 1, "score": 1, "last_activity_date": 1548208176, "creation_date": 1548203526, "last_edit_date": 1548208176, "question_id": 54318408, "link": "https://stackoverflow.com/questions/54318408/is-there-some-mental-model-or-pattern-i-m-missing-to-adapt-a-type-with-various-i", "closed_reason": "Needs details or clarity", "title": "Is there some mental model or pattern I\u2019m missing to adapt a type with various immutable forms which needs more complex fields?", "body": "<p>I\u2019m trying to represent a type which can have various immutable forms (sounds like an enum) but needs more complex fields.</p>\n\n<p>Each variant will have the same fields but will be differentiated by the values set.</p>\n\n<p>The current implementation uses a different constructor to return an instance of a given type, however there\u2019s no type information encoded in the struct itself.</p>\n\n<p>I seem to find myself coming back to <a href=\"https://internals.rust-lang.org/t/impl-trait-for-enum-variant/4131\" rel=\"nofollow noreferrer\">this RFC</a> with similar problems.</p>\n\n<p>Is there some mental model or pattern I\u2019m missing to adapt this in Rust?</p>\n\n<pre><code>pub struct TypeData {\n    pub a_symbol: &amp;'static str,\n    pub b_symbol: &amp;'static str,\n    pub c_symbol: &amp;'static str,\n}\n\nimpl TypeData {\n    pub fn type1() -&gt; TypeData {\n        TypeData  {\n            // ...\n        }\n    }\n\n    pub fn type2() -&gt; TypeData {\n        TypeData {\n            // ...\n        }\n    }\n}\n</code></pre>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 7, "last_activity_date": 1548203096, "last_edit_date": 1548203096, "creation_date": 1548202689, "answer_id": 54318314, "question_id": 54318218, "link": "https://stackoverflow.com/questions/54318218/why-can-i-still-use-a-variable-captured-by-a-move-closure/54318314#54318314", "title": "Why can I still use a variable captured by a `move` closure?", "body": "<blockquote>\n  <p>What does the <code>move</code> actually do here?</p>\n</blockquote>\n\n<p>It moves the variable into the closure.</p>\n\n<blockquote>\n  <p>I can still use <code>a</code> after the closure</p>\n</blockquote>\n\n<p><code>a</code> is a <code>&amp;'static char</code> which implements <code>Copy</code>. The compiler automatically inserts a copy of the value when you use it after it was moved.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/29490670/155423\">How does Rust provide move semantics?</a></li>\n<li><a href=\"https://stackoverflow.com/q/30288782/155423\">What are move semantics in Rust?</a></li>\n<li><a href=\"https://stackoverflow.com/q/24253344/155423\">Is it possible to make a type only movable and not copyable?</a></li>\n</ul>\n"}], "owner": {"reputation": 4849, "user_id": 3234803, "user_type": "registered", "accept_rate": 65, "profile_image": "https://i.stack.imgur.com/FEjsw.png?s=128&g=1", "display_name": "Zizheng Tai", "link": "https://stackoverflow.com/users/3234803/zizheng-tai"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 55, "favorite_count": 0, "accepted_answer_id": 54318314, "answer_count": 1, "score": 3, "last_activity_date": 1548203096, "creation_date": 1548201761, "last_edit_date": 1548202476, "question_id": 54318218, "link": "https://stackoverflow.com/questions/54318218/why-can-i-still-use-a-variable-captured-by-a-move-closure", "title": "Why can I still use a variable captured by a `move` closure?", "body": "<p>I wrote a Rust program that generates all the two-letter permutations of lower-case English letters (\"aa\", \"ab\", ..., \"zy\", \"zz\"):</p>\n\n<pre><code>fn main() {\n    static ASCII_LOWER: [char; 26] = [\n        'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',\n        'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'\n    ];\n\n    let x: Vec&lt;_&gt; = ASCII_LOWER.iter().flat_map(|a| {\n        let result = ASCII_LOWER.iter().map(move |b| {\n            format!(\"{}{}\", a, b)\n        });\n\n        dbg!(a);  // &lt;--- How can `a` still be used?\n\n        result\n    }).collect();\n\n    dbg!(x);\n}\n</code></pre>\n\n<p>I need to mark the inner closure as <code>move</code>, because otherwise the captured borrow of <code>a</code> doesn't live long enough. However, I don't understand what this <code>move</code> actually does in this case. I can still use <code>a</code> after the closure. What does the <code>move</code> actually do here?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548200647, "post_id": 54317987, "comment_id": 95455903, "body": "<i>I want to avoid copying data for no reason</i> \u2014 do your C++ or Swift versions &quot;avoid copying data&quot;? What do you mean by that in the first place?"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1548200730, "post_id": 54317987, "comment_id": 95455933, "body": "I don&#39;t understand understand what you ask."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548200834, "post_id": 54317987, "comment_id": 95455953, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/53161339/155423\">How do I use the byteorder crate to read a usize?</a> / <a href=\"https://stackoverflow.com/q/29307474/155423\">How can I convert a buffer of a slice of bytes (&amp;&#91;u8&#93;) to an integer?</a> / <a href=\"https://stackoverflow.com/q/29445026/155423\">Converting number primitives (i32, f64, etc) to byte representations</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/54317987/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548200868, "post_id": 54317987, "comment_id": 95455965, "body": "TL;DR the duplicates: <a href=\"https://crates.io/crates/byteorder\" rel=\"nofollow noreferrer\">byteorder</a>."}, {"owner": {"reputation": 13, "user_id": 4093137, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-vPC-bV2e4Kw/AAAAAAAAAAI/AAAAAAAAACQ/DtKe2Oif8js/photo.jpg?sz=128", "display_name": "Patrick Metcalfe", "link": "https://stackoverflow.com/users/4093137/patrick-metcalfe"}, "edited": false, "score": 0, "creation_date": 1548201567, "post_id": 54317987, "comment_id": 95456175, "body": "Well I was hoping to do it without byteorder though if this counts as a duplicate because that library exists then I understand."}, {"owner": {"reputation": 13, "user_id": 4093137, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-vPC-bV2e4Kw/AAAAAAAAAAI/AAAAAAAAACQ/DtKe2Oif8js/photo.jpg?sz=128", "display_name": "Patrick Metcalfe", "link": "https://stackoverflow.com/users/4093137/patrick-metcalfe"}, "edited": false, "score": 0, "creation_date": 1548201626, "post_id": 54317987, "comment_id": 95456189, "body": "And Swift and C++ versions don&#39;t create an intermediary array that I am aware of so there&#39;d be no buffer. Plus I imagine for performance using one buffer and constantly reading from that is a bad idea."}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548201989, "post_id": 54317987, "comment_id": 95456302, "body": "what do you mean ? you think C++ don&#39;t use a read buffer ? If so you wrong"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548202128, "post_id": 54317987, "comment_id": 95456338, "body": "<i>I was hoping to do it without byteorder</i> \u2014 why? <i>Swift and C++ versions don&#39;t create an intermediary array</i> \u2014 neither does a Rust version, by default. You&#39;ve chosen to introduce a buffer, however (<code>BufReader</code>). <i>for performance using one buffer and constantly reading from that is a bad idea</i> \u2014 that&#39;s actually usually <b>more</b> performant and is basically the reason that <code>BufReader</code> exists: to increase performance."}], "owner": {"reputation": 13, "user_id": 4093137, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-vPC-bV2e4Kw/AAAAAAAAAAI/AAAAAAAAACQ/DtKe2Oif8js/photo.jpg?sz=128", "display_name": "Patrick Metcalfe", "link": "https://stackoverflow.com/users/4093137/patrick-metcalfe"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 52, "favorite_count": 0, "closed_date": 1548235612, "answer_count": 0, "score": 0, "last_activity_date": 1548202150, "creation_date": 1548199935, "last_edit_date": 1548202150, "question_id": 54317987, "link": "https://stackoverflow.com/questions/54317987/read-structured-numbers-from-file-stream", "closed_reason": "Duplicate", "title": "Read structured numbers from file stream", "body": "<p>I have a file format which I have read in many different languages and need to add rust support. In this file format there are blobs of structured data of the format</p>\n\n<pre><code>struct Widget {\n    pub number_of_screws: u32,\n    pub number_of_nails: u32,\n    pub number_of_thingys: u16,\n}\n\nstruct WidgetFile {\n    pub widgets: Vec&lt;Widget&gt;,\n}\n</code></pre>\n\n<p>I want to read these efficiently. In C++, I can read a <code>u32</code> easily from a stream. In Swift I can easily read one from <code>Data</code> but in Rust I'm not sure the best way to do it because I want to avoid copying data for no reason.</p>\n\n<p>Here's what I have:</p>\n\n<pre><code>pub fn read_widgets() -&gt; WidgetFile {\n    let f = File::open(\"foo.widgetfile\").expect(\"file\");\n    let reader = BufReader::new(f);\n    // Somehow read bytes into a variable called buffer\n    let number_of_widgets = u32::read_from_bytes(buffer);\n}\n</code></pre>\n\n<p>How do I read a single <code>u32</code>, <code>u32</code>, and <code>u16</code> over and over again from <code>reader</code> and not keep consuming the buffer?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 3467, "user_id": 3393308, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9a3f30f7c191e8d556c70c951fe3d9af?s=128&d=identicon&r=PG", "display_name": "yorodm", "link": "https://stackoverflow.com/users/3393308/yorodm"}, "edited": false, "score": 0, "creation_date": 1548196039, "post_id": 54317322, "comment_id": 95454555, "body": "<a href=\"https://doc.rust-lang.org/rust-by-example/trait/clone.html\" rel=\"nofollow noreferrer\">See this entry in RBE book</a>"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 4, "creation_date": 1548196452, "post_id": 54317322, "comment_id": 95454687, "body": "<i>&quot;Can I do this without using either Copy, and Clone traits?&quot;</i> It doesn&#39;t sound reasonable not to use these traits to make copies. Can you provide additional context around your concern? What is your current attempt at creating these copies?"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548196631, "post_id": 54317322, "comment_id": 95454739, "body": "You can&#39;t copy a <code>string</code>, use clone"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548198284, "post_id": 54317322, "comment_id": 95455265, "body": "Is it guaranteed that all the fields are public and  implement Clone or Copy and there\u2019s a public constructor?"}, {"owner": {"reputation": 13, "user_id": 7123500, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Rwa59.jpg?s=128&g=1", "display_name": "PrinceCornNM", "link": "https://stackoverflow.com/users/7123500/princecornnm"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548199001, "post_id": 54317322, "comment_id": 95455468, "body": "@Shepmaster I think all fields are public and implement Copy and there&#39;s a public constructor."}, {"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 6, "creation_date": 1548200297, "post_id": 54317322, "comment_id": 95455823, "body": "It seems like the question is, why aren&#39;t they already <code>Clone</code>? Can you just file a bug with the existing library?"}], "answers": [{"tags": [], "owner": {"reputation": 573, "user_id": 9946772, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19b5785ce8af233b264c6f7fb66977e5?s=128&d=identicon&r=PG&f=1", "display_name": "kangalioo", "link": "https://stackoverflow.com/users/9946772/kangalioo"}, "is_accepted": true, "score": 0, "last_activity_date": 1548259342, "creation_date": 1548259342, "answer_id": 54331191, "question_id": 54317322, "link": "https://stackoverflow.com/questions/54317322/how-do-i-clone-structs-in-rust-without-using-either-copy-or-clone/54331191#54331191", "title": "How do I clone structs in Rust without using either Copy or Clone?", "body": "<p>A unit struct contains no data, so a \"deep copy\" would be just another instance of it: <code>let thing_clone = Thing;</code></p>\n\n<p>For the other types, you'd just manually clone the fields and create a new object out of the cloned fields. Assuming there is a <code>new</code> method for both <code>Thingy</code> and <code>Location</code>:</p>\n\n<pre><code>let thingy_clone = Thingy::new(thingy.0, thingy.1);\n\nlet location_clone = Location::new(location.name.clone(), location.code);\n</code></pre>\n\n<p>Note that I only explicitly wrote <code>.clone()</code> for the String field. That is because u8 and i32 implement <code>Copy</code> and will therefore be automatically copied, when needed. No explicit copying/cloning required.</p>\n\n<p>That said, it's definitely more idiomatic to use the <code>Clone</code> trait. If <code>Thing</code>, <code>Thingy</code> and <code>Location</code> are part of an external library, you could file a bug report, asking for <code>Clone</code> to be implemented for those structs.</p>\n"}], "owner": {"reputation": 13, "user_id": 7123500, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Rwa59.jpg?s=128&g=1", "display_name": "PrinceCornNM", "link": "https://stackoverflow.com/users/7123500/princecornnm"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1998, "favorite_count": 0, "accepted_answer_id": 54331191, "answer_count": 1, "score": -1, "last_activity_date": 1548259342, "creation_date": 1548195656, "last_edit_date": 1548200416, "question_id": 54317322, "link": "https://stackoverflow.com/questions/54317322/how-do-i-clone-structs-in-rust-without-using-either-copy-or-clone", "title": "How do I clone structs in Rust without using either Copy or Clone?", "body": "<p>How do I create deep copies of each of these three styles of structs?</p>\n\n<pre><code>// A unit struct\nstruct Thing;\n\n// A tuple struct\nstruct Thingy(u8, i32);\n\n// regular\nstruct Location {\n    name: String,\n    code: i32,\n}\n</code></pre>\n\n<p>Can I do this without using either the <code>Copy</code> or <code>Clone</code> traits? If a struct is already defined and doesn't have these trait implemented, is there a work-around?</p>\n\n<pre><code>// without this:\n#[derive(Copy, Clone)]\nstruct Location {\n    name: String,\n    code: i32,\n}\n</code></pre>\n"}, {"tags": ["javascript", "webpack", "rust", "webassembly"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1548194035, "post_id": 54316931, "comment_id": 95453905, "body": "<i>and host the generated files directly</i> \u2014 <b>how</b> do you host them? Look at the MIME type of the files in your browser&#39;s network inspector in both cases; presumably they differ. Then figure out why they don&#39;t match. Then figure out how to make them match."}, {"owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548194534, "post_id": 54316931, "comment_id": 95454097, "body": "For how I host them, I have tried both a bare bones <code>express.js</code> server to statically host the directory webpack exports to, as well as accessing the files directly through <code>file:&#47;&#47;&#47;</code>. I get the same error in both cases."}, {"owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548194736, "post_id": 54316931, "comment_id": 95454171, "body": "For the network inspector, everything shows to have been successful. I&#39;m not sure exactly how webpack works, but in reality there are no <code>index.js</code> or <code>bootstrap.js</code> files. There are only <code>bundle.js</code>, <code>1.bundle.js</code>, and one seemingly randomly named <code>.module.wasm</code> file. All show to have been acquired successfully."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1548194847, "post_id": 54316931, "comment_id": 95454199, "body": "I&#39;d expect the network transfer to be fine. What do the headers of those files say the MIME types are in the cases it works and doesn&#39;t?"}, {"owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548195353, "post_id": 54316931, "comment_id": 95454351, "body": "For <code>.js</code> the content-type is <code>application&#47;javascript</code>, and for the <code>module.wasm</code> file it is <code>application&#47;octet-stream</code>."}, {"owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548195397, "post_id": 54316931, "comment_id": 95454369, "body": "I have also found chrome gives a slightly more detailed error: <code>TypeError: Failed to execute &quot;compile&quot; on &quot;WebAssembly&quot;: Incorrect response MIME type. Expected &quot;application&#47;wasm&quot;</code>"}, {"owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548195480, "post_id": 54316931, "comment_id": 95454395, "body": "I think that may be enough to get me to the solution. I will give an update if I can get things working from here."}], "answers": [{"tags": [], "owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "is_accepted": true, "score": 7, "last_activity_date": 1548258699, "last_edit_date": 1548258699, "creation_date": 1548222430, "answer_id": 54320709, "question_id": 54316931, "link": "https://stackoverflow.com/questions/54316931/why-do-i-get-the-error-response-has-unsupported-mime-type-after-bundling-wasm/54320709#54320709", "title": "Why do I get the error &quot;Response has unsupported MIME type&quot; after bundling Wasm together, but not when serving with the webpack dev server?", "body": "<p>As <a href=\"https://stackoverflow.com/users/155423/shepmaster\">Shepmaster</a> helped me to figure out in the comments, the MIME type of the .wasm file is being set to <code>application/octet-stream</code> when the browser expects it to be <code>application/wasm</code>.</p>\n\n<p>I am using a simple <a href=\"https://expressjs.com/\" rel=\"noreferrer\">express</a> server to host my files. Express can be configured to use the correct MIME type with a single line.</p>\n\n<pre><code>var express = require('express');\nvar app = express();\n\n// Set the MIME type explicitly\nexpress.static.mime.define({'application/wasm': ['wasm']});\n\napp.use(express.static('./dist'));\n\napp.listen(3000);\n</code></pre>\n\n<p>According to <a href=\"https://github.com/expressjs/express/issues/3589\" rel=\"noreferrer\">this issue</a>, express will handle .wasm files correctly after version 4.17. It works correctly in webpack dev server because they implemented their own <a href=\"https://github.com/webpack/webpack-dev-server/pull/1580\" rel=\"noreferrer\">workaround</a> while they wait for the fix in express.</p>\n"}, {"comments": [{"owner": {"reputation": 490, "user_id": 5322506, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/706cb330de139e4f5423ee1702c3167d?s=128&d=identicon&r=PG&f=1", "display_name": "my-", "link": "https://stackoverflow.com/users/5322506/my"}, "edited": false, "score": 1, "creation_date": 1574279891, "post_id": 58962367, "comment_id": 104179970, "body": "All credit goes to Discord Rust channel user <code>@Pauan</code>"}], "tags": [], "owner": {"reputation": 490, "user_id": 5322506, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/706cb330de139e4f5423ee1702c3167d?s=128&d=identicon&r=PG&f=1", "display_name": "my-", "link": "https://stackoverflow.com/users/5322506/my"}, "is_accepted": false, "score": 4, "last_activity_date": 1574280169, "last_edit_date": 1574280169, "creation_date": 1574279724, "answer_id": 58962367, "question_id": 54316931, "link": "https://stackoverflow.com/questions/54316931/why-do-i-get-the-error-response-has-unsupported-mime-type-after-bundling-wasm/58962367#58962367", "title": "Why do I get the error &quot;Response has unsupported MIME type&quot; after bundling Wasm together, but not when serving with the webpack dev server?", "body": "<p>I had a similar problem (\"Response has unsupported MIME type\") with Flask. The problem was that I <strong>didn't</strong> have a separate route to the <code>.wasm</code> file. For example:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>@app.route('/path/to/file.wasm')\ndef wasm_file():\n    return send_file('/path/to/file.wasm', mimetype = 'application/wasm');\n</code></pre>\n\n<p>It is not the answer to this question, but it's a hint for other people who have a similar problem.</p>\n"}, {"tags": [], "owner": {"reputation": 182, "user_id": 11116081, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/JC4bb.png?s=128&g=1", "display_name": "Gabe Nodarse", "link": "https://stackoverflow.com/users/11116081/gabe-nodarse"}, "is_accepted": false, "score": 2, "last_activity_date": 1578454075, "creation_date": 1578454075, "answer_id": 59639022, "question_id": 54316931, "link": "https://stackoverflow.com/questions/54316931/why-do-i-get-the-error-response-has-unsupported-mime-type-after-bundling-wasm/59639022#59639022", "title": "Why do I get the error &quot;Response has unsupported MIME type&quot; after bundling Wasm together, but not when serving with the webpack dev server?", "body": "<p>I also encountered this problem, leading me to change my .htaccess file (I'm using Apache to host my local server) to include the following:\n<code>AddType application/wasm wasm</code></p>\n\n<p>If the error persists, and you are getting this error from using <code>WebAssembly.instantiateStreaming</code>, this related question may have an explanation and workaround: <a href=\"https://stackoverflow.com/questions/52239924/webassembly-instantiatestreaming-wrong-mime-type\">WebAssembly InstantiateStreaming Wrong MIME type</a></p>\n"}], "owner": {"reputation": 4217, "user_id": 9614249, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/eJfci.png?s=128&g=1", "display_name": "Increasingly Idiotic", "link": "https://stackoverflow.com/users/9614249/increasingly-idiotic"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2456, "favorite_count": 2, "accepted_answer_id": 54320709, "answer_count": 3, "score": 9, "last_activity_date": 1578454075, "creation_date": 1548193629, "last_edit_date": 1574283754, "question_id": 54316931, "link": "https://stackoverflow.com/questions/54316931/why-do-i-get-the-error-response-has-unsupported-mime-type-after-bundling-wasm", "title": "Why do I get the error &quot;Response has unsupported MIME type&quot; after bundling Wasm together, but not when serving with the webpack dev server?", "body": "<p>I am trying to make a Rust WebAssembly project and have modified the <a href=\"https://github.com/rustwasm/rust-webpack-template\" rel=\"noreferrer\">rust-webpack-template</a> as my starting point. The template is a webpack project with a JavaScript file that calls a single Wasm function and the Rust Wasm takes over from there.</p>\n\n<p>I have modified the template  because I would like to have my main logic in JavaScript and call the Rust Wasm through an API.</p>\n\n<p>I have changed the webpack entry to <code>bootstrap.js</code> shown below.</p>\n\n<pre><code>// bootstrap.js\nimport(\"./index.js\").catch(e =&gt; \n    console.error(\"Error importing 'index.js':\", e)\n);\n</code></pre>\n\n<p>I added the file <code>index.js</code> and it calls the Rust Wasm functions</p>\n\n<pre><code>// index.js\nimport * as wasm from \"../crate/pkg/rust_webpack\";\n\nconst title = document.getElementById(\"msg\");\n\ntitle.innerText = wasm.get_msg();\n</code></pre>\n\n<p>The <code>get_msg</code> function from Rust looks like this:</p>\n\n<pre><code>#[wasm_bindgen]\npub fn get_msg() -&gt; String {\n    \"Hello from Rust WebAssembly!\".to_owned()\n}\n</code></pre>\n\n<p>When I run the project using <code>webpack-dev-server -d</code>, everything works fine.</p>\n\n<p>However, when I build the project using <code>webpack</code> and try and host the generated files directly, nothing is displayed and the browser console displays the error:</p>\n\n<blockquote>\n  <p>Error importing 'index.js': TypeError: \"Response has unsupported MIME type\"</p>\n</blockquote>\n\n<p>This error comes from the code in <code>bootstrap.js</code> but I'm not entirely sure what it means or how to fix this error. </p>\n\n<p>Why do things work when serving with the webpack dev server but not after bundling everything together?</p>\n"}, {"tags": ["pointers", "rust", "type-conversion"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548193079, "post_id": 54316645, "comment_id": 95453523, "body": "<i>Is it a two-step conversion</i> \u2014 I&#39;m having trouble imagining what <i>else</i> it could be... what other possibilities do you see?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 1, "creation_date": 1548230242, "post_id": 54316645, "comment_id": 95463519, "body": "Note that this is not strictly speaking a <i>conversion</i>: the data is not modified by it and the compiler doesn&#39;t emit any code for it. It&#39;s more a <i>reinterpretation</i>: it changes the way the compiler looks at the data and the set of operations that can be applied to the data without changing the data itself."}], "answers": [{"tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 2, "last_activity_date": 1548239478, "creation_date": 1548239478, "answer_id": 54325160, "question_id": 54316645, "link": "https://stackoverflow.com/questions/54316645/how-does-converting-the-primitive-str-through-multiple-as-casts-work/54325160#54325160", "title": "How does converting the primitive str through multiple &quot;as&quot; casts work?", "body": "<p>In Rust, the <code>as</code> operator allows converting by <em>one</em> step at a time.</p>\n\n<p>There are a few conversions allowed, such as:</p>\n\n<ul>\n<li><code>&amp;T</code> to <code>*const T</code>,</li>\n<li><code>&amp;mut T</code> to <code>*mut T</code>,</li>\n<li><code>*mut T</code> to <code>*mut U</code> (pending some conditions on T and U),</li>\n<li>...</li>\n</ul>\n\n<p>However, even though you can go <code>&amp;mut T</code> to <code>*mut T</code> to <code>*mut U</code> using <code>as</code> twice, you cannot go directly from <code>&amp;mut T</code> to <code>*mut U</code>; both because compiler and humans would have a hard time figuring out the intermediate steps.</p>\n\n<hr>\n\n<p>So, what's this conversion sequence about?</p>\n\n<ul>\n<li>Going from reference to pointer: typical <code>&amp;T</code> to <code>*const T</code>, or the <code>mut</code> variant.</li>\n<li>Going from pointer to <code>str</code> to pointer to <code>[u8]</code>: a typical <code>*const T</code> to <code>*const U</code> for adequates <code>T</code> and <code>U</code>. <code>str</code> actually has the same representation as <code>[u8]</code>, but only a subset of values are valid (proper UTF-8 ones).</li>\n</ul>\n\n<p>It's interesting to note that one is safe and not the other:</p>\n\n<ul>\n<li>Since all <code>str</code> are <code>[u8]</code>, converting from <code>*str</code> to <code>*[u8]</code> is always safe.</li>\n<li>However, exposing <code>&amp;mut [u8]</code> allows breaking invariants inside <code>str</code>, and therefore <code>as_bytes_mut</code> is <code>unsafe</code>.</li>\n</ul>\n"}], "owner": {"reputation": 193, "user_id": 7064254, "user_type": "registered", "accept_rate": 0, "profile_image": "https://www.gravatar.com/avatar/39659e3b48aaf1e30eb206ab7ed31794?s=128&d=identicon&r=PG&f=1", "display_name": "Aperion", "link": "https://stackoverflow.com/users/7064254/aperion"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 64, "favorite_count": 0, "accepted_answer_id": 54325160, "answer_count": 1, "score": 0, "last_activity_date": 1548239478, "creation_date": 1548192220, "last_edit_date": 1548192886, "question_id": 54316645, "link": "https://stackoverflow.com/questions/54316645/how-does-converting-the-primitive-str-through-multiple-as-casts-work", "title": "How does converting the primitive str through multiple &quot;as&quot; casts work?", "body": "<p>Here is what I found in Rust's <a href=\"https://github.com/rust-lang/rust/blob/96909179d9ec80db286605876ce67659dd16fd4b/src/libcore/str/mod.rs\" rel=\"nofollow noreferrer\">source code</a>. I have difficulty in understanding <code>&amp;mut *(self as *mut str as *mut [u8])</code> and <code>self as *const str as *const u8</code>.</p>\n\n<p>Is it a two-step conversion? First convert to a <code>*mut str</code> or <code>*const str</code>, next as a <code>*mut [u8]</code> or <code>*const u8</code>?</p>\n\n<pre><code>#[stable(feature = \"str_mut_extras\", since = \"1.20.0\")]\n#[inline(always)]\npub unsafe fn as_bytes_mut(&amp;mut self) -&gt; &amp;mut [u8] {\n    &amp;mut *(self as *mut str as *mut [u8])\n}\n#[stable(feature = \"rust1\", since = \"1.0.0\")]\n#[inline]\npub const fn as_ptr(&amp;self) -&gt; *const u8 {\n    self as *const str as *const u8\n}\n</code></pre>\n"}, {"tags": ["rust", "cryptography"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548178717, "post_id": 54313465, "comment_id": 95447344, "body": "I suspect you just don&#39;t have enough ciphertext / have picked a ciphertext that highlights a potential flaw of this algorithm. Two blocks of text encrypted with the same key are <i>likely</i> to have a lower Hamming distance than those encrypted with different keys, but it&#39;s not <i>guaranteed</i>. You may need a lot of ciphertext to know whether a key size with low normalized Hamming distance is statistically significant or not."}, {"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1548180006, "post_id": 54313465, "comment_id": 95447909, "body": "What&#39;s the <code>&#47; KEYSIZE as u64</code> good for?"}, {"owner": {"reputation": 246, "user_id": 4286300, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/beee74edca1edd54a08ca79082b535b2?s=128&d=identicon&r=PG&f=1", "display_name": "nom", "link": "https://stackoverflow.com/users/4286300/nom"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1548181797, "post_id": 54313465, "comment_id": 95448719, "body": "@AndreyTyukin The <code>&#47;</code> operator expects arguments of the same type on both sides. <code>get_hamming_distance()</code> returns a u64 so that&#39;s why."}, {"owner": {"reputation": 246, "user_id": 4286300, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/beee74edca1edd54a08ca79082b535b2?s=128&d=identicon&r=PG&f=1", "display_name": "nom", "link": "https://stackoverflow.com/users/4286300/nom"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548181953, "post_id": 54313465, "comment_id": 95448809, "body": "@trentcl The challenge (<a href=\"https://cryptopals.com/sets/1/challenges/6\" rel=\"nofollow noreferrer\">cryptopals.com/sets/1/challenges/6</a>) specifically provides the steps to solve this, I&#39;ll try using a larger ciphertext though."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1548183164, "post_id": 54313465, "comment_id": 95449333, "body": "And it suggests using the smallest 2-3 normalized distances, or using more than two blocks and finding the smallest average distance, to mitigate the problem I think you&#39;re seeing."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548185998, "post_id": 54313465, "comment_id": 95450566, "body": "@nom I interpret Andrey Tyukin&#39;s question as &quot;why are you dividing at all&quot; (or at least that&#39;s what I&#39;d like to know)"}, {"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 4, "creation_date": 1548187764, "post_id": 54313465, "comment_id": 95451333, "body": "@Shepmaster No, I asked specifically why OP is performing an integer division with <code>u64</code> instead of casting both numbers to <code>f32</code> or <code>f64</code>. The division is necessary, because they use something like &quot;the average number of wrong bits per byte&quot; as heuristic, without the division / normalization the smallest <code>KEYSIZE</code> would always win. But right now, integer division only introduces noise and rounding errors. @OP: I think the hint <i>&quot;Or take 4 KEYSIZE blocks instead of 2 and average the distances.&quot;</i> is there for a good reason, the task feels as if it would require that kind of tweaking."}, {"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 1, "creation_date": 1548188342, "post_id": 54313465, "comment_id": 95451584, "body": "...and by the way: <code>u64</code>, for hamming distance between two blocks with few hundred bytes max? Seems a bit excessive."}, {"owner": {"reputation": 246, "user_id": 4286300, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/beee74edca1edd54a08ca79082b535b2?s=128&d=identicon&r=PG&f=1", "display_name": "nom", "link": "https://stackoverflow.com/users/4286300/nom"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1548251474, "post_id": 54313465, "comment_id": 95475523, "body": "@AndreyTyukin Thank you, I&#39;ll change that to a f64. And that <code>u64</code> is surely excessive, I don&#39;t know why I chose that, I&#39;ll fix it. And let me change my algorithm and I&#39;ll get back to you."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1549168294, "post_id": 54313465, "comment_id": 95804735, "body": "I&#39;m voting to close this question as off-topic because it doesn&#39;t adequately describe the correct behavior; it&#39;s my opinion that the code does not have a bug (but it may not be the algorithm you wanted to write)."}], "owner": {"reputation": 246, "user_id": 4286300, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/beee74edca1edd54a08ca79082b535b2?s=128&d=identicon&r=PG&f=1", "display_name": "nom", "link": "https://stackoverflow.com/users/4286300/nom"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 256, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1548251435, "creation_date": 1548177836, "last_edit_date": 1548251435, "question_id": 54313465, "link": "https://stackoverflow.com/questions/54313465/cryptopals-challenge-6-incorrect-results-when-computing-key-size", "title": "Cryptopals challenge 6 incorrect results when computing key size", "body": "<p>I'm working on the <a href=\"https://cryptopals.com/sets/1/challenges/6\" rel=\"nofollow noreferrer\">Cryptopals challenges</a> and I'm stuck on challenge 6. I've written the following Rust code to compute key sizes as specified in the challenge and I'm getting weird results.</p>\n\n<pre><code>fn get_keysizes(mut ciphertext: Vec&lt;u8&gt;) -&gt; Vec&lt;(usize, u64)&gt; {\n    let mut sizelist: Vec&lt;(usize, u64)&gt; = Vec::new();\n\n    for keysize in 2..41 {\n        let blocks: Vec&lt;&amp;[u8]&gt; = ciphertext.chunks(keysize).collect();\n        sizelist.push((keysize, get_hamming_distance(blocks[0], blocks[1]) / keysize as u64));\n    }\n    sizelist.sort_by(|x, y| x.1.cmp(&amp;y.1));\n    println!(\"{:?}\", sizelist);\n    sizelist\n}\n</code></pre>\n\n<p>I encrypted the string <code>For each KEYSIZE, take the first KEYSIZE worth of bytes, and the second KEYSIZE worth of bytes, and find the edit distance between them. Normalize this result by dividing by KEYSIZE.</code> with repeating key XOR using <code>the cryptopals crypto challenges</code> as the key and passed the ciphertext into my function and it computed the key length to be 3.</p>\n\n<p>Even though I've followed the algorithm in the challenge, I may have misinterpreted it.</p>\n\n<p>I have no idea why its not working, I've read a lot of articles on how to solve this challenge but none of them follow the algorithm in the challenge.</p>\n"}, {"tags": ["rust", "tuples", "semantics", "operator-precedence", "language-specifications"], "answers": [{"comments": [{"owner": {"reputation": 1473, "user_id": 204305, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/4fa6165d3bcb50e58e60304807f4090a?s=128&d=identicon&r=PG", "display_name": "Sage Mitchell", "link": "https://stackoverflow.com/users/204305/sage-mitchell"}, "edited": false, "score": 0, "creation_date": 1548266516, "post_id": 54313564, "comment_id": 95483870, "body": "Thanks, this seems to be a common enough pattern in the compiler itself so I won&#39;t feel too bad about repeating it. <code>rg &quot;match \\(.*,.*\\(\\)&quot;</code> turned up some examples including this match in <a href=\"https://github.com/rust-lang/rust/blob/master/src/libserialize/json.rs#L1693-L1696\" rel=\"nofollow noreferrer\">src/libserialize/json.rs</a>."}, {"owner": {"reputation": 1473, "user_id": 204305, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/4fa6165d3bcb50e58e60304807f4090a?s=128&d=identicon&r=PG", "display_name": "Sage Mitchell", "link": "https://stackoverflow.com/users/204305/sage-mitchell"}, "edited": false, "score": 1, "creation_date": 1548268048, "post_id": 54313564, "comment_id": 95484601, "body": "Tuple element ordering is preserved in <a href=\"https://github.com/rust-lang/rust/blob/6bba352cad2117f56353d400f71e96eafa2e6bd7/src/librustc/hir/lowering.rs#L3763-L3764\" rel=\"nofollow noreferrer\">translation to HIR</a>.  Then after translation from <a href=\"https://github.com/rust-lang/rust/blob/6bba352cad2117f56353d400f71e96eafa2e6bd7/src/librustc_mir/hair/cx/expr.rs#L782\" rel=\"nofollow noreferrer\">HIR to HAIR</a> tuples may be <a href=\"https://github.com/rust-lang/rust/blob/6bba352cad2117f56353d400f71e96eafa2e6bd7/src/librustc_mir/build/expr/as_rvalue.rs#L206-L214\" rel=\"nofollow noreferrer\">evaluated left-to-right</a> to produce a MIR Rvalue."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 10, "last_activity_date": 1548178758, "last_edit_date": 1548178758, "creation_date": 1548178210, "answer_id": 54313564, "question_id": 54313350, "link": "https://stackoverflow.com/questions/54313350/what-is-the-evaluation-order-of-tuples-in-rust/54313564#54313564", "title": "What is the evaluation order of tuples in Rust?", "body": "<p>Yes, the order of evaluation for tuples is guaranteed to be left-to-right (which also implies depth-first, as the value must be fully constructed).</p>\n\n<p>Unfortunately, this is never stated explicitly anywhere that I can find, but can be inferred from Rust's strong backwards compatibility guarantees. Making a change to evaluation order would likely introduce far too much breakage to ever be seriously considered.</p>\n\n<p>I'd also expect that the optimizer is allowed to make changes when safe to do so. For example, if the expressions in the tuple have no side effects, then reordering them is invisible to the user.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://users.rust-lang.org/t/rust-tuple-evaluation-order-left-right/23917\" rel=\"noreferrer\">Rust tuple: evaluation order: left -> right?</a></li>\n<li><a href=\"https://doc.rust-lang.org/reference/expressions.html\" rel=\"noreferrer\">The Rust Reference: Expressions</a></li>\n</ul>\n"}], "owner": {"reputation": 1473, "user_id": 204305, "user_type": "registered", "accept_rate": 83, "profile_image": "https://www.gravatar.com/avatar/4fa6165d3bcb50e58e60304807f4090a?s=128&d=identicon&r=PG", "display_name": "Sage Mitchell", "link": "https://stackoverflow.com/users/204305/sage-mitchell"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 507, "favorite_count": 0, "accepted_answer_id": 54313564, "answer_count": 1, "score": 7, "last_activity_date": 1548178758, "creation_date": 1548177379, "last_edit_date": 1548177779, "question_id": 54313350, "link": "https://stackoverflow.com/questions/54313350/what-is-the-evaluation-order-of-tuples-in-rust", "title": "What is the evaluation order of tuples in Rust?", "body": "<p>Tuple elements may have side-effects, and some of them may depend on others. Consider this program:</p>\n\n<pre><code>fn main() {\n    let mut v = vec![1, 2];\n    match (v.pop(), v.pop()) {\n        (Some(z), Some(y)) =&gt; println!(\"y = {}, z = {}\", y, z),\n        _ =&gt; unreachable!(),\n    }\n}\n</code></pre>\n\n<p>Does it output <code>y = 1, z = 2</code> or <code>y = 2, z = 1</code>? A few rounds on the <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=5b9476438263feed9937b80f23ec5cdb\" rel=\"noreferrer\">Rust Playground</a> suggests the former on stable 1.32.0, but maybe it would change if I ran it more times, recompiled the compiler, changed compiler versions, etc.</p>\n\n<p>Is there a documented commitment or at least intention to maintain a <em>particular</em> order of evaluation for tuples (e.g. depth-first and left-to-right)?</p>\n"}, {"tags": ["rust", "vulkan"], "comments": [{"owner": {"reputation": 2603, "user_id": 8306143, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jpU8P.jpg?s=128&g=1", "display_name": "Ekzuzy", "link": "https://stackoverflow.com/users/8306143/ekzuzy"}, "edited": false, "score": 2, "creation_date": 1548180469, "post_id": 54312290, "comment_id": 95448100, "body": "Do You create a swapchain with appropriate image usage specified? Only color attachment usage is guaranteed to be supported. You set usage to include all available usages but You don&#39;t check whether appropriate usage (storage image?) is there."}, {"owner": {"reputation": 109, "user_id": 4291158, "user_type": "registered", "accept_rate": 0, "profile_image": "https://lh4.googleusercontent.com/-tmy3EdfvBTE/AAAAAAAAAAI/AAAAAAAAABs/9PdxewEVMMw/photo.jpg?sz=128", "display_name": "Jens Metzner", "link": "https://stackoverflow.com/users/4291158/jens-metzner"}, "reply_to_user": {"reputation": 2603, "user_id": 8306143, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jpU8P.jpg?s=128&g=1", "display_name": "Ekzuzy", "link": "https://stackoverflow.com/users/8306143/ekzuzy"}, "edited": false, "score": 0, "creation_date": 1548246161, "post_id": 54312290, "comment_id": 95472417, "body": "I have printed the <code>caps.supported_usage_flags</code> and got the following message <code>ImageUsage { transfer_source: true, transfer_destination: true, sampled: true, storage: true, color_attachment: true, depth_stencil_attachment: false, transient_attachment: false, input_attachment: true }</code>. So a <code>storage</code> image is part of it."}, {"owner": {"reputation": 2603, "user_id": 8306143, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jpU8P.jpg?s=128&g=1", "display_name": "Ekzuzy", "link": "https://stackoverflow.com/users/8306143/ekzuzy"}, "edited": false, "score": 0, "creation_date": 1548247840, "post_id": 54312290, "comment_id": 95473347, "body": "Then this is not the cause of Your problem in this case. But to make sure Your code is correct, You should always check this. Your computer may support storage usage, but other computers may not not. And when You run Your application on another computer it may not work as You expect it to (even if You resolve Your current problem)."}], "answers": [{"comments": [{"owner": {"reputation": 109, "user_id": 4291158, "user_type": "registered", "accept_rate": 0, "profile_image": "https://lh4.googleusercontent.com/-tmy3EdfvBTE/AAAAAAAAAAI/AAAAAAAAABs/9PdxewEVMMw/photo.jpg?sz=128", "display_name": "Jens Metzner", "link": "https://stackoverflow.com/users/4291158/jens-metzner"}, "edited": false, "score": 0, "creation_date": 1548246523, "post_id": 54315891, "comment_id": 95472636, "body": "Per the Vulkano doc of <code>ImageLayout</code>: <i>Transitionning between layouts can only be done through a GPU-side operation that is part of a command buffer.</i> It&#39;s not clear for me how to do this?"}, {"owner": {"reputation": 2603, "user_id": 8306143, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jpU8P.jpg?s=128&g=1", "display_name": "Ekzuzy", "link": "https://stackoverflow.com/users/8306143/ekzuzy"}, "reply_to_user": {"reputation": 109, "user_id": 4291158, "user_type": "registered", "accept_rate": 0, "profile_image": "https://lh4.googleusercontent.com/-tmy3EdfvBTE/AAAAAAAAAAI/AAAAAAAAABs/9PdxewEVMMw/photo.jpg?sz=128", "display_name": "Jens Metzner", "link": "https://stackoverflow.com/users/4291158/jens-metzner"}, "edited": false, "score": 0, "creation_date": 1548247692, "post_id": 54315891, "comment_id": 95473273, "body": "@JensMetzner Either as a part of a render pass setup (initialLayout, finalLayout and subpassLayout fields), or through an image memory barrier (part of vkCmdPipelineBarrier() command)."}, {"owner": {"reputation": 109, "user_id": 4291158, "user_type": "registered", "accept_rate": 0, "profile_image": "https://lh4.googleusercontent.com/-tmy3EdfvBTE/AAAAAAAAAAI/AAAAAAAAABs/9PdxewEVMMw/photo.jpg?sz=128", "display_name": "Jens Metzner", "link": "https://stackoverflow.com/users/4291158/jens-metzner"}, "reply_to_user": {"reputation": 2603, "user_id": 8306143, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/jpU8P.jpg?s=128&g=1", "display_name": "Ekzuzy", "link": "https://stackoverflow.com/users/8306143/ekzuzy"}, "edited": false, "score": 0, "creation_date": 1548250796, "post_id": 54315891, "comment_id": 95475100, "body": "@Ekzuzy I added an <code>FrameBuffer</code> and also a render pass <code>.begin_render_pass(framebuffer.clone(),false,vec![[1.0, 1.0, 1.0, 1.0].into()],).unwrap().end_render_pass()</code> and now it works. It seems to be a known <a href=\"https://github.com/vulkano-rs/vulkano/issues/977\" rel=\"nofollow noreferrer\">issue</a>"}], "tags": [], "owner": {"reputation": 8395, "user_id": 3007154, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fb7293bd97c47febd218463c27b394c6?s=128&d=identicon&r=PG&f=1", "display_name": "krOoze", "link": "https://stackoverflow.com/users/3007154/krooze"}, "is_accepted": false, "score": 1, "last_activity_date": 1548188446, "creation_date": 1548188446, "answer_id": 54315891, "question_id": 54312290, "link": "https://stackoverflow.com/questions/54312290/how-do-i-use-a-vulkano-compute-shader-to-compute-to-a-swapchain-image/54315891#54315891", "title": "How do I use a Vulkano compute shader to compute to a swapchain image?", "body": "<p>Per the Vulkano doc:</p>\n\n<blockquote>\n  <p>ImageNotInitialized<br>\n  Trying to use an image without transitioning it from the \"undefined\" or \"preinitialized\" layouts first.</p>\n</blockquote>\n\n<p>Assumably the Image is in <code>Undefined</code> layout, but it seems to require the <code>PresentSrc</code> per the trace.</p>\n"}], "owner": {"reputation": 109, "user_id": 4291158, "user_type": "registered", "accept_rate": 0, "profile_image": "https://lh4.googleusercontent.com/-tmy3EdfvBTE/AAAAAAAAAAI/AAAAAAAAABs/9PdxewEVMMw/photo.jpg?sz=128", "display_name": "Jens Metzner", "link": "https://stackoverflow.com/users/4291158/jens-metzner"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 373, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1548188446, "creation_date": 1548173633, "last_edit_date": 1548174349, "question_id": 54312290, "link": "https://stackoverflow.com/questions/54312290/how-do-i-use-a-vulkano-compute-shader-to-compute-to-a-swapchain-image", "title": "How do I use a Vulkano compute shader to compute to a swapchain image?", "body": "<p>I'm trying to calculate something with a compute shader and save the result in a swapchain image to display it in a window for later interactivity.</p>\n\n<p>I get the following error message:</p>\n\n<blockquote>\n  <p>thread 'main' panicked at 'called <code>Result::unwrap()</code> on an <code>Err</code> value: AccessError { error: ImageNotInitialized { requested: PresentSrc }, command_name: \"vkCmdBindDescriptorSets\", command_param: \"Image bound to descriptor 0 of set 0\", command_offset: 1 }', libcore\\result.rs:1009:5\n  note: Run with <code>RUST_BACKTRACE=1</code> for a backtrace.\n  error: process didn't exit successfully: <code>target\\debug\\vulkan_test.exe</code> (exit code: 101)</p>\n</blockquote>\n\n<h3>main.rs</h3>\n\n<pre class=\"lang-rust prettyprint-override\"><code>extern crate vulkano;\nextern crate vulkano_shaders;\nextern crate vulkano_win;\nextern crate winit;\n\nuse std::sync::Arc;\nuse vulkano::command_buffer::AutoCommandBufferBuilder;\nuse vulkano::descriptor::descriptor_set::PersistentDescriptorSet;\nuse vulkano::device::{Device, DeviceExtensions};\nuse vulkano::instance::{Instance, PhysicalDevice};\nuse vulkano::pipeline::ComputePipeline;\nuse vulkano::swapchain;\nuse vulkano::swapchain::{\n    AcquireError, PresentMode, SurfaceTransform, Swapchain, SwapchainCreationError,\n};\nuse vulkano::sync;\nuse vulkano::sync::{FlushError, GpuFuture};\nuse vulkano_win::VkSurfaceBuild;\nuse winit::{EventsLoop, WindowBuilder};\n\nmod cs {\n    vulkano_shaders::shader! {\n    ty: \"compute\",\n    // path: \"shaders/compute.glsl\"\n        src: \"\n#version 450\n\nlayout(local_size_x = 8, local_size_y = 8, local_size_z = 1) in;\n\nlayout(set = 0, binding = 0, rgba8) uniform writeonly image2D img;\n\nvoid main() {\n    imageStore(img, ivec2(gl_GlobalInvocationID.xy), vec4(1,0,1,1));\n}        \n        \"\n    }\n}\n\nfn main() {\n    let instance = {\n        let extensions = vulkano_win::required_extensions();\n        Instance::new(None, &amp;extensions, None).expect(\"failed to create instance\")\n    };\n\n    let physical = PhysicalDevice::enumerate(&amp;instance)\n        .next()\n        .expect(\"no device available\");\n\n    println!(\"Name:    {}  (type: {:?})\", physical.name(), physical.ty());\n    println!(\"Version: {}\", physical.api_version());\n\n    let mut events_loop = EventsLoop::new();\n\n    let surface = WindowBuilder::new()\n        .with_title(\"Ray\")\n        .with_dimensions((1600.0, 900.0).into())\n        .build_vk_surface(&amp;events_loop, instance.clone())\n        .expect(\"failed to create window\");\n    let window = surface.window();\n\n    let queue_family = physical\n        .queue_families()\n        .find(|&amp;q| q.supports_graphics() &amp;&amp; surface.is_supported(q).unwrap_or(false))\n        .expect(\"failed to create queue family\");\n\n    let (device, mut queues) = {\n        let device_ext = DeviceExtensions {\n            khr_swapchain: true,\n            ..DeviceExtensions::none()\n        };\n        Device::new(\n            physical,\n            physical.supported_features(),\n            &amp;device_ext,\n            [(queue_family, 0.5)].iter().cloned(),\n        )\n        .expect(\"failed to create device\")\n    };\n    let queue = queues.next().expect(\"failed to create queue\");\n\n    let shader = cs::Shader::load(device.clone()).expect(\"failed to create shader module\");\n\n    let compute_pipeline = Arc::new(\n        ComputePipeline::new(device.clone(), &amp;shader.main_entry_point(), &amp;())\n            .expect(\"failed to create compute pipeline\"),\n    );\n\n    let (mut swapchain, mut images) = {\n        let caps = surface.capabilities(physical).unwrap();\n\n        let usage = caps.supported_usage_flags;\n        let alpha = caps.supported_composite_alpha.iter().next().unwrap();\n        let format = caps.supported_formats[0].0;\n\n        let initial_dimensions = if let Some(dimensions) = window.get_inner_size() {\n            let dimensions: (u32, u32) = dimensions.to_physical(window.get_hidpi_factor()).into();\n            [dimensions.0, dimensions.1]\n        } else {\n            return;\n        };\n        Swapchain::new(\n            device.clone(),\n            surface.clone(),\n            caps.min_image_count,\n            format,\n            initial_dimensions,\n            1,\n            usage,\n            &amp;queue,\n            SurfaceTransform::Identity,\n            alpha,\n            PresentMode::Fifo,\n            true,\n            None,\n        )\n        .expect(\"failed to create swapchain\")\n    };\n\n    let mut recreate_swapchain = false;\n    let mut previous_frame_end = Box::new(sync::now(device.clone())) as Box&lt;GpuFuture&gt;;\n\n    loop {\n        previous_frame_end.cleanup_finished();\n\n        if recreate_swapchain {\n            let dimensions = if let Some(dimensions) = window.get_inner_size() {\n                let dimensions: (u32, u32) =\n                    dimensions.to_physical(window.get_hidpi_factor()).into();\n                [dimensions.0, dimensions.1]\n            } else {\n                return;\n            };\n\n            let (new_swapchain, new_images) = match swapchain.recreate_with_dimension(dimensions) {\n                Ok(r) =&gt; r,\n                Err(SwapchainCreationError::UnsupportedDimensions) =&gt; continue,\n                Err(err) =&gt; panic!(\"{:?}\", err),\n            };\n\n            swapchain = new_swapchain;\n            images = new_images;\n            recreate_swapchain = false;\n        }\n\n        let (image_index, acquire_future) =\n            match swapchain::acquire_next_image(swapchain.clone(), None) {\n                Ok(r) =&gt; r,\n                Err(AcquireError::OutOfDate) =&gt; {\n                    recreate_swapchain = true;\n                    continue;\n                }\n                Err(err) =&gt; panic!(\"{:?}\", err),\n            };\n\n        let command_buffer = {\n            let set = Arc::new(\n                PersistentDescriptorSet::start(compute_pipeline.clone(), 0)\n                    .add_image(images[image_index].clone())\n                    .unwrap()\n                    .build()\n                    .unwrap(),\n            );\n\n            AutoCommandBufferBuilder::new(device.clone(), queue.family())\n                .unwrap()\n                .dispatch([200, 100, 1], compute_pipeline.clone(), set.clone(), ())\n                .unwrap()\n                .build()\n                .unwrap()\n        };\n\n        let future = previous_frame_end\n            .join(acquire_future)\n            .then_execute(queue.clone(), command_buffer)\n            .unwrap()\n            .then_swapchain_present(queue.clone(), swapchain.clone(), image_index)\n            .then_signal_fence_and_flush();\n\n        match future {\n            Ok(future) =&gt; {\n                previous_frame_end = Box::new(future) as Box&lt;_&gt;;\n            }\n            Err(FlushError::OutOfDate) =&gt; {\n                recreate_swapchain = true;\n                previous_frame_end = Box::new(sync::now(device.clone())) as Box&lt;_&gt;;\n            }\n            Err(e) =&gt; {\n                println!(\"{:?}\", e);\n                previous_frame_end = Box::new(sync::now(device.clone())) as Box&lt;_&gt;;\n            }\n        }\n\n        let mut done = false;\n        events_loop.poll_events(|ev| match ev {\n            winit::Event::WindowEvent { event, .. } =&gt; match event {\n                winit::WindowEvent::CloseRequested =&gt; done = true,\n                winit::WindowEvent::KeyboardInput {\n                    input:\n                        winit::KeyboardInput {\n                            virtual_keycode: Some(virtual_code),\n                            state: winit::ElementState::Released,\n                            ..\n                        },\n                    ..\n                } =&gt; match virtual_code {\n                    winit::VirtualKeyCode::Escape =&gt; done = true,\n                    _ =&gt; (),\n                },\n                winit::WindowEvent::Resized(_) =&gt; recreate_swapchain = true,\n                _ =&gt; (),\n            },\n            _ =&gt; (),\n        });\n        if done {\n            return;\n        }\n    }\n}\n</code></pre>\n\n<h3>Full error backtrace</h3>\n\n<pre class=\"lang-none prettyprint-override\"><code>thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: AccessError { error: ImageNotInitialized { requested: PresentSrc }, command_name: \"vkCmdBindDescriptorSets\", command_param: \"Image bound to descriptor 0 of set 0\", command_offset: 1 }', libcore\\result.rs:1009:5\nstack backtrace:\n   0: std::sys::windows::backtrace::set_frames\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\sys\\windows\\backtrace\\mod.rs:104\n   1: std::sys::windows::backtrace::set_frames\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\sys\\windows\\backtrace\\mod.rs:104\n   2: std::sys_common::backtrace::_print\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\sys_common\\backtrace.rs:71\n   3: std::sys_common::backtrace::_print\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\sys_common\\backtrace.rs:71\n   4: std::panicking::default_hook::{{closure}}\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:211\n   5: std::panicking::default_hook\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:227\n   6: std::panicking::rust_panic_with_hook\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:476\n   7: std::panicking::continue_panic_fmt\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:390\n   8: std::panicking::rust_begin_panic\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:325\n   9: core::panicking::panic_fmt\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libcore\\panicking.rs:77\n  10: core::result::unwrap_failed&lt;vulkano::command_buffer::traits::CommandBufferExecError&gt;\n             at \\libcore\\macros.rs:26\n  11: core::result::Result&lt;vulkano::command_buffer::traits::CommandBufferExecFuture&lt;vulkano::sync::future::join::JoinFuture&lt;alloc::boxed::Box&lt;GpuFuture&gt;, vulkano::swapchain::swapchain::SwapchainAcquireFuture&lt;winit::Window&gt;&gt;, vulkano::command_buffer::auto::AutoCommandBuffer&lt;vulkano::command_buffer::pool::standard::StandardCommandPoolAlloc&gt;&gt;, vulkano::command_buffer::traits::CommandBufferExecError&gt;::unwrap&lt;vulkano::command_buffer::traits::CommandBufferExecFuture&lt;vulkano::sync::future::join::JoinFuture&lt;alloc::boxed::Box&lt;GpuFuture&gt;, vulkano::swapchain::swapchain::SwapchainAcquireFuture&lt;winit::Window&gt;&gt;, vulkano::command_buffer::auto::AutoCommandBuffer&lt;vulkano::command_buffer::pool::standard::StandardCommandPoolAlloc&gt;&gt;,vulkano::command_buffer::traits::CommandBufferExecError&gt;\n             at \\libcore\\result.rs:808\n  12: vulkan_test::main\n             at .\\src\\main.rs:178\n  13: std::rt::lang_start::{{closure}}&lt;()&gt;\n             at \\libstd\\rt.rs:74\n  14: std::rt::lang_start_internal::{{closure}}\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\rt.rs:59\n  15: std::rt::lang_start_internal::{{closure}}\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\rt.rs:59\n  16: panic_unwind::__rust_maybe_catch_panic\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libpanic_unwind\\lib.rs:102\n  17: std::panicking::try\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:289\n  18: std::panicking::try\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:289\n  19: std::panicking::try\n             at /rustc/b6c32da9b0481e3e9d737153286b3ff8aa39a22c\\src/libstd\\panicking.rs:289\n  20: std::rt::lang_start&lt;()&gt;\n             at \\libstd\\rt.rs:74\n  21: main\n  22: invoke_main\n             at d:\\agent\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\n  23: invoke_main\n             at d:\\agent\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:78\n  24: BaseThreadInitThunk\n  25: RtlUserThreadStart\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 22377, "user_id": 2288659, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/bBg8v.png?s=128&g=1", "display_name": "Silvio Mayolo", "link": "https://stackoverflow.com/users/2288659/silvio-mayolo"}, "edited": false, "score": 2, "creation_date": 1548173821, "post_id": 54312271, "comment_id": 95444738, "body": "For what its worth, there&#39;s no recursion in your code. Recursion, by definition, occurs when a function calls itself, which does not occur in your code."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548174033, "post_id": 54312271, "comment_id": 95444863, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54312271/edit\">edit</a> your question to include it. The code you have provided uses variables that are not defined and thus cannot produce the output you claim it does. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 22377, "user_id": 2288659, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/bBg8v.png?s=128&g=1", "display_name": "Silvio Mayolo", "link": "https://stackoverflow.com/users/2288659/silvio-mayolo"}, "edited": false, "score": 0, "creation_date": 1548230824, "post_id": 54312271, "comment_id": 95463776, "body": "@SilvioMayolo you&#39;re right from a programming standpoint, but from a <i>mathematical</i> standpoint, <code>i</code> and <code>j</code> are defined recursively since their value at time <code>t</code> depends on their value at time <code>t-1</code>"}, {"owner": {"reputation": 61601, "user_id": 1203556, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/aca772bc8ed79a86894211c7efd920aa?s=128&d=identicon&r=PG", "display_name": "Tampa", "link": "https://stackoverflow.com/users/1203556/tampa"}, "reply_to_user": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1548241334, "post_id": 54312271, "comment_id": 95469862, "body": "@jmb this is for a kalman filter.  By definition a Kalman filter is recursive.  The above was the minimal to represent the issue I was having with the recursive nature of a Kalman filter"}], "answers": [{"tags": [], "owner": {"reputation": 22377, "user_id": 2288659, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/bBg8v.png?s=128&g=1", "display_name": "Silvio Mayolo", "link": "https://stackoverflow.com/users/2288659/silvio-mayolo"}, "is_accepted": true, "score": 2, "last_activity_date": 1548174512, "last_edit_date": 1548174512, "creation_date": 1548173774, "answer_id": 54312332, "question_id": 54312271, "link": "https://stackoverflow.com/questions/54312271/recursion-issues-in-rust/54312332#54312332", "title": "Recursion issues in rust", "body": "<p>This feature is not currently available in Rust. There is an <a href=\"https://github.com/rust-lang/rfcs/issues/372\" rel=\"nofollow noreferrer\">open issue</a> on the issue tracker relating to it. For now, you have to destructure by hand.</p>\n\n<pre><code>let (i1, j1) = test(i, j);\ni = i1;\nj = j1;\n</code></pre>\n"}], "owner": {"reputation": 61601, "user_id": 1203556, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/aca772bc8ed79a86894211c7efd920aa?s=128&d=identicon&r=PG", "display_name": "Tampa", "link": "https://stackoverflow.com/users/1203556/tampa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 273, "favorite_count": 0, "closed_date": 1548173989, "accepted_answer_id": 54312332, "answer_count": 1, "score": -2, "last_activity_date": 1548174512, "creation_date": 1548173559, "last_edit_date": 1548173955, "question_id": 54312271, "link": "https://stackoverflow.com/questions/54312271/recursion-issues-in-rust", "closed_reason": "Duplicate", "title": "Recursion issues in rust", "body": "<p>I have that does the following type of recursion and works as expected:</p>\n\n<pre><code>fn test2(i: isize) -&gt; (isize) {\n    println!(\"i={}\", i);\n    return (i + 1);\n}\n\nfn main() {\n    let mut i = 1;\n    let mut j = 1;\n    for t in 0..4 {\n        (i) = test2(i);\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>i=1\ni=2\ni=3\ni=4\n</code></pre>\n\n<p>The problem I have is what I really want is this recursion with multiple feedbacks like this.....</p>\n\n<pre><code>fn test(i: isize, j: isize) -&gt; (isize, isize) {\n    println!(\"i={} j={}\", i, j);\n    return (i + 1, j + 1);\n}\n\nfn main() {\n    for t in 0..4 {\n        let (i, j) = test(i, j);\n        println!(\"ii {} jj {}\", i, j);\n    }\n}\n</code></pre>\n\n<p>When I run the code I get the below:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>i=1 j=1\nii 2 jj 2\ni=1 j=1\nii 2 jj 2\ni=1 j=1\nii 2 jj 2\ni=1 j=1\nii 2 jj 2\n</code></pre>\n\n<p>If I leave off the let I get the below error:</p>\n\n<pre><code>for t in 0 .. 4 {\n    (i,j) = test(i, j);\n    println!(\"ii {} jj {}\", i,j)  ; \n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>        error[E0070]: invalid left-hand side expression                                                                                                                                                          \n   --&gt; src/main.rs:265:13                                                                                                                                                                                \n    |                                                                                                                                                                                                    \n265 |             (i,j) = test(i, j);                                                                                                                                                                    \n    |             ^^^^^^^^^^^^^^^^^^ left-hand of expression not valid                \n</code></pre>\n\n<p>How do I resolve?</p>\n"}, {"tags": ["rust", "serde"], "answers": [{"tags": [], "owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "is_accepted": true, "score": 1, "last_activity_date": 1548246527, "last_edit_date": 1548246527, "creation_date": 1548234001, "answer_id": 54323406, "question_id": 54309618, "link": "https://stackoverflow.com/questions/54309618/how-to-parse-field-to-string-with-serde/54323406#54323406", "title": "How to parse field to string with Serde?", "body": "<p>Serde provides <code>serde_json::Value</code> ( <a href=\"https://docs.serde.rs/serde_json/value/enum.Value.html\" rel=\"nofollow noreferrer\">reference</a> ) . It is an enum which contains data types like: </p>\n\n<pre><code>pub enum Value {\n    /// Represents a JSON null value.\n    Null,\n    /// Represents a JSON boolean.\n    Bool(bool),\n\n    /// Represents a JSON number, whether integer or floating point.\n    Number(Number),\n\n    /// Represents a JSON string.\n    String(String),\n\n    /// Represents a JSON array.\n    Array(Vec&lt;Value&gt;),\n\n    /// Represents a JSON object.\n    Object(Map&lt;String, Value&gt;),\n}\n</code></pre>\n\n<p>You can use <code>serde_json::Value</code> as a value type for your HashMap. It is simply possible to pull data from <code>serde_json::Value</code> with using <a href=\"https://docs.serde.rs/serde_json/value/fn.from_value.html\" rel=\"nofollow noreferrer\">serde_json::from_value</a> or use pattern matching. In your case i would use pattern matching, because only <code>Integer</code> types will be converted into a <code>String</code> and rest will be the same. </p>\n\n<p>But you'll need to consider adding one more step after deserialize. Like </p>\n\n<ul>\n<li><strike>Creating shadow field for <code>custom</code>, will be filled after deserialization.</strike></li>\n<li><strike>Or constructing new struct which contains <code>custom</code> as <code>HashMap&lt;String, String&gt;</code>. </strike></li>\n<li>Add a function to convert <code>HashMap&lt;String, Value&gt;</code> to <code>HashMap&lt;String, String&gt;</code>, </li>\n</ul>\n\n<hr>\n\n<p>Implementation of this trait can solve your problem.</p>\n\n<pre><code>trait ToStringStringMap {\n    fn to_string_string_map(&amp;self) -&gt; HashMap&lt;String, String&gt;;\n}\n\nimpl ToStringStringMap for HashMap&lt;String, Value&gt; {\n    fn to_string_string_map(&amp;self) -&gt; HashMap&lt;String, String&gt; {\n        self.iter()\n            .map(|(k, v)| {\n                let v = match v.clone() {\n                    e @ Value::Number(_) | e @ Value::Bool(_) =&gt; e.to_string(),\n                    Value::String(s) =&gt; s,\n                    _ =&gt; {\n                        println!(r#\"Warning : Can not convert field : \"{}'s value to String, It will be empty string.\"#, k);\n                        \"\".to_string()\n                    }\n                };\n\n                (k.clone(), v)\n            })\n            .collect()\n    }\n}\n</code></pre>\n\n<p><strong>Example</strong>: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ba1a9ca08e89a2517fd3c0fa025d86f6\" rel=\"nofollow noreferrer\">Playground</a></p>\n\n<p><strong>Note</strong>: Trait's name is not well chosen, suggestions are welcomed.  </p>\n"}], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2530, "favorite_count": 0, "accepted_answer_id": 54323406, "answer_count": 1, "score": 3, "last_activity_date": 1548246527, "creation_date": 1548164480, "question_id": 54309618, "link": "https://stackoverflow.com/questions/54309618/how-to-parse-field-to-string-with-serde", "title": "How to parse field to string with Serde?", "body": "<p>I have a custom field in my <code>JSON</code> which is coming dynamic and needs to be parsed to struct which has a <code>HashMap</code> field like following:</p>\n\n<pre><code>#[macro_use]\nextern crate serde_derive;\n\nextern crate serde;\nextern crate serde_json;\n\nuse std::collections::HashMap;\n\n#[derive(Serialize, Deserialize)]\nstruct MyStruct {\n    field1: String,\n    custom: HashMap&lt;String, String&gt;,\n}\n\nfn main() {\n    let json_string = r#\"{\"field1\":\"3\",\"custom\":{\"custom1\":\"15000\",\"custom2\":\"60\"}}\"#;\n    let my_struct = serde_json::from_str::&lt;MyStruct&gt;(json_string).unwrap();\n    println!(\"{}\", serde_json::to_string(&amp;my_struct).unwrap());\n}\n</code></pre>\n\n<p>It works when my json string has string fields in custom field which can be easily parsed to string.</p>\n\n<p>But the problem is my json string is:</p>\n\n<pre><code>let json_string_wrong = r#\"{\"field1\":\"3\",\"custom\":{\"custom1\":15000,\"custom2\":\"60\"}}\"#; // Need to parse this\n</code></pre>\n\n<p>How to handle such castings in serde?</p>\n"}, {"tags": ["callback", "rust", "lifetime", "rust-tokio"], "answers": [{"comments": [{"owner": {"reputation": 560, "user_id": 4102092, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/632336d7ad3f306e8e44d6886717e9b6?s=128&d=identicon&r=PG&f=1", "display_name": "Lucas", "link": "https://stackoverflow.com/users/4102092/lucas"}, "edited": false, "score": 0, "creation_date": 1548312395, "post_id": 54321135, "comment_id": 95497595, "body": "I have cargo/rust 1.32.0 and it told me I can leave out the <code>mut</code> for <code>self</code> in the signature of <code>Test::start(self)</code> and thus also on <code>x</code> in the main function."}, {"owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "reply_to_user": {"reputation": 560, "user_id": 4102092, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/632336d7ad3f306e8e44d6886717e9b6?s=128&d=identicon&r=PG&f=1", "display_name": "Lucas", "link": "https://stackoverflow.com/users/4102092/lucas"}, "edited": false, "score": 0, "creation_date": 1548318053, "post_id": 54321135, "comment_id": 95500165, "body": "@Lucas, yes, That&#39;s up to you. If you think <code>Test</code> will never get mutated, there&#39;s no need of <code>mut</code>."}], "tags": [], "owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "is_accepted": true, "score": 1, "last_activity_date": 1548258465, "last_edit_date": 1548258465, "creation_date": 1548224591, "answer_id": 54321135, "question_id": 54307368, "link": "https://stackoverflow.com/questions/54307368/using-a-callback-when-handling-tcp-connections-with-tokio/54321135#54321135", "title": "Using a callback when handling TCP connections with Tokio", "body": "<p>First things first:</p>\n\n<p>Compiler will translate <code>Box&lt;Fn(std::net::SocketAddr) + Sync&gt;</code> to <code>Box&lt;Fn(std::net::SocketAddr) + Sync + 'static&gt;</code> unless the lifetime is explicitly specified.</p>\n\n<p>Let's have a look at the errors:</p>\n\n<pre><code>error[E0277]: (dyn std::ops::Fn(std::net::SocketAddr) + std::marker::Sync + 'static) cannot be sent between threads safely\n</code></pre>\n\n<p>This is self-explanatory. You are trying to move <code>&amp;mut T</code> to another thread, but cannot, because <code>T</code> here is not <code>Send</code>. To send <code>&amp;mut T</code> to another thread <code>T</code> too needs to be of type <code>Send</code>.</p>\n\n<p>Here is the minimal code that will give the same error:</p>\n\n<pre><code>use std::fmt::Debug;\n\nfn func&lt;T&gt; (i:&amp;'static mut T) where T: Debug {\n    std::thread::spawn(move || {\n        println!(\"{:?}\", i);\n    });\n}\n</code></pre>\n\n<p>If I make <code>T</code> above to also be of type <code>Send</code>, the error goes away.\nBut in your case when you add the <code>Send</code> trait, it gives lifetime error. Why?</p>\n\n<p><code>&amp;mut self</code> has some lifetime greater than the function <code>start()</code> set by the caller, but there's no guarantee that its <code>'static</code>. You move this reference into the closure which is passed to the thread and can potentially outlive the scope it is closing over, leading to a dangling reference.</p>\n\n<p>Here's a minimal version, that would give the same error.</p>\n\n<pre><code>use std::fmt::Debug;\n\nfn func&lt;'a, T:'a&gt; (i:&amp;'a mut T) where T: Debug + Sync + Send {\n    std::thread::spawn(move || {\n        println!(\"{:?}\", i);\n    });\n}\n</code></pre>\n\n<p><code>Sync</code> is not really required here as it is <code>&amp;mut T</code>. Changing <code>&amp;mut T</code> to <code>&amp;T</code> (retaining <code>Sync</code>), will also result into the same error. The onus here is on references and not mutability. So you see, there is some lifetime <code>'a</code> and it is moved into a closure (given to a thread), which means the closure now contains a reference (disjoint from the main context). So now, what is <code>'a</code> and how long will it live from the closure's perspective that is invoked from another thread? Not inferable! As a result, the compiler complains saying <code>cannot infer an appropriate lifetime due to conflicting requirements</code>.</p>\n\n<p>If we tweak the code a bit to;</p>\n\n<pre><code>impl Test {\n    pub fn start(&amp;'static mut self) -&gt; Result&lt;(), Box&lt;std::error::Error&gt;&gt; {\n        let addr = \"127.0.0.1:4242\".parse::&lt;std::net::SocketAddr&gt;()?;\n        let listener = tokio::net::TcpListener::bind(&amp;addr)?;\n        let server = listener\n            .incoming()\n            .map_err(|e| eprintln!(\"failed to accept socket; error = {:?}\", e))\n            .for_each(move |socket: tokio::net::TcpStream| {\n                let address = socket.peer_addr().expect(\"\");\n                match &amp;self.printer {\n                    Some(callback) =&gt; { callback(address); }\n                    None =&gt; { println!(\"{}\", address); }\n                }\n                Ok(())\n            });\n        tokio::run(server);\n        Ok(())\n    }\n}\n</code></pre>\n\n<p>it will compile fine. There's a guarantee there that <code>self</code> has a <code>'static</code> lifetime. Please note that in the <code>match</code> statement we need to pass <code>&amp;self.printer</code>, as you cannot move out of a borrowed context. </p>\n\n<p>However, this expects <code>Test</code> to be declared static and that too a mutable one, which is generally not the best way, if you have other options.</p>\n\n<p>Another way is; if it's ok for you to pass <code>Test</code> by value to <code>start()</code> and then further move it into <code>for_each()</code>, the code would look like this: </p>\n\n<pre><code>use tokio::prelude::*;\n\nstruct Test {\n    printer: Option&lt;Box&lt;Fn(std::net::SocketAddr) + Send&gt;&gt;,\n}\n\nimpl Test {\n    pub fn start(mut self) -&gt; Result&lt;(), Box&lt;std::error::Error&gt;&gt; {\n        let addr = \"127.0.0.1:4242\".parse::&lt;std::net::SocketAddr&gt;()?;\n        let listener = tokio::net::TcpListener::bind(&amp;addr)?;\n        let server = listener\n            .incoming()\n            .map_err(|e| eprintln!(\"failed to accept socket; error = {:?}\", e))\n            .for_each(move |socket: tokio::net::TcpStream| {\n                let address = socket.peer_addr().expect(\"\");\n                match &amp;self.printer {\n                    Some(callback) =&gt; {\n                        callback(address);\n                    }\n                    None =&gt; {\n                        println!(\"{}\", address);\n                    }\n                }\n                Ok(())\n            });\n        tokio::run(server);\n        Ok(())\n    }\n}\n\nfn main() {\n    let mut x = Test { printer: None };\n    x.start();\n}\n</code></pre>\n"}], "owner": {"reputation": 560, "user_id": 4102092, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/632336d7ad3f306e8e44d6886717e9b6?s=128&d=identicon&r=PG&f=1", "display_name": "Lucas", "link": "https://stackoverflow.com/users/4102092/lucas"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 585, "favorite_count": 0, "accepted_answer_id": 54321135, "answer_count": 1, "score": 1, "last_activity_date": 1548258465, "creation_date": 1548156845, "last_edit_date": 1548157343, "question_id": 54307368, "link": "https://stackoverflow.com/questions/54307368/using-a-callback-when-handling-tcp-connections-with-tokio", "title": "Using a callback when handling TCP connections with Tokio", "body": "<p>I am trying to have a struct that starts an event loop, listens for TCP connections and calls a callback for each connection. </p>\n\n<p>(The callback will be handed some prepossessed data from the socket.  In my example below I just hand it the IP address of the connection but in my real code I will parse the contents that I receive with <code>serde</code> into a struct and pass that into the callback.  I hope that doesn't invalidate the following \"not working example\").</p>\n\n<p>My <code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"lifetime-problem\"\nversion = \"0.1.0\"\nedition = \"2018\"\n[dependencies]\ntokio-tcp = \"0.1.3\"\ntokio = \"0.1.14\"\n[[bin]]\nname = \"lifetime-problem\"\npath = \"main.rs\"\n</code></pre>\n\n<p>and <code>main.rs</code>:</p>\n\n<pre><code>use tokio::prelude::*;\n\nstruct Test {\n    printer: Option&lt;Box&lt;Fn(std::net::SocketAddr) + Sync&gt;&gt;,\n}\n\nimpl Test {\n    pub fn start(&amp;mut self) -&gt; Result&lt;(), Box&lt;std::error::Error&gt;&gt; {\n        let addr = \"127.0.0.1:4242\".parse::&lt;std::net::SocketAddr&gt;()?;\n        let listener = tokio::net::TcpListener::bind(&amp;addr)?;\n        let server = listener\n            .incoming()\n            .map_err(|e| eprintln!(\"failed to accept socket; error = {:?}\", e))\n            .for_each(move |socket: tokio::net::TcpStream| {\n                let address = socket.peer_addr().expect(\"\");\n                match self.printer {\n                    Some(callback) =&gt; { callback(address); }\n                    None =&gt; { println!(\"{}\", address); }\n                }\n                Ok(())\n            });\n        tokio::run(server);\n        Ok(())\n    }\n}\n\nfn main() {\n    let mut x = Test{ printer: None };\n    x.start();\n}\n</code></pre>\n\n<p>I have tried several things starting from this code (which is adopted directly from the <a href=\"https://tokio-rs.github.io/tokio/tokio/net/tcp/struct.TcpListener.html#examples\" rel=\"nofollow noreferrer\">Tokio example</a>). </p>\n\n<ol>\n<li><p>If I use the code like posted above I get:</p>\n\n<pre><code>error[E0277]: (dyn std::ops::Fn(std::net::SocketAddr) + std::marker::Sync + 'static) cannot be sent between threads safely\n</code></pre>\n\n<p>for the line 24 (<code>tokio::run(server)</code>).</p></li>\n<li><p>If I add the <code>Send</code> trait on the <code>Fn</code> in the printer field <em>XOR</em> if I remove the <code>move</code> in the closure in the <code>for_each</code> call I get another error instead: </p>\n\n<pre><code>error[E0495]: cannot infer an appropriate lifetime due to conflicting requirements\n</code></pre>\n\n<p>which points me to the closure that apparently cannot outlive the <code>start</code> method where it is defined but <code>tokio::run</code> seems to have conflicting requirements for it.</p></li>\n</ol>\n\n<p>Do you know if I am addressing the callback pattern in totally the wrong way or if there is just some minor error in my code?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1548168188, "post_id": 54307276, "comment_id": 95441183, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54307276/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. For example, <code>MyStruct</code>, <code>Engine</code>, <code>Parameters</code>, and <code>Proof</code> are all undefined. If they aren&#39;t needed to reproduce the problem, remove them. Otherwise, minimize them and provide them. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1548184516, "post_id": 54307276, "comment_id": 95449899, "body": "@Shepmaster Thank you for the information. But I find my question is clear enough to be understood and answered. Short and evident question is better than full and complicated one. As the result, I got quick and satisfied answer. No need to overcharge Stackoverflow."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548190211, "post_id": 54307276, "comment_id": 95452346, "body": "@Formalhaut Please do not rollback the edits, because they were made for a reason, e.g. <code>...</code> is not valid rust code and is not needed (why bother using the dots, when leaving them out is okay as well). Second it is okay to write <code>&#47;&#47; ...</code> as method content, but <code>unimplemented!()</code> is exactly for this purpose. Next the <code>&lt;!-- language: none --&gt;</code> tag is also there for a certain reason. Please avoid rolling back again."}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548200581, "post_id": 54307276, "comment_id": 95455888, "body": "@hellow After this comment I&#39;d assume you know exactly how the <code>&lt;!-- language --&gt;</code> tags work - and that is <code>none</code> takes the language(s) assigned to the <a href=\"https://stackoverflow.com/questions/tagged/none\">none</a> tag, while <code>lang-none</code> takes the language <i>none</i> which is probably exactly what you want in this case"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "reply_to_user": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 0, "creation_date": 1548231133, "post_id": 54307276, "comment_id": 95463937, "body": "@msrd0 you&#39;re right, but since the <a href=\"https://stackoverflow.com/questions/tagged/none\">none</a> has no syntax highlighting it will do the same as <code>lang-none</code>. Technically you&#39;re right. Feel free to correct the post."}], "answers": [{"tags": [], "owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "is_accepted": true, "score": 2, "last_activity_date": 1548167767, "last_edit_date": 1548167767, "creation_date": 1548156618, "answer_id": 54307313, "question_id": 54307276, "link": "https://stackoverflow.com/questions/54307276/how-to-pass-an-instance-of-a-structure-that-has-implemented-a-certain-trait/54307313#54307313", "title": "How to pass an instance of a structure that has implemented a certain trait?", "body": "<p>Try to make the struct that implements <code>Circuit</code> a generic type as well:</p>\n\n<pre><code>pub fn create_proof&lt;C, E&gt;(&amp;self, c: &amp;C, pk: &amp;Parameters&lt;E&gt;) -&gt; Proof&lt;E&gt;\nwhere\n    C: Circuit&lt;E&gt;,\n    E: Engine,\n{\n    unimplemented!()\n}\n</code></pre>\n"}], "owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 86, "favorite_count": 0, "accepted_answer_id": 54307313, "answer_count": 1, "score": 0, "last_activity_date": 1548190236, "creation_date": 1548156481, "last_edit_date": 1548190236, "question_id": 54307276, "link": "https://stackoverflow.com/questions/54307276/how-to-pass-an-instance-of-a-structure-that-has-implemented-a-certain-trait", "title": "How to pass an instance of a structure that has implemented a certain trait?", "body": "<p>I am trying to write a correct signature for a method that takes an object by reference as input. It's supposed the object to be an instance of a structure that implements a certain trait.</p>\n\n<pre><code>impl MyStruct {\n    pub fn create_proof&lt;E: Engine&gt;(&amp;self, C: &amp;Circuit&lt;E&gt;, pk: &amp;Parameters&lt;E&gt;) -&gt; Proof&lt;E&gt; {\n        unimplemented!()\n    }\n}\n</code></pre>\n\n<p><code>Circuit</code> is defined as a trait like this <code>trait Circuit&lt;E: Engine&gt;</code> and it has an implemented method inside.</p>\n\n<p>When I compile the project I get the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>the trait `mylib::Circuit` cannot be made into an object\nnote: method `circuit_method` has generic type parameters\n</code></pre>\n\n<p>Why this error occurred and how to fix it? I am not allowed to modify everything bound to <code>mylib</code> where the trait <code>Circuit</code> is. All I am allowed to do to write the correct signature. The whole code of the project is too huge and tricky, I do not think it is a good idea to share it.</p>\n"}, {"tags": ["rust", "future", "rust-actix"], "answers": [{"comments": [{"owner": {"reputation": 87, "user_id": 10903524, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0746494ecc1b6ab1be36ae024db6d1a2?s=128&d=identicon&r=PG&f=1", "display_name": "David Tex", "link": "https://stackoverflow.com/users/10903524/david-tex"}, "edited": false, "score": 1, "creation_date": 1548170274, "post_id": 54309388, "comment_id": 95442555, "body": "what are combinators?"}], "tags": [], "owner": {"reputation": 652, "user_id": 10500566, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b383503f8579bf5faa16188e68e6ce75?s=128&d=identicon&r=PG", "display_name": "Sajjad Pourali", "link": "https://stackoverflow.com/users/10500566/sajjad-pourali"}, "is_accepted": true, "score": 2, "last_activity_date": 1548164417, "last_edit_date": 1548164417, "creation_date": 1548163772, "answer_id": 54309388, "question_id": 54306821, "link": "https://stackoverflow.com/questions/54306821/append-data-to-proxied-response-in-actix-web/54309388#54309388", "title": "Append data to proxied response in Actix-web", "body": "<p>You can solve your problem by using futures combinators.</p>\n\n<p>for example :</p>\n\n<pre><code>Box::new(request.body().map_err(|e| e.into()).and_then(|mut x|{\n    client::ClientRequest::get(\"http://example.com/\")\n        .finish()\n        .unwrap()\n        .send()\n        .map_err(Error::from)\n        .and_then(|resp| {\n            resp.body()\n                .from_err()\n                .and_then(|body| {\n                    x.extend(body);\n                    Ok(HttpResponse::Ok().body(x))\n                })\n        })\n}))\n</code></pre>\n"}], "owner": {"reputation": 87, "user_id": 10903524, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0746494ecc1b6ab1be36ae024db6d1a2?s=128&d=identicon&r=PG&f=1", "display_name": "David Tex", "link": "https://stackoverflow.com/users/10903524/david-tex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 157, "favorite_count": 0, "accepted_answer_id": 54309388, "answer_count": 1, "score": 1, "last_activity_date": 1575135604, "creation_date": 1548154846, "last_edit_date": 1575135604, "question_id": 54306821, "link": "https://stackoverflow.com/questions/54306821/append-data-to-proxied-response-in-actix-web", "title": "Append data to proxied response in Actix-web", "body": "<p>I would like to append user's request data to peroxided response in <code>actix-web</code>, but <code>type mismatch resolving</code> error will happend.</p>\n\n<p>I think it's about rust futures but I don't have idea about this problem and how can I fix it.</p>\n\n<p>Sample Code :</p>\n\n<pre><code>use actix_web::*;\nuse futures::future::ok;\nuse futures::Future;\n\nfn show_request(\n    request: &amp;actix_web::HttpRequest,\n) -&gt; Box&lt;Future&lt;Item = HttpResponse, Error = Error&gt;&gt; {\n    let mut result: Vec&lt;u8&gt; = Vec::new();\n    Box::new(request.body().map_err(|e| e.into()).map(move |f| {\n        result.extend(f); \n        client::ClientRequest::get(\"http://example.com/\")\n            .finish().unwrap()\n            .send()\n            .map_err(Error::from)\n            .and_then(\n                |resp| resp.body() \n                    .from_err()  \n                    .and_then(|body| { \n                        result.extend(body); // append request body to response proxied site\n                        Ok(HttpResponse::Ok().body(result))\n                    }))\n\n\n    }))\n}\n\npub fn index(scope: actix_web::Scope&lt;()&gt;) -&gt; actix_web::Scope&lt;()&gt; {\n    scope.handler(\"\", |req: &amp;actix_web::HttpRequest| {\n        show_request(req)\n    })\n}\n\nfn main() {\n    actix_web::server::new(|| {\n        vec![\n            actix_web::App::new()\n                .scope(\"\", index)\n                .boxed(),\n\n        ]\n    }).bind(\"127.0.0.1:8000\")\n        .expect(\"Can not bind to port 8000\")\n        .run();\n}\n</code></pre>\n\n<p>Cargo.toml</p>\n\n<pre><code>[package]\nname = \"temp\"\nversion = \"0.1.0\"\nauthors = [\"John\"]\nedition = \"2018\"\n\n[dependencies]\nactix-web = \"0.7\"\nfutures = \"0.1\"\n</code></pre>\n\n<p>Shown error :</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0271]: type mismatch resolving `&lt;[closure@src/main.rs:9:55: 24:6 result:_] as std::ops::FnOnce&lt;(bytes::bytes::Bytes,)&gt;&gt;::Output == actix_web::httpresponse::HttpResponse`\n  --&gt; src/main.rs:9:5\n   |\n9  | /     Box::new(request.body().map_err(|e| e.into()).map(move |f| {\n10 | |         result.extend(f);\n11 | |         client::ClientRequest::get(\"http://example.com/\")\n12 | |             .finish().unwrap()\n...  |\n23 | |\n24 | |     }))\n   | |_______^ expected struct `futures::future::and_then::AndThen`, found struct `actix_web::httpresponse::HttpResponse`\n   |\n   = note: expected type `futures::future::and_then::AndThen&lt;futures::future::map_err::MapErr&lt;actix_web::client::pipeline::SendRequest, fn(actix_web::client::pipeline::SendRequestError) -&gt; actix_web::error::Error {&lt;actix_web::error::Error as std::convert::From&lt;actix_web::client::pipeline::SendRequestError&gt;&gt;::from}&gt;, futures::future::and_then::AndThen&lt;futures::future::from_err::FromErr&lt;actix_web::httpmessage::MessageBody&lt;actix_web::client::response::ClientResponse&gt;, actix_web::error::Error&gt;, std::result::Result&lt;actix_web::httpresponse::HttpResponse, actix_web::error::Error&gt;, [closure@src/main.rs:18:19: 21:10 result:_]&gt;, [closure@src/main.rs:16:8: 21:11 result:_]&gt;`\n              found type `actix_web::httpresponse::HttpResponse`\n   = note: required because of the requirements on the impl of `futures::future::Future` for `futures::future::map::Map&lt;futures::future::map_err::MapErr&lt;actix_web::httpmessage::MessageBody&lt;actix_web::httprequest::HttpRequest&gt;, [closure@src/main.rs:9:37: 9:49]&gt;, [closure@src/main.rs:9:55: 24:6 result:_]&gt;`\n   = note: required for the cast to the object type `dyn futures::future::Future&lt;Error=actix_web::error::Error, Item=actix_web::httpresponse::HttpResponse&gt;\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 0, "creation_date": 1548146376, "post_id": 54303935, "comment_id": 95428205, "body": "I neither know nor understand alga-derive, but the error message seems to suggest that you need to implement the <a href=\"https://rust-num.github.io/num/num/trait.Zero.html\" rel=\"nofollow noreferrer\"><code>Zero</code></a> trait from the <code>num</code> crate."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1548154673, "post_id": 54303935, "comment_id": 95433247, "body": "I can compile your code fine, without any errors. The only change was to add imports:  <code>use alga_derive::Alga;</code> and  <code>use alga::general::{AbstractMagma, Additive, Identity, Inverse};</code>, using version 0.7.1  of both alga and alga_derive."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 2, "creation_date": 1548154866, "post_id": 54303935, "comment_id": 95433366, "body": "Please check your provided code in isolation, to make sure that it can be used to reproduce your problem."}, {"owner": {"reputation": 7066, "user_id": 94102, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/622606bdd7ad08e2d2e177a8a8bb507a?s=128&d=identicon&r=PG", "display_name": "Jeremy Salwen", "link": "https://stackoverflow.com/users/94102/jeremy-salwen"}, "edited": false, "score": 0, "creation_date": 1548178045, "post_id": 54303935, "comment_id": 95447026, "body": "As my original question stated, the problem was not that the code did not compile, it&#39;s that the compiler did not think that <code>TrivialGroup</code> satisfied the <code>AdditiveGroup</code> trait.  I have added a few lines to turn this failure to satisfy the trait into a self-contained compilation failure."}], "owner": {"reputation": 7066, "user_id": 94102, "user_type": "registered", "accept_rate": 68, "profile_image": "https://www.gravatar.com/avatar/622606bdd7ad08e2d2e177a8a8bb507a?s=128&d=identicon&r=PG", "display_name": "Jeremy Salwen", "link": "https://stackoverflow.com/users/94102/jeremy-salwen"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 53, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1548181418, "creation_date": 1548145076, "last_edit_date": 1548181418, "question_id": 54303935, "link": "https://stackoverflow.com/questions/54303935/defining-additivegroup-with-alga-crate", "title": "Defining AdditiveGroup with alga crate", "body": "<p>According to the  <a href=\"https://docs.rs/alga_derive/0.7.1/alga_derive/\" rel=\"nofollow noreferrer\">alga documentation</a>, the macros (defined in alga_traits):</p>\n\n<pre><code>#[derive(Alga)]\n#[alga_traits(Group(Additive))]\nstruct TrivialGroup;\n</code></pre>\n\n<p>can be used to implement the <code>AbstractGroup</code> marker trait with <code>Additive</code> operator, if implementations of the traits <code>Identity</code>, <code>PartialEq</code>, <code>Inverse</code> and <code>AbstractMagma</code> are provided.</p>\n\n<p>However, if I implement them as:</p>\n\n<pre><code>use alga::general::{AbstractMagma, Additive, AdditiveGroup, Identity, Inverse}; // 0.7.2\nuse alga_derive::Alga; // 0.7.1\n\n#[derive(Alga, Clone, Copy, PartialEq, Debug)]\n#[alga_traits(Group(Additive))]\npub struct TrivialGroup;\n\nimpl AbstractMagma&lt;Additive&gt; for TrivialGroup {\n    fn operate(&amp;self, _right: &amp;Self) -&gt; Self {\n        TrivialGroup {}\n    }\n}\n\nimpl Identity&lt;Additive&gt; for TrivialGroup {\n    fn identity() -&gt; Self {\n        TrivialGroup {}\n    }\n}\n\nimpl Inverse&lt;Additive&gt; for TrivialGroup {\n    fn inverse(&amp;self) -&gt; Self {\n        TrivialGroup {}\n    }\n}\n\nstruct Bar&lt;T: AdditiveGroup&gt; {\n    t: T,\n}\n\nfn main() {\n    let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n}\n</code></pre>\n\n<p>The compiler still doesn't think that <code>TrivialGroup</code> satisfies the <code>AdditiveGroup</code> trait:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `TrivialGroup: num_traits::identities::Zero` is not satisfied\n  --&gt; src/main.rs:31:15\n   |\n31 |     let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n   |               ^^^^^^^^^^^^^^^^^^^ the trait `num_traits::identities::Zero` is not implemented for `TrivialGroup`\n   |\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveLoop` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveGroup` for `TrivialGroup`\nnote: required by `Bar`\n  --&gt; src/main.rs:26:1\n   |\n26 | struct Bar&lt;T: AdditiveGroup&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror[E0277]: the trait bound `TrivialGroup: std::ops::Neg` is not satisfied\n  --&gt; src/main.rs:31:15\n   |\n31 |     let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n   |               ^^^^^^^^^^^^^^^^^^^ the trait `std::ops::Neg` is not implemented for `TrivialGroup`\n   |\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::ClosedNeg` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveLoop` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveGroup` for `TrivialGroup`\nnote: required by `Bar`\n  --&gt; src/main.rs:26:1\n   |\n26 | struct Bar&lt;T: AdditiveGroup&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror[E0277]: cannot subtract `TrivialGroup` from `TrivialGroup`\n  --&gt; src/main.rs:31:15\n   |\n31 |     let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n   |               ^^^^^^^^^^^^^^^^^^^ no implementation for `TrivialGroup - TrivialGroup`\n   |\n   = help: the trait `std::ops::Sub` is not implemented for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::ClosedSub` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveQuasigroup` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveLoop` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveGroup` for `TrivialGroup`\nnote: required by `Bar`\n  --&gt; src/main.rs:26:1\n   |\n26 | struct Bar&lt;T: AdditiveGroup&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror[E0277]: cannot subtract-assign `TrivialGroup` from `TrivialGroup`\n  --&gt; src/main.rs:31:15\n   |\n31 |     let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n   |               ^^^^^^^^^^^^^^^^^^^ no implementation for `TrivialGroup -= TrivialGroup`\n   |\n   = help: the trait `std::ops::SubAssign` is not implemented for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::ClosedSub` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveQuasigroup` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveLoop` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveGroup` for `TrivialGroup`\nnote: required by `Bar`\n  --&gt; src/main.rs:26:1\n   |\n26 | struct Bar&lt;T: AdditiveGroup&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n\nerror[E0277]: cannot add-assign `TrivialGroup` to `TrivialGroup`\n  --&gt; src/main.rs:31:15\n   |\n31 |     let foo = Bar::&lt;TrivialGroup&gt; { t: TrivialGroup {} };\n   |               ^^^^^^^^^^^^^^^^^^^ no implementation for `TrivialGroup += TrivialGroup`\n   |\n   = help: the trait `std::ops::AddAssign` is not implemented for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::ClosedAdd` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveSemigroup` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveMonoid` for `TrivialGroup`\n   = note: required because of the requirements on the impl of `_ALGA_DERIVE_TrivialGroup::_alga::general::AdditiveGroup` for `TrivialGroup`\nnote: required by `Bar`\n  --&gt; src/main.rs:26:1\n   |\n26 | struct Bar&lt;T: AdditiveGroup&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>How should I define my additive group instead?</p>\n"}, {"tags": ["file", "rust"], "answers": [{"tags": [], "owner": {"reputation": 18446, "user_id": 274299, "user_type": "registered", "accept_rate": 60, "profile_image": "https://i.stack.imgur.com/ohONY.png?s=128&g=1", "display_name": "0xAX", "link": "https://stackoverflow.com/users/274299/0xax"}, "is_accepted": false, "score": 11, "last_activity_date": 1571828035, "last_edit_date": 1571828035, "creation_date": 1548143505, "answer_id": 54303514, "question_id": 54303398, "link": "https://stackoverflow.com/questions/54303398/how-to-get-the-size-of-an-already-opened-file-in-rust/54303514#54303514", "title": "How to get the size of an already-opened File in Rust?", "body": "<p>The <code>std::fs::File</code> provides a <a href=\"https://doc.rust-lang.org/std/fs/struct.File.html#method.metadata\" rel=\"noreferrer\"><code>metadata</code></a> method. It can be used with your <code>my_file</code> like this:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>my_file.metadata().unwrap().len();\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": true, "score": 7, "last_activity_date": 1586865891, "last_edit_date": 1586865891, "creation_date": 1548143788, "answer_id": 54303584, "question_id": 54303398, "link": "https://stackoverflow.com/questions/54303398/how-to-get-the-size-of-an-already-opened-file-in-rust/54303584#54303584", "title": "How to get the size of an already-opened File in Rust?", "body": "<p>There are a few options. </p>\n\n<ol>\n<li><p>If you create the file like you did (<code>File::create</code>), you will truncate the file, which means it will set the size of that file to <code>0</code> and write the content of <code>buffer</code> to the file. This means that your file will now have the length <code>buffer.len()</code>.</p></li>\n<li><p>Use <a href=\"https://doc.rust-lang.org/std/fs/struct.File.html#method.metadata\" rel=\"nofollow noreferrer\"><code>File::metadata</code></a> to get the metadata and therefore get the length of the file. Keep in mind that you have to sync the file (by using <a href=\"https://doc.rust-lang.org/std/fs/struct.File.html#method.sync_all\" rel=\"nofollow noreferrer\"><code>File::sync_all</code></a>) with the underlying filesystem to update the metadata and get the correct value.</p></li>\n<li><p>Use <a href=\"https://doc.rust-lang.org/std/io/trait.Seek.html#tymethod.seek\" rel=\"nofollow noreferrer\"><code>Seek::seek</code></a> which <code>File</code> implements. You can then get the current offset by using <code>my_file.seek(SeekFrom::End(0))</code> which will tell you the last position available.</p></li>\n<li><p>On nightly (expected for release 1.35.0), you can use <a href=\"https://doc.rust-lang.org/nightly/std/io/trait.Seek.html#method.stream_len\" rel=\"nofollow noreferrer\"><code>Seek::stream_len</code></a>, which, unlike <code>seek(SeekFrom::End(0))</code>, restores the previous seek position.</p></li>\n</ol>\n"}], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3868, "favorite_count": 1, "accepted_answer_id": 54303584, "answer_count": 2, "score": 8, "last_activity_date": 1586865891, "creation_date": 1548142962, "last_edit_date": 1548166585, "question_id": 54303398, "link": "https://stackoverflow.com/questions/54303398/how-to-get-the-size-of-an-already-opened-file-in-rust", "title": "How to get the size of an already-opened File in Rust?", "body": "<p>How can I get the size/length of the file that is declared as a <code>File</code> variable?</p>\n\n<p>There is an option for getting it using the file name via <code>fs::metadata</code>:</p>\n\n<pre><code>let x = fs::metadata(file_path)?.len();\n</code></pre>\n\n<p>But I have a file that I already created and edited:</p>\n\n<pre><code>let mut my_file = File::create(file_path).unwrap();\nmy_file.write_all(buffer) // buffer is a data which comes from network and put into Vec&lt;u8&gt;\n\n// From here, does it possible to get my_file length?\n// Looking something like my_file.len();\n</code></pre>\n\n<p>Are there any function that gives the length of the <code>File</code>?</p>\n"}, {"tags": ["macos", "rust"], "comments": [{"owner": {"reputation": 8454, "user_id": 958529, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/c3ec25db39c63bab1a11037649e326b8?s=128&d=identicon&r=PG", "display_name": "halfelf", "link": "https://stackoverflow.com/users/958529/halfelf"}, "edited": false, "score": 2, "creation_date": 1548135432, "post_id": 54301401, "comment_id": 95423670, "body": "Seems a darwin platform issue. Cannot reproduce on <code>stable-x86_64-unknown-linux-gnu</code>."}, {"owner": {"reputation": 321, "user_id": 7562670, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/lyaYy.jpg?s=128&g=1", "display_name": "Seiichi Uchida", "link": "https://stackoverflow.com/users/7562670/seiichi-uchida"}, "edited": false, "score": 0, "creation_date": 1548139924, "post_id": 54301401, "comment_id": 95425241, "body": "Could not reproduce with <code>rustup 1.16.0 (beab5ac2b 2018-12-06)</code> on macOS Mojovae. If you have not updated <code>rustup</code>, could you please try with the latest <code>rustup</code>? You can update it by running <code>rustup self update</code>."}], "answers": [{"tags": [], "owner": {"reputation": 573, "user_id": 564413, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/86687090f229c02fb7196df64e51b8cd?s=128&d=identicon&r=PG", "display_name": "blandger", "link": "https://stackoverflow.com/users/564413/blandger"}, "is_accepted": true, "score": 3, "last_activity_date": 1548168279, "last_edit_date": 1548168279, "creation_date": 1548161952, "answer_id": 54308848, "question_id": 54301401, "link": "https://stackoverflow.com/questions/54301401/how-to-install-rustfmt-with-the-release-of-rust-1-32/54308848#54308848", "title": "How to install rustfmt with the release of Rust 1.32?", "body": "<p>You can try these commands:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>rustup toolchain remove stable &amp;&amp; rustup toolchain add stable\n</code></pre>\n\n<p>OR</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>rustup toolchain remove stable &amp;&amp; rustup toolchain install stable\n</code></pre>\n\n<p>It can help in several cases after compiler version updates, like <strong>rustfmt</strong>, <strong>clippy</strong>, or other Rust components.</p>\n"}], "owner": {"user_type": "does_not_exist", "display_name": "user8370684"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 434, "favorite_count": 0, "accepted_answer_id": 54308848, "answer_count": 1, "score": 2, "last_activity_date": 1548168279, "creation_date": 1548132236, "last_edit_date": 1548168235, "question_id": 54301401, "link": "https://stackoverflow.com/questions/54301401/how-to-install-rustfmt-with-the-release-of-rust-1-32", "title": "How to install rustfmt with the release of Rust 1.32?", "body": "<p>I'm on macOS Mojave. I've used Rust in the past and rustfmt has always worked, but I can no longer download rustfmt. </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ rustup show\nDefault host: x86_64-apple-darwin\nstable-x86_64-apple-darwin (default)\nrustc 1.32.0 (9fda7c223 2019-01-16)\n\n$ rustup component add rustfmt\nerror: toolchain 'stable-x86_64-apple-darwin' does not contain component 'rustfmt' for target 'x86_64-apple-darwin'\n</code></pre>\n\n<p>Is there some other command that I need to execute?</p>\n"}, {"tags": ["rust", "ffi"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548128257, "post_id": 54300524, "comment_id": 95422010, "body": "empty type is not a thing in C, Also return an empty type don&#39;t make much sense to me, however <code>void</code> should &quot;work&quot; in most case. But <code>int</code> don&#39;t make any sense, rust empty type are empty."}, {"owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548131034, "post_id": 54300524, "comment_id": 95422589, "body": "Yeah sorry it&#39;s not a great example. I edited in a link to my actual code. Anyway my question has been answered."}], "answers": [{"comments": [{"owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "edited": false, "score": 0, "creation_date": 1548125982, "post_id": 54300623, "comment_id": 95421496, "body": "Yeah I dumbed down the example to cut down on the noise. Apparently I cut too much. In my actual code I&#39;m storing nontrivial data (TcpListener and TcpStream) and after passing them to C and back I&#39;m able to successfully send and receive data on the sockets."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "edited": false, "score": 0, "creation_date": 1548126372, "post_id": 54300623, "comment_id": 95421564, "body": "@anderspitman you put a struct containing those as an <code>int</code> on the C half of the code? They definitely cannot fit in that. I bet if you run in valgrind you will get a whole mess of errors."}, {"owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "edited": false, "score": 0, "creation_date": 1548126634, "post_id": 54300623, "comment_id": 95421630, "body": "Haha yeah. I was very surprised it was working at all. I&#39;ll read the omnibus and report back when I have a better overall understanding."}, {"owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "edited": false, "score": 0, "creation_date": 1548130867, "post_id": 54300623, "comment_id": 95422554, "body": "The omnibus is an excellent resource, and makes it obvious what I was doing wrong. In any case your answer makes it clear what I was doing is wrong and likely undefined, which is the correct answer. Thanks for your help!"}, {"owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "edited": false, "score": 1, "creation_date": 1548698616, "post_id": 54300623, "comment_id": 95626444, "body": "just wanted to report back and say thanks again. I was able to get everything working using the Omnibus as a guide."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 3, "last_activity_date": 1548165826, "last_edit_date": 1548165826, "creation_date": 1548125632, "answer_id": 54300623, "question_id": 54300524, "link": "https://stackoverflow.com/questions/54300524/what-is-returned-when-a-rust-ffi-function-returns-a-struct-without-reprc-to/54300623#54300623", "title": "What is returned when a Rust FFI function returns a struct without #[repr(C)] to C?", "body": "<p>TL;DR: The example isn't a useful one and doesn't show anything. </p>\n\n<blockquote>\n  <p>what does it actually get? Is it a pointer? An id of some sort?</p>\n</blockquote>\n\n<p>It's the struct, exactly as defined on the Rust side. It's a pointer if you return a pointer (this example does not) or an id if you return some id (this example does not).</p>\n\n<p>Rust's FFI imposes no overhead or abstraction \u2014\u00a0what you return is what is returned.</p>\n\n<blockquote>\n  <p>the documentation seems to indicate that I should be using <code>#[repr(C)]</code></p>\n</blockquote>\n\n<p>Yes, <em>you should</em>. Without it, your code is most likely undefined behavior. The layout of a Rust struct is not yet guaranteed. Without specifying the representation as C, there's no way for the C code to know which fields are where. </p>\n\n<blockquote>\n  <p>but it seems to work without it</p>\n</blockquote>\n\n<p>That's because your example struct has no fields and thus no size (which AFAIK isn't even valid in C without non-standard extensions). Rust basically never even needs to look at the data (what data?) so it doesn't matter what you pass back.</p>\n\n<blockquote>\n  <p>When printing the value received on the C side, it's showing very small integers</p>\n</blockquote>\n\n<p>This is probably just junk on the stack laying around. Literally uninitialized data. </p>\n\n<h1>Using a struct with fields without <code>#[repr(C)]</code></h1>\n\n<p>This is <strong>bad</strong>. Don't do it. <code>String</code> is a struct with non-trivial fields and it is not marked <code>#[repr(C)]</code>.</p>\n\n<p><strong>Cargo.toml</strong></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>[package]\nname = \"shear\"\nversion = \"0.1.0\"\nauthors = [\"An Devloper\"]\n\n[lib]\ncrate-type = [\"cdylib\"]\n\n[dependencies]\n</code></pre>\n\n<p><strong>src/lib.rs</strong></p>\n\n<pre><code>// Don't do this, `String` isn't #[repr(C)]!\n#[no_mangle]\npub extern \"C\" fn create_example() -&gt; String {\n    String::from(\"hello\")\n}\n\n// Don't do this, `String` isn't #[repr(C)]!\n#[no_mangle]\npub extern \"C\" fn use_example(e: String) {\n    println!(\"{}\", e);\n}\n</code></pre>\n\n<p><strong>main.c</strong></p>\n\n<pre class=\"lang-c prettyprint-override\"><code>extern int create_example();\nextern void use_example(int example);\n\nint main(int argc, char **argv) {\n  int example = create_example();\n  use_example(example);\n}\n</code></pre>\n\n<p><strong>Execution</strong></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ cargo build\n   Compiling shear v0.1.0 (file:///home/ubuntu/shear)\n    Finished dev [unoptimized + debuginfo] target(s) in 1.02s\n$ gcc -o example main.c -L target/debug/ -lshear\n$ LD_LIBRARY_PATH=target/debug/ ./example\nSegmentation fault\n</code></pre>\n\n<hr>\n\n<p>Please read the <a href=\"http://jakegoulding.com/rust-ffi-omnibus/\" rel=\"nofollow noreferrer\">The Rust FFI Omnibus</a> for details about how to properly transfer values across the FFI boundary. Disclaimer: I am the primary author.</p>\n"}], "owner": {"reputation": 6086, "user_id": 943814, "user_type": "registered", "accept_rate": 74, "profile_image": "https://www.gravatar.com/avatar/e8b4b9fc52a3084be9a2de004e0bb6dc?s=128&d=identicon&r=PG", "display_name": "anderspitman", "link": "https://stackoverflow.com/users/943814/anderspitman"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 392, "favorite_count": 0, "accepted_answer_id": 54300623, "answer_count": 1, "score": 0, "last_activity_date": 1548165826, "creation_date": 1548124717, "last_edit_date": 1548131004, "question_id": 54300524, "link": "https://stackoverflow.com/questions/54300524/what-is-returned-when-a-rust-ffi-function-returns-a-struct-without-reprc-to", "title": "What is returned when a Rust FFI function returns a struct without #[repr(C)] to C?", "body": "<p>EDIT: It was pointed out that my example isn't complete enough to be useful. My question is resolved, but if you're interested in looking at the complete code you can see it <a href=\"https://github.com/anderspitman/messtcp/blob/ea27eef487117b8df9e006a808f80b6169edea01/src/lib.rs\" rel=\"nofollow noreferrer\">here</a>.</p>\n\n<p>Given the following code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#[no_mangle]\npub extern \"C\" fn create_acceptor() -&gt; Acceptor {\n    Acceptor {}\n}\n\npub struct Acceptor {}\n</code></pre>\n\n<p>If I call this from C what does it actually get? Is it a pointer? An id of some sort?</p>\n\n<p>I'm currently using code like the following on the C side:</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>extern int create_acceptor();\n\nint main(int argc, char **argv) {\n        int acceptor = create_acceptor();\n        return 0;\n}\n</code></pre>\n\n<p>It seems to work fine. I'm using it like an opaque type that I pass back to Rust like <code>acceptor_doSomething(acceptor)</code>.</p>\n\n<p>But I'm confused because it doesn't seem to matter what type I use for <code>acceptor</code> on the C side. <code>void*</code> and <code>int</code> both behave the same. Also, the documentation seems to indicate that I should be using <code>#[repr(C)]</code>, but it seems to work without it. Why is that?</p>\n\n<p>When printing the value received on the C side, it's showing very small integers, so I'm guessing it's an id on the Rust side?</p>\n"}, {"tags": ["rust", "dyon"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1548117524, "creation_date": 1548117524, "answer_id": 54299714, "question_id": 54299344, "link": "https://stackoverflow.com/questions/54299344/how-do-i-call-a-built-in-dyon-function-from-rust/54299714#54299714", "title": "How do I call a built-in Dyon function from Rust?", "body": "<p>I can't explain the design decisions here, but <code>call_str_ret</code> <a href=\"https://github.com/PistonDevelopers/dyon/blob/c5072a442987a28e33fa5a67d1179164aac79662/src/runtime/mod.rs#L1181-L1203\" rel=\"nofollow noreferrer\">only handles functions that have been loaded</a>, not <a href=\"https://github.com/PistonDevelopers/dyon/blob/c5072a442987a28e33fa5a67d1179164aac79662/src/lib.rs#L481-L500\" rel=\"nofollow noreferrer\">external functions or intrinsics</a>.</p>\n\n<p>As a workaround, you can load a little shim function that just calls off to the appropriate function:</p>\n\n<pre><code>use dyon::{Module, Runtime, Variable};\nuse std::sync::Arc;\n\nfn main() {\n    let mut dyon_runtime = Runtime::new();\n    let mut module = Module::new();\n\n    let shim = Arc::new(\"do_it(x) = sin(x)\".into());\n    dyon::load_str(\"main.rs\", shim, &amp;mut module).expect(\"Unable to load shim function\");\n    let dyon_module = Arc::new(module);\n\n    let v = dyon_runtime.call_str_ret(\"do_it\", &amp;[Variable::f64(90.0)], &amp;dyon_module);\n    match v {\n        Err(e) =&gt; {\n            eprintln!(\"Error: {:?}\", e);\n        }\n        Ok(v) =&gt; {\n            println!(\"Called sin - result {:?}\", v);\n        }\n    };\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>Called sin - result F64(0.8939966636005579, None)\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 2, "last_activity_date": 1548122575, "last_edit_date": 1548122575, "creation_date": 1548119488, "answer_id": 54299905, "question_id": 54299344, "link": "https://stackoverflow.com/questions/54299344/how-do-i-call-a-built-in-dyon-function-from-rust/54299905#54299905", "title": "How do I call a built-in Dyon function from Rust?", "body": "<p><a href=\"https://docs.rs/dyon/0.40.0/src/dyon/runtime/mod.rs.html#1142-1169\" rel=\"nofollow noreferrer\"><code>call_str()</code></a> only cares about one type of function call. I don't know why they do this, but one solution would be to do it yourself:</p>\n\n<pre><code>use dyon::{ast, Module, Runtime, Variable};\nuse range::Range;\nuse std::cell::Cell;\nuse std::sync::Arc;\n\nfn main() {\n    let mut dyon_runtime = Runtime::new();\n    let module = Module::new();\n\n    let name: Arc&lt;String&gt; = Arc::new(\"sin\".into());\n    let f_index = Cell::new(module.find_function(&amp;name, 0));\n    let args = vec![ast::Expression::Variable(Box::new((\n        Range::empty(0),\n        Variable::F64(1.0, None),\n    )))];\n    let call = ast::Call {\n        alias: None,\n        name,\n        f_index,\n        args,\n        custom_source: None,\n        source_range: Range::empty(0),\n    };\n    let dyon_module = Arc::new(module);\n    println!(\"{:?}\", dyon_runtime.call(&amp;call, &amp;dyon_module));\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "is_accepted": true, "score": 0, "last_activity_date": 1548370962, "last_edit_date": 1548370962, "creation_date": 1548148549, "answer_id": 54304829, "question_id": 54299344, "link": "https://stackoverflow.com/questions/54299344/how-do-i-call-a-built-in-dyon-function-from-rust/54304829#54304829", "title": "How do I call a built-in Dyon function from Rust?", "body": "<p>Both of the other answers led me to a solution that works cleanly for both cases:\nI took the <code>Runtime.call_str_ret</code> and modified it to use any non-None result from <code>module.find_function</code>. IMO the code is actually cleaner than the original version in Runtime. I've submitted a PR for this which has been merged, so releases of Dyon after 0.40.0 will have <code>call_str_ret</code> working for built-in functions.</p>\n\n<hr>\n\n<p>If you can't use a more recent version of Dyon, then you could manually apply the patch from here: <a href=\"https://github.com/PistonDevelopers/dyon/pull/582\" rel=\"nofollow noreferrer\">https://github.com/PistonDevelopers/dyon/pull/582</a>.</p>\n\n<p>Or alternatively you could use your own version of call_str_ret, like this: </p>\n\n<pre><code>use dyon::{Module, Runtime, Variable};\nuse std::sync::Arc;\n\nextern crate range;\n\n/// Call function by name, returning a value.\npub fn call_str_ret_ex(\n    runtime:&amp;mut Runtime,\n    function: &amp;str,\n    args: &amp;[Variable],\n    module: &amp;Arc&lt;Module&gt;\n) -&gt; Result&lt;Variable, String&gt; {\n    use std::cell::Cell;\n    use range::Range;\n    use dyon::FnIndex;\n    use dyon::runtime::Flow;\n    use dyon::ast;\n\n    let name: Arc&lt;String&gt; = Arc::new(function.into());\n    let fn_index = module.find_function(&amp;name, 0);\n    if let FnIndex::None = fn_index {\n        return Err(format!(\"Could not find function `{}`\",function))\n    }\n\n    let call = ast::Call {\n        alias: None,\n        name: name.clone(),\n        f_index: Cell::new(fn_index),\n        args: args.iter()\n                .map(|arg| ast::Expression::Variable(Box::new((\n                            Range::empty(0), arg.clone()))))\n                .collect(),\n        custom_source: None,\n        source_range: Range::empty(0),\n    };\n    match runtime.call(&amp;call, &amp;module) {\n        Ok((Some(val), Flow::Continue)) =&gt; Ok(val),\n        Err(err) =&gt; Err(err),\n        _ =&gt; Err(\"Error during call\".to_owned())\n    }\n}\n</code></pre>\n\n<p>This will let you write the original code as</p>\n\n<pre><code>def test_dyon_fn(\n    dyon_runtime: &amp;mut Runtime\n    module: &amp;Module,\n    fn: &amp;str,\n)\n    let v = call_str_ret_ex(&amp;mut dyon_runtime, fn, &amp;[Variable::f64(0.0)], &amp;dyon_module);\nmatch v {\n    Err(e) =&gt; {\n        eprintln!(\"Error: {:?}\", e);\n    }\n    Ok(v) =&gt; {\n        println!(\"Called {:?}  - result {:?}\", fn, v);\n    }\n};\n\nfn main() {\n    let mut dyon_runtime = Runtime::new();\n    let mut module = Module::new();\n    let shim = Arc::new(\"sin_shim(x) = sin(x)\".into());\n    dyon::load_str(\"main.rs\", shim, &amp;mut module).expect(\"Unable to load shim function\");\n    let dyon_module = Arc::new(module);\n\n    test_dyon_fn(&amp;mut dyon_runtime, &amp;dyon_module, \"sin\");\n    test_dyon_fn(&amp;mut dyon_runtime, &amp;dyon_module, \"sin_shim\");\n    test_dyon_fn(&amp;mut dyon_runtime, &amp;dyon_module, \"no_such\");\n}\n</code></pre>\n\n<p>This prints:</p>\n\n<pre><code>Called sin - result F64(0.0, None)\nCalled sin_shim - result F64(0.0, None)\nError: \"Could not find function `no_such`\"\n</code></pre>\n"}], "owner": {"reputation": 60850, "user_id": 221955, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/0bc09e1bd45610fc85274cd7bb002c56?s=128&d=identicon&r=PG", "display_name": "Michael Anderson", "link": "https://stackoverflow.com/users/221955/michael-anderson"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 166, "favorite_count": 0, "accepted_answer_id": 54304829, "answer_count": 3, "score": 1, "last_activity_date": 1548370962, "creation_date": 1548114404, "last_edit_date": 1548115630, "question_id": 54299344, "link": "https://stackoverflow.com/questions/54299344/how-do-i-call-a-built-in-dyon-function-from-rust", "title": "How do I call a built-in Dyon function from Rust?", "body": "<p>I'm trying to call a Dyon built-in function (<code>sin</code>) from Rust:</p>\n\n<pre><code>use dyon::{Module, Runtime, Variable};\nuse std::sync::Arc;\n\nfn main() {\n    let mut dyon_runtime = Runtime::new();\n    let module = Module::new();\n    let dyon_module = Arc::new(module);\n    let v = dyon_runtime.call_str_ret(\"sin\", &amp;[Variable::f64(0.0)], &amp;dyon_module);\n    match v {\n        Err(e) =&gt; {\n            eprintln!(\"Error: {:?}\", e);\n        }\n        Ok(v) =&gt; {\n            println!(\"Called sin - result {:?}\", v);\n        }\n    };\n}\n</code></pre>\n\n<p>However, I get</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Error: \"Could not find function `sin`\"\n</code></pre>\n\n<p>What do I need to do to correctly call this function?</p>\n"}, {"tags": ["asynchronous", "rust", "rust-actix", "actix-web"], "answers": [{"tags": [], "owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "is_accepted": true, "score": 3, "last_activity_date": 1548166814, "last_edit_date": 1548166814, "creation_date": 1548142483, "answer_id": 54303297, "question_id": 54298923, "link": "https://stackoverflow.com/questions/54298923/forward-request-body-to-response-in-actix-web/54303297#54303297", "title": "Forward request body to response in Actix-Web", "body": "<p>You are trying to return a <code>Future</code> without <code>Box</code>ing, you are <code>Box</code>ing the response in <code>Map</code>'s closure, not the expected <code>Future</code>. Using <code>futures::future::ok</code> is not necessary because your <code>request.body</code> is already future. </p>\n\n<pre><code>fn show_request(\n    request: &amp;actix_web::HttpRequest,\n) -&gt; Box&lt;Future&lt;Item = HttpResponse, Error = Error&gt;&gt; {\n    Box::new(request.body().map_err(|e| e.into()).map(move |f| {\n        actix_web::HttpResponse::Ok()\n            .content_type(\"text/plain\")\n            .body(f)\n    }))\n}\n</code></pre>\n"}], "owner": {"reputation": 87, "user_id": 10903524, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0746494ecc1b6ab1be36ae024db6d1a2?s=128&d=identicon&r=PG&f=1", "display_name": "David Tex", "link": "https://stackoverflow.com/users/10903524/david-tex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 756, "favorite_count": 0, "accepted_answer_id": 54303297, "answer_count": 1, "score": 3, "last_activity_date": 1583994945, "creation_date": 1548111589, "last_edit_date": 1583994945, "question_id": 54298923, "link": "https://stackoverflow.com/questions/54298923/forward-request-body-to-response-in-actix-web", "title": "Forward request body to response in Actix-Web", "body": "<p>I would like to forward the Actix-Web request body to the response body (something like echo) but it gives a <code>mismatched types</code> error.</p>\n\n<pre><code>use actix_web::*;\nuse futures::future::ok;\nuse futures::Future;\n\nfn show_request(\n    request: &amp;actix_web::HttpRequest\n) -&gt; Box&lt;Future&lt;Item=HttpResponse, Error=Error&gt;&gt; {\n    request\n        .body()\n        .from_err::&lt;actix_web::error::PayloadError&gt;()\n        .map(move |f| {\n            Box::new(ok(actix_web::HttpResponse::Ok()\n                .content_type(\"text/plain\")\n                .body(f)))\n        })\n}\n\npub fn index(scope: actix_web::Scope&lt;()&gt;) -&gt; actix_web::Scope&lt;()&gt; {\n    scope.handler(\"\", |req: &amp;actix_web::HttpRequest| {\n        show_request(req)\n    })\n}\n\nfn main() {\n    actix_web::server::new(|| {\n        vec![\n            actix_web::App::new()\n                .scope(\"\", index)\n                .boxed(),\n\n        ]\n    }).bind(\"127.0.0.1:8000\")\n        .expect(\"Can not bind to port 8000\")\n        .run();\n}\n\n</code></pre>\n\n<pre><code>[package]\nname = \"temp\"\nversion = \"0.1.0\"\nauthors = [\"John\"]\nedition = \"2018\"\n\n[dependencies]\nactix-web = \"0.7\"\nfutures = \"0.1\"\n</code></pre>\n\n<p>error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/proj.rs:50:2\n   |\n49 |   ) -&gt; Box&lt;Future&lt;Item=HttpResponse, Error=Error&gt;&gt; {\n   |        ------------------------------------------- expected `std::boxed::Box&lt;(dyn futures::Future&lt;Error=actix_web::Error, Item=actix_web::HttpResponse&gt; + 'static)&gt;` because of return type\n50 |       request\n   |  _____^\n51 | |         .body()\n52 | |         .from_err::&lt;actix_web::error::PayloadError&gt;()\n53 | |         .map(move |f| {\n...  |\n56 | |                 .body(f)))\n57 | |         })\n   | |__________^ expected struct `std::boxed::Box`, found struct `futures::Map`\n   |\n   = note: expected type `std::boxed::Box&lt;(dyn futures::Future&lt;Error=actix_web::Error, Item=actix_web::HttpResponse&gt; + 'static)&gt;`\n              found type `futures::Map&lt;futures::future::FromErr&lt;actix_web::dev::MessageBody&lt;actix_web::HttpRequest&gt;, actix_web::error::PayloadError&gt;, [closure@src/.rs:53:8: 57:4]&gt;`\n</code></pre>\n\n<p>Why does this error occur and how can I fix it?</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "edited": false, "score": 0, "creation_date": 1548102166, "post_id": 54297254, "comment_id": 95414888, "body": "Haha, I didn&#39;t think it was lying to me :) Oh, I thought the option referred to the left hand side, and that&#39;s why I was confused."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 2, "last_activity_date": 1548102461, "last_edit_date": 1548102461, "creation_date": 1548102060, "answer_id": 54297254, "question_id": 54297183, "link": "https://stackoverflow.com/questions/54297183/why-do-i-get-the-error-no-method-named-collect-found-for-type-option/54297254#54297254", "title": "Why do I get the error &quot;no method named collect found for type Option&quot;?", "body": "<p>The error message isn't lying to you. <code>Option</code> does <strong>not</strong> have a method called <code>collect</code>.</p>\n\n<blockquote>\n  <p>I (think) I'm trying to collect the output of an iterator</p>\n</blockquote>\n\n<p><a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.nth\" rel=\"nofollow noreferrer\"><code>Iterator::nth</code></a> returns an <code>Option</code>. <code>Option</code> does not implement <code>Iterator</code>; you cannot call <code>collect</code> on it.</p>\n\n<blockquote>\n  <p><code>Option&lt;[&amp;str; 2]&gt;</code></p>\n</blockquote>\n\n<p>You can't do this, either:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/26757355/155423\">How do I collect into an array?</a></li>\n</ul>\n\n<hr>\n\n<p>I'd write this as</p>\n\n<pre><code>let mut graphemes = message.graphemes(true).fuse();\n\nlet message_opt = match (graphemes.next_back(), graphemes.next_back()) {\n    (Some(a), Some(b)) =&gt; Some([a, b]),\n    _ =&gt; None,\n};\n</code></pre>\n"}], "owner": {"reputation": 1543, "user_id": 3560724, "user_type": "registered", "accept_rate": 59, "profile_image": "https://www.gravatar.com/avatar/8405071cb6c766f5842267de9714aa0e?s=128&d=identicon&r=PG&f=1", "display_name": "Alex", "link": "https://stackoverflow.com/users/3560724/alex"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 431, "favorite_count": 0, "accepted_answer_id": 54297254, "answer_count": 1, "score": 1, "last_activity_date": 1548102461, "creation_date": 1548101713, "last_edit_date": 1548101919, "question_id": 54297183, "link": "https://stackoverflow.com/questions/54297183/why-do-i-get-the-error-no-method-named-collect-found-for-type-option", "title": "Why do I get the error &quot;no method named collect found for type Option&quot;?", "body": "<p>I'm doing the <a href=\"https://exercism.io/\" rel=\"nofollow noreferrer\">Exercism</a> Rust problem in which a string has arbitrary length, but could be null, and needs to be classified based on its last two graphemes.</p>\n\n<p>My understanding is that <code>Option</code> is used to account for something that could be null, or could be not null, when this is unknown at compile time, so I've tried this:</p>\n\n<pre><code>extern crate unicode_segmentation;\n\nuse unicode_segmentation::UnicodeSegmentation;\n\npub fn reply(message: &amp;str) -&gt; &amp;str {\n    let message_opt: Option&lt;[&amp;str; 2]&gt; = message.graphemes(true).rev().take(2).nth(0).collect();\n}\n</code></pre>\n\n<p>My understanding of which, is that the right hand side will give an array of two <code>&amp;str</code>s, if the string is non zero in length, or will return none, and the left hand side will store it as an option (so that I can later match on <code>Some</code> or <code>None</code>)</p>\n\n<p>The error is: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>no method named 'collect' found for type std::option::Option&lt;&amp;str&gt; in the current scope\n</code></pre>\n\n<p>This doesn't make sense to me, as I (think) I'm trying to collect the output of an iterator, I am not <em>collecting</em> an option.</p>\n"}, {"tags": ["json", "rust", "serde"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548113368, "post_id": 54295107, "comment_id": 95418784, "body": "&quot;REST API which returns the JSON above&quot;, that not a rest api..."}, {"owner": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1548173938, "post_id": 54295107, "comment_id": 95444806, "body": "What do you mean?"}], "answers": [{"comments": [{"owner": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "edited": false, "score": 0, "creation_date": 1548096894, "post_id": 54295220, "comment_id": 95412766, "body": "Thanks, I&#39;ve used a type alias <code>pub type DataValue = serde_json::Value;</code> and added a manual conversion function from <code>serde_json::Value</code> to a real <code>struct</code>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "edited": false, "score": 0, "creation_date": 1548097024, "post_id": 54295220, "comment_id": 95412819, "body": "@big_gie what do you mean by <i>&quot;a manual conversion function [...] to a real struct&quot;</i>? You don&#39;t know what number or kinds of data are coming in, so you cannot create a struct with fixed fields."}, {"owner": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "edited": false, "score": 0, "creation_date": 1548097576, "post_id": 54295220, "comment_id": 95413030, "body": "I know the structure of the received json. So for the above I have <code>struct Data { fields: Vec&lt;DataField&gt;, results: Vec&lt;Vec&lt;DataType&gt;&gt; }</code>. I have a function that takes the <code>serde_json::Value</code> and populate this struct by manually accessing the <code>serde_json::Value</code> fields."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "edited": false, "score": 0, "creation_date": 1548098135, "post_id": 54295220, "comment_id": 95413249, "body": "@big_gie ah, right, <code>columns</code> is a fixed schema. I&#39;ve updated to address that."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1548098105, "last_edit_date": 1548098105, "creation_date": 1548092474, "answer_id": 54295220, "question_id": 54295107, "link": "https://stackoverflow.com/questions/54295107/how-to-deserialize-json-where-the-types-of-the-values-are-specified-in-another-f/54295220#54295220", "title": "How to deserialize JSON where the types of the values are specified in another field?", "body": "<p>Your data is completely, hopelessly dynamic, which means that you don't get to use any nice tools like deriving <code>Deserialize</code>.</p>\n\n<p>You'll need to use <a href=\"https://docs.rs/serde_json/1.0.36/serde_json/enum.Value.html\" rel=\"nofollow noreferrer\"><code>serde_json::Value</code></a>, an enum of all possible JSON types for the data. You can derive a struct for the fixed structure though:</p>\n\n<pre><code>use serde_derive; // 1.0.84\nuse serde_json::{self, Value}; // 1.0.34 \n\nstatic INPUT: &amp;str = r#\"\n{\n    \"columns\": [\n        {\n            \"name\": \"stringColumn\",\n            \"type\": \"string\"\n        },\n        {\n            \"name\": \"DateColumn\",\n            \"type\": \"date\"\n        },\n        {\n            \"name\": \"NumberColumn\",\n            \"type\": \"number\"\n        }\n    ],\n    \"data\": [\n        [\n            \"This is a string\",\n            1548091093000,\n            123\n        ]\n    ]\n}\n\"#;\n\n#[derive(Debug, serde_derive::Deserialize)]\nstruct Thing {\n    columns: Vec&lt;Column&gt;,\n    data: Vec&lt;Vec&lt;Value&gt;&gt;,\n}\n\n#[derive(Debug, serde_derive::Deserialize)]\nstruct Column {\n    name: String,\n    r#type: String,\n}\n\nfn main() {\n    let data = serde_json::from_str::&lt;Thing&gt;(INPUT);\n    println!(\"{:#?}\", data)\n}\n</code></pre>\n\n<blockquote>\n  <p>A number can be an integer or a float</p>\n</blockquote>\n\n<p>This is already handled by <a href=\"https://docs.rs/serde_json/1.0.36/serde_json/struct.Number.html\" rel=\"nofollow noreferrer\"><code>serde_json::Number</code></a></p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/53018165/155423\">Can Serde deserialize JSON to one of a set of types depending on the value of a field?</a></li>\n</ul>\n"}], "owner": {"reputation": 2479, "user_id": 178154, "user_type": "registered", "accept_rate": 54, "profile_image": "https://www.gravatar.com/avatar/3325e461df2fda8738f35a8bf4fd735e?s=128&d=identicon&r=PG", "display_name": "big_gie", "link": "https://stackoverflow.com/users/178154/big-gie"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 327, "favorite_count": 0, "answer_count": 1, "score": 2, "last_activity_date": 1548098105, "creation_date": 1548091959, "last_edit_date": 1548092069, "question_id": 54295107, "link": "https://stackoverflow.com/questions/54295107/how-to-deserialize-json-where-the-types-of-the-values-are-specified-in-another-f", "title": "How to deserialize JSON where the types of the values are specified in another field?", "body": "<p>I'm not sure how I should attempt to deserialize some JSON that looks like this: </p>\n\n<pre class=\"lang-js prettyprint-override\"><code>{\n    \"columns\": [\n        {\n            \"name\": \"stringColumn\",\n            \"type\": \"string\"\n        },\n        {\n            \"name\": \"DateColumn\",\n            \"type\": \"date\"\n        },\n        {\n            \"name\": \"NumberColumn\",\n            \"type\": \"number\"\n        }\n    ],\n    \"data\": [\n        [\n            \"This is a string\",\n            1548091093000,\n            123\n        ]\n    ]\n}\n</code></pre>\n\n<p>The <code>columns</code> vector describes the types and number of entries inside an element of the <code>data</code> vector. The example above could be converted to CSV as such (ignoring the types):</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>stringColumn,DateColumn,NumberColumn\n\"This is a string\",1548091093000,123\n</code></pre>\n\n<p>Some extra challenges:</p>\n\n<ol>\n<li>A <code>number</code> can be an integer or a float. Should I represent it as an enum?</li>\n<li>The large number <code>1548091093000</code> is the number of <em>milliseconds</em> since the UNIX epoch (equivalent to <code>Monday, January 21, 2019 5:18:13 PM</code>). Because I have dates (using epoch) and numbers, I cannot distinguish them easily without having access to the \"header\" description...</li>\n<li>I'm using the <a href=\"https://crates.io/crates/restson\" rel=\"nofollow noreferrer\"><code>restson</code></a> to call a REST API which returns the JSON above. restson will call <code>serde_json::from_str()</code> with the final type. This means this type must implement <code>Deserialize</code>.</li>\n</ol>\n\n<p>How can I deserialize this?</p>\n"}, {"tags": ["rust", "ownership"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548084948, "post_id": 54293155, "comment_id": 95406872, "body": "Why not changing the signature of <code>increment_item</code> to take <code>self</code> instead of <code>&amp;mut self</code>?"}, {"owner": {"reputation": 1780, "user_id": 648661, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a2f49b925608fec6fe8520f0fbe4e14e?s=128&d=identicon&r=PG", "display_name": "Terseus", "link": "https://stackoverflow.com/users/648661/terseus"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548085083, "post_id": 54293155, "comment_id": 95406967, "body": "@hellow Because I don&#39;t want to consume the <code>Container</code> instance in the process, I&#39;m trying to design my wrapper to be as ergonomic as possible and abstract away <i>completely</i> the fact that <code>Item</code> must be consumed when changing it; I&#39;ll add it to the description."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548085360, "post_id": 54293155, "comment_id": 95407138, "body": "You can use an <code>Option&lt;Item&gt;</code> to <code>mem::replace</code> it with <code>None</code>, or you can <code>mem::replace</code> with a zeroed memory zone (unsafe)."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1548085394, "post_id": 54293155, "comment_id": 95407159, "body": "@Boiethios: Why <code>mem::replace</code>, just <code>take</code>! :)"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1548086062, "post_id": 54293155, "comment_id": 95407579, "body": "See the duplicate, and specifically <a href=\"https://stackoverflow.com/a/41370552/147192\">Shepmaster&#39;s answer</a>, which illustrates how to use an option for your use case."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548086131, "post_id": 54293155, "comment_id": 95407623, "body": "See also <a href=\"https://stackoverflow.com/q/29570781/155423\">Temporarily move out of borrowed content</a>; <a href=\"https://stackoverflow.com/q/52031002/155423\">How do I move out of a struct field that is an Option?</a>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 2920, "user_id": 210304, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/3c70d1833ed67198b6e364834b13c770?s=128&d=identicon&r=PG", "display_name": "Caio", "link": "https://stackoverflow.com/users/210304/caio"}, "edited": false, "score": 0, "creation_date": 1548086194, "post_id": 54293155, "comment_id": 95407649, "body": "@Caio how would that help? OP specifically states that they don&#39;t want to take <code>self</code> by value."}, {"owner": {"reputation": 2920, "user_id": 210304, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/3c70d1833ed67198b6e364834b13c770?s=128&d=identicon&r=PG", "display_name": "Caio", "link": "https://stackoverflow.com/users/210304/caio"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548087405, "post_id": 54293155, "comment_id": 95408324, "body": "@Shepmaster Sorry for the bad comment. It should be an additional <code>ContainerBuilder</code> struct instead. Deleted"}], "answers": [{"comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 1, "creation_date": 1548085472, "post_id": 54293313, "comment_id": 95407211, "body": "That&#39;s the way to do this, but I dislike to use <code>unwrap</code> each time I must use the field."}, {"owner": {"reputation": 1780, "user_id": 648661, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a2f49b925608fec6fe8520f0fbe4e14e?s=128&d=identicon&r=PG", "display_name": "Terseus", "link": "https://stackoverflow.com/users/648661/terseus"}, "edited": false, "score": 0, "creation_date": 1548086457, "post_id": 54293313, "comment_id": 95407806, "body": "Ey this looks like a good solution, I&#39;ll try it and accept the answer when I have some time, thanks!"}, {"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 0, "creation_date": 1548090166, "post_id": 54293313, "comment_id": 95409769, "body": "Just asking to learn, are we going to give answer the questions even they are duplicate? Or do we just flag them as duplicate?"}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 1, "creation_date": 1548091888, "post_id": 54293313, "comment_id": 95410598, "body": "@AkinerAlkan: It&#39;s better to flag as duplicate and not answer; but if a duplicate is only uncovered after an answer is made, then so be it. I should have waited for Shepmaster to check the question first, he&#39;s got a built-in duplicate detector ;)"}, {"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 1, "creation_date": 1548092545, "post_id": 54293313, "comment_id": 95410867, "body": "@Matthieu M.: I am recently started actively contributing SO as habbit and I can say that he is pretty much idol to me in here rust community :)"}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 3, "last_activity_date": 1548085379, "creation_date": 1548085379, "answer_id": 54293313, "question_id": 54293155, "link": "https://stackoverflow.com/questions/54293155/how-to-replace-the-value-of-a-struct-field-without-taking-ownership/54293313#54293313", "title": "How to replace the value of a struct field without taking ownership", "body": "<p>The simplest way is to use an <code>Option</code>:</p>\n\n<ul>\n<li>use <code>take</code> to take ownership of the item,</li>\n<li>then assign back <code>Some(...)</code>.</li>\n</ul>\n\n<p>If a panic occurs while the <code>Option</code> is empty, this is perfectly safe. No double-destruction occurs, and the container can even remain usable if you so desire.</p>\n\n<p>Or in code:</p>\n\n<pre><code>// Third-party API\nstruct Item {\n    x: u32,\n}\n\nimpl Item {\n    pub fn increment(self, amount: u32) -&gt; Self {\n        Item { x: self.x + amount }\n    }\n}\n\n// My API\nstruct Container {\n    item: Option&lt;Item&gt;,\n}\n\nimpl Container {\n    pub fn increment_item(&amp;mut self, amount: u32) {\n        let item = self.item.take().unwrap();\n        self.item = Some(self.item.increment(amount));\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 1780, "user_id": 648661, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a2f49b925608fec6fe8520f0fbe4e14e?s=128&d=identicon&r=PG", "display_name": "Terseus", "link": "https://stackoverflow.com/users/648661/terseus"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1021, "favorite_count": 1, "closed_date": 1548086027, "accepted_answer_id": 54293313, "answer_count": 1, "score": 0, "last_activity_date": 1548085379, "creation_date": 1548084777, "last_edit_date": 1548085233, "question_id": 54293155, "link": "https://stackoverflow.com/questions/54293155/how-to-replace-the-value-of-a-struct-field-without-taking-ownership", "closed_reason": "Duplicate", "title": "How to replace the value of a struct field without taking ownership", "body": "<p>(Following <a href=\"https://stackoverflow.com/q/54267665/648661\">&quot;cannot move out of borrowed content&quot; when replacing a struct field</a>)</p>\n\n<p>I have a third-party API where one struct have a method that consumes the instance and returns a new instance; I want to wrap this API in my own wrapper and abstract away the detail that the struct is consumed in the operation.</p>\n\n<p>This example explains what I'm trying to achieve:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// Third-party API\nstruct Item {\n    x: u32,\n}\n\nimpl Item {\n    pub fn increment(self, amount: u32) -&gt; Self {\n        Item { x: self.x + amount }\n    }\n}\n\n// My API\nstruct Container {\n    item: Item,\n}\n\nimpl Container {\n    pub fn increment_item(&amp;mut self, amount: u32) {\n        // This line causes \"cannot move out of borrowed content\" but this is exactly what I want to do\n        self.item = self.item.increment(amount);\n    }\n}\n</code></pre>\n\n<p>While now I understand the error I'm wondering how can I implement this without taking ownership of <code>self</code> inside <code>Container::increment_item</code>.</p>\n\n<p>Proposed solutions:</p>\n\n<ul>\n<li><strong>Change <code>Item::increment</code> to take <code>&amp;mut self</code> instead of <code>self</code>:</strong> I can't, <code>Item::increment</code> comes from a crate.</li>\n<li><strong>Use <code>mem::replace</code> (from <a href=\"https://stackoverflow.com/a/54268089/648661\">here</a>):</strong> Unfortunately constructing an <code>Item</code> instance it's not that easy, and to be honest I don't completely understand how the <code>mem::replace</code> solutions works.</li>\n<li><strong>Change <code>Container::increment_item</code> to take <code>self</code> instead of <code>&amp;mut self</code>:</strong> I don't want to consume the <code>Container</code> instance in the process, I'm trying to design my wrapper to be as ergonomic as possible and abstract away <em>completely</em> the fact that <code>Item</code> must be consumed when changing it.</li>\n</ul>\n\n<p>Some ideas on how to do it? Or am I trying an impossible design in Rust?</p>\n"}, {"tags": ["rust", "iterator"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548071600, "post_id": 54289278, "comment_id": 95399545, "body": "What is your <code>Map</code>?"}, {"owner": {"reputation": 14787, "user_id": 139766, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6352d881fa53799e7452d6edb2d1df89?s=128&d=identicon&r=PG", "display_name": "Callum Rogers", "link": "https://stackoverflow.com/users/139766/callum-rogers"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548071734, "post_id": 54289278, "comment_id": 95399629, "body": "@Boiethios: It&#39;s the standard library <a href=\"https://doc.rust-lang.org/core/iter/struct.Map.html\" rel=\"nofollow noreferrer\"><code>core::iter::Map</code></a> returned by <a href=\"https://doc.rust-lang.org/core/iter/trait.Iterator.html#method.map\" rel=\"nofollow noreferrer\"><code>Iterator#map</code></a>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1548075842, "post_id": 54289278, "comment_id": 95401724, "body": "<code>G</code> is a type parameter of <code>map_keys</code>, so it must be determined by the <i>caller</i> of <code>map_keys</code>. But your code is determining it from inside that function."}], "answers": [{"tags": [], "owner": {"reputation": 2920, "user_id": 210304, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/3c70d1833ed67198b6e364834b13c770?s=128&d=identicon&r=PG", "display_name": "Caio", "link": "https://stackoverflow.com/users/210304/caio"}, "is_accepted": false, "score": 0, "last_activity_date": 1548076854, "creation_date": 1548076854, "answer_id": 54290955, "question_id": 54289278, "link": "https://stackoverflow.com/questions/54289278/extending-iterator-over-pairs-with-map-keys/54290955#54290955", "title": "Extending Iterator over pairs with map_keys", "body": "<p><code>G</code> is tied by the method and abstracts over the concrete type being passed in for each function call. For example:</p>\n\n<pre><code>fn print&lt;T: core::fmt::Debug&gt;(t: T) {\n    println!(\"{:?}\", t);\n}\n\nfn main() {\n    print(1);\n    print(1f64);\n    print(\"1\");\n}\n</code></pre>\n\n<p>This means that it is not possible to return an arbitrary <strong>fixed</strong> <code>G</code> implementation but there are some workarounds.</p>\n\n<p>1 - Static dispatch. The code must be modified to receive and return the same generic:</p>\n\n<pre><code>use core::iter::Map;\n\ntrait KeyedIterator&lt;K, V&gt;: Iterator&lt;Item = (K, V)&gt; {\n    fn map_keys&lt;R, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt;\n    where\n        Self: Sized,\n        F: FnMut((K, V)) -&gt; (R, V),\n    {\n        self.map(f)\n    }\n}\n\nimpl&lt;I, K, V&gt; KeyedIterator&lt;K, V&gt; for I where I: Iterator&lt;Item = (K, V)&gt; {}\n\nfn main() {\n    let vec = vec![(1u32, 2i32), (3, 4), (5, 6)];\n    println!(\"{:?}\", vec.into_iter().map_keys(|(k, v)| (k as f64 + 0.8, v)).collect::&lt;Vec&lt;(f64, i32)&gt;&gt;());\n}\n</code></pre>\n\n<p>2 - Dynamic dispatch. With a little of run-time overhead, you can use <code>Box</code>.</p>\n\n<pre><code>trait KeyedIterator&lt;K, V&gt;: Iterator&lt;Item = (K, V)&gt; {\n    fn map_keys&lt;'a, R, F: 'a&gt;(self, mut f: F) -&gt; Box&lt;Iterator&lt;Item = (R, V)&gt; + 'a&gt;\n    where\n        Self: Sized + 'a,\n        F: FnMut(K) -&gt; R\n    {\n        Box::new(self.map(move |(key, value): (K, V)| (f(key), value)))\n    }\n}\n\nimpl&lt;I, K, V&gt; KeyedIterator&lt;K, V&gt; for I where\n    I: Iterator&lt;Item = (K, V)&gt; {}\n\nfn main() {\n    let vec = vec![(1u32, 2i32), (3, 4), (5, 6)];\n    println!(\n        \"{:?}\",\n        vec.into_iter()\n            .map_keys(|k| k as f64 + 0.8)\n            .collect::&lt;Vec&lt;(f64, i32)&gt;&gt;()\n    );\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 14787, "user_id": 139766, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6352d881fa53799e7452d6edb2d1df89?s=128&d=identicon&r=PG", "display_name": "Callum Rogers", "link": "https://stackoverflow.com/users/139766/callum-rogers"}, "edited": false, "score": 0, "creation_date": 1548080480, "post_id": 54290964, "comment_id": 95404351, "body": "Ah, this makes sense to me now! Re: the no existential return types in traits, do you know if this is an intrinsic problem that is unlikely to ever be possible or something that simply hasn&#39;t been implemented yet?"}, {"owner": {"reputation": 14787, "user_id": 139766, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6352d881fa53799e7452d6edb2d1df89?s=128&d=identicon&r=PG", "display_name": "Callum Rogers", "link": "https://stackoverflow.com/users/139766/callum-rogers"}, "edited": false, "score": 1, "creation_date": 1548080859, "post_id": 54290964, "comment_id": 95404571, "body": "Answering my own question, this may be possible in the future: <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/1522-conservative-impl-trait.md\" rel=\"nofollow noreferrer\">github.com/rust-lang/rfcs/blob/master/text/&hellip;</a>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 14787, "user_id": 139766, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6352d881fa53799e7452d6edb2d1df89?s=128&d=identicon&r=PG", "display_name": "Callum Rogers", "link": "https://stackoverflow.com/users/139766/callum-rogers"}, "edited": false, "score": 0, "creation_date": 1548081483, "post_id": 54290964, "comment_id": 95404927, "body": "It certainly would make the trait non-object-safe. Traits don&#39;t <i>need</i> to be object-safe of course, and I can&#39;t see any other theoretical problems with it. I definitely could be wrong on that point though!"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 4, "last_activity_date": 1548085628, "last_edit_date": 1548085628, "creation_date": 1548076876, "answer_id": 54290964, "question_id": 54289278, "link": "https://stackoverflow.com/questions/54289278/extending-iterator-over-pairs-with-map-keys/54290964#54290964", "title": "Extending Iterator over pairs with map_keys", "body": "<p>If you declare a type parameter for a type or a function, that type must be provided by the <em>caller</em>. However, in your code, you are attempting to determine the type <code>G</code> in the body of <code>map_keys</code>, based on the type of the closure that is defined there.</p>\n\n<p>Usually, the way to have a function body determine a type is with an existential return type (e.g. <code>Map&lt;Self, impl FnMut((K, V)) -&gt; (R, V)&gt;</code>. However, this is not permitted in trait methods.</p>\n\n<p>The pattern that is used for all the built-in iterator adapters will work for your use case though. That is, define a struct, which is returned by your method and make it an iterator:</p>\n\n<pre><code>// Struct to hold the state of the iterator\nstruct KeyedIter&lt;I, F&gt; {\n    iter: I,\n    f: F,\n}\n\n// Make KeyedIter an iterator whenever `I` is an iterator over tuples and `F` has the \n// correct signature\nimpl&lt;K, V, R, I, F&gt; Iterator for KeyedIter&lt;I, F&gt;\nwhere\n    I: Iterator&lt;Item = (K, V)&gt;,\n    F: FnMut(K) -&gt; R,\n{\n    type Item = R;\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        self.iter.next().map(|(k, _v)| (self.f)(k))\n    }\n}\n\n// A trait for adding the `map_keys` method\ntrait KeyedIterator&lt;K, V&gt; {\n    fn map_keys&lt;R, F&gt;(self, f: F) -&gt; KeyedIter&lt;Self, F&gt;\n    where\n        F: FnMut(K) -&gt; R,\n        Self: Sized;\n}\n\n// implement the trait for all iterators over tuples\nimpl&lt;I, K, V&gt; KeyedIterator&lt;K, V&gt; for I\nwhere\n    I: Iterator&lt;Item = (K, V)&gt;,\n{\n    fn map_keys&lt;R, F&gt;(self, f: F) -&gt; KeyedIter&lt;Self, F&gt;\n    where\n        F: FnMut(K) -&gt; R,\n        Self: Sized,\n    {\n        KeyedIter { iter: self, f }\n    }\n}\n</code></pre>\n\n<p>The <code>KeyedIter</code> struct is parameterised by types that the caller knows about: the previous iterator, and the mapping function. There is no need to try to express the type of an intermediate closure - instead it's handled lazily in the iterator's <code>next()</code> method. </p>\n\n<hr>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/a/32551408/493729\">\"Expected type parameter\" error in the constructor of a generic struct</a></li>\n</ul>\n"}], "owner": {"reputation": 14787, "user_id": 139766, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/6352d881fa53799e7452d6edb2d1df89?s=128&d=identicon&r=PG", "display_name": "Callum Rogers", "link": "https://stackoverflow.com/users/139766/callum-rogers"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 196, "favorite_count": 0, "accepted_answer_id": 54290964, "answer_count": 2, "score": 2, "last_activity_date": 1548085628, "creation_date": 1548071056, "last_edit_date": 1548082964, "question_id": 54289278, "link": "https://stackoverflow.com/questions/54289278/extending-iterator-over-pairs-with-map-keys", "title": "Extending Iterator over pairs with map_keys", "body": "<p>I'm trying to write some simple extension methods for Rust's <code>Iterator</code> when it's iterating over <code>(K, V)</code> pairs. The simplest implementation I can come up with for mapping keys involves reusing <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map\" rel=\"nofollow noreferrer\"><code>Iterator::map</code></a> like so: </p>\n\n<pre><code>use std::iter::Map;\n\ntrait KeyedIterator&lt;K, V&gt;: Iterator&lt;Item = (K, V)&gt; {\n    fn map_keys&lt;R, F, G&gt;(self, f: F) -&gt; Map&lt;Self, G&gt;\n    where\n        Self: Sized,\n        F: FnMut(K) -&gt; R,\n        G: FnMut((K, V)) -&gt; (R, V),\n    {\n        self.map(|(key, value): (K, V)| (f(key), value))\n    }\n}\n\nimpl&lt;I, K, V&gt; KeyedIterator&lt;K, V&gt; for I where I: Iterator&lt;Item = (K, V)&gt; {}\n</code></pre>\n\n<p>However, it has this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/lib.rs:10:18\n   |\n10 |         self.map(|(key, value): (K, V)| (f(key), value))\n   |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected type parameter, found closure\n   |\n   = note: expected type `G`\n              found type `[closure@src/lib.rs:10:18: 10:56 f:_]`\n</code></pre>\n\n<p>Shouldn't the closure implement <code>G</code> as it is a function from <code>(K, V)</code> to <code>(R, V)</code>? What am I missing here?</p>\n"}, {"tags": ["module", "rust", "rust-2018"], "answers": [{"comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548075528, "post_id": 54289072, "comment_id": 95401539, "body": "A leading <code>::</code> is also permitted, which is equivalent to <code>crate::</code>. Some people think it&#39;s ugly, but it&#39;s used a lot in code that precedes edition 2018, which is when <code>crate::</code> was introduced."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548075838, "post_id": 54289072, "comment_id": 95401721, "body": "@PeterHall Are you sure? It does not compile"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1548075955, "post_id": 54289072, "comment_id": 95401788, "body": "Oh, I see. I will modify the question to target the 2018 edition."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1548078176, "post_id": 54289072, "comment_id": 95403059, "body": "Ah, I didn&#39;t even realise that no longer works in edition 2018!"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 2, "last_activity_date": 1548070292, "creation_date": 1548070292, "answer_id": 54289072, "question_id": 54289071, "link": "https://stackoverflow.com/questions/54289071/what-are-the-valid-path-roots-in-the-use-keyword/54289072#54289072", "title": "What are the valid path roots in the use keyword?", "body": "<p>Your path can begin in 2 different ways: absolute or relative:</p>\n\n<ul>\n<li><p>Your path can begin with a crate name, or the <code>crate</code> keyword to name the current crate:</p>\n\n<pre><code>struct Foo;\n\nmod module {\n    use crate::Foo; // Use `Foo` from the current crate.\n    use serde::Serialize; // Use `Serialize` from the serde crate.\n}\n\nfn main() {}\n</code></pre></li>\n<li><p>Otherwise, the root is implicitely <code>self</code>, that means that your path will be relative to your current module:</p>\n\n<pre><code>mod module {\n    pub struct Foo;\n    pub struct Bar;\n}\n\nuse module::Foo; // By default, you are in the `self` (current) module.\nuse self::module::Bar; // Explicit `self`.\n</code></pre>\n\n<p>In this context, you can use <code>super</code> to access to the outer module:</p>\n\n<pre><code>struct Foo;\n\nmod module {\n    use super::Foo; // Access `Foo` from the outer module.\n}\n</code></pre></li>\n</ul>\n"}, {"tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": false, "score": 4, "last_activity_date": 1549571547, "last_edit_date": 1549571547, "creation_date": 1549556923, "answer_id": 54577897, "question_id": 54289071, "link": "https://stackoverflow.com/questions/54289071/what-are-the-valid-path-roots-in-the-use-keyword/54577897#54577897", "title": "What are the valid path roots in the use keyword?", "body": "<p>Paths in <code>use</code> statements can only start in the following ways:</p>\n\n<ul>\n<li><em>name of an extern crate</em>: then it refers to that extern crate</li>\n<li><code>crate</code>: refers to the (top level of your) own crate</li>\n<li><code>self</code>: refers to the current module</li>\n<li><code>super</code>: refers to the parent module</li>\n<li><em>other name</em>: in this case, it looks for that name <em>relative</em> to the current module</li>\n</ul>\n\n<p>An example demonstrating all kinds of <code>use</code>-paths (<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=370cfbc657f0946fa738a220f641aa30\" rel=\"nofollow noreferrer\">Playground</a>):</p>\n\n<pre><code>pub const NAME: &amp;str = \"peter\";\npub const WEIGHT: f32 = 3.1;\n\nmod inner {\n    mod child {\n        pub const HEIGHT: f32 = 0.3;\n        pub const AGE: u32 = 3;\n    }\n\n    // Different kinds of uses\n    use base64::encode;   // Extern crate `base64`\n    use crate::NAME;      // Own crate (top level module)\n    use self::child::AGE; // Current module\n    use super::WEIGHT;    // Parent module (in this case, this is the same \n                          // as `crate`)\n    use child::HEIGHT;    // If the first name is not `crate`, `self` or \n                          // `super` and it's not the name of an extern \n                          // crate, it is a path relative to the current\n                          // module (as if it started with `self`)\n}\n</code></pre>\n\n<p>This <code>use</code> statement behavior changed with Rust 2018 (available in Rust \u2265 1.31)). Read <a href=\"https://doc.rust-lang.org/edition-guide/rust-2018/module-system/path-clarity.html\" rel=\"nofollow noreferrer\">this guide</a> for more information about use statements and how they changed in Rust 2018.</p>\n"}], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 961, "favorite_count": 0, "answer_count": 2, "score": 3, "last_activity_date": 1549571547, "creation_date": 1548070292, "last_edit_date": 1548094046, "question_id": 54289071, "link": "https://stackoverflow.com/questions/54289071/what-are-the-valid-path-roots-in-the-use-keyword", "title": "What are the valid path roots in the use keyword?", "body": "<p>With the module system being revamped for the 2018 edition, the functioning of the <code>use</code> keyword has changed. What are the valid paths that can go after the <code>use</code> keyword?</p>\n"}, {"tags": ["module", "rust"], "comments": [{"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 0, "creation_date": 1548066609, "post_id": 54287835, "comment_id": 95396696, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/48071513/how-to-use-one-module-from-another-module-in-a-rust-cargo-project\">How to use one module from another module in a Rust cargo project?</a>"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548066802, "post_id": 54287835, "comment_id": 95396812, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/20922091/how-do-you-use-parent-module-imports-in-rust\">How do you use parent module imports in Rust?</a>"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548067360, "post_id": 54287835, "comment_id": 95397136, "body": "@hellow The answer must be updated."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548248467, "post_id": 54287835, "comment_id": 95473705, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/54289071/what-are-the-valid-path-roots-in-the-use-keyword\">What are the valid path roots in the use keyword?</a>"}], "answers": [{"tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 1, "last_activity_date": 1548066483, "creation_date": 1548066483, "answer_id": 54287940, "question_id": 54287835, "link": "https://stackoverflow.com/questions/54287835/how-to-include-types-from-the-main-module-in-other-files-from-the-same-crate/54287940#54287940", "title": "How to include types from the main module in other files from the same crate?", "body": "<p>You must use the <code>crate</code> keyword to access to the root of your crate:</p>\n\n<pre><code>use crate::MyStruct;\n</code></pre>\n"}], "owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 60, "favorite_count": 1, "accepted_answer_id": 54287940, "answer_count": 1, "score": 0, "last_activity_date": 1548066483, "creation_date": 1548066129, "question_id": 54287835, "link": "https://stackoverflow.com/questions/54287835/how-to-include-types-from-the-main-module-in-other-files-from-the-same-crate", "title": "How to include types from the main module in other files from the same crate?", "body": "<p>I'm writing a Rust library called <code>my_new_lib</code> and have the following file structure:</p>\n\n<pre><code>\u251c\u2500\u2500 my_new_lib\n    \u251c\u2500\u2500 src\n        \u251c\u2500\u2500 lib.rs\n        \u2514\u2500\u2500 file1.rs\n    \u251c\u2500\u2500 tests\n</code></pre>\n\n<p>In <code>lib.rs</code> I defined a struct:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>/// content of lib.rs\n\npub struct my_struct {}\n</code></pre>\n\n<p>In <code>file1.rs</code> I want to use <code>my_struct</code>, for example:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>/// content of file1.rs\n\nuse ????\n\npub struct my_second_struct {\n    member1: my_struct\n}\n</code></pre>\n\n<p>what should I put in the <code>use</code> clause in <code>file1.rs</code> to make it work?</p>\n"}, {"tags": ["rust", "copy", "borrowing"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 2, "creation_date": 1548065932, "post_id": 54287719, "comment_id": 95396307, "body": "Use <code>move</code>. Copyable things are not moved but copied. Let me find the duplicate."}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066010, "post_id": 54287719, "comment_id": 95396360, "body": "@Boiethios doesn&#39;t work either, I&#39;ll add the error"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066033, "post_id": 54287719, "comment_id": 95396371, "body": "Add it to both your closures"}, {"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 0, "creation_date": 1548066127, "post_id": 54287719, "comment_id": 95396420, "body": "I just answered, the question for quick help, Can be happily vote for if it is duplicate"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066167, "post_id": 54287719, "comment_id": 95396449, "body": "@Boiethios Same error if I add to both closures. First version works like that as in AkinerAlkan&#39;s answer, but can I also get the second version to work that way?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066222, "post_id": 54287719, "comment_id": 95396473, "body": "It works pretty well: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=95da9639666f29e055ab5fb75a912436\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066282, "post_id": 54287719, "comment_id": 95396510, "body": "@Boiethios it doesn&#39;t when you inline <code>id</code>: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=de2261586d535305991492d18770bbc0\" rel=\"nofollow noreferrer\">play.rust-lang.org/&hellip;</a>"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066480, "post_id": 54287719, "comment_id": 95396612, "body": "@Boiethios but as I understand, if I borrow <code>ids : Vec&lt;i64&gt;</code> I should be just fine getting one of the <code>i64</code>&#39;s out and copy it into my return tuple?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066710, "post_id": 54287719, "comment_id": 95396752, "body": "What is your actual question? Is it &quot;how to inline <code>id</code>&quot;?"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1548066850, "post_id": 54287719, "comment_id": 95396835, "body": "@Boiethios Well, I&#39;m rather trying to understand why it doesn&#39;t allow me to write the code in question, especially why it says that <code>i</code> needs to live until outside the capture when the return value of <code>ids[i]</code> should not contain a reference to <code>i</code> anymore"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548083486, "post_id": 54287719, "comment_id": 95406076, "body": "Based on your error messages, you are still using Rust 2015. I <b>strongly</b> encourage you to switch to 2018 for improved error messages."}], "answers": [{"tags": [], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "is_accepted": false, "score": 2, "last_activity_date": 1548083694, "last_edit_date": 1548083694, "creation_date": 1548066070, "answer_id": 54287818, "question_id": 54287719, "link": "https://stackoverflow.com/questions/54287719/how-to-copy-instead-of-borrow-an-i64-into-a-closure-in-rust/54287818#54287818", "title": "How to copy instead of borrow an i64 into a closure in Rust?", "body": "<p>You can move the variable into closure with <code>move</code> keyword. Here you need to change the closure like:</p>\n\n<pre><code>v.iter().map(move |n|  // move is the keyword for moving variables into closure scope.\n    (n.clone(), id)\n)\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c901ec00ddd6d4e41354badfbd59ff1f\" rel=\"nofollow noreferrer\">Playground</a></p>\n"}, {"comments": [{"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 0, "creation_date": 1548067913, "post_id": 54288324, "comment_id": 95397447, "body": "That makes sense, but the compiler points the error message to <code>i</code>, not <code>ids</code>, so is this just a wrong error message?"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 0, "creation_date": 1548068071, "post_id": 54288324, "comment_id": 95397541, "body": "@msrd0 That&#39;s another issue: you try to return something that holds a reference to <code>i</code>, but <code>i</code> is declared from inside your mutable closure."}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 0, "creation_date": 1548068425, "post_id": 54288324, "comment_id": 95397747, "body": "Ok I see, because <code>map</code> does take ownership of the closure, the compiler cannot guarantee it being executed before <code>i</code> runs out of scope. That was not very clear from the error message from the compiler. Thanks"}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 0, "creation_date": 1548068715, "post_id": 54288324, "comment_id": 95397912, "body": "That&#39;s not exactly that: <code>v.iter().map(&lt;closure&gt;)</code> returns a struct <code>Map</code> in which there is a reference to the local variable <code>i</code>. That&#39;s another case of a returned reference to a local variable."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1548077150, "post_id": 54288324, "comment_id": 95402518, "body": "I don&#39;t think your last paragraph is accurate. You <i>can</i> borrow <code>ids</code> in the inner closure, it&#39;s <code>i</code> that can&#39;t be borrowed (because it belongs to the outer closure). On the other hand, you can <i>move</i> <code>i</code> (because it&#39;s <code>Copy</code>), but you can&#39;t move <code>ids</code> because the outer closure only borrows it. You need to borrow <code>ids</code> while moving <code>i</code>, which you can do by <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=196fe9c95c7abce220619c846ce7ed8e\" rel=\"nofollow noreferrer\">taking a reference to <code>ids</code> in the outer closure and using <code>move</code> to move both.</a>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1548083665, "post_id": 54288324, "comment_id": 95406171, "body": "<i>A mix of both is impossible</i> \u2014 this is technically accurate, but as trentcl shows, you can take an explicit reference and then move the reference in, effectively getting a mix."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548084325, "post_id": 54288324, "comment_id": 95406555, "body": "@Shepmaster You understand what I meant. You must add a step to have only movable types (either a copyable type or a reference). I answer to the question: why cant I inline the index stuff."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1548086206, "post_id": 54288324, "comment_id": 95407661, "body": "<code>FnMut</code> is also not relevant in the way you imply. Each closure will only borrow <code>ids</code> immutably if it can get away with it, even if it had to borrow the rest of the environment exclusively. Your minimal repro demonstrates a case where exclusive borrowing <i>is actually required</i>, but that&#39;s not true in the original code."}, {"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "edited": false, "score": 0, "creation_date": 1591390605, "post_id": 54288324, "comment_id": 110048971, "body": "A mix of both is impossible - this is totally inaccurate AFAIK. Take a look at this very <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f6aa77d0b4e2fb3a3538151af72bf2b3\" rel=\"nofollow noreferrer\">simple example</a>. There is no hard rule saying that variables can&#39;t be moved into closure, it depends on how the variable is used. In fact some closures can be movable without using <code>move ||</code>"}, {"owner": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "edited": false, "score": 0, "creation_date": 1591392349, "post_id": 54288324, "comment_id": 110049668, "body": "The trick in my example is that closure only implements <code>FnOnce</code> since the variable is always moved out of the closure&#39;s environment upon closure being called. I don&#39;t think an example can be made for <code>Fn</code> and <code>FnMut</code>. Mix of both capture by value and capture by reference is only possible for <code>FnOnce</code> closures."}, {"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "reply_to_user": {"reputation": 405, "user_id": 5182723, "user_type": "registered", "accept_rate": 67, "profile_image": "https://graph.facebook.com/10205453818898510/picture?type=large", "display_name": "Marin Ver\u0161i\u0107", "link": "https://stackoverflow.com/users/5182723/marin-ver%c5%a1i%c4%87"}, "edited": false, "score": 0, "creation_date": 1591436341, "post_id": 54288324, "comment_id": 110058652, "body": "@MarinVer\u0161i\u0107 Didn&#39;t know this was possible. Feel free to either update my answer or create your own one."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 3, "last_activity_date": 1548083584, "last_edit_date": 1548083584, "creation_date": 1548067780, "answer_id": 54288324, "question_id": 54287719, "link": "https://stackoverflow.com/questions/54287719/how-to-copy-instead-of-borrow-an-i64-into-a-closure-in-rust/54288324#54288324", "title": "How to copy instead of borrow an i64 into a closure in Rust?", "body": "<p>When you create a closure in Rust, it captures the variables either by value or by reference. A mix of both is impossible. By default, it captures by reference, but with the <code>move</code> keyword, it captures by value (<em>i.e.</em> it moves the captured variables inside the closure).</p>\n\n<p>So, in your first code, you need to move <code>id</code> inside the closure:</p>\n\n<pre><code>fn main() {\n    let names: Vec&lt;Vec&lt;String&gt;&gt; = vec![\n        vec![\"Foo1\".to_string(), \"Foo2\".to_string()],\n        vec![\"Bar1\".to_string(), \"Bar2\".to_string()],\n    ];\n    let ids: Vec&lt;i64&gt; = vec![10, 20];\n\n    names.iter().enumerate().flat_map(|(i, v)| {\n        let id: i64 = ids[i];\n        v.iter().map(move |n| (n.clone(), id))\n    });\n}\n</code></pre>\n\n<p>Then you ask if you can \"inline\" <code>ids</code>:</p>\n\n<pre><code>fn main() {\n    let names: Vec&lt;Vec&lt;String&gt;&gt; = vec![\n        vec![\"Foo1\".to_string(), \"Foo2\".to_string()],\n        vec![\"Bar1\".to_string(), \"Bar2\".to_string()],\n    ];\n    let ids: Vec&lt;i64&gt; = vec![10, 20];\n\n    names.iter().enumerate().flat_map(|(i, v)| {\n        v.iter().map(|n| (n.clone(), ids[i]))\n    });\n}\n</code></pre>\n\n<p>You cannot put <code>ids</code> at all in your inner closure, because you are already inside a <code>FnMut</code> closure (that requires exclusive access). Thus, you cannot borrow or move <code>ids</code> because it is already borrowed by the <code>FnMut</code> closure. Minimal reproduction:</p>\n\n<pre><code>fn main() {\n    let mut i = 0;\n\n    let mut closure = || {\n        i = 2;\n        || {\n            println!(\"i = {}\", i);\n        }\n    };\n\n    closure()();\n}\n</code></pre>\n"}], "owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1635, "favorite_count": 1, "accepted_answer_id": 54288324, "answer_count": 2, "score": 4, "last_activity_date": 1548109165, "creation_date": 1548065710, "last_edit_date": 1548109165, "question_id": 54287719, "link": "https://stackoverflow.com/questions/54287719/how-to-copy-instead-of-borrow-an-i64-into-a-closure-in-rust", "title": "How to copy instead of borrow an i64 into a closure in Rust?", "body": "<p>I have the following minimal example of my code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>fn main()\n{\n    let names : Vec&lt;Vec&lt;String&gt;&gt; = vec![\n        vec![\"Foo1\".to_string(), \"Foo2\".to_string()],\n        vec![\"Bar1\".to_string(), \"Bar2\".to_string()]\n    ];\n    let ids : Vec&lt;i64&gt; = vec![10, 20];\n\n    names.iter().enumerate().flat_map(|(i,v)| {\n        let id : i64 = ids[i];\n        v.iter().map(|n| \n            (n.clone(), id)\n        )\n    });\n}\n</code></pre>\n\n<p>Now, when I compile that with <code>rustc</code> I get the following error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `id` does not live long enough\n  --&gt; main.rs:12:16\n   |\n11 |         v.iter().map(|n| \n   |                      --- capture occurs here\n12 |             (n.clone(), id)\n   |                         ^^ borrowed value does not live long enough\n13 |         )\n14 |     });\n   |     -- borrowed value needs to live until here\n   |     |\n   |     borrowed value only lives until here\n</code></pre>\n\n<p>But in my understanding, <code>id</code> is of type <code>i64</code> and should therefore be able to be copied into the capture, with would be exactly what I need?</p>\n\n<p>I've also tried to inline the <code>id</code> variable but to no avail:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `i` does not live long enough\n  --&gt; main.rs:11:21\n   |\n10 |             v.iter().map(|n| \n   |                          --- capture occurs here\n11 |                 (n.clone(), ids[i])\n   |                                 ^ borrowed value does not live long enough\n12 |             )\n13 |         });\n   |         -- borrowed value needs to live until here\n   |         |\n   |         borrowed value only lives until here\n</code></pre>\n\n<p>So how can I copy my integer into the closure instead of borrowing it?</p>\n\n<p>I tried using <code>move</code>, but <code>rustc</code> doesn't like that either:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of captured outer variable in an `FnMut` closure\n  --&gt; main.rs:10:17\n   |\n7  |         let ids : Vec&lt;i64&gt; = vec![10, 20];\n   |             --- captured outer variable\n...\n10 |             v.iter().map(move |n| \n   |                          ^^^^^^^^ cannot move out of captured outer variable in an `FnMut` closure\n</code></pre>\n\n<p>So I'd somehow need to get <code>rustc</code> to only move/copy some but not the other variable?</p>\n"}, {"tags": ["rust"], "answers": [{"comments": [{"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "reply_to_user": {"reputation": 523, "user_id": 8617507, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9da6733c7db911f11532d8dfdbc576c4?s=128&d=identicon&r=PG&f=1", "display_name": "iDuanYingJie", "link": "https://stackoverflow.com/users/8617507/iduanyingjie"}, "edited": false, "score": 0, "creation_date": 1548059826, "post_id": 54285638, "comment_id": 95393116, "body": "For further info you can check the following links.  , <a href=\"https://doc.rust-lang.org/rust-by-example/scope/borrow/ref.html\" rel=\"nofollow noreferrer\">rust-book</a> , <a href=\"https://users.rust-lang.org/t/when-to-ref-or/5798\" rel=\"nofollow noreferrer\">rust-users</a> , <a href=\"https://www.reddit.com/r/rust/comments/2tq33x/ref_keyword/\" rel=\"nofollow noreferrer\">reddit-ref keyword</a>"}], "tags": [], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "is_accepted": false, "score": 6, "last_activity_date": 1548057961, "creation_date": 1548057961, "answer_id": 54285638, "question_id": 54285560, "link": "https://stackoverflow.com/questions/54285560/in-function-parameters-what-is-the-difference-between-using-the-ref-keyword-and/54285638#54285638", "title": "In function parameters, what is the difference between using the ref keyword and using the &amp; symbol?", "body": "<p>In patterns, <code>&amp;</code> destructures a borrow, <code>ref</code> binds to a location by-reference rather than by-value. </p>\n\n<p>In other words, <code>&amp;</code> lets you reach through a borrow, and <code>ref</code> says \u201ctake a borrow to this place within the thing I\u2019m matching\u201d</p>\n\n<blockquote>\n  <p><code>&amp;</code> and <code>ref</code> are opposites.</p>\n</blockquote>\n\n<pre><code>#![feature(core_intrinsics)]\n\nfn main() {\n    let x = &amp;false;\n    print_type_name_of(x);\n\n    let &amp;x = &amp;false;\n    print_type_name_of(x);\n\n    let ref x = &amp;false;\n    print_type_name_of(x);\n}\n\nfn print_type_name_of&lt;T&gt;(_: T) {\n    println!(\"{}\", unsafe { std::intrinsics::type_name::&lt;T&gt;() })\n}\n</code></pre>\n\n<p>The output will be like following:</p>\n\n<pre><code>&amp;bool\nbool\n&amp;&amp;bool\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548080462, "post_id": 54286498, "comment_id": 95404338, "body": "<i>because the pattern matching is more &quot;clever&quot;</i> \u2014 more clever, yes, but not completely. I&#39;ve found myself needing to use <code>ref</code> when I did not expect to."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": false, "score": 3, "last_activity_date": 1548062401, "last_edit_date": 1548062401, "creation_date": 1548061568, "answer_id": 54286498, "question_id": 54285560, "link": "https://stackoverflow.com/questions/54285560/in-function-parameters-what-is-the-difference-between-using-the-ref-keyword-and/54286498#54286498", "title": "In function parameters, what is the difference between using the ref keyword and using the &amp; symbol?", "body": "<p><code>&amp;</code> applies to the rvalue (the type) while <code>ref</code> applies to the lvalue (the variable name), but they both do the same thing.</p>\n\n<p><code>ref</code> was useful inside a pattern, because you have only access to a lvalue:</p>\n\n<pre><code>#![feature(core_intrinsics)]\n\nfn print_type&lt;T&gt;(_: T) {\n    println!(\"{}\", unsafe { std::intrinsics::type_name::&lt;T&gt;() })\n}\n\nfn main() {\n    let opt = Some(0);\n\n    match opt {\n        Some(ref i) =&gt; print_type(i), // &amp;i32\n        None =&gt; (),\n    }\n}\n</code></pre>\n\n<p>However, today, this keyword is not really useful, because the pattern matching is more \"clever\". It understands that if you borrow the matching value, it means that you want to borrow the inner:</p>\n\n<pre><code>match &amp;opt {\n    Some(i) =&gt; print_type(i), // &amp;i32\n    None =&gt; (),\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 3, "last_activity_date": 1548081309, "last_edit_date": 1548081309, "creation_date": 1548080901, "answer_id": 54292058, "question_id": 54285560, "link": "https://stackoverflow.com/questions/54285560/in-function-parameters-what-is-the-difference-between-using-the-ref-keyword-and/54292058#54292058", "title": "In function parameters, what is the difference between using the ref keyword and using the &amp; symbol?", "body": "<blockquote>\n  <p>In function parameters, what is the difference between using the <code>ref</code> keyword and using the <code>&amp;</code> symbol?</p>\n</blockquote>\n\n<p>You've already <em>answered your own question</em>:</p>\n\n<blockquote>\n  <p>[using <code>ref</code>] will take ownership</p>\n</blockquote>\n\n<p>Ownership of the variable is transferred to the function and then a reference to the moved variable is taken. That is,</p>\n\n<pre><code>fn f2(ref _s: String) {}\n</code></pre>\n\n<p>is equivalent to </p>\n\n<pre><code>fn f2(s0: String) {\n    let _s = &amp;s0;\n    // or \n    // let ref _s = s0;\n}\n</code></pre>\n\n<p>If you use <code>&amp;String</code> (<a href=\"https://stackoverflow.com/q/40006219/155423\">which you shouldn't</a>), the function doesn't take ownership of the variable, only a reference to it.</p>\n\n<blockquote>\n  <p>the address printed [...] is not the same </p>\n</blockquote>\n\n<p>Yes, because the variable has been moved. When a variable moves, the address it is located at might change. That's why it's called \"moving\".</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/34717001/155423\">What&#39;s the difference between ref and &amp; when assigning a variable from a reference?</a></li>\n<li><a href=\"https://stackoverflow.com/q/28587698/155423\">What&#39;s the difference between placing &quot;mut&quot; before a variable name and after the &quot;:&quot;?</a></li>\n<li><a href=\"https://stackoverflow.com/q/40006219/155423\">Why is it discouraged to accept a reference to a String (&amp;String), Vec (&amp;Vec), or Box (&amp;Box) as a function argument?</a></li>\n</ul>\n"}], "owner": {"reputation": 523, "user_id": 8617507, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9da6733c7db911f11532d8dfdbc576c4?s=128&d=identicon&r=PG&f=1", "display_name": "iDuanYingJie", "link": "https://stackoverflow.com/users/8617507/iduanyingjie"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 156, "favorite_count": 0, "answer_count": 3, "score": 6, "last_activity_date": 1548081309, "creation_date": 1548057536, "last_edit_date": 1548080414, "question_id": 54285560, "link": "https://stackoverflow.com/questions/54285560/in-function-parameters-what-is-the-difference-between-using-the-ref-keyword-and", "title": "In function parameters, what is the difference between using the ref keyword and using the &amp; symbol?", "body": "<p>In this code, <code>sref1</code> and <code>sref2</code> are the addresses of <code>s</code>, and the addresses are the same. What is the difference between <code>ref</code> and <code>&amp;</code>?</p>\n\n<pre><code>fn main() {\n    let s = String::from(\"hello\");\n    let sref1 = &amp;s;\n    let ref sref2 = s;\n    println!(\"{:p}\", sref1);\n    println!(\"{:p}\", sref2);\n\n    f1(&amp;s);\n    f2(s);\n}\n\nfn f1(_s: &amp;String) {\n    println!(\"{:p}\", _s);\n}\n\nfn f2(ref _s: String) {\n    println!(\"{:p}\", _s);\n}\n</code></pre>\n\n<p><code>_s</code> in <code>f1</code> and <code>f2</code> is also the address of the string, <code>f2</code> will take ownership, but the address printed by <code>f2</code> is not the same as the address printed by <code>f1</code>. Why?</p>\n"}, {"tags": ["rust", "rust-actix"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548034391, "post_id": 54282508, "comment_id": 95386836, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54282508/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548034920, "post_id": 54282508, "comment_id": 95386921, "body": "Applying the duplicates, you&#39;ll probably need to use <code>server: HttpServer&lt;App, Box&lt;Fn() -&gt; App&gt;&gt;</code> with the corresponding change inside the method, but since there&#39;s no MCVE, it&#39;s hard to state what exactly you&#39;ll need."}], "owner": {"reputation": 1192, "user_id": 1213186, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/d9eabf15c471c4eb5158034e943711ce?s=128&d=identicon&r=PG", "display_name": "ddibiase", "link": "https://stackoverflow.com/users/1213186/ddibiase"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 170, "favorite_count": 0, "closed_date": 1548034841, "answer_count": 0, "score": 2, "last_activity_date": 1548034851, "creation_date": 1548034113, "last_edit_date": 1548034385, "question_id": 54282508, "link": "https://stackoverflow.com/questions/54282508/closure-vs-function-declaration-in-struct", "closed_reason": "Duplicate", "title": "Closure vs. function declaration in struct", "body": "<p>I'm having trouble (as a newbie) getting my application to compile. This is likely the most obvious detail but I'm struggling with comprehending what's happening.</p>\n\n<p>I'm writing a wrapper struct for the Actix Web server library. My struct is defined as such:</p>\n\n<pre><code>struct CustomServer {\n    connections: IncomingRequets,\n    server: HttpServer&lt;App, fn() -&gt; App&gt;,\n    address: String,\n    port: i32,\n}\n</code></pre>\n\n<p>I'm attempting to create the struct and return it via a function:</p>\n\n<pre><code>let address: Handle&lt;JsString&gt; = cx.argument::&lt;JsString&gt;(0)?;\nlet port: Handle&lt;JsNumber&gt; = cx.argument::&lt;JsNumber&gt;(1)?;\nlet server = server::new(|| {\n    App::new()\n        .middleware(middleware::Logger::default())\n        .default_resource(|r| r.f(index))\n});\n// Export the server struct\nCustomServer {\n    address: address.value(),\n    port: port.value() as i32,\n    server: server,\n    connections: IncomingRequets {\n        requests: HashMap::new(),\n    },\n}\n</code></pre>\n\n<p><code>expected fn pointer, found closure</code>. I do understand that this is likely due to a missing piece in my understanding of how concrete structs and types are declared. I also understand that I'm passing in a closure as opposed to a function.</p>\n\n<p>So my thought process is: a) how can I declare a closure as part of the <code>HttpServer</code> parameters or b) can I declare the function within the struct and return it as a factory/generator that returns the app?</p>\n"}, {"tags": ["macos", "rust", "gmp"], "comments": [{"owner": {"reputation": 40086, "user_id": 499581, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/1ba2cebc4582467916f2ddd6128447f4?s=128&d=identicon&r=PG", "display_name": "l&#39;L&#39;l", "link": "https://stackoverflow.com/users/499581/lll"}, "edited": false, "score": 0, "creation_date": 1548023103, "post_id": 54281527, "comment_id": 95384905, "body": "How about <code>MacPorts</code> version (<code>gmp @6.1.2_1 (devel, math)</code>)?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548028605, "post_id": 54281527, "comment_id": 95385909, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54281527/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548028941, "post_id": 54281527, "comment_id": 95385955, "body": "For example, is the type alias important for the problem? You&#39;ve shown methods taking <code>self</code> but not the structs they are defined on. If he structs are important, include them. If not, remove them and use functions. Is it important to have two methods? Why do the methods have no bodies? That&#39;s not valid Rust. What version of the gmp crate are you using? What version of Rust?"}, {"owner": {"reputation": 69, "user_id": 763989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/13f5e8f3cb0324edad4ae3b380a87ec1?s=128&d=identicon&r=PG", "display_name": "vertique", "link": "https://stackoverflow.com/users/763989/vertique"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548538955, "post_id": 54281527, "comment_id": 95578976, "body": "@Shepmaster The funniest thing - that while I was trying to do MCVE on Windows, I got the very same error. Like on MacOSX - and on Windows now I have two exact copies(if to believe git) of project. In one there is error <code>expected struct &quot;gmp::mpz::Mpz&quot;, found enum &quot;std::option::Option&quot;</code>- other builds ok!?"}, {"owner": {"reputation": 69, "user_id": 763989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/13f5e8f3cb0324edad4ae3b380a87ec1?s=128&d=identicon&r=PG", "display_name": "vertique", "link": "https://stackoverflow.com/users/763989/vertique"}, "reply_to_user": {"reputation": 40086, "user_id": 499581, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/1ba2cebc4582467916f2ddd6128447f4?s=128&d=identicon&r=PG", "display_name": "l&#39;L&#39;l", "link": "https://stackoverflow.com/users/499581/lll"}, "edited": false, "score": 0, "creation_date": 1548582534, "post_id": 54281527, "comment_id": 95585900, "body": "@l&#39;L&#39;l tried MacPorts version - same error:("}], "answers": [{"tags": [], "owner": {"reputation": 69, "user_id": 763989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/13f5e8f3cb0324edad4ae3b380a87ec1?s=128&d=identicon&r=PG", "display_name": "vertique", "link": "https://stackoverflow.com/users/763989/vertique"}, "is_accepted": true, "score": 0, "last_activity_date": 1550004984, "creation_date": 1550004984, "answer_id": 54658569, "question_id": 54281527, "link": "https://stackoverflow.com/questions/54281527/rust-compile-error-on-macos-related-to-gmp/54658569#54658569", "title": "Rust compile error on macOS related to GMP", "body": "<p>Ok so it was cargo dependency hell:) - after multiple unsuccessful reinstalls, cleaning etc I finally was able to rebuild by manually downloading and rebuilding and re-referencing local paths of dependencies that were referenced with git. From then on - all was building fine no matter if I referenced locally or via git or crates.</p>\n"}], "owner": {"reputation": 69, "user_id": 763989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/13f5e8f3cb0324edad4ae3b380a87ec1?s=128&d=identicon&r=PG", "display_name": "vertique", "link": "https://stackoverflow.com/users/763989/vertique"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 143, "favorite_count": 1, "accepted_answer_id": 54658569, "answer_count": 1, "score": 0, "last_activity_date": 1550004984, "creation_date": 1548022846, "last_edit_date": 1548710242, "question_id": 54281527, "link": "https://stackoverflow.com/questions/54281527/rust-compile-error-on-macos-related-to-gmp", "title": "Rust compile error on macOS related to GMP", "body": "<p>Something like</p>\n\n<pre><code>use super::gmp::mpz::Mpz;\n...\npub type MyMPZ = Mpz;\n\n...\n\nfn a() -&gt; Option&lt;MyMPZ&gt;;\n</code></pre>\n\n<p>It (along with many other Rust files, libs and other dependencies) compiles and runs OK on Ubuntu and even Windows, but on macOS Mojave\nI get </p>\n\n<blockquote>\n  <p>expected struct `gmp::mpz::Mpz`, found enum `std::option::Option`</p>\n  \n  <p>note: expected type `&amp;gmp::mpz::Mpz`\n  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found type `&amp;std::option::Option`</p>\n</blockquote>\n\n<p>I installed GMP with Brew, but I tried with GMP 6.1.2 built by myself with the same results.</p>\n\n<p><strong>Update 1:</strong> \nSeems MCVE doesn't make much sense since I have two exact copies of project in same root like root\\example1 and root\\example2. One copy builds ok, another gives the error message. Tried cargo clean etc numerous times to same effect. </p>\n\n<p><strong>Update 2:</strong> \nSeems it's definitely some sort of caching issue. Because when I build dependencies, they take custom built 32bit version of gmp.lib from <code>C:\\Users\\&lt;userName&gt;\\.rustup\\toolchains\\nightly-i686-pc-windows-msvc\\lib\\rustlib\\i686-pc-windows-msvc\\lib</code>. So if I checkout dependency and build it separately - tests run there. If I build the whole project, and using my own build dependency crates as .lib I at some point was getting </p>\n\n<blockquote>\n  <p>expected struct `gmp::mpz::Mpz`, found another struct `gmp::mpz::Mpz`</p>\n</blockquote>\n\n<p>that seems like mixing of GMP 32/64 bit libraries to me.</p>\n"}, {"tags": ["rust", "bindgen"], "answers": [{"comments": [{"owner": {"reputation": 2959, "user_id": 5903309, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/665cdb14fb46d20c11a176c92e6ed663?s=128&d=identicon&r=PG", "display_name": "Jan Nils Ferner", "link": "https://stackoverflow.com/users/5903309/jan-nils-ferner"}, "edited": false, "score": 0, "creation_date": 1548143279, "post_id": 54281562, "comment_id": 95426699, "body": "Hint: You can mark your own answer as the solution to your problem by clicking on the green check mark \u2713"}, {"owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "reply_to_user": {"reputation": 2959, "user_id": 5903309, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/665cdb14fb46d20c11a176c92e6ed663?s=128&d=identicon&r=PG", "display_name": "Jan Nils Ferner", "link": "https://stackoverflow.com/users/5903309/jan-nils-ferner"}, "edited": false, "score": 1, "creation_date": 1548166357, "post_id": 54281562, "comment_id": 95439902, "body": "Still have 6 hours to go until I can :)"}, {"owner": {"reputation": 2959, "user_id": 5903309, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/665cdb14fb46d20c11a176c92e6ed663?s=128&d=identicon&r=PG", "display_name": "Jan Nils Ferner", "link": "https://stackoverflow.com/users/5903309/jan-nils-ferner"}, "edited": false, "score": 0, "creation_date": 1548176444, "post_id": 54281562, "comment_id": 95446225, "body": "Oh, didn&#39;t realize there was a time limit, thanks for the info :)"}], "tags": [], "owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "is_accepted": true, "score": 2, "last_activity_date": 1548023166, "creation_date": 1548023166, "answer_id": 54281562, "question_id": 54280550, "link": "https://stackoverflow.com/questions/54280550/bindgen-skipping-definitions-from-c-header-file/54281562#54281562", "title": "Bindgen skipping definitions from C++ header file", "body": "<p>Solved by adding <code>.whitelist_function(\"seal::.*\")</code> to the <code>build.rs</code> file. Since the inline functions weren't enclosed in a type, they were not whitelisted by the current config.</p>\n"}], "owner": {"reputation": 676, "user_id": 3649801, "user_type": "registered", "accept_rate": 60, "profile_image": "https://www.gravatar.com/avatar/be5d9ec096ae9fc7112e2435f4203294?s=128&d=identicon&r=PG&f=1", "display_name": "Belval", "link": "https://stackoverflow.com/users/3649801/belval"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 378, "favorite_count": 0, "accepted_answer_id": 54281562, "answer_count": 1, "score": 2, "last_activity_date": 1548023166, "creation_date": 1548015256, "last_edit_date": 1548016374, "question_id": 54280550, "link": "https://stackoverflow.com/questions/54280550/bindgen-skipping-definitions-from-c-header-file", "title": "Bindgen skipping definitions from C++ header file", "body": "<p>I am trying to compile bindings for the <a href=\"https://github.com/Microsoft/SEAL\" rel=\"nofollow noreferrer\">SEAL C++ library</a>. Here is <a href=\"https://github.com/Belval/seal-rs\" rel=\"nofollow noreferrer\">my repo</a>.</p>\n\n<pre><code>// Generate the bindings\nlet bindings = bindgen::Builder::default()\n    .generate_inline_functions(true)\n    .derive_default(true)\n    .header(\"./seal/src/seal/seal.h\")\n    .clang_arg(\"-I./seal/src/\")\n    .clang_arg(\"-std=c++17\")\n    .clang_arg(\"-x\")\n    .clang_arg(\"c++\")\n    .opaque_type(\"std::.*\")\n    .whitelist_type(\"seal::.*\")\n    .generate()\n    .expect(\"Unable to generate bindings\");\n\nlet out_path = PathBuf::from(\"./src/\");\nbindings\n    .write_to_file(out_path.join(\"bindings.rs\"))\n    .expect(\"Couldn't write bindings!\");\n</code></pre>\n\n<p>bindings.rs does not have anything from <a href=\"https://github.com/Microsoft/SEAL/blob/aa7bf57aa11a91d9ca8712816550ae68793add99/src/seal/defaultparams.h\" rel=\"nofollow noreferrer\">defaultparams.h</a></p>\n\n<p>What do I have to add to the Builder object to include <a href=\"https://github.com/Microsoft/SEAL/blob/aa7bf57aa11a91d9ca8712816550ae68793add99/src/seal/defaultparams.h\" rel=\"nofollow noreferrer\">defaultparams.h</a>'s functions in the generated bindings? I need <code>coeff_modulus_128()</code> for example. </p>\n\n<p>I tried whitelisting the <code>std::vector</code> but it did not have any impact on the generated bindings.</p>\n"}, {"tags": ["rust", "future", "rust-tokio"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548012171, "post_id": 54279989, "comment_id": 95381889, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54279989/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548012235, "post_id": 54279989, "comment_id": 95381906, "body": "Your question is confusing. What is <i>stopping</i> you from <a href=\"https://doc.rust-lang.org/std/thread/index.html\" rel=\"nofollow noreferrer\">starting a new thread</a>?"}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 5513, "user_id": 2718801, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9d4b144cdafa73e1d470362ed8d7c3a9?s=128&d=identicon&r=PG", "display_name": "jhpratt", "link": "https://stackoverflow.com/users/2718801/jhpratt"}, "edited": false, "score": 0, "creation_date": 1549291752, "post_id": 54280186, "comment_id": 95840060, "body": "@jhpratt that&#39;s really quite a substantially different question. I&#39;d encourage you to ask it separately, along with a suitable MCVE."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 5513, "user_id": 2718801, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9d4b144cdafa73e1d470362ed8d7c3a9?s=128&d=identicon&r=PG", "display_name": "jhpratt", "link": "https://stackoverflow.com/users/2718801/jhpratt"}, "edited": false, "score": 0, "creation_date": 1549310537, "post_id": 54280186, "comment_id": 95849460, "body": "@jhpratt It&#39;ll probably have to wait for a few hours, but I&#39;ll put something up for it."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 3, "last_activity_date": 1548014041, "last_edit_date": 1548014041, "creation_date": 1548012823, "answer_id": 54280186, "question_id": 54279989, "link": "https://stackoverflow.com/questions/54279989/is-there-a-way-to-launch-a-tokiodelay-on-a-new-thread-to-allow-the-main-loop-t/54280186#54280186", "title": "Is there a way to launch a tokio::Delay on a new thread to allow the main loop to continue?", "body": "<p>Yes, you can start a new OS level thread and run a Tokio event loop there:</p>\n\n<pre><code>use futures::future::Future; // 0.1.25\nuse std::{\n    thread,\n    time::{Duration, Instant},\n};\nuse tokio::timer::Delay; // 0.1.14 \n\nfn main() {\n    let t = thread::spawn(|| {\n        let when = Instant::now() + Duration::from_millis(100);\n        let task = Delay::new(when)\n            .and_then(move |_| {\n                println!(\"Delay expired\");\n                Ok(())\n            })\n            .map_err(|e| panic!(\"delay errored: {}\", e));\n\n        tokio::run(task);\n    });\n\n    t.join().unwrap();\n}\n</code></pre>\n\n<p>You can also use Tokio's tasks via <a href=\"https://docs.rs/tokio/0.1.14/tokio/executor/fn.spawn.html\" rel=\"nofollow noreferrer\"><code>tokio::spawn</code></a>:</p>\n\n<pre><code>use futures::future::{self, Future}; // 0.1.25\nuse std::time::{Duration, Instant};\nuse tokio::timer::Delay; // 0.1.14\n\nfn main() {\n    tokio::run(future::lazy(|| {\n        tokio::spawn({\n            let when = Instant::now() + Duration::from_millis(100);\n            Delay::new(when)\n                .and_then(move |_| {\n                    println!(\"Delay 100 expired\");\n                    Ok(())\n                })\n                .map_err(|e| panic!(\"delay errored: {}\", e))\n        });\n\n        tokio::spawn({\n            let when = Instant::now() + Duration::from_millis(200);\n            Delay::new(when)\n                .and_then(move |_| {\n                    println!(\"Delay 200 expired\");\n                    Ok(())\n                })\n                .map_err(|e| panic!(\"delay errored: {}\", e))\n        });\n\n        future::ok::&lt;_, ()&gt;(())\n    }))\n}\n</code></pre>\n"}], "owner": {"reputation": 27, "user_id": 4327237, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/832d7fe5830aad87d1034834959294cf?s=128&d=identicon&r=PG&f=1", "display_name": "sid34", "link": "https://stackoverflow.com/users/4327237/sid34"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 869, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1548014041, "creation_date": 1548011439, "last_edit_date": 1548012158, "question_id": 54279989, "link": "https://stackoverflow.com/questions/54279989/is-there-a-way-to-launch-a-tokiodelay-on-a-new-thread-to-allow-the-main-loop-t", "title": "Is there a way to launch a tokio::Delay on a new thread to allow the main loop to continue?", "body": "<p>I am trying to run a function at the end of a delay if the timer is not canceled. The use case is a press and hold / double tap for user input.</p>\n\n<p>The main issue that I am having is that the <code>tokio::run(task);</code> stops the main loop from executing thus prevents me from evaluating the state of the users control.</p>\n\n<pre><code>fn start_timer(&amp;self) {\n    let function_name = self.combo.function_name.clone();\n    let when = Instant::now() + Duration::from_millis(self.combo.timer_value as u64);\n    let task = Delay::new(when)\n        .and_then(move |_| {\n            call_function(&amp;function_name, InteropParams::Button);\n            Ok(())\n        })\n        .map_err(|e| panic!(\"delay errored; err={:?}\", e));\n\n    tokio::run(task);\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548000487, "post_id": 54278279, "comment_id": 95378476, "body": "You&#39;ve asked enough questions by now that we shouldn&#39;t have to remind you that not including your code <i>in the question</i> means that the question is off topic. Or that you should include the error you get. Please respect the rules."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548000685, "post_id": 54278279, "comment_id": 95378544, "body": "The duplicate question applies for the same rules, swapping &quot;variable&quot; for &quot;temporary&quot;."}, {"owner": {"reputation": 5005, "user_id": 573149, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/Wn0FW.jpg?s=128&g=1", "display_name": "Andrew Mackenzie", "link": "https://stackoverflow.com/users/573149/andrew-mackenzie"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548001644, "post_id": 54278279, "comment_id": 95378805, "body": "That question (<a href=\"https://stackoverflow.com/questions/50345139/why-can-i-return-a-reference-to-a-local-literal-but-not-a-variable\" title=\"why can i return a reference to a local literal but not a variable\">stackoverflow.com/questions/50345139/&hellip;</a>) refers to returning a Literal in one of the cases, is it actually the same?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1548002780, "post_id": 54278279, "comment_id": 95379193, "body": "Yes. <code>Executor { module: Module { foo: true } }</code> is a literal that can be converted to a <code>static</code>, but <code>ExecutorArc { module: Arc::new(Module { foo: true }) }</code> is not because it contains a function call."}, {"owner": {"reputation": 5005, "user_id": 573149, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/Wn0FW.jpg?s=128&g=1", "display_name": "Andrew Mackenzie", "link": "https://stackoverflow.com/users/573149/andrew-mackenzie"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548092626, "post_id": 54278279, "comment_id": 95410910, "body": "OK. Thanks. Is &quot;contains function call&quot; the only criteria, or stack allocation of a struct (i.e. non literal) would also call this? Well, I guess to allocate, you need a function call....so maybe the same thing?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1548092853, "post_id": 54278279, "comment_id": 95411017, "body": "At first approximation, it&#39;s &quot;the literal must contain only literals itself&quot; in order to be automatically promoted to a <code>static</code>. There&#39;s a few edge cases inside the standard library, but those are exceptions."}], "owner": {"reputation": 5005, "user_id": 573149, "user_type": "registered", "accept_rate": 73, "profile_image": "https://i.stack.imgur.com/Wn0FW.jpg?s=128&g=1", "display_name": "Andrew Mackenzie", "link": "https://stackoverflow.com/users/573149/andrew-mackenzie"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 59, "favorite_count": 0, "closed_date": 1548000604, "answer_count": 0, "score": 0, "last_activity_date": 1548000442, "creation_date": 1548000190, "last_edit_date": 1548000442, "question_id": 54278279, "link": "https://stackoverflow.com/questions/54278279/why-cant-i-return-reference-to-a-struct-when-it-contains-arcsub-field-but-can", "closed_reason": "Duplicate", "title": "Why can&#39;t I return reference to a struct when it contains Arc&lt;sub-field&gt; but can with just a sub-field?", "body": "<p>I have a function that loads an struct called <code>Executor</code> from a file and returns a reference to it.</p>\n\n<ul>\n<li>if the <code>Executor</code> struct contains a field <code>Module</code>, it compiles and works</li>\n<li>if the <code>Executor</code> struct contains a field <code>Arc&lt;Module&gt;</code>, it won't compile and complains struct belongs to the current function.</li>\n</ul>\n\n<pre><code>use std::sync::Arc;\n\n#[derive(Debug)]\nstruct Module {\n    foo: bool,\n}\n\n#[derive(Debug)]\nstruct Executor {\n    module: Module,\n}\n\nimpl Executor {\n    pub fn load() -&gt; Result&lt;&amp;'static Executor, ()&gt; {\n        Ok(&amp;Executor {\n            module: Module { foo: true },\n        })\n    }\n}\n\n#[derive(Debug)]\nstruct ExecutorArc {\n    module: Arc&lt;Module&gt;,\n}\n\nimpl ExecutorArc {\n    pub fn load() -&gt; Result&lt;&amp;'static ExecutorArc, ()&gt; {\n        Ok(&amp;ExecutorArc {\n            module: Arc::new(Module { foo: true }),\n        })\n    }\n}\n\nfn main() {\n    let executor = Executor::load().unwrap();\n    println!(\"executor = {:?}\", executor);\n\n    let executor_arc = ExecutorArc::load().unwrap();\n    println!(\"executor_arc = {:?}\", executor_arc);\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=cee6a59ad0c792a33b6c9f6632d47796\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0515]: cannot return value referencing temporary value\n  --&gt; src/main.rs:28:9\n   |\n28 |            Ok(&amp;ExecutorArc {\n   |  __________^___-\n   | | _________|\n   | ||\n29 | ||             module: Arc::new(Module { foo: true }),\n30 | ||         })\n   | ||_________-^ returns a value referencing data owned by the current function\n   | |__________|\n   |            temporary value created here\n</code></pre>\n\n<p>It seems to me that in both cases the struct <code>Executor</code> belongs to the function called, where it is allocated.</p>\n\n<p>How can I do something like this?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547999642, "post_id": 54277188, "comment_id": 95378227, "body": "Idiomatic Rust uses a leading underscore to indicate that a variable or type is <i>unused</i>. That&#39;s not the case here, so you should not name your type <code>_Node</code>."}], "answers": [{"comments": [{"owner": {"reputation": 609, "user_id": 3673043, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/5b9edc66864a60b8f10d2e173e1e80fc?s=128&d=identicon&r=PG", "display_name": "suyash", "link": "https://stackoverflow.com/users/3673043/suyash"}, "edited": false, "score": 0, "creation_date": 1548001890, "post_id": 54278244, "comment_id": 95378888, "body": "Thanks! realized need to explicitly clone on the <code>None</code> branch for individual nodes to have independent <code>data</code>"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1547999958, "creation_date": 1547999958, "answer_id": 54278244, "question_id": 54277188, "link": "https://stackoverflow.com/questions/54277188/unable-to-mutably-borrow-the-contents-inside-a-refcell-even-after-the-scope-of/54278244#54278244", "title": "Unable to mutably borrow the contents inside a RefCell, even after the scope of the previous mutable borrow has ended", "body": "<blockquote>\n  <p>What am I missing here?</p>\n</blockquote>\n\n<p>Your algorithm is broken. You can see this by adding this debugging code inside of the <code>Some</code> arm of the match:</p>\n\n<pre><code>{\n    let a = current_data.borrow();\n    let b = other.borrow();\n\n    assert_ne!(a.id, b.id);\n}\n</code></pre>\n\n<p>This fails:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>thread 'main' panicked at 'assertion failed: `(left != right)`\n  left: `6`,\n right: `6`', src/main.rs:23:25\n</code></pre>\n\n<p>You are trying to borrow the <em>exact same node</em> twice at the same time.</p>\n"}], "owner": {"reputation": 609, "user_id": 3673043, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/5b9edc66864a60b8f10d2e173e1e80fc?s=128&d=identicon&r=PG", "display_name": "suyash", "link": "https://stackoverflow.com/users/3673043/suyash"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 176, "favorite_count": 0, "accepted_answer_id": 54278244, "answer_count": 1, "score": 0, "last_activity_date": 1547999958, "creation_date": 1547992754, "last_edit_date": 1547999599, "question_id": 54277188, "link": "https://stackoverflow.com/questions/54277188/unable-to-mutably-borrow-the-contents-inside-a-refcell-even-after-the-scope-of", "title": "Unable to mutably borrow the contents inside a RefCell, even after the scope of the previous mutable borrow has ended", "body": "<p>Consider the following bit of code</p>\n\n<pre><code>use std::{cell::RefCell, rc::Rc};\n\ntype NodeRef = Rc&lt;RefCell&lt;_Node&gt;&gt;;\n\n#[derive(Debug)]\nstruct _Node {\n    id: usize,\n    data: Option&lt;NodeRef&gt;,\n    edges: Vec&lt;NodeRef&gt;,\n}\n\nimpl _Node {\n    fn add(&amp;mut self, other: NodeRef) {\n        println!(\"at {}\", self.id);\n\n        self.data = match self.data.take() {\n            Some(current_data) =&gt; {\n                {\n                    let mut current_data_raw = current_data.borrow_mut();\n                    current_data_raw.id += other.borrow().id;\n                }\n                Some(current_data)\n            }\n            None =&gt; Some(Rc::clone(&amp;other)),\n        };\n\n        for e in &amp;self.edges {\n            e.borrow_mut().add(Rc::clone(&amp;other));\n        }\n\n        println!(\"done {}\", self.id);\n    }\n}\n\n#[derive(Debug)]\nstruct Node(NodeRef);\n\nimpl Node {\n    fn new(id: usize) -&gt; Node {\n        Node(Rc::new(RefCell::new(_Node {\n            id,\n            data: None,\n            edges: vec![],\n        })))\n    }\n\n    fn add_edge(&amp;self, other: &amp;Node) {\n        self.0.borrow_mut().edges.push(Rc::clone(&amp;other.0));\n    }\n\n    fn add(&amp;self, other: Self) {\n        self.0.borrow_mut().add(other.0);\n    }\n}\n\nfn main() {\n    let a = Node::new(0);\n    let b = Node::new(1);\n    let c = Node::new(2);\n    let d = Node::new(3);\n    let e = Node::new(4);\n    let f = Node::new(5);\n\n    d.add_edge(&amp;a);\n    d.add_edge(&amp;b);\n\n    e.add_edge(&amp;b);\n    e.add_edge(&amp;c);\n\n    f.add_edge(&amp;d);\n    f.add_edge(&amp;e);\n\n    f.add(Node::new(6));\n}\n</code></pre>\n\n<p>The output generated on running this is </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>at 5\nat 3\nat 0\ndone 0\nat 1\ndone 1\ndone 3\nat 4\nat 1\nthread 'main' panicked at 'already mutably borrowed: BorrowError', src/libcore/result.rs:1009:5\n</code></pre>\n\n<p>This creates a graph of the form</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>F--E--A \n \\  \\\n  \\   B\n   \\ /\n    D\n     \\ \n      C\n</code></pre>\n\n<p>I am trying to propagate a value through the entire graph, so it starts from F, and goes to E and D. From E it goes to A and B without any error. Then from D, the runtime panics saying the <code>RefCell</code> constraint for mutable borrows has been broken.</p>\n\n<p>It seems that it is considering the mutable borrow from the previous invocation of the callback with B, however, the mutable borrow (<code>current_data_raw</code>) inside <code>_Node::add</code> has a limited scope, and after the scope ends, I should be allowed to mutably borrow the value again. From the output, when the function is called for node B for the second time, the entire first invocation of the function and not just the mutable borrow scope has exited.</p>\n\n<p>What am I missing here?</p>\n"}, {"tags": ["sockets", "ssl", "websocket", "rust", "mio"], "owner": {"reputation": 15065, "user_id": 723090, "user_type": "registered", "accept_rate": 88, "profile_image": "https://i.stack.imgur.com/ML1tj.png?s=128&g=1", "display_name": "Mark", "link": "https://stackoverflow.com/users/723090/mark"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 378, "favorite_count": 1, "answer_count": 0, "score": 3, "last_activity_date": 1548001470, "creation_date": 1547990424, "last_edit_date": 1548001470, "question_id": 54276857, "link": "https://stackoverflow.com/questions/54276857/resource-temporarily-unavailable-when-trying-to-connect-to-https-websocket-wit", "title": "&quot;Resource temporarily unavailable&quot; when trying to connect to https websocket with ws-rs (mio)", "body": "<p>I am trying to establish a secure connection using Rust <a href=\"https://github.com/housleyjk/ws-rs\" rel=\"nofollow noreferrer\"><code>ws-rs</code></a> (based on mio).</p>\n\n<p>The part of the code that I think is relevant:</p>\n\n<pre><code>impl ws::Handler for Client {\n    fn on_message(&amp;mut self, msg: ws::Message) -&gt; ws::Result&lt;()&gt; {\n        println!(\"msg = {}\", msg);\n        self.out.close(ws::CloseCode::Normal)\n    }\n\n    fn upgrade_ssl_client(\n        &amp;mut self,\n        sock: TcpStream,\n        _: &amp;url::Url,\n    ) -&gt; ws::Result&lt;SslStream&lt;TcpStream&gt;&gt; {\n        let mut builder = SslConnector::builder(SslMethod::tls()).map_err(|e| {\n            ws::Error::new(\n                ws::ErrorKind::Internal,\n                format!(\"Failed to upgrade client to SSL: {}\", e),\n            )\n        })?;\n        builder.set_verify(SslVerifyMode::empty());\n\n        let connector = builder.build()\n            .configure()\n            .unwrap()\n            .use_server_name_indication(false)\n            .verify_hostname(false)\n            .connect(\"localhost:12321\", sock)\n            .unwrap();\n\n        Ok(connector)\n    }\n}\n</code></pre>\n\n<p>A complete example is at <a href=\"https://github.com/mverleg/mwe_ws_rs_connectivity_issues/blob/master/rs_ws_ssl_server_client.rs\" rel=\"nofollow noreferrer\">Github</a>, it's ~150 lines which is as small as I could get it.</p>\n\n<p>I get this error:</p>\n\n<pre><code>thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value:\nWouldBlock(MidHandshakeSslStream {\n    stream: SslStream {\n        stream: TcpStream { addr: V4(127.0.0.1:52164), peer: V4(127.0.0.1:12321), fd: 12 },\n        ssl: Ssl { state: \"SSLv2/v3 read server hello A\", verify_result: X509VerifyResult { code: 0, error: \"ok\" } }\n    }, error: Error {\n        code: ErrorCode(2),\n        cause: Some(Io(Os {\n            code: 11,\n            kind: WouldBlock,\n            message: \"Resource temporarily unavailable\"\n        }))\n    }\n})\n</code></pre>\n\n<p>I don't really know what that means...</p>\n\n<p>(I also created a ws-rs Github <a href=\"https://github.com/housleyjk/ws-rs/issues/247\" rel=\"nofollow noreferrer\">issue</a> last month as I thought it might be a problem with the lib or the example)</p>\n"}, {"tags": ["xml", "parsing", "xpath", "rust", "rdf"], "comments": [{"owner": {"reputation": 9995, "user_id": 7879193, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-bVdcN0nQCio/AAAAAAAAAAI/AAAAAAAACfs/jPa4Dr_Nzbk/photo.jpg?sz=128", "display_name": "Stanislav Kralin", "link": "https://stackoverflow.com/users/7879193/stanislav-kralin"}, "edited": false, "score": 1, "creation_date": 1547992111, "post_id": 54276554, "comment_id": 95376055, "body": "Try <code>http:&#47;&#47;www.w3.org&#47;1999&#47;02&#47;22-rdf-syntax-ns</code> or <code>http:&#47;&#47;www.w3.org&#47;1999&#47;02&#47;22-rdf-syntax-ns#</code> instead of <code>https:&#47;&#47;www.w3.org&#47;1999&#47;02&#47;22-rdf-syntax-ns</code>."}, {"owner": {"reputation": 886, "user_id": 8170773, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/61b971ec934427a008d8b263ad4142b9?s=128&d=identicon&r=PG&f=1", "display_name": "hedgar2017", "link": "https://stackoverflow.com/users/8170773/hedgar2017"}, "reply_to_user": {"reputation": 9995, "user_id": 7879193, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-bVdcN0nQCio/AAAAAAAAAAI/AAAAAAAACfs/jPa4Dr_Nzbk/photo.jpg?sz=128", "display_name": "Stanislav Kralin", "link": "https://stackoverflow.com/users/7879193/stanislav-kralin"}, "edited": false, "score": 0, "creation_date": 1547994205, "post_id": 54276554, "comment_id": 95376668, "body": "Works! Thank you."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1547997744, "post_id": 54276554, "comment_id": 95377663, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54276554/edit\">edit</a> your question to include it. We cannot tell the complete XML that is input, which includes the namespace definitions. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1547998933, "creation_date": 1547998933, "answer_id": 54278081, "question_id": 54276554, "link": "https://stackoverflow.com/questions/54276554/how-do-i-select-the-value-of-a-namespaced-attribute-with-sxd-xpath/54278081#54278081", "title": "How do I select the value of a namespaced attribute with SXD-XPath?", "body": "<p>According to <a href=\"https://www.w3.org/TR/rdf-syntax-grammar/#section-Namespace\" rel=\"nofollow noreferrer\">the RDF RFC</a>, the RDF namespace URI is <code>http://www.w3.org/1999/02/22-rdf-syntax-ns#</code>.</p>\n\n<p>Assuming that your input XML properly defines this namespace:</p>\n\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=\"1.0\"?&gt;\n&lt;outer xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"&gt;\n  &lt;ultradata xml:id=\"deadbeef\" rdf:resource=\"http://some-resource/ultralink\"&gt;Some stuff&lt;/ultradata&gt;\"\n&lt;/outer&gt;\n</code></pre>\n\n<p>Then you need to use the same namespace in the code:</p>\n\n<pre><code>static INPUT: &amp;str = r##\"&lt;?xml version=\"1.0\"?&gt;\n&lt;outer xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\"&gt;\n  &lt;ultradata xml:id=\"deadbeef\" rdf:resource=\"http://some-resource/ultralink\"&gt;Some stuff&lt;/ultradata&gt;\"\n&lt;/outer&gt;\n\"##;\n\nfn main() {\n    let package = sxd_document::parser::parse(INPUT).expect(\"Invalid XML\");\n    let doc = package.as_document();\n\n    let mut context = sxd_xpath::Context::new();\n    context.set_namespace(\"rdf\", \"http://www.w3.org/1999/02/22-rdf-syntax-ns#\");\n\n    let xpath = sxd_xpath::Factory::new().build(\"//@rdf:resource\").expect(\"Invalid XPath\").expect(\"No XPath\");\n    let value = xpath.evaluate(&amp;context, doc.root()).expect(\"Cannot evaluate XPath\");\n\n    if let sxd_xpath::Value::Nodeset(ns) = value {\n        for n in ns {\n            println!(\"{:?}\", n);\n        }\n    }\n}\n</code></pre>\n\n<hr>\n\n<p>Disclaimer: I am the author of SXD-XPath and SXD-Document</p>\n"}], "owner": {"reputation": 886, "user_id": 8170773, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/61b971ec934427a008d8b263ad4142b9?s=128&d=identicon&r=PG&f=1", "display_name": "hedgar2017", "link": "https://stackoverflow.com/users/8170773/hedgar2017"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 97, "favorite_count": 0, "accepted_answer_id": 54278081, "answer_count": 1, "score": 0, "last_activity_date": 1547998933, "creation_date": 1547988128, "last_edit_date": 1547997368, "question_id": 54276554, "link": "https://stackoverflow.com/questions/54276554/how-do-i-select-the-value-of-a-namespaced-attribute-with-sxd-xpath", "title": "How do I select the value of a namespaced attribute with SXD-XPath?", "body": "<p>I have the following XML:</p>\n\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;ultradata xml:id=\"deadbeef\" rdf:resource=\"http://some-resource/ultralink\"&gt;Some stuff&lt;/ultradata&gt;\n</code></pre>\n\n<p>I want to get the value of <code>rdf:resource</code>, but I cannot figure out how to do namespacing. My namespace registration:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>let mut context = sxd_xpath::Context::new();\ncontext.set_namespace(\"xml\", \"http://www.w3.org/XML/1998/namespace\");\ncontext.set_namespace(\"rdf\", \"https://www.w3.org/1999/02/22-rdf-syntax-ns\");\n</code></pre>\n\n<p>It seems that there is no <code>resource</code> at <a href=\"https://www.w3.org/1999/02/22-rdf-syntax-ns\" rel=\"nofollow noreferrer\">https://www.w3.org/1999/02/22-rdf-syntax-ns</a>.</p>\n\n<p><code>@xml:id</code> works, but <code>@rdf:resource</code> does not. From the same context, of course.</p>\n\n<p>This namespace stuff is really weird. How can I select the value of <code>rdf:resource</code>?</p>\n"}, {"tags": ["random", "rust", "alphanumeric"], "answers": [{"comments": [{"owner": {"reputation": 366, "user_id": 11492659, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/3e61e264c1094508a0ae578af2fc03e6?s=128&d=identicon&r=PG&f=1", "display_name": "hzqelf", "link": "https://stackoverflow.com/users/11492659/hzqelf"}, "edited": false, "score": 1, "creation_date": 1597913777, "post_id": 54277357, "comment_id": 112289290, "body": "<code>Alphanumeric</code> isn&#39;t equals <code>ascii</code>. <code>ascii</code> includes <code>!@#$%^&amp;*(){}[]:;&quot;&#39;&lt;&gt;?,.&#47;|\\-_+=</code>, etc."}], "tags": [], "owner": {"reputation": 351, "user_id": 6364989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6d5184dda79dcd18dd12ee12e5e7122d?s=128&d=identicon&r=PG&f=1", "display_name": "M. Clabaut", "link": "https://stackoverflow.com/users/6364989/m-clabaut"}, "is_accepted": true, "score": 16, "last_activity_date": 1609942378, "last_edit_date": 1609942378, "creation_date": 1547993858, "answer_id": 54277357, "question_id": 54275459, "link": "https://stackoverflow.com/questions/54275459/how-do-i-create-a-random-string-by-sampling-from-alphanumeric-characters/54277357#54277357", "title": "How do I create a random String by sampling from alphanumeric characters?", "body": "<p>As explained in the <a href=\"https://docs.rs/rand/0.5.0/rand/trait.Rng.html#method.gen_ascii_chars\" rel=\"nofollow noreferrer\">rand 0.5.0 docs</a>, <code>gen_ascii_chars</code> is deprecated and you should use <code>sample_iter(&amp;Alphanumeric)</code> instead.</p>\n<pre class=\"lang-rust prettyprint-override\"><code>use rand::{distributions::Alphanumeric, Rng}; // 0.8\n\nfn main() {\n    let s: String = rand::thread_rng()\n        .sample_iter(&amp;Alphanumeric)\n        .take(7)\n        .map(char::from)\n        .collect();\n    println!(&quot;{}&quot;, s);\n}\n</code></pre>\n"}], "owner": {"reputation": 351, "user_id": 6364989, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6d5184dda79dcd18dd12ee12e5e7122d?s=128&d=identicon&r=PG&f=1", "display_name": "M. Clabaut", "link": "https://stackoverflow.com/users/6364989/m-clabaut"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3246, "favorite_count": 2, "accepted_answer_id": 54277357, "answer_count": 1, "score": 9, "last_activity_date": 1609942378, "creation_date": 1547979629, "last_edit_date": 1548003242, "question_id": 54275459, "link": "https://stackoverflow.com/questions/54275459/how-do-i-create-a-random-string-by-sampling-from-alphanumeric-characters", "title": "How do I create a random String by sampling from alphanumeric characters?", "body": "<p>I tried to compile the following code:</p>\n\n<pre><code>extern crate rand; // 0.6\nuse rand::Rng;\n\nfn main() {\n    rand::thread_rng()\n        .gen_ascii_chars()\n        .take(10)\n        .collect::&lt;String&gt;();\n}\n</code></pre>\n\n<p>but <code>cargo build</code> says:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>warning: unused import: `rand::Rng`\n --&gt; src/main.rs:2:5\n  |\n2 | use rand::Rng;\n  |     ^^^^^^^^^\n  |\n  = note: #[warn(unused_imports)] on by default\n\nerror[E0599]: no method named `gen_ascii_chars` found for type `rand::prelude::ThreadRng` in the current scope\n --&gt; src/main.rs:6:10\n  |\n6 |         .gen_ascii_chars()\n  |          ^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>The Rust compiler asks me to remove the <code>use rand::Rng;</code> clause, at the same time complaining that there is no <code>gen_ascii_chars</code> method. \nI would expect Rust to just use <code>rand::Rng</code> trait, and to not provide such a contradictory error messages. How can I go further from here?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1547962420, "post_id": 54273751, "comment_id": 95370219, "body": "add <code>.cloned()</code> before collect, and please this is not a good question at all."}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1547989756, "post_id": 54275839, "comment_id": 95375424, "body": "<a href=\"https://play.integer32.com/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f9906ee9a4373bda1e47d82b755d41ad\" rel=\"nofollow noreferrer\">play.integer32.com/&hellip;</a> ?"}, {"owner": {"reputation": 2920, "user_id": 210304, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/3c70d1833ed67198b6e364834b13c770?s=128&d=identicon&r=PG", "display_name": "Caio", "link": "https://stackoverflow.com/users/210304/caio"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1547990801, "post_id": 54275839, "comment_id": 95375714, "body": "@Stargateur You are right. Edited."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1547992633, "post_id": 54275839, "comment_id": 95376194, "body": "You should use <code>retain</code> instead of <code>into_iter</code> + <code>filter</code> + <code>collect</code> if you are okay with consuming the <code>Vec</code>. Know your standard library!"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1547992801, "post_id": 54275839, "comment_id": 95376231, "body": "Also, I&#39;d put <code>cloned()</code> before <code>filter</code>, and avoid the double-borrow, but maybe that&#39;s just me."}], "tags": [], "owner": {"reputation": 2920, "user_id": 210304, "user_type": "registered", "accept_rate": 92, "profile_image": "https://www.gravatar.com/avatar/3c70d1833ed67198b6e364834b13c770?s=128&d=identicon&r=PG", "display_name": "Caio", "link": "https://stackoverflow.com/users/210304/caio"}, "is_accepted": false, "score": 4, "last_activity_date": 1600030357, "last_edit_date": 1600030357, "creation_date": 1547982380, "answer_id": 54275839, "question_id": 54273751, "link": "https://stackoverflow.com/questions/54273751/rust-and-vec-iterator-how-to-filter/54275839#54275839", "title": "rust and vec iterator - how to filter", "body": "<p>There is a single <a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#impl-FromIterator%3CT%3E\" rel=\"nofollow noreferrer\">implementation of <code>FromIterator</code> for <code>Vec</code></a>, and this implementation collects values of <code>T</code> from the same type <code>T</code>, i.e., it is not possible to convert <code>T</code> into an arbitrary type <code>U</code> and collect its elements at the same time.</p>\n<p>In your case, you want to collect an iterator of <code>&amp;f64</code> into a vector of <code>f64</code>, therefore, you need to convert by cloning/copying and then collect.</p>\n<pre><code>self.data.iter().filter(|&amp;&amp;x| x != self.missing_value).cloned().collect::&lt;Vec&lt;f64&gt;&gt;();\n</code></pre>\n<p>If you have ownership of the vector, it is possible to iterate over <code>f64</code> instead of <code>&amp;f64</code> by using <code>into_iter</code>.</p>\n<pre><code>self.data.into_iter().filter(|&amp;x| x != self.missing_value).collect::&lt;Vec&lt;f64&gt;&gt;();\n</code></pre>\n"}], "owner": {"reputation": 61601, "user_id": 1203556, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/aca772bc8ed79a86894211c7efd920aa?s=128&d=identicon&r=PG", "display_name": "Tampa", "link": "https://stackoverflow.com/users/1203556/tampa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2999, "favorite_count": 0, "closed_date": 1548000170, "answer_count": 1, "score": -1, "last_activity_date": 1600030357, "creation_date": 1547960802, "last_edit_date": 1548000165, "question_id": 54273751, "link": "https://stackoverflow.com/questions/54273751/rust-and-vec-iterator-how-to-filter", "closed_reason": "Duplicate", "title": "rust and vec iterator - how to filter", "body": "<p>I have a vector and trying to create a new vector by filtering.  It does not work and I don't know why:</p>\n\n<pre><code>fn example(data: Vec&lt;f64&gt;, missing_value: f64) {\n    let dude = data\n        .iter()\n        .filter(|&amp;x| *x != missing_value)\n        .collect::&lt;Vec&lt;f64&gt;&gt;();\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: a collection of type `std::vec::Vec&lt;f64&gt;` cannot be built from an iterator over elements of type `&amp;f64`\n --&gt; src/lib.rs:5:10\n  |\n5 |         .collect::&lt;Vec&lt;f64&gt;&gt;();\n  |          ^^^^^^^ a collection of type `std::vec::Vec&lt;f64&gt;` cannot be built from `std::iter::Iterator&lt;Item=&amp;f64&gt;`\n  |\n  = help: the trait `std::iter::FromIterator&lt;&amp;f64&gt;` is not implemented for `std::vec::Vec&lt;f64&gt;`\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "edited": false, "score": 2, "creation_date": 1547927788, "post_id": 54270851, "comment_id": 95364536, "body": "Dont use <code>let</code>, just assign a new value: <code>Acceleration = TerminalVelocity;</code>. Otherwise the &quot;new&quot; <code>Acceleration</code> in the inner scope will simply shadow the outer one."}, {"owner": {"reputation": 51, "user_id": 10926030, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-w_r5FGhM3is/AAAAAAAAAAI/AAAAAAAAACw/oToWnr9Lvv0/photo.jpg?sz=128", "display_name": "Andrew Chon", "link": "https://stackoverflow.com/users/10926030/andrew-chon"}, "reply_to_user": {"reputation": 7882, "user_id": 2722968, "user_type": "registered", "accept_rate": 50, "profile_image": "https://www.gravatar.com/avatar/d0a9ce812892f03b8342c5a60be24632?s=128&d=identicon&r=PG&f=1", "display_name": "user2722968", "link": "https://stackoverflow.com/users/2722968/user2722968"}, "edited": false, "score": 0, "creation_date": 1547927848, "post_id": 54270851, "comment_id": 95364551, "body": "I feel like an absolute idiot haha. Thank you."}], "owner": {"reputation": 51, "user_id": 10926030, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-w_r5FGhM3is/AAAAAAAAAAI/AAAAAAAAACw/oToWnr9Lvv0/photo.jpg?sz=128", "display_name": "Andrew Chon", "link": "https://stackoverflow.com/users/10926030/andrew-chon"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 57, "favorite_count": 0, "closed_date": 1547944429, "answer_count": 0, "score": 0, "last_activity_date": 1547956891, "creation_date": 1547927700, "last_edit_date": 1547956891, "question_id": 54270851, "link": "https://stackoverflow.com/questions/54270851/access-a-variable-that-is-inside-an-if-statement", "closed_reason": "Duplicate", "title": "Access a variable that is inside an if statement", "body": "<p>Basically, I am working on a little physics information thingy. I need to access the variable inside of an if-statement. (I initialized it at the start of fn main(), and I changed the value in an if-statement). From my experiences (which are few) I noticed that Rust really just does not like you making public variables, let alone, editing them.</p>\n\n<p>I have tried to do a shift operation using two different variables, but I kind of figured it wouldn't work:</p>\n\n<pre><code>    if Falling {\n        if Acceleration &gt; TerminalVelocity {\n            let mut FinalAcceleration = TerminalVelocity;\n            Acceleration &lt;&lt; FinalAcceleration;\n        }\n    }\n\n</code></pre>\n\n<p>Here is the code I currently have right now:</p>\n\n<pre><code>mod friction;\nmod terminal_velocity;\nfn main() {\n    let mut Falling = true;\n\n    let mut Mass: f32 = 10.0;\n    let mut Gravity: f32 = 9.81;\n    let mut Incline: f32 = 0.0;\n    let mut FricCoefficient: f32 = 0.5;\n    let mut DeltaTime: f32 = 5.0;\n    let mut Acceleration: f32 = 5.0;\n\n    let mut AtmosDensity: f32 = 1.225;\n    let mut FrontalArea: f32 = 5.0;\n    let mut Weight: f32 = 4.45;\n    let mut DragCoefficient: f32 = 0.6;\n\n    let mut TerminalVelocity: f32 = terminal_velocity::terminal_velocity(AtmosDensity, FrontalArea, Weight, DragCoefficient);\n    if Falling {\n        if Acceleration &gt; TerminalVelocity {\n            let mut Acceleration = TerminalVelocity;\n        }\n    }\n\n    let f_val = friction::friction(Mass, Gravity, Incline, FricCoefficient, DeltaTime, Acceleration);\n    println!(\"{}\", f_val)\n}\n</code></pre>\n\n<p>I expected it to use the variable I had declared within that if-statement, however it just ignored it and used the initial value of 'Acceleration'.</p>\n\n<p>P.S Yes, I know I should use snake-case, VS Code yells at me for it all the time.</p>\n\n<p>P.S.S Yes, I know the physics are really bad.</p>\n\n<p>I am new to Rust, and I came to it mainly because of its low-risk. However, I am not as adapted to it as I am other languages. The solution might be blatantly obvious, which in that case, I apologize for wasting your time. Thank you for your help.</p>\n"}, {"tags": ["async-await", "rust", "rust-tokio"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1547930158, "post_id": 54270468, "comment_id": 95365121, "body": "<i>&quot;Directly returning <code>impl trait</code> is not allowed&quot;</i> \u2014 what makes you say that?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1547930371, "post_id": 54270468, "comment_id": 95365178, "body": "Ah. You mean it&#39;s not allowed in a trait. Yes, in this situation you will need to return a trait object."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547952410, "post_id": 54270468, "comment_id": 95368998, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54270468/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code, or even what version of Rust you are using! Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 657, "user_id": 2547570, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/66ac34b6d04aa0bf9c738ef391c8b722?s=128&d=identicon&r=PG", "display_name": "mq7", "link": "https://stackoverflow.com/users/2547570/mq7"}, "edited": false, "score": 0, "creation_date": 1548068454, "post_id": 54270468, "comment_id": 95397761, "body": "Should I include a Rust Playground link for each short example?"}], "answers": [{"tags": [], "owner": {"reputation": 8073, "user_id": 2852624, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/682806d261e4f00f77aa8633689a9558?s=128&d=identicon&r=PG&f=1", "display_name": "Matthias247", "link": "https://stackoverflow.com/users/2852624/matthias247"}, "is_accepted": true, "score": 2, "last_activity_date": 1547952569, "last_edit_date": 1547952569, "creation_date": 1547932874, "answer_id": 54271495, "question_id": 54270468, "link": "https://stackoverflow.com/questions/54270468/tokio-async-await-with-trait/54271495#54271495", "title": "tokio-async-await with trait", "body": "<p>Neither <code>async</code> functions nor <code>impl Trait</code> are allowed in traits. You can use associated types to get closer. Here are some ideas:</p>\n\n<pre><code>pub trait ResourceTrait {\n    type FutType: Future&lt;Output = ()&gt;;\n\n    fn prepare(&amp;mut self, auth: &amp;str) -&gt; Self::Next;\n}\n</code></pre>\n\n<p>Implementing this is currently is a bit tricky, since some of the required tooling is either not yet available, stable or buggy.</p>\n\n<p>It can be implemented as:</p>\n\n<pre><code>impl ResourceTrait for Resource {\n    type FutType = FutureObj&lt;'static, ()&gt;;\n\n    fn prepare(&amp;mut self, auth: &amp;str) -&gt; FutureObj&lt;'static, ()&gt; {\n        FutureObj::new(Box::new(\n            async move {\n                // Do async things\n                // You might get a lifetime issue here if trying to access auth,\n                // since it's borrowed.\n            }\n        ))\n    }\n}\n\n</code></pre>\n\n<p>An alternative with existential types might be:</p>\n\n<pre><code>impl ResourceTrait for Resource {\n    // this is required since the real type of the async function\n    // is unnameable\n    existential type FutType = Future&lt;Output = ()&gt;;\n\n    fn prepare(&amp;mut self, auth: &amp;str) -&gt; Self::FutType {\n        async move {\n            // Do async things. Might still encounter the same borrowing issues,\n            // since the lifetime of the returned Future isn't coupled to the\n            // lifetime of self.\n            // The workaround is to make copies of all required fields and move\n            // them into the Future\n        }\n    }\n}\n\n</code></pre>\n\n<p>This might or might not work (since the feature is work in progress).\nFor properly borrowing parameters like <code>self</code> or <code>auth</code> in the returned future, we might also need Generic Associated Types to be available first. </p>\n\n<p>In order to workaround the borrowing problems for <code>self</code>, you might be able to define</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Resource {\n    inner: Arc&lt;ResourceInner&gt;, // carries all actual state\n}\n</code></pre>\n\n<p>so that you can copy <code>inner</code> in <code>prepare</code> and move it into the <code>Future</code>.</p>\n"}, {"tags": [], "owner": {"reputation": 91, "user_id": 2255882, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/0ea0663cf8b8883c9bceddff810e5830?s=128&d=identicon&r=PG", "display_name": "ShadowFan-X", "link": "https://stackoverflow.com/users/2255882/shadowfan-x"}, "is_accepted": false, "score": 1, "last_activity_date": 1564935885, "creation_date": 1564935885, "answer_id": 57348266, "question_id": 54270468, "link": "https://stackoverflow.com/questions/54270468/tokio-async-await-with-trait/57348266#57348266", "title": "tokio-async-await with trait", "body": "<p>If you're okay with returning a boxed future, you can use the <a href=\"https://crates.io/crates/async-trait\" rel=\"nofollow noreferrer\"><code>async-trait</code></a> crate:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(async_await)]\n\nuse async_trait::async_trait;\n\n#[async_trait]\ntrait Advertisement {\n    async fn run(&amp;self);\n}\n\nstruct Modal;\n\n#[async_trait]\nimpl Advertisement for Modal {\n    async fn run(&amp;self) {\n        self.render_fullscreen().await;\n        for _ in 0..4u16 {\n            remind_user_to_join_mailing_list().await;\n        }\n        self.hide_for_now().await;\n    }\n}\n\nstruct AutoplayingVideo {\n    media_url: String,\n}\n\n#[async_trait]\nimpl Advertisement for AutoplayingVideo {\n    async fn run(&amp;self) {\n        let stream = connect(&amp;self.media_url).await;\n        stream.play().await;\n\n        // Video probably persuaded user to join our mailing list!\n        Modal.run().await;\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 657, "user_id": 2547570, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/66ac34b6d04aa0bf9c738ef391c8b722?s=128&d=identicon&r=PG", "display_name": "mq7", "link": "https://stackoverflow.com/users/2547570/mq7"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1801, "favorite_count": 0, "accepted_answer_id": 54271495, "answer_count": 2, "score": 6, "last_activity_date": 1564935885, "creation_date": 1547924957, "last_edit_date": 1548070552, "question_id": 54270468, "link": "https://stackoverflow.com/questions/54270468/tokio-async-await-with-trait", "title": "tokio-async-await with trait", "body": "<p>I'd like to write async functions in a trait, but since <code>async fn</code> in traits are not supported yet, I am trying to find the equivalent method interface. This is what I have tried in Rust nightly (2019-01-01):</p>\n\n<p><a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=07038a797e6c140de604f0eac5344d97\" rel=\"noreferrer\">playground</a></p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>#![feature(await_macro, async_await, futures_api)]\n#[macro_use]\nextern crate tokio;\nuse tokio::prelude::*;\n\ntrait T {\n    async fn f();\n}\n\nfn main() {\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0706]: trait fns cannot be declared `async`\n --&gt; src/main.rs:7:5\n  |\n7 |     async fn f();\n  |     ^^^^^^^^^^^^^\n</code></pre>\n\n<p>I read somewhere that <code>async</code> is just <code>impl Future</code>.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait T {\n    fn f() -&gt; impl futures::Future&lt;Item = (), Error = ()&gt;;\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0562]: `impl Trait` not allowed outside of function and inherent method return types\n --&gt; src/lib.rs:2:15\n  |\n2 |     fn f() -&gt; impl futures::Future&lt;Item = (), Error = ()&gt;;\n  |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>Directly returning <code>impl trait</code> is not allowed, so I tried a boxed trait:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>trait Resource {\n    fn loaded(&amp;self) -&gt; bool;\n    fn init(&amp;mut self, auth: &amp;str) -&gt; Box&lt;dyn std::future::Future&lt;Output=()&gt;&gt;;\n    fn prepare(&amp;mut self, auth: &amp;str) -&gt; Box&lt;dyn std::future::Future&lt;Output=()&gt;&gt; {\n        Box::new(async {\n            if !self.loaded() {\n                await!(*(self.init(auth)));\n            }\n        })\n    }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>[rustc] the size for values of type `dyn std::future::Future&lt;Output=()&gt;` cannot be known at compilation time\n</code></pre>\n\n<p>Without deref, I get the error that no <code>into_awaitable</code> exists for <code>Box&lt;&gt;.</code></p>\n\n<p>Can I use non-Sized <code>impl Future</code> or <code>*Box&lt;Future&gt;</code> with <code>await!</code>? What is the most suitable interface for async functions in the trait?</p>\n"}, {"tags": ["types", "rust", "closures"], "comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 2, "creation_date": 1547923580, "post_id": 54269942, "comment_id": 95363469, "body": "At first your approach is wrong, you are moving <code>fst</code> into <code>sub</code> function then trying to change it&#39;s value. but returning nothing ? <code>fst</code> is going to be dropped inside sub function."}], "answers": [{"comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1547931461, "post_id": 54270419, "comment_id": 95365444, "body": "And also this simple <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7d29a34ebe5a0cd6366da331463cae31\" rel=\"nofollow noreferrer\">code</a> , check the error, it says: &quot;note: no two closures, even if identical, have the same type&quot;, &quot;help: consider boxing your closure and/or using it as a trait object&quot;"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547956474, "post_id": 54270419, "comment_id": 95369501, "body": "<i>But I really am not sure why you would want to do this!</i> \u2014 This 100%. Just <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=11c373e10f2b0f9a1b95867f2d0488f4\" rel=\"nofollow noreferrer\">reassign <code>fst</code> and let it get a new type</a>."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547982452, "post_id": 54270419, "comment_id": 95373676, "body": "@Shepmaster I actually made an assumption that OP wanted to overwrite the input fn pointer, which wasn&#39;t quite expressed in the question. That&#39;s why I included an example <code>main</code> that uses the solution. If it was just a matter of reusing the variable name <i>inside</i> the function, it seemed too trivial a request - but maybe that&#39;s what OP actually wanted?"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 5, "last_activity_date": 1547929482, "last_edit_date": 1547929482, "creation_date": 1547924535, "answer_id": 54270419, "question_id": 54269942, "link": "https://stackoverflow.com/questions/54269942/is-it-possible-to-assign-a-closure-to-a-variable-of-type-impl-fn/54270419#54270419", "title": "Is it possible to assign a closure to a variable of type impl Fn()?", "body": "<p>This cannot be done without boxing. The reason is that the actual type of <code>fst</code> in the input is different than the type of the closure that you later overwrite it with. The only way to make them the same type is with a trait object.</p>\n\n<p>The boxed version might look like this:</p>\n\n<pre><code>use std::mem;\n\nfn sub&lt;'a, T: Clone + 'a&gt;(fst: &amp;mut Box&lt;dyn Fn(T) + 'a&gt;, snd: impl Fn(T) + 'a) {\n    // Replace the original fst with a dummy closure while the new closure is being\n    // constructed, to avoid the reference being temporarily invalid\n    let fst_orig = mem::replace(fst, Box::new(|_| {}));\n    *fst = Box::new(move |t: T| {\n        fst_orig(t.clone());\n        snd(t)\n    });\n}\n\n\nfn main() {\n    let mut f1: Box&lt;dyn Fn(i32)&gt; = Box::new(|x| println!(\"f1: {}\", x));\n    let f2 = |x| println!(\"f2: {}\", x);\n\n    sub(&amp;mut f1, f2);\n\n    f1(42);\n}\n</code></pre>\n\n<p>But I really am not sure why you would want to do this!</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1547956818, "creation_date": 1547956818, "answer_id": 54273468, "question_id": 54269942, "link": "https://stackoverflow.com/questions/54269942/is-it-possible-to-assign-a-closure-to-a-variable-of-type-impl-fn/54273468#54273468", "title": "Is it possible to assign a closure to a variable of type impl Fn()?", "body": "<p>Answering the question you <em>asked</em>,  no, you cannot yet assign a closure to a variable with the type <code>impl Fn</code> because you cannot yet declare such a variable:</p>\n\n<pre><code>fn foo() {\n    let x: impl Fn() = move || println!(\"Hello\");\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0562]: `impl Trait` not allowed outside of function and inherent method return types\n --&gt; src/lib.rs:2:12\n  |\n2 |     let x: impl Fn() = move || println!(\"Hello\");\n  |            ^^^^^^^^^\n</code></pre>\n\n<p>\"But wait!\" you say, \"I have such a type in my function argument!\". Truth is that no, you do not. </p>\n\n<p>This syntax:</p>\n\n<pre><code>fn foo(x: impl Fn()) {}\n</code></pre>\n\n<p>Is just shorthand for this:</p>\n\n<pre><code>fn foo&lt;F&gt;(x: F)\nwhere\n    F: Fn(),\n{}\n</code></pre>\n\n<p>You've simply constructed a generic and applied a trait bound to it. </p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/47929824/155423\">What makes `impl Trait` as an argument &quot;universal&quot; and as a return value &quot;existential&quot;?</a></li>\n</ul>\n"}], "owner": {"reputation": 49, "user_id": 10938171, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b7482338737e1107b3df12d19ac04a32?s=128&d=identicon&r=PG&f=1", "display_name": "Edgar", "link": "https://stackoverflow.com/users/10938171/edgar"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 486, "favorite_count": 0, "answer_count": 2, "score": 4, "last_activity_date": 1548089756, "creation_date": 1547921318, "last_edit_date": 1548089756, "question_id": 54269942, "link": "https://stackoverflow.com/questions/54269942/is-it-possible-to-assign-a-closure-to-a-variable-of-type-impl-fn", "title": "Is it possible to assign a closure to a variable of type impl Fn()?", "body": "<p>I was able to make this code work:</p>\n\n<pre><code>fn twice&lt;T: Clone&gt;(fst: impl Fn(T), snd: impl Fn(T)) -&gt; impl Fn(T) {\n    move |t| {\n        fst(t.clone());\n        snd(t)\n    }\n}\n</code></pre>\n\n<p>However, what I want is this (without boxing):</p>\n\n<pre><code>fn sub&lt;T: Clone&gt;(mut fst: impl Fn(T), snd: impl Fn(T)) {\n    fst = move |t: T| {\n        fst(t.clone());\n        snd(t)\n    };\n}\n</code></pre>\n\n<p>Is there a way I can make the second piece of code work without boxing, using traits, type casting or any other method? Rust complains that the types do not match.</p>\n"}, {"tags": ["rust", "borrow-checker"], "answers": [{"comments": [{"owner": {"reputation": 1780, "user_id": 648661, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a2f49b925608fec6fe8520f0fbe4e14e?s=128&d=identicon&r=PG", "display_name": "Terseus", "link": "https://stackoverflow.com/users/648661/terseus"}, "edited": false, "score": 1, "creation_date": 1548084064, "post_id": 54268089, "comment_id": 95406409, "body": "<i>(or of any of its parts)</i> Thanks, that was what I missed about ownership in structs, now I understand the error. Unfortunately in my real world case <code>Item</code> (and therefore <code>Item::increment</code>) comes from a third-party API so I can&#39;t just make it <code>mut</code> there, also it&#39;s not easy to construct a new instance of <code>Item</code> so the <code>mem::replace</code> solution it&#39;s not what I were expecting.  I&#39;m going to open a new question about this specific case."}], "tags": [], "owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "is_accepted": true, "score": 1, "last_activity_date": 1547921151, "last_edit_date": 1547921151, "creation_date": 1547908099, "answer_id": 54268089, "question_id": 54267665, "link": "https://stackoverflow.com/questions/54267665/cannot-move-out-of-borrowed-content-when-replacing-a-struct-field/54268089#54268089", "title": "&quot;cannot move out of borrowed content&quot; when replacing a struct field", "body": "<ul>\n<li><code>Item::increment</code> expects <code>self</code> by value, it moves the <code>Item</code> on which it is invoked.</li>\n<li><code>Container::increment_item</code> takes <code>&amp;mut self</code> by reference, it allows you to mutate <code>self</code>, but it does not allow you to take ownership of <code>self</code> (or of any of its parts).</li>\n<li>When you invoke <code>self.item.increment(amount)</code>, you are trying to pass <code>self.item</code> by value, thus moving ownership to the <code>Item::increment</code> function, but you are not allowed to do this with references to values that you don't own.</li>\n</ul>\n\n<p>Just pass <code>self</code> to <code>Item::increment</code> by mutable reference, that's exactly what mutable references are for:</p>\n\n<pre><code>struct Item {\n    x: u32,\n}\n\nimpl Item {\n    pub fn increment(&amp;mut self, amount: u32) {\n        self.x += amount;\n    }\n}\n\nstruct Container {\n    item: Item,\n}\n\nimpl Container {\n    pub fn increment_item(&amp;mut self, amount: u32) {\n        self.item.increment(amount);\n    }\n}\n</code></pre>\n\n<p>If you insist on taking ownership of <code>Item</code>, then you could use <code>mem::replace</code>:</p>\n\n<pre><code>use std::mem;\n\nstruct Item {\n    x: u32,\n}\n\nimpl Item {\n    pub fn increment(self, amount: u32) -&gt; Self {\n        Item { x: self.x + amount }\n    }\n}\n\nstruct Container {\n    item: Item,\n}\n\nimpl Container {\n    pub fn increment_item(&amp;mut self, amount: u32) {\n        self.item = mem::replace(&amp;mut self.item, Item { x: 0 }).increment(amount);\n    }\n}\n</code></pre>\n\n<p>but it seems unnecessarily complicated in this case.</p>\n"}, {"comments": [{"owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "edited": false, "score": 0, "creation_date": 1549010496, "post_id": 54268155, "comment_id": 95758665, "body": "kindly explain the downvote!"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1555393357, "post_id": 54268155, "comment_id": 98083847, "body": "Not the downvoter, but you can&#39;t make every item copy. Therefore it&#39;s not a solution for every usecase."}], "tags": [], "owner": {"reputation": 429, "user_id": 5081997, "user_type": "registered", "profile_image": "https://lh3.googleusercontent.com/-GmesG-HGk2A/AAAAAAAAAAI/AAAAAAAACLI/lmInTd8OR3A/photo.jpg?sz=128", "display_name": "cotigao", "link": "https://stackoverflow.com/users/5081997/cotigao"}, "is_accepted": false, "score": -1, "last_activity_date": 1555393363, "last_edit_date": 1555393363, "creation_date": 1547908545, "answer_id": 54268155, "question_id": 54267665, "link": "https://stackoverflow.com/questions/54267665/cannot-move-out-of-borrowed-content-when-replacing-a-struct-field/54268155#54268155", "title": "&quot;cannot move out of borrowed content&quot; when replacing a struct field", "body": "<p><code>increment_item()</code> takes <code>Container</code> by  reference and <code>item</code> cannot be moved (or \"consumed\") while it is behind a reference since <code>increment()</code> takes <code>Item</code> by value. Quickest way to fix this is to make <code>Item</code> a <code>Copy</code> type. This will trigger a copy and not a move (i.e consume). <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=4825186dd85643e0c47d1b4eac9ecae3\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<pre><code>#[derive(Clone, Copy)]\nstruct Item {\n    x: u32,\n}\n</code></pre>\n\n<p>For more, please refer <a href=\"https://doc.rust-lang.org/std/marker/trait.Copy.html\" rel=\"nofollow noreferrer\">Copy</a></p>\n"}], "owner": {"reputation": 1780, "user_id": 648661, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a2f49b925608fec6fe8520f0fbe4e14e?s=128&d=identicon&r=PG", "display_name": "Terseus", "link": "https://stackoverflow.com/users/648661/terseus"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1096, "favorite_count": 0, "closed_date": 1547955461, "accepted_answer_id": 54268089, "answer_count": 2, "score": 0, "last_activity_date": 1555393363, "creation_date": 1547905014, "last_edit_date": 1548969309, "question_id": 54267665, "link": "https://stackoverflow.com/questions/54267665/cannot-move-out-of-borrowed-content-when-replacing-a-struct-field", "closed_reason": "Duplicate", "title": "&quot;cannot move out of borrowed content&quot; when replacing a struct field", "body": "<p>Consider this example:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>struct Item {\n    x: u32,\n}\n\nimpl Item {\n    pub fn increment(self, amount: u32) -&gt; Self {\n        Item { x: self.x + amount }\n    }\n}\n\nstruct Container {\n    item: Item,\n}\n\nimpl Container {\n    pub fn increment_item(&amp;mut self, amount: u32) {\n        // This line causes \"cannot move out of borrowed content\"\n        self.item = self.item.increment(amount);\n    }\n}\n</code></pre>\n\n<p>As you can see, <code>Item.increment</code> consumes the item and returns a new instance.</p>\n\n<p>In <code>Container.increment_item</code> I want to replace the current item with the one returned by <code>Item.increment</code> but the compiler yells at me with a <code>cannot move out of borrowed content</code> error.</p>\n\n<p>In <code>Container.increment_item</code> <code>self</code> is <code>mut</code> so I can mutate its fields, I don't understand why the compiler doesn't allow me to do it.</p>\n\n<p>I know that I can make <code>Container.increment_item</code> consumes <code>self</code> and return a new object, like <code>Item.increment</code> does, and it works, but I would like to understand why I'm getting the error and how can I fix it when I really can't consume the container.</p>\n"}, {"tags": ["path", "rust", "directory", "home-directory"], "answers": [{"tags": [], "owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "is_accepted": true, "score": 17, "last_activity_date": 1588166144, "last_edit_date": 1588166144, "creation_date": 1548155166, "answer_id": 54306906, "question_id": 54267608, "link": "https://stackoverflow.com/questions/54267608/expand-tilde-in-rust-path-idiomatically/54306906#54306906", "title": "Expand tilde in Rust Path idiomatically", "body": "<ol>\n<li><p>The most idiomatic way would be to just use an existing crate, in this case <code>shellexpand</code> (<a href=\"https://github.com/netvl/shellexpand\" rel=\"noreferrer\">github</a>, <a href=\"https://crates.io/crates/shellexpand\" rel=\"noreferrer\">crates.io</a>) seems to do what you want:</p>\n\n<pre><code>extern crate shellexpand; // 1.0.0\n\n#[test]\nfn test_shellexpand() {\n    let home = std::env::var(\"HOME\").unwrap();\n    assert_eq!(shellexpand::tilde(\"~/foo\"), format!(\"{}/foo\", home));\n}\n</code></pre></li>\n<li><p>Alternatively, you could try it with <code>dirs</code> (<a href=\"https://crates.io/crates/dirs\" rel=\"noreferrer\">crates.io</a>). Here is a sketch:</p>\n\n<pre><code>extern crate dirs; // 1.0.4\n\nuse std::path::{Path, PathBuf};\n\nfn expand_tilde&lt;P: AsRef&lt;Path&gt;&gt;(path_user_input: P) -&gt; Option&lt;PathBuf&gt; {\n    let p = path_user_input.as_ref();\n    if !p.starts_with(\"~\") {\n        return Some(p.to_path_buf());\n    }\n    if p == Path::new(\"~\") {\n        return dirs::home_dir();\n    }\n    dirs::home_dir().map(|mut h| {\n        if h == Path::new(\"/\") {\n            // Corner case: `h` root directory;\n            // don't prepend extra `/`, just drop the tilde.\n            p.strip_prefix(\"~\").unwrap().to_path_buf()\n        } else {\n            h.push(p.strip_prefix(\"~/\").unwrap());\n            h\n        }\n    })\n}\n</code></pre>\n\n<p>Usage examples:</p>\n\n<pre><code>#[test]\nfn test_expand_tilde() {\n    // Should work on your linux box during tests, would fail in stranger\n    // environments!\n    let home = std::env::var(\"HOME\").unwrap();\n    let projects = PathBuf::from(format!(\"{}/Projects\", home));\n    assert_eq!(expand_tilde(\"~/Projects\"), Some(projects));\n    assert_eq!(expand_tilde(\"/foo/bar\"), Some(\"/foo/bar\".into()));\n    assert_eq!(\n        expand_tilde(\"~alice/projects\"),\n        Some(\"~alice/projects\".into())\n    );\n}\n</code></pre>\n\n<p>Some remarks:</p>\n\n<ul>\n<li>The <code>P: AsRef&lt;Path&gt;</code> input type imitates what the standard\nlibrary does. This is why the method accepts all <code>Path</code>-like\ninputs, like <code>&amp;str</code>, <code>&amp;OsStr</code>, and <code>&amp;Path</code>.</li>\n<li><code>Path::new</code> doesn't allocate anything, it points to\nexactly the same bytes as the <code>&amp;str</code>.</li>\n<li><code>strip_prefix(\"~/\").unwrap()</code> should never fail here,\nbecause we checked that the path starts with <code>~</code> and\nis not just <code>~</code>. The only way how this can be is that\nthe path starts with <code>~/</code> (because of how <code>starts_with</code>\nis defined).</li>\n</ul></li>\n</ol>\n"}], "owner": {"reputation": 495, "user_id": 4253785, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Z7RjG.jpg?s=128&g=1", "display_name": "Cl&#233;ment Joly", "link": "https://stackoverflow.com/users/4253785/cl%c3%a9ment-joly"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3416, "favorite_count": 0, "accepted_answer_id": 54306906, "answer_count": 1, "score": 13, "last_activity_date": 1588166144, "creation_date": 1547904600, "last_edit_date": 1548156988, "question_id": 54267608, "link": "https://stackoverflow.com/questions/54267608/expand-tilde-in-rust-path-idiomatically", "title": "Expand tilde in Rust Path idiomatically", "body": "<p>Sometimes, for instance when reading some configuration file, you read a file path entered by the user without going through the shell (for instance, you get <code>~/test</code>).</p>\n\n<p>As <code>Option 2</code> below doesn\u2019t write to test file in user home directory, I\u2019m wondering if there is something more idiomatic than <code>Option 1</code>.</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>use std::env::var;\nuse std::fs::File;\nuse std::io::prelude::*;\nuse std::path::Path;\n\nfn write_to(path: &amp;Path) {\n    let mut f = File::create(path).unwrap();\n    f.write_all(\"Hi\".as_bytes()).unwrap();\n}\n\nfn main() {\n    // Option 1\n    let from_env = format!(\"{}/test\", var(\"HOME\").unwrap());\n    let with_var = Path::new(&amp;from_env);\n    // Create $HOME/test\n    write_to(with_var);\n\n    // Option 2\n    let with_tilde = Path::new(\"~/test\");\n    // Create the test file in current directory, provided a directory ./~ exists\n    write_to(with_tilde);\n}\n</code></pre>\n\n<p><strong><em>Note</strong>: <code>unwrap()</code> is used here to keep the example short. There should be some error handling in production code.</em></p>\n"}, {"tags": ["struct", "rust", "borrow-checker"], "comments": [{"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 1, "creation_date": 1547888474, "post_id": 54265184, "comment_id": 95354718, "body": "Who is supposed to own the <code>Bar</code> in <code>Foo::new(&amp;Bar::empty())</code>? The <code>Foo</code> struct doesn&#39;t own it, it only references it. Are you sure that you wanted a <code>&amp;&#39;a Bar</code>, and not just <code>Bar</code>, or something like <code>Box&lt;Bar&gt;</code>, or <code>Rc&lt;Bar&gt;</code>? Currently, your <code>Foo</code> has no raison d&#39;&#234;tre without a <code>Bar</code>, therefore you cannot instantiate a <code>Foo</code> without having a <code>Bar</code> in scope."}, {"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1547888634, "post_id": 54265184, "comment_id": 95354747, "body": "@AndreyTyukin There will be a parent struct owning both the bar and the foos referencing it. So foos will be spawned from the parent struct with a reference to the bar. However, when I am writing tests I want to create a lot of foos with a throwaway dummy bar, and I find my code for doing that gets very convoluted."}, {"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 1, "creation_date": 1547890049, "post_id": 54265184, "comment_id": 95355000, "body": "Maybe it&#39;s noteworthy that both <code>let foo = Foo { bar: &amp;Bar::empty() };</code> and <code>println!(&quot;{}&quot;, Foo::new(&amp;Bar::empty()).bar.value);</code> work, because <i>&quot;If you immediately assign the reference to a variable in a let statement (or make it part of some struct or array that is being immediately assigned), then Rust makes the [referenced] anonymous variable live as long as the variable the let initializes [...] Otherwise, the anonymous variable lives to the end of the enclosing statement&quot;</i> (Blandy, Orendorff). Especially the second part seems useful for short <code>assert</code> statements."}, {"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 1, "creation_date": 1547890288, "post_id": 54265184, "comment_id": 95355045, "body": "@AndreyTyukin Thanks for the input. Unfortunately, I need to use the <code>new</code> constructor. And doing the construction in the same line of code as the struct is used is usually not feasible since it may be used in multiple assertions etc. So I guess I will have to use a separate <code>let </code> statement to create the bar."}, {"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1547891194, "post_id": 54265184, "comment_id": 95355223, "body": "@AndreyTyukin By the way, I still think your comment qualifies as a good answer to my question so feel free to post it as such."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 1, "creation_date": 1547926767, "post_id": 54265184, "comment_id": 95364297, "body": "@Anders if this is sufficiently annoying, you could create a simple macro to have a shorter syntax."}], "answers": [{"comments": [{"owner": {"reputation": 51497, "user_id": 49246, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/c421b43470bb8d3c099c5a847e588549?s=128&d=identicon&r=PG", "display_name": "starblue", "link": "https://stackoverflow.com/users/49246/starblue"}, "edited": false, "score": 0, "creation_date": 1547985109, "post_id": 54273317, "comment_id": 95374282, "body": "Now that NLL are stable, has anybody investigated whether it is a good idea to extend the lifetime of temporaries?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 51497, "user_id": 49246, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/c421b43470bb8d3c099c5a847e588549?s=128&d=identicon&r=PG", "display_name": "starblue", "link": "https://stackoverflow.com/users/49246/starblue"}, "edited": false, "score": 0, "creation_date": 1548001075, "post_id": 54273317, "comment_id": 95378653, "body": "@starblue to be honest, I thought that <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=210bc4497f0ee6d9e01619fcb60517c9\" rel=\"nofollow noreferrer\">making the functions in question const</a> would allow this to work, but it doesn&#39;t (yet?)"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 51497, "user_id": 49246, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/c421b43470bb8d3c099c5a847e588549?s=128&d=identicon&r=PG", "display_name": "starblue", "link": "https://stackoverflow.com/users/49246/starblue"}, "edited": false, "score": 0, "creation_date": 1548003675, "post_id": 54273317, "comment_id": 95379452, "body": "@starblue ah, that was <a href=\"https://github.com/rust-lang/rust/pull/53851\" rel=\"nofollow noreferrer\">deliberately restricted</a>, so it&#39;s possible it might work in the future. I think it&#39;s orthogonal to NLL though."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1547954429, "creation_date": 1547954429, "answer_id": 54273317, "question_id": 54265184, "link": "https://stackoverflow.com/questions/54265184/is-there-one-line-syntax-for-constructing-a-struct-that-contains-a-reference-to/54273317#54273317", "title": "Is there one-line syntax for constructing a struct that contains a reference to a temporary?", "body": "<p>No, there is no such syntax, other than what you have typed. </p>\n\n<p>For the details of how long a temporary lives when you take a reference to it, see:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/47662253/155423\">Why is it legal to borrow a temporary?</a></li>\n</ul>\n\n<hr>\n\n<blockquote>\n  <p>There will be a parent struct owning both the <code>bar</code> and the <code>foo</code>s referencing it.</p>\n</blockquote>\n\n<p>Good luck:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/32300132/155423\">Why can&#39;t I store a value and a reference to that value in the same struct?</a></li>\n</ul>\n"}], "owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 224, "favorite_count": 0, "accepted_answer_id": 54273317, "answer_count": 1, "score": 1, "last_activity_date": 1547954429, "creation_date": 1547884967, "last_edit_date": 1547953860, "question_id": 54265184, "link": "https://stackoverflow.com/questions/54265184/is-there-one-line-syntax-for-constructing-a-struct-that-contains-a-reference-to", "title": "Is there one-line syntax for constructing a struct that contains a reference to a temporary?", "body": "<p>Consider the following invalid Rust code. There is one struct <code>Foo</code> that contains a reference to a second struct <code>Bar</code>:</p>\n\n<pre><code>struct Foo&lt;'a&gt; {\n    bar: &amp;'a Bar,\n}\n\nimpl&lt;'a&gt; Foo&lt;'a&gt; {\n    fn new(bar: &amp;'a Bar) -&gt; Foo&lt;'a&gt; {\n        Foo { bar }\n    }\n}\n\nstruct Bar {\n    value: String,\n}\n\nimpl Bar {\n    fn empty() -&gt; Bar {\n        Bar {\n            value: String::from(\"***\"),\n        }\n    }\n}\n\nfn main() {\n    let foo = Foo::new(&amp;Bar::empty());\n    println!(\"{}\", foo.bar.value);\n}\n</code></pre>\n\n<p>The compiler does not like this:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0716]: temporary value dropped while borrowed\n  --&gt; src/main.rs:24:25\n   |\n24 |     let foo = Foo::new(&amp;Bar::empty());\n   |                         ^^^^^^^^^^^^ - temporary value is freed at the end of this statement\n   |                         |\n   |                         creates a temporary which is freed while still in use\n25 |     println!(\"{}\", foo.bar.value);\n   |                    ------------- borrow later used here\n   |\n   = note: consider using a `let` binding to create a longer lived value\n</code></pre>\n\n<p>I can make it work by doing what the compiler says - using a <code>let</code> binding:</p>\n\n<pre><code>fn main() {\n    let bar = &amp;Bar::empty();\n    let foo = Foo::new(bar);\n    println!(\"{}\", foo.bar.value);\n}\n</code></pre>\n\n<p>However, suddenly I need two lines for something as trivial as instantiating my <code>Foo</code>. Is there any simple way to fix this in a one-liner?</p>\n"}, {"tags": ["unicode", "rust"], "comments": [{"owner": {"reputation": 100407, "user_id": 16406, "user_type": "registered", "accept_rate": 77, "profile_image": "https://www.gravatar.com/avatar/fadf252892475e9b177d5cd5e8b24145?s=128&d=identicon&r=PG&f=1", "display_name": "Chris Dodd", "link": "https://stackoverflow.com/users/16406/chris-dodd"}, "edited": false, "score": 5, "creation_date": 1547869953, "post_id": 54263873, "comment_id": 95351815, "body": "One would assume it means a code-point that is not a <a href=\"https://en.wikipedia.org/wiki/Universal_Character_Set_characters#Surrogates\" rel=\"nofollow noreferrer\">surrogate</a>"}, {"owner": {"reputation": 269348, "user_id": 5987, "user_type": "registered", "accept_rate": 55, "profile_image": "https://www.gravatar.com/avatar/2a1f9f4986b58015691eb2014e78869f?s=128&d=identicon&r=PG", "display_name": "Mark Ransom", "link": "https://stackoverflow.com/users/5987/mark-ransom"}, "edited": false, "score": 3, "creation_date": 1547870544, "post_id": 54263873, "comment_id": 95351879, "body": "You should <i>never</i> encounter a surrogate code point in UTF-8, it&#39;s for UTF-16 only."}, {"owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "edited": false, "score": 2, "creation_date": 1547870636, "post_id": 54263873, "comment_id": 95351887, "body": "What page is this quote coming from? If this is talking about a raw <code>char</code> pointer, then it seems like your mention of UTF8 might just be confusing things?"}, {"owner": {"reputation": 1528, "user_id": 1516794, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/0aa31034e2c59f34d63141791746ec35?s=128&d=identicon&r=PG", "display_name": "cmal", "link": "https://stackoverflow.com/users/1516794/cmal"}, "edited": false, "score": 0, "creation_date": 1547878460, "post_id": 54263873, "comment_id": 95353012, "body": "page 535 and 541 of the book &quot;Programming Rust&quot;"}, {"owner": {"reputation": 51497, "user_id": 49246, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/c421b43470bb8d3c099c5a847e588549?s=128&d=identicon&r=PG", "display_name": "starblue", "link": "https://stackoverflow.com/users/49246/starblue"}, "edited": false, "score": 1, "creation_date": 1547888704, "post_id": 54263873, "comment_id": 95354758, "body": "No, padding is not required. The problem with converting <code>&amp;[u8]</code> (bytes) to <code>&amp;str</code> (UTF-8 encoded Unicode characters) is that the bytes are arbitrary and might not be correct UTF-8. Among other things this forbids surrogates. And if you use a raw pointer into the string it should follow similar restrictions, I suppose."}], "answers": [{"tags": [], "owner": {"reputation": 11412, "user_id": 617159, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/fc43cf2d76ce0981a21c0e5a817f96f5?s=128&d=identicon&r=PG", "display_name": "Lambda Fairy", "link": "https://stackoverflow.com/users/617159/lambda-fairy"}, "is_accepted": true, "score": 11, "last_activity_date": 1547878885, "creation_date": 1547878885, "answer_id": 54264604, "question_id": 54263873, "link": "https://stackoverflow.com/questions/54263873/what-does-a-non-surrogate-unicode-code-point-mean-in-unicode/54264604#54264604", "title": "What does a &quot;non-surrogate Unicode code point&quot; mean in Unicode?", "body": "<p>In Unicode, the code points from U+D800 to U+DFFF are called <em>surrogates</em>. They are <a href=\"https://en.wikipedia.org/wiki/UTF-16#U+D800_to_U+DFFF\" rel=\"noreferrer\">reserved for use by UTF-16</a>, and you're not allowed to use them for anything else.</p>\n\n<p>The Rust <code>char</code> type represents an abstract code point, and is not tied to any particular encoding, so storing a UTF-16 surrogate in a <code>char</code> doesn't make sense.</p>\n"}], "owner": {"reputation": 1528, "user_id": 1516794, "user_type": "registered", "accept_rate": 72, "profile_image": "https://www.gravatar.com/avatar/0aa31034e2c59f34d63141791746ec35?s=128&d=identicon&r=PG", "display_name": "cmal", "link": "https://stackoverflow.com/users/1516794/cmal"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 240, "favorite_count": 0, "accepted_answer_id": 54264604, "answer_count": 1, "score": 2, "last_activity_date": 1547955076, "creation_date": 1547869260, "last_edit_date": 1547955076, "question_id": 54263873, "link": "https://stackoverflow.com/questions/54263873/what-does-a-non-surrogate-unicode-code-point-mean-in-unicode", "title": "What does a &quot;non-surrogate Unicode code point&quot; mean in Unicode?", "body": "<p>There is a rule which says \"dereferencing a raw pointer must yield a proper, non-surrogate Unicode code point\" in Rust.</p>\n\n<p>I do not understand what the \"non-surrogate\" means here. What I know is that UTF-8 has variable-length code points, so that a <code>Vec&lt;u8&gt;</code> cannot be converted to UTF-8 directly, and \"padding\" is needed.</p>\n"}, {"tags": ["rust", "stdout", "stdin"], "comments": [{"owner": {"reputation": 1540, "user_id": 2606171, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/F4ncy.png?s=128&g=1", "display_name": "belst", "link": "https://stackoverflow.com/users/2606171/belst"}, "edited": false, "score": 1, "creation_date": 1547857012, "post_id": 54262976, "comment_id": 95350100, "body": "have you tried flushing the output after the <code>print!</code> statement? Normally stdout gets flushed on newline. <code>stdout().flush();</code>"}, {"owner": {"reputation": 293, "user_id": 5228766, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/j3GWn.jpg?s=128&g=1", "display_name": "computer_geek64", "link": "https://stackoverflow.com/users/5228766/computer-geek64"}, "reply_to_user": {"reputation": 1540, "user_id": 2606171, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/F4ncy.png?s=128&g=1", "display_name": "belst", "link": "https://stackoverflow.com/users/2606171/belst"}, "edited": false, "score": 0, "creation_date": 1547857785, "post_id": 54262976, "comment_id": 95350226, "body": "I did not flush STDOUT. After reading further into the docs, I see now that you have to flush STDOUT manually when using the <code>print</code> macro, because it is not implicitly flushed until a newline character is encountered. Thanks a lot for the help, @belst! Feel free to post that as an answer, and I&#39;ll accept it as the best answer."}], "answers": [{"comments": [{"owner": {"reputation": 406, "user_id": 1644647, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qZyFl.jpg?s=128&g=1", "display_name": "jabgibson", "link": "https://stackoverflow.com/users/1644647/jabgibson"}, "edited": false, "score": 1, "creation_date": 1550778485, "post_id": 54263074, "comment_id": 96406576, "body": "I believe the Write trait also needs to be in scope for this to work. <code>use std::io::Write; </code> (referencing the flush() method)"}], "tags": [], "owner": {"reputation": 1540, "user_id": 2606171, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/F4ncy.png?s=128&g=1", "display_name": "belst", "link": "https://stackoverflow.com/users/2606171/belst"}, "is_accepted": true, "score": 13, "last_activity_date": 1550780887, "last_edit_date": 1550780887, "creation_date": 1547857973, "answer_id": 54263074, "question_id": 54262976, "link": "https://stackoverflow.com/questions/54262976/how-do-i-print-stdout-and-get-stdin-on-the-same-line-in-rust/54263074#54263074", "title": "How do I print STDOUT and get STDIN on the same line in Rust?", "body": "<p><code>stdout</code> gets flushed on newlines. Since your <code>print!</code> statement does not contain nor end in a newline it will not get flushed. You need to do it manually using <code>std::io::stdout().flush()</code></p>\n\n<p>For example</p>\n\n<pre><code>use std::io::{self, Write};\n\nfn main() {\n    let mut input = String::new();\n    print!(\"Enter a string &gt;&gt; \");\n    let _ = io::stdout().flush();\n    io::stdin().read_line(&amp;mut input).expect(\"Error reading from STDIN\");\n}\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": false, "score": 2, "last_activity_date": 1547873102, "creation_date": 1547873102, "answer_id": 54264143, "question_id": 54262976, "link": "https://stackoverflow.com/questions/54262976/how-do-i-print-stdout-and-get-stdin-on-the-same-line-in-rust/54264143#54264143", "title": "How do I print STDOUT and get STDIN on the same line in Rust?", "body": "<blockquote>\n  <p>you should be able to write output and get input on the same line.</p>\n</blockquote>\n\n<p>There is no concept of \"same line\" in <code>stdin</code> and <code>stdout</code>. There are just different stream, if you want to perform terminal manipulation you should use something that handle terminal, like <a href=\"https://docs.rs/console/0.7.5/console/\" rel=\"nofollow noreferrer\">console</a>.</p>\n\n<blockquote>\n  <p>In Python (3.x), this can be accomplished with a single line, because the input function allows for a string argument that precedes the STDIN prompt: <code>variable = input(\"Output string\")</code></p>\n</blockquote>\n\n<p>Well, here you go:</p>\n\n<pre><code>use dialoguer::Input;\n\nlet name = Input::new().with_prompt(\"Your name\").interact()?;\nprintln!(\"Name: {}\", name);\n</code></pre>\n\n<ul>\n<li><a href=\"https://docs.rs/dialoguer/0.3.0/dialoguer/struct.Input.html#example-usage\" rel=\"nofollow noreferrer\">https://docs.rs/dialoguer/0.3.0/dialoguer/struct.Input.html#example-usage</a></li>\n</ul>\n"}], "owner": {"reputation": 293, "user_id": 5228766, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/j3GWn.jpg?s=128&g=1", "display_name": "computer_geek64", "link": "https://stackoverflow.com/users/5228766/computer-geek64"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3199, "favorite_count": 2, "closed_date": 1588726861, "accepted_answer_id": 54263074, "answer_count": 2, "score": 6, "last_activity_date": 1550780887, "creation_date": 1547856861, "last_edit_date": 1547955742, "question_id": 54262976, "link": "https://stackoverflow.com/questions/54262976/how-do-i-print-stdout-and-get-stdin-on-the-same-line-in-rust", "closed_reason": "Duplicate", "title": "How do I print STDOUT and get STDIN on the same line in Rust?", "body": "<p>The macros <code>println!()</code> and <code>print!()</code> allow you to print strings and variables with and without a trailing newline, respectively. Additionally, the <code>stdin()</code> function provides a function to read a line of user input from STDIN (<code>stdin().read_line(&amp;mut string)</code>).</p>\n\n<p>It should be safe to assume that if the <code>print</code> macro and the <code>read_line</code> function were used consecutively, you should be able to write output and get input on the same line. However, the segments are executed in reverse order when this happens (STDIN is read first, then the statement is printed).</p>\n\n<p>Here is an example of what I am trying to accomplish:</p>\n\n<pre><code>use std::io;\n\nfn main() {\n    let mut input = String::new();\n    print!(\"Enter a string &gt;&gt; \");\n    io::stdin().read_line(&amp;mut input).expect(\"Error reading from STDIN\");\n}\n</code></pre>\n\n<p>The desired output would be (<code>STDIN</code> represents the point where the user is asked for input, it is not actually printed):</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Enter a string &gt;&gt; STDIN\n</code></pre>\n\n<p>The actual output is:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>STDIN\nEnter a string &gt;&gt; \n</code></pre>\n\n<p>On the other hand, the <code>println</code> macro does not reverse the order, although there is still the issue of the trailing newline:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>Enter a string &gt;&gt; \nSTDIN\n</code></pre>\n\n<p>In Python (3.x), this can be accomplished with a single line, because the <code>input</code> function allows for a string argument that precedes the STDIN prompt: <code>variable = input(\"Output string\")</code></p>\n\n<p>I separated the task into the <code>print</code> macro and the <code>read_line</code> function after failing to find a solution in the Rust documentation that would allow something similar to the Python example.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 7873, "user_id": 2225104, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/195de66794c596e35bc145c80e9f5515?s=128&d=identicon&r=PG", "display_name": "BitTickler", "link": "https://stackoverflow.com/users/2225104/bittickler"}, "edited": false, "score": 0, "creation_date": 1547842330, "post_id": 54260772, "comment_id": 95345756, "body": "There are 2 different schools of thought competing. One does not see a problem with having module hierarchy to be locked in on file system hierarchy, and they even think it is a good idea. The other school of thought hates that to the bone. Java (and rust) follow the former school. So in your case, you have to build a crate from the code you want to reuse from within multiple other crates."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547846465, "post_id": 54260772, "comment_id": 95347320, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/26224947/rust-basic-imports-includes\">Rust basic imports (includes)</a>"}, {"owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "reply_to_user": {"reputation": 7873, "user_id": 2225104, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/195de66794c596e35bc145c80e9f5515?s=128&d=identicon&r=PG", "display_name": "BitTickler", "link": "https://stackoverflow.com/users/2225104/bittickler"}, "edited": false, "score": 0, "creation_date": 1547846526, "post_id": 54260772, "comment_id": 95347346, "body": "@BitTickler Java&#39;s packages and Rust&#39;s modules are very different. Unless you compare them to something even more different (like Python&#39;s modules or bash&#39;s sourced files), Java&#39;s packages and Rust&#39;s modules seem more like exact opposites. Java&#39;s packages are one-package-per-directory, packages don&#39;t nest, every file belongs to exactly one package etc. In Rust, modules nest and you can have multiple modules per file, so I don&#39;t see why they should belong to the same &quot;school of thought&quot;?"}, {"owner": {"reputation": 7873, "user_id": 2225104, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/195de66794c596e35bc145c80e9f5515?s=128&d=identicon&r=PG", "display_name": "BitTickler", "link": "https://stackoverflow.com/users/2225104/bittickler"}, "reply_to_user": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "edited": false, "score": 0, "creation_date": 1547848018, "post_id": 54260772, "comment_id": 95347847, "body": "@AndreyTyukin They are, in the sense that file location matters. You might guess - and rightfully so, that I am not really a fan of that."}], "answers": [{"tags": [], "owner": {"reputation": 38158, "user_id": 2707792, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/hjDjB.png?s=128&g=1", "display_name": "Andrey Tyukin", "link": "https://stackoverflow.com/users/2707792/andrey-tyukin"}, "is_accepted": false, "score": 4, "last_activity_date": 1549806234, "last_edit_date": 1549806234, "creation_date": 1547846016, "answer_id": 54261498, "question_id": 54260772, "link": "https://stackoverflow.com/questions/54260772/how-to-use-functions-from-one-file-among-multiple-files/54261498#54261498", "title": "How to use functions from one file among multiple files?", "body": "<p>You need <code>mod zzz;</code> only once in the <code>main.rs</code>.</p>\n\n<p>In <code>aaa.rs</code> and <code>bbb.rs</code> you need a <code>use crate::zzz;</code>, not a <code>mod zzz;</code>. </p>\n\n<p>An example:</p>\n\n<p>File <code>src/aaa.rs</code>:</p>\n\n<pre><code>use crate::zzz; // `crate::` is required since 2018 edition\n\npub fn do_something() {\n    zzz::do_stuff();\n}\n</code></pre>\n\n<p>File <code>src/bbb.rs</code>:</p>\n\n<pre><code>use crate::zzz;\n\npub fn do_something_else() {\n    zzz::do_stuff();\n}\n</code></pre>\n\n<p>File <code>src/main.rs</code>:</p>\n\n<pre><code>// src/main.rs\nmod aaa;\nmod bbb;\nmod zzz;\n\nfn main() {\n    aaa::do_something();\n    bbb::do_something_else();\n}\n</code></pre>\n\n<p>File <code>src/zzz.rs</code>:</p>\n\n<pre><code>pub fn do_stuff() {\n    println!(\"does stuff zzz\");\n}\n</code></pre>\n\n<hr>\n\n<p>You would need a <code>mod zzz;</code> inside of <code>aaa</code> module only if you had a directory called <code>aaa</code> and inside of it a files <code>mod.rs</code> and <code>zzz.rs</code>. Then you would have to put <code>mod zzz;</code> in <code>mod.rs</code> to make the submodule <code>aaa::zzz</code> visible to the rest of your program.</p>\n"}], "owner": {"reputation": 11, "user_id": 10935224, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/2uln0.jpg?s=128&g=1", "display_name": "A. S. Underwood", "link": "https://stackoverflow.com/users/10935224/a-s-underwood"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 462, "favorite_count": 0, "answer_count": 1, "score": 1, "last_activity_date": 1549806234, "creation_date": 1547842082, "last_edit_date": 1547956959, "question_id": 54260772, "link": "https://stackoverflow.com/questions/54260772/how-to-use-functions-from-one-file-among-multiple-files", "title": "How to use functions from one file among multiple files?", "body": "<p>I'm trying to use the functions from one file with multiple other files.</p>\n\n<p>When I try adding 'mod somefile' to the files, the Rust compiler wants them to be nested in a subfolder, which isn't how I want to structure the project, as it would mean duplicating the file each time.</p>\n\n<pre><code>// src/main.rs\nmod aaa;\nmod bbb;\n\nfn main() {\n    aaa::do_something();\n    bbb::do_something_else();\n}\n</code></pre>\n\n<pre><code>// src/aaa.rs\nmod zzz; // rust compiler wants the file to be nested in a subfolder as aaa/zzz.rs\n\npub fn do_something() {\n    zzz::do_stuff();\n}\n</code></pre>\n\n<pre><code>// src/bbb.rs\nmod zzz; // again, compiler wants the file nested in a subfolder as bbb/zzz.rs\n\npub fn do_something_else() {\n    zzz::do_stuff();\n}\n</code></pre>\n\n<pre><code>// src/zzz.rs\n\npub fn do_stuff() {\n    // does stuff here\n}\n</code></pre>\n\n<p>I would like to be able to leave <code>src/zzz.rs</code> in the root <code>src</code> folder and use its functions among any of the other files in the project, instead of having to duplicate it in subfolders for each file (ex: <code>src/aaa/zzz.rs</code>, <code>src/bbb/zzz.rs</code>).</p>\n"}, {"tags": ["regex", "hashmap", "rust", "regex-group"], "answers": [{"comments": [{"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "edited": false, "score": 2, "creation_date": 1547840651, "post_id": 54259908, "comment_id": 95345076, "body": "This panics if a a named group is missing. It can be fixed by using <code>filter_map(|n| Some((n, captures.name(n)?.as_str())))</code> instead of the <code>map</code>."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "edited": false, "score": 2, "creation_date": 1547841174, "post_id": 54259908, "comment_id": 95345278, "body": "@Anders: Oh, you are right. I&#39;ll fix it as you suggested. Although a more idiomatic solution would be to create a <code>HasMap&lt;&amp;str, Option&lt;&amp;str&gt;&gt;</code> by using instead <code>map(|n| (n, caps.name(n).map(|m| m.as_str())))</code>"}, {"owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "edited": false, "score": 0, "creation_date": 1547841285, "post_id": 54259908, "comment_id": 95345338, "body": "Good suggestion with the option."}], "tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 4, "last_activity_date": 1547952999, "last_edit_date": 1547952999, "creation_date": 1547837632, "answer_id": 54259908, "question_id": 54259474, "link": "https://stackoverflow.com/questions/54259474/convert-regex-captures-into-hashmap-in-rust/54259908#54259908", "title": "Convert regex Captures into HashMap in Rust?", "body": "<p>It is tricky because the regex can have multiple matches, and each capture can be matched multiple times in a single global match.</p>\n\n<p>Maybe something like this <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=e23ca5e53320ba02007c86f0bb3585b7\" rel=\"nofollow noreferrer\">(playground)</a>:</p>\n\n<pre><code>fn main() {\n    let re = Regex::new(r\"(?P&lt;y&gt;\\d{4})-(?P&lt;m&gt;\\d{2})-(?P&lt;d&gt;\\d{2})\").unwrap();\n    let text = \"2012-03-14\";\n    let caps = re.captures(text).unwrap();\n    let dict: HashMap&lt;&amp;str, &amp;str&gt; = re\n        .capture_names()\n        .flatten()\n        .filter_map(|n| Some((n, caps.name(n)?.as_str())))\n        .collect();\n    println!(\"{:#?}\", dict);\n}\n</code></pre>\n\n<p>That outputs:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>{\n    \"y\": \"2012\",\n    \"d\": \"14\",\n    \"m\": \"03\"\n}\n</code></pre>\n\n<p>The code is simple once you realize that the capture names are not available from the <code>Match</code> itself, but from the parent <code>Regex</code>. You have to do the following:</p>\n\n<ol>\n<li>Call <code>capture_names()</code>, that will be an iterable of <code>Option&lt;&amp;str&gt;</code>.</li>\n<li><code>flatten()</code> the iterable, that will remove the <code>None</code> and <em>unwrap</em> the <code>&amp;str</code> values.</li>\n<li><code>filter_map()</code> the capture names into a list of tuples <em>(name, value)</em> of type <code>(&amp;str, &amp;str)</code>. The <code>filter</code> is needed to remove captures that are not present (thanks to @Anders).</li>\n<li><code>collect()</code>! This just works because <code>HashMap&lt;K, V&gt;</code> implements the trait  <code>FromIterator&lt;(K, V)&gt;</code>, so an iterator of <code>(&amp;str, &amp;str)</code> collects into a <code>HasMap&lt;&amp;str, &amp;str&gt;</code>.</li>\n</ol>\n"}, {"tags": [], "owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "is_accepted": false, "score": 2, "last_activity_date": 1547953017, "last_edit_date": 1547953017, "creation_date": 1547840660, "answer_id": 54260496, "question_id": 54259474, "link": "https://stackoverflow.com/questions/54259474/convert-regex-captures-into-hashmap-in-rust/54260496#54260496", "title": "Convert regex Captures into HashMap in Rust?", "body": "<p>If you have multiple captures, you can collect them into a list like this:</p>\n\n<pre><code>let all: Vec&lt;HashMap&lt;&amp;str, &amp;str&gt;&gt; = re\n    .captures_iter(\"2012-01-12 , 2013-07-11 , 2014-09-14\")\n    .map(|caps| {\n        re.capture_names()\n            .map(|o| o.and_then(|n| Some((n, caps.name(n)?.as_str()))))\n            .flatten()\n            .collect()\n    })\n    .collect();\n\nprintln!(\"{:#?}\", all);\n</code></pre>\n"}], "owner": {"reputation": 7411, "user_id": 2200659, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/ImYIK.jpg?s=128&g=1", "display_name": "Anders", "link": "https://stackoverflow.com/users/2200659/anders"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1274, "favorite_count": 0, "accepted_answer_id": 54259908, "answer_count": 2, "score": 3, "last_activity_date": 1547953017, "creation_date": 1547835368, "question_id": 54259474, "link": "https://stackoverflow.com/questions/54259474/convert-regex-captures-into-hashmap-in-rust", "title": "Convert regex Captures into HashMap in Rust?", "body": "<p>I have a <code>Regex</code> with an unknown number of named groups with unknown names. I want to match a string to that regex, and get a <code>HashMap&lt;&amp;str, &amp;str&gt;</code> with the name of the groups as key and the captured strings as value.</p>\n\n<p>How can I do this? Will I have to use <code>regex.captures(str).iter()</code> and then somehow map and filter and collect into a map? Or is there some shortcut?</p>\n"}, {"tags": ["csv", "struct", "rust", "iterator"], "answers": [{"comments": [{"owner": {"reputation": 3227, "user_id": 4978464, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/d2540c98b6e3f47ffc9e31b6c1e09f60?s=128&d=identicon&r=PG&f=1", "display_name": "gfgm", "link": "https://stackoverflow.com/users/4978464/gfgm"}, "edited": false, "score": 0, "creation_date": 1547841609, "post_id": 54260282, "comment_id": 95345492, "body": "This is an incredibly clear explanation thank you. Could I ask you to explain what this <code>collect::&lt;Result&lt;Vec&lt;Record&gt;, _&gt;&gt;()?</code> is doing? is it saying to return a Vec of Record&#39;s or else nothing?"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 3227, "user_id": 4978464, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/d2540c98b6e3f47ffc9e31b6c1e09f60?s=128&d=identicon&r=PG&f=1", "display_name": "gfgm", "link": "https://stackoverflow.com/users/4978464/gfgm"}, "edited": false, "score": 0, "creation_date": 1547842296, "post_id": 54260282, "comment_id": 95345741, "body": "@gfgm: Ah, that is the tricky one! Serde&#39;s CSV <code>deserialize()</code> returns an iterable of <code>Result&lt;Record, _&gt;</code> with the parse result of each line. But I&#39;d like to get a <code>Result&lt;impl Iterable&lt;Record&gt;, _&gt;</code> to apply the <code>?</code> easily to the whole file. How to do it? It happens that <code>Result&lt;V, E&gt;</code> implements <code>FromIterator&lt;Result&lt;A,E&gt;&gt;</code> (if <code>V</code> implements <code>FromIterator&lt;A&gt;</code>), that means that I can <code>collect()</code> the iterator of results into a result of a vector! Then just apply the <code>?</code> operator and you have a <code>Vec&lt;Record&gt;</code>. The only drawback is that you have to specify the type to <code>collect()</code>."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 3227, "user_id": 4978464, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/d2540c98b6e3f47ffc9e31b6c1e09f60?s=128&d=identicon&r=PG&f=1", "display_name": "gfgm", "link": "https://stackoverflow.com/users/4978464/gfgm"}, "edited": false, "score": 0, "creation_date": 1547842377, "post_id": 54260282, "comment_id": 95345780, "body": "The end result is that if any line of the file yields a parse error, the whole file is considered an error and the <code>?</code> ends the function with an <code>Err</code>."}], "tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 2, "last_activity_date": 1547841586, "last_edit_date": 1547841586, "creation_date": 1547839531, "answer_id": 54260282, "question_id": 54259336, "link": "https://stackoverflow.com/questions/54259336/ownership-and-lifetime-in-nested-iterators-in-rust-for-string-comparison/54260282#54260282", "title": "Ownership and lifetime in nested iterators in rust for string comparison", "body": "<p>The problem with the code, as is, is not actually very Rust-related, but that you are consuming the readers when you read from them. Your code basically does (in pseudo-code):</p>\n\n<pre><code>file1 = open(\"file1\");\nfile2 = open(\"file2\");\nfor line1 in read_lines(file1):\n    for line2 in read_lines(file2):\n        compare(line1, line2)\n</code></pre>\n\n<p>The <code>file1</code> is all right, so is the <code>file2</code> the first time it is read. But in the second iteration of the outer loop <code>file2</code> is at the end-of-file, so no more lines will be read from it and the loop ends.</p>\n\n<p>The easier solution is to read <code>file2</code> each time:</p>\n\n<pre><code>file1 = open(\"file1\");\nfor line1 in read_lines(file1):\n    file2 = open(\"file2\");\n    for line2 in read_lines(file2):\n        compare(line1, line2)\n</code></pre>\n\n<p>It is not very efficient because you are reading the same file over and over again. </p>\n\n<p>If you want to read it only once, you can collect all the <code>Records</code> from <code>file2</code> into a <code>Vec</code> and then iterate the <code>Vec</code> as many times as needed:</p>\n\n<pre><code>let mut rdr = csv::Reader::from_reader(data1.as_bytes());\nlet mut rdr2 = csv::Reader::from_reader(data2.as_bytes());\nlet lines2 = rdr2.deserialize().collect::&lt;Result&lt;Vec&lt;Record&gt;, _&gt;&gt;()?;\n\nfor result in rdr.deserialize() {\n    let record: Record = result?;\n    for record2 in &amp;lines2 {\n        let comp = Compare{\n            dfa: &amp;record,\n            dfb: record2,\n        };\n        println!(\"{:?} compared to {:?}: {:?}\", comp.dfa.mp, \n             comp.dfb.mp, comp.jwdist());\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 3227, "user_id": 4978464, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/d2540c98b6e3f47ffc9e31b6c1e09f60?s=128&d=identicon&r=PG&f=1", "display_name": "gfgm", "link": "https://stackoverflow.com/users/4978464/gfgm"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 230, "favorite_count": 0, "accepted_answer_id": 54260282, "answer_count": 1, "score": 0, "last_activity_date": 1547841586, "creation_date": 1547834699, "last_edit_date": 1547837149, "question_id": 54259336, "link": "https://stackoverflow.com/questions/54259336/ownership-and-lifetime-in-nested-iterators-in-rust-for-string-comparison", "title": "Ownership and lifetime in nested iterators in rust for string comparison", "body": "<p>I am dipping my toes into Rust and can't seem to figure out how to compare rows of two csv files. I suspect my difficulty arises from trying to tackle the problem in entirely the wrong way, and so I am throwing myself onto the mercies of stackoverflow.</p>\n\n<p>I am writing a simple program that reads two csv files of known fields, and then compares the edit distance of each element of column j in csv1 to each element of column j in csv2 for all columns j in J. At the moment, my code only succeeds in comparing the first row of csv1 to all the rows of csv2.</p>\n\n<p>My pattern is to: </p>\n\n<ol>\n<li>read the csvs into a <code>struct Reader</code> using the csv and serde crates (all good). </li>\n<li>Create a <code>struct Compare</code> that holds two rows of type Reader, one from each csv.</li>\n<li>Write a method for Compare that returns the string distances.</li>\n</ol>\n\n<p>I have the core snippets of code below, and the whole thing can be accessed in the rust playground <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=28ab27412f20dcc376e95cf615b5125d\" rel=\"nofollow noreferrer\">here</a>.</p>\n\n<p>The <code>struct Record</code> will hold a row,</p>\n\n<pre><code>#[derive(Debug,Deserialize)]\nstruct Record {\n    mp: String,\n    party: String,\n    constit: String,\n    position: String,\n    group: String,\n}\n</code></pre>\n\n<p>and the <code>struct Compare</code> holds two rows together. I am having it borrow the value because I kept getting a copy error -- but arguably this is where my problems begin!</p>\n\n<pre><code>#[derive(Debug)]\nstruct Compare&lt;'a&gt; {\n    dfa: &amp;'a Record,\n    dfb: &amp;'a Record,\n}\n</code></pre>\n\n<p>Here I implement a method for Compare that computes the Jaro-Winkler distance for each element of the two rows and returns another struct type defined elsewhere (see the link to rust playground above for the full file):</p>\n\n<pre><code>impl &lt;'a&gt; Compare&lt;'a&gt; {\n    fn jwdist(&amp;self) -&gt; Stringcomps {\n        let res = Stringcomps {\n            mp: strsim::jaro_winkler(&amp;self.dfa.mp, &amp;self.dfb.mp),\n            party: strsim::jaro_winkler(&amp;self.dfa.party, &amp;self.dfb.party),\n            constit: strsim::jaro_winkler(&amp;self.dfa.constit, &amp;self.dfb.constit),\n            position: strsim::jaro_winkler(&amp;self.dfa.position, &amp;self.dfb.position),\n            group: strsim::jaro_winkler(&amp;self.dfa.group, &amp;self.dfb.group),\n        };\n        res\n    }    \n}\n</code></pre>\n\n<p>The following bit of code runs the function (with some toy data). It produces the incorrect output as it only compares the first row of the first csv file to all the rows of the other csv file:</p>\n\n<pre><code>fn run() -&gt; Result&lt;(), Box&lt;Error&gt;&gt; {\n    // get first df\n    let data1 = \"mp,party,constit,position,group\\n\ngeorge,con,bath,whip,no\\n\nbob,lab,oxford,backbench,yes\";\n    let data2 = \"mp,party,constit,position,group\\n\ngoerge,can,both,wihp,no\\n\nbob,lob,ofxord,backbenth,yes\";\n    let mut rdr = csv::Reader::from_reader(data1.as_bytes());\n    // get second df\n    let mut rdr2 = csv::Reader::from_reader(data2.as_bytes());\n    // iterate through both and compare\n    for result in rdr.deserialize() {\n        let record: Record = result?;\n        for result2 in rdr2.deserialize() {\n            let record2: Record = result2?;\n            let comp = Compare{\n                dfa: &amp;record,\n                dfb: &amp;record2,\n            };\n            println!(\"{:?} compared to {:?}: {:?}\", comp.dfa.mp, \n            comp.dfb.mp, comp.jwdist());\n        }\n    }\n    Ok(())\n}\n\nfn main() {\n    if let Err(err) = run() {\n        println!(\"error running example: {}\", err);\n        process::exit(1);\n    }\n}\n</code></pre>\n\n<p>I've tried to fix my problems by initializing the object <code>comp</code> before the second for loop but I cannot seem to get it to work. Initialization requires a default method, which I tried to write for Record. I think I got it working but then ran into trouble because the lifetime of the object I was assigning inside the second for loop was too short and would not survive long enough to be printed. This made me pretty convinced that I'm probably tackling the problem wrong.</p>\n\n<p>Apologies in advance: this is a pedagogical project so I am here to get schooled.</p>\n"}, {"tags": ["rust", "traits", "associated-types"], "answers": [{"comments": [{"owner": {"reputation": 14772, "user_id": 74261, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/Z5AQr.jpg?s=128&g=1", "display_name": "nothrow", "link": "https://stackoverflow.com/users/74261/nothrow"}, "edited": false, "score": 1, "creation_date": 1547830810, "post_id": 54258372, "comment_id": 95340876, "body": "Thanks! How is the <code>&lt;T as Iterator&gt;::Item</code> part called? I was not able to google it, since I was probably missing the correct terminology."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 14772, "user_id": 74261, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/Z5AQr.jpg?s=128&g=1", "display_name": "nothrow", "link": "https://stackoverflow.com/users/74261/nothrow"}, "edited": false, "score": 0, "creation_date": 1547830997, "post_id": 54258372, "comment_id": 95340971, "body": "That part doesn&#39;t have a name by itself (I don&#39;t think), but <code>T::Item: ToString</code> is called a <i>bound</i>, or a <i>trait bound</i>. You might also see it called a <i>constraint</i>."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 10, "last_activity_date": 1547831159, "last_edit_date": 1547831159, "creation_date": 1547830597, "answer_id": 54258372, "question_id": 54258253, "link": "https://stackoverflow.com/questions/54258253/how-do-i-define-trait-bounds-on-an-associated-type/54258372#54258372", "title": "How do I define trait bounds on an associated type?", "body": "<p>Yes, you can do that with a <code>where</code> clause:</p>\n\n<pre><code>fn parse&lt;T: Iterator&gt;(mut args: T) -&gt; Result&lt;String, String&gt;\nwhere \n    &lt;T as Iterator&gt;::Item: ToString,\n{\n   // ....\n}\n</code></pre>\n\n<p>Or, since it's unambiguous which <code>Item</code> is meant here, the bound can just be:</p>\n\n<pre><code>where T::Item: ToString\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "is_accepted": false, "score": 7, "last_activity_date": 1547952885, "last_edit_date": 1547952885, "creation_date": 1547839020, "answer_id": 54260201, "question_id": 54258253, "link": "https://stackoverflow.com/questions/54258253/how-do-i-define-trait-bounds-on-an-associated-type/54260201#54260201", "title": "How do I define trait bounds on an associated type?", "body": "<p>You can  use the <a href=\"https://doc.rust-lang.org/1.30.0/book/first-edition/associated-types.html#trait-objects-with-associated-types\" rel=\"noreferrer\"><code>Item =</code> syntax</a>: </p>\n\n<pre><code>fn parse&lt;I: ToString, T: Iterator&lt;Item = I&gt;&gt;(mut args: T) -&gt; Result&lt;String, String&gt;\n</code></pre>\n\n<p>That allows you to simplify this further with the <code>impl</code> syntax:</p>\n\n<pre><code>fn parse&lt;T: Iterator&lt;Item = impl ToString&gt;&gt;(mut args: T) -&gt; Result&lt;String, String&gt;\n</code></pre>\n\n<p>and finally:</p>\n\n<pre><code>fn parse(mut args: impl Iterator&lt;Item = impl ToString&gt;) -&gt; Result&lt;String, String&gt;\n</code></pre>\n\n<p>I would consider this a more readable alternative.</p>\n"}], "owner": {"reputation": 14772, "user_id": 74261, "user_type": "registered", "accept_rate": 85, "profile_image": "https://i.stack.imgur.com/Z5AQr.jpg?s=128&g=1", "display_name": "nothrow", "link": "https://stackoverflow.com/users/74261/nothrow"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3943, "favorite_count": 2, "accepted_answer_id": 54258372, "answer_count": 2, "score": 8, "last_activity_date": 1547952885, "creation_date": 1547830097, "last_edit_date": 1547952657, "question_id": 54258253, "link": "https://stackoverflow.com/questions/54258253/how-do-i-define-trait-bounds-on-an-associated-type", "title": "How do I define trait bounds on an associated type?", "body": "<p>I want to write a function that accepts <code>Iterator</code> of type that has <code>ToString</code> trait.</p>\n\n<p>What I have in mind:</p>\n\n<pre><code>fn parse&lt;T: Iterator /* ?T::Item : ToString? */&gt;(mut args: T) -&gt; Result&lt;String, String&gt; {\n    match args.next() {\n        Some(x) =&gt; x.to_string(),\n        None =&gt; String::from(\"Missing parameter\"),\n    }\n}\n</code></pre>\n"}, {"tags": ["linux", "rust", "pthreads"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1547832063, "post_id": 54257241, "comment_id": 95341475, "body": "It&#39;s pretty hard to answer this without seeing some code. For starters, how are you spawning threads in Rust? Or is the Rust code single-threaded but the C library is multi-threaded?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1547832190, "post_id": 54257241, "comment_id": 95341537, "body": "If the C library is depending on thread-local storage and expects to be called in its own pthread then that could certainly cause a problem. I&#39;m not sure of the quality, but I found this: <a href=\"https://github.com/mahkoh/posix.rs\" rel=\"nofollow noreferrer\">github.com/mahkoh/posix.rs</a> which might help."}, {"owner": {"reputation": 401, "user_id": 3663205, "user_type": "registered", "accept_rate": 47, "profile_image": "https://www.gravatar.com/avatar/07e4409ee008a11074f8a16bbe2806ed?s=128&d=identicon&r=PG&f=1", "display_name": "Joshua Gevirtz", "link": "https://stackoverflow.com/users/3663205/joshua-gevirtz"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1547834347, "post_id": 54257241, "comment_id": 95342485, "body": "@PeterHall I&#39;ll grant you that, but it would be hard for me to show code because there are so many relevant layers.  The Rust code is multi-threaded and the C code is aware that it might be called in a multi-threaded context so therefore uses thread-local storage for certain structures via pthreads_getspecefic and pthreads_setspecific."}, {"owner": {"reputation": 401, "user_id": 3663205, "user_type": "registered", "accept_rate": 47, "profile_image": "https://www.gravatar.com/avatar/07e4409ee008a11074f8a16bbe2806ed?s=128&d=identicon&r=PG&f=1", "display_name": "Joshua Gevirtz", "link": "https://stackoverflow.com/users/3663205/joshua-gevirtz"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1547834476, "post_id": 54257241, "comment_id": 95342534, "body": "@PeterHall based on some poking around, it looks like Rust std::thread relies on pthreads.  If that is in fact the case, <i>should</i> Rust be able to call to arbitrary C code that uses pthreads_[set, get]specific and expect the correct result?"}], "owner": {"reputation": 401, "user_id": 3663205, "user_type": "registered", "accept_rate": 47, "profile_image": "https://www.gravatar.com/avatar/07e4409ee008a11074f8a16bbe2806ed?s=128&d=identicon&r=PG&f=1", "display_name": "Joshua Gevirtz", "link": "https://stackoverflow.com/users/3663205/joshua-gevirtz"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 428, "favorite_count": 0, "answer_count": 0, "score": 1, "last_activity_date": 1547954909, "creation_date": 1547826334, "last_edit_date": 1547954909, "question_id": 54257241, "link": "https://stackoverflow.com/questions/54257241/is-it-possible-that-the-way-rust-creates-threads-doesnt-play-nicely-with-the-c", "title": "Is it possible that the way Rust creates threads doesn&#39;t play nicely with the C library&#39;s dependence on pthreads?", "body": "<p>I am trying to use a C library in Rust by creating bindings automatically with bindgen.  Using these bindings, I write a Rust API so that Rust developers can use the C library with a nice Rust API.  Everything works great until threads are involved, at which points I experience race conditions and deadlocks.</p>\n\n<p>The C library was written with thread-safety in mind and relies heavily on <code>pthread_setspecific</code> and <code>pthread_getspecific</code> for thread-local storage.  I think it is possible the race conditions and deadlocks are caused by the code related to the thread-local machinations of the C library.</p>\n\n<p>Is it possible that the way Rust is creating threads doesn't play nicely with the C library's dependence on pthreads and that this incompatibility is causing the issues I am seeing?  </p>\n\n<p>I don't know a lot about Linux threads, though I have spent some time reading up about it in connection to this problem.</p>\n"}, {"tags": ["rust", "clap"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1547810305, "post_id": 54252825, "comment_id": 95329783, "body": "Does it work if you say that your argument is a <code>Vec</code>?"}, {"owner": {"reputation": 96, "user_id": 3557349, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/43bb3869db50703cf1a588ce112101bb?s=128&d=identicon&r=PG&f=1", "display_name": "FrederikDS", "link": "https://stackoverflow.com/users/3557349/frederikds"}, "edited": false, "score": 0, "creation_date": 1547811229, "post_id": 54252825, "comment_id": 95330208, "body": "Take a look at <code>clap::Values</code> <a href=\"https://docs.rs/clap/2.32.0/clap/struct.Values.html\" rel=\"nofollow noreferrer\">here</a>, if you cannot assume that the values are encoded with UTF-8, use <code>clap::OsValues</code>."}, {"owner": {"reputation": 8363, "user_id": 1531806, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/FkpTG.jpg?s=128&g=1", "display_name": "Pascal Precht", "link": "https://stackoverflow.com/users/1531806/pascal-precht"}, "reply_to_user": {"reputation": 96, "user_id": 3557349, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/43bb3869db50703cf1a588ce112101bb?s=128&d=identicon&r=PG&f=1", "display_name": "FrederikDS", "link": "https://stackoverflow.com/users/3557349/frederikds"}, "edited": false, "score": 0, "creation_date": 1547812526, "post_id": 54252825, "comment_id": 95330894, "body": "@FrederikDS that however will end up with a different API: --opts &#39;one&#39; &#39;two&#39; &#39;tree&#39;.  I was looking for: --opts.one &#39;foo&#39; --opts.two &#39;bar&#39;  where &#39;one&#39; and &#39;two&#39; aren&#39;t known"}, {"owner": {"reputation": 36166, "user_id": 393701, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/250889c646cd2a916920d9252f7c6f42?s=128&d=identicon&r=PG", "display_name": "SirDarius", "link": "https://stackoverflow.com/users/393701/sirdarius"}, "edited": false, "score": 1, "creation_date": 1547818562, "post_id": 54252825, "comment_id": 95334085, "body": "As a user of CLI tools, I&#39;d be surprised by the <code>--programOpts.bar &#39;foo&#39;</code> syntax. I would rather expect something like <code>--programOpts &#39;bar=foo&#39;</code>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547955632, "post_id": 54252825, "comment_id": 95369371, "body": "See also <a href=\"https://stackoverflow.com/q/54191836/155423\">How can I pass all command line arguments through Clap to another program?</a>"}, {"owner": {"reputation": 8363, "user_id": 1531806, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/FkpTG.jpg?s=128&g=1", "display_name": "Pascal Precht", "link": "https://stackoverflow.com/users/1531806/pascal-precht"}, "reply_to_user": {"reputation": 36166, "user_id": 393701, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/250889c646cd2a916920d9252f7c6f42?s=128&d=identicon&r=PG", "display_name": "SirDarius", "link": "https://stackoverflow.com/users/393701/sirdarius"}, "edited": false, "score": 0, "creation_date": 1548275692, "post_id": 54252825, "comment_id": 95487836, "body": "@SirDarius it actually seems quite common to have option.property syntax in CLI commands..."}], "answers": [{"tags": [], "owner": {"reputation": 8363, "user_id": 1531806, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/FkpTG.jpg?s=128&g=1", "display_name": "Pascal Precht", "link": "https://stackoverflow.com/users/1531806/pascal-precht"}, "is_accepted": true, "score": 1, "last_activity_date": 1548275838, "creation_date": 1548275838, "answer_id": 54335252, "question_id": 54252825, "link": "https://stackoverflow.com/questions/54252825/is-it-possible-to-configure-argument-groups-of-unknown-size-with-clap/54335252#54335252", "title": "Is it possible to configure argument groups of unknown size with Clap?", "body": "<p>After further research I decided to go down a slightly different path and rather take advantage of the known UNIX <code>--</code> syntax.</p>\n\n<p>Meaning that all options and flags coming after <code>--</code> will be passed down to the underlying program:</p>\n\n<pre><code>$ cli --program [PROGRAM] -- foo bar --bazinga --yay=w00t\n</code></pre>\n\n<p>This can be done using Clap's <code>.raw()</code> configuration on Arg structs.</p>\n"}], "owner": {"reputation": 8363, "user_id": 1531806, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/FkpTG.jpg?s=128&g=1", "display_name": "Pascal Precht", "link": "https://stackoverflow.com/users/1531806/pascal-precht"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 91, "favorite_count": 0, "accepted_answer_id": 54335252, "answer_count": 1, "score": 1, "last_activity_date": 1548275838, "creation_date": 1547810103, "question_id": 54252825, "link": "https://stackoverflow.com/questions/54252825/is-it-possible-to-configure-argument-groups-of-unknown-size-with-clap", "title": "Is it possible to configure argument groups of unknown size with Clap?", "body": "<p>I'm building a CLI which can call other underlying programs, that have their own options and arguments. I'd like to be able to pass those options to a program through the CLI. </p>\n\n<pre><code>$ cli --program [PROGRAM] --programOpts[OPT1, OPT2, ...]\n</code></pre>\n\n<p>Example:</p>\n\n<pre><code>$ cli --program foo --programOpts.bar 'foo' --programOpts.foo 'bar'\n</code></pre>\n\n<p>^ In this case <code>bar</code> and <code>foo</code> in <code>programOpts</code> are unknown to <code>cli</code>. The CLI only knows about <code>programOpts</code> and that it's an unknown vector of options specific to the underlying program that's being called.</p>\n\n<p>I was hoping Clap had an API to implement such a thing (looked into <code>Arg</code> and <code>ArgGroup</code>) but it doesn't seem like it.</p>\n\n<p>Is there such an API?</p>\n"}, {"tags": ["rust", "rust-tokio", "hyper"], "answers": [{"comments": [{"owner": {"reputation": 23, "user_id": 10932562, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cfac709efbc5d9fac7b451e18c6798e1?s=128&d=identicon&r=PG&f=1", "display_name": "Jones", "link": "https://stackoverflow.com/users/10932562/jones"}, "edited": false, "score": 1, "creation_date": 1548056985, "post_id": 54267440, "comment_id": 95391961, "body": "Thank you for the short explanation. I should dig deeper into Tokio&#39;s documentation I guess."}], "tags": [], "owner": {"reputation": 1324, "user_id": 6800156, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/144bd2330b7c506ab60c6f9e68250fa0?s=128&d=identicon&r=PG&f=1", "display_name": "Artemiy Rodionov", "link": "https://stackoverflow.com/users/6800156/artemiy-rodionov"}, "is_accepted": true, "score": 1, "last_activity_date": 1547956292, "last_edit_date": 1547956292, "creation_date": 1547903344, "answer_id": 54267440, "question_id": 54252530, "link": "https://stackoverflow.com/questions/54252530/hyper-server-drops-connection-on-returning-asyncnotready-in-future/54267440#54267440", "title": "Hyper server drops connection on returning Async::NotReady in Future", "body": "<p>Hyper is built on top of the futures crate and uses its future model known as a \"readiness\" or \"pull\" where values are pulled out of futures on demand, and otherwise a task is <strong>notified</strong> when a value might be ready to get pulled out.</p>\n\n<p>When <code>poll</code> returns <code>NotReady</code>, the current task <strong>must</strong> register for a readiness change notification, otherwise the task may never be completed. Any function that returns <code>Async</code> must adhere to it.</p>\n\n<p>In other words, you should wait until <code>poll</code> can return <code>Ready</code> or notify the current task to indicate that it is ready to make progress and return <code>NotReady</code></p>\n\n<pre><code>// notify about progress\nfn poll(&amp;mut self) -&gt; Poll&lt;Self::Item, Self::Error&gt; {\n    println!(\"Poll future\");\n\n    if self.ready {\n        println!(\"Future ready\");\n\n        return Ok(Async::Ready(()));\n    }\n\n    println!(\"Future not ready\");\n    self.ready = true;\n\n    // The executor will poll this task next iteration\n    futures::task::current().notify();\n    Ok(Async::NotReady)\n}\n\n// wait until it is Ready\nfn poll(&amp;mut self) -&gt; Poll&lt;Self::Item, Self::Error&gt; {\n    loop {\n        println!(\"Poll future\");\n\n        if self.ready {\n            println!(\"Future ready\");\n            return Ok(Async::Ready(()));\n        }\n\n        println!(\"Future not ready\");\n        self.ready = true;\n    }\n}\n</code></pre>\n\n<p>Tokio's docs <a href=\"https://tokio.rs/docs/going-deeper/tasks/\" rel=\"nofollow noreferrer\">1</a> <a href=\"https://tokio.rs/docs/internals/runtime-model/\" rel=\"nofollow noreferrer\">2</a> might clarify it.</p>\n"}], "owner": {"reputation": 23, "user_id": 10932562, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cfac709efbc5d9fac7b451e18c6798e1?s=128&d=identicon&r=PG&f=1", "display_name": "Jones", "link": "https://stackoverflow.com/users/10932562/jones"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 267, "favorite_count": 1, "accepted_answer_id": 54267440, "answer_count": 1, "score": 2, "last_activity_date": 1547956367, "creation_date": 1547809024, "last_edit_date": 1547956367, "question_id": 54252530, "link": "https://stackoverflow.com/questions/54252530/hyper-server-drops-connection-on-returning-asyncnotready-in-future", "title": "Hyper server drops connection on returning Async::NotReady in Future", "body": "<p>I'm trying to run a hyper server with an asynchronous response on a request using a future. When the future's <code>poll</code> method is called and returns <code>Async::NotReady</code>, the connection is just dropped (\"dropping I/O source: 0\"). I expected that the <code>poll</code> method is called multiple times until it returns <code>Async::Ready</code>. </p>\n\n<p>The <a href=\"https://github.com/hyperium/hyper/blob/master/examples/send_file.rs\" rel=\"nofollow noreferrer\">example shown</a> returns an async io future which is doing (I guess) the same thing. </p>\n\n<p>Why is the future's <code>poll</code> function just called once and why does hyper drop the connection after the future returns <code>Async::NotReady</code>?</p>\n\n<p>Example Code: (hyper version is: v0.12.21)</p>\n\n<pre><code>use futures::{Async, Future, Poll};\nuse hyper::http::{Request, Response};\nuse hyper::service::service_fn;\nuse hyper::{Body, Server};\n\nfn main() {\n    let addr = ([127, 0, 0, 1], 3335).into();\n    println!(\"Start request handler. (Listening on http://{})\", addr);\n\n    hyper::rt::run(\n        Server::bind(&amp;addr)\n            .serve(|| service_fn(|request: Request&lt;Body&gt;| handle_request(request.uri().path())))\n            .map_err(|e| println!(\"server error: {}\", e)),\n    );\n}\n\ntype BoxedResponseFuture = Box&lt;Future&lt;Item = Response&lt;Body&gt;, Error = tokio::io::Error&gt; + Send&gt;;\n\nfn handle_request(path: &amp;str) -&gt; BoxedResponseFuture {\n    println!(\"Handle request {:?}\", path);\n    Box::new(\n        ResponseFuture { ready: false }\n            .and_then(|_| {\n                let response = Response::new(Body::from(\"Success\".to_string()));\n\n                Ok(response)\n            })\n            .or_else(|e| {\n                let response = Response::new(Body::from(format!(\"Error: {:?}\", e)));\n\n                Ok(response)\n            }),\n    )\n}\n\nstruct ResponseFuture {\n    ready: bool,\n}\n\nimpl Future for ResponseFuture {\n    type Item = ();\n    type Error = ();\n\n    fn poll(&amp;mut self) -&gt; Poll&lt;Self::Item, Self::Error&gt; {\n        println!(\"Poll future\");\n\n        if self.ready {\n            println!(\"Future ready\");\n\n            return Ok(Async::Ready(()));\n        }\n\n        println!(\"Future not ready\");\n        self.ready = true;\n        Ok(Async::NotReady)\n    }\n}\n</code></pre>\n"}, {"tags": ["memory-management", "data-structures", "rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547806781, "post_id": 54251695, "comment_id": 95327832, "body": "You want to it be a string, but why is the inner type of the <code>BTreeSet</code> a <code>Vec&lt;u8&gt;</code>, but not a <code>String</code>? What do you want it to be look like in the end? An example would be good"}, {"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 0, "creation_date": 1547806969, "post_id": 54251695, "comment_id": 95327948, "body": "Please provide <a href=\"https://stackoverflow.com/help/mcve\">MCVE</a>"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 1, "creation_date": 1547807580, "post_id": 54251695, "comment_id": 95328308, "body": "&quot;My problem is that the set can be very large, perhaps 10GB at most so I would like to limit memory usage.&quot;, so why construct it as a string ? that don&#39;t make sense, just print every element with a whitespace, don&#39;t construct it."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1547807692, "post_id": 54251695, "comment_id": 95328382, "body": "Aside the fact, that if you really have a 10GB data structure, you&#39;re most certainly doing something wrong."}, {"owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1547808450, "post_id": 54251695, "comment_id": 95328792, "body": "@Stargateur I&#39;m just worried that writing them each individually to a file would be slower than writing a whole string. But perhaps I&#39;m wrong on that."}, {"owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547808494, "post_id": 54251695, "comment_id": 95328819, "body": "@hellow It is working with DNA data which can be very large, but yes it&#39;s not ideal."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 4, "creation_date": 1547810271, "post_id": 54251695, "comment_id": 95329767, "body": "Provided that you use a <a href=\"https://doc.rust-lang.org/stable/std/io/struct.BufWriter.html\" rel=\"nofollow noreferrer\"><code>BufWriter</code></a>, then writing them each individually will almost always be faster than writing a whole string due to the time spent in allocating the string and copying data to it."}], "answers": [{"comments": [{"owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 0, "creation_date": 1547817467, "post_id": 54253740, "comment_id": 95333421, "body": "That&#39;s excellent. However, I&#39;m writing this to import into a python script, and I get the following errors: <code>writer.write(b&quot; &quot;)?; &#47;&#47; add the space    |         ^^^^^^^^^^^^^^^^^^^ the trait `std::convert::From&lt;std::io::Error&gt;` is not implemented for `cpython::PyErr` </code>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 1, "creation_date": 1547817837, "post_id": 54253740, "comment_id": 95333636, "body": "The <code>?</code> at the end of some of the lines is for propagating errors to exit the calling function with an error. You may need to handle errors differently in your situation, or do some work to convert between error types.   If you are happy not to handle errors, and just have them trigger a panic, then you can replace the <code>?</code>s with <code>.unwrap()</code> as a quick and dirty fix."}, {"owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 0, "creation_date": 1547818524, "post_id": 54253740, "comment_id": 95334071, "body": "Ok, I got it to compile at least, which I feel in Rust goes a long way. Btw, your example is wrong in using dna_piece.as_bytes() rather than just dna_piece if the tree is type <code>BTreeSet&lt;std::vec::Vec&lt;u8&gt;&gt;</code> as I specified, as it is already in bytes."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 1, "creation_date": 1547821985, "post_id": 54253740, "comment_id": 95335956, "body": "@simernes ah, yeah true. I&#39;ll change that"}, {"owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 0, "creation_date": 1547825540, "post_id": 54253740, "comment_id": 95338131, "body": "Btw, what would happen if for some reason the program crashed while writing the buffer? It&#39;s my understanding that the actual system call to write is when the BufWriter goes out of scope, so it would all add up first in the buffer, and then write, correct?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "edited": false, "score": 1, "creation_date": 1547825686, "post_id": 54253740, "comment_id": 95338215, "body": "@simernes no, the buffer has a fixed size (defaulting to 8kB) and is written to disk as soon as the buffer is full."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 1, "last_activity_date": 1547823226, "last_edit_date": 1547823226, "creation_date": 1547813324, "answer_id": 54253740, "question_id": 54251695, "link": "https://stackoverflow.com/questions/54251695/is-there-a-way-to-join-a-btreeset-on-whitespace-while-consuming-it-to-get-a-stri/54253740#54253740", "title": "Is there a way to join a BTreeSet on whitespace while consuming it to get a string without pushing each element to a string?", "body": "<p>This isn't possible. If you want to avoid allocating the entire contents of the set twice, you really have two options:</p>\n\n<ol>\n<li><p>Switch to a <code>HashSet</code> so you can use its <code>drain</code> method. Unfortunately this method does not yet exist for <code>BTreeSet</code>.</p>\n\n<pre><code>let mut output = Vec::new(); // use with_capacity if you know an upper bound on the size\nfor x in hash_set.drain() {\n    output.extend_from_slice(&amp;x);\n    output.push(b' '); // add the space\n}\n</code></pre></li>\n<li><p>Write directly to a file instead of creating a temporary data structure. Use a <code>BufWriter</code> for fewer IO calls.</p>\n\n<pre><code>let buffer = File::create(\"filename.txt\")?;\nlet mut writer = BufWriter::new(buffer);\nfor dna_piece in dna_pieces_set.iter() {\n    writer.write(dna_piece)?;\n    writer.write(b\" \")?; // add the space\n}     \n</code></pre></li>\n</ol>\n"}], "owner": {"reputation": 984, "user_id": 2889451, "user_type": "registered", "accept_rate": 87, "profile_image": "https://i.stack.imgur.com/fWMAk.jpg?s=128&g=1", "display_name": "Simen Russnes", "link": "https://stackoverflow.com/users/2889451/simen-russnes"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 164, "favorite_count": 0, "accepted_answer_id": 54253740, "answer_count": 1, "score": 0, "last_activity_date": 1547954807, "creation_date": 1547806103, "last_edit_date": 1547954807, "question_id": 54251695, "link": "https://stackoverflow.com/questions/54251695/is-there-a-way-to-join-a-btreeset-on-whitespace-while-consuming-it-to-get-a-stri", "title": "Is there a way to join a BTreeSet on whitespace while consuming it to get a string without pushing each element to a string?", "body": "<p>Is there a way to join a <code>BTreeSet</code> on whitespace while consuming it to get a string with each element separated by whitespace, other than by iterating over each element and pushing to a string?</p>\n\n<p>My set can be very large, perhaps 10GB at most, so I would like to limit memory usage.</p>\n\n<pre><code>type `std::collections::BTreeSet&lt;std::vec::Vec&lt;u8&gt;&gt;`\n</code></pre>\n\n<p>I am using the <a href=\"https://crates.io/crates/bio\" rel=\"nofollow noreferrer\">bio crate</a> for making reverse compliments of DNA strings, which <a href=\"https://github.com/rust-bio/rust-bio/blob/master/src/alphabets/dna.rs\" rel=\"nofollow noreferrer\">takes and returns a <code>Vec&lt;u8&gt;</code></a> (or at least returns <code>Vec&lt;u8&gt;</code>) so to avoid having to convert back and forth at some steps I want to keep them as such.</p>\n\n<p>Here is an example:</p>\n\n<pre><code>let dna_pieces = std::fs::read_to_string(path_dna_file).expect(\"Unable to read file\");\nlet dna_pieces = dna_pieces.split(\" \");\n\nlet mut dna_pieces_set = BTreeSet::new();\n\n// first adds a small set to the tree\nfor dna_piece in dna_pieces {\n    let dna_bytes = species_kmer.to_owned().into_bytes();\n    dna_pieces_set.insert(dna_bytes);\n}\n\n// then adds a bigger other set to the same tree\nlet dna_pieces_big_list = std::fs::read_to_string(path_dna_file_big).expect(\"Unable to read file\");\nlet dna_pieces_big_list = dna_pieces_big_list.split(\" \");\nfor dna_piece in dna_pieces_big_list {\n    let dna_bytes = dna_piece.to_owned().into_bytes();\n    let dna_bytes_to_rev = dna_piece.to_owned().into_bytes();\n    let reverse_complement = bio::alphabets::dna::revcomp(dna_bytes_to_rev);\n    if !dna_pieces_set.contains(&amp;reverse_complement) {\n        dna_pieces_set.insert(dna_bytes);\n    }\n}\n\n// format the treeset into a string output_unique_dna_pieces...\n\nstd::fs::write(path_unique_dna_pieces, output_unique_dna_pieces).expect(\"Unable to write file\");\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1547799224, "post_id": 54249893, "comment_id": 95323977, "body": "It looks like you started in programming with Rust. Please read <a href=\"https://doc.rust-lang.org/stable/book/\" rel=\"nofollow noreferrer\">the book</a> as it explains all the details on how to write Rust programs and the syntax. If you still have questions, please comt back and ask them."}, {"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547799344, "post_id": 54249893, "comment_id": 95324028, "body": "@hellow Yes, I did start programming in Rust. But it does not mean that my question is incorrect. For example, in Python it is not a problem to store a class into a variable."}, {"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "edited": false, "score": 0, "creation_date": 1547799586, "post_id": 54249893, "comment_id": 95324122, "body": "I edited my question. If a macros helps I would be happy to see an example."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1547799600, "post_id": 54249893, "comment_id": 95324125, "body": "Thanks for the edit, but now I ask you something. How is somebody outside of function <code>f1</code> supposed to know how your struct <code>mystruct</code> looks like? How do they know what kind of members it has, what size they are? It is not possible, you cannot use <code>mystruct</code> outside of your <code>f1</code> function"}, {"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547799688, "post_id": 54249893, "comment_id": 95324154, "body": "@hellow &quot;How is somebody outside of function f1 supposed to know how your struct mystruct looks like?&quot; That is what my question is about. This is why I want to store a struct into a variable somehow."}, {"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1547799768, "post_id": 54249893, "comment_id": 95324192, "body": "@hellow I edited the code again. I forgot to create an instance."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547800189, "post_id": 54249893, "comment_id": 95324363, "body": "As said: No it&#39;s not possible. You have to define it in a shared scope."}], "answers": [{"comments": [{"owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "edited": false, "score": 0, "creation_date": 1547815245, "post_id": 54251520, "comment_id": 95332286, "body": "Thank you for nice explanation."}, {"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "reply_to_user": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "edited": false, "score": 1, "creation_date": 1547818485, "post_id": 54251520, "comment_id": 95334047, "body": "@Fomalhaut: You&#39;re welcome. Coming from a highly dynamic language like Python you are bound to bump into limitations that we&#39;re taking for granted; I&#39;m looking forward to your future [rust] questions :)"}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 5, "last_activity_date": 1547805542, "creation_date": 1547805542, "answer_id": 54251520, "question_id": 54249893, "link": "https://stackoverflow.com/questions/54249893/how-to-store-a-struct-into-a-variable-in-rust/54251520#54251520", "title": "How to store a struct into a variable in Rust?", "body": "<blockquote>\n  <p>How to store a struct into a variable in Rust?</p>\n</blockquote>\n\n<p>Rust is a <strong>statically</strong> typed language, and as such it is <strong>not possible</strong> to store a <em>type</em> into a variable, then use this variable to construct an instance of the type.</p>\n\n<p>This is the reason you are not able to express what the type of <code>s</code> is; there is simply no vocabulary in the language for this.</p>\n\n<hr>\n\n<p>Depending on what you want to do, you may wish to look into:</p>\n\n<ul>\n<li>Generics: <code>fn f2&lt;T: Default&gt;()</code> would allow creating an instance of any type <code>T</code> implementing the <code>Default</code> trait.</li>\n<li>Run-time polymorphism: A factory function <code>FnOnce(i32) -&gt; Box&lt;Trait&gt;</code> could produce an instance of any type implementing <code>Trait</code> from a <code>i32</code>.</li>\n</ul>\n"}], "owner": {"reputation": 5341, "user_id": 3467698, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/9ae079231f5aec46808b1c7853833e72?s=128&d=identicon&r=PG", "display_name": "Fomalhaut", "link": "https://stackoverflow.com/users/3467698/fomalhaut"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 392, "favorite_count": 0, "accepted_answer_id": 54251520, "answer_count": 1, "score": 1, "last_activity_date": 1547955954, "creation_date": 1547799006, "last_edit_date": 1547955954, "question_id": 54249893, "link": "https://stackoverflow.com/questions/54249893/how-to-store-a-struct-into-a-variable-in-rust", "title": "How to store a struct into a variable in Rust?", "body": "<p>Rust allows declaring a structure inside a function but it doesn't allow assigning a variable with it in a simple way.</p>\n\n<pre><code>fn f1() -&gt; (something) {\n    struct mystruct {\n        x: i32,\n    }\n\n    let s = mystruct;\n\n    s\n}\n\nfn f2(s: something) {\n    let obj = s { x: 5 };\n    println!(obj.x);\n}\n\nfn main() {\n    let s = f1();\n    f2(s);\n}\n</code></pre>\n\n<p>Is it possible to store a struct into a variable in a different way? How do I write the struct type correctly? In my project, I want to declare a struct inside a function and create instances inside of another one.</p>\n"}, {"tags": ["types", "async-await", "rust", "future"], "comments": [{"owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "edited": false, "score": 0, "creation_date": 1547795948, "post_id": 54249243, "comment_id": 95322694, "body": "There is an <a href=\"https://github.com/rust-lang/rust/issues/50547\" rel=\"nofollow noreferrer\">RFC</a> going on for the async/await"}, {"owner": {"reputation": 1733, "user_id": 1460102, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/e70df89ccf5e5509e4aae9ef4ed5b865?s=128&d=identicon&r=PG", "display_name": "xxks-kkk", "link": "https://stackoverflow.com/users/1460102/xxks-kkk"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1547796653, "post_id": 54249243, "comment_id": 95322985, "body": "@hellow I updated my question and I think mine is quite different from the one you suggested."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547796866, "post_id": 54249243, "comment_id": 95323084, "body": "Okay, I can accept that, thanks for editing your question :)"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547797427, "post_id": 54249243, "comment_id": 95323298, "body": "Maybe this is a duplicate? <a href=\"https://stackoverflow.com/questions/26577070/how-to-use-fn-traits-closures-in-signatures-in-rust\" title=\"how to use fn traits closures in signatures in rust\">stackoverflow.com/questions/26577070/&hellip;</a>"}], "answers": [{"tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": false, "score": 3, "last_activity_date": 1547953615, "last_edit_date": 1547953615, "creation_date": 1547797047, "answer_id": 54249553, "question_id": 54249243, "link": "https://stackoverflow.com/questions/54249243/whats-the-type-of-an-async-fn/54249553#54249553", "title": "What&#39;s the type of an async fn?", "body": "<p>You have to introduce two type parameters to your function signature, one for the <code>Fn</code> and one for the <code>Future</code>, e.g.</p>\n\n<pre><code>#![feature(futures_api, async_await)]\n\nasync fn foo() {}\n\nfn run&lt;G: std::future::Future, F: FnOnce() -&gt; G&gt;(f: F) {\n    f();\n}\n\nfn main() {\n    bar(foo)\n}\n</code></pre>\n\n<p>You can replace <code>FnOnce</code> with <code>Fn</code> or <code>FnMut</code> depending on your needs.</p>\n"}, {"tags": [], "owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "is_accepted": false, "score": 2, "last_activity_date": 1547953648, "last_edit_date": 1547953648, "creation_date": 1547797121, "answer_id": 54249565, "question_id": 54249243, "link": "https://stackoverflow.com/questions/54249243/whats-the-type-of-an-async-fn/54249565#54249565", "title": "What&#39;s the type of an async fn?", "body": "<p>Using generic type parameter can help since an <code>async fn</code> returns an implementation of the <code>Future</code> trait. </p>\n\n<pre><code>#![feature(futures_api, async_await)]\n\nuse std::future::Future;\n\nfn main() {\n    run(foo);\n}\n\nasync fn foo() {}\n\nfn run&lt;T: Future&gt;(f: fn() -&gt; T) {\n    f();\n}\n</code></pre>\n"}], "owner": {"reputation": 1733, "user_id": 1460102, "user_type": "registered", "accept_rate": 73, "profile_image": "https://www.gravatar.com/avatar/e70df89ccf5e5509e4aae9ef4ed5b865?s=128&d=identicon&r=PG", "display_name": "xxks-kkk", "link": "https://stackoverflow.com/users/1460102/xxks-kkk"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 429, "favorite_count": 1, "answer_count": 2, "score": 2, "last_activity_date": 1547953648, "creation_date": 1547795501, "last_edit_date": 1547953568, "question_id": 54249243, "link": "https://stackoverflow.com/questions/54249243/whats-the-type-of-an-async-fn", "title": "What&#39;s the type of an async fn?", "body": "<p>I want to have a function that takes a <a href=\"https://doc.rust-lang.org/book/ch19-05-advanced-functions-and-closures.html\" rel=\"nofollow noreferrer\">function pointer</a> of <code>async fn</code>.<br>\nWhat should the type of <code>f</code> be in <code>fn run</code>?</p>\n\n<pre><code>async fn foo() {}\n\nfn run(f: /* ??? */) {}\n</code></pre>\n\n<p>According to the <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/2394-async_await.md\" rel=\"nofollow noreferrer\">async/await RFC</a>:</p>\n\n<blockquote>\n  <p>An <code>async fn foo(args..) -&gt; T</code> is a function of the type <code>fn(args..) -&gt; impl Future&lt;Output = T&gt;</code>. </p>\n</blockquote>\n\n<p>However, if I write</p>\n\n<pre><code>fn run(f: fn() -&gt; impl Future&lt;()&gt;)\n</code></pre>\n\n<p>I get the error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>`impl Trait` not allowed outside of function and inherent method return types\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1547796572, "post_id": 54249200, "comment_id": 95322952, "body": "Your code is not valid rust syntax, e.g. <code>pub struct InputData{};</code> is not valid. Please fix that and format your code according to the rustfmt guidelines, e.g. by using <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">the playground</a>"}], "answers": [{"tags": [], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "is_accepted": true, "score": 1, "last_activity_date": 1547796131, "creation_date": 1547796131, "answer_id": 54249374, "question_id": 54249200, "link": "https://stackoverflow.com/questions/54249200/how-do-i-import-a-mod-with-traits-into-rust-this-function-takes-1-parameter-but/54249374#54249374", "title": "How do I import a mod with traits into rust? this function takes 1 parameter but 0 parameters were supplied", "body": "<p>It seems like you imported the mod but called the function wrong.</p>\n\n<p>You can call it in two different ways:</p>\n\n<ol>\n<li><code>fix_me::Wow::findMe(&amp;input_data);</code>       </li>\n<li><code>input_data.findMe();</code></li>\n</ol>\n"}], "owner": {"reputation": 61601, "user_id": 1203556, "user_type": "registered", "accept_rate": 57, "profile_image": "https://www.gravatar.com/avatar/aca772bc8ed79a86894211c7efd920aa?s=128&d=identicon&r=PG", "display_name": "Tampa", "link": "https://stackoverflow.com/users/1203556/tampa"}, "delete_vote_count": 1, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 372, "favorite_count": 0, "closed_date": 1547954567, "accepted_answer_id": 54249374, "answer_count": 1, "score": -3, "last_activity_date": 1547796131, "creation_date": 1547795255, "question_id": 54249200, "link": "https://stackoverflow.com/questions/54249200/how-do-i-import-a-mod-with-traits-into-rust-this-function-takes-1-parameter-but", "closed_reason": "Duplicate", "title": "How do I import a mod with traits into rust? this function takes 1 parameter but 0 parameters were supplied", "body": "<p>How do I import a mod into rust? </p>\n\n<p>1) I have a file with these contents:</p>\n\n<pre><code>this_is_stupid.rs\n\npub mod fix_me {\n\n    use crate::InputData;\n\n    pub trait Wow {\n        fn findMe(&amp;self);\n    }\n\n\n    //impl  InputData {\n    impl Wow for InputData {\n\n        fn findMe(&amp;self) {\n            print!(\"Really dudes we are working?\");\n        }\n    } //end impl \n} // mod \n</code></pre>\n\n<p>In my main I have this:</p>\n\n<pre><code>   pub mod this_is_stupid;\n   use crate::this_is_stupid::fix_me;\n   pub struct InputData {}\n   fn main() {\n        let input_data: InputData{};\n        fix_me::Wow::findMe();\n    }\n</code></pre>\n\n<p>Here is my error:</p>\n\n<pre><code>error[E0061]: this function takes 1 parameter but 0 parameters were supplied                                                                                          \n  --&gt; src/main.rs:85:9                                                                                                                                                \n   |                                                                                                                                                                  \n85 |         fix_me::Wow::findMe();                                                                                                                                   \n   |         ^^^^^^^^^^^^^^^^^^^^^ expected 1 parameter                                                                                                               \n   |                                                                                                                                                                  \n  ::: src/this_is_stupid.rs:12:9                                                                                                                                      \n   |                                                                                                                                                                  \n12 |         fn findMe(&amp;self);                                                                                                                                        \n   |         ----------------- defined here   \n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 17989, "user_id": 365102, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/e3139989e6548e7deac2cd45253d60df?s=128&d=identicon&r=PG", "display_name": "Mateen Ulhaq", "link": "https://stackoverflow.com/users/365102/mateen-ulhaq"}, "edited": false, "score": 0, "creation_date": 1547788543, "post_id": 54248024, "comment_id": 95320357, "body": "You haven&#39;t defined a function <code>cross_product</code> function."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1547953166, "post_id": 54248024, "comment_id": 95369099, "body": "Go read <a href=\"https://doc.rust-lang.org/book/\" rel=\"nofollow noreferrer\"><i>The Rust Programming Language</i></a>. It is free and answers beginner questions."}], "answers": [{"comments": [{"owner": {"reputation": 51, "user_id": 10926030, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-w_r5FGhM3is/AAAAAAAAAAI/AAAAAAAAACw/oToWnr9Lvv0/photo.jpg?sz=128", "display_name": "Andrew Chon", "link": "https://stackoverflow.com/users/10926030/andrew-chon"}, "edited": false, "score": 0, "creation_date": 1547830220, "post_id": 54248132, "comment_id": 95340600, "body": "Thank you for the help!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547953341, "post_id": 54248132, "comment_id": 95369132, "body": "Taking ownership of the vectors is <i>highly unlikely</i> to be what the OP wants."}], "tags": [], "owner": {"reputation": 1171, "user_id": 2430915, "user_type": "registered", "accept_rate": 67, "profile_image": "https://www.gravatar.com/avatar/fa2d09b09a5eaf435ffdf18206a3a6b4?s=128&d=identicon&r=PG", "display_name": "BBS", "link": "https://stackoverflow.com/users/2430915/bbs"}, "is_accepted": false, "score": 1, "last_activity_date": 1547953325, "last_edit_date": 1547953325, "creation_date": 1547788943, "answer_id": 54248132, "question_id": 54248024, "link": "https://stackoverflow.com/questions/54248024/how-to-define-a-function-in-rust/54248132#54248132", "title": "How to define a function in Rust?", "body": "<p>It looks like you are mainly having problems with Rust syntax. You can either create a cross product function or do the cross product inline. </p>\n\n<pre><code>let vec1 = vec![1.15, 7.0];\nlet vec2 = vec![7.0, 2.0];\nlet cross_product = vec1[0] * vec2[1] - vec1[1] * vec2[0];\nprintln!(\"{}\", cross_product);\n</code></pre>\n\n<p>If you want a function you can use continually.</p>\n\n<pre><code>fn function_cross_product(vec1: Vec&lt;f64&gt;, vec2: Vec&lt;f64&gt;) -&gt; f64 {\n  return vec1[0] * vec2[1] - vec1[1] * vec2[0];\n};\nlet other_product = function_cross_product(vec1, vec2);\nprintln!(\"{}\", other_product);\n</code></pre>\n\n<p>The second solution can be misleading because it will always produce the cross product for a 2x2 vector even if you pass different sized vectors.</p>\n"}, {"tags": [], "owner": {"reputation": 4195, "user_id": 6882497, "user_type": "registered", "accept_rate": 77, "profile_image": "https://i.stack.imgur.com/yMbwv.jpg?s=128&g=1", "display_name": "Akiner Alkan", "link": "https://stackoverflow.com/users/6882497/akiner-alkan"}, "is_accepted": true, "score": 1, "last_activity_date": 1608756701, "last_edit_date": 1608756701, "creation_date": 1547789669, "answer_id": 54248223, "question_id": 54248024, "link": "https://stackoverflow.com/questions/54248024/how-to-define-a-function-in-rust/54248223#54248223", "title": "How to define a function in Rust?", "body": "<p>There are two possible ways to do this.</p>\n<h3>First Way</h3>\n<p>You can declare a function and pass it into <code>println!()</code> which is similar to many programming languages like Java, C#,  etc.</p>\n<pre><code>// Declare the function\nfn cross_product(slice1: &amp;[i32], slice2: &amp;[i32]) -&gt; i32 {\n    slice1[0] * slice2[1] - slice1[1] * slice2[2]\n}\n\n// Use it Like following\nfn main() {\n    let vec1 = vec![1, 2, 3];\n    let vec2 = vec![4, 5, 6];\n\n    println!(&quot;{}&quot;, cross_product(&amp;vec1[..], &amp;vec2[..]));\n}\n</code></pre>\n<h3>Second Way</h3>\n<p>You can declare a closure and pass it into <code>println!()</code>, a common methodology in functional programming:</p>\n<pre><code>// You can declare a closure and use it as function in the same code block\nfn main() {\n    let vec1 = vec![1, 2, 3];\n    let vec2 = vec![4, 5, 6];\n\n    let cross_product = |slice1: &amp;[i32], slice2: &amp;[i32]| -&gt; i32 {\n        let result = slice1[0] * slice2[1] - slice1[1] * slice2[2];\n        result\n    };\n\n    println!(&quot;{}&quot;, cross_product(&amp;vec1[..], &amp;vec2[..]));\n}\n</code></pre>\n<p>Please note that I have created the vectors and closures using the <code>i32</code> data type, which corresponds to an integer. You can change the type with <code>f32</code> or if you want wider float range <code>f64</code>.</p>\n"}], "owner": {"reputation": 51, "user_id": 10926030, "user_type": "registered", "profile_image": "https://lh6.googleusercontent.com/-w_r5FGhM3is/AAAAAAAAAAI/AAAAAAAAACw/oToWnr9Lvv0/photo.jpg?sz=128", "display_name": "Andrew Chon", "link": "https://stackoverflow.com/users/10926030/andrew-chon"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 120, "favorite_count": 0, "accepted_answer_id": 54248223, "answer_count": 2, "score": -1, "last_activity_date": 1608756701, "creation_date": 1547788009, "last_edit_date": 1549630946, "question_id": 54248024, "link": "https://stackoverflow.com/questions/54248024/how-to-define-a-function-in-rust", "title": "How to define a function in Rust?", "body": "<p>I decided to do 2D vector cross product in Rust. In JavaScript, this is simple to do:</p>\n\n<pre class=\"lang-js prettyprint-override\"><code>float CrossProduct( const Vec2&amp; a, const Vec2&amp; b ) {\n    return a.x * b.y - a.y * b.x;\n}\n</code></pre>\n\n<p>I tried to convert it to the Rust system:</p>\n\n<pre><code>// Just created two separate variables for the two different vectors\n\nlet vec1 = vec![1.15, 7.0];\nlet vec2 = vec![7.0, 2.0];\nlet cross_product(&amp;vec1, &amp;vec2) = vec1[0] * vec2[1] - vec1[1] * vec2[0];\nprintln!(\"{}\", cross_product);\n\n// I also tried return.\nlet vec1 = vec![1.15, 7.0];\nlet vec2 = vec![7.0, 2.0];\nlet cross_product(&amp;vec1, &amp;vec2) {\n    return (vec1[0] * vec2[1] - vec1[1] * vec2[0]);\n}\nprintln!(\"{}\", cross_product);\n</code></pre>\n\n<p>I thought that one of these would work, however this was more of a reality check to me how different Rust can be from any language I have used previously.</p>\n\n<p>I found a very inefficient way to work around this, however I would rather learn to do this correctly. I am new to Rust, so please take my attempts with a grain of salt.</p>\n"}, {"tags": ["rust", "closures", "ownership", "borrowing"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1547784544, "post_id": 54247561, "comment_id": 95319511, "body": "TL;DR the duplicate: No, not yet, if ever."}], "owner": {"reputation": 25893, "user_id": 353820, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/32b29e1dc23c2c5abe0283ab7b9541d3?s=128&d=identicon&r=PG", "display_name": "Doug", "link": "https://stackoverflow.com/users/353820/doug"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 28, "favorite_count": 0, "closed_date": 1547784497, "answer_count": 0, "score": 2, "last_activity_date": 1547784425, "creation_date": 1547783850, "last_edit_date": 1547783984, "question_id": 54247561, "link": "https://stackoverflow.com/questions/54247561/can-a-closure-return-a-reference-to-data-it-owns", "closed_reason": "Duplicate", "title": "Can a closure return a reference to data it owns?", "body": "<p>If I have a closure, I can <code>move || ...</code> to move data into the closure context, like this:</p>\n\n<pre><code>#[derive(Debug)]\nstruct State {\n    value: usize,\n}\n\nfn external_receiver(mut inc: impl FnMut() -&gt; usize) {\n    let x = inc();\n    println!(\"{:?}\", x);\n\n    let x = inc();\n    println!(\"{:?}\", x);\n}\n\nfn main() {\n    let mut foo = Box::new(State { value: 0 });\n    external_receiver(move || -&gt; usize { \n        foo.as_mut().value += 1;\n        return foo.as_ref().value;\n    });\n}\n</code></pre>\n\n<p>I have a few situations where it would be convenient to have a closure that could return a <code>&amp;mut State</code> reference to some data object, where the caller of the closure was totally naive about the source of the object.</p>\n\n<p>I can't get anything like that to work though:</p>\n\n<pre><code>#[derive(Debug)]\nstruct State {\n    value: usize,\n}\n\nfn external_receiver(inc: impl Fn() -&gt; &amp;mut State) {\n    let x = inc();\n    x.value += 1;\n    println!(\"{:?}\", x);\n}\n\nfn main() {\n    let mut foo = Box::new(State { value: 0 });\n    external_receiver(move || -&gt; &amp;mut State { foo.as_mut() });\n}\n</code></pre>\n\n<p>There doesn't seem to any obvious way around this; I can't seem to figure out how to assert that the lifetime of the returned reference (<code>&amp;'a mut State</code>) should be equal to the lifetime of the closure itself.</p>\n\n<p>I've tried a couple of variations like passing a reference:</p>\n\n<pre><code>fn external_receiver&lt;'a&gt;(inc: &amp;'a mut FnMut() -&gt; &amp;'a mut State) {\n    let x = inc();\n    x.value += 1;\n    println!(\"{:?}\", x);\n}\n\nfn main() {\n    let mut foo = Box::new(State { value: 0 });\n    let mut x = move || -&gt; &amp;mut State { foo.as_mut() };\n    external_receiver(&amp;mut x);\n}\n</code></pre>\n\n<p>...but I get the typical:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime for autoref due to conflicting requirements\n  --&gt; src/main.rs:14:45\n   |\n14 |     let mut x = move || -&gt; &amp;mut State { foo.as_mut() };\n   |                                             ^^^^^^\n   |\nnote: first, the lifetime cannot outlive the lifetime  as defined on the body at 14:17...\n  --&gt; src/main.rs:14:17\n   |\n14 |     let mut x = move || -&gt; &amp;mut State { foo.as_mut() };\n   |                 ^^^^^^^^^^^^^^^^^^^^^\nnote: ...so that closure can access `foo`\n  --&gt; src/main.rs:14:41\n   |\n14 |     let mut x = move || -&gt; &amp;mut State { foo.as_mut() };\n   |                                         ^^^\nnote: but, the lifetime must be valid for the call at 15:5...\n  --&gt; src/main.rs:15:5\n   |\n15 |     external_receiver(&amp;mut x);\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\nnote: ...so that argument is valid for the call\n  --&gt; src/main.rs:15:23\n   |\n15 |     external_receiver(&amp;mut x);\n   |                       ^^^^^^\n</code></pre>\n\n<p>Does moving data to a closure not actually move the data into the closure itself (even if the closure is boxed?)?</p>\n\n<p>Is there some way to be able to have a function that basically does <code>Fn() -&gt; &amp;Foo</code>?</p>\n"}, {"tags": ["rust"], "owner": {"reputation": 13635, "user_id": 547365, "user_type": "registered", "accept_rate": 79, "profile_image": "https://www.gravatar.com/avatar/ddefbca930fdd39846b698bab7ac3146?s=128&d=identicon&r=PG", "display_name": "w.brian", "link": "https://stackoverflow.com/users/547365/w-brian"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 173, "favorite_count": 0, "closed_date": 1577545061, "answer_count": 0, "score": 0, "locked_date": 1577545081, "last_activity_date": 1547782153, "creation_date": 1547780748, "last_edit_date": 1547781561, "question_id": 54247229, "link": "https://stackoverflow.com/questions/54247229/is-there-a-way-to-allocate-directly-to-the-heap-without-using-the-unstable-box-s", "closed_reason": "Duplicate", "title": "Is there a way to allocate directly to the heap without using the unstable box syntax?", "body": "<p>I'm in the process of getting a project of mine targeting WASM, and it appears that the stack size in the browser is relatively small and non-configurable. A consequence of this is that my application will overflow the stack while attempting to allocate \na large struct on the heap, due to the intermediate stack allocation when calling <code>Box::new()</code>. The <a href=\"https://github.com/rust-lang/rust/issues/49733\" rel=\"nofollow noreferrer\">unstable <code>box</code> syntax</a> fixed this, but it appears to be dead in the water.</p>\n\n<p>I managed to get it running without <code>box</code>, albeit in a less-than-ideal fashion. I had to refactor my structs to hold reference to boxed data in order to allocate in smaller chunks.</p>\n\n<p>Is there a way to allocate directly to the heap without <code>box</code>?</p>\n"}, {"tags": ["rust", "rust-diesel"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547781288, "post_id": 54247145, "comment_id": 95318852, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/54247145/edit\">edit</a> your question to include it. We cannot tell what code you have, whatsoever. Try to produce something that reproduces your error in a brand new Cargo project, providing information about your DB. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> and <a href=\"//stackoverflow.com/tags/rust-diesel/info\">Diesel-specific MCVE tips</a> as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547782291, "post_id": 54247145, "comment_id": 95319036, "body": "Please also re-read <a href=\"https://stackoverflow.com/questions/how-to-ask\">How to Ask</a> and take the time to describe what happens when you use the code that you&#39;ve shown and how it differs from what you expected."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547784970, "post_id": 54247145, "comment_id": 95319604, "body": "Specifically, based on my quick testing, the code you&#39;ve provided <b>works</b>. Obviously, I&#39;m missing some test cases or else you would never have asked the question! This is why it&#39;s good to proactively provide these kinds of things as part of asking a good question."}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547786702, "post_id": 54247145, "comment_id": 95319975, "body": "OK, will do tomorrow."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1548234190, "post_id": 54247145, "comment_id": 95465617, "body": "@DaveMason tomorrow is over"}], "owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 58, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1547781283, "creation_date": 1547779934, "last_edit_date": 1547781283, "question_id": 54247145, "link": "https://stackoverflow.com/questions/54247145/how-do-i-specify-an-escape-character-for-wildcards-for-diesel", "title": "How do I specify an escape character for wildcards for Diesel?", "body": "<p>I am doing some <code>name.like(r\"A-%\\%\")</code> searches with Diesel, but I can't figure out how to specify the SQL escape character I'm using... in this case <code>\\</code> (so this search is for names that start with <code>A-</code> and end with <code>%</code> - the first <code>%</code> is the SQL wildcard equivalent to <code>.*</code> in Regex).</p>\n"}, {"tags": ["rust", "future", "rust-tokio"], "answers": [{"comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 1, "creation_date": 1547755531, "post_id": 54243421, "comment_id": 95311377, "body": "As an alternative to avoid for_each : <code>rx.take_while(|x| futures::future::ok(*x == true)).into_future().then(|_| Ok(())) </code> works also ."}, {"owner": {"reputation": 5913, "user_id": 1244932, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/d2c608e688b798896e8b516855fc1ab1?s=128&d=identicon&r=PG", "display_name": "user1244932", "link": "https://stackoverflow.com/users/1244932/user1244932"}, "edited": false, "score": 0, "creation_date": 1547755869, "post_id": 54243421, "comment_id": 95311532, "body": "But my problem also in joining <code>future::lazy</code> and <code>rx.take_while</code>"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 5913, "user_id": 1244932, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/d2c608e688b798896e8b516855fc1ab1?s=128&d=identicon&r=PG", "display_name": "user1244932", "link": "https://stackoverflow.com/users/1244932/user1244932"}, "edited": false, "score": 0, "creation_date": 1547771802, "post_id": 54243421, "comment_id": 95317023, "body": "@user1244932 updated."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1547785528, "post_id": 54243421, "comment_id": 95319710, "body": "@&#214;merErden please don&#39;t feel like you need to delete your answer if it&#39;s still correct; you recognized that the OP wanted the chaining and <code>into_future</code> before I did. It&#39;s always possible that the OP thinks that your answer better fits their code."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 0, "last_activity_date": 1547771784, "last_edit_date": 1547771784, "creation_date": 1547755150, "answer_id": 54243421, "question_id": 54242732, "link": "https://stackoverflow.com/questions/54242732/cannot-use-streamtake-while-on-an-mpscchannel-bool-future-is-not-satisfied/54243421#54243421", "title": "Cannot use Stream::take_while on an mpsc::channel: bool: Future is not satisfied", "body": "<p>Read and understand the documentation and function signature of methods you attempt to use:</p>\n\n<pre><code>fn take_while&lt;P, R&gt;(self, pred: P) -&gt; TakeWhile&lt;Self, P, R&gt;\nwhere\n    P: FnMut(&amp;Self::Item) -&gt; R,\n    R: IntoFuture&lt;Item = bool, Error = Self::Error&gt;,\n    Self: Sized, \n</code></pre>\n\n<p><code>take_while</code> takes a closure that returns some type that must be convertible into a future; a <code>bool</code> is not convertible into a future. The simplest way to do this is via <a href=\"https://docs.rs/futures/0.1.25/futures/future/fn.ok.html\" rel=\"nofollow noreferrer\"><code>future::ok</code></a>:</p>\n\n<pre><code>let thr = thread::spawn(|| {\n    let mut runtime = tokio::runtime::current_thread::Runtime::new().unwrap();\n    runtime.spawn({\n        rx.take_while(|&amp;x| future::ok(x))\n            .for_each(|x| {\n                println!(\"{}\", x);\n                future::ok(())\n            })\n    });\n\n    runtime.run()\n});\n\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/46625376/155423\">The trait bound `(): futures::Future` is not satisfied when using TcpConnectionNew</a></li>\n</ul>\n\n<blockquote>\n  <p>But my problem also in joining <code>future::lazy</code> and <code>rx.take_while</code></p>\n</blockquote>\n\n<p>That's an unrelated problem to what you asked about. Again, we look at the docs, this time for <a href=\"https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#method.and_then\" rel=\"nofollow noreferrer\"><code>Future::and_then</code></a>:</p>\n\n<pre><code>fn and_then&lt;F, B&gt;(self, f: F) -&gt; AndThen&lt;Self, B, F&gt;\nwhere\n    F: FnOnce(Self::Item) -&gt; B,\n    B: IntoFuture&lt;Error = Self::Error&gt;,\n    Self: Sized, \n</code></pre>\n\n<p>Similarly to <code>take_while</code>, it takes a closure and the closure must return something that can be convertible into a future. Your code doesn't provide a closure.</p>\n\n<p>Then look at <a href=\"https://docs.rs/futures/0.1.23/futures/stream/trait.Stream.html#method.into_future\" rel=\"nofollow noreferrer\"><code>Stream::into_future</code></a>. This returns <a href=\"https://docs.rs/futures/0.1.23/futures/stream/struct.StreamFuture.html#impl-Future\" rel=\"nofollow noreferrer\">a type that implements <code>Future</code></a> and returns a tuple. The first item in the tuple is a single value from the stream, the second is the stream itself, to allow getting more values.</p>\n\n<p>To get all the item and error types correct, I've make liberal use of <code>map(drop)</code> and <code>map_err(drop)</code> \u2014 you will want to do something better for your data and error handling.</p>\n\n<pre><code>runtime.spawn({\n    future::lazy(|| {\n        println!(\"event loop started\");\n        Ok(())\n    })\n    .and_then(|_| {\n        rx.take_while(|&amp;x| future::ok(x))\n            .into_future()\n            .map(drop)\n            .map_err(drop)\n    })\n    .map(drop)\n});\n</code></pre>\n\n<hr>\n\n<p>Really, you should just use a <a href=\"https://docs.rs/futures/0.1.23/futures/sync/oneshot/index.html\" rel=\"nofollow noreferrer\">oneshot channel</a>; it's much simpler:</p>\n\n<pre><code>use futures::{\n    future::{self, Future},\n    sync::oneshot,\n};\nuse std::thread;\n\nfn main() {\n    let (tx, rx) = oneshot::channel();\n\n    let thr = thread::spawn(|| {\n        let mut runtime = tokio::runtime::current_thread::Runtime::new().unwrap();\n\n        runtime.spawn({\n            future::lazy(|| {\n                println!(\"event loop started\");\n                Ok(())\n            })\n            .and_then(|_| rx.map_err(drop))\n        });\n\n        runtime.run()\n    });\n\n    let lines = [\"hello\", \"goodbye\", \"exit\"];\n    for &amp;line in &amp;lines {\n        if line == \"exit\" {\n            tx.send(()).unwrap();\n            break;\n        }\n    }\n\n    thr.join().unwrap().unwrap();\n}\n</code></pre>\n"}], "owner": {"reputation": 5913, "user_id": 1244932, "user_type": "registered", "accept_rate": 70, "profile_image": "https://www.gravatar.com/avatar/d2c608e688b798896e8b516855fc1ab1?s=128&d=identicon&r=PG", "display_name": "user1244932", "link": "https://stackoverflow.com/users/1244932/user1244932"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 517, "favorite_count": 0, "closed_date": 1551037533, "answer_count": 1, "score": -1, "last_activity_date": 1547771784, "creation_date": 1547752274, "last_edit_date": 1547754404, "question_id": 54242732, "link": "https://stackoverflow.com/questions/54242732/cannot-use-streamtake-while-on-an-mpscchannel-bool-future-is-not-satisfied", "closed_reason": "Duplicate", "title": "Cannot use Stream::take_while on an mpsc::channel: bool: Future is not satisfied", "body": "<p>I want to run an event loop in one thread and handle data from a UDP socket until another thread signals to stop work.</p>\n\n<p>This is a difficult task for me, so I want to start from a simpler task:\none thread starting the event loop and waiting for another thread to signal the end:</p>\n\n<pre><code>use futures::{future, future::Future, stream::Stream, sync::mpsc};\nuse std::{io, io::BufRead, thread};\n\nfn main() {\n    let (mut tx, rx) = mpsc::channel::&lt;bool&gt;(1);\n\n    let thr = thread::spawn(|| {\n        let mut runtime = tokio::runtime::current_thread::Runtime::new().unwrap();\n        runtime.spawn(\n            future::lazy(|| {\n                println!(\"event loop started\");\n                Ok(())\n            })\n            .and_then(rx.take_while(|x| *x == true).into_future()),\n        );\n\n        runtime.run()\n    });\n\n    let stdin = io::stdin();\n    for line in stdin.lock().lines() {\n        let line = line.unwrap();\n        println!(\"{}\", line);\n        if line == \"exit\" {\n            tx.try_send(false).unwrap();\n            break;\n        }\n    }\n    thr.join().unwrap().unwrap();\n}\n</code></pre>\n\n<p>This code doesn't compile:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `bool: futures::future::Future` is not satisfied\n  --&gt; src/main.rs:14:26\n   |\n14 |             .and_then(rx.take_while(|x| *x == true).into_future()),\n   |                          ^^^^^^^^^^ the trait `futures::future::Future` is not implemented for `bool`\n   |\n   = note: required because of the requirements on the impl of `futures::future::IntoFuture` for `bool`\n\nerror[E0599]: no method named `into_future` found for type `futures::stream::take_while::TakeWhile&lt;futures::sync::mpsc::Receiver&lt;bool&gt;, [closure@src/main.rs:14:37: 14:51], bool&gt;` in the current scope\n  --&gt; src/main.rs:14:53\n   |\n14 |             .and_then(rx.take_while(|x| *x == true).into_future()),\n   |                                                     ^^^^^^^^^^^\n   |\n   = note: the method `into_future` exists but the following trait bounds were not satisfied:\n           `futures::stream::take_while::TakeWhile&lt;futures::sync::mpsc::Receiver&lt;bool&gt;, [closure@src/main.rs:14:37: 14:51], bool&gt; : futures::stream::Stream`\n           `&amp;mut futures::stream::take_while::TakeWhile&lt;futures::sync::mpsc::Receiver&lt;bool&gt;, [closure@src/main.rs:14:37: 14:51], bool&gt; : futures::stream::Stream`\n\n</code></pre>\n\n<p>How do I fix the compilation error?</p>\n"}, {"tags": ["ruby", "rust", "ffi"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1547749273, "post_id": 54241922, "comment_id": 95308434, "body": "You are passing data that you claim to be encoded via  <code>Us-ASCII</code> but it&#39;s not."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547948904, "post_id": 54241922, "comment_id": 95368557, "body": "It&#39;s worth noting that this <b>does not</b> reproduce on a 64-bit Ubuntu Linux VM, but it <b>does</b> on a 32-bit Ubuntu Linux VM."}], "owner": {"reputation": 63, "user_id": 1956705, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/O0kny.jpg?s=128&g=1", "display_name": "Lattis", "link": "https://stackoverflow.com/users/1956705/lattis"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 87, "favorite_count": 0, "answer_count": 0, "score": 3, "last_activity_date": 1548015762, "creation_date": 1547748848, "last_edit_date": 1548015762, "question_id": 54241922, "link": "https://stackoverflow.com/questions/54241922/why-am-i-getting-an-encoding-error-when-requiring-a-shared-object-compiled-from", "title": "Why am I getting an encoding error when requiring a shared object compiled from Rust on 32-bit Linux?", "body": "<p>Background: I am using <a href=\"https://github.com/tildeio/helix\" rel=\"nofollow noreferrer\">Helix</a> to write a native extension for Ruby, written in Rust.  On my 64bit MacBook Pro, everything works fine, I am experiencing this problem on a 32bit Linux machine (i686-unknown-linux-gnu).  The problem occurs regardless of the code in the Rust source.</p>\n\n<p>The shared object compiles fine, but if I try to require it, I invariably get an error like the following:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>`require': invalid symbol in encoding US-ASCII :\"(}\\xC3\\xBFtO\\xEE\\xB7\\xE0\\xEBi\\x01\\xAC|\\xC3\\xBF\\x18.\\x8D\\xB5\\xC6\\xC0\\x89\\xB5\\xFD\\xF1\\x8B\\xB5\\x80\\x8B\\x91\\x01\\x18.\\x8D\\xB5\\xB7\\xC0\\x89\\xB5\\xE0|\\xC3\\xBF\\xFA\\x8Ck\" (EncodingError)\n</code></pre>\n\n<p>On different invocations of Ruby, when I require the file, the binary string in the error message is different, which further perplexes me.</p>\n\n<h3>Steps to reproduce (required: <a href=\"https://github.com/tildeio/helix\" rel=\"nofollow noreferrer\">Helix</a>, Rust, Ruby, Bundler):</h3>\n\n<p>Note: I am using</p>\n\n<ul>\n<li>Helix 0.7.5</li>\n<li>cargo 1.30.0 (a1a4ad372 2018-11-02)</li>\n<li>rustc 1.30.1 (1433507eb 2018-11-07)</li>\n<li>ruby 2.6.0p0 (2018-12-25 revision 66547) [i686-linux]</li>\n<li>Bundler version 1.17.2</li>\n</ul>\n\n<p>But the same problem exists with the recommended versions from the Helix README, albeit compiled for 32 bit rather than 64 bit</p>\n\n<ul>\n<li>Helix 0.7.5</li>\n<li>cargo 0.18.0 (fe7b0cdcf 2017-04-24)</li>\n<li>rustc 1.17.0 (56124baa9 2017-04-24)</li>\n<li>ruby 2.4.1p111 (2017-03-22 revision 58053) [i686-linux]</li>\n<li>Bundler version 1.14.6</li>\n</ul>\n\n<pre class=\"lang-none prettyprint-override\"><code>mkdir repro\ncd repro/\nbundle init\necho 'gem \"helix-rails\"' &gt; Gemfile\nbundle\nhelix bootstrap example\ncd example\nbundle exec rake build\nbundle exec ruby lib/example.rb\n</code></pre>\n\n<p>I've also opened <a href=\"https://github.com/tildeio/helix/issues/163\" rel=\"nofollow noreferrer\">issue 163 on the tildeio/helix repo</a>.</p>\n"}, {"tags": ["rust", "traits"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547745580, "post_id": 54239972, "comment_id": 95306705, "body": "<i>create any extra code by chaining</i> \u2014 what does this mean? What code would be created, and how would chaining create code?"}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547777048, "post_id": 54239972, "comment_id": 95318040, "body": "If I returned a box, that would presumably create a box, and then dereference it later."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1547778641, "post_id": 54239972, "comment_id": 95318316, "body": "Why are you returning <code>Box</code>es from your constructors?"}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547779432, "post_id": 54239972, "comment_id": 95318473, "body": "I return Boxes because it was the only way I could find to get 2 structs to implement a trait and be able to have everything using just the trait. But if there&#39;s a better way, I&#39;d love to know about it."}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547780243, "post_id": 54239972, "comment_id": 95318621, "body": "I tried moving the <code>Box</code> out of the constuctors to the <code>get</code> function, but same result (as I expected)."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1547780314, "post_id": 54239972, "comment_id": 95318636, "body": "Yeah, it doesn&#39;t fix your problem, but returning the types themself and boxing them at the callside is more idiomatic rust. I&#39;m currently writing an answer explaining your actual problem. One minute :)."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1547780894, "post_id": 54239972, "comment_id": 95318762, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/39482131/155423\">Using impl Trait in Trait definition</a> / <a href=\"https://stackoverflow.com/q/30661046/155423\">How do I return an instance of a trait from a method?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/54239972/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547784196, "post_id": 54239972, "comment_id": 95319445, "body": "Thanks Shepmaster, the second of those was why I was using <code>Box</code>es in the first place. Based on <code>rustc --explain E0038</code> it appeared that I can&#39;t do what I want. But I see that Chronial has actually done it. I don&#39;t understand why it works ... but I&#39;m sure I can eventually do so. So, no, I don&#39;t think those links answer the question. Sorry if I was unclear."}], "answers": [{"comments": [{"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547784736, "post_id": 54247372, "comment_id": 95319550, "body": "Thanks! But I&#39;m quite confused about the details. From your preliminary comment, I assumed it was <code>put</code> that you were going to <code>impl</code> for <code>Box&lt;dyn RequestInfo&gt;</code> but for that you defined a helper function. The <code>put</code> function itself is marked as Self:Sized, which E0038 says: &quot;you can add a <code>where Self: Sized</code> bound on them to mark them as explicitly unavailable to trait objects. The functionality will still be available to all other implementers, including <code>Box&lt;Trait&gt;</code> which is itself sized (assuming you <code>impl Trait for Box&lt;Trait&gt;</code>)&quot; but it is available. Strange."}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547785224, "post_id": 54247372, "comment_id": 95319652, "body": "Then, I don&#39;t understand why the function implemented for <code>Box&lt;dyn RequestInfo&gt;</code> - does it simply trigger some recognition in the compiler, because I seem to be able to define all sorts of other &quot;virtual&quot; functions."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1547785259, "post_id": 54247372, "comment_id": 95319654, "body": "In a way I did implement <code>put</code> for <code>Box&lt;dyn RequestInfo&gt;</code>. It has a default implementation in the trait itself. That implementation is not available on unsized types (i.e. trait objects), but it is available on sized objects.(i.e. <code>Box&lt;ref RequestInfo&gt;</code>). Does this all make sense to you when you move the implementation of <code>put</code> from the trait to the <code>impl RequestInfo for Box&lt;dyn RequestInfo&gt;</code> block?"}, {"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1547788470, "post_id": 54247372, "comment_id": 95320336, "body": "@Chronial Ahh... any function that doesn&#39;t have an implementation in the the trait, needs one in the <code>Box&lt;dyn RequestInfo&gt;</code> block, even if all it does is dispatch to the ref&#39;ed struct (in fact, that&#39;s what they all should be). So the chaining adds an extra function call for each chain step (presumably the <code>as_ref()</code> gets inlined)."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "edited": false, "score": 0, "creation_date": 1547790447, "post_id": 54247372, "comment_id": 95320827, "body": "Correct. But the call to <code>pub</code> will also inlined (it is not using dynamic dispatch). I just tested this, and the chained version generates exactly the same assembler as  the unchained version: <a href=\"https://godbolt.org/z/CTZLNX\" rel=\"nofollow noreferrer\">godbolt.org/z/CTZLNX</a>"}], "tags": [], "owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "is_accepted": false, "score": 2, "last_activity_date": 1547782021, "creation_date": 1547782021, "answer_id": 54247372, "question_id": 54239972, "link": "https://stackoverflow.com/questions/54239972/how-can-i-return-a-trait-from-an-implementation-so-i-can-chain-calls/54247372#54247372", "title": "How can I return a trait from an implementation so I can chain calls?", "body": "<p>And now to the final step: You will have noticed that traits with methods that return <code>Self</code> <a href=\"https://doc.rust-lang.org/error-index.html#method-references-the-self-type-in-its-arguments-or-return-type\" rel=\"nofollow noreferrer\">can not be used as trait objects</a>. That link has a solution to your problem: mark that method with <code>where Self: Sized</code>, so it doesn't appear on your trait object. But then you can't do your chaining with trait objects. This can be solved by implementing the method on <code>Box&lt;dyn RequestInfo&gt;</code> \u2013 which is not a trait object, but a <code>Box</code>. So, putting this all together:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait RequestInfo {\n    fn logged_in(&amp;self) -&gt; bool;\n    fn put(&amp;mut self, string: String) -&gt; &amp;mut Self\n    where Self: Sized {\n        self.put_internal(string);\n        self\n    }\n    fn put_internal(&amp;mut self, string: String) {}\n}\nimpl RequestInfo for Box&lt;dyn RequestInfo&gt; {\n    fn logged_in(&amp;self) -&gt; bool {\n        self.as_ref().logged_in()\n    }\n}\n\nstruct LoggedOut {}\nimpl RequestInfo for LoggedOut {\n    fn logged_in(&amp;self) -&gt; bool {false}\n}\n\nstruct LoggedIn {output: Vec&lt;String&gt;}\nimpl LoggedIn {\n    fn new() -&gt; LoggedIn {\n        LoggedIn { output: Vec::new() }\n    }\n}\nimpl RequestInfo for LoggedIn {\n    fn logged_in(&amp;self) -&gt; bool {true}\n    fn put_internal(&amp;mut self, string: String) {\n        self.output.push(string);\n   }\n}\nfn get(flag: bool) -&gt; Box&lt;dyn RequestInfo&gt; {\n    if flag {Box::new(LoggedIn::new())} else {Box::new(LoggedOut{})}\n}\n\nfn main() {\n    let mut info = get(true);\n    info.put(\"abc\".to_string()).put(\"def\".to_string());\n}\n</code></pre>\n\n<p>You will have to decide if all of this is worth it for some chaining.</p>\n"}, {"comments": [{"owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1548168751, "post_id": 54259630, "comment_id": 95441550, "body": "Thanks! I don&#39;t know why someone down-voted this, but this is much nicer. I&#39;ll use this a lot as I spend my non-Rust time coding in Smalltalk, so I like objects (even trait objects having no inheritance), and I like cascading calls."}, {"owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "reply_to_user": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "edited": false, "score": 0, "creation_date": 1548196962, "post_id": 54259630, "comment_id": 95454859, "body": "You&#39;re welcome :). But you should probably be aware that this uses dynamic dispatch which will give you a tiny performance penalty on each chained call. But this should be negligible in most scenarios."}], "tags": [], "owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "is_accepted": true, "score": 1, "last_activity_date": 1547836161, "creation_date": 1547836161, "answer_id": 54259630, "question_id": 54239972, "link": "https://stackoverflow.com/questions/54239972/how-can-i-return-a-trait-from-an-implementation-so-i-can-chain-calls/54259630#54259630", "title": "How can I return a trait from an implementation so I can chain calls?", "body": "<p>I gave this some more thought and you can disregard my previous answer. That solution is unnecessarily complex. I got way to focused on returning <code>&amp;mut Self</code> from <code>put</code>, even though that wasn't asked for at all. You can just return <code>&amp;mut RequestInfo</code> from your <code>put</code> method and you're fine. The only price you pay is that you can't have a default implementation for <code>put</code> anymore.</p>\n\n<pre><code>pub trait RequestInfo {\n    fn put(self: &amp;mut Self, string: String) -&gt; &amp;mut dyn RequestInfo;\n}\n\nstruct LoggedOut {}\nimpl RequestInfo for LoggedOut {\n    fn put(self: &amp;mut Self, string: String) -&gt; &amp;mut dyn RequestInfo {\n        self\n    }\n}\n\nstruct LoggedIn {\n    output: Vec&lt;String&gt;,\n}\nimpl LoggedIn {\n    fn new() -&gt; LoggedIn {\n        LoggedIn { output: Vec::new() }\n    }\n}\nimpl RequestInfo for LoggedIn {\n     fn put(self: &amp;mut Self, string: String) -&gt; &amp;mut dyn RequestInfo {\n        self.output.push(string);\n        self\n    }\n}\n\nfn get(flag: bool) -&gt; Box&lt;dyn RequestInfo&gt; {\n    if flag {Box::new(LoggedIn::new())} else {Box::new(LoggedOut{})}\n}\n\n\nfn main() {\n    let mut info = get(false);\n    info.put(\"abc\".to_string()).put(\"def\".to_string());\n}\n</code></pre>\n"}], "owner": {"reputation": 355, "user_id": 1574106, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/b194afd8e8777547fff445a99c918296?s=128&d=identicon&r=PG", "display_name": "Dave Mason", "link": "https://stackoverflow.com/users/1574106/dave-mason"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1270, "favorite_count": 1, "accepted_answer_id": 54259630, "answer_count": 2, "score": 3, "last_activity_date": 1547956189, "creation_date": 1547741546, "last_edit_date": 1547780375, "question_id": 54239972, "link": "https://stackoverflow.com/questions/54239972/how-can-i-return-a-trait-from-an-implementation-so-i-can-chain-calls", "title": "How can I return a trait from an implementation so I can chain calls?", "body": "<p>I have a trait with a couple of implementations, and I want to return the object so I can chain calls.</p>\n\n<pre><code>pub trait RequestInfo {\n    fn logged_in(&amp;self) -&gt; bool;\n    fn put(&amp;mut self, string: String) -&gt; RequestInfo {\n        self\n    }\n}\n\nstruct LoggedOut {}\nimpl LoggedOut {\n    fn new() -&gt; Box&lt;RequestInfo&gt; {\n        Box::new(LoggedOut {})\n    }\n}\nimpl RequestInfo for LoggedOut {\n    fn logged_in(&amp;self) -&gt; bool {\n        false\n    }\n}\n\nstruct LoggedIn {\n    output: Vec&lt;String&gt;,\n}\nimpl LoggedIn {\n    fn new() -&gt; Box&lt;RequestInfo&gt; {\n        Box::new(LoggedIn { output: Vec::new() })\n    }\n}\nimpl RequestInfo for LoggedIn {\n    fn logged_in(&amp;self) -&gt; bool {\n        true\n    }\n    fn put(&amp;mut self, string: String) -&gt; impl RequestInfo {\n        self.output.push(string);\n        self\n    }\n}\n\nfn main() {\n    let mut info = LoggedIn::new();\n    info.put(\"abc\".to_string()).put(\"def\".to_string());\n}\n\n</code></pre>\n\n<p>I get errors:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0562]: `impl Trait` not allowed outside of function and inherent method return types\n  --&gt; src/main.rs:32:42\n   |\n32 |     fn put(&amp;mut self, string: String) -&gt; impl RequestInfo {\n   |                                          ^^^^^^^^^^^^^^^^\n\nerror[E0308]: mismatched types\n --&gt; src/main.rs:4:9\n  |\n3 |     fn put(&amp;mut self, string: String) -&gt; RequestInfo {\n  |                                          ----------- expected `(dyn RequestInfo + 'static)` because of return type\n4 |         self\n  |         ^^^^ expected trait RequestInfo, found &amp;mut Self\n  |\n  = note: expected type `(dyn RequestInfo + 'static)`\n             found type `&amp;mut Self`\n\nerror[E0277]: the size for values of type `(dyn RequestInfo + 'static)` cannot be known at compilation time\n --&gt; src/main.rs:3:42\n  |\n3 |     fn put(&amp;mut self, string: String) -&gt; RequestInfo {\n  |                                          ^^^^^^^^^^^ doesn't have a size known at compile-time\n  |\n  = help: the trait `std::marker::Sized` is not implemented for `(dyn RequestInfo + 'static)`\n  = note: to learn more, visit &lt;https://doc.rust-lang.org/book/second-edition/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait&gt;\n  = note: the return type of a function must have a statically known size\n</code></pre>\n\n<p>The only thing that might work is to <code>Box</code> self, like I do in the <code>new()</code> functions, but I don't want to create any extra code by chaining... which is really just a convenience anyway.</p>\n\n<p>Returning <code>&amp;mut Self</code> and using <code>Box&lt;impl RequestInfo&gt;</code> almost works.... except that I have a function that returns either a <code>LoggedIn</code> object or a <code>LoggedOut</code> object, so here's revised code:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>pub trait RequestInfo {\n    fn logged_in(&amp;self) -&gt; bool;\n    fn put(&amp;mut self, string: String) -&gt; &amp;mut Self {\n        self\n    }\n}\n\nstruct LoggedOut {}\nimpl LoggedOut {\n    fn new() -&gt; Box&lt;impl RequestInfo&gt; {\n        Box::new(LoggedOut {})\n    }\n}\nimpl RequestInfo for LoggedOut {\n    fn logged_in(&amp;self) -&gt; bool {\n        false\n    }\n}\n\nstruct LoggedIn {\n    output: Vec&lt;String&gt;,\n}\nimpl LoggedIn {\n    fn new() -&gt; Box&lt;impl RequestInfo&gt; {\n        Box::new(LoggedIn { output: Vec::new() })\n    }\n}\nimpl RequestInfo for LoggedIn {\n    fn logged_in(&amp;self) -&gt; bool {\n        true\n    }\n    fn put(&amp;mut self, string: String) -&gt; &amp;mut Self {\n        self.output.push(string);\n        self\n    }\n}\n\nfn get(flag: bool) -&gt; Box&lt;impl RequestInfo&gt; {\n    if flag {\n        return LoggedIn::new();\n    }\n    LoggedOut::new()\n}\n\nfn main() {\n    let mut info = get(true);\n    info.put(\"abc\".to_string()).put(\"def\".to_string());\n}\n</code></pre>\n\n<p>And it gives the following error (earlier in the function it returned a <code>LoggedIn</code> object):</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: mismatched types\n  --&gt; src/main.rs:42:5\n   |\n42 |     LoggedOut::new()\n   |     ^^^^^^^^^^^^^^^^ expected opaque type, found a different opaque type\n   |\n   = note: expected type `std::boxed::Box&lt;impl RequestInfo&gt;` (opaque type)\n              found type `std::boxed::Box&lt;impl RequestInfo&gt;` (opaque type)\n</code></pre>\n"}, {"tags": ["audio", "rust", "streaming", "mp3"], "comments": [{"owner": {"reputation": 302, "user_id": 7618662, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FRMsr.jpg?s=128&g=1", "display_name": "ThatOneDeveloper", "link": "https://stackoverflow.com/users/7618662/thatonedeveloper"}, "edited": false, "score": 0, "creation_date": 1547742659, "post_id": 54239713, "comment_id": 95305148, "body": "What crates are you using to read the audio and then stream it?"}, {"owner": {"reputation": 170, "user_id": 5892926, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8db427d11035a6cb73ba10186cef6564?s=128&d=identicon&r=PG&f=1", "display_name": "penalosa", "link": "https://stackoverflow.com/users/5892926/penalosa"}, "reply_to_user": {"reputation": 302, "user_id": 7618662, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FRMsr.jpg?s=128&g=1", "display_name": "ThatOneDeveloper", "link": "https://stackoverflow.com/users/7618662/thatonedeveloper"}, "edited": false, "score": 0, "creation_date": 1547743546, "post_id": 54239713, "comment_id": 95305621, "body": "None, just the standard library file methods to open the file, and TcpStream to stream the raw binary data"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1547747309, "post_id": 54239713, "comment_id": 95307537, "body": "Without a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> of what you currently have, we cannot do more than guessing. Please consider making one, including what you have attempted so far to solve the problem."}], "answers": [{"tags": [], "owner": {"reputation": 2041, "user_id": 1333724, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/acc5cea42dca926af89f94eb56fbbdbb?s=128&d=identicon&r=PG", "display_name": "maxm", "link": "https://stackoverflow.com/users/1333724/maxm"}, "is_accepted": false, "score": 0, "last_activity_date": 1547745170, "creation_date": 1547745170, "answer_id": 54241039, "question_id": 54239713, "link": "https://stackoverflow.com/questions/54239713/how-to-stream-audio-files-in-real-time/54241039#54241039", "title": "How to stream audio files in real time", "body": "<p>If you're sticking with http you could use chunked transfer encoding and delay sending the packets/chunks. This would indeed be something similar to hardcoded <code>thread::sleep</code> but you could use an event loop to determine when to send the next chunk instead of pausing the thread.</p>\n\n<p>You might run into timing issues though, maybe your sleep logic is causing longer delays than the runtime of the song. YouTube has similar logic to what you're talking about. It looks like they break videos into multiple http requests and the frontend client requests a new chunk when the buffer is too small. Breaking the file into multiple http body requests and then reassembling them at the client might have the characteristics you're looking for. </p>\n\n<p>You could simply implement the http <code>Range</code> header and allow the client to only request a specific <code>Range</code> of the mp3 file. <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\" rel=\"nofollow noreferrer\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests</a></p>\n"}, {"tags": [], "owner": {"reputation": 302, "user_id": 7618662, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FRMsr.jpg?s=128&g=1", "display_name": "ThatOneDeveloper", "link": "https://stackoverflow.com/users/7618662/thatonedeveloper"}, "is_accepted": false, "score": 0, "last_activity_date": 1547747559, "creation_date": 1547747559, "answer_id": 54241611, "question_id": 54239713, "link": "https://stackoverflow.com/questions/54239713/how-to-stream-audio-files-in-real-time/54241611#54241611", "title": "How to stream audio files in real time", "body": "<p>The easiest method (by far) would be to have the client request chunks of the audio file on demand. <code>std::net::TcpStream</code> (which is what you said you're using) doesn't have a method to throttle the transfer rate, so you don't have many options to limit streaming backend short of using hard-coded thread delays.</p>\n\n<p>As an example, you can have your client store a segment of audio, and when the user listening to the audio reaches a certain point before the end of the segment (or skips ahead), the client makes a request to the server to fetch the relevant segment.</p>\n\n<p>This is similar to how real-world streaming services (like Youtube) work, because as you said, it would be a bad idea to store the entire file client-side.</p>\n"}], "owner": {"reputation": 170, "user_id": 5892926, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8db427d11035a6cb73ba10186cef6564?s=128&d=identicon&r=PG&f=1", "display_name": "penalosa", "link": "https://stackoverflow.com/users/5892926/penalosa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 794, "favorite_count": 0, "answer_count": 2, "score": -1, "last_activity_date": 1547747559, "creation_date": 1547740717, "question_id": 54239713, "link": "https://stackoverflow.com/questions/54239713/how-to-stream-audio-files-in-real-time", "title": "How to stream audio files in real time", "body": "<p>I'm writing an audio streaming server - similar to Icecast, and I'm running into a problem with streaming audio files. Proxying audio works fine (an audio source connects and sends audio in real time, which is then transmitted to clients over HTTP), but when I try to stream an audio file it goes by to quickly - clients end up with the entire audio file within their local buffer. I want them to only have a few 10s of seconds in their local buffer.</p>\n\n<p>Essentially, how can I slow down the sending of an audio file over HTTP?\nThe files are all MP3. I've managed to get it pretty much working by experimenting with hardcoded thread delays etc... but that's not a sustainable solution.</p>\n"}, {"tags": ["rust", "lifetime", "type-alias"], "comments": [{"owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1547737128, "post_id": 54238520, "comment_id": 95301731, "body": "Is there a particular reason you are trying to push the reference in the type alias, rather than define the alias as <code>Peekable&lt;Iter&lt;MyStruct&gt;&gt;</code> and take a <code>&amp;mut MyIterator</code> as a parameter?"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1547737562, "post_id": 54238520, "comment_id": 95301997, "body": "You have not specified which <code>Iter</code> you are talking about, there are several types with that name in the standard library (e.g. <a href=\"https://doc.rust-lang.org/std/slice/struct.Iter.html\" rel=\"nofollow noreferrer\"><code>std::slice::Iter</code></a>). Nevertheless, note that each of the standard ones have a lifetime parameter, for keeping track of the original data&#39;s lifetime."}, {"owner": {"reputation": 190, "user_id": 5399309, "user_type": "registered", "accept_rate": 50, "profile_image": "https://graph.facebook.com/10201131262441304/picture?type=large", "display_name": "Jo&#235;l Abrahams", "link": "https://stackoverflow.com/users/5399309/jo%c3%abl-abrahams"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1547737737, "post_id": 54238520, "comment_id": 95302124, "body": "@E_net4wisheshappyholidays My bad, I added it to the question."}, {"owner": {"reputation": 190, "user_id": 5399309, "user_type": "registered", "accept_rate": 50, "profile_image": "https://graph.facebook.com/10201131262441304/picture?type=large", "display_name": "Jo&#235;l Abrahams", "link": "https://stackoverflow.com/users/5399309/jo%c3%abl-abrahams"}, "reply_to_user": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "edited": false, "score": 0, "creation_date": 1547737843, "post_id": 54238520, "comment_id": 95302188, "body": "@MatthieuM. Oh main reasoning is that it should always be a mutable reference as I want to always call the <code>next</code> method. Even when I omit this from the type alias however it complains about a lifetime parameter."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1547737882, "post_id": 54238520, "comment_id": 95302226, "body": "<code>Iter</code> needs a lifetime specified in the alias: <code>type MyIterator&lt;&#39;a&gt; = Peekable&lt;Iter&lt;&#39;a, MyStruct&gt;&gt;;</code> At this point I do not think you need to make it a mutable reference."}, {"owner": {"reputation": 190, "user_id": 5399309, "user_type": "registered", "accept_rate": 50, "profile_image": "https://graph.facebook.com/10201131262441304/picture?type=large", "display_name": "Jo&#235;l Abrahams", "link": "https://stackoverflow.com/users/5399309/jo%c3%abl-abrahams"}, "edited": false, "score": 0, "creation_date": 1547738487, "post_id": 54238520, "comment_id": 95302640, "body": "Yes true, also found out that I get issues with multiple mutable borrows if I do that."}], "answers": [{"comments": [{"owner": {"reputation": 190, "user_id": 5399309, "user_type": "registered", "accept_rate": 50, "profile_image": "https://graph.facebook.com/10201131262441304/picture?type=large", "display_name": "Jo&#235;l Abrahams", "link": "https://stackoverflow.com/users/5399309/jo%c3%abl-abrahams"}, "edited": false, "score": 0, "creation_date": 1547738242, "post_id": 54238823, "comment_id": 95302474, "body": "Oh how embarrassing, I looked at the definition of <code>Peekable</code> and not <code>Iter</code>. It works now, thank you!"}], "tags": [], "owner": {"reputation": 54931, "user_id": 758345, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/19136cbc4a30ad881e9d95275e9eb5a0?s=128&d=identicon&r=PG", "display_name": "Chronial", "link": "https://stackoverflow.com/users/758345/chronial"}, "is_accepted": true, "score": 2, "last_activity_date": 1547738236, "last_edit_date": 1547738236, "creation_date": 1547737790, "answer_id": 54238823, "question_id": 54238520, "link": "https://stackoverflow.com/questions/54238520/is-there-a-way-to-create-a-type-alias-of-a-stdsliceiter/54238823#54238823", "title": "Is there a way to create a type alias of a std::slice::Iter?", "body": "<p>I assume that Rust is just inferring the lifetime parameter for <code>Iter</code> in the function parameter context. But as <a href=\"https://stackoverflow.com/questions/54238520/is-there-a-way-to-create-a-typealias-of-an-iter-in-rust#comment95301997_54238520\">E_net4 hinted at in their comment</a>, the <code>Iter</code> you are probably using is defined as <code>Iter&lt;'a, T: 'a&gt;</code>. The correct type definition is:</p>\n\n<pre><code>type MyIterator&lt;'a&gt; = &amp;'a mut Peekable&lt;Iter&lt;'a, MyStruct&gt;&gt;;\n</code></pre>\n"}], "owner": {"reputation": 190, "user_id": 5399309, "user_type": "registered", "accept_rate": 50, "profile_image": "https://graph.facebook.com/10201131262441304/picture?type=large", "display_name": "Jo&#235;l Abrahams", "link": "https://stackoverflow.com/users/5399309/jo%c3%abl-abrahams"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 135, "favorite_count": 0, "accepted_answer_id": 54238823, "answer_count": 1, "score": 3, "last_activity_date": 1547738516, "creation_date": 1547736864, "last_edit_date": 1547738516, "question_id": 54238520, "link": "https://stackoverflow.com/questions/54238520/is-there-a-way-to-create-a-type-alias-of-a-stdsliceiter", "title": "Is there a way to create a type alias of a std::slice::Iter?", "body": "<p>I'm trying to create a type alias of a <a href=\"https://doc.rust-lang.org/std/iter/struct.Peekable.html\" rel=\"nofollow noreferrer\"><code>Peekable</code></a> <a href=\"https://doc.rust-lang.org/std/slice/struct.Iter.html\" rel=\"nofollow noreferrer\"><code>slice::Iter</code></a>, but the compiler keeps complaining that I need a lifetime parameter.</p>\n\n<p>This iterator is used in several places, and always iterates over the same type. To make the code more concise, I would like to use a type alias.</p>\n\n<p>I have already tried (code examples below):</p>\n\n<ul>\n<li>Adding a lifetime parameter to the struct it is iterating over, and pass this as the argument to the generic, to no avail.</li>\n<li>Adding a lifetime parameter inside the iterator</li>\n</ul>\n\n\n\n<pre><code>use std::{iter::Peekable, slice::Iter};\n\npub struct MyStruct {\n    pub arg1: i32,\n    pub arg2: i32,\n    pub arg3: MyEnum,\n}\n\npub enum MyEnum {\n    Default,\n}\n\n// mutable since I want to call .peek() and .next() on my iterator\ntype MyIterator&lt;'a&gt; = &amp;'a mut Peekable&lt;Iter&lt;MyStruct&gt;&gt;;\n</code></pre>\n\n<p>Notice that the above works just fine if I don't use a type alias, i.e. I use it directly in code:</p>\n\n<pre><code>pub fn my_fn(it: &amp;mut Peekable&lt;Iter&lt;MyStruct&gt;&gt;) -&gt; i32 { /* ... */ }\n</code></pre>\n\n<p>I keep getting the following error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0106]: missing lifetime specifier\n  --&gt; src/lib.rs:14:40\n   |\n14 | type MyIterator&lt;'a&gt; = &amp;'a mut Peekable&lt;Iter&lt;MyStruct&gt;&gt;;\n   |                                        ^^^^^^^^^^^^^^ expected lifetime parameter\n</code></pre>\n\n<p>I have also tried:</p>\n\n<ul>\n<li><code>...  = &amp;'a Peekable&lt;Iter&lt;&amp;'a MyStruct&gt;&gt;;</code></li>\n<li><code>...  = &amp;'a Peekable&lt;Iter&lt;MyStruct+ 'a&gt;&gt;;</code> </li>\n</ul>\n\n<p>Neither work, even when adding a lifetime parameter to the <code>MyStruct</code>. I don't really understand how Rust wants me to define the lifetime parameter. (In general I don't fully understand this concept yet as I just started programming in Rust)</p>\n"}, {"tags": ["data-structures", "rust", "mutability", "interior-mutability"], "comments": [{"owner": {"reputation": 36513, "user_id": 752976, "user_type": "registered", "accept_rate": 84, "profile_image": "https://i.stack.imgur.com/j7Uis.jpg?s=128&g=1", "display_name": "Bartek Banachewicz", "link": "https://stackoverflow.com/users/752976/bartek-banachewicz"}, "edited": false, "score": 5, "creation_date": 1547734861, "post_id": 54237610, "comment_id": 95300369, "body": "Converting an immutable reference to a mutable one is pretty much never a good idea. You should borrow as mutable in the first place."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 3, "creation_date": 1547734946, "post_id": 54237610, "comment_id": 95300436, "body": "Or else use interior mutability in your data structure, with something like <code>RefCell</code>."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 3, "creation_date": 1547736785, "post_id": 54237610, "comment_id": 95301503, "body": "You might want to look at <a href=\"https://cglab.ca/~abeinges/blah/too-many-lists/book/\" rel=\"nofollow noreferrer\">Learning Rust with entirely too many linked lists</a>"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 3, "creation_date": 1547737508, "post_id": 54237610, "comment_id": 95301963, "body": "I don&#39;t think the downvotes are warranted. No, you can&#39;t do this without UB, but it&#39;s not an unreasonable question -- especially for a user coming from a language like C++ where <code>const</code>ness is really more of a <i>suggestion</i> than a <i>rule</i>."}, {"owner": {"reputation": 121669, "user_id": 56778, "user_type": "registered", "accept_rate": 93, "profile_image": "https://www.gravatar.com/avatar/34b152ef95a49568ce45df38cd87e54b?s=128&d=identicon&r=PG", "display_name": "Jim Mischel", "link": "https://stackoverflow.com/users/56778/jim-mischel"}, "edited": false, "score": 3, "creation_date": 1547741915, "post_id": 54237610, "comment_id": 95304687, "body": "Translation: &quot;Is it possible to shoot myself in the head?&quot;"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1547798082, "post_id": 54237610, "comment_id": 95323538, "body": "@trentcl even in C++ removing the const is UB <a href=\"https://en.cppreference.com/w/cpp/language/const_cast#Notes\" rel=\"nofollow noreferrer\">en.cppreference.com/w/cpp/language/const_cast#Notes</a>"}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547814455, "post_id": 54237610, "comment_id": 95331871, "body": "@hellow From that page: &quot;Modifying a const object through a non-const access path [...] results in undefined behavior.&quot; In C++ you can trigger UB by <i>modifying</i> a const object through a non-const pointer. In Rust you can trigger UB whether or not the referent is const, even <i>without</i> trying to modify it, because you can violate aliasing assumptions. This is not the case in C++ (unless perhaps you invoke C99-esque <code>restrict</code> pointers, but not the case of <code>const_cast</code>, anyway)."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1547814600, "post_id": 54237610, "comment_id": 95331941, "body": "Or, put another way: <code>const_cast</code> is valid to do <i>sometimes</i>. Casting <code>&amp;T</code> to <code>&amp;mut T</code> is valid <i>never</i>."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547816206, "post_id": 54237610, "comment_id": 95332762, "body": "Ah okay, I got that, sorry :)"}, {"owner": {"reputation": 118, "user_id": 5878035, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a659cd8d50fd9529d899c27fc71cd295?s=128&d=identicon&r=PG", "display_name": "Aylei", "link": "https://stackoverflow.com/users/5878035/aylei"}, "edited": false, "score": 0, "creation_date": 1547821441, "post_id": 54237610, "comment_id": 95335684, "body": "Thanks all you guys (comments guideline told me not to comment for complimenting, but upvotes just cannot fully express my gratitude). I feel like I am dumber when I write Rust, but you guys show me why Rust was designed that way and the friendliness of the community. This inspired to learn more in Rust and thinking in the Rust way, then I can help someone like me someday ;)"}], "answers": [{"comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 5, "creation_date": 1547738089, "post_id": 54238460, "comment_id": 95302371, "body": "The <a href=\"https://doc.rust-lang.org/nomicon/transmutes.html\" rel=\"nofollow noreferrer\">Nomicon</a> has a related passage which I appreciate very much: <i>&quot;transmuting an &amp; to &amp;mut is UB; Transmuting an &amp; to &amp;mut is always UB; No you can&#39;t do it; No you&#39;re not special&quot;</i>"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 8, "last_activity_date": 1547736675, "creation_date": 1547736675, "answer_id": 54238460, "question_id": 54237610, "link": "https://stackoverflow.com/questions/54237610/is-there-a-way-to-make-an-immutable-reference-mutable/54238460#54238460", "title": "Is there a way to make an immutable reference mutable?", "body": "<blockquote>\n  <p>Is there a way to make an immutable reference mutable?</p>\n</blockquote>\n\n<p>No.</p>\n\n<p>You could write unsafe Rust code to force the types to line up, but the code would actually be unsafe and lead to <em>undefined behavior</em>. You do not want this.</p>\n\n<hr>\n\n<p>For your specific problem, see:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/53242052/155423\">How to remove the Nth node from the end of a linked list?</a></li>\n<li><a href=\"https://stackoverflow.com/q/54027704/155423\">How to use two pointers to iterate a linked list in Rust?</a></li>\n</ul>\n"}, {"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1547750330, "post_id": 54242058, "comment_id": 95308957, "body": "This answer is misleading. In Rust, unlike C/C++, it&#39;s unsound just to convert a <code>&amp;</code> reference into a <code>&amp;mut</code> reference even if the underlying object could be mutated. This is because <code>&amp;mut</code> references are like <code>restrict</code>-qualified pointers in C, and casting a <code>T*</code> to a <code>T* restrict</code> can lead to undefined behavior as the compiler is allowed to optimize loads and stores based around the <code>restrict</code> assumption."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1547750671, "post_id": 54242058, "comment_id": 95309100, "body": "In other words, the answer to <a href=\"https://stackoverflow.com/questions/9079104/is-it-undefined-behaviour-to-cast-away-the-constness-of-a-function-parameter\">this question</a> does not apply in Rust. More than guaranteeing the referent is mutable, you have to guarantee the <code>&amp;T</code> is <i>unaliased</i>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1547751273, "post_id": 54242058, "comment_id": 95309381, "body": "This function is <b>undefined behavior</b>; there is <b>no</b> possible usage of it that is safe to use. <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=10369463c3af5edd7f4d2bd3048ab8cc\" rel=\"nofollow noreferrer\">Try running it with Miri</a>. There&#39;s a reason my answer did not provide the code that can never be safely used."}, {"owner": {"reputation": 302, "user_id": 7618662, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FRMsr.jpg?s=128&g=1", "display_name": "ThatOneDeveloper", "link": "https://stackoverflow.com/users/7618662/thatonedeveloper"}, "edited": false, "score": 0, "creation_date": 1547753975, "post_id": 54242058, "comment_id": 95310614, "body": "This answer was meant to show why this undefined behavior, I wasn&#39;t trying to suggest this should ever be used."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1547772479, "post_id": 54242058, "comment_id": 95317150, "body": "<i>show why this undefined behavior</i> \u2014 you cannot show that something is undefined behavior. By definition, UB means that anything can happen. Running that code is allowed to erase your hard drive or summon nasal demons. The fact that it happens to segfault is basically luck."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 3, "creation_date": 1547775424, "post_id": 54242058, "comment_id": 95317722, "body": "The assumption &quot;If you run this... you get a segfault&quot; suggests that the compiler is actually bound to compile the code to something <i>meaningful, but incorrect given the values provided at runtime</i>. In fact, <code>very_bad_function</code> may not be compiled to anything meaningful at all, as the optimizer may make assumptions about reachability based on the non-aliasing of <code>&amp;mut T</code>. Breaking aliasing rules is not an <i>extra</i> reason &quot;in addition to&quot; the problem of writing to read-only memory -- it&#39;s the <i>only</i> reason why this code has undefined behavior..."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1547775470, "post_id": 54242058, "comment_id": 95317732, "body": "... since, in order to claim the code writes to read-only memory, you have to believe that it has a meaningful translation into machine code, which it does not."}], "tags": [], "owner": {"reputation": 302, "user_id": 7618662, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/FRMsr.jpg?s=128&g=1", "display_name": "ThatOneDeveloper", "link": "https://stackoverflow.com/users/7618662/thatonedeveloper"}, "is_accepted": false, "score": 3, "last_activity_date": 1547754489, "last_edit_date": 1547754489, "creation_date": 1547749382, "answer_id": 54242058, "question_id": 54237610, "link": "https://stackoverflow.com/questions/54237610/is-there-a-way-to-make-an-immutable-reference-mutable/54242058#54242058", "title": "Is there a way to make an immutable reference mutable?", "body": "<p>The correct answer is that you <strong>should not</strong> be doing this. This is undefined behavior, and breaks many assumptions made by the compiler when compiling your program.</p>\n\n<p>However, <strong>it is possible</strong> to do this. Other people have also mentioned why this is not a good idea, but they haven't actually shown what the code to do something like this would look like. Even though you should <strong>not do this</strong>, this is what it would look like:</p>\n\n<pre><code>unsafe fn very_bad_function&lt;T&gt;(reference: &amp;T) -&gt; &amp;mut T {\n    let const_ptr = reference as *const T;\n    let mut_ptr = const_ptr as *mut T;\n    &amp;mut *mut_ptr\n}\n</code></pre>\n\n<p>Essentially, you convert a constant pointer into a mutable one, and then make the mutable pointer into a reference.</p>\n\n<p>Here's one example why this is very unsafe and unpredictable:</p>\n\n<pre><code>fn main() {\n    static THIS_IS_IMMUTABLE: i32 = 0;\n    unsafe {\n        let mut bad_reference = very_bad_function(&amp;THIS_IS_IMMUTABLE);\n        *bad_reference = 5;\n    }\n}\n</code></pre>\n\n<p>If you run this... you get a segfault. What happened? Essentially, you invalidated memory rules by trying to write to an area of memory that had been marked as immutable. Essentially, when you use a function like this, you break the trust the compiler has made with you to not mess with constant memory.</p>\n\n<p>Which is why you should never use this, <strong>especially in a public API</strong>, because if someone passes an innocent immutable reference to your function, and your function mutates it, and the reference is to an area of memory not meant to be written to, you'll get a segfault.</p>\n\n<p>In short: don't try to cheat the borrow checker. It's there for a reason.</p>\n\n<p>EDIT: In addition to the reasons I just mentioned on why this is undefined behavior, another reason is breaking reference aliasing rules. That is, since you can have both a mutable and immutable reference to a variable at the same time with this, it causes loads of problems when you pass them in separately to the same function, which assumes the immutable and mutable references are unique. Read <a href=\"https://doc.rust-lang.org/nomicon/aliasing.html\" rel=\"nofollow noreferrer\">this page</a> from the Rust docs for more information about this.</p>\n"}], "owner": {"reputation": 118, "user_id": 5878035, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a659cd8d50fd9529d899c27fc71cd295?s=128&d=identicon&r=PG", "display_name": "Aylei", "link": "https://stackoverflow.com/users/5878035/aylei"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3389, "favorite_count": 1, "accepted_answer_id": 54238460, "answer_count": 2, "score": 3, "last_activity_date": 1547754489, "creation_date": 1547733803, "last_edit_date": 1547737682, "question_id": 54237610, "link": "https://stackoverflow.com/questions/54237610/is-there-a-way-to-make-an-immutable-reference-mutable", "title": "Is there a way to make an immutable reference mutable?", "body": "<p>I want to solve a leetcode question in Rust (<a href=\"https://leetcode.com/problems/remove-nth-node-from-end-of-list/\" rel=\"nofollow noreferrer\">Remove Nth Node From End of List</a>). My solution uses two pointers to find the <code>Node</code> to remove:</p>\n\n<pre><code>#[derive(PartialEq, Eq, Debug)]\npub struct ListNode {\n    pub val: i32,\n    pub next: Option&lt;Box&lt;ListNode&gt;&gt;,\n}\n\nimpl ListNode {\n    #[inline]\n    fn new(val: i32) -&gt; Self {\n        ListNode { next: None, val }\n    }\n}\n\n// two-pointer sliding window\nimpl Solution {\n    pub fn remove_nth_from_end(head: Option&lt;Box&lt;ListNode&gt;&gt;, n: i32) -&gt; Option&lt;Box&lt;ListNode&gt;&gt; {\n        let mut dummy_head = Some(Box::new(ListNode { val: 0, next: head }));\n        let mut start = dummy_head.as_ref();\n        let mut end = dummy_head.as_ref();\n        for _ in 0..n {\n            end = end.unwrap().next.as_ref();\n        }\n        while end.as_ref().unwrap().next.is_some() {\n            end = end.unwrap().next.as_ref();\n            start = start.unwrap().next.as_ref();\n        }\n        // TODO: fix the borrow problem\n        // ERROR!\n        // start.unwrap().next = start.unwrap().next.unwrap().next.take();\n        dummy_head.unwrap().next\n    }\n}\n</code></pre>\n\n<p>I borrow two immutable references of the linked-list. After I find the target node to remove, I want to drop one and make the other mutable. Each of the following code examples leads to a compiler error: </p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>// ERROR\ndrop(end); \nlet next = start.as_mut().unwrap.next.take();\n\n// ERROR\nlet mut node = *start.unwrap()\n</code></pre>\n\n<p>I don't know if this solution is possible to be written in Rust. If I can make an immutable reference mutable, how do I do it? If not, is there anyway to implement the same logic while making the borrow checker happy?</p>\n"}, {"tags": ["generics", "hashmap", "rust"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547721538, "post_id": 54233898, "comment_id": 95292870, "body": "Related: <a href=\"https://stackoverflow.com/questions/26212397/references-to-traits-in-structs\" title=\"references to traits in structs\">stackoverflow.com/questions/26212397/&hellip;</a>"}, {"owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1547722774, "post_id": 54233898, "comment_id": 95293603, "body": "This link is indeed related but doesn&#39;t solve the problem of defining a struct member which is a trait with associated type"}], "answers": [{"comments": [{"owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "edited": false, "score": 0, "creation_date": 1547749135, "post_id": 54235563, "comment_id": 95308362, "body": "Thanks for your answer! Say I want to go with the suggestion (1) of introducing a type parameter to <code>MyDB</code>, how would I implement a constructor for <code>MyDB</code>? (e.g <code>MyDB::new()</code>)"}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 2, "last_activity_date": 1547727545, "last_edit_date": 1547727545, "creation_date": 1547726748, "answer_id": 54235563, "question_id": 54233898, "link": "https://stackoverflow.com/questions/54233898/struct-members-who-are-traits-that-use-associated-types/54235563#54235563", "title": "Struct members who are traits that use associated types", "body": "<p><strong>tl;dr: this isn't possible.</strong></p>\n\n<p>First of all, this is not valid:</p>\n\n<pre><code>struct MyDB {\n    hash_container: HashMapContainer\n}\n</code></pre>\n\n<p><code>HashMapContainer</code> is a trait, but you are trying to use it as a type. Instead, you would need to either (1) introduce a type parameter, constrained by the trait:</p>\n\n<pre><code>struct MyDB&lt;H: HashMapContainer&gt; {\n    hash_container: H,\n}\n</code></pre>\n\n<p>Or (2) use a trait object, for example in a <code>Box</code>:</p>\n\n<pre><code>struct MyDB {\n    hash_container: Box&lt;dyn HashMapContainer&gt;,\n}\n</code></pre>\n\n<p>Each of these approaches has different trade-offs. Using the type parameter will fix the type to something that must be known at compile time. The trait object would be more flexible because the concrete type can change at runtime, but has some performance implications as well as some restrictions on the trait and how it is used.</p>\n\n<p>Since you want to pick the implementation of <code>HashMapContainer</code> at runtime, based on a string value, you <em>have to</em> go with the trait object route. However, since the concrete type is only known at runtime, the associated type would only be known at runtime too. This means compiler won't be able to type-check anything involving the associated type.</p>\n\n<p>Essentially, your combined requirements; dynamically changing the trait implementation and relying on the trait's associated type; are incompatible.</p>\n\n<p>If you could fix the associated type, so it was always the same, then this could work:</p>\n\n<pre><code>struct MyDB {\n    hash_container: Box&lt;dyn HashMapContainer&lt;Value = SomeType&gt;&gt;,\n}\n</code></pre>\n\n<p>Alternatively, if you are willing to limit implementations of the trait to a fixed set of known types, then you can encode them in an enum.</p>\n\n<p>The actual answer here will depend on your real-world requirements and where you are able to bend them.</p>\n"}], "owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 93, "favorite_count": 0, "answer_count": 1, "score": 0, "last_activity_date": 1547727545, "creation_date": 1547721015, "last_edit_date": 1547721237, "question_id": 54233898, "link": "https://stackoverflow.com/questions/54233898/struct-members-who-are-traits-that-use-associated-types", "title": "Struct members who are traits that use associated types", "body": "<p>I have a follow up question to this question: <a href=\"https://stackoverflow.com/questions/54231775/expose-a-hashmap-in-a-generic-way-that-disregards-the-hashmap-value\">Expose a HashMap in a generic way that disregards the HashMap value</a></p>\n\n<p>Suppose I want to use <code>HashMapContainer</code> (the same one that was defined in the previous question's first answer) as a member in another struct (let's call it <code>MyDB</code>) and in <code>MyDB</code> constructor I want to decide whether to construct this member as <code>HashMapContainerImpl1</code> or <code>HashMapContainerImpl2</code>. I don't want to define <code>MyDB</code> as a template (e.g <code>MyDB&lt;T&gt;</code>) because <code>MyDB</code> users don't care about the value of the <code>HashMap</code> (<code>MyDB</code> constructor will decide about that). What is the right way to implement that?</p>\n\n<p>Here is a sample code of what I want to achieve (it doesn't compile):</p>\n\n<pre><code>pub trait HashMapContainer {\n    type Value;\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, Self::Value&gt;;\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, Self::Value&gt;;\n}\n\nstruct MyDB {\n    hash_container: HashMapContainer\n}\n\nimpl MyDB {\n    pub fn new(hash_value_type: &amp;str) -&gt; MyDB {\n        // have a logic to set hash_container to either \n        // HashMapContainerImpl1 or HashMapContainerImpl2\n        // according to hash_value_type\n    }\n\n    pub fn count_keys(&amp;self) -&gt; usize {\n        self.hash_container.get_hash_map().len()\n    }\n}\n\nfn main() {\n    let db = MyDB::new();\n    println!(\"key count: {}\", db.count_keys());\n}\n</code></pre>\n"}, {"tags": ["hashmap", "rust"], "answers": [{"comments": [{"owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "edited": false, "score": 0, "creation_date": 1547719565, "post_id": 54231903, "comment_id": 95291616, "body": "I have a follow up question: suppose I want to use <code>HashMapContainer</code> as a member in another struct (let&#39;s call it <code>MyDB</code>) and in <code>MyDB</code> constructor I want to decide whether to construct this member as <code>HashMapContainerImpl1</code> or <code>HashMapContainerImpl2</code>. I don&#39;t want to define <code>MyDB</code> as a template (e.g <code>MyDB&lt;T&gt;</code>) because <code>MyDB</code> users don&#39;t care about the value of the HashMap, <code>MyDB</code> constructor will decide about that. What is the right way to implement that?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "reply_to_user": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "edited": false, "score": 0, "creation_date": 1547719893, "post_id": 54231903, "comment_id": 95291833, "body": "Use a enum with two variants, one for <code>Impl1</code> and one for <code>Impl2</code>. For the future, please ask a new question and refer to this one :)"}, {"owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "edited": false, "score": 0, "creation_date": 1547721056, "post_id": 54231903, "comment_id": 95292563, "body": "I just did, thanks for this comment: <a href=\"https://stackoverflow.com/questions/54233898/struct-members-who-are-traits-that-use-associated-types\" title=\"struct members who are traits that use associated types\">stackoverflow.com/questions/54233898/&hellip;</a>. Could you please provide a more detailed answer there?"}], "tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": true, "score": 2, "last_activity_date": 1547738792, "last_edit_date": 1547738792, "creation_date": 1547714307, "answer_id": 54231903, "question_id": 54231775, "link": "https://stackoverflow.com/questions/54231775/expose-a-hashmap-in-a-generic-way-that-disregards-the-hashmap-value/54231903#54231903", "title": "Expose a HashMap in a generic way that disregards the HashMap value", "body": "<h1>With an associated type</h1>\n\n<p>The code below using a generic is correct, but after thinking about it, I think that using an associated type might be more suitable here. The trait should look like this:</p>\n\n<pre><code>pub trait HashMapContainer {\n    type Value;\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, Self::Value&gt;;\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, Self::Value&gt;;\n}\n</code></pre>\n\n<p>The difference is, that you now can only implement the trait once for a struct and not multiple times, which is <em>more correct</em> in this case.</p>\n\n<p>The implementations are roughly the same as with the generic type parameter.</p>\n\n<pre><code>impl HashMapContainer for HashMapContainerImpl1 {\n    type Value = String;\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, Self::Value&gt; {\n        &amp;self.map\n    }\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, Self::Value&gt; {\n        &amp;mut self.map\n    }\n}\n\nimpl HashMapContainer for HashMapContainerImpl2 {\n    type Value = u8;\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, Self::Value&gt; {\n        &amp;self.map\n    }\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, Self::Value&gt; {\n        &amp;mut self.map\n    }\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=88b36b1b977de3771773782ef1dece83\" rel=\"nofollow noreferrer\">Playground</a>)</p>\n\n<p>You can also look at <a href=\"https://stackoverflow.com/questions/32059370/when-is-it-appropriate-to-use-an-associated-type-versus-a-generic-type\">When is it appropriate to use an associated type versus a generic type?</a> which explains the difference between those two pretty good.</p>\n\n<h1>With a generic type</h1>\n\n<p>This is solvable by introducing a generic type in your <code>HashMapContainer</code> trait.</p>\n\n<pre><code>pub trait HashMapContainer&lt;T&gt; {\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, T&gt;;\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, T&gt;;\n}\n</code></pre>\n\n<p>I changed the signature to return a reference to the <code>HashMap</code>. It would be possible to do it without, e.g. by using <code>clone</code> or taking <code>self</code> as value, instead of as reference. I also introduced a <code>_mut</code> version.</p>\n\n<p>The implementation is straight foreword:</p>\n\n<pre><code>impl HashMapContainer&lt;String&gt; for HashMapContainerImpl1 {\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, String&gt; {\n        &amp;self.map\n    }\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, String&gt; {\n        &amp;mut self.map\n    }\n}\n\nimpl HashMapContainer&lt;u8&gt; for HashMapContainerImpl2 {\n    fn get_hash_map(&amp;self) -&gt; &amp;HashMap&lt;String, u8&gt; {\n        &amp;self.map\n    }\n    fn get_hash_map_mut(&amp;mut self) -&gt; &amp;mut HashMap&lt;String, u8&gt; {\n        &amp;mut self.map\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 552, "user_id": 5007125, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/QbIq9.jpg?s=128&g=1", "display_name": "seladb", "link": "https://stackoverflow.com/users/5007125/seladb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 109, "favorite_count": 0, "accepted_answer_id": 54231903, "answer_count": 1, "score": 1, "last_activity_date": 1547738792, "creation_date": 1547713795, "last_edit_date": 1547738645, "question_id": 54231775, "link": "https://stackoverflow.com/questions/54231775/expose-a-hashmap-in-a-generic-way-that-disregards-the-hashmap-value", "title": "Expose a HashMap in a generic way that disregards the HashMap value", "body": "<p>I have different structs which all contain a <code>HashMap</code> with <code>String</code> as the key, but with different value types. For example, one struct has a member of type <code>HashMap&lt;String, String&gt;</code>, the other will have a member of type <code>HashMap&lt;String, u8&gt;</code>, and so on.</p>\n\n<p>I want to define a method that can access these <code>HashMap</code> members and do generic actions on them that don't involve the value. For example, I want to count the number of keys, remove a key, check if a key exists, etc. I'm not sure how to implement this behavior.</p>\n\n<p>The best way I had in mind so far is to define a trait that has a method that exposes the <code>HashMap</code> and let each struct implement it. However I don't know how to write this trait and method in a way that \"ignores\" the value type. I tried using a wildcard (<code>_</code>) but it doesn't work. How do I implement this? </p>\n\n<p>Here is my code (which doesn't compile):</p>\n\n<pre><code>use std::collections::HashMap;\n\npub trait HashMapContainer {\n    fn get_hash_map(&amp;self) -&gt; HashMap&lt;String, _&gt;;\n}\n\nstruct HashMapContainerImpl1 {\n    map: HashMap&lt;String, String&gt;,\n}\n\nimpl HashMapContainerImpl1 {\n    pub fn new() -&gt; HashMapContainerImpl1 {\n        HashMapContainerImpl1 {\n            map: HashMap::new(),\n        }\n    }\n\n    fn internal_logic_on_map(&amp;mut self) {\n        //....\n    }\n}\n\nimpl HashMapContainer for HashMapContainerImpl1 {\n    fn get_hash_map(&amp;self) -&gt; HashMap&lt;String, _&gt; {\n        self.map\n    }\n}\n\nstruct HashMapContainerImpl2 {\n    map: HashMap&lt;String, u8&gt;,\n}\n\nimpl HashMapContainerImpl2 {\n    pub fn new() -&gt; HashMapContainerImpl2 {\n        HashMapContainerImpl2 {\n            map: HashMap::new(),\n        }\n    }\n\n    fn internal_logic_on_map(&amp;mut self) {\n        //....\n    }\n}\n\nimpl HashMapContainer for HashMapContainerImpl2 {\n    fn get_hash_map(&amp;self) -&gt; HashMap&lt;String, _&gt; {\n        self.map\n    }\n}\n\nfn do_generic_actions_on_map(hm_container: &amp;HashMapContainer) {\n    println!(\"key count: {}\", hm_container.get_hash_map().len());\n    println!(\n        \"key esists? {}\",\n        hm_container.get_hash_map().get(\"key1\").is_some()\n    );\n    hm_container.get_hash_map().remove(\"key2\");\n}\n\nfn main() {\n    let cont1 = HashMapContainerImpl1::new();\n    let cont2 = HashMapContainerImpl2::new();\n    do_generic_actions_on_map(cont1);\n    do_generic_actions_on_map(cont2);\n}\n</code></pre>\n"}, {"tags": ["rust", "rust-cargo"], "answers": [{"comments": [{"owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "edited": false, "score": 0, "creation_date": 1548911337, "post_id": 54450061, "comment_id": 95715571, "body": "Thanks @kbknapp. I had done it the same way without any issues."}], "tags": [], "owner": {"reputation": 126, "user_id": 3281907, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/167b5d70056ea34fa24058a251d63964?s=128&d=identicon&r=PG", "display_name": "kbknapp", "link": "https://stackoverflow.com/users/3281907/kbknapp"}, "is_accepted": true, "score": 1, "last_activity_date": 1548884940, "creation_date": 1548884940, "answer_id": 54450061, "question_id": 54230418, "link": "https://stackoverflow.com/questions/54230418/can-i-do-a-cargo-build-with-debug-symbols-as-well-as-release-flag/54450061#54450061", "title": "Can I do a cargo build with debug symbols as well as release flag?", "body": "<p>Compiling with <code>--release</code>, and having a <code>Cargo.toml</code></p>\n\n<pre><code>[profile.release]\ndebug=True\n</code></pre>\n\n<p>And will indeed include debug symbols as well as perform optimizations. The two are not contradictory.</p>\n\n<p>The <code>[profile.release]</code> table of your <code>Cargo.toml</code> only tells <code>cargo</code> what configuration options you'd like to use when you pass the <code>--release</code> flag. Other options include tuning LTO, optimization levels, and enabling/disabling rpath.</p>\n"}], "owner": {"reputation": 2512, "user_id": 5808553, "user_type": "registered", "accept_rate": 64, "profile_image": "https://www.gravatar.com/avatar/6be8254e63e22cc820bb14938d532814?s=128&d=identicon&r=PG&f=1", "display_name": "Rajeev Ranjan", "link": "https://stackoverflow.com/users/5808553/rajeev-ranjan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 781, "favorite_count": 0, "closed_date": 1595353319, "accepted_answer_id": 54450061, "answer_count": 1, "score": 0, "last_activity_date": 1595352399, "creation_date": 1547707660, "last_edit_date": 1595352399, "question_id": 54230418, "link": "https://stackoverflow.com/questions/54230418/can-i-do-a-cargo-build-with-debug-symbols-as-well-as-release-flag", "closed_reason": "Duplicate", "title": "Can I do a cargo build with debug symbols as well as release flag?", "body": "<p>I am debugging my cargo project. I build it using <code>--release</code> flag generally. But when I saw the stack trace in gdb, it was not very readable. I figured out that I could <a href=\"https://doc.rust-lang.org/cargo/reference/manifest.html#the-profile-sections\" rel=\"nofollow noreferrer\">create debug symbols</a> with <code>debug=true</code> in Cargo.toml. </p>\n\n<p>Can I still use <code>--release</code> flag with cargo build ? Are these not contradicting? This is what the terminal help for the flag says - </p>\n\n<blockquote>\n  <p>--release Build artifacts in release mode, with optimizations</p>\n</blockquote>\n\n<p>I ask this for clarity beforehand as a debug run takes several hours for me to hit the issue.</p>\n"}, {"tags": ["rust", "lifetime", "temporary"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 3, "creation_date": 1547706815, "post_id": 54229893, "comment_id": 95285386, "body": "The compiler literally tells you what&#39;s wrong: <code>temporary value is freed at the end of this statement</code>, <code>creates a temporary which is freed while still in use</code> and <code>borrow later used here</code>. I think the error message is pretty clear. If not, please tell us, what you are you understanding."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 2, "creation_date": 1547719547, "post_id": 54229893, "comment_id": 95291607, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/28469667/borrowed-value-does-not-live-long-enough-when-using-the-builder-pattern\">&quot;borrowed value does not live long enough&quot; when using the builder pattern</a>"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1547724609, "post_id": 54229893, "comment_id": 95294574, "body": "I don&#39;t think that the duplicate applies, since here the temporary <b>could</b> be dropped without trouble if it wasn&#39;t prevented by a wrong explicit lifetime."}], "answers": [{"comments": [{"owner": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1547709664, "post_id": 54230289, "comment_id": 95286530, "body": "@AndersKaseorg I would like to read if  there is a reference or documentation for the roughly  interpretation that you mentioned?"}, {"owner": {"reputation": 3054, "user_id": 115030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15c74c0974c6cc25c194a2737e2d6747?s=128&d=identicon&r=PG", "display_name": "Anders Kaseorg", "link": "https://stackoverflow.com/users/115030/anders-kaseorg"}, "reply_to_user": {"reputation": 5152, "user_id": 1601571, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/56403b8ee9f5066ce3f75b9783cc9b2b?s=128&d=identicon&r=PG", "display_name": "&#214;mer Erden", "link": "https://stackoverflow.com/users/1601571/%c3%96mer-erden"}, "edited": false, "score": 0, "creation_date": 1547711227, "post_id": 54230289, "comment_id": 95287182, "body": "@&#214;merErden Sure, I\u2019ve added a link."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1547747124, "post_id": 54230289, "comment_id": 95307440, "body": "I still don&#39;t think think this is correct. Rust <i>does</i> allow the example that you&#39;ve said it disallows. Also, in C++ this should not be UB for exactly the same reason: because the reference is to <code>words</code> which <i>does</i> live long enough."}], "tags": [], "owner": {"reputation": 3054, "user_id": 115030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15c74c0974c6cc25c194a2737e2d6747?s=128&d=identicon&r=PG", "display_name": "Anders Kaseorg", "link": "https://stackoverflow.com/users/115030/anders-kaseorg"}, "is_accepted": false, "score": 3, "last_activity_date": 1547746870, "last_edit_date": 1547746870, "creation_date": 1547707018, "answer_id": 54230289, "question_id": 54229893, "link": "https://stackoverflow.com/questions/54229893/why-cant-i-call-a-method-with-a-temporary-value/54230289#54230289", "title": "Why can&#39;t I call a method with a temporary value?", "body": "\n\n<p><code>Foo::new(words).split_first()</code> would be interpreted roughly as</p>\n\n<pre class=\"lang-rs prettyprint-override\"><code>let tmp = Foo::new(words);\nlet ret = tmp.split_first();\ndrop(tmp);\nret\n</code></pre>\n\n<p>If Rust allowed you to do this, the references in <code>ret</code> <s>would point</s> [edit: <em>would be allowed by the type of <code>split_first</code> to point</em>*] into the now dropped value of <code>tmp</code>.  So it\u2019s a good thing that Rust disallows this.  If you wrote the equivalent one-liner in C++, you\u2019d silently get undefined behavior.</p>\n\n<p>By writing the <code>let</code> binding yourself, you delay the drop until the end of the scope, thus extending the region where it\u2019s safe to have these references.</p>\n\n<p>For more details, see <a href=\"https://doc.rust-lang.org/reference/expressions.html#temporary-lifetimes\" rel=\"nofollow noreferrer\">temporary lifetimes</a> in the Rust Reference.</p>\n\n<p>* Edit: As <a href=\"https://stackoverflow.com/questions/54229893/why-cant-i-call-a-method-with-a-temporary-value/54231303#54231303\">pointed out by Jmb</a>, the real problem in this particular example is that the type</p>\n\n<pre class=\"lang-rs prettyprint-override\"><code>fn split_first(&amp;'a self) -&gt; &amp;'a str\n</code></pre>\n\n<p>isn\u2019t specific enough, and a better solution is to refine the type to:</p>\n\n<pre class=\"lang-rs prettyprint-override\"><code>fn split_first&lt;'b&gt;(&amp;'b self) -&gt; &amp;'a str\n</code></pre>\n\n<p>which can be abbreviated:</p>\n\n<pre class=\"lang-rs prettyprint-override\"><code>fn split_first(&amp;self) -&gt; &amp;'a str\n</code></pre>\n\n<p>This conveys the intended guarantee that the returned references do not point into the <code>Foo&lt;'a&gt;</code> (only into the string itself).</p>\n"}, {"comments": [{"owner": {"reputation": 3054, "user_id": 115030, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/15c74c0974c6cc25c194a2737e2d6747?s=128&d=identicon&r=PG", "display_name": "Anders Kaseorg", "link": "https://stackoverflow.com/users/115030/anders-kaseorg"}, "edited": false, "score": 0, "creation_date": 1547713623, "post_id": 54231303, "comment_id": 95288293, "body": "That\u2019s a good point. I never checked that <code>split_first</code> <i>actually</i> returns references into its input, merely that its type says it can. Fixing the type is a better solution."}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": 5, "last_activity_date": 1547752120, "last_edit_date": 1547752120, "creation_date": 1547711619, "answer_id": 54231303, "question_id": 54229893, "link": "https://stackoverflow.com/questions/54229893/why-cant-i-call-a-method-with-a-temporary-value/54231303#54231303", "title": "Why can&#39;t I call a method with a temporary value?", "body": "<p><strong>Short answer:</strong> remove the <code>'a</code> lifetime for the <code>self</code> parameter of <code>split_first</code>: <code>fn split_first(&amp;self) -&gt; &amp;'a str</code> (<a href=\"https://play.integer32.com/?version=stable&amp;mode=release&amp;edition=2015&amp;gist=722e82987ffd1b0d2a21acbcc40e2763\" rel=\"nofollow noreferrer\">playground</a>).</p>\n\n<p><strong>Long answer:</strong></p>\n\n<p>When you write this code:</p>\n\n<pre><code>struct Foo&lt;'a&gt; {\n    part: &amp;'a str,\n}\n\nimpl&lt;'a&gt; Foo&lt;'a&gt; {\n    fn new(s: &amp;'a str) -&gt; Self {\n        Foo { part: s }\n    }\n}\n</code></pre>\n\n<p>You are telling the compiler that all <code>Foo</code> instances are related to some lifetime <code>'a</code> that must be equal to or shorter than the lifetime of the string passed as parameter to <code>Foo::new</code>. That lifetime <code>'a</code> <em>may</em> be different from the lifetime of each <code>Foo</code> instance. When you then write:</p>\n\n<pre><code>let words = \"Sometimes think, the greatest sorrow than older\";\nFoo::new(words)\n</code></pre>\n\n<p>The compiler infers that the lifetime <code>'a</code> must be equal to or shorter than the lifetime of <code>words</code>. Barring any other constraints the compiler will use the lifetime of <code>words</code>, which is <code>'static</code> so it is valid for the full life of the program.</p>\n\n<p>When you add your definition of <code>split_first</code>:</p>\n\n<pre><code>fn split_first(&amp;'a self) -&gt; &amp;'a str\n</code></pre>\n\n<p>You are adding an extra constraint: you are saying that <code>'a</code> must also be equal to or shorter than the lifetime of <code>self</code>. The compiler will therefore take the shorter of the lifetime of <code>words</code> and the lifetime of the temporary <code>Foo</code> instance, which is the lifetime of the temporary. <a href=\"https://stackoverflow.com/a/54230289/155423\">@AndersKaseorg's answer</a> explains why that doesn't work.</p>\n\n<p>By removing the <code>'a</code> lifetime on the <code>self</code> parameter, I am decorrelating  <code>'a</code> from the lifetime of the temporary, so the compiler can again infer that <code>'a</code> is the lifetime of <code>words</code>, which is long enough for the program to work.</p>\n"}], "owner": {"reputation": 523, "user_id": 8617507, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9da6733c7db911f11532d8dfdbc576c4?s=128&d=identicon&r=PG&f=1", "display_name": "iDuanYingJie", "link": "https://stackoverflow.com/users/8617507/iduanyingjie"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 913, "favorite_count": 1, "answer_count": 2, "score": 1, "last_activity_date": 1547752120, "creation_date": 1547705057, "last_edit_date": 1547739089, "question_id": 54229893, "link": "https://stackoverflow.com/questions/54229893/why-cant-i-call-a-method-with-a-temporary-value", "title": "Why can&#39;t I call a method with a temporary value?", "body": "<p>I can't call <code>Foo::new(words).split_first()</code> in the following code</p>\n\n<pre><code>fn main() {\n    let words = \"Sometimes think, the greatest sorrow than older\";\n/*\n    let foo = Foo::new(words);\n    let first = foo.split_first();\n*/\n\n    let first = Foo::new(words).split_first();\n\n    println!(\"{}\", first);\n}\n\nstruct Foo&lt;'a&gt; {\n    part: &amp;'a str,\n}\n\nimpl&lt;'a&gt; Foo&lt;'a&gt; {\n\n    fn split_first(&amp;'a self) -&gt; &amp;'a str {\n        self.part.split(',').next().expect(\"Could not find a ','\")\n    }\n\n    fn new(s: &amp;'a str) -&gt; Self {\n        Foo { part: s }\n    }\n}\n</code></pre>\n\n<p>the compiler will give me an error message</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0716]: temporary value dropped while borrowed\n  --&gt; src/main.rs:8:17\n   |\n8  |     let first = Foo::new(words).split_first();\n   |                 ^^^^^^^^^^^^^^^              - temporary value is freed at the end of this statement\n   |                 |\n   |                 creates a temporary which is freed while still in use\n9  | \n10 |     println!(\"{}\", first);\n   |                    ----- borrow later used here\n   |\n   = note: consider using a `let` binding to create a longer lived value\n</code></pre>\n\n<p>If I bind the value of <code>Foo::new(words)</code> first, then call the <code>split_first</code> method there is no problem. </p>\n\n<p>These two methods of calling should intuitively be the same but are somehow different.</p>\n"}]