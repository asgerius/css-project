[{"tags": ["rust", "clap"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1535566739, "post_id": 52083767, "comment_id": 91117991, "body": "FWIW, <code>description.as_ref()</code> works."}, {"owner": {"reputation": 1158, "user_id": 4956078, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44600007f35ab98b7badbf1110df0687?s=128&d=identicon&r=PG&f=1", "display_name": "JMAA", "link": "https://stackoverflow.com/users/4956078/jmaa"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1535567292, "post_id": 52083767, "comment_id": 91118239, "body": "So it does! Any idea why this works and not <code>&amp;</code>?"}], "answers": [{"comments": [{"owner": {"reputation": 1158, "user_id": 4956078, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44600007f35ab98b7badbf1110df0687?s=128&d=identicon&r=PG&f=1", "display_name": "JMAA", "link": "https://stackoverflow.com/users/4956078/jmaa"}, "edited": false, "score": 0, "creation_date": 1535568318, "post_id": 52084145, "comment_id": 91118712, "body": "Great :) Any idea why the compiler is unable to convert directly? I&#39;d love to understand fully"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "reply_to_user": {"reputation": 1158, "user_id": 4956078, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44600007f35ab98b7badbf1110df0687?s=128&d=identicon&r=PG&f=1", "display_name": "JMAA", "link": "https://stackoverflow.com/users/4956078/jmaa"}, "edited": false, "score": 1, "creation_date": 1535568577, "post_id": 52084145, "comment_id": 91118830, "body": "@JMAA Just updated. Basically, this API is a bit unusual to request an <code>Into&lt;&amp;str&gt;</code>. There is no such implementation of <code>From&lt;String&gt;</code> for a string slice, and the compiler does not coerce <code>&amp;String</code> to something that fulfills <code>Into&lt;&amp;str&gt;</code> either. Other APIs often choose to take parameters <code>T: AsRef&lt;str&gt;</code> or string slices directly, thus avoiding these issues."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 1158, "user_id": 4956078, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44600007f35ab98b7badbf1110df0687?s=128&d=identicon&r=PG&f=1", "display_name": "JMAA", "link": "https://stackoverflow.com/users/4956078/jmaa"}, "edited": false, "score": 0, "creation_date": 1535568696, "post_id": 52084145, "comment_id": 91118890, "body": "@JMAA I <i>think</i> it&#39;s possible for the standard library to implement <code>Into&lt;&amp;str&gt; for &amp;String</code>; perhaps you could give it a shot and try contributing it!"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535568725, "post_id": 52084145, "comment_id": 91118899, "body": "@E_net4 I was just leaving an almost identical comment :) The reason why there is no implmentation of <code>Into&lt;&amp;str&gt; for String</code> is because <code>into</code> consumes self, so it wouldn&#39;t be possible for it to return a reference type."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535568778, "post_id": 52084145, "comment_id": 91118929, "body": "@PeterHall Right! This would also not be the case for <code>&amp;String</code>, but it&#39;s not implemented yet. (or at least we think it can be for the time being)"}], "tags": [], "owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "is_accepted": true, "score": 3, "last_activity_date": 1535568832, "last_edit_date": 1535568832, "creation_date": 1535567993, "answer_id": 52084145, "question_id": 52083767, "link": "https://stackoverflow.com/questions/52083767/how-do-i-pass-a-string-to-a-method-accepting-intostr/52084145#52084145", "title": "How do I pass a String to a method accepting Into&lt;&amp;str&gt;?", "body": "<p>With the given (unusual) constraint of <code>Into&lt;&amp;str&gt;</code>, the compiler is unable to turn a <code>String</code> or a <code>&amp;String</code> directly into the requested string slice. There is no such implementation of either <code>From&lt;String&gt;</code>, nor <code>From&lt;&amp;String&gt;</code>, for a string slice. Conversions from an owned string or string-like value to a slice is usually done through other traits.</p>\n\n<p>Instead, you can:</p>\n\n<ol>\n<li>Use <a href=\"https://doc.rust-lang.org/std/string/struct.String.html?search=#method.as_str\" rel=\"nofollow noreferrer\"><code>String::as_str()</code></a>, which always provides <code>&amp;str</code>;</li>\n<li>Call <code>as_ref()</code> from the <a href=\"https://doc.rust-lang.org/std/convert/trait.AsRef.html\" rel=\"nofollow noreferrer\"><code>AsRef</code></a> trait, leading the compiler to choose the implementation <code>AsRef&lt;str&gt;</code> for <code>String</code>;</li>\n<li>Or re-borrow the string, thus forcing a conversion to <code>&amp;str</code>.</li>\n</ol>\n\n\n\n<pre><code>let matches = App::new(NAME).about(description.as_str()).get_matches(); // (1)\nlet matches = App::new(NAME).about(description.as_ref()).get_matches(); // (2)\nlet matches = App::new(NAME).about(&amp;*description).get_matches(); // (3)\n</code></pre>\n"}], "owner": {"reputation": 1158, "user_id": 4956078, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/44600007f35ab98b7badbf1110df0687?s=128&d=identicon&r=PG&f=1", "display_name": "JMAA", "link": "https://stackoverflow.com/users/4956078/jmaa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 385, "favorite_count": 0, "accepted_answer_id": 52084145, "answer_count": 1, "score": 1, "last_activity_date": 1535568832, "creation_date": 1535566285, "last_edit_date": 1535566471, "question_id": 52083767, "link": "https://stackoverflow.com/questions/52083767/how-do-i-pass-a-string-to-a-method-accepting-intostr", "title": "How do I pass a String to a method accepting Into&lt;&amp;str&gt;?", "body": "<p>I'm trying to pass a <code>String</code> to clap's builder methods:</p>\n\n<pre><code>extern crate clap; // 2.32.0\n\nuse clap::App;\n\nconst NAME: &amp;'static str = \"example\";\nconst DESC_PART_1: &amp;'static str = \"desc\";\nconst DESC_PART_2: &amp;'static str = \"ription\";\n\nfn main() {\n    let description: String = format!(\"{}{}\", DESC_PART_1, DESC_PART_2);\n    let matches = App::new(NAME).about(description).get_matches();\n}\n</code></pre>\n\n<p>I get the error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `&amp;str: std::convert::From&lt;std::string::String&gt;` is not satisfied\n  --&gt; src/main.rs:11:34\n   |\n11 |     let matches = App::new(NAME).about(description).get_matches();\n   |                                  ^^^^^ the trait `std::convert::From&lt;std::string::String&gt;` is not implemented for `&amp;str`\n   |\n   = note: required because of the requirements on the impl of `std::convert::Into&lt;&amp;str&gt;` for `std::string::String`\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=15667c16c7d853ce4a668dfb453948b6&amp;version=nightly&amp;mode=debug&amp;edition=2018\" rel=\"nofollow noreferrer\">Live example</a></p>\n\n<p>I get a similar error if I pass <code>&amp;description</code>. I'm struggling to understand the origin of this error and the reasoning behind clap using the signature <code>pub fn about&lt;S: Into&lt;&amp;'b str&gt;&gt;(self, about: S) -&gt; Self</code>.</p>\n"}, {"tags": ["vector", "syntax", "rust", "initialization"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 3, "creation_date": 1535560690, "post_id": 52082169, "comment_id": 91114924, "body": "Your code has a lot of other errors, suggesting that you typed it in SO without testing it. After fixing those, in the way that seemed like what you might have intended, I see a different (though similar sounding) error: <code>the trait bound </code>Plane: std::clone::Clone` is not satisfied`"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 2, "creation_date": 1535560851, "post_id": 52082169, "comment_id": 91115006, "body": "The vector construction syntax <code>vec![val; 4]</code> requires that the type implement <code>Clone</code>. That&#39;s so it can copy it for entry. You can either make <code>Plane</code> implement <code>Clone</code>, or just fill the vector a different way - e.g. collecting from an iterator."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535561432, "post_id": 52082169, "comment_id": 91115256, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/35630131/155423\">Creating a Vector of Vectors in Rust</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/52082169/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 15131, "user_id": 166838, "user_type": "registered", "accept_rate": 96, "profile_image": "https://www.gravatar.com/avatar/0c01a983961c34967d0ccedda9eb7d49?s=128&d=identicon&r=PG", "display_name": "Elf Sternberg", "link": "https://stackoverflow.com/users/166838/elf-sternberg"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535563624, "post_id": 52082169, "comment_id": 91116465, "body": "@Shepmaster I do not see how the link you provided answers my question. It details whether or not an Iterator exists when accessing the vector; in my case, I&#39;m getting a straight up notice that the Copy trait doesn&#39;t exist at initialization time. How do you believe these are related?"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1535564324, "post_id": 52082169, "comment_id": 91116794, "body": "I also agree that the suggested question is not very useful, but there are still too many issues in here to be sure. Why aren&#39;t you showing us the code that produces the second error?"}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 2, "creation_date": 1535564693, "post_id": 52082169, "comment_id": 91116977, "body": "Moreover, the title might be misleading: if you wish for multiple <code>Plane</code>s to contain a slice to a single vector, then you would technically have a vector of slices."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535565087, "post_id": 52082169, "comment_id": 91117193, "body": "Your question is &quot;Initializing a vector of vectors in Rust&quot; the dupe shows you how to do that. Perhaps your question needs to be rephrased if a literal answer to your literal question does not solve it..."}], "answers": [{"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 6, "last_activity_date": 1535568825, "last_edit_date": 1535568825, "creation_date": 1535568370, "answer_id": 52084234, "question_id": 52082169, "link": "https://stackoverflow.com/questions/52082169/initializing-a-vector-of-vectors-in-rust/52084234#52084234", "title": "Initializing a vector of vectors in Rust", "body": "<p>The <code>Vec</code> construction macro <a href=\"https://doc.rust-lang.org/std/macro.vec.html\" rel=\"noreferrer\"><code>vec![val; n]</code></a> requires that the element type implements <code>Clone</code> so it can copy the example element into the remaining slots. So, the easy fix is to make <code>Plane</code> implement <code>Clone</code>:</p>\n\n<pre><code>#[derive(Clone)]\npub struct Plane {\n    bounds: (usize, usize),\n    velocity: u8,\n    region: Vec&lt;u16&gt;,\n}\n</code></pre>\n\n<p>Alternatively, you can just fill the vector a different way, which doesn't rely on the elements implementing <code>Clone</code>. For example:</p>\n\n<pre><code>use std::iter;\nlet planes: Vec&lt;_&gt; = iter::repeat_with(|| Plane::new(width, height, velocity))\n    .take(4)\n    .collect();\n</code></pre>\n"}], "owner": {"reputation": 15131, "user_id": 166838, "user_type": "registered", "accept_rate": 96, "profile_image": "https://www.gravatar.com/avatar/0c01a983961c34967d0ccedda9eb7d49?s=128&d=identicon&r=PG", "display_name": "Elf Sternberg", "link": "https://stackoverflow.com/users/166838/elf-sternberg"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2358, "favorite_count": 0, "accepted_answer_id": 52084234, "answer_count": 1, "score": 0, "last_activity_date": 1549997735, "creation_date": 1535560139, "last_edit_date": 1549997735, "question_id": 52082169, "link": "https://stackoverflow.com/questions/52082169/initializing-a-vector-of-vectors-in-rust", "title": "Initializing a vector of vectors in Rust", "body": "<p>I'm trying to create a simple multi-color mandelbrot generator, extending the example giving in O'Reilly's <em>Programming Rust</em>. The idea is to create three different \"planes\" of greymap with slightly different escape velocities, then merge those into an RGB-style colormapped image. The main idea is that each plane is independent, so each can be processed by a separate thread using the <code>crossbeam</code> crate, which is the final goal.</p>\n\n<p>The problem is that I can't seem to vectorize my planes.  Let me show you:</p>\n\n<pre><code>pub struct Plane {\n    bounds: (usize, usize),\n    velocity: u8,\n    region: Vec&lt;u16&gt;,\n}\n\nimpl Plane {\n    pub fn new(width: usize, height: usize, velocity: u8) -&gt; Plane {\n        Plane {\n            bounds: (width, height),\n            velocity: velocity,\n            region: vec![0 as u16; width * height],\n        }\n    }\n}\n\npub fn main() {\n    // ... argument processing elided\n    let width = 1000;\n    let height = 1000;\n    let velocity = 10;\n    let planes = vec![Plane::new(width, height, velocity); 4]; // RGBa\n}\n</code></pre>\n\n<p>When I attempt to build this, I get:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0277]: the trait bound `Plane: std::clone::Clone` is not satisfied\n  --&gt; src/main.rs:23:18\n   |\n23 |     let planes = vec![Plane::new(width, height, velocity); 4]; // RGBa\n   |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `std::clone::Clone` is not implemented for `Plane`\n   |\n   = note: required by `std::vec::from_elem`\n   = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n</code></pre>\n\n<p>I've tried creating one gigantic plane and then slicing it into subplanes with <code>chunks_mut</code> and then passing references to the underlying arrays, but then it gives me: </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>region: &amp;' [u16]: this field does not implement 'Copy'\n</code></pre>\n\n<p>As far as I can tell, I'm not trying to copy the <code>Plane</code> object, but the <code>vec![]</code> macro wants to <em>move</em> it somewhere, for which <code>Copy</code> must be implemented, but within that I just want the handle to the array moved, not the data, right? And that's just a bitmap itself, shouldn't it have <code>Copy</code> implemented already? </p>\n\n<p>This works fine on a single plane, even when <em>that</em> plane is sliced into regions for multi-core processing (see example <a href=\"https://github.com/elfsternberg/programming_rust/blob/master/mandelbrot/src/main.rs#L105\" rel=\"nofollow noreferrer\">here</a>), although in that case the \"one gigantic plane\" lives in a parent function and only slices of it are handed off to the renderer(s).</p>\n\n<p>Is there a way to move the array of plane data into the struct for proper encapsulation?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 4491, "user_id": 1264974, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/6558cf06df3ccf1c49329f38fd843b7d?s=128&d=identicon&r=PG", "display_name": "justinas", "link": "https://stackoverflow.com/users/1264974/justinas"}, "edited": false, "score": 3, "creation_date": 1535553610, "post_id": 52079983, "comment_id": 91110306, "body": "Note that <code>impl Trait</code> was not stable until <a href=\"https://blog.rust-lang.org/2018/05/10/Rust-1.26.html\" rel=\"nofollow noreferrer\">Rust 1.26</a> and changing existing function signatures in <code>std</code> now would be a breaking change. This explains why the standard library does not use your suggested pattern."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1535553678, "post_id": 52079983, "comment_id": 91110359, "body": "The author of that crate seems to be following an interpretation of the <a href=\"https://rust-lang-nursery.github.io/api-guidelines/future-proofing.html#newtypes-encapsulate-implementation-details-c-newtype-hide\" rel=\"nofollow noreferrer\">C-NEWTYPE-HIDE</a> guideline, which is indeed reasonable and more backwards-compatible than impl Trait."}], "answers": [{"comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 2, "creation_date": 1535555181, "post_id": 52080290, "comment_id": 91111481, "body": "Many standard library iterator adapters also <i>may or may not</i> implement additional traits depending on whether or not the original iterator does. For example, <code>iter.map(f)</code> is an iterator that implements <code>DoubleEndedIterator</code> if and only if <code>iter</code> implements <code>DoubleEndedIterator</code>. You couldn&#39;t define <code>map</code> this way using <code>impl Trait</code>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 2, "creation_date": 1535555200, "post_id": 52080290, "comment_id": 91111499, "body": "It&#39;s not a breaking change to turn <code>fn foo() -&gt; impl Iterator</code> into <code>fn foo() -&gt; impl Iterator + Debug + DoubleEndedIterator </code> is it?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535557345, "post_id": 52080290, "comment_id": 91113014, "body": "@PeterHall I do not believe so, but I haven&#39;t thought <i>too</i> deeply into it"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535557868, "post_id": 52080290, "comment_id": 91113368, "body": "As far as I can tell, there is no possibility of inferring equality between an <code>impl Trait</code>s in a covariant position and one in a contravariant position. They have different meanings."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 9, "last_activity_date": 1535557515, "last_edit_date": 1535557515, "creation_date": 1535553833, "answer_id": 52080290, "question_id": 52079983, "link": "https://stackoverflow.com/questions/52079983/what-is-the-advantage-of-publishing-a-concrete-type-in-a-crates-api-instead-of/52080290#52080290", "title": "What is the advantage of publishing a concrete type in a crate&#39;s API instead of `impl trait`?", "body": "<p>There's never One True Best Practice.</p>\n\n<p>Reasons for returning a concrete type include:</p>\n\n<ol>\n<li><p>You cannot currently declare a variable of type <code>impl Trait</code>, so any such usage has to be inferred. These cannot easily be placed in a struct for the same reason.</p></li>\n<li><p>You cannot add inherent methods to an <code>impl Trait</code> return type. For example, <a href=\"https://doc.rust-lang.org/std/str/struct.Chars.html\" rel=\"noreferrer\"><code>Chars</code></a> has the <a href=\"https://doc.rust-lang.org/std/str/struct.Chars.html#method.as_str\" rel=\"noreferrer\"><code>as_str</code></a> method.</p></li>\n<li><p>As <a href=\"https://stackoverflow.com/questions/52079983/what-is-the-advantage-of-publishing-a-concrete-type-in-a-crates-api-instead-of/52080290?noredirect=1#comment91111481_52080290\">trentcl points out</a>, <code>impl Trait</code> cannot conditionally implement a trait. This is important for iterator adapters such as <a href=\"https://doc.rust-lang.org/std/iter/struct.Skip.html\" rel=\"noreferrer\"><code>Skip</code></a>.</p></li>\n<li><p>You state \"compatible with <code>std::env::Args</code>\", but here are the traits that <code>Args</code> implements:</p>\n\n<pre><code>impl Iterator for Args {}\nimpl ExactSizeIterator for Args {}\nimpl DoubleEndedIterator for Args {}\nimpl Debug for Args {}\n</code></pre>\n\n<p>Your interface doesn't allow for 3 of the four of those. Consumers of your API cannot iterate from the back anymore, as one example. You can fix this by doing <code>impl Iterator&lt;Item = String&gt; + DoubleEndedIterator + ExactSizeIterator + Debug</code>, but at some point you effectively have your own type anyway. This problem is also possible if you return a newtype over an existing iterator, which is why I want a better delegation syntax.</p></li>\n</ol>\n\n<p>See also the <a href=\"https://rust-lang-nursery.github.io/api-guidelines/future-proofing.html#newtypes-encapsulate-implementation-details-c-newtype-hide\" rel=\"noreferrer\">C-NEWTYPE-HIDE</a> API guideline.</p>\n\n<blockquote>\n  <p>the Rust standard library does this for all of its iterators</p>\n</blockquote>\n\n<p>The iterators in the standard library were created before <code>impl Trait</code> existed so they had <em>no other choice</em>. They cannot be changed now to no longer return a concrete type due to backwards compatibility.</p>\n"}], "owner": {"reputation": 1443, "user_id": 43774, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a6290b348bfb2b8048d758beba2cd202?s=128&d=identicon&r=PG", "display_name": "rivy", "link": "https://stackoverflow.com/users/43774/rivy"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 261, "favorite_count": 0, "accepted_answer_id": 52080290, "answer_count": 1, "score": 6, "last_activity_date": 1535557515, "creation_date": 1535553017, "last_edit_date": 1535553429, "question_id": 52079983, "link": "https://stackoverflow.com/questions/52079983/what-is-the-advantage-of-publishing-a-concrete-type-in-a-crates-api-instead-of", "title": "What is the advantage of publishing a concrete type in a crate&#39;s API instead of `impl trait`?", "body": "<p>In patching a crate, I took it on myself to hide the internal iterator type, but the author says that publishing the type is a feature, and that best practice is to publish an explicit wrapper structure for every iterator exposed in the public API. Apparently, the Rust standard library does this for all of its iterators.</p>\n\n<p>Why do this? More concretely, if implementing a type that's compatible with <code>std::env::Args</code>, what are the pros and cons of using...</p>\n\n<pre><code>// implement iterator compatible with std::env::Args\npub struct Args { // public\n    // pub(crate) ...\n}\n\nimpl Iterator for Args {\n    // ...\n}\n\npub fn args() -&gt; Args {\n    // ...\n    // return Args\n}\n</code></pre>\n\n<p>vs</p>\n\n<pre><code>// implement iterator compatible with std::env::Args\npub(crate) struct Args { // hidden (outside of crate)\n    // pub(crate) ...\n}\n\nimpl Iterator for Args {\n    // ...\n}\n\npub fn args() -&gt; impl Iterator&lt;Item = String&gt; {\n    // ...\n    // return Args\n}\n</code></pre>\n"}, {"tags": ["rust", "codecov", "kcov"], "comments": [{"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 1, "creation_date": 1535527182, "post_id": 52070625, "comment_id": 91092937, "body": "How do you measure coverage? (tools/commands/configs used)"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 5, "creation_date": 1535528841, "post_id": 52070625, "comment_id": 91093900, "body": "For <code>unwrap</code>: it is quite possible that <code>unwrap</code> is inlined and you never cover the branch that panics. Therefore kcov believe there is a non-covered branch on the <code>unwrap</code> call."}, {"owner": {"reputation": 620, "user_id": 2576287, "user_type": "registered", "accept_rate": 56, "profile_image": "https://lh5.googleusercontent.com/-VegFz4P9Ovc/AAAAAAAAAAI/AAAAAAAAATo/Z-69W9rBCno/photo.jpg?sz=128", "display_name": "mrLSD", "link": "https://stackoverflow.com/users/2576287/mrlsd"}, "reply_to_user": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 0, "creation_date": 1535529791, "post_id": 52070625, "comment_id": 91094493, "body": "@kazemakase added config file and description to original question."}, {"owner": {"reputation": 620, "user_id": 2576287, "user_type": "registered", "accept_rate": 56, "profile_image": "https://lh5.googleusercontent.com/-VegFz4P9Ovc/AAAAAAAAAAI/AAAAAAAAATo/Z-69W9rBCno/photo.jpg?sz=128", "display_name": "mrLSD", "link": "https://stackoverflow.com/users/2576287/mrlsd"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1535529899, "post_id": 52070625, "comment_id": 91094543, "body": "@mcarton If this is so, then this is the bug <code>kcov</code>"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 2, "creation_date": 1535533470, "post_id": 52070625, "comment_id": 91096773, "body": "IMHO, it&#39;s not a bug, &lt;strike&gt;it&#39;s a feature&lt;/strike&gt;, but instead intended. Kconv analyses the assembly and sees a not-taken branch, so it will mark it as not covered"}, {"owner": {"reputation": 620, "user_id": 2576287, "user_type": "registered", "accept_rate": 56, "profile_image": "https://lh5.googleusercontent.com/-VegFz4P9Ovc/AAAAAAAAAAI/AAAAAAAAATo/Z-69W9rBCno/photo.jpg?sz=128", "display_name": "mrLSD", "link": "https://stackoverflow.com/users/2576287/mrlsd"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535534365, "post_id": 52070625, "comment_id": 91097362, "body": "@hellow It&#39;s not always true. I analyzed my results, and sometimes line not marked as covered or not-covered for <code>unwrap</code>. And how it&#39;s possbile not-teken branch if <code>unwrap</code> invoked?"}, {"owner": {"reputation": 19105, "user_id": 3005167, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/t0bMQ.png?s=128&g=1", "display_name": "kazemakase", "link": "https://stackoverflow.com/users/3005167/kazemakase"}, "edited": false, "score": 3, "creation_date": 1535534618, "post_id": 52070625, "comment_id": 91097513, "body": "@mrLSD Thanks for the update. Coverage tools rely on the line number table which maps source lines to machine instruction locations. This is not a 1:1 mapping. A source line often relates to many instructions. Sometimes a line does not have instructions associated with it (e.g. function arguments, or if the compiler was smart with removing unneccessary code). I am surprised by the not-covered <code>}</code>s, though, because I would expect them to be related to <code>RET</code> instructions at least. Could be that your functions were inlined so no code for returning had to be generated..."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1535550087, "post_id": 52070625, "comment_id": 91107753, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/52070625/edit\">edit</a> your question to include it. No one wants your &quot;full project&quot; to start with, we want you to create a <b>brand-new</b> project that has <i>only</i> this problem. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> if you need them. Saying &quot;the standard TravisCI configuration&quot; is useless because that can change over time."}, {"owner": {"reputation": 620, "user_id": 2576287, "user_type": "registered", "accept_rate": 56, "profile_image": "https://lh5.googleusercontent.com/-VegFz4P9Ovc/AAAAAAAAAAI/AAAAAAAAATo/Z-69W9rBCno/photo.jpg?sz=128", "display_name": "mrLSD", "link": "https://stackoverflow.com/users/2576287/mrlsd"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535550616, "post_id": 52070625, "comment_id": 91108105, "body": "@Shepmaster I put complete tavis-ci config. I will try to reproduce it via minimal Rust project and put here if success. Thanks."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535555151, "post_id": 52070625, "comment_id": 91111457, "body": "Sounds great! I bet you don&#39;t even need to involve travis or codecov.io and can just run it locally (assuming kcov creates the UI)"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1535614092, "post_id": 52070625, "comment_id": 91132586, "body": "Another guess for the uncovered `}\u02cb: those might be destructor calls that have already been called somewhere else and a drop-glue check is done"}], "answers": [{"tags": [], "owner": {"reputation": 86, "user_id": 7826850, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/02c1d3873b93cf2c18f4e89a600f0cb9?s=128&d=identicon&r=PG", "display_name": "Jeroen", "link": "https://stackoverflow.com/users/7826850/jeroen"}, "is_accepted": false, "score": 0, "last_activity_date": 1554800085, "creation_date": 1554800085, "answer_id": 55588777, "question_id": 52070625, "link": "https://stackoverflow.com/questions/52070625/rust-coverage-using-kcov-does-not-appear-correct/55588777#55588777", "title": "Rust coverage using kcov does not appear correct", "body": "<p>Assuming Cargo's and Travis' behavior hasn't changed significantly since this question was posted, there are a couple of things at play here.</p>\n\n<ul>\n<li>Whenever a build configuration changes, your build's fingerprint changes, resulting in a full or partial rebuild and a new filename for the resulting binary in <code>target</code>. Admittedly I'm not aware of the intricacies of exactly when or why this happens, I just know that it happens. In fact, for the project I'm working on, Cargo seems so confused about one of the dependencies that it forces a rebuild almost every single time.</li>\n<li>Travis' <code>cache: cargo</code> default is pretty dumb; it caches all of <code>$CARGO_HOME</code> and <code>target</code> without exceptions. Note that this in combination with the former also means that these caches grow without bound, so you need to throw them away once in a while or use a smarter caching scheme.</li>\n<li><code>for file in target/debug/myproject-*[^\\.d]</code> runs kcov for all builds of <code>myproject</code>, regardless of whether it's newly built or from Travis' build cache. Older builds may of course have different line numbers since they were built from different (older) sources, and coverage may be different.</li>\n<li>coverage.io merges coverage results by making a line red if it is included in <em>any</em> report, unless it's covered by <em>any</em> (other) report. It doesn't show any indication whatsoever if the line numbers from different reports don't match up, or even if one of the reports contains line numbers beyond EOF. In fact, as far as I could find, it doesn't even show which binaries covered/did not cover a line number even though it has this information. You have to download the XML reports and interpret them manually to see that.</li>\n</ul>\n\n<p>Therefore, those uncovered lines might not (all?) be due to the way Rust compiles its binaries as the comments to the question suggest, but might in fact be referring to a different (older) source file entirely. This became pretty obvious in our project after a while...</p>\n\n<p><a href=\"https://i.stack.imgur.com/vr8DU.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/vr8DU.png\" alt=\"borked coverage results\"></a></p>\n\n<p>If it's not this obvious, the easiest way to verify that this is what's going on is to just throw away Travis' build cache and force a rebuild.</p>\n\n<p>Since incremental builds don't really work for our project anyway, the solution we used was to just not have Travis cache the target directory, as suggested <a href=\"https://levans.fr/rust_travis_cache.html\" rel=\"nofollow noreferrer\">here</a>. Depending on how much your CI build time depends on incremental builds you may be forced to do something smarter.</p>\n"}], "owner": {"reputation": 620, "user_id": 2576287, "user_type": "registered", "accept_rate": 56, "profile_image": "https://lh5.googleusercontent.com/-VegFz4P9Ovc/AAAAAAAAAAI/AAAAAAAAATo/Z-69W9rBCno/photo.jpg?sz=128", "display_name": "mrLSD", "link": "https://stackoverflow.com/users/2576287/mrlsd"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 647, "favorite_count": 5, "answer_count": 1, "score": 6, "last_activity_date": 1554800085, "creation_date": 1535523356, "last_edit_date": 1535555081, "question_id": 52070625, "link": "https://stackoverflow.com/questions/52070625/rust-coverage-using-kcov-does-not-appear-correct", "title": "Rust coverage using kcov does not appear correct", "body": "<p>When I record code coverage of my Rust project using codecov.io, the coverage does not appear correct.</p>\n\n<ol>\n<li><p>The <code>unwrap()</code> function and the end bracket are not covered</p>\n\n<p><a href=\"https://i.stack.imgur.com/qQTKP.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/qQTKP.png\" alt=\"unwrap and end bracket not covered\"></a></p></li>\n<li><p>The function declaration is not covered</p>\n\n<p><a href=\"https://i.stack.imgur.com/D9BA5.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/D9BA5.png\" alt=\"function declaration not covered\"></a></p></li>\n</ol>\n\n<p>This is very strange.</p>\n\n<hr>\n\n<p>I cannot provide the full project for reproducing.</p>\n\n<p>I'm using the standard TravisCI configuration for Rust. Here is my .travis.yml:</p>\n\n<pre><code>language: rust\ncache: cargo\ndist: trusty\nsudo: required\n\nrust:\n  - stable\n  - beta\n  - nightly\n\nmatrix:\n  allow_failures:\n    - rust: nightly\n\nscript:\n  - cargo build --verbose --all\n  - cargo test --verbose --all\n\nafter_success: |\n  wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &amp;&amp;\n  tar xzf master.tar.gz &amp;&amp;\n  cd kcov-master &amp;&amp;\n  mkdir build &amp;&amp;\n  cd build &amp;&amp;\n  cmake .. &amp;&amp;\n  make &amp;&amp;\n  make install DESTDIR=../../kcov-build &amp;&amp;\n  cd ../.. &amp;&amp;\n  rm -rf kcov-master &amp;&amp;\n  for file in target/debug/myproject-*[^\\.d]; do mkdir -p \"target/cov/$(basename $file)\"; ./kcov-build/usr/local/bin/kcov --exclude-pattern=/.cargo,/usr/lib --verify \"target/cov/$(basename $file)\" \"$file\"; done &amp;&amp;\n  bash &lt;(curl -s https://codecov.io/bash)\n  echo \"Uploaded code coverage\"\n</code></pre>\n"}, {"tags": ["linux", "rust", "stack-overflow"], "comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 4, "creation_date": 1535489926, "post_id": 52065965, "comment_id": 91082636, "body": "In a signal handler, you can only use async-signal-safe function. I doubt this is the case of <code>println!</code>."}, {"owner": {"reputation": 208003, "user_id": 841108, "user_type": "registered", "accept_rate": 61, "profile_image": "https://i.stack.imgur.com/Fm52y.png?s=128&g=1", "display_name": "Basile Starynkevitch", "link": "https://stackoverflow.com/users/841108/basile-starynkevitch"}, "edited": false, "score": 4, "creation_date": 1535489953, "post_id": 52065965, "comment_id": 91082646, "body": "See also <a href=\"https://stackoverflow.com/a/21204438/841108\">this</a>. Handling <code>SIGSEGV</code> in Rust is as tricky as handling it in C. Look also <a href=\"http://www.linuxprogrammingblog.com/all-about-linux-signals?page=4\" rel=\"nofollow noreferrer\">here</a>"}, {"owner": {"reputation": 208003, "user_id": 841108, "user_type": "registered", "accept_rate": 61, "profile_image": "https://i.stack.imgur.com/Fm52y.png?s=128&g=1", "display_name": "Basile Starynkevitch", "link": "https://stackoverflow.com/users/841108/basile-starynkevitch"}, "edited": false, "score": 0, "creation_date": 1535490809, "post_id": 52065965, "comment_id": 91082952, "body": "Read also <a href=\"http://man7.org/linux/man-pages/man7/signal-safety.7.html\" rel=\"nofollow noreferrer\">signal-safety(7)</a> and <a href=\"http://man7.org/linux/man-pages/man7/signal.7.html\" rel=\"nofollow noreferrer\">signal(7)</a>"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 8, "creation_date": 1535492446, "post_id": 52065965, "comment_id": 91083449, "body": "&quot;Exhausting stack space is one of the causes of segmentation fault. In this case running a signal handler is not possible because it requires space on the stack. To allow handling SIGSEGV in such condition the sigaltstack(2) function exists that sets alternative stack to be used by signal handlers.&quot;"}, {"owner": {"reputation": 477, "user_id": 3239194, "user_type": "registered", "accept_rate": 27, "profile_image": "https://www.gravatar.com/avatar/68cb18e8d1c60c5d43b2dadc7d98b49d?s=128&d=identicon&r=PG&f=1", "display_name": "A-B", "link": "https://stackoverflow.com/users/3239194/a-b"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535735680, "post_id": 52065965, "comment_id": 91191199, "body": "@Stargateur Thanks for the comment. The alternate stack is working for me."}], "owner": {"reputation": 477, "user_id": 3239194, "user_type": "registered", "accept_rate": 27, "profile_image": "https://www.gravatar.com/avatar/68cb18e8d1c60c5d43b2dadc7d98b49d?s=128&d=identicon&r=PG&f=1", "display_name": "A-B", "link": "https://stackoverflow.com/users/3239194/a-b"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 655, "favorite_count": 0, "answer_count": 0, "score": 3, "last_activity_date": 1535490093, "creation_date": 1535489119, "last_edit_date": 1535490093, "question_id": 52065965, "link": "https://stackoverflow.com/questions/52065965/how-to-handle-sigsegv-signal-in-userspace-using-rust", "title": "How to handle SIGSEGV signal in userspace using Rust?", "body": "<p>I am trying to understand the stack overflow handler in Rust. I have written the function <code>recursive_stack()</code> which declares some local variables again and again to exhaust the stack space.</p>\n\n<pre><code>extern crate nix;\n\nuse nix::sys::signal;\n\nextern \"C\" fn handle_sigsegv(_: i32) {\n    //Do something here\n}\n\nfn main() {\n    let sig_action = signal::SigAction::new(\n        signal::SigHandler::Handler(handle_sigsegv),\n        signal::SaFlags::SA_NODEFER,\n        signal::SigSet::empty(),\n    );\n    unsafe {\n        signal::sigaction(signal::SIGSEGV, &amp;sig_action);\n    }\n    println!(\"Before function\");\n    recursive_stack();\n    println!(\"After function\");\n}\n\nfn recursive_stack() {\n    let _array: [i64; 50] = [0; 50];\n    recursive_stack();\n}\n</code></pre>\n\n<p>I want to catch the signal and execute my signal handler. If I register my signal handler, I get a \"Segmentation fault (core dumped)\" message. If I don't register a signal handler than I get a stack overflow message.</p>\n\n<p>This signal handler works fine if I register it for <code>SIGINT</code> signal but gives strange results for <code>SIGSEGV</code>. What am I missing?</p>\n\n<p>I am running this program on Ubuntu 18.04. </p>\n"}, {"tags": ["rust", "ownership"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1535477759, "post_id": 52062617, "comment_id": 91077373, "body": "I was able to modify this code to get a mutable reference without changing too much. What did you try? What issues did you run into?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 3, "creation_date": 1535478504, "post_id": 52062617, "comment_id": 91077718, "body": "<a href=\"https://play.rust-lang.org/?gist=c04fd844e19fcfed732fee6575b27ba9&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"nofollow noreferrer\">The solution in the duplicate question applied to your code</a>. You can also fix it by switching to the Rust 2018 Edition preview, or by enabling <code>#![feature(nll)]</code> using a nightly Rust build."}, {"owner": {"reputation": 71, "user_id": 8552405, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5fbe9032b46fa33ca6fdabd836763943?s=128&d=identicon&r=PG&f=1", "display_name": "Lukas E.", "link": "https://stackoverflow.com/users/8552405/lukas-e"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535611870, "post_id": 52062617, "comment_id": 91131381, "body": "Thank you very much for your help - I was indeed only missing the move of the iterator in a seperate variable."}], "owner": {"reputation": 71, "user_id": 8552405, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/5fbe9032b46fa33ca6fdabd836763943?s=128&d=identicon&r=PG&f=1", "display_name": "Lukas E.", "link": "https://stackoverflow.com/users/8552405/lukas-e"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 208, "favorite_count": 0, "closed_date": 1535478236, "answer_count": 0, "score": 1, "last_activity_date": 1535478207, "creation_date": 1535474076, "last_edit_date": 1535478207, "question_id": 52062617, "link": "https://stackoverflow.com/questions/52062617/how-do-i-return-a-mutable-reference-to-the-last-element-in-a-singly-linked-list", "closed_reason": "Duplicate", "title": "How do I return a mutable reference to the last element in a singly linked list to append an element?", "body": "<p>I have been playing around with single linked lists in Rust. How do I implement a method which returns a mutable reference to the last element in the list in order to append an element?</p>\n\n<p>I am aware of <a href=\"http://cglab.ca/~abeinges/blah/too-many-lists/book/\" rel=\"nofollow noreferrer\"><em>Learning Rust With Entirely Too Many Linked Lists</em></a> and also pretty confident in using unsafe code, but is there really no safe implementation to append an element? </p>\n\n<p>A non mutable reference is of course easy to implement (<code>get_last_element()</code>):</p>\n\n<pre><code>use std::mem;\n\n#[derive(Debug)]\npub struct SingleLinkedList {\n    head: Option&lt;Box&lt;Node&gt;&gt;,\n}\n\n#[derive(Debug)]\nstruct Node {\n    data: u32,\n    next: Option&lt;Box&lt;Node&gt;&gt;,\n}\n\nimpl SingleLinkedList {\n    fn new() -&gt; Self {\n        SingleLinkedList { head: None }\n    }\n\n    fn get_last_element(&amp;self) -&gt; Option&lt;&amp;Box&lt;Node&gt;&gt; {\n        match self.head {\n            Some(ref el) =&gt; {\n                let mut iterator = el;\n                loop {\n                    match iterator.next {\n                        Some(ref next_el) =&gt; {\n                            iterator = next_el;\n                        }\n                        None =&gt; return Some(iterator),\n                    }\n                }\n            }\n            None =&gt; return None,\n        }\n    }\n\n    fn push_front(&amp;mut self, _data: u32) {\n        let new_head = Some(Box::new(Node {\n            data: _data,\n            next: mem::replace(&amp;mut self.head, None),\n        }));\n        self.head = new_head;\n    }\n}\n\nfn main() {\n    let mut list = SingleLinkedList::new();\n    list.push_front(1);\n    list.push_front(2);\n\n    let ptr = list.get_last_element();\n    println!(\"PTR: {:?}\", ptr);\n    println!(\"{:?}\", list);\n}\n</code></pre>\n"}, {"tags": ["rust", "dependencies", "rust-cargo"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535456965, "post_id": 52057069, "comment_id": 91064425, "body": "I think yes, but I&#39;m not sure."}, {"owner": {"reputation": 40442, "user_id": 15985, "user_type": "registered", "accept_rate": 65, "profile_image": "https://www.gravatar.com/avatar/fb915f0b3a0a397891f4fd6dab6c2ac8?s=128&d=identicon&r=PG", "display_name": "Thomas Bratt", "link": "https://stackoverflow.com/users/15985/thomas-bratt"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535457035, "post_id": 52057069, "comment_id": 91064461, "body": "I could probably check with objdump or something similar but I want to see if there&#39;s a definitive answer or if it&#39;s planned for a future release. There&#39;s a related issue with the size of hello-world type executables."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1535457101, "post_id": 52057069, "comment_id": 91064511, "body": "With LTO for sure, otherwise I&#39;m not that certain."}], "answers": [{"comments": [{"owner": {"reputation": 40442, "user_id": 15985, "user_type": "registered", "accept_rate": 65, "profile_image": "https://www.gravatar.com/avatar/fb915f0b3a0a397891f4fd6dab6c2ac8?s=128&d=identicon&r=PG", "display_name": "Thomas Bratt", "link": "https://stackoverflow.com/users/15985/thomas-bratt"}, "edited": false, "score": 0, "creation_date": 1535459462, "post_id": 52057443, "comment_id": 91066078, "body": "Nice :) I&#39;ll accept that as the answer unless someone comes up with something definitive from the rust docs/project."}], "tags": [], "owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "is_accepted": true, "score": 12, "last_activity_date": 1535477987, "last_edit_date": 1535477987, "creation_date": 1535457854, "answer_id": 52057443, "question_id": 52057069, "link": "https://stackoverflow.com/questions/52057069/does-a-compiled-rust-executable-exclude-unused-code-from-dependencies/52057443#52057443", "title": "Does a compiled Rust executable exclude unused code from dependencies?", "body": "<p>It looks like it. I made a test lib and bin crate side by side:</p>\n\n<pre><code>// hellobin/src/main.rs\n\nextern crate hellolib;\n\nfn main() {\n    hellolib::func1();\n}\n</code></pre>\n\n<p>For the lib:</p>\n\n<pre><code>// hellolib/src/main.rs\n\npub fn func1() {\n    println!(\"Hello, world!\");\n}\n\npub fn func2() {\n    println!(\"Hello, other world!\");\n}\n</code></pre>\n\n<p>Building my binary and then inspecting symbols with <code>nm</code>:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ nm target/debug/helloworld | grep hello\n0000000100001360 t __ZN10helloworld4main17h749f61fb726f0a10E\n00000001000014b0 T __ZN8hellolib5func117hec0b5301559d46f6E\n</code></pre>\n\n<p>Only the used function has a symbol in the final binary.</p>\n\n<p>You can compile with <code>cargo rustc -- -C link-dead-code</code> though and you will see both symbols are present, including the unused one:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>$ nm target/debug/helloworld | grep hello\n0000000100001270 t __ZN10helloworld4main17h3104b73b00fdd798E\n00000001000013d0 T __ZN8hellolib5func117hec0b5301559d46f6E\n0000000100001420 T __ZN8hellolib5func217hc9d0886874057b84E\n</code></pre>\n\n<p>I believe (but I'm not sure) that it's the linker removing the dead code, so it may have still been compiled and then removed during linking.</p>\n"}, {"comments": [{"owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1535467737, "post_id": 52059181, "comment_id": 91071635, "body": "I edited the answer to clarify that the <code>tl;dr yes</code> refers to unused functions in particular."}], "tags": [], "owner": {"reputation": 814, "user_id": 2430485, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/vZThf.png?s=128&g=1", "display_name": "Markus Klein", "link": "https://stackoverflow.com/users/2430485/markus-klein"}, "is_accepted": false, "score": 8, "last_activity_date": 1535467577, "last_edit_date": 1535467577, "creation_date": 1535463039, "answer_id": 52059181, "question_id": 52057069, "link": "https://stackoverflow.com/questions/52057069/does-a-compiled-rust-executable-exclude-unused-code-from-dependencies/52059181#52059181", "title": "Does a compiled Rust executable exclude unused code from dependencies?", "body": "<p>TL;DR: Yes, every unused function is going to be excluded.</p>\n\n<p>This is actually the job of LLVM that will at least keep track of every unused function. <em>Any unused code</em> (as in codepaths in function not taken across the entire Application) may require LTO (Link Time Optimizations) to be activated to turn your crate into one compilation unit and give LLVM a fighting chance.</p>\n"}], "owner": {"reputation": 40442, "user_id": 15985, "user_type": "registered", "accept_rate": 65, "profile_image": "https://www.gravatar.com/avatar/fb915f0b3a0a397891f4fd6dab6c2ac8?s=128&d=identicon&r=PG", "display_name": "Thomas Bratt", "link": "https://stackoverflow.com/users/15985/thomas-bratt"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1071, "favorite_count": 0, "accepted_answer_id": 52057443, "answer_count": 2, "score": 16, "last_activity_date": 1535477987, "creation_date": 1535456743, "last_edit_date": 1535477970, "question_id": 52057069, "link": "https://stackoverflow.com/questions/52057069/does-a-compiled-rust-executable-exclude-unused-code-from-dependencies", "title": "Does a compiled Rust executable exclude unused code from dependencies?", "body": "<p>If I build a Rust application using Cargo with some crate dependencies, will any code in those dependencies that is unused by my application be eliminated from the final executable?</p>\n"}, {"tags": ["rust", "lifetime"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535401872, "post_id": 52046118, "comment_id": 91044105, "body": "Why do you believe that your code should work? Does your returned value capture that reference? Does the reference live long enough? How would the compiler verify that?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535402352, "post_id": 52046118, "comment_id": 91044273, "body": "Why did you decide to take a reference in the first place?"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535403031, "post_id": 52046118, "comment_id": 91044524, "body": "@Shepmaster I believe my code should work because it does work just fine if I don&#39;t take a callback but call a function instead. I don&#39;t know where you ask me why I take a reference, if it is the parameter of <code>callback</code>, changing it to <code>Fn(Q)</code> instead of <code>Fn(&amp;Q)</code> does not make any difference"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535404070, "post_id": 52046118, "comment_id": 91044900, "body": "I&#39;m asking why you are taking <code>&amp;Fn</code>. How long does <i>that</i> reference live? How can the compiler verify it lives long enough?"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535404189, "post_id": 52046118, "comment_id": 91044939, "body": "@Shepmaster Well, if I don&#39;t take a reference, I get an error message that the size of the callback is not known at compile-time (<code>the trait bound `for&lt;&#39;r&gt; std::ops::Fn(&amp;&#39;r Q) -&gt; S + &#39;static: std::marker::Sized` is not satisfied</code>)"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535404822, "post_id": 52046118, "comment_id": 91045155, "body": "But why don&#39;t you take a callback by value, <a href=\"https://doc.rust-lang.org/book/second-edition/ch13-01-closures.html#storing-closures-using-generic-parameters-and-the-fn-traits\" rel=\"nofollow noreferrer\">the way the books suggests</a>?"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535405181, "post_id": 52046118, "comment_id": 91045269, "body": "@Shepmaster Thanks, I tried that, but it still doesn&#39;t work. Please see my edit"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535405599, "post_id": 52046118, "comment_id": 91045428, "body": "I believe this is now a duplicate of <a href=\"https://stackoverflow.com/q/49341520/155423\">How to specify generic function bounds involving the lifetimes of intermediate variables?</a>"}, {"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535405846, "post_id": 52046118, "comment_id": 91045511, "body": "@Shepmaster it might be me but I cannot find how the other question/answer applies here. Would you mind elaborating on how the other answer helps me in this case?"}], "answers": [{"tags": [], "owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "is_accepted": true, "score": 5, "last_activity_date": 1535407637, "creation_date": 1535407637, "answer_id": 52047580, "question_id": 52046118, "link": "https://stackoverflow.com/questions/52046118/rust-callback-error-lifetime-static-required/52047580#52047580", "title": "Rust Callback: Error: Lifetime &#39;static required", "body": "<p>With the help of rustc's suggestions and <a href=\"https://serde.rs/lifetimes.html\" rel=\"noreferrer\">this article</a>, I was able to solve all errors:</p>\n\n<ol>\n<li>I added <code>C : 'static</code> to the <code>where</code> clause</li>\n<li>I changed the closure <code>|full_body|</code> so that it would <code>move</code></li>\n<li>I changed the type bound from <code>Deserialize&lt;'de&gt;</code> to <code>DeserializeOwned</code></li>\n</ol>\n\n<p>I ended up with this code that seems to work:</p>\n\n<pre><code>pub fn helper&lt;Q, S, C&gt;(mut state : State, callback : C) -&gt; Box&lt;HandlerFuture&gt;\n    where Q : DeserializeOwned,\n          S : Serialize,\n          C : Fn(Q) -&gt; S,\n          C : 'static\n{\n    let f = Body::take_from(&amp;mut state)\n        .concat2()\n        .then(move |full_body| match full_body {\n            Ok(valid_body) =&gt; {\n                let body_content = String::from_utf8(valid_body.to_vec()).unwrap();\n                let body_json = from_str::&lt;Q&gt;(&amp;body_content).unwrap();\n                let resp_json = callback(body_json);\n                let resp_content = to_string(&amp;resp_json).unwrap().into_bytes();\n                let res = create_response(&amp;state, StatusCode::Ok, Some((resp_content, APPLICATION_JSON)));\n                future::ok((state, res))\n            }\n            Err(e) =&gt; return future::err((state, e.into_handler_error()))\n        });\n\n    Box::new(f)\n}\n</code></pre>\n"}], "owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1457, "favorite_count": 0, "accepted_answer_id": 52047580, "answer_count": 1, "score": 3, "last_activity_date": 1535407637, "creation_date": 1535399504, "last_edit_date": 1535405165, "question_id": 52046118, "link": "https://stackoverflow.com/questions/52046118/rust-callback-error-lifetime-static-required", "title": "Rust Callback: Error: Lifetime &#39;static required", "body": "<p>I'm trying to write a generic function that takes a callback as a parameter. However, I always get the following error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0310]: the parameter type `C` may not live long enough\n  --&gt; src/lib.rs:36:5\n   |\n17 | pub fn helper&lt;'de, Q, S, C&gt;(mut state : State, callback : C) -&gt; Box&lt;HandlerFuture&gt;\n   |                          - help: consider adding an explicit lifetime bound `C: 'static`...\n...\n36 |     Box::new(f)\n   |     ^^^^^^^^^^^\n   |\nnote: ...so that the type `futures::Then&lt;futures::stream::Concat2&lt;hyper::Body&gt;, futures::FutureResult&lt;(gotham::state::State, hyper::Response), (gotham::state::State, gotham::handler::HandlerError)&gt;, [closure@src/lib.rs:24:15: 34:10 callback:&amp;C, state:gotham::state::State]&gt;` will meet its required lifetime bounds\n  --&gt; src/lib.rs:36:5\n   |\n36 |     Box::new(f)\n   |     ^^^^^^^^^^^\n</code></pre>\n\n<p>This is a minimal compilable example that produces the error message:</p>\n\n<pre><code>extern crate futures;\nextern crate gotham;\nextern crate hyper;\nextern crate mime;\nextern crate serde;\nextern crate serde_json;\n\nuse futures::{future, Future, Stream};\nuse gotham::handler::{HandlerFuture, IntoHandlerError};\nuse gotham::http::response::create_response;\nuse gotham::state::{FromState, State};\nuse hyper::{Body, StatusCode};\nuse mime::APPLICATION_JSON;\nuse serde::{Deserialize, Serialize};\nuse serde_json::{from_str, to_string};\n\npub fn helper&lt;'de, Q, S, C&gt;(mut state : State, callback : C) -&gt; Box&lt;HandlerFuture&gt;\n    where Q : Deserialize&lt;'de&gt;,\n          S : Serialize,\n          C : Fn(Q) -&gt; S\n{\n    let f = Body::take_from(&amp;mut state)\n        .concat2()\n        .then(|full_body| match full_body {\n            Ok(valid_body) =&gt; {\n                let body_content = String::from_utf8(valid_body.to_vec()).unwrap();\n                let body_json = from_str::&lt;Q&gt;(&amp;body_content).unwrap();\n                let resp_json = callback(body_json);\n                let resp_content = to_string(&amp;resp_json).unwrap().into_bytes();\n                let res = create_response(&amp;state, StatusCode::Ok, Some((resp_content, APPLICATION_JSON)));\n                future::ok((state, res))\n            }\n            Err(e) =&gt; return future::err((state, e.into_handler_error()))\n        });\n\n    Box::new(f)\n}\n</code></pre>\n\n<p>Adding <code>C : 'static</code> to the <code>where</code> clause as rustc suggests, I get the following error message:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0597]: `body_content` does not live long enough\n  --&gt; src/lib.rs:28:48\n   |\n28 |                 let body_json = from_str::&lt;Q&gt;(&amp;body_content).unwrap();\n   |                                                ^^^^^^^^^^^^ borrowed value does not live long enough\n...\n33 |             }\n   |             - borrowed value only lives until here\n   |\nnote: borrowed value must be valid for the lifetime 'de as defined on the function body at 17:1...\n  --&gt; src/lib.rs:17:1\n   |\n17 | / pub fn helper&lt;'de, Q, S, C&gt;(mut state : State, callback : C) -&gt; Box&lt;HandlerFuture&gt;\n18 | |     where Q : Deserialize&lt;'de&gt;,\n19 | |           S : Serialize,\n20 | |           C : Fn(Q) -&gt; S,\n...  |\n37 | |     Box::new(f)\n38 | | }\n   | |_^\n</code></pre>\n\n<p>This is the minimal content of my <code>Cargo.toml</code>:</p>\n\n<pre><code>[package]\nname = \"test\"\nversion = \"0.1.0\"\n\n[dependencies]\nfutures = \"0.1\"\ngotham = \"0.2\"\nhyper = \"0.11\"\nmime = \"0.3\"\nserde = \"1.0\"\nserde_json = \"1.0\"\n</code></pre>\n"}, {"tags": ["rust", "rustup"], "answers": [{"tags": [], "owner": {"reputation": 10587, "user_id": 5446749, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/fzsuf.jpg?s=128&g=1", "display_name": "vinzee", "link": "https://stackoverflow.com/users/5446749/vinzee"}, "is_accepted": true, "score": 88, "last_activity_date": 1535398787, "last_edit_date": 1535398787, "creation_date": 1535398693, "answer_id": 52045967, "question_id": 52045966, "link": "https://stackoverflow.com/questions/52045966/how-to-uninstall-rust-that-was-installed-via-rustup/52045967#52045967", "title": "How to uninstall Rust that was installed via rustup?", "body": "<p>To uninstall <code>rustc</code>, <code>rustup</code> and <code>cargo</code> from my Ubuntu 16.04 installation, I did:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>rustup self uninstall\n</code></pre>\n\n<p>and it worked.</p>\n"}, {"comments": [{"owner": {"reputation": 52212, "user_id": 376535, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/e841b2deaeef854e0ab8ec6cdd1ba740?s=128&d=identicon&r=PG", "display_name": "Shiplu Mokaddim", "link": "https://stackoverflow.com/users/376535/shiplu-mokaddim"}, "edited": false, "score": 1, "creation_date": 1612865654, "post_id": 52726400, "comment_id": 116893753, "body": "My installation command doesn&#39;t show me this."}, {"owner": {"reputation": 96, "user_id": 11928561, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-e_mdxHwq2qw/AAAAAAAAAAI/AAAAAAAAAYU/rLcVYXEd_jo/photo.jpg?sz=128", "display_name": "Ryoidenshi Aokigahara", "link": "https://stackoverflow.com/users/11928561/ryoidenshi-aokigahara"}, "reply_to_user": {"reputation": 52212, "user_id": 376535, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/e841b2deaeef854e0ab8ec6cdd1ba740?s=128&d=identicon&r=PG", "display_name": "Shiplu Mokaddim", "link": "https://stackoverflow.com/users/376535/shiplu-mokaddim"}, "edited": false, "score": 0, "creation_date": 1614586681, "post_id": 52726400, "comment_id": 117420188, "body": "@ShipluMokaddim I don&#39;t remember this screen only when tried to skip interactive part. In one cloud IDE i&#39;ve got error that &quot;/dev/tty&quot; device not found. Looked into installer script and found that error is related to one question during installation (typical install and something else). Script also contains comment that &quot;-y&quot; argument (as I remember) will skip interactive part and run typical installation. On local devices I&#39;ve seen it both in windows and linux. Probably you skiped something :D"}, {"owner": {"reputation": 52212, "user_id": 376535, "user_type": "registered", "accept_rate": 87, "profile_image": "https://www.gravatar.com/avatar/e841b2deaeef854e0ab8ec6cdd1ba740?s=128&d=identicon&r=PG", "display_name": "Shiplu Mokaddim", "link": "https://stackoverflow.com/users/376535/shiplu-mokaddim"}, "reply_to_user": {"reputation": 96, "user_id": 11928561, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-e_mdxHwq2qw/AAAAAAAAAAI/AAAAAAAAAYU/rLcVYXEd_jo/photo.jpg?sz=128", "display_name": "Ryoidenshi Aokigahara", "link": "https://stackoverflow.com/users/11928561/ryoidenshi-aokigahara"}, "edited": false, "score": 0, "creation_date": 1614591298, "post_id": 52726400, "comment_id": 117421947, "body": "@RyoidenshiAokigahara I solved it 3 weeks ago. Don&#39;t remember now how. But I think your comment has a good point."}], "tags": [], "owner": {"reputation": 2092, "user_id": 1704235, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/673f1d81e228a0e81f916f8c5ed8d501?s=128&d=identicon&r=PG&f=1", "display_name": "MaNKuR", "link": "https://stackoverflow.com/users/1704235/mankur"}, "is_accepted": false, "score": 25, "last_activity_date": 1539106434, "last_edit_date": 1539106434, "creation_date": 1539106096, "answer_id": 52726400, "question_id": 52045966, "link": "https://stackoverflow.com/questions/52045966/how-to-uninstall-rust-that-was-installed-via-rustup/52726400#52726400", "title": "How to uninstall Rust that was installed via rustup?", "body": "<p>If you pay attention to the message you get while installing, you will find the command you are looking for:</p>\n\n<p><a href=\"https://i.stack.imgur.com/cCmrL.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/cCmrL.png\" alt=\"Rust uninstall command\"></a></p>\n"}, {"tags": [], "owner": {"reputation": 193, "user_id": 4710245, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-4GnvLw0CYEU/AAAAAAAAAAI/AAAAAAAAABw/iWcKuuXeQcs/photo.jpg?sz=128", "display_name": "Anthony Pi&#241;ero", "link": "https://stackoverflow.com/users/4710245/anthony-pi%c3%b1ero"}, "is_accepted": false, "score": -3, "last_activity_date": 1603031698, "last_edit_date": 1603031698, "creation_date": 1602988332, "answer_id": 64409164, "question_id": 52045966, "link": "https://stackoverflow.com/questions/52045966/how-to-uninstall-rust-that-was-installed-via-rustup/64409164#64409164", "title": "How to uninstall Rust that was installed via rustup?", "body": "<p>this worked for me on mac:</p>\n<pre><code>$ sudo sh /usr/local/lib/rustlib/uninstall.sh\n\ninstall: uninstalling component 'rustc'\ninstall: uninstalling component 'rust-std-aarch64-apple-darwin'\ninstall: uninstalling component 'cargo'\ninstall: uninstalling component 'rust-docs'\ninstall: uninstalling component 'rls-preview'\ninstall: uninstalling component 'rust-analysis-aarch64-apple-darwin'\n    \n    Rust is uninstalled.\n</code></pre>\n"}], "owner": {"reputation": 10587, "user_id": 5446749, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/fzsuf.jpg?s=128&g=1", "display_name": "vinzee", "link": "https://stackoverflow.com/users/5446749/vinzee"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 22619, "favorite_count": 9, "accepted_answer_id": 52045967, "answer_count": 3, "score": 50, "last_activity_date": 1603031698, "creation_date": 1535398693, "last_edit_date": 1535402237, "question_id": 52045966, "link": "https://stackoverflow.com/questions/52045966/how-to-uninstall-rust-that-was-installed-via-rustup", "title": "How to uninstall Rust that was installed via rustup?", "body": "<p>I installed Rust on my Ubuntu 16.04 machine through </p>\n\n<pre class=\"lang-none prettyprint-override\"><code>curl https://sh.rustup.rs -sSf | sh\n</code></pre>\n\n<p>as can be seen on the <a href=\"https://www.rust-lang.org/en-US/install.html\" rel=\"noreferrer\">Installation Page</a>.</p>\n\n<p>How do I now uninstall Rust?</p>\n"}, {"tags": ["multithreading", "tcp", "rust", "mockito", "steam"], "comments": [{"owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "edited": false, "score": 0, "creation_date": 1535442273, "post_id": 52045373, "comment_id": 91055380, "body": "What are you expecting to happen here? It looks like you&#39;re creating a TCP server on <code>127.0.0.1:7879</code> and then sending a request to that same port. And then accepting that connection and printing the first written packet - which works as expected. But then you&#39;re mocking a server on port 1234 too and never sending anything to it but expecting it to have been called?"}, {"owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "edited": false, "score": 0, "creation_date": 1535442328, "post_id": 52045373, "comment_id": 91055411, "body": "If you&#39;re trying to write tests for the multithreaded server, why do you need to mock anything? Can&#39;t you just send it requests from your test?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1535524160, "post_id": 52045373, "comment_id": 91091336, "body": "He&#39;s not creating a server on <code>127.0.0.1:7879</code>, he&#39;s mocking a server on this address and checking that the client called the server. And where do you see port 1234 in the question?"}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "edited": false, "score": 0, "creation_date": 1535524533, "post_id": 52045373, "comment_id": 91091505, "body": "I don&#39;t know enough about Mockito to be sure, but could the issue come from the fact that you send the request (through <code>connect_and_send_request</code>) before you create the mock, so by the time the mock is created the request is already passed and the mock doesn&#39;t see it?"}, {"owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "edited": false, "score": 1, "creation_date": 1535532428, "post_id": 52045373, "comment_id": 91096120, "body": "Mockito creates a HTTP server on port 1234. It has no idea about his TCP listener"}, {"owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "edited": false, "score": 0, "creation_date": 1535532591, "post_id": 52045373, "comment_id": 91096232, "body": "<a href=\"https://docs.rs/mockito/0.12.0/mockito/constant.SERVER_ADDRESS.html\" rel=\"nofollow noreferrer\">docs.rs/mockito/0.12.0/mockito/constant.SERVER_ADDRESS.html</a>"}, {"owner": {"reputation": 93, "user_id": 2456849, "user_type": "registered", "accept_rate": 18, "profile_image": "https://i.stack.imgur.com/E8By1.png?s=128&g=1", "display_name": "MichalObi", "link": "https://stackoverflow.com/users/2456849/michalobi"}, "edited": false, "score": 0, "creation_date": 1535565642, "post_id": 52045373, "comment_id": 91117461, "body": "Thanks Matt - i try diff approach to make this work correctly without Mockito mock."}, {"owner": {"reputation": 2462, "user_id": 911651, "user_type": "registered", "accept_rate": 76, "profile_image": "https://www.gravatar.com/avatar/8d03f24dd6314707c4da54eb577a7dbf?s=128&d=identicon&r=PG", "display_name": "AlexLiesenfeld", "link": "https://stackoverflow.com/users/911651/alexliesenfeld"}, "edited": false, "score": 0, "creation_date": 1599683813, "post_id": 52045373, "comment_id": 112852968, "body": "I think this problem would be much easier to solve with a more modern HTTP mocking library, such as <a href=\"https://crates.io/crates/httpmock\" rel=\"nofollow noreferrer\">crates.io/crates/httpmock</a> (shameless plug)."}], "owner": {"reputation": 93, "user_id": 2456849, "user_type": "registered", "accept_rate": 18, "profile_image": "https://i.stack.imgur.com/E8By1.png?s=128&g=1", "display_name": "MichalObi", "link": "https://stackoverflow.com/users/2456849/michalobi"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 343, "favorite_count": 0, "answer_count": 0, "score": 0, "last_activity_date": 1535396637, "creation_date": 1535395873, "last_edit_date": 1535396637, "question_id": 52045373, "link": "https://stackoverflow.com/questions/52045373/rust-official-tutorial-multithreaded-web-server-with-mockito-tests-empty-reque", "title": "Rust official tutorial multithreaded web server with mockito tests - empty request", "body": "<p>I am trying to write integration tests for the official multithreaded web server tutorial. </p>\n\n<p>In <code>integrational_tests.rs</code>, I have something like this:</p>\n\n<pre><code>fn connect_and_send_request() {\n    let stream = TcpStream::connect(\"127.0.0.1:7879\").unwrap();\n    let mut writer = BufWriter::new(stream);\n    let s = b\"GET / HTTP/1.1\\r\\n\\r\\n\";\n    writer.write(s).unwrap();\n    writer.flush().unwrap();\n}\n\nfn test_main_route() {\n    let server_address = [SocketAddr::from(([127, 0, 0, 1], 7879))];\n\n    let listener: TcpListener = TcpListener::bind(&amp;server_address[..]).unwrap();\n    let pool = ThreadPool::new(4);\n\n    connect_and_send_request();\n\n    for stream in listener.incoming() {\n        let mut stream = stream.unwrap();\n\n        pool.execute(|| {\n            let main_mock = mock(\"GET\", \"/\").create();\n            handle_connection(stream);\n            println!(\"Main mock {}\", main_mock);\n            main_mock.assert();\n        });\n    }\n\n    fn handle_connection(mut stream: TcpStream) {\n        let mut response = [0; 512];\n        stream.read(&amp;mut response).unwrap();\n        stream.flush().unwrap();\n        println!(\"Request: {}\", String::from_utf8_lossy(&amp;response[..]));\n    }\n}\n</code></pre>\n\n<p>In my \"Request\" <code>println!</code> I see my request string, but <code>main_mock.assert()</code> based on Mockito fails:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>thread &lt;unnamed&gt; panicked at assertion failed: (left == right) \nexpect GET / ... but recived 0.\n</code></pre>\n"}, {"tags": ["rust", "copy", "slice"], "answers": [{"comments": [{"owner": {"reputation": 1250, "user_id": 9314540, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/867477659dda7aded0a1b28a6a5ac1e7?s=128&d=identicon&r=PG&f=1", "display_name": "rampatowl", "link": "https://stackoverflow.com/users/9314540/rampatowl"}, "edited": false, "score": 0, "creation_date": 1535393594, "post_id": 52044634, "comment_id": 91040587, "body": "Thanks for the reply! Does this mean that the entire slice will be copied? (And if so is there a way to just copy the last element, in case the slice is long?)"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 1250, "user_id": 9314540, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/867477659dda7aded0a1b28a6a5ac1e7?s=128&d=identicon&r=PG&f=1", "display_name": "rampatowl", "link": "https://stackoverflow.com/users/9314540/rampatowl"}, "edited": false, "score": 0, "creation_date": 1535393847, "post_id": 52044634, "comment_id": 91040698, "body": "@rampatowl No, the entire slice is just passed by reference. It&#39;s just that you are returning the element by value. So this will make sure that the element will be copied instead of moved."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 4, "last_activity_date": 1535393779, "last_edit_date": 1535393779, "creation_date": 1535392542, "answer_id": 52044634, "question_id": 52044150, "link": "https://stackoverflow.com/questions/52044150/how-to-copy-last-element-from-slice/52044634#52044634", "title": "How to copy last element from slice", "body": "<p>If you are working with simple types, such as <code>i32</code> and other small, fixed-sized structures, these types usually implement <code>Copy</code>. This trait is a marker which tells the compiler to copy values in memory in situations where they would otherwise be moved. In fact, this is what the error message means when it refers to a <code>non-copy slice</code>: if the elements don't implement <code>Copy</code> then it would have to move them and that would leave the slice in an invalid state, which is not allowed.</p>\n\n<p>If you constrain your function to expect only <code>Copy</code> types, then it will happily copy those values for you:</p>\n\n<pre><code>fn last_element&lt;T: Copy&gt;(list: &amp;[T]) -&gt; T {\n    list[list.len() - 1]\n}\n</code></pre>\n\n<p>If the type of your elements could be more complex, and doesn't implement <code>Copy</code>, then you can constrain the function wider, to any type that implements <code>Clone</code>, and then call <code>clone()</code> on the element before it is returned:</p>\n\n<pre><code>fn last_element&lt;T: Clone&gt;(list: &amp;[T]) -&gt; T {\n    list[list.len() - 1].clone()\n}\n</code></pre>\n\n<p>Cloning is generally a heavier operation than copying, since it is usually implemented on per-field basis in Rust code, while <code>Copy</code> is a lower-level operation on raw memory.</p>\n\n<p>A final option would be to just return a reference to the last element in the first place. The caller of the function can then decide what to do with it. If it's a <code>Copy</code> type (like numbers) then dereferencing it will copy it:</p>\n\n<pre><code>fn last_element&lt;T&gt;(list: &amp;[T]) -&gt; &amp;T {\n    &amp;list[list.len() - 1]\n}\n\nfn main() {\n    let mut slice = [1, 2, 3, 4, 5];\n    let x = *last_element(&amp;slice);\n}\n</code></pre>\n\n<p>If the elements were <code>Clone</code> but not <code>Copy</code> then, instead of dereferencing, you can explicitly <code>clone</code> it at that point instead:</p>\n\n<pre><code>let x = last_element(&amp;slice).clone();\n</code></pre>\n"}], "owner": {"reputation": 1250, "user_id": 9314540, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/867477659dda7aded0a1b28a6a5ac1e7?s=128&d=identicon&r=PG&f=1", "display_name": "rampatowl", "link": "https://stackoverflow.com/users/9314540/rampatowl"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 146, "favorite_count": 0, "accepted_answer_id": 52044634, "answer_count": 1, "score": 1, "last_activity_date": 1548090677, "creation_date": 1535390376, "last_edit_date": 1548090677, "question_id": 52044150, "link": "https://stackoverflow.com/questions/52044150/how-to-copy-last-element-from-slice", "title": "How to copy last element from slice", "body": "<p>I am new to Rust and am trying to learn the idiomatic way to work with the borrow checker.</p>\n\n<p>I'm trying to write a simple function that takes in a slice (generic over the data type) and returns the last element, in such a way that I can mutate the slice afterward. The naive implementation gives me an error:</p>\n\n<pre><code>fn last_element&lt;T&gt;(list: &amp;[T]) -&gt; T {\n    list[list.len() - 1]\n}\n\nfn main() {\n    let mut slice = [1, 2, 3, 4, 5];\n    let x = last_element(&amp;slice);\n    println!(\"{}\", x);\n\n    // I want to be able to mutate slice after extracting last element\n    slice[2] = 17;\n}\n</code></pre>\n\n<p>The error is <code>cannot move out of type</code>[T]<code>, a non-copy slice</code>. I see that one workaround is to have the function return a reference:</p>\n\n<pre><code>fn last_element&lt;T&gt;(list: &amp;[T]) -&gt; &amp;T {\n    &amp;list[list.len() - 1]\n}\n\nfn main() {\n    let mut slice = [1, 2, 3, 4, 5];\n    let x = last_element(&amp;slice);\n    println!(\"{}\", x);\n    // I want to be able to mutate slice after extracting last element\n    slice[2] = 17;\n}\n</code></pre>\n\n<p>But then I get an error for <code>slice[2] = 17</code> because the slice was borrowed when <code>x</code> was assigned. I do want to be able to mutate after calling <code>last_element</code>. The one workaround I found was to dereference <code>x</code>, which I believe consumes the borrow:</p>\n\n<pre><code>fn last_element&lt;T&gt;(list: &amp;[T]) -&gt; &amp;T {\n    &amp;list[list.len() - 1]\n}\n\nfn main() {\n    let mut slice = [1, 2, 3, 4, 5];\n    let x = *last_element(&amp;slice);\n    println!(\"{}\", x);\n    // I want to be able to mutate slice after extracting last element\n    slice[2] = 17;\n}\n</code></pre>\n\n<p>Is this the most idiomatic way to accomplish the aim of being able to get the last element of a slice and still mutate the slice afterward? Or should I never even be doing the mutation afterward if I am writing good code?</p>\n"}, {"tags": ["rust", "lifetime", "borrowing"], "comments": [{"owner": {"reputation": 12494, "user_id": 1402929, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/IORgE.jpg?s=128&g=1", "display_name": "Matt Harrison", "link": "https://stackoverflow.com/users/1402929/matt-harrison"}, "edited": false, "score": 3, "creation_date": 1535390062, "post_id": 52043578, "comment_id": 91038937, "body": "Your second example does compile and run with 2018 edition of Rust FYI: <a href=\"https://www.ncameron.org/blog/how-to-help-test-the-2018-edition/\" rel=\"nofollow noreferrer\">ncameron.org/blog/how-to-help-test-the-2018-edition</a>"}], "answers": [{"comments": [{"owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535390617, "post_id": 52044028, "comment_id": 91039165, "body": "So to clarify: this problem exists only when running in the current Rust compiler, and will probably be circumvented entirely by revisions set in place by ~the end of this year?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535390759, "post_id": 52044028, "comment_id": 91039238, "body": "@CrepeGoat Nothing can be guaranteed, but that is a fair assessment."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 1, "creation_date": 1548091034, "post_id": 52044028, "comment_id": 95410200, "body": "@CrepeGoat And this did turn out to be the case. You no longer need nightly builds to access nll, as long as you target Rust Edition 2018."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 3, "last_activity_date": 1548090952, "last_edit_date": 1548090952, "creation_date": 1535389864, "answer_id": 52044028, "question_id": 52043578, "link": "https://stackoverflow.com/questions/52043578/why-can-i-force-reference-move-semantics-for-self-parameter-of-method-but-no/52044028#52044028", "title": "Why can I force reference move semantics for `&amp;self` parameter of method, but not function parameters?", "body": "<p>You can fix it like this:</p>\n\n<pre><code>v_ref = {\n    // move `v_ref` to a new variable which will go out of scope by the end of the block\n    let r = v_ref;\n    // Mutating &amp; slice splitting moved to function\n    let (v_l, v_r) = example2_inner(r);\n\n    match len % 2 {\n        0 =&gt; v_l,\n        _ =&gt; v_r,\n    }\n};\n</code></pre>\n\n<p>The reason is that <code>v_1</code> and <code>v_2</code> both are references to <code>v_ref</code>, but these references both outlive the block because they are being returned from it. Then you try to write to <code>v_ref</code>, which the borrow checker doesn't like because there are still these live references around.</p>\n\n<p>Assigning <code>v_ref</code> to a new variable, <code>r</code>, means that <code>v_ref</code> is no longer valid - the variable has been moved. The live references, <code>v_1</code> and <code>v_2</code> are now referring to <code>r</code>, which in turn is a reference to <code>v</code>, and which only lives as long as the block. You are now free to write to <code>v_ref</code> because nothing else is referring to it.</p>\n\n<hr>\n\n<p>Alternatively, you can just update to Rust Edition 2018, or enable non-lexical lifetimes, which can handle this situation.</p>\n"}, {"comments": [{"owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535515281, "post_id": 52055533, "comment_id": 91088373, "body": "thanks for addressing the first part of my question :]"}], "tags": [], "owner": {"reputation": 2673, "user_id": 7274990, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/6819319104c8dbd5f1612d86ea8d9216?s=128&d=identicon&r=PG&f=1", "display_name": "Calculator", "link": "https://stackoverflow.com/users/7274990/calculator"}, "is_accepted": false, "score": 2, "last_activity_date": 1535454387, "last_edit_date": 1535454387, "creation_date": 1535451658, "answer_id": 52055533, "question_id": 52043578, "link": "https://stackoverflow.com/questions/52043578/why-can-i-force-reference-move-semantics-for-self-parameter-of-method-but-no/52055533#52055533", "title": "Why can I force reference move semantics for `&amp;self` parameter of method, but not function parameters?", "body": "<blockquote>\n  <p>Why don't these two examples compile the same way? Are mutable\n  reference move semantics (i.e., the <code>{vref}</code> from E1) enforced for\n  methods (i.e. <code>split_at_mut</code>), but not functions (i.e., <code>example2_inner</code>)?\n  Why is this the case?</p>\n</blockquote>\n\n<p>Actually, it is not about methods vs functions, but about method call syntax vs function call syntax.</p>\n\n<p>Every method call can be translated into the UFCS (Universal Function Call Syntax) which is generally of this form:</p>\n\n<pre><code>&lt;Type as Trait&gt;::method(args);\n</code></pre>\n\n<p>If we make a naive attempt to translate the call of <code>{ v_ref }.split_at_mut(len / 2)</code> into UFCS in version 1, we end up with the same error as in version 2:</p>\n\n<pre><code>&lt;[_]&gt;::split_at_mut({v_ref}, len / 2)\n</code></pre>\n\n<p>The reason is that the above is equivalent to something which again does not cause <code>v_ref</code> to be moved into the block:</p>\n\n<pre><code>&lt;[_]&gt;::split_at_mut({&amp;mut *v_ref}, len / 2)\n</code></pre>\n\n<p>What the method syntax actually resolves to is this working variant of the above:</p>\n\n<pre><code>&lt;[_]&gt;::split_at_mut(&amp;mut *{v_ref}, len / 2)\n</code></pre>\n\n<p>For this variant, the compiler infers that <code>v_ref</code> indeed should be moved into the block, because the compiler realizes that the re-borrowing necessary for the method call is already going to happen on <code>{v_ref}</code>, so it doesn't insert an additional superfluous re-borrow on <code>v_ref</code>.</p>\n\n<p>Now that we know how the method syntax solves your issue implicitly, we have an alternative solution for your issue in version 2:</p>\n\n<pre><code>example2_inner(&amp;mut *{ v_ref });\n</code></pre>\n"}], "owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 141, "favorite_count": 0, "accepted_answer_id": 52044028, "answer_count": 2, "score": 3, "last_activity_date": 1548168020, "creation_date": 1535387777, "last_edit_date": 1548168020, "question_id": 52043578, "link": "https://stackoverflow.com/questions/52043578/why-can-i-force-reference-move-semantics-for-self-parameter-of-method-but-no", "title": "Why can I force reference move semantics for `&amp;self` parameter of method, but not function parameters?", "body": "<p>I have two versions of a function that are intended to do the same thing.</p>\n\n<h1>Version 1 - Works!</h1>\n\n<pre><code>pub fn example1() {\n    // Make a mutable slice\n    let mut v = [0, 1, 2, 3];\n\n    // Make a mutable reference to said slice\n    let mut v_ref = &amp;mut v[..];\n    let len = v_ref.len();\n\n    // Reduce slice to sub-slice -&gt; np ;)\n    v_ref = {\n        // Create sub-slices\n        let (v_l, v_r) = {\n            // Involves some edits -&gt; need mut\n            v_ref.swap(0, len - 1);\n\n            { v_ref }.split_at_mut(len / 2)\n        };\n\n        // Choose slice with which to overwrite\n        // (involves some non-trivial condition here)\n        match len % 2 {\n            0 =&gt; v_l,\n            _ =&gt; v_r,\n        }\n    };\n\n    // And then we do something with v_ref\n    println!(\"{:?}\", v_ref);\n}\n</code></pre>\n\n<p>Essentially:</p>\n\n<ul>\n<li>We start with a mutable variable, <code>mut v_ref: &amp;mut [i32]</code>, containing a mutable reference to a slice</li>\n<li>We make two sub-slices from <code>v_ref</code> using <code>split_at_mut</code>*</li>\n<li>The variable <code>v_ref</code> is overwritten to hold one of the sub-slices</li>\n</ul>\n\n<p>*(<em>Note</em> - We avoid the problem of having two mutable references by <em>moving</em> <code>v_ref</code>, <a href=\"https://chrismorgan.info/blog/rust-ownership-the-hard-way.html\" rel=\"nofollow noreferrer\">as opposed to reborrowing</a>, by using <a href=\"https://bluss.github.io/rust/fun/2015/10/11/stuff-the-identity-function-does/\" rel=\"nofollow noreferrer\">an identity block</a>)</p>\n\n<p>(Regarding the intent of the code - this slice reduction is intended to be repeated in a loop; however this detail does not affect the problem)</p>\n\n<h1>Version 2 - Fails to compile</h1>\n\n<p>Version 2 is nearly identical to version 1, <em>except</em> that the sub-slice creation is moved to its own function:</p>\n\n<pre><code>fn example2_inner(v_ref: &amp;mut [i32]) -&gt; (&amp;mut [i32], &amp;mut [i32]) {\n    // Recreate len variable in function scope\n    let len = v_ref.len();\n\n    // Same mutation here\n    v_ref.swap(0, len - 1);\n\n    // Same slice split here\n    v_ref.split_at_mut(len / 2)\n}\n\npub fn example2() {\n    let mut v = [0, 1, 2, 3];\n\n    let mut v_ref = &amp;mut v[..];\n    let len = v_ref.len();\n\n    // This now fails to compile :(\n    v_ref = {\n        // Mutating &amp; slice spliting moved to function\n        let (v_l, v_r) = example2_inner({ v_ref });\n\n        match len % 2 {\n            0 =&gt; v_l,\n            _ =&gt; v_r,\n        }\n    };\n\n    println!(\"{:?}\", v_ref);\n}\n</code></pre>\n\n<p>When I try to build this, I get the following errors:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0506]: cannot assign to `v_ref` because it is borrowed\n  --&gt; src/lib.rs:19:5\n   |\n19 | /     v_ref = {\n20 | |         // Mutating &amp; slice spliting moved to function\n21 | |         let (v_l, v_r) = example2_inner({ v_ref });\n   | |                                           ----- borrow of `v_ref` occurs here\n22 | |\n...  |\n26 | |         }\n27 | |     };\n   | |_____^ assignment to borrowed `v_ref` occurs here\n\nerror[E0502]: cannot borrow `v_ref` as immutable because `*v_ref` is also borrowed as mutable\n  --&gt; src/lib.rs:29:22\n   |\n21 |         let (v_l, v_r) = example2_inner({ v_ref });\n   |                                           ----- mutable borrow occurs here\n...\n29 |     println!(\"{:?}\", v_ref);\n   |                      ^^^^^ immutable borrow occurs here\n30 | }\n   | - mutable borrow ends here\n</code></pre>\n\n<h1>Questions</h1>\n\n<ul>\n<li>Why don't these two examples compile the same way? Are mutable reference move semantics (i.e., the <code>{vref}</code> from E1) enforced for methods (i.e. <code>split_at_mut</code>), but not functions (i.e., <code>example2_inner</code>)? Why is this the case?</li>\n<li>I would like to keep <code>example2_inner</code> as an independent utility function: how would I change Example 2 to accommodate that?</li>\n</ul>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1535386639, "post_id": 52043256, "comment_id": 91037408, "body": "Seems pretty straightforward: it&#39;s warning you that the lifetime is used only once in the struct."}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 0, "creation_date": 1535386767, "post_id": 52043256, "comment_id": 91037471, "body": "Yeah, but how can this be solved? (Without removing the <code>#![warn(...)]</code>)"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "edited": false, "score": 1, "creation_date": 1535386784, "post_id": 52043256, "comment_id": 91037483, "body": "@trentcl What is the purpose of the warning in this context? The lint is supposed to be for suggesting when unnamed <code>&#39;_</code>  lifetimes can be used instead, but that doesn&#39;t appear to be the case here."}, {"owner": {"reputation": 17608, "user_id": 3650362, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Fqdi1.jpg?s=128&g=1", "display_name": "trentcl", "link": "https://stackoverflow.com/users/3650362/trentcl"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535396881, "post_id": 52043256, "comment_id": 91042039, "body": "@Peter This looks like a bug given the accepted answer, but at first I thought that maybe it doesn&#39;t <i>have</i> a purpose in this context, in which case &quot;just turn it off&quot; would be the correct answer. Lots of warnings exist that shouldn&#39;t be turned on all the time"}], "answers": [{"comments": [{"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1535386949, "post_id": 52043368, "comment_id": 91037571, "body": "Shouldn&#39;t <code>#[automatically_derived]</code> disallow such warnings?"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1535387109, "post_id": 52043368, "comment_id": 91037627, "body": "Looks like a bug that should be reported."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 0, "creation_date": 1535387321, "post_id": 52043368, "comment_id": 91037725, "body": "@TimDiekmann I <i>think</i> that&#39;s what I just added a link to, but perhaps the lint name has changed over time?"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 6, "last_activity_date": 1535397657, "last_edit_date": 1535397657, "creation_date": 1535386870, "answer_id": 52043368, "question_id": 52043256, "link": "https://stackoverflow.com/questions/52043256/what-does-single-use-lifetimes-mean-on-a-struct-with-derive-in-a-function-and/52043368#52043368", "title": "What does `single_use_lifetimes` mean on a struct with derive in a function and how to solve it?", "body": "<p>The purpose is to prevent code like this, where the lifetime is meaningless to specify explicitly:</p>\n\n<pre><code>pub fn example&lt;'a&gt;(_val: SomeType&lt;'a&gt;) {}\n</code></pre>\n\n<p>Instead, it's preferred to use <code>'_</code>:</p>\n\n<pre><code>pub fn example(_val: SomeType&lt;'_&gt;) {}\n</code></pre>\n\n<p>If you <a href=\"https://stackoverflow.com/q/28580386/155423\">expand your code</a> and trim it down, you get this:</p>\n\n<pre><code>use std::fmt;\n\nstruct Foo&lt;'a&gt; {\n    bar: &amp;'a u32,\n}\n\nimpl&lt;'a&gt; fmt::Debug for Foo&lt;'a&gt; {\n    fn fmt(&amp;self, _f: &amp;mut fmt::Formatter) -&gt; fmt::Result { Ok(()) }\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>warning: lifetime parameter `'a` only used once\n --&gt; src/lib.rs:9:6\n  |\n9 | impl&lt;'a&gt; fmt::Debug for Foo&lt;'a&gt; {\n  |      ^^\n  |\n</code></pre>\n\n<p>That is, the <code>&lt;'a&gt;</code> isn't needed, but the derive adds it anyway (because automatically generating code is hard).</p>\n\n<p>I honestly don't know what it would expect the code to change to here, as you can't use <code>'_</code> for the struct's generic lifetimes there...</p>\n\n<blockquote>\n  <p>How can this be solved?</p>\n</blockquote>\n\n<p>I don't know that it can, without rewriting the <code>derive</code> implementation of <code>Debug</code>.</p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://github.com/rust-lang/rust/issues/51903\" rel=\"nofollow noreferrer\">println!(), derive(Debug), derive(Clone), and probably many other macros break when using the elided_lifetimes_in_paths lint </a></li>\n</ul>\n"}], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 161, "favorite_count": 0, "accepted_answer_id": 52043368, "answer_count": 1, "score": 2, "last_activity_date": 1535397657, "creation_date": 1535386399, "last_edit_date": 1535386480, "question_id": 52043256, "link": "https://stackoverflow.com/questions/52043256/what-does-single-use-lifetimes-mean-on-a-struct-with-derive-in-a-function-and", "title": "What does `single_use_lifetimes` mean on a struct with derive in a function and how to solve it?", "body": "<pre><code>#![warn(single_use_lifetimes)]\n\nfn do_foo() {\n    #[derive(Debug)]\n    struct Foo&lt;'a&gt; {\n        bar: &amp;'a u32,\n    }\n}\n</code></pre>\n\n<p>results in this warning:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>warning: lifetime parameter `'a` only used once\n --&gt; src/lib.rs:6:16\n  |\n6 |     struct Foo&lt;'a&gt; {\n  |                ^^\n  |\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=b2c32414ed3d3d043b8487753c63cd94\" rel=\"nofollow noreferrer\">playground</a></p>\n\n<p>What does this warning mean? How can this be solved?</p>\n\n<p>This warning is not shown when omitting either the derive or the function.</p>\n"}, {"tags": ["vector", "rust"], "answers": [{"comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535435878, "post_id": 52042241, "comment_id": 91052194, "body": "Can this be done with a recursive function? I wonder what the method signature would look like."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535467055, "post_id": 52042241, "comment_id": 91071147, "body": "Amazing! &lt;3 Thanks!"}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 10, "last_activity_date": 1537345985, "last_edit_date": 1537345985, "creation_date": 1535382670, "answer_id": 52042241, "question_id": 52042045, "link": "https://stackoverflow.com/questions/52042045/get-the-number-of-elements-stored-inside-an-n-dimensional-vector/52042241#52042241", "title": "Get the number of elements stored inside an n-dimensional vector", "body": "<p>You do not need an explicit loop to do so:</p>\n\n<pre><code>let vec2d = vec![\n    vec![1, 1, 1],\n    vec![1, 1, 1],\n];\n\nlet n_vec_element: usize = vec2d.iter().map(Vec::len).sum();\n\nassert_eq!(n_vec_element, 6);\n</code></pre>\n\n<p>For a 3d vector, you can do the same:</p>\n\n<pre><code>let vec3d = vec![\n    vec![\n        vec![1, 3, 5 as i32],\n        vec![2, 4, 6 as i32],\n        vec![3, 5, 7 as i32],\n    ],\n    vec![\n        vec![1, 3, 5 as i32],\n        vec![2, 4, 6 as i32],\n        vec![3, 5, 7 as i32],\n    ]\n];\n\nlet n_vec_element: usize = vec3d.iter().flatten().map(Vec::len).sum();\n\nassert_eq!(n_vec_element, 18);\n</code></pre>\n\n<p>With a 4D vector, you can put 2 <code>flatten</code>, etc.</p>\n\n<hr>\n\n<p>With the specialization feature (<em>i.e.</em>, with the nightly compiler), you can generalize this with an unique method:</p>\n\n<pre><code>#![feature(specialization)]\n\ntrait Count {\n    fn count(self) -&gt; usize;\n}\n\nimpl&lt;T&gt; Count for T {\n    default fn count(self) -&gt; usize {\n        1\n    }\n}\n\nimpl&lt;T&gt; Count for T\nwhere\n    T: IntoIterator,\n    T::Item: Count,\n{\n    fn count(self) -&gt; usize {\n        self.into_iter().map(|x| x.count()).sum()\n    }\n}\n\nfn main() {\n    let v = vec![1, 2, 3];\n    assert_eq!(v.count(), 3);\n\n    let v = vec![vec![1, 2, 3], vec![4, 5, 6]];\n    assert_eq!(v.count(), 6);\n}\n</code></pre>\n"}], "owner": {"reputation": 53, "user_id": 6093746, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/bc1399997a98cb4059d3a814fb2187bd?s=128&d=identicon&r=PG&f=1", "display_name": "henzosabiq", "link": "https://stackoverflow.com/users/6093746/henzosabiq"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 278, "favorite_count": 1, "accepted_answer_id": 52042241, "answer_count": 1, "score": 5, "last_activity_date": 1537345985, "creation_date": 1535381918, "last_edit_date": 1535385302, "question_id": 52042045, "link": "https://stackoverflow.com/questions/52042045/get-the-number-of-elements-stored-inside-an-n-dimensional-vector", "title": "Get the number of elements stored inside an n-dimensional vector", "body": "<p>I have a 2-dimensional vector:</p>\n\n<pre><code>let vec2d = vec![\n    vec![1, 1, 1],\n    vec![1, 1, 1],\n];\n</code></pre>\n\n<p>I can yield the total of elements stored this way:</p>\n\n<pre><code>let mut n_vec_element: i32 = 0;\n\nfor i in vec2d.iter() {\n    n_vec_element += i.len() as i32;\n}\n\nprintln!(\"2D vector elements :{}\", n_vec_element); // prints 6\n</code></pre>\n\n<p>When I increase the dimensions, the loop gets longer:</p>\n\n<pre><code>let mut n_vec_element: i32 = 0;\n\nlet vec3d = vec![\n    vec![\n        vec![1, 3, 5 as i32],\n        vec![2, 4, 6 as i32],\n        vec![3, 5, 7 as i32],\n    ],\n    vec![\n        vec![1, 3, 5 as i32],\n        vec![2, 4, 6 as i32],\n        vec![3, 5, 7 as i32],\n    ]\n];\n\nfor i in vec3d.iter() {\n\n    // I must add another iter everytime I increment the dimension by 1.\n    // Else, it returns the number of stored vector instead of the vector \n    // elements.\n\n    for j in i.iter() { \n        n_vec_size += j.len() as i32;\n    }\n};\n\nprintln!(\"3D vector elements :{}\", n_vec_element); // prints 18\n</code></pre>\n\n<p>There must be a more concise way to do this, but I haven't figured it out yet. Initially, I tried using vector's <code>len()</code> function but as I said above, it returns number of vectors stored instead of its elements. </p>\n"}, {"tags": ["syntax", "rust"], "comments": [{"owner": {"reputation": 198293, "user_id": 707111, "user_type": "moderator", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/oXZkh.jpg?s=128&g=1", "display_name": "Ry-", "link": "https://stackoverflow.com/users/707111/ry"}, "edited": false, "score": 1, "creation_date": 1535359875, "post_id": 52035619, "comment_id": 91021329, "body": "Position 5 is the end of the string, and you\u2019re asking for 5 until the end of the string, so it\u2019s the empty string. 6 would panic because it\u2019s <i>after</i> the end."}, {"owner": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "reply_to_user": {"reputation": 198293, "user_id": 707111, "user_type": "moderator", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/oXZkh.jpg?s=128&g=1", "display_name": "Ry-", "link": "https://stackoverflow.com/users/707111/ry"}, "edited": false, "score": 0, "creation_date": 1535360453, "post_id": 52035619, "comment_id": 91021645, "body": "I suspect that the fifth index is the end of the line, it&#39;s only strange that it is taken into account. Although, probably, this is correct. I just do not understand how the string is arranged. Apparently, the end of the line, this is also a significant symbol, i.e. empty character."}, {"owner": {"reputation": 198293, "user_id": 707111, "user_type": "moderator", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/oXZkh.jpg?s=128&g=1", "display_name": "Ry-", "link": "https://stackoverflow.com/users/707111/ry"}, "edited": false, "score": 0, "creation_date": 1535360885, "post_id": 52035619, "comment_id": 91021929, "body": "It\u2019s not the end of the <i>line</i>, it\u2019s the end of the string. There\u2019s no character there \u2013 <code>s[5]</code> is not valid \u2013 but there\u2019s space for an empty, zero-length slice."}], "answers": [{"comments": [{"owner": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "edited": false, "score": 0, "creation_date": 1535365780, "post_id": 52035841, "comment_id": 91024782, "body": "Is it possible to ignore last (empty) slice index item in this case? If so how I can dot it?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "edited": false, "score": 0, "creation_date": 1535366545, "post_id": 52035841, "comment_id": 91025212, "body": "I&#39;m not sure if I understand your question correctly. This code is just an example. If you change the loop to go to <code>s.len()</code> instead of <code>s.len() + 1</code> then it wouldn&#39;t include the last empty slice. Is that what you mean?"}, {"owner": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "edited": false, "score": 0, "creation_date": 1535366893, "post_id": 52035841, "comment_id": 91025414, "body": "This solution at the level of algorithm. It is very easy to make a mistake. It would be great if the compiler or any auxiliary program would help to detect such behavior (unexpected, unnecessary)."}, {"owner": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "edited": false, "score": 0, "creation_date": 1535367186, "post_id": 52035841, "comment_id": 91025584, "body": "I think the solution is do not use indexes while working with slides. It would be better to use <code>code</code>iter()<code>:      fn main() {     &#47;&#47;let s = String::from(&quot;hello&quot;);     let s = [1..10];     for i in 0..s.len() + 1 {         println!(&quot;slice = {:?}&quot;, &amp;s[i..]);     }          for element in s.iter() {         println!(&quot;slice = {:?}&quot;, element);     } } </code>code`"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "edited": false, "score": 3, "creation_date": 1535369176, "post_id": 52035841, "comment_id": 91026737, "body": "The compiler can&#39;t protect you from logical errors. If you intended to write <code>&amp;s[1..3]</code>, but accidentally wrote <code>&amp;[0..2]</code>, you&#39;re on your own. And yes, you are right: iterators are usually the best approach for looping, and are often faster than looping over indices."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 14, "last_activity_date": 1535360967, "last_edit_date": 1535360967, "creation_date": 1535360456, "answer_id": 52035841, "question_id": 52035619, "link": "https://stackoverflow.com/questions/52035619/why-does-a-slice-starting-at-the-length-of-a-string-not-panic/52035841#52035841", "title": "Why does a slice starting at the length of a string not panic?", "body": "<p>Ranges in Rust do not include the upper bound (unless you use the <code>..=</code> range constructor). That means that ranges like <code>2..2</code> are zero length: \"start at 2 and take each element up to, but not including 2\". When the length is <code>5</code>, <code>5..5</code> and <code>5..</code> are equivalent.</p>\n\n<p>While it doesn't seem to make much sense to start a range past the last element, it is convenient that this works this way. For example, if you were taking ever shrinking ranges:</p>\n\n<pre><code>for i in 0 .. s.len() + 1 {\n    println!(\"slice = {:?}\", &amp;s[i ..]);\n}\n</code></pre>\n\n<p>Outputs:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>slice = \"hello\"\nslice = \"ello\"\nslice = \"llo\"\nslice = \"lo\"\nslice = \"o\"\nslice = \"\"\n</code></pre>\n\n<p>It would be annoying if you had to handle the last, empty slice, case separately.</p>\n\n<p>But going further past the length of the data <em>will</em> cause a panic. There's no reason why you would intentionally have written <code>s[6..6]</code> when the string's length is 5.</p>\n"}], "owner": {"reputation": 637, "user_id": 6999141, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/8056cd6d51c3c6f3dd6bd787259b4a1d?s=128&d=identicon&r=PG", "display_name": "Anatolii Kosorukov", "link": "https://stackoverflow.com/users/6999141/anatolii-kosorukov"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 480, "favorite_count": 4, "accepted_answer_id": 52035841, "answer_count": 1, "score": 7, "last_activity_date": 1545065533, "creation_date": 1535359597, "last_edit_date": 1545065533, "question_id": 52035619, "link": "https://stackoverflow.com/questions/52035619/why-does-a-slice-starting-at-the-length-of-a-string-not-panic", "title": "Why does a slice starting at the length of a string not panic?", "body": "<pre><code>fn main() {\n    let s = String::from(\"hello\");\n    let hello = &amp;s[5..];\n    println!(\"{}\", hello);\n}\n</code></pre>\n\n<p>Why does this code run without a panic? I think this is a condition where the index goes beyond the size of the content. The output of this code example shows nothing.</p>\n"}, {"tags": ["serialization", "rust", "serde", "serde-json"], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 8, "last_activity_date": 1538409605, "last_edit_date": 1538409605, "creation_date": 1535357270, "answer_id": 52035083, "question_id": 52034764, "link": "https://stackoverflow.com/questions/52034764/how-do-i-serialize-an-enum-without-including-the-name-of-the-enum-variant/52035083#52035083", "title": "How do I serialize an enum without including the name of the enum variant?", "body": "<p>You can use the <a href=\"https://serde.rs/enum-representations.html#untagged\" rel=\"nofollow noreferrer\"><code>untagged</code></a> attribute which will produce the desired output. You won't need to implement <code>Serialize</code> yourself with this:</p>\n\n<pre><code>#[derive(Debug, Serialize)]\n#[serde(untagged)]\nenum TValue&lt;'a&gt; {\n    String(&amp;'a str),\n    Int(&amp;'a i32),\n}\n</code></pre>\n\n<hr>\n\n<p>If you wanted to implement <code>Serialize</code> yourself, I believe you want to skip your variant so you should not use <code>serialize_newtype_variant()</code> as it exposes your variant. You should use  <code>serialize_str()</code> and <code>serialize_i32()</code> directly:</p>\n\n<pre><code>impl&lt;'a&gt; Serialize for TValue&lt;'a&gt; {\n    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;\n    where\n        S: Serializer,\n    {\n        match *self {\n            TValue::String(s) =&gt; serializer.serialize_str(s),\n            TValue::Int(i) =&gt; serializer.serialize_i32(*i),\n        }\n    }\n}\n</code></pre>\n\n<p>It produces the desired output: </p>\n\n<pre><code>{\"offset\":0}\n</code></pre>\n"}], "owner": {"reputation": 243, "user_id": 3642703, "user_type": "registered", "accept_rate": 100, "profile_image": "https://graph.facebook.com/100002641138406/picture?type=large", "display_name": "Jade", "link": "https://stackoverflow.com/users/3642703/jade"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 1721, "favorite_count": 0, "accepted_answer_id": 52035083, "answer_count": 1, "score": 3, "last_activity_date": 1538409605, "creation_date": 1535355803, "last_edit_date": 1535371332, "question_id": 52034764, "link": "https://stackoverflow.com/questions/52034764/how-do-i-serialize-an-enum-without-including-the-name-of-the-enum-variant", "title": "How do I serialize an enum without including the name of the enum variant?", "body": "<p>I am trying to serialize an enum to a JSON string. I implemented <code>Serialize</code> trait for my enum as it is described in the docs, but I always get <code>{\"offset\":{\"Int\":0}}</code> instead of the desired <code>{\"offset\":0}</code>. </p>\n\n<pre><code>extern crate serde;\nextern crate serde_json;\n\nuse std::collections::HashMap;\n\nuse serde::ser::{Serialize, Serializer};\n\n#[derive(Debug)]\nenum TValue&lt;'a&gt; {\n    String(&amp;'a str),\n    Int(&amp;'a i32),\n}\n\nimpl&lt;'a&gt; Serialize for TValue&lt;'a&gt; {\n    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;\n    where\n        S: Serializer,\n    {\n        match *self {\n            TValue::String(ref s) =&gt; serializer.serialize_newtype_variant(\"TValue\", 0, \"String\", s),\n            TValue::Int(i) =&gt; serializer.serialize_newtype_variant(\"TValue\", 1, \"Int\", &amp;i),\n        }\n    }\n}\n\nfn main() {\n    let offset: i32 = 0;\n    let mut request_body = HashMap::new();\n    request_body.insert(\"offset\", TValue::Int(&amp;offset));\n    let serialized = serde_json::to_string(&amp;request_body).unwrap();\n    println!(\"{}\", serialized); // {\"offset\":{\"Int\":0}}\n}\n</code></pre>\n"}, {"tags": ["rust", "copy", "borrow-checker"], "answers": [{"tags": [], "owner": {"reputation": 134258, "user_id": 785065, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/qAbxM.jpg?s=128&g=1", "display_name": "loganfsmyth", "link": "https://stackoverflow.com/users/785065/loganfsmyth"}, "is_accepted": true, "score": 26, "last_activity_date": 1592407429, "last_edit_date": 1592407429, "creation_date": 1535327217, "answer_id": 52031060, "question_id": 52031002, "link": "https://stackoverflow.com/questions/52031002/how-do-i-move-out-of-a-struct-field-that-is-an-option/52031060#52031060", "title": "How do I move out of a struct field that is an Option?", "body": "<p>Essentially, you can't assign the value to <code>self.attrib</code> if it's still owned by <code>self.next_atrrib</code>. That means you need to remove the value from <code>self.next_attrib</code> and then give ownership to <code>self.attrib</code>.</p>\n\n<p>One way to do this would be to manually replace the value. For instance, you could use <a href=\"https://doc.rust-lang.org/std/mem/fn.replace.html\" rel=\"noreferrer\"><code>std::mem::replace</code></a> to replace the value with <code>None</code> and take ownership of the current value as <code>next_attrib</code>. Then you can take the value and, if it is <code>Some(_)</code>, you can place its content in <code>self.attrib</code>.:</p>\n\n<pre><code>impl SomeStruct {\n    pub fn apply_changes(&amp;mut self) {\n        let next_attrib = std::mem::replace(&amp;mut self.next_attrib, None);\n        if let Some(se) = next_attrib {\n            self.attrib = se;\n        }\n    }\n}\n</code></pre>\n\n<p>Since this is a relatively common pattern, however, there is a utility function on <code>Option</code> to handle situations where you'd like to take ownership of the contents of an <code>Option</code> and set the <code>Option</code> to <code>None</code>. The <a href=\"https://doc.rust-lang.org/std/option/enum.Option.html#method.take\" rel=\"noreferrer\"><code>Option::take</code></a> method is what you want.</p>\n\n<pre><code>impl SomeStruct {\n    pub fn apply_changes(&amp;mut self) {\n        if let Some(se) = self.next_attrib.take() {\n            self.attrib = se;\n        }\n    }\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/27098694/155423\">How can I swap in a new value for a field in a mutable reference to a structure?</a></li>\n</ul>\n"}], "owner": {"reputation": 941, "user_id": 7617604, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d7f920ede1516b4f8460a1b0e554bc8b?s=128&d=identicon&r=PG&f=1", "display_name": "Burdui", "link": "https://stackoverflow.com/users/7617604/burdui"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2723, "favorite_count": 0, "accepted_answer_id": 52031060, "answer_count": 1, "score": 14, "last_activity_date": 1592407429, "creation_date": 1535326431, "last_edit_date": 1535327476, "question_id": 52031002, "link": "https://stackoverflow.com/questions/52031002/how-do-i-move-out-of-a-struct-field-that-is-an-option", "title": "How do I move out of a struct field that is an Option?", "body": "<p>I want to collect changes to a struct and apply them all at once.\nThe basic outline looks like this:</p>\n\n<pre><code>enum SomeEnum {\n    Foo,\n    Bar,\n}\n\nstruct SomeStruct {\n    attrib: SomeEnum,\n    next_attrib: Option&lt;SomeEnum&gt;,\n}\n\nimpl SomeStruct {\n    pub fn apply_changes(&amp;mut self) {\n        if let Some(se) = self.next_attrib {\n            self.attrib = se;\n        }\n        self.next_attrib = None;\n    }\n}\n</code></pre>\n\n<p>which yields the following compiler error:</p>\n\n<blockquote>\n  <pre class=\"lang-none prettyprint-override\"><code>error[E0507]: cannot move out of borrowed content\n  --&gt; src/lib.rs:13:27\n   |\n13 |         if let Some(se) = self.next_attrib {\n   |                     --    ^^^^ cannot move out of borrowed content\n   |                     |\n   |                     hint: to prevent move, use `ref se` or `ref mut se`\n</code></pre>\n</blockquote>\n\n<p>I found <a href=\"https://stackoverflow.com/questions/28843931/get-an-enum-field-from-a-struct-cannot-move-out-of-borrowed-content\">Get an enum field from a struct: cannot move out of borrowed content</a> and added <code>#[derive(Clone, Copy)]</code> to my enum's definition.</p>\n\n<p>This may work but I feel uncomfortable about (implicitly) using copying since this could generally happen to larger datatypes as well.</p>\n\n<p>The actual owner is never moved out of the struct.</p>\n\n<p>Is there another way to accomplish this, without exposing the <code>Copy</code>/<code>Clone</code> traits to all users of the enum?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 6, "last_activity_date": 1535317274, "last_edit_date": 1592644375, "creation_date": 1535317274, "answer_id": 52030229, "question_id": 52030175, "link": "https://stackoverflow.com/questions/52030175/how-can-i-retrieve-the-full-path-of-a-trait-bound-in-a-rust-compiler-plugin/52030229#52030229", "title": "How can I retrieve the full path of a trait bound in a Rust compiler plugin?", "body": "<p>You can't.</p>\n<blockquote>\n<h1><a href=\"https://rust-lang-nursery.github.io/rustc-guide/rustc-driver.html\" rel=\"noreferrer\">The Rustc Driver</a>:</h1>\n<p>[\u2026] the main phases of the compiler are:</p>\n<ol>\n<li>Parse Input: Initial crate parsing</li>\n<li>Configure and Expand: Resolve <code>#[cfg]</code> attributes, name resolution, and <strong>expand macros</strong></li>\n<li>Run Analysis Passes: <strong>Run trait resolution</strong>, typechecking, region checking and other miscellaneous analysis passes on the crate</li>\n<li>Translate to LLVM: Translate to the in-memory form of LLVM IR and turn it into an executable/object files</li>\n</ol>\n</blockquote>\n<p>(emphasis is mine)</p>\n<p>Macros are expanded before trait resolution is done, so at the time your plugin is run, nothing is known about this <code>Debug</code> except the name given in the source code.</p>\n"}], "owner": {"reputation": 2959, "user_id": 5903309, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/665cdb14fb46d20c11a176c92e6ed663?s=128&d=identicon&r=PG", "display_name": "Jan Nils Ferner", "link": "https://stackoverflow.com/users/5903309/jan-nils-ferner"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 53, "favorite_count": 1, "accepted_answer_id": 52030229, "answer_count": 1, "score": 4, "last_activity_date": 1535317274, "creation_date": 1535316751, "question_id": 52030175, "link": "https://stackoverflow.com/questions/52030175/how-can-i-retrieve-the-full-path-of-a-trait-bound-in-a-rust-compiler-plugin", "title": "How can I retrieve the full path of a trait bound in a Rust compiler plugin?", "body": "<p>I'm working on a Rust plugin that needs to access the absolute path of a trait bound. In practice, this means that for the following code, I want to resolve the full path of <code>Debug</code> as <code>std::fmt::Debug</code>.</p>\n\n<pre><code>use std::fmt::*;\n\n#[foo]\ntrait Foo: Debug {}\n</code></pre>\n\n<p>My current approach consist of taking the <code>Annotatable</code> that <code>MultiItemDecorator</code> provides for me and pattern matching it to\n<code>Annotatable::Item</code>, where I match <code>.node</code> to <code>ItemKind::Trait</code>. I then match <code>.generic_bounds</code> to a collection of <code>GenericBound::Trait</code>, where I retrieve <code>.trait_ref.path</code>. </p>\n\n<p>This struct however only contains <code>path(Debug)</code>, which is not enough information for me.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535313845, "post_id": 52029790, "comment_id": 91010063, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/35568871/155423\">Is it possible to implement inherent methods on type aliases?</a> and <a href=\"https://stackoverflow.com/q/25413201/155423\">How do I implement a trait I don&#39;t own for a type I don&#39;t own?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/52029790/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 3, "creation_date": 1535313875, "post_id": 52029790, "comment_id": 91010077, "body": "TL;DR: You don&#39;t, you can&#39;t, and that&#39;s by design."}, {"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1535315415, "post_id": 52029790, "comment_id": 91010438, "body": "Possible duplicate of <a href=\"https://stackoverflow.com/questions/35568871/is-it-possible-to-implement-inherent-methods-on-type-aliases\">Is it possible to implement inherent methods on type aliases?</a>"}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "reply_to_user": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 1, "creation_date": 1535315559, "post_id": 52029790, "comment_id": 91010469, "body": "@E_net4 I don&#39;t think he actually wants to implement <code>Debug</code> on the type alias, but to implement <code>Debug</code> on <code>Range</code>, which cannot simply derive it, as it is usually done."}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 1, "creation_date": 1535315594, "post_id": 52029790, "comment_id": 91010477, "body": "Looks a bit like an XY problem to me"}], "answers": [{"comments": [{"owner": {"reputation": 4999, "user_id": 595335, "user_type": "registered", "accept_rate": 66, "profile_image": "https://i.stack.imgur.com/4h21E.jpg?s=128&g=1", "display_name": "Max Alexander", "link": "https://stackoverflow.com/users/595335/max-alexander"}, "edited": false, "score": 0, "creation_date": 1535574095, "post_id": 52030021, "comment_id": 91121303, "body": "Ah thank you! Only thing is I wonder how to capture the signature of the function when printing it."}, {"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "reply_to_user": {"reputation": 4999, "user_id": 595335, "user_type": "registered", "accept_rate": 66, "profile_image": "https://i.stack.imgur.com/4h21E.jpg?s=128&g=1", "display_name": "Max Alexander", "link": "https://stackoverflow.com/users/595335/max-alexander"}, "edited": false, "score": 0, "creation_date": 1535575938, "post_id": 52030021, "comment_id": 91122101, "body": "@MaxAlexander that&#39;s not possible in stable Rust. See <a href=\"https://github.com/rust-lang/rfcs/issues/1428\" rel=\"nofollow noreferrer\">Expose the <code>type_name</code> intrinsic</a>, and maybe drop your use case there, there has been recent activity."}], "tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 8, "last_activity_date": 1535315308, "creation_date": 1535315308, "answer_id": 52030021, "question_id": 52029790, "link": "https://stackoverflow.com/questions/52029790/how-do-i-implement-debug-for-a-struct-containing-a-function-type-alias/52030021#52030021", "title": "How do I implement Debug for a struct containing a function type alias?", "body": "<p><a href=\"https://stackoverflow.com/q/25413201/155423\">You can't implement (or derive) a trait you don't own on a type you don't own.</a></p>\n\n<p>However, that's not what you want to do. What you want is to implement <code>Debug</code> for <code>Range</code>, but you can't do that by deriving because <code>fn</code>s don't implement <code>Debug</code>.\nIndeed, deriving <code>Debug</code> requires all fields to be <code>Debug</code> as well. Then you are stuck with implementing <code>Debug</code> by yourself; It is after all, just a normal trait:</p>\n\n<pre><code>type RangeFn = fn(&amp;(), &amp;()) -&gt; bool;\n\nstruct Range {\n    fun: RangeFn,\n    other_field: u32,\n}\n\nimpl std::fmt::Debug for Range {\n    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter) -&gt; std::result::Result&lt;(), std::fmt::Error&gt; {\n        f.debug_struct(\"Range\")\n            .field(\"other_field\", &amp;self.other_field)\n            .finish()\n    }\n}\n\nfn main() {\n    let r = Range {\n        fun: |_, _| true,\n        other_field: 42,\n    };\n\n    println!(\"{:?}\", r);\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?gist=07b1edd344ed321588aff7bef680458d&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"noreferrer\">link to playground</a>)</p>\n"}], "owner": {"reputation": 4999, "user_id": 595335, "user_type": "registered", "accept_rate": 66, "profile_image": "https://i.stack.imgur.com/4h21E.jpg?s=128&g=1", "display_name": "Max Alexander", "link": "https://stackoverflow.com/users/595335/max-alexander"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 604, "favorite_count": 0, "accepted_answer_id": 52030021, "answer_count": 1, "score": 3, "last_activity_date": 1535315915, "creation_date": 1535313349, "last_edit_date": 1535315915, "question_id": 52029790, "link": "https://stackoverflow.com/questions/52029790/how-do-i-implement-debug-for-a-struct-containing-a-function-type-alias", "title": "How do I implement Debug for a struct containing a function type alias?", "body": "<p>I have the following type:</p>\n\n<pre><code>type RangeFn = fn(&amp;Value, &amp;Value) -&gt; bool;\n</code></pre>\n\n<p>Now I want to put it with this <code>struct</code>:</p>\n\n<pre><code>#[derive(Debug)]\nstruct Range {\n    fun: RangeFn,\n}\n</code></pre>\n\n<p>But if I have a <code>struct</code> that takes <code>RangeFn</code> as a parameter, then I can't seem to have it derive from <code>Debug</code>. How do I make <code>RangeFn</code> compatible with the <code>Debug</code> trait?</p>\n"}, {"tags": ["rust", "compiler-warnings"], "comments": [{"owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "edited": false, "score": 0, "creation_date": 1535302277, "post_id": 52028325, "comment_id": 91007001, "body": "You do not need to put the type of <code>i</code>. Because of the line <code>i = Some(0)</code>, the compiler knows that <code>i</code> is <code>Option&lt;i32&gt;</code>"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1535305443, "post_id": 52028325, "comment_id": 91007871, "body": "Since this is a compiler bug, you could perhaps just live with the warning, or suppress it in this instance with <code>#[allow(unused_assignments)]</code> on the containing function."}], "answers": [{"comments": [{"owner": {"reputation": 1414, "user_id": 6564029, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/WxyK5.jpg?s=128&g=1", "display_name": "Michail", "link": "https://stackoverflow.com/users/6564029/michail"}, "edited": false, "score": 0, "creation_date": 1535303321, "post_id": 52028389, "comment_id": 91007285, "body": "Hm, I&#39;ll try to do something like that, but that&#39;s going to be convoluted, to say the least. The actual code has some <code>return</code>s and <code>if let</code>s, which complicates expression extraction somewhat."}], "tags": [], "owner": {"reputation": 25137, "user_id": 4498831, "user_type": "registered", "accept_rate": 92, "profile_image": "https://i.stack.imgur.com/jDBV2.png?s=128&g=1", "display_name": "Boiethios", "link": "https://stackoverflow.com/users/4498831/boiethios"}, "is_accepted": true, "score": 7, "last_activity_date": 1535304129, "last_edit_date": 1535304129, "creation_date": 1535302509, "answer_id": 52028389, "question_id": 52028325, "link": "https://stackoverflow.com/questions/52028325/why-does-a-variable-assignment-in-a-loop-before-a-continue-statement-count-as-ne/52028389#52028389", "title": "Why does a variable assignment in a loop before a continue statement count as never read?", "body": "<p>The compiler is not well aware of the flow break controls <a href=\"https://github.com/rust-lang/rust/issues/22630\" rel=\"noreferrer\">because of a bug</a>. If you can, you should use an expression oriented syntax that is more idiomatic:</p>\n\n<pre><code>fn main() {\n    let mut i = None;\n\n    let mut cond = true;\n    while true &amp;&amp; i.map_or(true, |x| x &lt; 10) {\n        i = if cond {\n            cond = false;\n            Some(0)\n        } else {\n            Some(5)\n        }\n    } \n}\n</code></pre>\n\n<p>or create a custom iterator.</p>\n"}], "owner": {"reputation": 1414, "user_id": 6564029, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/WxyK5.jpg?s=128&g=1", "display_name": "Michail", "link": "https://stackoverflow.com/users/6564029/michail"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 232, "favorite_count": 0, "accepted_answer_id": 52028389, "answer_count": 1, "score": 4, "last_activity_date": 1535304129, "creation_date": 1535302023, "last_edit_date": 1535303202, "question_id": 52028325, "link": "https://stackoverflow.com/questions/52028325/why-does-a-variable-assignment-in-a-loop-before-a-continue-statement-count-as-ne", "title": "Why does a variable assignment in a loop before a continue statement count as never read?", "body": "<p>On the following code:</p>\n\n<pre><code>fn main() {\n    let mut i: Option&lt;i32&gt; = None;\n\n    let mut cond = true;\n    while true &amp;&amp; i.map_or(true, |x| x &lt; 10) {\n        if cond {\n            cond = false;\n            i = Some(0);\n            continue;\n        }\n        i = Some(5);\n    } \n}\n</code></pre>\n\n<p>I get the warning:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>warning: value assigned to `i` is never read\n --&gt; src/lib.rs:8:13\n  |\n8 |             i = Some(0);\n  |             ^\n  |\n  = note: #[warn(unused_assignments)] on by default\n</code></pre>\n\n<p>This is very minimized (so please ignore for the moment that it'll loop forever), but shows the issue: the compiler seems to think that <code>i</code> from inside the <code>if</code> is overwritten by the outer assignment, which is clearly not the case due to the <code>continue</code>.</p>\n\n<p>Am I missing something and have I introduced a bug of some description into the program, or is it the compiler's mistake?</p>\n"}, {"tags": ["rust"], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 4, "last_activity_date": 1535301537, "creation_date": 1535301537, "answer_id": 52028267, "question_id": 52028177, "link": "https://stackoverflow.com/questions/52028177/why-does-the-definition-of-cow-use-as-in-ownedb-as-toownedowned/52028267#52028267", "title": "Why does the definition of Cow use &quot;as&quot; in Owned(&lt;B as ToOwned&gt;::Owned)?", "body": "<p>It is just being explicit via <a href=\"https://doc.rust-lang.org/book/second-edition/ch19-03-advanced-traits.html#fully-qualified-syntax-for-disambiguation-calling-methods-with-the-same-name\" rel=\"nofollow noreferrer\">fully qualified syntax</a>. It could equally have been defined as</p>\n\n<pre><code>pub enum Cow&lt;'a, B&gt;\nwhere\n    B: 'a + ToOwned + ?Sized,\n{\n    Borrowed(&amp;'a B),\n    Owned(B::Owned),\n}\n</code></pre>\n\n<p>This syntax is how you access the <em>associated type</em> of <code>B</code>'s implementation of <code>ToOwned</code>.</p>\n"}], "owner": {"reputation": 986, "user_id": 6819040, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/IJDZr.jpg?s=128&g=1", "display_name": "AurevoirXavier", "link": "https://stackoverflow.com/users/6819040/aurevoirxavier"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 57, "favorite_count": 0, "accepted_answer_id": 52028267, "answer_count": 1, "score": 1, "last_activity_date": 1535302817, "creation_date": 1535300893, "last_edit_date": 1535302817, "question_id": 52028177, "link": "https://stackoverflow.com/questions/52028177/why-does-the-definition-of-cow-use-as-in-ownedb-as-toownedowned", "title": "Why does the definition of Cow use &quot;as&quot; in Owned(&lt;B as ToOwned&gt;::Owned)?", "body": "<p>Here's how <a href=\"https://doc.rust-lang.org/std/borrow/enum.Cow.html\" rel=\"nofollow noreferrer\"><code>Cow</code></a> is defined:</p>\n\n<pre><code>pub enum Cow&lt;'a, B&gt;\nwhere\n    B: 'a + ToOwned + ?Sized,\n{\n    Borrowed(&amp;'a B),\n    Owned(&lt;B as ToOwned&gt;::Owned),\n}\n</code></pre>\n\n<p>Why is <code>B as ToOwned</code> there? In order to remove <code>'a</code> and <code>?Sized</code> bounds?</p>\n"}, {"tags": ["rust", "return", "closures"], "comments": [{"owner": {"reputation": 6434, "user_id": 602340, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/c813559e4994a45eb8eedca722399fa0?s=128&d=identicon&r=PG", "display_name": "matiu", "link": "https://stackoverflow.com/users/602340/matiu"}, "edited": false, "score": 0, "creation_date": 1552085810, "post_id": 52027634, "comment_id": 96891925, "body": "You could just go, <code>.unwrap_or(1)</code>"}], "answers": [{"comments": [{"owner": {"reputation": 27886, "user_id": 3337070, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/8974b88c4bd084f5928ad99d4e8033da?s=128&d=identicon&r=PG", "display_name": "sshashank124", "link": "https://stackoverflow.com/users/3337070/sshashank124"}, "edited": false, "score": 1, "creation_date": 1535297406, "post_id": 52027664, "comment_id": 91005570, "body": "That makes sense. I was just hopeful that there was something similar to Kotlin&#39;s <code>return@</code> in the case of a closure parameter"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 14, "last_activity_date": 1535297101, "creation_date": 1535297101, "answer_id": 52027664, "question_id": 52027634, "link": "https://stackoverflow.com/questions/52027634/is-there-any-way-to-return-from-a-function-from-inside-a-closure/52027664#52027664", "title": "Is there any way to return from a function from inside a closure?", "body": "<p>No, there is not. </p>\n\n<p>A closure is a method (a kind of function) under the hood. You are asking for the ability to exit a parent function from an arbitrarily deeply nested function call. Such non-local flow control has generally proven to be extremely bad for programmer sanity and program maintenance.</p>\n\n<hr>\n\n<p>To solve your problem:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/51344951/155423\">How do you unwrap a Result on Ok or return from the function on Err?</a></li>\n</ul>\n"}], "owner": {"reputation": 27886, "user_id": 3337070, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/8974b88c4bd084f5928ad99d4e8033da?s=128&d=identicon&r=PG", "display_name": "sshashank124", "link": "https://stackoverflow.com/users/3337070/sshashank124"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 2757, "favorite_count": 1, "accepted_answer_id": 52027664, "answer_count": 1, "score": 16, "last_activity_date": 1535297101, "creation_date": 1535296876, "last_edit_date": 1535296971, "question_id": 52027634, "link": "https://stackoverflow.com/questions/52027634/is-there-any-way-to-return-from-a-function-from-inside-a-closure", "title": "Is there any way to return from a function from inside a closure?", "body": "<p>I have the following simplified code:</p>\n\n<pre><code>fn f() -&gt; i32 {\n    let a = some_result.unwrap_or_else(|_| {\n        return 1; // want to return this value from f &lt;-------------\n    });\n}\n</code></pre>\n\n<p>I want to return the value <code>1</code> from the whole function <code>f</code> in this specific error case but I can't figure out how to do it from within a closure.</p>\n\n<p>If I instead use a <code>match</code> expression, it works fine as follows:</p>\n\n<pre><code>fn f() -&gt; i32 {\n    let a = match some_result {\n        Ok(result) =&gt; result,\n        Err(_)     =&gt; { return 1; },\n    };\n}\n</code></pre>\n\n<p>However, this makes the code verbose since I have the trivial <code>Ok</code> match arm.</p>\n"}, {"tags": ["rust", "gstreamer", "gif"], "comments": [{"owner": {"reputation": 1771, "user_id": 3040948, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2e165e48a46079440f8ae438b0a3ed88?s=128&d=identicon&r=PG", "display_name": "Sebastian Dr&#246;ge", "link": "https://stackoverflow.com/users/3040948/sebastian-dr%c3%b6ge"}, "edited": false, "score": 0, "creation_date": 1535347787, "post_id": 52026809, "comment_id": 91016202, "body": "It would help if you could provide a full debug log with <code>GST_DEBUG=6</code>. The actual error will be somewhere in there, the reason why something return <code>GST_FLOW_ERROR</code> (-5)."}], "answers": [{"tags": [], "owner": {"reputation": 1913, "user_id": 275196, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/2c20425d4619585036e00049e4f325d6?s=128&d=identicon&r=PG", "display_name": "moatPylon", "link": "https://stackoverflow.com/users/275196/moatpylon"}, "is_accepted": true, "score": 1, "last_activity_date": 1535808931, "creation_date": 1535808931, "answer_id": 52128624, "question_id": 52026809, "link": "https://stackoverflow.com/questions/52026809/extracting-gif-frames-with-gstreamer/52128624#52128624", "title": "Extracting GIF frames with gstreamer", "body": "<p>For anyone hitting similar problems: GIF decoding only works with a pull-based AppSrc. GIF seems to be the only popular web format (like jpgs, pngs, webms, mp4s, etc) which doesn't work with push-based AppSrc APIs.</p>\n"}], "owner": {"reputation": 1913, "user_id": 275196, "user_type": "registered", "accept_rate": 94, "profile_image": "https://www.gravatar.com/avatar/2c20425d4619585036e00049e4f325d6?s=128&d=identicon&r=PG", "display_name": "moatPylon", "link": "https://stackoverflow.com/users/275196/moatpylon"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 345, "favorite_count": 0, "accepted_answer_id": 52128624, "answer_count": 1, "score": 1, "last_activity_date": 1535808931, "creation_date": 1535290731, "question_id": 52026809, "link": "https://stackoverflow.com/questions/52026809/extracting-gif-frames-with-gstreamer", "title": "Extracting GIF frames with gstreamer", "body": "<p>I'm trying to extract the frames of any video (including GIFs) using gstreamer with AppSrc and AppSink. My minimal faulty pipeline in Rust (using the gstreamer crate) is:</p>\n\n<pre><code>let buf = /* All in memory for the moment */;\n\nlet app_src = ElementFactory::make(\"appsrc\", None).unwrap();\nlet decodebin = ElementFactory::make(\"decodebin\", None).unwrap();\nlet app_sink = ElementFactory::make(\"appsink\", None).unwrap();\nlet pipeline = Pipeline::new();\n\npipeline.add_many(&amp;[&amp;app_src, &amp;decodebin, &amp;app_sink]).unwrap();\napp_src.link(&amp;decodebin).unwrap();\n\nlet buf = GstRc::from_slice(buf).unwrap();\nlet app_src = app_src.downcast::&lt;AppSrc&gt;().unwrap();\napp_src.push_buffer(buf).into_result().unwrap();\napp_src.end_of_stream().into_result().unwrap();\n\nlet app_sink = app_sink.downcast::&lt;AppSink&gt;().unwrap();\napp_sink.set_caps(Some(&amp;Caps::from_str(&amp;\"video/x-raw\")).unwrap()));\napp_sink.set_sync(false);\napp_sink.set_wait_on_eos(true);\n\nlet app_sink2 = app_sink.clone();\ndecodebin.connect_pad_added(move |decodebin, _| {\n    let _ = decodebin.link(&amp;app_sink2);\n});\n\npipeline.set_state(State::Playing).into_result().unwrap();\npipeline\n    .get_state(CLOCK_TIME_NONE)\n    .0\n    .into_result()\n    .unwrap()\n\n /* Pull each frame through with app_sink.pull_sample() */\n</code></pre>\n\n<p>This is working with various videos and even images I've tested, but for any GIF it just errors out on <code>pipeline.get_state()</code>. <code>GST_DEBUG=4</code> shows:</p>\n\n<pre><code>0:00:18.929304768 27027 0x7f48746d8050 INFO                   libav gstavdemux.c:1314:gst_ffmpegdemux_open:&lt;avdemux_gif0:video_0&gt; stream tags: taglist, video-codec=(string)\"GIF\\ \\(Graphics\\ Interchange\\ Format\\)\";\n0:00:18.929353999 27027 0x7f48746d8050 WARN                   libav gstavdemux.c:1603:gst_ffmpegdemux_loop:&lt;avdemux_gif0&gt; av_read_frame returned -5\n0:00:18.929370474 27027 0x7f48746d8050 WARN                   libav gstavdemux.c:1590:gst_ffmpegdemux_loop:&lt;avdemux_gif0&gt; error: Internal data stream error.\n0:00:18.929383308 27027 0x7f48746d8050 WARN                   libav gstavdemux.c:1590:gst_ffmpegdemux_loop:&lt;avdemux_gif0&gt; error: streaming stopped, reason error (-5)\n0:00:18.929371274 27027 0x7f48746d8680 INFO            videodecoder gstvideodecoder.c:1330:gst_video_decoder_sink_event_default:&lt;avdec_gif0&gt; upstream tags: taglist, video-codec=(string)\"GIF\\ \\(Graphics\\ Interchange\\ Format\\)\";\n0:00:18.929406505 27027 0x7f48746d8050 INFO        GST_ERROR_SYSTEM gstelement.c:2145:gst_element_message_full_with_details:&lt;avdemux_gif0&gt; posting message: Internal data stream error.\n0:00:18.929462537 27027 0x7f48746d8050 INFO        GST_ERROR_SYSTEM gstelement.c:2172:gst_element_message_full_with_details:&lt;avdemux_gif0&gt; posted error message: Internal data stream error.\n</code></pre>\n\n<p>The error is <code>av_read_frame returned -5</code>. <code>GST_DEBUG=5</code> doesn't print anything more detailed about the error. Strangely enough, <code>gst-launch</code> works:</p>\n\n<pre><code>gst-launch-1.0 filesrc location=test.gif ! decodebin ! video/x-raw ! fakesink\n</code></pre>\n\n<p>Running that with <code>GST_DEBUG=4</code> doesn't show anything surprising except there's no error. I've tried a few different things, such as prerolling before playing, but I've got idea why it's not working in this <em>specific</em> case. Can anyone give me some pointers?</p>\n\n<p>I have all gst-plugins-* installed plus gst-libav. I'm using gstreamer 1.14.2 on ArchLinux.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1535290709, "post_id": 52026575, "comment_id": 91003736, "body": "Once you have mutably borrowed <code>v</code> (i.e. <code>let mut v_ref = &amp;mut v[..];</code>), you can&#39;t access <code>v</code> any more, until that borrow is over. That&#39;s because then you&#39;d have borrowed it twice, which isn&#39;t allowed when one of the borrows is mutable. However, <code>v_ref</code> now points to the same data and you <i>can</i> borrow <code>v_ref</code>."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1535290808, "post_id": 52026575, "comment_id": 91003765, "body": "<i>&quot;Why does it keep complaining about my uses of v.len()?&quot;</i> \u2014 The <code>len</code> method will borrow <code>v</code>, which isn&#39;t allowed because <code>v_ref</code> has already borrowed <code>v</code> mutably. Instead just use <code>v_ref.len()</code>, which points to the same data."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535292016, "post_id": 52026575, "comment_id": 91004096, "body": "<i>I understand that you can&#39;t have multiple references to an object in the same scope as a single mutable reference</i> \u2014 why are you trying to use multiple references to the same object then (<code>v</code> / <code>v_ref</code>)?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535313963, "post_id": 52026575, "comment_id": 91010106, "body": "Please don&#39;t edit your question such that it invalidates existing answers. You are welcome to edit your question to your heart&#39;s content before you post it and before an answer is provided."}, {"owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535314004, "post_id": 52026575, "comment_id": 91010118, "body": "It does not invalidate the question - the typo did not contribute to the core of my problem"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535314117, "post_id": 52026575, "comment_id": 91010148, "body": "I did not say it invalidated the <i>question</i>, but that it invalidates the <i>answer</i>. If you remove the typos / bugs in your code, then 1/3 of the answer no longer makes any sense."}, {"owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535393803, "post_id": 52026575, "comment_id": 91040682, "body": "Sorry, I&#39;m embarrassed that I let typos leak in. This is my first posted question here, so thanks for explaining the SO question procedure."}], "answers": [{"comments": [{"owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535326544, "post_id": 52027403, "comment_id": 91012522, "body": "This definitely fixed the reduced problem I gave you... but it didn&#39;t fix my actual problem :( thanks anyway"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "edited": false, "score": 0, "creation_date": 1535326828, "post_id": 52027403, "comment_id": 91012572, "body": "@CrepeGoat well, now you can figure out the difference between that and this and ask a new question. Feel free to pop into the <a href=\"https://chat.stackoverflow.com/rooms/62927/rust\">Rust SO chatroom</a> if you want help reducing it."}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 1, "last_activity_date": 1535295171, "creation_date": 1535295171, "answer_id": 52027403, "question_id": 52026575, "link": "https://stackoverflow.com/questions/52026575/errors-in-overwriting-slice-reference-with-sub-slice-reference/52027403#52027403", "title": "Errors in overwriting slice reference with sub-slice reference", "body": "<h3>Problem 1: Using the same variable mutably and immutably</h3>\n\n<p>As <a href=\"https://stackoverflow.com/questions/52026575/errors-in-overwriting-slice-reference-with-sub-slice-reference#comment91003736_52026575\">Peter Hall points out</a>, the code attempts to reference the variable <code>v</code> while there's a concurrent mutable reference to it, even though you don't care about <code>v_ref</code> anymore. A MCVE:</p>\n\n<pre><code>pub fn example() {\n    let mut v = 0;\n    let mut v_ref = &amp;mut v;\n    println!(\"{}\", v)\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/50251487/155423\">What are non-lexical lifetimes?</a></li>\n</ul>\n\n<h3>Problem 2: Using the same variable mutably and immutably</h3>\n\n<p>Then the code attempts to overlap mutable and mutable borrows in a single function call. A MCVE:</p>\n\n<pre><code>pub fn example() {\n    let mut v = [0, 1, 2, 3];\n    v.split_at_mut(v.len());\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/41187296/155423\">Cannot borrow as immutable because it is also borrowed as mutable in function arguments</a></li>\n</ul>\n\n<h3>Problem 3: Using the same variable mutably and mutably</h3>\n\n<p>Then the code has overlapping mutable borrows of <code>v</code> in the loop. </p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/37986640/155423\">Cannot obtain a mutable reference when iterating a recursive structure: cannot borrow as mutable more than once at a time</a></li>\n</ul>\n\n<hr>\n\n<p>All together:</p>\n\n<pre><code>pub fn example() {\n    let mut v = [0, 1, 2, 3];\n    let mut v_ref = &amp;mut v[..];\n\n    while v_ref.len() &gt; 1 {\n        let len = v_ref.len();\n        v_ref.swap(0, len - 1);\n        let (v_l, _) = { v_ref }.split_at_mut(len / 2);\n        v_ref = v_l;\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 1755, "user_id": 3757757, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/xhHJj.jpg?s=128&g=1", "display_name": "CrepeGoat", "link": "https://stackoverflow.com/users/3757757/crepegoat"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 50, "favorite_count": 0, "accepted_answer_id": 52027403, "answer_count": 1, "score": 0, "last_activity_date": 1535314072, "creation_date": 1535289012, "last_edit_date": 1535314072, "question_id": 52026575, "link": "https://stackoverflow.com/questions/52026575/errors-in-overwriting-slice-reference-with-sub-slice-reference", "title": "Errors in overwriting slice reference with sub-slice reference", "body": "<p>I'm trying to nail down ownership rules. I want to:</p>\n\n<ul>\n<li>start with a mutable reference to a slice</li>\n<li>make some edits to its contents</li>\n<li>reduce the slice reference to a reference of a sub-slice and repeat</li>\n</ul>\n\n<p>Below is my attempt:</p>\n\n<pre><code>pub fn example() {\n    // Make a mutable slice\n    let mut v = [0, 1, 2, 3];\n\n    // Make a mutable reference to said slice\n    let mut v_ref = &amp;mut v[..];\n\n    while v_ref.len() &gt; 1 {\n        // Involves some edits -&gt; need mut\n        v_ref.swap(0, v_ref.len() - 1);\n\n        // Try to reduce slice to sub-slice (some simplification here)\n        // Errors!\n        let (v_l, v_h) = v.split_at_mut(v.len() / 2);\n        v_ref = v_l;\n    }\n}\n</code></pre>\n\n<p>However I'm getting the errors:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `*v_ref` as immutable because it is also borrowed as mutable\n  --&gt; src/lib.rs:11:23\n   |\n11 |         v_ref.swap(0, v_ref.len() - 1);\n   |         -----         ^^^^^          - mutable borrow ends here\n   |         |             |\n   |         |             immutable borrow occurs here\n   |         mutable borrow occurs here\n\nerror[E0499]: cannot borrow `v` as mutable more than once at a time\n  --&gt; src/lib.rs:15:26\n   |\n7  |     let mut v_ref = &amp;mut v[..];\n   |                          - first mutable borrow occurs here\n...\n15 |         let (v_l, v_h) = v.split_at_mut(v.len() / 2);\n   |                          ^ second mutable borrow occurs here\n...\n18 | }\n   | - first borrow ends here\n\nerror[E0502]: cannot borrow `v` as immutable because it is also borrowed as mutable\n  --&gt; src/lib.rs:15:41\n   |\n7  |     let mut v_ref = &amp;mut v[..];\n   |                          - mutable borrow occurs here\n...\n15 |         let (v_l, v_h) = v.split_at_mut(v.len() / 2);\n   |                                         ^ immutable borrow occurs here\n...\n18 | }\n   | - mutable borrow ends here\n</code></pre>\n\n<p>I understand that you can't have multiple references to an object in the same scope as a single mutable reference. </p>\n\n<p>There should be a safe way to reduce a slice's range, as you're only reducing the scope of a current mutable reference. What's the best way to do that?</p>\n"}, {"tags": ["rust", "lifetime"], "answers": [{"comments": [{"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "edited": false, "score": 0, "creation_date": 1535285545, "post_id": 52025713, "comment_id": 91002370, "body": "Fair enough.  I just worry about the &quot;Rust is black magic&quot; belief that sometimes gets around."}], "tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 1, "last_activity_date": 1535290259, "last_edit_date": 1535290259, "creation_date": 1535282333, "answer_id": 52025713, "question_id": 52025655, "link": "https://stackoverflow.com/questions/52025655/a-smart-constructor-for-an-iterator-with-a-reference-to-a-closure-inside/52025713#52025713", "title": "A smart constructor for an iterator with a reference to a closure inside", "body": "<p>The <code>impl Trait</code> syntax supports adding lifetimes to the return type:</p>\n\n<pre><code>fn mk_iter&lt;'a, T: Fn(i32) -&gt; i32&gt;(closure: &amp;'a T) -&gt; impl Iterator&lt;Item = i32&gt; + 'a {\n      //                                                                  here ^^^^\n    IteratorState {\n        closure\n    }\n}\n</code></pre>\n\n<p>(<a href=\"https://play.rust-lang.org/?gist=a0161edfac731f4a091a4033a82aae65&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"nofollow noreferrer\">link to playground</a>)</p>\n"}], "owner": {"reputation": 1414, "user_id": 6564029, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/WxyK5.jpg?s=128&g=1", "display_name": "Michail", "link": "https://stackoverflow.com/users/6564029/michail"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 46, "favorite_count": 0, "accepted_answer_id": 52025713, "answer_count": 1, "score": 0, "last_activity_date": 1535290259, "creation_date": 1535281855, "last_edit_date": 1535290226, "question_id": 52025655, "link": "https://stackoverflow.com/questions/52025655/a-smart-constructor-for-an-iterator-with-a-reference-to-a-closure-inside", "title": "A smart constructor for an iterator with a reference to a closure inside", "body": "<p>Consider the following code for a (greatly simplified) iterator with a reference to a closure inside:</p>\n\n<pre><code>struct IteratorState&lt;'a, T: 'a + Fn(i32) -&gt; i32&gt; {\n    closure: &amp;'a T,\n}\n\nimpl&lt;'a, T: 'a + Fn(i32) -&gt; i32&gt; Iterator for IteratorState&lt;'a, T&gt; {\n    type Item = i32;\n\n    fn next(&amp;mut self) -&gt; Option&lt;i32&gt; {\n        None\n    }\n}\n</code></pre>\n\n<p>It compiles and I can construct <code>IteratorState</code>s directly. However, I also need a smart constructor to hide some details of the implementation (not shown in the MCVE). The following attempt does not compile:</p>\n\n<pre><code>fn mk_iter&lt;'a, T: Fn(i32) -&gt; i32&gt;(closure: &amp;'a T) -&gt; impl Iterator&lt;Item = i32&gt; {\n    IteratorState { closure }\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=e7ee66ea6ffc6b5e2825c6470d1ab15b&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"nofollow noreferrer\">The error is</a></p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0495]: cannot infer an appropriate lifetime for lifetime parameter `'a` due to conflicting requirements\n  --&gt; src/lib.rs:14:5\n   |\n14 |     IteratorState { closure }\n   |     ^^^^^^^^^^^^^\n   |\nnote: first, the lifetime cannot outlive the lifetime 'a as defined on the function body at 13:1...\n  --&gt; src/lib.rs:13:1\n   |\n13 | fn mk_iter&lt;'a, T: Fn(i32) -&gt; i32&gt;(closure: &amp;'a T) -&gt; impl Iterator&lt;Item = i32&gt; {\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nnote: ...so that reference does not outlive borrowed content\n  --&gt; src/lib.rs:14:21\n   |\n14 |     IteratorState { closure }\n   |                     ^^^^^^^\n   = note: but, the lifetime must be valid for the static lifetime...\nnote: ...so that return value is valid for the call\n  --&gt; src/lib.rs:13:54\n   |\n13 | fn mk_iter&lt;'a, T: Fn(i32) -&gt; i32&gt;(closure: &amp;'a T) -&gt; impl Iterator&lt;Item = i32&gt; {\n   |                                                      ^^^^^^^^^^^^^^^^^^^^^^^^^\n</code></pre>\n\n<p>I think I understand what the problem is: there's no guarantee that constructed <code>IteratorState</code> won't outlive the contained reference (please correct me if I got this wrong), but I'm not quite sure how to fix it. </p>\n"}, {"tags": ["rust", "rust-cargo", "rust-crates"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535293796, "post_id": 52024304, "comment_id": 91004565, "body": "Your question is fine and seemingly on-topic, but I don&#39;t understand your goals. Why does the answer to this question matter to you? What will change based on the answer? It&#39;s possible that filling in some of this detail might help someone provide a useful answer."}, {"owner": {"reputation": 375, "user_id": 10275339, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c30fd1003aeb7cbcf53cb7017b34aaab?s=128&d=identicon&r=PG&f=1", "display_name": "nromaniv", "link": "https://stackoverflow.com/users/10275339/nromaniv"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535368235, "post_id": 52024304, "comment_id": 91026180, "body": "@Shepmaster, I am a student, and I am trying to learn more about Rust and Rust ecosystem. I&#39;d like to incorporate it into my university projects as well as my work and contribute. If I get a clear explanation, I will likely submit an issue on GitHub to further elaborate on the distinction between crates and packages in the book. In other words, I am not after some specific goal. I am asking out of curiosity primarily."}], "answers": [{"tags": [], "owner": {"reputation": 11723, "user_id": 3356777, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/1c7bee1f2c7ba7f81ddb902b83626558?s=128&d=identicon&r=PG&f=1", "display_name": "attdona", "link": "https://stackoverflow.com/users/3356777/attdona"}, "is_accepted": true, "score": 5, "last_activity_date": 1535568804, "last_edit_date": 1535568804, "creation_date": 1535528777, "answer_id": 52072169, "question_id": 52024304, "link": "https://stackoverflow.com/questions/52024304/what-exactly-is-a-crate-in-the-cargo-ecosystem-and-what-is-the-mapping-to-what/52072169#52072169", "title": "What exactly is a &#39;crate&#39; in the Cargo ecosystem and what is the mapping to what is on crates.io?", "body": "<p>The exact things hosted on crates.io are crates inside packages.</p>\n\n<p>A <strong>crate</strong> is the output artifact of the compiler. </p>\n\n<p>From <a href=\"https://doc.rust-lang.org/reference/crates-and-source-files.html#cratesourcefile\" rel=\"nofollow noreferrer\">Rust Reference Manual</a>:</p>\n\n<blockquote>\n  <p>The compilation model centers on artifacts called crates. Each compilation processes a single crate in source form, and if successful, produces a single crate in binary form: either an executable or some sort of library.</p>\n</blockquote>\n\n<p>A <strong>package</strong> is an artifact managed by Cargo, the Rust package manager.</p>\n\n<p><code>Cargo.toml</code> manifest file defines the package with the syntax:</p>\n\n<pre><code>[package]\nname = \"hello_world\"\nversion = \"0.1.0\"\nauthors = [\"Your Name &lt;you@example.com&gt;\"]  \n</code></pre>\n\n<p>A package may contain one or more crates, for example one library crate, <strong>named as the package name</strong> and zero or more executable crates, each defined explicitly within a <code>[[bin]]</code> section of the manifest file or implicitly if located inside the <code>src/bin</code> directory of the package.</p>\n\n<p>The <a href=\"https://doc.rust-lang.org/cargo/\" rel=\"nofollow noreferrer\">Cargo book</a> uses the term crate as an alias for package. Consider the following statement to try to get out some sense:</p>\n\n<p>Generally* the main artifact of a package is a library crate, and since it is identified with the package name, it is customary to treat package and crate as synonyms.</p>\n\n<p>*: A package may contains only a binary, see for example <a href=\"https://github.com/BurntSushi/ripgrep\" rel=\"nofollow noreferrer\">ripgrep</a></p>\n"}], "owner": {"reputation": 375, "user_id": 10275339, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c30fd1003aeb7cbcf53cb7017b34aaab?s=128&d=identicon&r=PG&f=1", "display_name": "nromaniv", "link": "https://stackoverflow.com/users/10275339/nromaniv"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 360, "favorite_count": 2, "accepted_answer_id": 52072169, "answer_count": 1, "score": 10, "last_activity_date": 1535568804, "creation_date": 1535270315, "last_edit_date": 1535291040, "question_id": 52024304, "link": "https://stackoverflow.com/questions/52024304/what-exactly-is-a-crate-in-the-cargo-ecosystem-and-what-is-the-mapping-to-what", "title": "What exactly is a &#39;crate&#39; in the Cargo ecosystem and what is the mapping to what is on crates.io?", "body": "<p>I am a little confused as to the exact things hosted on crates.io (is a 'crate' the proper way to refer to those)? My understanding is that a crate is a unit of compilation in Rust, but then what is the mapping between crates and what is on crates.io? For instance, <a href=\"https://doc.rust-lang.org/stable/book/2018-edition/appendix-04-macros.html#procedural-macros-for-custom-derive\" rel=\"noreferrer\"><em>The Rust Programming Language</em> appendix on macros</a> says that since there can only be one procedural macro per crate:</p>\n\n<blockquote>\n  <p>Our two crates are tightly related, so we create the procedural macro crate within the directory of our <code>hello_macro</code> crate. If we change the trait definition in <code>hello_macro</code>, we\u2019ll have to change the implementation of the procedural macro in <code>hello_macro_derive</code> as well. The two crates will need to be published separately, and programmers using these crates will need to add both as dependencies and bring them both into scope. We could instead have the hello_macro crate use <code>hello_macro_derive</code> as a dependency and reexport the procedural macro code. But the way we\u2019ve structured the project makes it possible for programmers to use <code>hello_macro</code> even if they don\u2019t want the <code>derive</code> functionality.</p>\n</blockquote>\n\n<p>It has to be published separately on crates.io. This seems pretty clear: a crate on crates.io is the same as a local crate, and the mapping is one-to-one.</p>\n\n<p>However, when discussing projects with both an executable and a library, it implies that they are separate crates but needn't be published separately. For instance, the sccache repo has both main.rs and lib.rs. Is the separate binary crate not actually stored on crates.io and resides in the repo only? Then how does cargo install figure out what to install? </p>\n\n<p>What is a \"package\"?</p>\n\n<p>I tried to run <code>cargo package</code> with a sample project that contains both binary and library targets. And <em>both</em> were added to the .cargo file (by the way, is the exact format of .cargo archives documented <em>anywhere</em>?). This still leaves me confused. Can we publish multiple crates as a part of one package? Should we then refer to what is stored on crates.io as <em>packages</em>? Am I right to assume that each package can contain multiple binary crates but only one library crate? This is my current understanding.</p>\n"}, {"tags": ["enums", "rust", "rust-macros"], "comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 2, "creation_date": 1535227286, "post_id": 52020446, "comment_id": 90992008, "body": "What is your goal exactly? A simpler matcher such as <code>($($inames:tt)*) =&gt; { enum Instruction { $($inames)* } };</code> works fine, so my guess is you are trying to do something more with the variants, which it would be helpful to describe."}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1535227845, "post_id": 52020446, "comment_id": 90992126, "body": "Ah thanks, that helps with what I&#39;m trying to do now. I didn&#39;t think to try that (this is my first macro in Rust so I&#39;m still figuring of all this out). Although later on it may be helpful to have the macro in there for other stuff, so I&#39;ll update the question to include what that may be."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535228698, "post_id": 52020446, "comment_id": 90992307, "body": "You want your macro to <i>modify your documentation comments</i>?"}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "edited": false, "score": 0, "creation_date": 1535228821, "post_id": 52020446, "comment_id": 90992335, "body": "I haven&#39;t really planned it out yet, that&#39;s probably a bad idea. I was just rushing to get an example on the question. The main point is that the enum variants are created from the documentation. I can remove the rest of the details to focus on that."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535228870, "post_id": 52020446, "comment_id": 90992348, "body": "Additionally, you want to modify your <code>twi</code> to become <code>Twi</code>, and somehow intuit that the 3 values <code>TO, rA, SIMM</code> becomes 5 <code>u32</code>? It sounds like you are trying implement your actual assembler as a macro..."}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535228895, "post_id": 52020446, "comment_id": 90992353, "body": "@Shepmaster There&#39;s would also be custom <code>impl</code> stuff as well generated from the documentation, but I left that out as I didn&#39;t have an issue with that part."}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "edited": false, "score": 0, "creation_date": 1535229038, "post_id": 52020446, "comment_id": 90992387, "body": "I am writing an assembler (or rather attempting to haha). However I just wanted to define the possible instructions with macros so I could document the instructions&#39; usages and generate a <code>impl</code> block from that for things like printing them out. Even if this isn&#39;t a good idea, I&#39;d still love to know how to do this as I&#39;m trying to learn more about Rust macros."}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535229945, "post_id": 52020446, "comment_id": 90992604, "body": "@Shepmaster And I didn&#39;t mean to sound like I don&#39;t appreciate advice on my approach to this, I really do appreciate it. My main concern right now is fixing this issue I have with this macro, but I&#39;m also open to suggestions for what I should be doing instead if you explain why my approach isn&#39;t a good idea. It&#39;s just unclear what to do with your comments."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535231673, "post_id": 52020446, "comment_id": 90992938, "body": "The problem I have with this question is that I have <i>no</i> idea what it is you want to do. You show 2.5 different styles of macro invocation; you show a before and after without explicitly stating what the transformation rules would be. Your original question was seemingly answered and yet all of the cruft from it remains, etc. The amount of effort this question requires from an answerer to know what you <i>want</i> is very high, and that&#39;s before they try to start <i>answering</i>."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535231815, "post_id": 52020446, "comment_id": 90992975, "body": "This leads to my questions, likely phrased poorly, all attempting to get you to clarify your question: <i>You want your macro to modify your documentation comments?</i> \u2014 is your question how to do this? <i>you want to modify your <code>twi</code> to become <code>Twi</code></i> \u2014 is your question how to do this? <i>intuit that the 3 values TO, rA, SIMM becomes 5 u32</i> \u2014 is your question how to do this (we couldn&#39;t even begin to answer because the rules are opaque)?"}, {"owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535232739, "post_id": 52020446, "comment_id": 90993174, "body": "@Shepmaster I see your point. I had an &quot;Edit&quot; label for my response to mcarton that explained my goals, but I think that label got lost in the edits so now all that documentation stuff looks like part of my original question. I realize this is a bit of an xy problem, but in this case I really do want to know how to define the variants using a macro inside of the enum definition, even if it&#39;s not the ideal solution. I edited my question to try to make it more clear that I want to know if it&#39;s possible to do that, and that I&#39;m not really concerned the the documentation stuff right now."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "edited": false, "score": 0, "creation_date": 1535234213, "post_id": 52020446, "comment_id": 90993493, "body": "Let us <a href=\"https://chat.stackoverflow.com/rooms/178760/discussion-between-shepmaster-and-addison\">continue this discussion in chat</a>."}], "owner": {"reputation": 3152, "user_id": 1525759, "user_type": "registered", "accept_rate": 81, "profile_image": "https://i.stack.imgur.com/LHtNL.jpg?s=128&g=1", "display_name": "Addison", "link": "https://stackoverflow.com/users/1525759/addison"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 678, "favorite_count": 0, "answer_count": 0, "score": 2, "last_activity_date": 1535232820, "creation_date": 1535224195, "last_edit_date": 1535232820, "question_id": 52020446, "link": "https://stackoverflow.com/questions/52020446/how-can-i-use-a-macro-to-generate-enum-variants-that-may-or-may-not-contain-asso", "title": "How can I use a macro to generate enum variants that may or may not contain associated values?", "body": "<p>I'm trying to make a macro to define some enum variants that represent assembler instructions.</p>\n\n<p>Right now, I have the following which works fine. This is pretty useless, but eventually I'm going to add some automatically derived methods so it'll have a purpose later on:</p>\n\n<pre><code>macro_rules! define_instructions {\n    ($($inames:tt),+ $(,)*) =&gt; {\n        #[derive(Debug)]\n        pub enum Instruction {\n            $($inames),*\n        }\n    };\n}\n\ndefine_instructions! {\n    PsqLux,\n    PsqLx,\n    Twi,\n}\n\nfn main() {}\n</code></pre>\n\n<p>The problem is that most (but not all) of the variants I'll be adding will need to have associated values:</p>\n\n<pre><code>define_instructions! {\n    PsqLux(u32, u32, u32, u32, u32),\n    PsqLx(u32, u32, u32, u32, u32),\n    Twi(u32, u32, u32),\n    SomethingWithoutAVariant,\n}\n</code></pre>\n\n<p>I tried using this to allow for the variants to have associated values (it doesn't actually support associated values yet, it's just a start):</p>\n\n<pre><code>macro_rules! define_instructions {\n    (@define) =&gt; {};\n\n    (@define $iname:ident) =&gt; {\n        $iname,\n    };\n\n    (@define $iname:ident $($inames:tt)*) =&gt; {\n        $iname,\n        define_instructions! { @define $($inames)* }\n    };\n\n    ($($inames:tt),+ $(,)*) =&gt; {\n        #[derive(Debug)]\n        pub enum Instruction {\n            define_instructions! { @define $($inames)* }\n        }\n    };\n}\n\ndefine_instructions! {\n    PsqLux,\n    PsqLx,\n    Twi,\n}\n</code></pre>\n\n<p>That code gave me this error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: expected one of `(`, `,`, `=`, `{`, or `}`, found `!`\n  --&gt; src/main.rs:17:32\n   |\n17 |               define_instructions! { @define $($inames)* }\n   |                                  ^ expected one of `(`, `,`, `=`, `{`, or `}` here\n...\n22 | / define_instructions! {\n23 | |     PsqLux,\n24 | |     PsqLx,\n25 | |     Twi,\n26 | | }\n   | |_- in this macro invocation\n</code></pre>\n\n<p>It's seems like I can't use macros inside of an <code>enum</code> definition. Assuming that's true, how could I work around this and be able to generate enum variants that may or may not contain associated values? </p>\n\n<p><em>Note</em>: I'm sure there's something wrong with the rules I added, but I'd at least like to be able to get to the point where I can call them, so I can get them working.</p>\n\n<p><strong>Edit</strong></p>\n\n<p><a href=\"https://stackoverflow.com/questions/52020446/how-can-i-use-a-macro-to-generate-enum-variants-that-may-or-may-not-contain-asso#comment90992008_52020446\">mcarton explained</a> another way to do what I'm trying to do, and that's helpful at the moment.</p>\n\n<p>However I'd still like to know how to use a macro inside a enum definition, because in the future I'd be able to like to write macros like this:</p>\n\n<pre><code>define_instructions! {\n    /// Name: Trap Word Immediate\n    /// Simplified Mnemonics:\n    /// twgti rA, value = twi 8, _rA, _value\n    /// twllei rA, value = twi 6, _rA, _value\n    twi TO, rA, SIMM;\n\n    // and so on...  \n}\n\n// That macro would become\n\npub enum Instruction {\n    /// Name: Trap Word Immediate\n    /// Usage: twi TO, rA, SIMM\n    /// Simplified Mnemonics:\n    /// twi 8, rA, value = twgti rA, value\n    /// twllei rA, value = twi 6, rA, value\n    Twi(u32, u32, u32, u32, u32),\n}\n</code></pre>\n\n<p>So I have the workaround, but I'm still curious if it's possible to use macros inside of an <code>enum</code> definition. Is that possible, and if not why isn't it?</p>\n"}, {"tags": ["rust", "loading", "amethyst"], "comments": [{"owner": {"reputation": 1896, "user_id": 791025, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/66a1d3b208aad4b7381b384fe2fa0756?s=128&d=identicon&r=PG", "display_name": "AdmiralJonB", "link": "https://stackoverflow.com/users/791025/admiraljonb"}, "edited": false, "score": 0, "creation_date": 1541958969, "post_id": 52019501, "comment_id": 93387836, "body": "I presume you&#39;ve solved this by now, but I would guess it has something to do with how you&#39;re running it. You need to make sure the textures folder is in the working directory of the executable. I&#39;d also check that your file is actually named correctly."}, {"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1556767016, "post_id": 52019501, "comment_id": 98543147, "body": "I am getting the same problem with 0.10.0. Please tell me (a) what I should use for the asset directory in the call to <code>Application::build</code> and (b) where I should put my asset file assuming the file is called <code>texture&#47;texture.png</code> in the call to <code>loader.load</code>."}, {"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1556767432, "post_id": 52019501, "comment_id": 98543226, "body": "The executable will be $WKSP/target/debug/$PROG."}], "answers": [{"comments": [{"owner": {"reputation": 564, "user_id": 612829, "user_type": "registered", "accept_rate": 57, "profile_image": "https://i.stack.imgur.com/wB0H0.jpg?s=128&g=1", "display_name": "Martin Ellison", "link": "https://stackoverflow.com/users/612829/martin-ellison"}, "edited": false, "score": 0, "creation_date": 1556867428, "post_id": 55963543, "comment_id": 98580534, "body": "I think I have it working now using Rust and Amethyst nightly mode. Thanks for your help."}], "tags": [], "owner": {"reputation": 366, "user_id": 1576773, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/69471561f6a3b2bde06c5f74f47106ad?s=128&d=identicon&r=PG", "display_name": "Azriel", "link": "https://stackoverflow.com/users/1576773/azriel"}, "is_accepted": false, "score": 1, "last_activity_date": 1556859950, "last_edit_date": 1556859950, "creation_date": 1556859586, "answer_id": 55963543, "question_id": 52019501, "link": "https://stackoverflow.com/questions/52019501/amethysts-loader-cant-find-an-asset-file/55963543#55963543", "title": "Amethyst&#39;s Loader can&#39;t find an asset file", "body": "<p>Hopefully this table helps you, because there are many possible answers.</p>\n\n<p>All rows assume you are loading a texture using:</p>\n\n<pre class=\"lang-rust prettyprint-override\"><code>loader.load(\"path/to/texture.png\", ..)\n</code></pre>\n\n<p>Paths listed are relative to the repository directory.</p>\n\n<pre><code>| Amethyst version | What the code uses for assets dir | How you run the executable | Where the texture should be |\n| ---------------- | --------------------------------- | -------------------------- | --------------------------- |\n| 0.10.0           | `\"assets\"`                                         | cargo run                  | `$repo/target/$profile/assets/path/to/texture.png` |\n| 0.10.0           | `format!(\"{}/assets\", env!(\"CARGO_MANIFEST_DIR\"))` | cargo run                  | `$repo/assets/path/to/texture.png` |\n| 0.10.0           | `\"assets\"`                                         | `./target/$profile/app`    | `$repo/assets/path/to/texture.png` |\n| 0.10.0           | `env!(\"CARGO_MANIFEST_DIR\")`                       | `./target/$profile/app`    | `$repo/assets/path/to/texture.png` |\n| 0.10.0           | `option_env!(\"CARGO_MANIFEST_DIR\").map(|d| format!(\"{}/assets\", d)).unwrap_or(\"assets\")` | cargo run                  | `$repo/assets/path/to/texture.png` |\n| 0.10.0           | `option_env!(\"CARGO_MANIFEST_DIR\").map(|d| format!(\"{}/assets\", d)).unwrap_or(\"assets\")` | `./target/$profile/app`    | `$repo/target/$profile/assets/path/to/texture.png` |\n| `master`         | `application_root_dir()`                           | cargo run                  | `$repo/assets/path/to/texture.png` |\n| `master`         | `application_root_dir()`                           | `./target/$profile/app`    | `$repo/target/$profile/assets/path/to/texture.png` |\n</code></pre>\n\n<p>The first 4 are not good solutions (either dev path or player path is wrong). The 5th and 6th ways to tolerate it, which is done for you on <code>master</code> using the <code>application_root_dir()</code> function.</p>\n"}], "owner": {"reputation": 125, "user_id": 5862030, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/c3ea28fa33abc07ba4b55ca26c4ad35c?s=128&d=identicon&r=PG&f=1", "display_name": "KuSpa", "link": "https://stackoverflow.com/users/5862030/kuspa"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 561, "favorite_count": 1, "answer_count": 1, "score": 3, "last_activity_date": 1556859950, "creation_date": 1535216843, "last_edit_date": 1535218125, "question_id": 52019501, "link": "https://stackoverflow.com/questions/52019501/amethysts-loader-cant-find-an-asset-file", "title": "Amethyst&#39;s Loader can&#39;t find an asset file", "body": "<p>I am using the Rust Amethyst game engine to load a texture named <code>ground.png</code>, but the <code>Loader</code> does not seem to find the file:</p>\n\n<pre><code>//...\nlet assets_dir = format!(\"{}\", env!(\"CARGO_MANIFEST_DIR\"));\nlet mut game = Application::build(assets_dir, Example)?.build(game_data)?;\n</code></pre>\n\n<p>My <code>assets_dir</code> is the root folder of the project and when loading my file, I append <code>textures/ground.png</code>:</p>\n\n<pre><code>let texture_handle = {\n    let loader = world.read_resource::&lt;Loader&gt;();\n    let texture_storage = world.read_resource::&lt;AssetStorage&lt;Texture&gt;&gt;();\n    loader.load(\n        \"textures/ground.png\",\n        PngFormat,\n        Default::default(),\n        (),\n        &amp;texture_storage,\n    )\n};\n</code></pre>\n\n<p>My file directory looks like this:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>\u251c\u2500\u2500 src\n\u2502   \u2514\u2500\u2500 main.rs\n\u251c\u2500\u2500 Cargo.toml\n\u2514\u2500\u2500 textures\n    \u2514\u2500\u2500 ground.png\n</code></pre>\n\n<p>The error I am getting is a <code>None</code> value when fetching the texture:</p>\n\n<pre><code>assert!(\n    world\n        .read_resource::&lt;AssetStorage&lt;Texture&gt;&gt;()\n        .get(&amp;texture_handle) != None\n); //panics\n</code></pre>\n\n<p>I am using amethyst 0.8.</p>\n"}, {"tags": ["rust", "dry"], "comments": [{"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1535206595, "post_id": 52017919, "comment_id": 90986459, "body": "What is <code>Message</code>? Is it a trait of yours or a third party&#39;s?"}, {"owner": {"reputation": 2056, "user_id": 5822873, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/58b4154461abce8a2db3cabd3841ef7c?s=128&d=identicon&r=PG", "display_name": "KadoBOT", "link": "https://stackoverflow.com/users/5822873/kadobot"}, "reply_to_user": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "edited": false, "score": 0, "creation_date": 1535206942, "post_id": 52017919, "comment_id": 90986549, "body": "Third party, from actix: <a href=\"https://docs.rs/actix/0.7.3/actix/trait.Message.html\" rel=\"nofollow noreferrer\">docs.rs/actix/0.7.3/actix/trait.Message.html</a>"}, {"owner": {"reputation": 1127, "user_id": 8171453, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d3ac080ba0604191f0653a8880a21cdd?s=128&d=identicon&r=PG&f=1", "display_name": "Emoun", "link": "https://stackoverflow.com/users/8171453/emoun"}, "edited": false, "score": 0, "creation_date": 1588062185, "post_id": 52017919, "comment_id": 108747802, "body": "<a href=\"https://crates.io/crates/duplicate\" rel=\"nofollow noreferrer\">The <code>duplicate</code> crate</a> provides an attribute macro to solve exactly this. See also <a href=\"https://stackoverflow.com/a/61467564/8171453\">my answer</a> to the linked duplicate question for an example."}], "answers": [{"tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": true, "score": 4, "last_activity_date": 1535211861, "last_edit_date": 1535211861, "creation_date": 1535206940, "answer_id": 52018188, "question_id": 52017919, "link": "https://stackoverflow.com/questions/52017919/how-to-avoid-impl-repetition-in-rust/52018188#52018188", "title": "How to avoid impl repetition in Rust?", "body": "<p>The answer to <em>how to avoid repetition</em> in Rust is usually macros.</p>\n\n<p>Your case is actually quite simple, as macros go:</p>\n\n<pre><code>macro_rules! hero_message {\n    ($name : ident) =&gt; {\n        impl Message for $name {\n            type Result = Result&lt;Hero, Error&gt;;\n        }\n    }\n}\nhero_message!{CreateHero}\nhero_message!{SearchHero}\nhero_message!{DeleteHero}\n</code></pre>\n\n<p>Reading the answer in the <a href=\"https://stackoverflow.com/a/39150448/865874\">linked duplicated question</a>, you can also write a generic trait implementation, that for simple problems like yours, would look more idiomatic. It would look like this:</p>\n\n<pre><code>trait MessageHero {}\n\nimpl&lt;T: MessageHero&gt; Message for T {\n    type Result = Result&lt;Hero, Error&gt;;\n}\n\nimpl MessageHero for CreateHero {}\nimpl MessageHero for SearchHero {}\nimpl MessageHero for DeleteHero {}\n</code></pre>\n"}], "owner": {"reputation": 2056, "user_id": 5822873, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/58b4154461abce8a2db3cabd3841ef7c?s=128&d=identicon&r=PG", "display_name": "KadoBOT", "link": "https://stackoverflow.com/users/5822873/kadobot"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 174, "favorite_count": 1, "closed_date": 1535207900, "accepted_answer_id": 52018188, "answer_count": 1, "score": 2, "last_activity_date": 1535211861, "creation_date": 1535204855, "question_id": 52017919, "link": "https://stackoverflow.com/questions/52017919/how-to-avoid-impl-repetition-in-rust", "closed_reason": "Duplicate", "title": "How to avoid impl repetition in Rust?", "body": "<p>I have the following implementation, but I don't want to repeat myself. How can I use a implementation that have the same body on different structs without repeating?</p>\n\n<pre><code>impl Message for CreateHero {\n    type Result = Result&lt;Hero, Error&gt;;\n}\n\nimpl Message for SearchHero {\n    type Result = Result&lt;Hero, Error&gt;;\n}\n\nimpl Message for DeleteHero {\n    type Result = Result&lt;Hero, Error&gt;;\n}\n</code></pre>\n"}, {"tags": ["rust", "format"], "comments": [{"owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 2, "creation_date": 1535197750, "post_id": 52015611, "comment_id": 90983970, "body": "Note that translating a program is a <a href=\"https://www.gnu.org/software/gettext/manual/gettext.html#Concepts\" rel=\"nofollow noreferrer\">problem</a> <a href=\"https://www.youtube.com/watch?v=0j74jcxSunY\" rel=\"nofollow noreferrer\">far</a> <a href=\"https://developer.mozilla.org/en-US/docs/Mozilla/Localization/Localization_content_best_practices\" rel=\"nofollow noreferrer\">far</a> <a href=\"https://bjoernkw.com/2013/06/30/i18n-is-a-hard-and-largely-unsolved-problem/\" rel=\"nofollow noreferrer\">more</a> <a href=\"https://www.factorio.com/blog/post/fff-244\" rel=\"nofollow noreferrer\">complicated</a> than just having a few template strings."}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "edited": false, "score": 0, "creation_date": 1535204082, "post_id": 52015611, "comment_id": 90985760, "body": "@mcarton +20 for FFF blog post"}], "answers": [{"tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": true, "score": 3, "last_activity_date": 1535189286, "creation_date": 1535189286, "answer_id": 52015854, "question_id": 52015611, "link": "https://stackoverflow.com/questions/52015611/how-can-i-store-a-format-string-template-outside-of-my-source-code/52015854#52015854", "title": "How can I store a format string template outside of my source code?", "body": "<p>That's not possible.  Format strings must be actual literal strings.</p>\n\n<p>The next best approach would be some kind of <a href=\"https://crates.io/search?q=dynamic%20string%20format\" rel=\"nofollow noreferrer\">dynamic string format</a> library.  Or, failing that, you could always use <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.replace\" rel=\"nofollow noreferrer\"><code>str::replace</code></a> if your needs aren't too complex.</p>\n"}], "owner": {"reputation": 488, "user_id": 2904507, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/89fa3cf087339a65c4cc8389134b0252?s=128&d=identicon&r=PG", "display_name": "Gedweb", "link": "https://stackoverflow.com/users/2904507/gedweb"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 571, "favorite_count": 1, "accepted_answer_id": 52015854, "answer_count": 1, "score": 3, "last_activity_date": 1535202228, "creation_date": 1535187571, "last_edit_date": 1535202228, "question_id": 52015611, "link": "https://stackoverflow.com/questions/52015611/how-can-i-store-a-format-string-template-outside-of-my-source-code", "title": "How can I store a format string template outside of my source code?", "body": "<p>When translating, messages can be in different languages and have format parameters. I want to be able to do this where the template can be stored in a file:</p>\n\n<pre><code>static PATTERN: &amp;'static str = r\"Hello {inner};\";\n\n/// in some implementation\n\nfn any_method(&amp;self) -&gt; String {\n    format!(PATTERN, inner = \"world\");\n}\n</code></pre>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 13772, "user_id": 379311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c993f4f111e6ff3211ccda1b98828253?s=128&d=identicon&r=PG", "display_name": "Yann Vernier", "link": "https://stackoverflow.com/users/379311/yann-vernier"}, "edited": false, "score": 1, "creation_date": 1535146646, "post_id": 52011912, "comment_id": 90974994, "body": "It looks to me like you want a <code>scan</code>, not a <code>map</code>. And having the <code>map</code> operation alter external state is some sort of obfustated <code>for</code>."}], "answers": [{"comments": [{"owner": {"reputation": 147, "user_id": 8940015, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/26dcc35052997268151655e9ab26d243?s=128&d=identicon&r=PG&f=1", "display_name": "mrbus2007", "link": "https://stackoverflow.com/users/8940015/mrbus2007"}, "edited": false, "score": 0, "creation_date": 1535156295, "post_id": 52012060, "comment_id": 90976889, "body": "Thanks much, @mcarton. But to be exact, the expected result is <code>[24, 12, 4]</code>, so we need <code>rev</code> before <code>map</code>."}], "tags": [], "owner": {"reputation": 20827, "user_id": 2733851, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/MUOS4.png?s=128&g=1", "display_name": "mcarton", "link": "https://stackoverflow.com/users/2733851/mcarton"}, "is_accepted": true, "score": 9, "last_activity_date": 1535178414, "last_edit_date": 1535178414, "creation_date": 1535146930, "answer_id": 52012060, "question_id": 52011912, "link": "https://stackoverflow.com/questions/52011912/why-does-a-doubly-reversed-iterator-act-as-if-it-was-never-reversed/52012060#52012060", "title": "Why does a doubly-reversed iterator act as if it was never reversed?", "body": "<p>This behavior is actually <a href=\"https://doc.rust-lang.org/std/iter/struct.Map.html\" rel=\"noreferrer\">explicitly described in the documentation</a>:</p>\n\n<blockquote>\n  <h1>Notes about side effects</h1>\n  \n  <p>The <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map\" rel=\"noreferrer\"><code>map</code></a> iterator implements <a href=\"https://doc.rust-lang.org/std/iter/trait.DoubleEndedIterator.html\" rel=\"noreferrer\"><code>DoubleEndedIterator</code></a>, meaning that\n  you can also <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map\" rel=\"noreferrer\"><code>map</code></a> backwards:</p>\n  \n  <p>[\u2026]</p>\n  \n  <p>But if your closure has state, iterating backwards may act in a way you do\n  not expect. [\u2026]</p>\n</blockquote>\n\n<p><a href=\"https://play.rust-lang.org/?gist=936faf2d6c03bf83dfaf23a7b8bf26b7&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"noreferrer\">A way to solve this</a> would be by adding an intermediary <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.collect\" rel=\"noreferrer\"><code>collect</code></a> to be sure that the second <code>rev</code> does not apply on the <code>Map</code>:</p>\n\n<pre><code>fn main() {\n    let input = vec![2, 3, 4];\n    let mut prod = 1;\n    let p: Vec&lt;usize&gt; = input\n        .iter()\n        .map(|v| {\n            prod *= v;\n            prod\n        }).rev()\n        .collect::&lt;Vec&lt;_&gt;&gt;()\n        .into_iter()\n        .rev()\n        .collect();\n    println!(\"{:?}\", p);\n}\n</code></pre>\n\n<p>But that requires an extra allocation. <a href=\"https://play.rust-lang.org/?gist=73cd47c46871d0c3472ae77e6e198f94&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"noreferrer\">Another way</a> would be to collect, and then <a href=\"https://doc.rust-lang.org/std/primitive.slice.html#method.reverse\" rel=\"noreferrer\">reverse</a>:</p>\n\n<pre><code>fn main() {\n    let input = vec![2, 3, 4];\n    let mut prod = 1;\n    let mut p: Vec&lt;usize&gt; = input\n        .iter()\n        .rev()\n        .map(|v| {\n            prod *= v;\n            prod\n        }).collect();\n    p.reverse();\n\n    println!(\"{:?}\", p);\n}\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535202231, "post_id": 52016309, "comment_id": 90985228, "body": "There&#39;s nothing <i>inherently</i> wrong with mutability in a language like Rust, which restricts mutable variables to only be used by one thing at a time. For example, I&#39;d expect <code>Vec::reverse</code> to be way more efficient as it doesn&#39;t need to deallocate and reallocate space for the vector."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535203614, "post_id": 52016309, "comment_id": 90985628, "body": "<i>collect from the right</i> \u2014 implementing <code>FromIterator</code> for a newtype over a <code>Vec</code> and doing <code>reverse</code> or a <code>VecDeque</code> and doing <code>push_front</code> seem plausible."}, {"owner": {"reputation": 13772, "user_id": 379311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c993f4f111e6ff3211ccda1b98828253?s=128&d=identicon&r=PG", "display_name": "Yann Vernier", "link": "https://stackoverflow.com/users/379311/yann-vernier"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535204611, "post_id": 52016309, "comment_id": 90985908, "body": "I agree, the reverse on a mutable vec is more efficient. It&#39;s merely a matter of confining the scope where mutation is appropriate to reduce the risk of following mistakes."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535207667, "post_id": 52016309, "comment_id": 90986734, "body": "<code>let p = { &#47;* ... *&#47; pmut };</code> would be more idiomatic."}], "tags": [], "owner": {"reputation": 13772, "user_id": 379311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/c993f4f111e6ff3211ccda1b98828253?s=128&d=identicon&r=PG", "display_name": "Yann Vernier", "link": "https://stackoverflow.com/users/379311/yann-vernier"}, "is_accepted": false, "score": 2, "last_activity_date": 1535207793, "last_edit_date": 1535207793, "creation_date": 1535192627, "answer_id": 52016309, "question_id": 52011912, "link": "https://stackoverflow.com/questions/52011912/why-does-a-doubly-reversed-iterator-act-as-if-it-was-never-reversed/52016309#52016309", "title": "Why does a doubly-reversed iterator act as if it was never reversed?", "body": "<p>Your <code>prod</code> variable is carrying state across from one item to the next, which is not what a mapping does. Mappings operate on each element independently, which makes them easily parallelized and easier to reason about. The result you're asking for is to be precise a <a href=\"http://hackage.haskell.org/package/base-4.11.1.0/docs/Data-List.html#v:scanr1\" rel=\"nofollow noreferrer\">right scan</a> (a reversed case of a <a href=\"https://en.wikipedia.org/wiki/Prefix_sum\" rel=\"nofollow noreferrer\">prefix sum</a>), but I'm not sure there are convenient methods to collect from the right (probably the easiest mutable way would be using <a href=\"https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.push_front\" rel=\"nofollow noreferrer\"><code>VecDeque::push_front</code></a>). This led me to perform the operation in two passes for my first version:</p>\n\n<pre><code>fn main() {\n    let input: Vec&lt;usize&gt; = vec![2, 3, 4];\n    let initprod = 1;\n    let prev: Vec&lt;usize&gt; = input\n        .iter()\n        .rev()\n        .scan(initprod, |prod, &amp;v| {\n            *prod *= v;\n            Some(*prod)\n        }).collect();\n    let p: Vec&lt;usize&gt; = prev.into_iter().rev().collect();\n    println!(\"{:?}\", p);\n}\n</code></pre>\n\n<p>Note that <code>initprod</code> is immutable; <code>prod</code> carries the state. Using <code>into_iter</code> also means <code>prev</code> is consumed. We could use <code>vec.reverse</code> as shown by mcarton, but then we need to have a mutable variable. Scans can be parallelized, but to a lesser degree than maps. See e.g. <a href=\"https://github.com/rayon-rs/rayon/issues/393\" rel=\"nofollow noreferrer\">discussion on adding them to Rayon</a>. One might also consider if a <a href=\"https://doc.rust-lang.org/std/iter/trait.ExactSizeIterator.html\" rel=\"nofollow noreferrer\"><code>ExactSizeIterator</code></a> should allow reverse collection into an ordinary vector, but the standard library <a href=\"https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.scan\" rel=\"nofollow noreferrer\"><code>scan</code></a> method breaks the known size using <code>Option</code> (which by the <code>next</code> convention turns it into a take-while-scan). </p>\n\n<p>Here's a fewer copy variant using a preallocated VecDeque to collect from the right. I used an extra scope to restrict the mutability. It also requires Rust 1.21 or later to use <code>for_each</code>. There's unnecessary overhead in tracking the number of items and ring buffer structure, but it's at least somewhat legible still. </p>\n\n<pre><code>use std::collections::VecDeque;\n\nfn main() {\n    let input: Vec&lt;usize&gt; = vec![2,3,4];\n    let p = {\n        let mut pmut = VecDeque::with_capacity(input.len());\n        let initprod = 1;\n        input\n            .iter()\n            .rev()\n            .scan(initprod, |prod, &amp;v| {\n                *prod *= v;\n                Some(*prod)\n            })\n            .for_each(|v| { \n                pmut.push_front(v)\n            });\n        pmut\n    };\n    println!(\"{:?}\", p);\n}\n</code></pre>\n\n<p>Incidentally, following the old adage about Lisp programmers knowing the value of everything and the cost of nothing, here's a Haskell version I don't really know how inefficient it is:</p>\n\n<pre><code>scanr1 (*) [2, 3, 4]\n</code></pre>\n"}], "owner": {"reputation": 147, "user_id": 8940015, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/26dcc35052997268151655e9ab26d243?s=128&d=identicon&r=PG&f=1", "display_name": "mrbus2007", "link": "https://stackoverflow.com/users/8940015/mrbus2007"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 256, "favorite_count": 1, "accepted_answer_id": 52012060, "answer_count": 2, "score": 9, "last_activity_date": 1535293124, "creation_date": 1535145846, "last_edit_date": 1535293124, "question_id": 52011912, "link": "https://stackoverflow.com/questions/52011912/why-does-a-doubly-reversed-iterator-act-as-if-it-was-never-reversed", "title": "Why does a doubly-reversed iterator act as if it was never reversed?", "body": "<p>I have an input vector which contains numbers. In an output vector, I need to get a sequence of partial products but in right-to-left order. The last element of the output must be equal to the last one in the input; the second-to-last element of the output must be a product of the last and second-to-last elements of input; and so on. For example, if the input vector is</p>\n\n<pre><code>let input = vec![2, 3, 4];\n</code></pre>\n\n<p>then I need the output to be <code>[24, 12, 4]</code>.</p>\n\n<p>My implementation takes an iterator over the input, reverses it, <code>map</code>s, reverses again and <code>collect</code>s:</p>\n\n<pre><code>fn main() {\n    let input = vec![2, 3, 4];\n    let mut prod = 1;\n    let p: Vec&lt;usize&gt; = input\n        .iter()\n        .rev()\n        .map(|v| {\n            prod *= v;\n            prod\n        }).rev()\n        .collect();\n    println!(\"{:?}\", p);\n}\n</code></pre>\n\n<p><a href=\"https://play.rust-lang.org/?gist=b2312eaa6356fa1eb24d7715a06ad9c6&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"noreferrer\">The result is <code>[2, 6, 24]</code></a>, the same as if I delete both <code>rev()</code>s. The two <code>rev()</code>s do not solve the problem, they just \"annihilate\" each other.</p>\n\n<p>Is this task solvable in \"chain of calls\" style, without using <code>for</code>?</p>\n"}, {"tags": ["dynamic", "rust", "vtable"], "answers": [{"comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 1, "creation_date": 1535143531, "post_id": 52011460, "comment_id": 90973965, "body": "Likely for forwards compatibility."}, {"owner": {"reputation": 8378, "user_id": 124538, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/82159aeb57c52bc0c7bfe6e9c832c3ea?s=128&d=identicon&r=PG", "display_name": "Wesley Wiser", "link": "https://stackoverflow.com/users/124538/wesley-wiser"}, "reply_to_user": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535143639, "post_id": 52011460, "comment_id": 90974005, "body": "@PeterHall Yes. Knowing the size &amp; alignment of data is so fundamental &amp; useful, there&#39;s little reason not to include it especially given that the storage overhead is once per type-vtable and it&#39;s just two <code>usize</code>s."}, {"owner": {"reputation": 975, "user_id": 7687388, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Xhm3T.png?s=128&g=1", "display_name": "CodeSandwich", "link": "https://stackoverflow.com/users/7687388/codesandwich"}, "edited": false, "score": 0, "creation_date": 1535146381, "post_id": 52011460, "comment_id": 90974911, "body": "Thank you for such a comprehensive answer! I have 1 more question: <a href=\"https://doc.rust-lang.org/nomicon/exotic-sizes.html\" rel=\"nofollow noreferrer\">Rustonomicon states</a> that DSTs pretty much boil down to slices. Slices have size unknown at compilation time. How do vtables handle size field of slices with different lengths? Does slice of 2 <code>u32</code>s have other vtable from slice of 3 <code>u32</code>s? After all one has size of 16 and other has 24 (simplification)."}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 975, "user_id": 7687388, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Xhm3T.png?s=128&g=1", "display_name": "CodeSandwich", "link": "https://stackoverflow.com/users/7687388/codesandwich"}, "edited": false, "score": 2, "creation_date": 1535186065, "post_id": 52011460, "comment_id": 90981121, "body": "@CodeSandwich The Rustonomicon might be being unclear. There are certain DSTs which resemble slices - structs with a few sized fields then a slice (or other DST) as the final field. A pointer to any DST has to carry extra information in the form of an extra <code>usize</code>. For slices, or slice-like DSTs, the extra information is the size of the slice. For trait objects, it&#39;s a pointer to the vtable."}, {"owner": {"reputation": 975, "user_id": 7687388, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Xhm3T.png?s=128&g=1", "display_name": "CodeSandwich", "link": "https://stackoverflow.com/users/7687388/codesandwich"}, "edited": false, "score": 0, "creation_date": 1535199070, "post_id": 52011460, "comment_id": 90984285, "body": "So that&#39;s why it&#39;s not possible to cast different trait objects, slice objects and composed DSTs to trait objects."}], "tags": [], "owner": {"reputation": 8378, "user_id": 124538, "user_type": "registered", "accept_rate": 95, "profile_image": "https://www.gravatar.com/avatar/82159aeb57c52bc0c7bfe6e9c832c3ea?s=128&d=identicon&r=PG", "display_name": "Wesley Wiser", "link": "https://stackoverflow.com/users/124538/wesley-wiser"}, "is_accepted": true, "score": 8, "last_activity_date": 1535143431, "creation_date": 1535143431, "answer_id": 52011460, "question_id": 52011247, "link": "https://stackoverflow.com/questions/52011247/why-do-trait-object-vtables-contain-size-and-alignment/52011460#52011460", "title": "Why do trait object vtables contain size and alignment?", "body": "<p>Here's what I've found so far:</p>\n\n<p>The size &amp; alignment properties in a vtable are loaded in the <a href=\"https://github.com/rust-lang/rust/blob/b75b0471a8b87c44e0bd953d2a5c36d896128723/src/librustc_codegen_llvm/glue.rs#L25\" rel=\"noreferrer\"><code>librustc_codegen_llvm::glue::size_and_align_of_dst()</code></a> function which returns the size and alignment of a dynamically sized type. For <code>ty::Dynamic(..)</code> values (the compiler's internal way of describing trait objects), the size and alignment are read from the vtable:</p>\n\n<pre><code>match t.sty {\n    ty::Dynamic(..) =&gt; {\n        // load size/align from vtable\n        let vtable = info.unwrap();\n        (meth::SIZE.get_usize(bx, vtable), meth::ALIGN.get_usize(bx, vtable))\n    }\n    ...\n}\n</code></pre>\n\n<p>This function in turn is used in several places:</p>\n\n<ul>\n<li><a href=\"https://github.com/rust-lang/rust/blob/b355906919927ab3c879becd14392f023af883a1/src/librustc_codegen_llvm/mir/operand.rs#L331\" rel=\"noreferrer\"><code>librustc_codegen_llvm::operand::store_unsized()</code></a> for allocating enough storage space on the stack for the storing the unboxed value. </li>\n<li><a href=\"https://github.com/rust-lang/rust/blob/b75b0471a8b87c44e0bd953d2a5c36d896128723/src/librustc_codegen_llvm/intrinsic.rs#L152\" rel=\"noreferrer\"><code>librustc_codegen_llvm::intrinsic::codegen_intrinsic_call()</code></a> for implementing the <a href=\"https://doc.rust-lang.org/core/intrinsics/fn.size_of_val.html\" rel=\"noreferrer\"><code>size_of_val()</code> intrinsic</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/blob/b75b0471a8b87c44e0bd953d2a5c36d896128723/src/librustc_codegen_llvm/intrinsic.rs#L166\" rel=\"noreferrer\"><code>librustc_codegen_llvm::intrinsic::codegen_intrinsic_call()</code></a> for implementing the <a href=\"https://doc.rust-lang.org/std/intrinsics/fn.min_align_of_val.html\" rel=\"noreferrer\"><code>min_align_of_val()</code> intrinsic</a></li>\n</ul>\n\n<p>I didn't spot any places where these values are currently fed into the Rust deallocation function (<a href=\"https://github.com/rust-lang/rust/blob/727eabd68143e968d8826ee29b8ea7792d29fa96/src/liballoc/alloc.rs#L28\" rel=\"noreferrer\"><code>__rust_dealloc()</code></a>), but they could certainly be used for that in the future.</p>\n"}], "owner": {"reputation": 975, "user_id": 7687388, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/Xhm3T.png?s=128&g=1", "display_name": "CodeSandwich", "link": "https://stackoverflow.com/users/7687388/codesandwich"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 533, "favorite_count": 2, "accepted_answer_id": 52011460, "answer_count": 1, "score": 7, "last_activity_date": 1535143431, "creation_date": 1535142174, "last_edit_date": 1535143329, "question_id": 52011247, "link": "https://stackoverflow.com/questions/52011247/why-do-trait-object-vtables-contain-size-and-alignment", "title": "Why do trait object vtables contain size and alignment?", "body": "<p>Rust's trait objects are fat pointers that contain 2 regular pointers: to data and to a vtable. The vtable is a structure containing a destructor function pointer, all trait method pointers and finally the size and alignment of the data.</p>\n\n<p><strong>What are the size and alignment fields for?</strong></p>\n\n<p>I couldn't find much:</p>\n\n<ul>\n<li><a href=\"https://huonw.github.io/blog/2015/01/peeking-inside-trait-objects/\" rel=\"noreferrer\">Blog post A</a>: it's for deallocating memory, but not used today, may be used by some future, more flexible mechanisms (What could it be? Does any exist yet?)</li>\n<li><a href=\"https://iandouglasscott.com/2018/05/28/exploring-rust-fat-pointers/\" rel=\"noreferrer\">Blog post B</a>: it's for deallocating type-erased boxed values, so they know how to release memory (Doesn't <code>Box</code> store location, size and alignment of its allocation? Every size variant of every DST can't get its own version of a vtable, can it?)</li>\n</ul>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535136489, "post_id": 52009797, "comment_id": 90971109, "body": "This is basically a duplicate of <a href=\"https://stackoverflow.com/q/40578224/155423\">Why doesn&#39;t the lifetime of a mutable borrow end when the function call is complete?</a> but I already used and withdrew my gold badge dupe-hammer. Let me know when this has been closed as a dupe and I&#39;ll delete my answer."}], "answers": [{"comments": [{"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "edited": false, "score": 0, "creation_date": 1535137178, "post_id": 52010101, "comment_id": 90971426, "body": "It might be worth making it clear that introducing another lifetime parameter, <code>fn func&lt;&#39;a, &#39;b&gt;(s: &amp;&#39;a mut String) -&gt; &amp;&#39;b str</code> could fix it?"}], "tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 2, "last_activity_date": 1535138412, "last_edit_date": 1535138412, "creation_date": 1535136109, "answer_id": 52010101, "question_id": 52009797, "link": "https://stackoverflow.com/questions/52009797/what-is-the-impact-of-the-return-type-in-a-function-with-a-mutable-borrow/52010101#52010101", "title": "What is the impact of the return type in a function with a mutable borrow?", "body": "<p>This question is basically a duplicate of <a href=\"https://stackoverflow.com/q/40578224/155423\">Why doesn&#39;t the lifetime of a mutable borrow end when the function call is complete?</a> but I already used and withdrew my gold badge dupe-hammer. Let me know when this has been closed as a dupe and I'll delete this answer.</p>\n\n<hr>\n\n<p>If you don't return a reference, there can be no borrow.</p>\n\n<blockquote>\n  <p>If the return type of <code>func</code> is changed to <code>&amp;str</code></p>\n</blockquote>\n\n<p>Then, due to <a href=\"https://doc.rust-lang.org/book/2018-edition/ch10-03-lifetime-syntax.html#lifetime-elision\" rel=\"nofollow noreferrer\">lifetime elision</a>, the function is equivalent to:</p>\n\n<pre><code>fn func&lt;'a&gt;(s: &amp;'a mut String) -&gt; &amp;'a str\n</code></pre>\n\n<p>And the returned value is allowed to borrow from the argument. Thus you can no longer change the argument in case it invalidates the return value.</p>\n\n<p>If the returned value <em>didn't</em> borrow from the argument, you can use lifetimes to disentangle them. Here we return a <code>'static</code> string:</p>\n\n<pre><code>fn func(s: &amp;mut String) -&gt; &amp;'static str {\n    \"\"\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/40578224/155423\">Why doesn&#39;t the lifetime of a mutable borrow end when the function call is complete?</a></li>\n<li><a href=\"https://stackoverflow.com/questions/47618823/cannot-borrow-as-mutable-because-it-is-also-borrowed-as-immutable?noredirect=1&amp;lq=1\">Cannot borrow as mutable because it is also borrowed as immutable</a></li>\n<li><a href=\"https://stackoverflow.com/questions/40325690/what-is-lifetime-elision-in-very-simple-terms\">What is lifetime elision in very simple terms?</a></li>\n</ul>\n"}], "owner": {"reputation": 637, "user_id": 4001713, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d94ed7161a76a1cc4faf18e3a68b5b63?s=128&d=identicon&r=PG&f=1", "display_name": "Shridharshan", "link": "https://stackoverflow.com/users/4001713/shridharshan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 121, "favorite_count": 0, "closed_date": 1535267422, "answer_count": 1, "score": 3, "last_activity_date": 1535138412, "creation_date": 1535134394, "last_edit_date": 1535135681, "question_id": 52009797, "link": "https://stackoverflow.com/questions/52009797/what-is-the-impact-of-the-return-type-in-a-function-with-a-mutable-borrow", "closed_reason": "Duplicate", "title": "What is the impact of the return type in a function with a mutable borrow?", "body": "<p>The following code in Rust builds and runs:</p>\n\n<pre><code>fn func(s: &amp;mut String) -&gt; i32 {\n    s.push_str(\"!\");\n    println!(\"{}\", s);\n    1\n}\n\nfn main() {\n    let mut x = String::from(\"hello world\");\n    let v = func(&amp;mut x);\n    println!(\"{}\", v);\n    let r = &amp;x[..];\n    println!(\"{}\", r);\n}\n</code></pre>\n\n<p>If the return type of <code>func</code> is changed to <code>&amp;str</code>, I get</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `x` as immutable because it is also borrowed as mutable\n  --&gt; src/main.rs:11:18\n   |\n9  |         let v = func(&amp;mut x);\n   |                           - mutable borrow occurs here\n10 |         println!(\"{}\", v);\n11 |         let r = &amp;x[..];\n   |                  ^ immutable borrow occurs here\n12 |         println!(\"{}\", r);\n13 |     }\n   |     - mutable borrow ends here\n</code></pre>\n\n<p>I know that in a given scope, only one mutable reference is allowed, but how does the return type matter?</p>\n"}, {"tags": ["rust", "future", "rust-tokio"], "comments": [{"owner": {"reputation": 28990, "user_id": 1114966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/af8712b05e5cfb862323a07c83749054?s=128&d=identicon&r=PG", "display_name": "squiguy", "link": "https://stackoverflow.com/users/1114966/squiguy"}, "edited": false, "score": 1, "creation_date": 1535131568, "post_id": 52009155, "comment_id": 90968996, "body": "You may be interested in using <a href=\"https://docs.rs/tokio/%2A/tokio/io/trait.AsyncRead.html#method.split\" rel=\"nofollow noreferrer\"><code>split</code></a> as well."}, {"owner": {"reputation": 746, "user_id": 4934881, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/c1f090bd6cc3203a5249c9be8d741d46?s=128&d=identicon&r=PG", "display_name": "dergroncki", "link": "https://stackoverflow.com/users/4934881/dergroncki"}, "reply_to_user": {"reputation": 28990, "user_id": 1114966, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/af8712b05e5cfb862323a07c83749054?s=128&d=identicon&r=PG", "display_name": "squiguy", "link": "https://stackoverflow.com/users/1114966/squiguy"}, "edited": false, "score": 0, "creation_date": 1535132021, "post_id": 52009155, "comment_id": 90969222, "body": "Can you explain how to use split here? As you can see from my code println!(&quot;{:?}&quot;, res) returns Ok((TcpStream, [19, 19, 19, ...].  How can I access the contained TcpStream and write data to the socket?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535132832, "post_id": 52009155, "comment_id": 90969624, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/52009155/edit\">edit</a> your question to include it. We cannot tell what crates, types, traits, fields, etc. are present in the code. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}], "answers": [{"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": true, "score": 5, "last_activity_date": 1535136886, "last_edit_date": 1535136886, "creation_date": 1535133129, "answer_id": 52009530, "question_id": 52009155, "link": "https://stackoverflow.com/questions/52009155/how-to-use-a-socket-contained-in-the-result-type-in-a-chain-of-futures/52009530#52009530", "title": "How to use a socket contained in the Result type in a chain of futures?", "body": "<p>Please start by re-reading <a href=\"https://doc.rust-lang.org/book/2018-edition\" rel=\"nofollow noreferrer\"><em>The Rust Programming Language</em></a>, specifically the chapter on <a href=\"https://doc.rust-lang.org/book/2018-edition/ch09-02-recoverable-errors-with-result.html\" rel=\"nofollow noreferrer\">Recoverable Errors with Result</a>. Then re-read the documentation for <a href=\"https://docs.rs/futures/0.1.23/futures/\" rel=\"nofollow noreferrer\">the library you are using</a>.</p>\n\n<p><a href=\"https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#method.then\" rel=\"nofollow noreferrer\"><code>Future::then</code></a>, emphasis mine:</p>\n\n<blockquote>\n<pre><code>fn then&lt;F, B&gt;(self, f: F) -&gt; Then&lt;Self, B, F&gt;\nwhere\n    F: FnOnce(Result&lt;Self::Item, Self::Error&gt;) -&gt; B,\n    B: IntoFuture,\n    Self: Sized,\n</code></pre>\n  \n  <p>Chain on a computation for when a future finished, passing the result\n  of the future to the provided closure <code>f</code>.</p>\n  \n  <p>This function can be used to ensure a computation runs <strong>regardless of\n  the conclusion</strong> of the future. The closure provided will be <strong>yielded a\n  <code>Result</code></strong> once the future is complete.</p>\n</blockquote>\n\n<p>Contrast this to the <em>other</em> function you are using, <a href=\"https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#method.and_then\" rel=\"nofollow noreferrer\"><code>Future::and_then</code></a>, emphasis mine:</p>\n\n<blockquote>\n<pre><code>fn and_then&lt;F, B&gt;(self, f: F) -&gt; AndThen&lt;Self, B, F&gt;\nwhere\n    F: FnOnce(Self::Item) -&gt; B,\n    B: IntoFuture&lt;Error = Self::Error&gt;,\n    Self: Sized, \n</code></pre>\n  \n  <p>Execute another future after this one has resolved <strong>successfully</strong>.</p>\n  \n  <p>This function can be used to chain two futures together and ensure\n  that the final future isn't resolved until both have finished. The\n  closure provided is yielded <strong>the successful result of this future</strong> and\n  returns another value which can be converted into a future.</p>\n</blockquote>\n\n<hr>\n\n<p>One solution is to only process it on success via <code>and_then</code>:</p>\n\n<pre><code>extern crate tokio; // 0.1.7\n\nuse tokio::{io, net::TcpStream, prelude::*};\n\nfn example(socket: TcpStream, buf_read: Vec&lt;u8&gt;) {\n    io::read_exact(socket, buf_read)\n        .and_then(|(socket, buf_read)| {\n            let buf_write = vec![19; 30];\n            io::write_all(socket, buf_write)\n        }).and_then(|(socket, data)| {\n            let buf_write = vec![18; 10];\n            io::write_all(socket, buf_write)\n        });\n    // TODO: use future somehow \n}\n</code></pre>\n\n<p>If you want to know about the failure, then you can continue to use <code>then</code> but you will have to handle the error somehow:</p>\n\n<pre><code>fn example(socket: TcpStream, buf_read: Vec&lt;u8&gt;) {\n    io::read_exact(socket, buf_read)\n        .and_then(|(socket, buf_read)| {\n            let buf_write = vec![19; 30];\n            io::write_all(socket, buf_write)\n        }).then(|res| match res {\n            Ok((socket, data)) =&gt; {\n                let buf_write = vec![18; 10];\n                io::write_all(socket, buf_write)\n            }\n            Err(e) =&gt; {\n                // Do something with the error and return another\n                // future that's type-compatible\n                unimplemented!()\n            },\n        });\n    // TODO: use future somehow\n}\n</code></pre>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/22187926/155423\">What&#39;s the benefit of using a Result?</a></li>\n</ul>\n"}], "owner": {"reputation": 746, "user_id": 4934881, "user_type": "registered", "accept_rate": 80, "profile_image": "https://www.gravatar.com/avatar/c1f090bd6cc3203a5249c9be8d741d46?s=128&d=identicon&r=PG", "display_name": "dergroncki", "link": "https://stackoverflow.com/users/4934881/dergroncki"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 112, "favorite_count": 0, "accepted_answer_id": 52009530, "answer_count": 1, "score": 1, "last_activity_date": 1535136886, "creation_date": 1535131302, "last_edit_date": 1535134971, "question_id": 52009155, "link": "https://stackoverflow.com/questions/52009155/how-to-use-a-socket-contained-in-the-result-type-in-a-chain-of-futures", "title": "How to use a socket contained in the Result type in a chain of futures?", "body": "<p>I have the following working code from the Tokio docs which I modified slightly:</p>\n\n<pre><code>// Task\nlet connection = io::read_exact(socket, buf_read)\n    .and_then(|(socket, buf_read)| {\n        println!(\"Do something with the received data...\");\n        for b in &amp;buf_read {\n            println!(\"{}\", b);\n        }\n\n        // Write to the socket\n        let buf_write = vec![19; 30];\n        io::write_all(socket, buf_write)\n    })\n    .then(|res| {\n        println!(\"{:?}\", res); // Just for testing\n        //Output: Ok((TcpStream, [19, 19, 19, ...]\n\n        println!(\"Send data...\");\n        let buf_write = vec![18; 10]; // Fill the buffer with some data\n        //\n        //How to use the socket contained in res to write the data to the socket\n        //    \n        Ok(())\n    });\n</code></pre>\n\n<p>In <a href=\"https://tokio.rs/docs/getting-started/hello-world/\" rel=\"nofollow noreferrer\">the docs it is mentioned</a></p>\n\n<blockquote>\n  <p>Note that <code>res</code> is a <code>Result</code> that contains the original socket. This allows us to sequence additional reads or writes on the same socket.</p>\n</blockquote>\n\n<p>How to use the socket contained in the <code>Result</code> to write data to the socket?</p>\n"}, {"tags": ["csv", "rust"], "comments": [{"owner": {"reputation": 10100, "user_id": 619216, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/c07104de771c3b6f6c30be8f592ef8f7?s=128&d=identicon&r=PG", "display_name": "BurntSushi5", "link": "https://stackoverflow.com/users/619216/burntsushi5"}, "edited": false, "score": 6, "creation_date": 1535123773, "post_id": 52007207, "comment_id": 90964911, "body": "csv is not a random access format, so you can&#39;t. The only thing you can do is edit an existing row such that it retains precisely the same number of bytes. It sounds like this is a case of an XY problem. If you need to make efficient edits to a 2GB data set, then csv is not the right format unless your edits are significantly constrained."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535124321, "post_id": 52007207, "comment_id": 90965243, "body": "I believe your question is answered by the answers of <a href=\"https://stackoverflow.com/q/51501313/155423\">How do I update a field in a csv::ByteRecord?</a>. If you disagree, please <a href=\"https://stackoverflow.com/posts/52007207/edit\">edit</a> your question to explain the differences. Otherwise, we can mark this question as already answered."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535124991, "post_id": 52007207, "comment_id": 90965649, "body": "Or <a href=\"https://stackoverflow.com/q/5506656/155423\">Write/Edit CSV-file (not rewrite the whole file!)</a>; <a href=\"https://stackoverflow.com/q/16020858/155423\">Inline CSV File Editing with Python</a>; <a href=\"https://stackoverflow.com/q/35440228/155423\">PHP - Update specific row in CSV file</a>; <a href=\"https://stackoverflow.com/q/3561278/155423\">How to parse a CSV file, update a field, then save</a> \u2013 no matter the language it&#39;s impossible in general by design."}, {"owner": {"reputation": 71, "user_id": 5086327, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-tkZmvFw1Bmc/AAAAAAAAAAI/AAAAAAAAADM/9vd_WvP67lk/photo.jpg?sz=128", "display_name": "Tonis", "link": "https://stackoverflow.com/users/5086327/tonis"}, "edited": false, "score": 0, "creation_date": 1535125524, "post_id": 52007207, "comment_id": 90965970, "body": "Okay, this can be marked as answered then."}], "owner": {"reputation": 71, "user_id": 5086327, "user_type": "registered", "profile_image": "https://lh5.googleusercontent.com/-tkZmvFw1Bmc/AAAAAAAAAAI/AAAAAAAAADM/9vd_WvP67lk/photo.jpg?sz=128", "display_name": "Tonis", "link": "https://stackoverflow.com/users/5086327/tonis"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 526, "favorite_count": 0, "closed_date": 1535128432, "answer_count": 0, "score": 0, "last_activity_date": 1535128514, "creation_date": 1535123057, "last_edit_date": 1535124538, "question_id": 52007207, "link": "https://stackoverflow.com/questions/52007207/edit-a-specific-row-in-csv-file-without-rewriting-whole-file", "closed_reason": "Duplicate", "title": "Edit a specific row in CSV file without rewriting whole file", "body": "<p>How can I delete or edit a specific row in a CSV file without rewriting the whole file?</p>\n\n<p>This code works with the <em>rust-csv</em> library and does the job well:</p>\n\n<pre><code>extern crate csv; // 1.0.1\n\nuse csv::{ReaderBuilder, WriterBuilder};\nuse std::error::Error;\n\npub fn delete_data(table_name: String, column: String, query: String) -&gt; Result&lt;(), Box&lt;Error&gt;&gt; {\n    let mut rdr = ReaderBuilder::new()\n        .has_headers(true)\n        .from_path(format!(\"{}.csv\", table_name))?;\n    let column_index: usize;\n    {\n        let header = rdr.byte_headers()?;\n        column_index = header.iter().position(|r| r == column.as_bytes()).unwrap();\n    }\n\n    let mut wtr = WriterBuilder::new().from_path(format!(\"{}.csv\", table_name))?;\n    wtr.write_record(rdr.byte_headers()?)?;\n\n    for result in rdr.byte_records() {\n        let record = result?;\n        if record.get(column_index).unwrap() == query.as_bytes() {\n            wtr.write_record(&amp;record)?;\n        }\n    }\n\n    wtr.flush()?;\n    Ok(())\n}\n</code></pre>\n\n<p>I would like to improve the solution so that it will not rewrite the whole file as new, only edit the certain row that's needed to delete/update.</p>\n\n<p>For example, I have 2GB of data, refreshing all the rows on each edit of value is not what I would like to do.</p>\n"}, {"tags": ["oop", "object", "struct", "rust", "instanceof"], "comments": [{"owner": {"reputation": 5513, "user_id": 2718801, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/9d4b144cdafa73e1d470362ed8d7c3a9?s=128&d=identicon&r=PG", "display_name": "jhpratt", "link": "https://stackoverflow.com/users/2718801/jhpratt"}, "edited": false, "score": 5, "creation_date": 1535117181, "post_id": 52005382, "comment_id": 90960635, "body": "Why would you need this, given Rust&#39;s compile time guarantees?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535117510, "post_id": 52005382, "comment_id": 90960863, "body": "Please review how to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> and then <a href=\"https://stackoverflow.com/posts/52005382/edit\">edit</a> your question to include it. We cannot tell what types, fields, etc. are present in the code, nor can we see <i>why</i> you want to accomplish this goal or what code would require it. Try to produce something that reproduces your error on the <a href=\"https://play.rust-lang.org\" rel=\"nofollow noreferrer\">Rust Playground</a> or you can reproduce it in a brand new Cargo project. There are <a href=\"//stackoverflow.com/tags/rust/info\">Rust-specific MCVE tips</a> as well."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535117753, "post_id": 52005382, "comment_id": 90961037, "body": "Perhaps <a href=\"https://stackoverflow.com/q/26126683/155423\">How to match trait implementors</a> will help"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535119228, "post_id": 52005382, "comment_id": 90961998, "body": "Your updated  code does not contain a definition for <code>User</code>; does it even need to have a user at all to show the problem? Most importantly, it doesn&#39;t show the code explaining why you <i>need</i> an <code>instanceof</code> check in the first place. It just shows that you want to call it."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535119305, "post_id": 52005382, "comment_id": 90962058, "body": "Are you already aware that <a href=\"https://stackoverflow.com/questions/30894002/is-it-good-practice-to-often-use-instanceof\">using <code>instanceof</code> in Java is not a good idea</a>? Copying bad design from one language to the other is not usually an encouraged path."}, {"owner": {"reputation": 145, "user_id": 9159340, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/5NmP6.jpg?s=128&g=1", "display_name": "Dialvive", "link": "https://stackoverflow.com/users/9159340/dialvive"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535119618, "post_id": 52005382, "comment_id": 90962261, "body": "Hard time writing a first-time question in StackOverflow haha, thank you @Shepmaster"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535119927, "post_id": 52005382, "comment_id": 90962475, "body": "<i>Hard time writing a first-time question</i> \u2014 I note from your profile that you are a CS student, so hopefully this unsolicited advice isn&#39;t unwelcomed: the feedback that we are providing you with is absolutely not limited to Stack Overflow. It will be pertinent to every part of your entire professional life. Reducing a problem to it&#39;s bare essentials (&quot;create a MCVE&quot;), evaluating <i>why</i> you are doing something, taking the time to format and frame your communication, etc. are all critical to success (in programming and likely most everything)."}, {"owner": {"reputation": 145, "user_id": 9159340, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/5NmP6.jpg?s=128&g=1", "display_name": "Dialvive", "link": "https://stackoverflow.com/users/9159340/dialvive"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535121184, "post_id": 52005382, "comment_id": 90963333, "body": "Any advice is more than welcomed @Shepmaster !  &quot;crate&quot; changed to &quot;module&quot;, thanks."}], "answers": [{"comments": [{"owner": {"reputation": 9895, "user_id": 452775, "user_type": "registered", "accept_rate": 63, "profile_image": "https://www.gravatar.com/avatar/88963e7cc58eabf150447e7b78a24793?s=128&d=identicon&r=PG", "display_name": "Lii", "link": "https://stackoverflow.com/users/452775/lii"}, "edited": false, "score": 0, "creation_date": 1535119639, "post_id": 52005668, "comment_id": 90962276, "body": "Does your initial solution using <code>instance_of</code> work also if <code>msg</code> is a reference with a trait type, and if its value is some unknown trait implementation, either <code>SimpleMessage</code> or <code>ComplexMessage</code>? That is the essence of the Java <code>instanceof</code> operator, that the runtime type of the argument is tested. In your given example <code>msg</code> seems to have the non-reference type <code>ComplexMessage</code>. An <code>instanceof</code> operator which only works in that case is nothing like the one that is found in Java, and that should be clearly stated in the answer text."}, {"owner": {"reputation": 145, "user_id": 9159340, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/5NmP6.jpg?s=128&g=1", "display_name": "Dialvive", "link": "https://stackoverflow.com/users/9159340/dialvive"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535119841, "post_id": 52005668, "comment_id": 90962416, "body": "I also thought about using a Struct-tuple, haven&#39;t given a thought for enums though, using them may be a more elegant (and much useful) solution, let me try it out, thanks DK. @Shepmaster"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 9895, "user_id": 452775, "user_type": "registered", "accept_rate": 63, "profile_image": "https://www.gravatar.com/avatar/88963e7cc58eabf150447e7b78a24793?s=128&d=identicon&r=PG", "display_name": "Lii", "link": "https://stackoverflow.com/users/452775/lii"}, "edited": false, "score": 0, "creation_date": 1535120156, "post_id": 52005668, "comment_id": 90962639, "body": "@Lii No it won&#39;t work in that situation. It&#39;s literally only going to match exact types."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535120261, "post_id": 52005668, "comment_id": 90962714, "body": "Wouldn&#39;t <a href=\"https://doc.rust-lang.org/std/any/trait.Any.html#method.is\" rel=\"nofollow noreferrer\"><code>Any::is</code></a> be a shorter implementation?"}, {"owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535121020, "post_id": 52005668, "comment_id": 90963217, "body": "@Shepmaster Meh, it limits the types to be <code>Sized</code>. May not be a problem..."}, {"owner": {"reputation": 145, "user_id": 9159340, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/5NmP6.jpg?s=128&g=1", "display_name": "Dialvive", "link": "https://stackoverflow.com/users/9159340/dialvive"}, "edited": false, "score": 1, "creation_date": 1535122293, "post_id": 52005668, "comment_id": 90964038, "body": "Thanks @PeterHall using enums it is the most elegant/practical solution."}], "tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": true, "score": 7, "last_activity_date": 1535136495, "last_edit_date": 1535136495, "creation_date": 1535117734, "answer_id": 52005668, "question_id": 52005382, "link": "https://stackoverflow.com/questions/52005382/what-is-a-function-for-structs-like-javas-instanceof/52005668#52005668", "title": "What is a function for structs like Java&#39;s instanceof?", "body": "<p>First of all, if you try to port Java OOP idioms to Rust you are going to have a hard time. Rust programmers use completely different idioms and patterns, which are more suited to the design of the language.</p>\n\n<p>That said, you can compare types using <code>std::any::TypeId</code>. A <em>similar</em> function to <code>instanceOf</code> can be implemented like this:</p>\n\n<pre><code>use std::any::{Any, TypeId};\n\ntrait InstanceOf\nwhere\n    Self: Any,\n{\n    fn instance_of&lt;U: ?Sized + Any&gt;(&amp;self) -&gt; bool {\n        TypeId::of::&lt;Self&gt;() == TypeId::of::&lt;U&gt;()\n    }\n}\n\n// implement this trait for every type that implements `Any` (which is most types)\nimpl&lt;T: ?Sized + Any&gt; InstanceOf for T {}\n</code></pre>\n\n<p>And use it like this:</p>\n\n<pre><code>let msg = ComplexMessage::new();\n\nprintln!(\"msg is ComplexMessage: {}\", msg.instance_of::&lt;ComplexMessage&gt;());\nprintln!(\"msg is SimpleMessage: {}\", msg.instance_of::&lt;SimpleMessage&gt;());\n</code></pre>\n\n<p>Outputs:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>msg is ComplexMessage: true\nmsg is SimpleMessage: false\n</code></pre>\n\n<p>Note that Rust does not have a concept of type inheritance like Java does, so this will only tell you if it is exactly the same type.</p>\n\n<hr>\n\n<p>A more Rusty approach to your problem, as DK commented below this answer, would be to use an <code>enum</code> to model the fact that you have two kinds of message. Rust <code>enum</code>s are nothing like Java <code>enum</code>s - they are just as powerful as <code>struct</code>s except they model the idea of alternatives, as opposed to aggregates. Here is one way you could implement this using the types you have and wrapping them up:</p>\n\n<pre><code>enum Message&lt;'a&gt; {\n    Complex(ComplexMessage&lt;'a&gt;),\n    Simple(SimpleMessage&lt;'a&gt;),\n}\n</code></pre>\n\n<p>Whenever a function can only accept a <code>ComplexMessage</code> you can write the signature to reflect that:</p>\n\n<pre><code>fn send_multimedia(msg: ComplexMessage) { ... }\n</code></pre>\n\n<p>And whenever you can accept either type, use the <code>enum</code>:</p>\n\n<pre><code>fn get_msg_size(msg: Message) -&gt; usize {\n    match(msg) {\n        Message::Complex(complex) =&gt; complex.content.len() + complex.file.size(),\n        Message::Simple(simple) =&gt; simple.content.len(),\n    }\n}\n</code></pre>\n"}], "owner": {"reputation": 145, "user_id": 9159340, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/5NmP6.jpg?s=128&g=1", "display_name": "Dialvive", "link": "https://stackoverflow.com/users/9159340/dialvive"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 778, "favorite_count": 0, "accepted_answer_id": 52005668, "answer_count": 1, "score": 7, "last_activity_date": 1535136495, "creation_date": 1535116713, "last_edit_date": 1535121373, "question_id": 52005382, "link": "https://stackoverflow.com/questions/52005382/what-is-a-function-for-structs-like-javas-instanceof", "title": "What is a function for structs like Java&#39;s instanceof?", "body": "<p>I'm making an OOP chat client in Rust. The module messages.rs creates and handles messages to other modules as structs: <code>SimpleMessage</code> and <code>ComplexMessage</code> structs:</p>\n\n<pre><code>//! # Messages\n\nuse time::SteadyTime;\n\n/// Represents a simple text message\npub struct SimpleMessage&lt;'a&gt; {\n    pub user: ...\n    pub time: &amp;'a SteadyTime&lt;'a&gt;,\n    pub content: &amp;'a str,\n}\n\n/// Represents attachments, like text or multimedia files.\npub struct ComplexMessage&lt;'a&gt; {\n    pub user: ...\n    pub time: &amp;'a SteadyTime&lt;'a&gt;,\n    //pub content: PENDING\n}\n\nimpl&lt;'a&gt; SimpleMessage&lt;'a&gt; { }\nimpl&lt;'a&gt; ComplexMessage&lt;'a&gt; { }\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn is_simple() {\n        assert_eq!(&amp;self.instance_of(), SimpleMessage);\n    }\n\n    #[test]\n    fn is_complex() {\n        assert_eq!(&amp;self.instance_of(), ComplexMessage);\n    }\n}\n</code></pre>\n\n<p>I'm troubled finding a Java-like function such as <code>InstanceOf()</code> for structs, that would potentially work like: </p>\n\n<pre><code>&amp;self.instance_of() -&gt; str\n</code></pre>\n\n<p>This would be used to process a <code>ComplexMessage</code> different from a <code>SimpleMessage</code> in a GUI, adding a preview and download button for the <code>ComplexMessage</code>.</p>\n\n<p>Any ideas?</p>\n"}, {"tags": ["rust", "unix-socket"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535107726, "post_id": 52002298, "comment_id": 90954703, "body": "This is not a <a href=\"https://stackoverflow.com/help/mcve\">MCVE</a>. Please try to create one"}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535107898, "post_id": 52002298, "comment_id": 90954801, "body": "Code has been edited."}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535108042, "post_id": 52002298, "comment_id": 90954882, "body": "Why don&#39;t you just use a regular <a href=\"https://doc.rust-lang.org/std/net/struct.UdpSocket.html\" rel=\"nofollow noreferrer\">UDP socket</a>?"}, {"owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535108230, "post_id": 52002298, "comment_id": 90954987, "body": "The use I have is for IPC between processes that require to communicate using socket files for various other reasons."}], "answers": [{"tags": [], "owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "is_accepted": true, "score": 3, "last_activity_date": 1535109138, "last_edit_date": 1535109138, "creation_date": 1535108270, "answer_id": 52003001, "question_id": 52002298, "link": "https://stackoverflow.com/questions/52002298/using-unix-sockets-with-socket2/52003001#52003001", "title": "Using Unix sockets with socket2", "body": "<blockquote>\n  <p><a href=\"https://docs.rs/socket2/0.3.7/socket2/struct.Domain.html#method.unix\" rel=\"nofollow noreferrer\">This function is only available on Unix when the <code>unix</code> feature is activated.</a></p>\n</blockquote>\n\n<p>And <a href=\"https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#choosing-features\" rel=\"nofollow noreferrer\">How to activate a feature</a></p>\n\n<p>In your case just add this to your cargo manifest:</p>\n\n<pre><code>[dependencies.socket2]\nversion = \"0.3.7\"\nfeatures = [\"unix\"]\n</code></pre>\n"}], "owner": {"reputation": 916, "user_id": 3019905, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/P1ga3.png?s=128&g=1", "display_name": "Dash83", "link": "https://stackoverflow.com/users/3019905/dash83"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 231, "favorite_count": 0, "accepted_answer_id": 52003001, "answer_count": 1, "score": 1, "last_activity_date": 1535109289, "creation_date": 1535105730, "last_edit_date": 1535109289, "question_id": 52002298, "link": "https://stackoverflow.com/questions/52002298/using-unix-sockets-with-socket2", "title": "Using Unix sockets with socket2", "body": "<p>I'm trying to build a Unix-domain socket using the <a href=\"https://crates.io/crates/socket2\" rel=\"nofollow noreferrer\">socket2</a> crate and the most basic code fails to compile:</p>\n\n<pre><code>extern crate socket2;\nuse socket2::*;\n\nfn main() {\n    let socket = Socket::new(Domain::unix(), Type::dgram(), None).unwrap();\n}\n</code></pre>\n\n<p>This is the error:</p>\n\n<blockquote>\n<pre><code>5 | let socket = Socket::new(Domain::unix(), Type::dgram(), None).unwrap();\n  |                          ^^^^^^^^^^^^ function or associated item not found in \n                                               `socket2::Domain`\n</code></pre>\n</blockquote>\n\n<p>The <a href=\"https://docs.rs/socket2/0.3.7/socket2/struct.Domain.html\" rel=\"nofollow noreferrer\">documentation</a> indicates, that unix function is \"only available on Unix when the unix feature is activated\". I'm running this code on a Ubuntu machine. Do I need to activate anything else in my cargo file for this function to be enabled? The crate lacks examples that I can rely on.</p>\n"}, {"tags": ["rust", "traits", "return-type"], "answers": [{"comments": [{"owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 1, "creation_date": 1535212552, "post_id": 52018925, "comment_id": 90988023, "body": "What is the <code>dyn</code> keyword doing? It works just fine without it"}, {"owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "reply_to_user": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "edited": false, "score": 12, "creation_date": 1535212676, "post_id": 52018925, "comment_id": 90988067, "body": "Technically, it&#39;s redundant.  It was introduced to &quot;clarify&quot; what the code means: <code>dyn RngCore</code> is a dynamically dispatched type derived from the <code>RngCore</code> trait.  <code>dyn</code> will be required in a future edition of Rust.  It&#39;s exactly the sort of thing Shepmaster will edit, so I might as well get it over with now."}], "tags": [], "owner": {"reputation": 44438, "user_id": 42353, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/f05e802879a805c03a55645dfcc0d4ea?s=128&d=identicon&r=PG", "display_name": "DK.", "link": "https://stackoverflow.com/users/42353/dk"}, "is_accepted": true, "score": 16, "last_activity_date": 1594994523, "last_edit_date": 1594994523, "creation_date": 1535212514, "answer_id": 52018925, "question_id": 52001592, "link": "https://stackoverflow.com/questions/52001592/why-can-impl-trait-not-be-used-to-return-multiple-conditional-types/52018925#52018925", "title": "Why can impl trait not be used to return multiple / conditional types?", "body": "<p><code>impl Trait</code> is not equivalent to returning an interface or base class object.  It's a way of saying &quot;I don't want to write the name of the specific type I'm returning&quot;.  You're still returning a value of a single, specific type; you just aren't saying <em>which</em> type.</p>\n<p>Each of those branches is returning different types, hence the problem.  Implementing the same trait is not enough.</p>\n<p>What you likely want in this specific case is a trait object like <code>Box&lt;dyn RngCore&gt;</code>.</p>\n<pre><code>extern crate rand; // 0.6.5\n\nuse rand::{rngs::OsRng, thread_rng, RngCore};\n\nfn rng() -&gt; Box&lt;dyn RngCore&gt; {\n    match OsRng::new() {\n        Ok(rng) =&gt; Box::new(rng),\n        Err(_) =&gt; Box::new(thread_rng()),\n    }\n}\n</code></pre>\n<p><strong>Note</strong>: if you are using a slightly older version of Rust, you may need to remove the <code>dyn</code> keyword.  It's optional in the previous (2015) edition of Rust.</p>\n"}, {"tags": [], "owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "is_accepted": false, "score": 11, "last_activity_date": 1553798613, "last_edit_date": 1553798613, "creation_date": 1553740184, "answer_id": 55389318, "question_id": 52001592, "link": "https://stackoverflow.com/questions/52001592/why-can-impl-trait-not-be-used-to-return-multiple-conditional-types/55389318#55389318", "title": "Why can impl trait not be used to return multiple / conditional types?", "body": "<p><a href=\"https://stackoverflow.com/a/52018925/155423\">DK. has already explained <em>why</em></a>, but I'd like to provide an alternative workaround.</p>\n\n<p>As mentioned in <a href=\"https://stackoverflow.com/questions/29760668/conditionally-iterate-over-one-of-several-possible-iterators\">Conditionally iterate over one of several possible iterators</a>, you can create an enum that implements a trait if both of its component types do. For example:</p>\n\n<pre><code>extern crate rand; // 0.6.5\n\nuse rand::{rngs::OsRng, thread_rng, RngCore};\n\nfn rng() -&gt; impl RngCore {\n    match OsRng::new() {\n        Ok(rng) =&gt; EitherRng::Left(rng),\n        Err(_) =&gt; EitherRng::Right(thread_rng()),\n    }\n}\n\nenum EitherRng&lt;L, R&gt; {\n    Left(L),\n    Right(R),\n}\n\nimpl&lt;L, R&gt; RngCore for EitherRng&lt;L, R&gt;\nwhere\n    L: RngCore,\n    R: RngCore,\n{\n    fn next_u32(&amp;mut self) -&gt; u32 {\n        match self {\n            EitherRng::Left(l) =&gt; l.next_u32(),\n            EitherRng::Right(r) =&gt; r.next_u32(),\n        }\n    }\n\n    fn next_u64(&amp;mut self) -&gt; u64 {\n        match self {\n            EitherRng::Left(l) =&gt; l.next_u64(),\n            EitherRng::Right(r) =&gt; r.next_u64(),\n        }\n    }\n\n    fn fill_bytes(&amp;mut self, b: &amp;mut [u8]) {\n        match self {\n            EitherRng::Left(l) =&gt; l.fill_bytes(b),\n            EitherRng::Right(r) =&gt; r.fill_bytes(b),\n        }\n    }\n\n    fn try_fill_bytes(&amp;mut self, b: &amp;mut [u8]) -&gt; Result&lt;(), rand::Error&gt; {\n        match self {\n            EitherRng::Left(l) =&gt; l.try_fill_bytes(b),\n            EitherRng::Right(r) =&gt; r.try_fill_bytes(b),\n        }\n    }\n}\n</code></pre>\n\n<p>The <a href=\"https://crates.io/crates/either\" rel=\"noreferrer\">either crate</a> provides a lot of these types of implementations for fundamental traits. </p>\n\n<p>See also:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/q/51885745/155423\">How do I conditionally return different types of futures?</a></li>\n</ul>\n"}], "owner": {"reputation": 6355, "user_id": 3755692, "user_type": "registered", "accept_rate": 62, "profile_image": "https://i.stack.imgur.com/F7x32.png?s=128&g=1", "display_name": "msrd0", "link": "https://stackoverflow.com/users/3755692/msrd0"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 3158, "favorite_count": 3, "accepted_answer_id": 52018925, "answer_count": 2, "score": 13, "last_activity_date": 1605895994, "creation_date": 1535103459, "last_edit_date": 1605895994, "question_id": 52001592, "link": "https://stackoverflow.com/questions/52001592/why-can-impl-trait-not-be-used-to-return-multiple-conditional-types", "title": "Why can impl trait not be used to return multiple / conditional types?", "body": "<p>I'm trying to get a random number generator. Since <code>OsRng::new()</code> can fail, I'd like to fall back to <code>thread_rng()</code> if I have to:</p>\n<pre><code>extern crate rand; // 0.5.5\n\nuse rand::{thread_rng, OsRng, RngCore};\n\nfn rng() -&gt; impl RngCore\n{\n    match OsRng::new() {\n        Ok(rng) =&gt; rng,\n        Err(e) =&gt; thread_rng()\n    }\n}\n</code></pre>\n<p>However, I get this error message which I cannot understand:</p>\n<pre class=\"lang-none prettyprint-override\"><code>error[E0308]: match arms have incompatible types\n --&gt; src/lib.rs:6:5\n  |\n6 | /     match OsRng::new() {\n7 | |         Ok(rng) =&gt; rng,\n8 | |         Err(e) =&gt; thread_rng(),\n  | |                   ------------ match arm with an incompatible type\n9 | |     }\n  | |_____^ expected struct `rand::OsRng`, found struct `rand::ThreadRng`\n  |\n  = note: expected type `rand::OsRng`\n             found type `rand::ThreadRng`\n</code></pre>\n<p>Why is the compiler expecting <code>rand::OsRng</code> here instead of an implementation of <code>RngCore</code>? If I remove the <code>match</code> and directly return <code>thread_rng()</code>, I don't get above error message.</p>\n<p>I do not believe that this is a duplicate of <a href=\"https://stackoverflow.com/q/30661046/3755692\">How do I return an instance of a trait from a method?</a>, as the other question is asking about <strong>how</strong> one can return a trait from a function, and this question is about <strong>why</strong> the compiler will not allow me to return a trait but wants me to return an <code>OsRng</code> which is not the return type of the function.</p>\n"}, {"tags": ["generics", "struct", "syntax", "rust", "tuples"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535102221, "post_id": 52001160, "comment_id": 90951459, "body": "Do you want a generic struct like <code>struct CustomSet &lt;T&gt;</code>?"}, {"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535102387, "post_id": 52001160, "comment_id": 90951560, "body": "&quot;unit data type&quot; what is it ?"}, {"owner": {"reputation": 809, "user_id": 4562090, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/49c1bc24e5ba1f2f49155650e7902a3c?s=128&d=identicon&r=PG&f=1", "display_name": "Raynal Gobel", "link": "https://stackoverflow.com/users/4562090/raynal-gobel"}, "edited": false, "score": 0, "creation_date": 1535102403, "post_id": 52001160, "comment_id": 90951571, "body": "Generic struct will force me to implement custom <code>T</code> type and rust compiler will complain that type <code>T</code> is unused on the struct."}, {"owner": {"reputation": 809, "user_id": 4562090, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/49c1bc24e5ba1f2f49155650e7902a3c?s=128&d=identicon&r=PG&f=1", "display_name": "Raynal Gobel", "link": "https://stackoverflow.com/users/4562090/raynal-gobel"}, "edited": false, "score": 0, "creation_date": 1535102440, "post_id": 52001160, "comment_id": 90951588, "body": "&quot;unit data type&quot; is just an empty tuple <code>()</code>. I found it on <a href=\"https://stackoverflow.com/questions/31107614/what-does-an-empty-set-of-parentheses-mean-when-used-in-a-generic-type-declarati?rq=1\">here</a>"}], "answers": [{"tags": [], "owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "is_accepted": true, "score": 4, "last_activity_date": 1535116358, "last_edit_date": 1535116358, "creation_date": 1535103258, "answer_id": 52001525, "question_id": 52001160, "link": "https://stackoverflow.com/questions/52001160/how-to-return-a-struct-with-the-unit-data-type/52001525#52001525", "title": "How to return a struct with the unit data type?", "body": "<p>In this case you have to use <a href=\"https://doc.rust-lang.org/std/marker/struct.PhantomData.html\" rel=\"nofollow noreferrer\"><code>PhantomData</code></a></p>\n\n<pre><code>use std::marker::PhantomData;\n\nstruct CustomSet&lt;T&gt; {\n    _phantom: PhantomData&lt;T&gt;,\n}\n\nimpl CustomSet&lt;()&gt; {\n    pub fn new() -&gt; CustomSet&lt;()&gt; {\n        CustomSet {\n            _phantom: PhantomData,\n        }\n    }\n}\n</code></pre>\n\n<p>The PhantomData \"informs\" the  compiler that the argument <code>T</code> is used and so it will no longer complain about that.</p>\n\n<p>Note that although you add a member to your struct, it will not consume any more size.</p>\n\n<pre><code>fn main() {\n    println!(\"{}\", std::mem::size_of::&lt;CustomSet&lt;()&gt;&gt;());  // 0\n    println!(\"{}\", std::mem::size_of::&lt;CustomSet&lt;u32&gt;&gt;()); // 0\n} \n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 36134, "user_id": 493729, "user_type": "registered", "accept_rate": 89, "profile_image": "https://i.stack.imgur.com/bU0Kx.jpg?s=128&g=1", "display_name": "Peter Hall", "link": "https://stackoverflow.com/users/493729/peter-hall"}, "is_accepted": false, "score": 6, "last_activity_date": 1535116650, "last_edit_date": 1535116650, "creation_date": 1535115087, "answer_id": 52004917, "question_id": 52001160, "link": "https://stackoverflow.com/questions/52001160/how-to-return-a-struct-with-the-unit-data-type/52004917#52004917", "title": "How to return a struct with the unit data type?", "body": "<p>The type <code>CustomSet&lt;()&gt;</code> only makes sense if <code>CustomSet</code> is defined with a type parameter. A type parameter is a variable, not another type, so your definition doesn't really make sense. Rather, you need to define it with a variable:</p>\n\n<pre><code>struct CustomSet&lt;T&gt; {}\n</code></pre>\n\n<p>This means that <code>CustomSet</code> is defined for any possible type <code>T</code> (with the caveat that the type must be <code>Sized</code>, which is true of most types).</p>\n\n<p>Now, the definition above won't work as it is because Rust will complain that you are not using the variable <code>T</code> inside the type. What's the point of a variable you don't use?</p>\n\n<p>As <a href=\"https://stackoverflow.com/a/52001525/493729\">hellow said</a>, you could use <code>PhantomData</code>, but that is more of a workaround for when you need the variable but don't actually need to use it for some reason. Since you are implementing a collection, you will want to use the <code>T</code> in order to store values somewhere:</p>\n\n<pre><code>struct CustomSet&lt;T&gt; {\n    data: Vec&lt;T&gt;,\n}\n</code></pre>\n\n<p>The behaviour of this type can still be implemented for <em>all possible</em> <code>T</code>, not just <code>()</code>, giving you lots of code reuse:</p>\n\n<pre><code>impl&lt;T&gt; CustomSet&lt;T&gt; {\n    pub fn new() -&gt; CustomSet&lt;T&gt; {\n        CustomSet {\n            data: Vec::new(),\n        }\n    }\n}\n</code></pre>\n\n<p>It's only when you actually use the type that you need to constrain <code>T</code> at all:</p>\n\n<pre><code>let my_set: CustomSet&lt;()&gt; = CustomSet::new();\n</code></pre>\n\n<p>Even that type annotation would often not be needed in a real program, as it would be inferred from usage. For example, if you had provided an <code>insert</code> method for <code>CustomSet</code>, you might use it like this:</p>\n\n<pre><code>// type annotation not needed because it will be inferred from the next line\nlet mut my_set = CustomSet::new();\nmy_set.insert(());\n</code></pre>\n"}], "owner": {"reputation": 809, "user_id": 4562090, "user_type": "registered", "accept_rate": 75, "profile_image": "https://www.gravatar.com/avatar/49c1bc24e5ba1f2f49155650e7902a3c?s=128&d=identicon&r=PG&f=1", "display_name": "Raynal Gobel", "link": "https://stackoverflow.com/users/4562090/raynal-gobel"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 272, "favorite_count": 0, "accepted_answer_id": 52001525, "answer_count": 2, "score": 1, "last_activity_date": 1545399019, "creation_date": 1535102059, "last_edit_date": 1545399019, "question_id": 52001160, "link": "https://stackoverflow.com/questions/52001160/how-to-return-a-struct-with-the-unit-data-type", "title": "How to return a struct with the unit data type?", "body": "<p>I am trying to implement a custom set. This can be compiled with no problems:</p>\n\n<pre><code>struct CustomSet {}\n\nimpl CustomSet {\n    pub fn new() -&gt; CustomSet {\n        CustomSet {}\n    }\n}\n</code></pre>\n\n<p>When I tried to add unit type (empty tuple) into the <code>CustomSet</code> type, it won't compile.</p>\n\n<pre><code>struct CustomSet&lt;()&gt; {}\n\nimpl CustomSet&lt;()&gt; {\n    pub fn new() -&gt; CustomSet&lt;()&gt; {\n        CustomSet {}\n    }\n}\n</code></pre>\n\n<p>Error with the following</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error: expected one of `&gt;`, identifier, or lifetime, found `(`\n --&gt; src/lib.rs:1:18\n  |\n1 | struct CustomSet&lt;()&gt; {}\n  |                  ^ expected one of `&gt;`, identifier, or lifetime here\n</code></pre>\n\n<p>How to return a struct with the unit data type? What did I do wrong?</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535076966, "post_id": 51996526, "comment_id": 90942497, "body": "What is your <i>question</i>?"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535078673, "post_id": 51996526, "comment_id": 90942780, "body": "See also <a href=\"https://stackoverflow.com/q/43420605/155423\">Which algorithm from petgraph will find the shortest path from A to B?</a>; <a href=\"https://stackoverflow.com/q/47737084/155423\">How can I simultaneously iterate over a Rust HashMap and modify some of its values?</a>; <a href=\"https://stackoverflow.com/q/35524499/155423\">cannot borrow variable as mutable because it is also borrowed as immutable while building a self-referential HashMap</a>; <a href=\"https://stackoverflow.com/q/44453398/155423\">HashMap: borrow read/write at the same time</a>; etc."}, {"owner": {"reputation": 998, "user_id": 3874512, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2096d0d108e55ca0b691fb9161377ae1?s=128&d=identicon&r=PG&f=1", "display_name": "BowlingHawk95", "link": "https://stackoverflow.com/users/3874512/bowlinghawk95"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535081575, "post_id": 51996526, "comment_id": 90943357, "body": "@Shepmaster forgive me, I assumed the question would be implicit given the error and my statement of the desired algorithm.  Edited.  Thank you for the alternate questions, none of these came up in my Google searches for this problem.  I will look them over and see what I can take away from them."}, {"owner": {"reputation": 998, "user_id": 3874512, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2096d0d108e55ca0b691fb9161377ae1?s=128&d=identicon&r=PG&f=1", "display_name": "BowlingHawk95", "link": "https://stackoverflow.com/users/3874512/bowlinghawk95"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535087508, "post_id": 51996526, "comment_id": 90944810, "body": "@Shepmaster after reading the above answers, I see that <code>RefCell</code> might be able to help, but I have questions.  1) <code>RefCell</code> seems to allow multiple mutable references to one value in a map, but does that help with my needs to mutate multiple key-value pairs inside a borrow? 2) It seems that <code>RefCell</code> ought to be avoided (or at least minimized) for philosophical reasons, since it side-steps Rust&#39;s compile-time borrow checking.  If that&#39;s the case, then is there a good alternate approach to the algorithm above that gets away from this issue altogether?"}], "answers": [{"comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535110086, "post_id": 52000796, "comment_id": 90956090, "body": "<a href=\"https://github.com/bluss/petgraph/blob/master/src/dijkstra.rs#L21\" rel=\"nofollow noreferrer\">Possible solution</a>"}, {"owner": {"reputation": 998, "user_id": 3874512, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2096d0d108e55ca0b691fb9161377ae1?s=128&d=identicon&r=PG&f=1", "display_name": "BowlingHawk95", "link": "https://stackoverflow.com/users/3874512/bowlinghawk95"}, "edited": false, "score": 0, "creation_date": 1535123574, "post_id": 52000796, "comment_id": 90964795, "body": "Excellent, informative answer.  I hadn&#39;t thought about Rust shuffling or cloning the <code>HashMap</code> out from under me, which of course is obvious now that I think about it.  Your suggestion to clone the get result sounds straightforward and plausible, let me play with it and get back to you.  Thanks!"}, {"owner": {"reputation": 998, "user_id": 3874512, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2096d0d108e55ca0b691fb9161377ae1?s=128&d=identicon&r=PG&f=1", "display_name": "BowlingHawk95", "link": "https://stackoverflow.com/users/3874512/bowlinghawk95"}, "reply_to_user": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 0, "creation_date": 1535123631, "post_id": 52000796, "comment_id": 90964831, "body": "@Stargateur Thanks, perhaps I will look at someone else&#39;s implementation for comparison once I finish my own.  I am using this partially as a learning experience for Rust, so looking at another implementation without struggling through my own rather defeats the point."}], "tags": [], "owner": {"reputation": 249985, "user_id": 147192, "user_type": "registered", "accept_rate": 80, "profile_image": "https://i.stack.imgur.com/E78Vj.png?s=128&g=1", "display_name": "Matthieu M.", "link": "https://stackoverflow.com/users/147192/matthieu-m"}, "is_accepted": true, "score": 2, "last_activity_date": 1535100801, "creation_date": 1535100801, "answer_id": 52000796, "question_id": 51996526, "link": "https://stackoverflow.com/questions/51996526/are-there-any-constructs-i-can-use-to-enable-mutating-a-hashmap-within-a-call-to/52000796#52000796", "title": "Are there any constructs I can use to enable mutating a HashMap within a call to HashMap::get?", "body": "<p><strong>No.</strong></p>\n\n<blockquote>\n  <p>I am getting an error because I'm mutating a <code>HashMap</code> inside a match expression on a value obtained from <code>.get()</code>. I understand why this is a violation of the borrowing and mutation principles of Rust, but I haven't found a workaround.</p>\n</blockquote>\n\n<p>I am afraid you have not actually understood the borrowing principles.</p>\n\n<p>The key principle which underpins Rust's safety is: <strong>Mutation NAND Aliasing</strong>.</p>\n\n<p>This principle is then enforced <em>either at run-time or at compile-time</em>, with a strong preference for compile-time when feasible since it is free of run-time overhead.</p>\n\n<p>In your situation, you have:</p>\n\n<ol>\n<li>A reference inside <code>HashMap</code>, obtained from <code>HashMap::get()</code>.</li>\n<li>You attempt to modify said <code>HashMap</code> while holding onto the reference.</li>\n</ol>\n\n<p>Let's imagine, for a second, that some constructs allows this code to compile and run; what would happen? <strong>BOOM</strong>.</p>\n\n<p>When inserting an element in the <code>HashMap</code>, the <code>HashMap</code> may:</p>\n\n<ol>\n<li>Shuffle existing elements, since it is using Robin Hood hashing.</li>\n<li>Transfer all elements to another (larger) heap-allocated array.</li>\n</ol>\n\n<p>Therefore, <code>HashMap::insert</code> means that any existing reference to an element of the <code>HashMap</code> may become <strong>dangling</strong> and point to either another element, or random memory.</p>\n\n<p><strong>There is no safe way to insert into the <code>HashMap</code> while holding a reference to an element of the <code>HashMap</code>.</strong></p>\n\n<hr>\n\n<p>You need to find a solution which does not involve keeping a reference to the <code>HashMap</code>.</p>\n\n<p>My advice would be to simply <code>clone</code>: <code>match known_paths.get(current).clone()</code>. Once you have a first <em>working</em> implementation of the algorithm, you can look into possibly improving its performance, as necessity dictates.</p>\n"}], "owner": {"reputation": 998, "user_id": 3874512, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/2096d0d108e55ca0b691fb9161377ae1?s=128&d=identicon&r=PG&f=1", "display_name": "BowlingHawk95", "link": "https://stackoverflow.com/users/3874512/bowlinghawk95"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 91, "favorite_count": 0, "accepted_answer_id": 52000796, "answer_count": 1, "score": 1, "last_activity_date": 1535100801, "creation_date": 1535076385, "last_edit_date": 1535081876, "question_id": 51996526, "link": "https://stackoverflow.com/questions/51996526/are-there-any-constructs-i-can-use-to-enable-mutating-a-hashmap-within-a-call-to", "title": "Are there any constructs I can use to enable mutating a HashMap within a call to HashMap::get?", "body": "<p>I'm trying to implement Dijkstra's algorithm in Rust.  I am getting an error because I'm mutating a <code>HashMap</code> inside a <code>match</code> expression on a value obtained from <code>.get()</code>.  I understand why this is a violation of the borrowing and mutation principles of Rust, but I haven't found a workaround.</p>\n\n<p>I have tried using <code>.entry()</code> and <code>.and_modify()</code> to perform an in-place modification, but I also need to insert and/or modify other keys besides the one being matched on.</p>\n\n<p>Are there any constructs/functions I can use to safely enable this mutation within a <code>get</code>, or, failing that, is there another approach to this algorithm that steers clear of this issue?</p>\n\n<p>(Unfinished) Code Snippet:</p>\n\n<pre><code>use std::collections::{HashMap, HashSet};\n\nstruct Graph {\n    vertices: Vec&lt;i32&gt;,\n    edges: HashMap&lt;i32, HashMap&lt;i32, i32&gt;&gt;, // start -&gt; {end -&gt; weight}\n}\n\nfn dijkstra(start: i32, g: Graph) -&gt; HashMap&lt;i32, HashMap&lt;i32, (i32, Vec&lt;i32&gt;)&gt;&gt; {\n    let mut known_paths: HashMap&lt;i32, (i32, Vec&lt;i32&gt;)&gt; = HashMap::new(); // end -&gt; (total_weight, path)\n\n    known_paths.insert(start, (0, Vec::new()));\n\n    let mut current = &amp;start;\n    let mut unvisited: HashSet&lt;i32&gt; = g.edges.keys().cloned().collect();\n\n    while unvisited.len() &gt; 0 {\n        match known_paths.get(current) {\n            Some((current_dist, current_path)) =&gt; if let Some(ref incident_edges) =\n                g.edges.get(current)\n            {\n                for (neighbor, dist) in incident_edges.iter() {\n                    match known_paths.get(&amp;neighbor) {\n                        Some((old_distance, _old_path)) =&gt; if current_dist + dist &lt; *old_distance {\n                            let mut new_path = current_path.clone();\n                            new_path.push(*current);\n                            known_paths.insert(*neighbor, (current_dist + dist, new_path));\n                        },\n                        None =&gt; {\n                            let mut new_path = current_path.clone();\n                            new_path.push(*current);\n                            known_paths.insert(*neighbor, (current_dist + dist, new_path));\n                        }\n                    }\n                }\n            },\n            None =&gt; panic!(\"Something went wrong with current={}\", current),\n        }\n    }\n    HashMap::new()\n}\n</code></pre>\n\n<p>Error:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0502]: cannot borrow `known_paths` as mutable because it is also borrowed as immutable\n  --&gt; src/lib.rs:26:29\n   |\n17 |         match known_paths.get(current) {\n   |               ----------- immutable borrow occurs here\n...\n26 |                             known_paths.insert(*neighbor, (current_dist + dist, new_path));\n   |                             ^^^^^^^^^^^ mutable borrow occurs here\n...\n37 |         }\n   |         - immutable borrow ends here\n\nerror[E0502]: cannot borrow `known_paths` as mutable because it is also borrowed as immutable\n  --&gt; src/lib.rs:31:29\n   |\n17 |         match known_paths.get(current) {\n   |               ----------- immutable borrow occurs here\n...\n31 |                             known_paths.insert(*neighbor, (current_dist + dist, new_path));\n   |                             ^^^^^^^^^^^ mutable borrow occurs here\n...\n37 |         }\n   |         - immutable borrow ends here\n</code></pre>\n"}, {"tags": ["rust", "rust-cargo"], "owner": {"reputation": 4068, "user_id": 862193, "user_type": "registered", "accept_rate": 88, "profile_image": "https://www.gravatar.com/avatar/60a062a625895665d619c40b96f82d6a?s=128&d=identicon&r=PG", "display_name": "Tim", "link": "https://stackoverflow.com/users/862193/tim"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 143, "favorite_count": 1, "answer_count": 0, "score": 1, "last_activity_date": 1535136772, "creation_date": 1535076193, "last_edit_date": 1535136772, "question_id": 51996507, "link": "https://stackoverflow.com/questions/51996507/is-it-possible-to-disable-a-dependencys-feature-when-building-with-rls", "title": "Is it possible to disable a dependency&#39;s feature when building with RLS?", "body": "<p>I have the following dependency configuration in <code>Cargo.toml</code>.</p>\n\n<pre><code>[dependencies.ffmpeg-sys]\nversion = \"3.4.1\"\ndefault-features = false\nfeatures = [\"avcodec\", \"avformat\", \"swresample\", \"static\", \"build\"]\n</code></pre>\n\n<p>Adding the <code>build</code> feature hugely increases compile time and I only need to do it when building in release mode.</p>\n\n<p>Is there a way to disable features of a dependency based on the build type (debug, release, RLS)?</p>\n"}, {"tags": ["rust", "glsl", "shader", "glium"], "comments": [{"owner": {"reputation": 138010, "user_id": 5577765, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/LoGpC.jpg?s=128&g=1", "display_name": "Rabbid76", "link": "https://stackoverflow.com/users/5577765/rabbid76"}, "edited": false, "score": 0, "creation_date": 1535276022, "post_id": 51990153, "comment_id": 91000162, "body": "Your program works fine for me. But note, <code>gl_FragColor</code> is deprecated for <code>#version 330 core</code>. You have to declare a <a href=\"https://www.khronos.org/opengl/wiki/Fragment_Shader#Outputs\" rel=\"nofollow noreferrer\">Fragment shader output variable</a>: <code>out vec4 fragColor;</code>. And in <code>main</code>: <code>fragColor = vec4(0.0f, 0.5f, 0.0f, 1.0f);</code>"}], "owner": {"reputation": 773, "user_id": 9408711, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/a288a953384d55fc2242d676c4fb7c4f?s=128&d=identicon&r=PG&f=1", "display_name": "aitvann", "link": "https://stackoverflow.com/users/9408711/aitvann"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 491, "favorite_count": 1, "answer_count": 0, "score": 3, "last_activity_date": 1535230457, "creation_date": 1535040903, "last_edit_date": 1535058008, "question_id": 51990153, "link": "https://stackoverflow.com/questions/51990153/is-there-any-way-to-pass-an-array-to-a-shader-in-glium", "title": "Is there any way to pass an array to a shader in glium?", "body": "<p>I tried to do this with a uniform-block:</p>\n\n<p>Rust:</p>\n\n<pre><code>#[derive(Copy, Clone)]\nstruct Circle {\n    position: (f32, f32),\n    radius: u32,\n    _padding: u32,\n}\n\n#[derive(Copy, Clone)]\nstruct UniformBlock {\n    map: [Circle; 64],\n}\n\nimplement_uniform_block!(Circle, position, radius);\nimplement_uniform_block!(UniformBlock, map);\n\nlet buffer = UniformBuffer::new(\n    &amp;display,\n    UniformBlock::new([Circle::new((20., 20.), 8); 64]),\n).unwrap();\n\nuniform! {\n    MapBlock: &amp;buffer\n}\n</code></pre>\n\n<p>GLSL:</p>\n\n<pre class=\"lang-c prettyprint-override\"><code>struct Circle\n{\n    vec2 position;\n    uint radius;\n};\n\nlayout(std140) uniform MapBlock\n{\n    Circle map[64];\n};\n</code></pre>\n\n<p>but I received the following run-time error:</p>\n\n<blockquote>\n  <p>called Result::unwrap() on an Err value: UniformBlockLayoutMismatch { name: \"MapBlock\", err: MemberMismatch { member: \"map\", err: MemberMismatch { member: \"\", err: MemberMismatch { member: \"position\", err: OffsetMismatch { expected: 16, obtained: 0 } } } } }</p>\n</blockquote>\n\n<p>Each time the program was started, the shader expected a different size structure, like this:  expected: 160, expected: 32, expected: 48. Can this  be solved? Are there other ways to pass an array to the shader?</p>\n\n<p>I'm using:</p>\n\n<ul>\n<li>Rust 1.28.0 stable,</li>\n<li>glium  0.22.0,</li>\n<li>Nalgebra 0.16.0</li>\n</ul>\n\n<p>Full code Rust:</p>\n\n<pre><code>#[macro_use]\nextern crate glium;\nuse glium::{\n    glutin,\n    uniforms::{\n        UniformValue,\n        UniformBuffer,\n        AsUniformValue\n    },\n    vertex::{\n        Attribute,\n        AttributeType\n    }\n};\n\nextern crate nalgebra as na;\n\nuse std::{\n    fs::File,\n    fmt::Debug,\n    io::prelude::*\n};\n\n\n\n#[derive(Copy, Clone)]\nstruct Point2&lt;T: 'static + Copy + PartialEq + Debug&gt;(na::Point2&lt;T&gt;);\n\nimpl&lt;T: 'static + Copy + PartialEq + Debug&gt; Point2&lt;T&gt; {\n    fn new(x: T, y: T) -&gt; Self {\n        Point2(na::Point2::new(x, y))\n    }\n}\n\nunsafe impl Attribute for Point2&lt;f32&gt; {\n    #[inline]\n    fn get_type() -&gt; AttributeType {\n        AttributeType::F32F32\n    }\n}\n\nimpl AsUniformValue for Point2&lt;f32&gt; {\n    fn as_uniform_value(&amp;self) -&gt; UniformValue {\n        UniformValue::Vec2([self.0.x, self.0.y])\n    }\n}\n\n\n#[derive(Copy, Clone)]\nstruct Vertex {\n    position: Point2&lt;f32&gt;\n}\n\nimpl Vertex {\n    fn new(position: Point2&lt;f32&gt;) -&gt; Self {\n        Self { position }\n    }\n}\n\n\n#[derive(Copy, Clone)]\nstruct Circle {\n    position: (f32, f32),\n    radius: u32,\n    _padding: u32\n}\n\nimpl Circle {\n    fn new(position: (f32, f32), radius: u32) -&gt; Self {\n        Self { position, radius, _padding: 0 }\n    }\n}\n\n\n#[derive(Copy, Clone)]\nstruct UniformBlock {\n    map: [Circle; 64]\n}\n\nimpl UniformBlock {\n    fn new(map: [Circle; 64]) -&gt; Self {\n        Self { map }\n    }\n}\n\n\nimplement_vertex!(Vertex, position);\nimplement_uniform_block!(Circle, position, radius);\nimplement_uniform_block!(UniformBlock, map);\n\n\nfn main() {\n    let mut events_loop = glutin::EventsLoop::new();\n    let display = {\n        let window = glutin::WindowBuilder::new()\n            .with_title(\"Window\");\n        let context = glutin::ContextBuilder::new()\n            .with_vsync(true);\n        glium::Display::new(window, context, &amp;events_loop).unwrap()\n    };\n\n    let vertex_buffer = glium::VertexBuffer::new(&amp;display, &amp;[\n        Vertex::new(Point2::new(-1.0,  1.0)),\n        Vertex::new(Point2::new(-1.0, -1.0)),\n        Vertex::new(Point2::new( 1.0, -1.0)),\n        Vertex::new(Point2::new( 1.0,  1.0))\n    ]).unwrap();\n\n    let indices = glium::IndexBuffer::new(&amp;display, glium::index::PrimitiveType::TrianglesList, &amp;[\n        0, 1, 3,\n        1, 2, 3u8\n    ]).unwrap();\n\n    let program = {\n        let mut v_sh_src = String::new();\n        File::open(\"shaders/vertex.glsl\").unwrap()\n            .read_to_string(&amp;mut v_sh_src).unwrap();\n\n        let mut f_sh_src = String::new();\n        File::open(\"shaders/fragment.glsl\").unwrap()\n            .read_to_string(&amp;mut f_sh_src).unwrap();\n\n        glium::Program::from_source(&amp;display, v_sh_src.as_str(), f_sh_src.as_str(), None).unwrap()\n    };\n\n    let buffer = UniformBuffer::new(&amp;display, UniformBlock::new([Circle::new((200., 200.), 32); 64])).unwrap();\n\n    let mut done = false;\n    while !done {\n        use glium::Surface;\n\n        let mut target = display.draw();\n        target.clear_color(0.0, 0.0, 0.0, 1.0);\n        target.draw(&amp;vertex_buffer, &amp;indices, &amp;program, &amp;uniform! {\n            mapBlock: &amp;buffer\n        }, &amp;Default::default()).unwrap();\n        target.finish().unwrap();\n\n        events_loop.poll_events(|event| {\n            use glutin::{ Event, WindowEvent, ElementState, VirtualKeyCode };\n\n            match event {\n                Event::WindowEvent { event, window_id } =&gt;\n                    if window_id == display.gl_window().id() {\n                        match event {\n                            WindowEvent::CloseRequested =&gt; done = true,\n                            WindowEvent::KeyboardInput { input, .. } =&gt; {\n                                match input.state {\n                                    ElementState::Released =&gt; match input.virtual_keycode {\n                                        Some(VirtualKeyCode::Escape) =&gt; done = true,\n                                        _ =&gt; ()\n                                    }\n                                    _ =&gt; ()\n                                }\n                            }\n                            _ =&gt; ()\n                        }\n                    }\n                _ =&gt; ()\n            }\n        });\n    }\n}\n</code></pre>\n\n<p>Full code frafment.glsl:</p>\n\n<pre><code>#version 330 core\n\n\n\nstruct Circle\n{\n    vec2 position;\n    uint radius;\n};\n\nlayout(std140) uniform mapBlock\n{\n    Circle map[64];\n};\n\n\nvoid main()\n{\n    for (int i = 0; i &lt; 64; ++i)\n        if (distance(map[i].position, gl_FragCoord.xy) &lt;= map[i].radius)\n            gl_FragColor = vec4(0.0f, 0.5f, 0.0f, 1.0f);\n}\n</code></pre>\n\n<p>Full code vertex.glsl:</p>\n\n<pre><code>#version 330 core\n\nlayout (location = 0) in vec2 position;\n\n\n\nvoid main()\n{\n    gl_Position = vec4(position, 0.0f, 1.0f);\n}\n</code></pre>\n"}, {"tags": ["rust", "deserialization", "serde"], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535039662, "post_id": 51989727, "comment_id": 90929142, "body": "<a href=\"https://github.com/serde-rs/serde/issues/1325\" rel=\"nofollow noreferrer\">Serde issue 1325</a> seems to indicate this won&#39;t work in a recursive manner \u2014 am I misunderstanding?"}, {"owner": {"reputation": 6357, "user_id": 6086311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb99289473f6393b89474785f2d294d1?s=128&d=identicon&r=PG", "display_name": "dtolnay", "link": "https://stackoverflow.com/users/6086311/dtolnay"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 1, "creation_date": 1535040802, "post_id": 51989727, "comment_id": 90929824, "body": "You would need a DeserializeSeed impl along every level of the hierarchy of nested structs to propagate that <code>Allocator</code> to everywhere that needs it (this is where a procedural macro could be helpful), or find some way to stick the <code>Allocator</code> in a thread_local to make it available to the deserialize impls that way."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535040896, "post_id": 51989727, "comment_id": 90929876, "body": "<i>stick the <code>Allocator</code> in a thread_local</i> \u2014 I was thinking along those lines, but it feels like the lifetimes of the returned strings wouldn&#39;t naturally work and you&#39;d need to resort to unsafe. I haven&#39;t tried though."}], "tags": [], "owner": {"reputation": 6357, "user_id": 6086311, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/cb99289473f6393b89474785f2d294d1?s=128&d=identicon&r=PG", "display_name": "dtolnay", "link": "https://stackoverflow.com/users/6086311/dtolnay"}, "is_accepted": false, "score": 3, "last_activity_date": 1535039434, "creation_date": 1535039434, "answer_id": 51989727, "question_id": 51988630, "link": "https://stackoverflow.com/questions/51988630/how-can-i-get-serde-to-allocate-strings-from-an-arena-during-deserialization/51989727#51989727", "title": "How can I get Serde to allocate strings from an arena during deserialization?", "body": "<p>Here is one possible implementation that uses <a href=\"https://docs.serde.rs/serde/de/trait.DeserializeSeed.html\" rel=\"nofollow noreferrer\"><code>serde::de::DeserializeSeed</code></a> to expose the arena allocator to the deserialization code.</p>\n\n<p>In a more elaborate use case you may want to write a procedural macro to generate such impls.</p>\n\n<hr>\n\n<pre><code>#[macro_use]\nextern crate serde_derive;\n\nextern crate copy_arena;\nextern crate serde;\nextern crate serde_json;\n\nuse std::fmt;\nuse std::marker::PhantomData;\nuse std::str;\n\nuse serde::de::{self, DeserializeSeed, Deserializer, MapAccess, Visitor};\n\nuse copy_arena::{Allocator, Arena};\n\n#[derive(Debug)]\nstruct Jason&lt;'a&gt; {\n    one: &amp;'a str,\n    two: &amp;'a str,\n}\n\nstruct ArenaSeed&lt;'a, T&gt; {\n    allocator: Allocator&lt;'a&gt;,\n    marker: PhantomData&lt;fn() -&gt; T&gt;,\n}\n\nimpl&lt;'a, T&gt; ArenaSeed&lt;'a, T&gt; {\n    fn new(arena: &amp;'a mut Arena) -&gt; Self {\n        ArenaSeed {\n            allocator: arena.allocator(),\n            marker: PhantomData,\n        }\n    }\n\n    fn alloc_string(&amp;mut self, owned: String) -&gt; &amp;'a str {\n        let slice = self.allocator.alloc_slice(owned.as_bytes());\n        // We know the bytes are valid UTF-8.\n        str::from_utf8(slice).unwrap()\n    }\n}\n\nimpl&lt;'de, 'a&gt; DeserializeSeed&lt;'de&gt; for ArenaSeed&lt;'a, Jason&lt;'a&gt;&gt; {\n    type Value = Jason&lt;'a&gt;;\n\n    fn deserialize&lt;D&gt;(self, deserializer: D) -&gt; Result&lt;Self::Value, D::Error&gt;\n    where\n        D: Deserializer&lt;'de&gt;,\n    {\n        static FIELDS: &amp;[&amp;str] = &amp;[\"one\", \"two\"];\n        deserializer.deserialize_struct(\"Jason\", FIELDS, self)\n    }\n}\n\nimpl&lt;'de, 'a&gt; Visitor&lt;'de&gt; for ArenaSeed&lt;'a, Jason&lt;'a&gt;&gt; {\n    type Value = Jason&lt;'a&gt;;\n\n    fn expecting(&amp;self, formatter: &amp;mut fmt::Formatter) -&gt; fmt::Result {\n        formatter.write_str(\"struct Jason\")\n    }\n\n    fn visit_map&lt;A&gt;(mut self, mut map: A) -&gt; Result&lt;Self::Value, A::Error&gt;\n    where\n        A: MapAccess&lt;'de&gt;,\n    {\n        #[derive(Deserialize)]\n        #[serde(field_identifier, rename_all = \"lowercase\")]\n        enum Field { One, Two }\n\n        let mut one = None;\n        let mut two = None;\n        while let Some(key) = map.next_key()? {\n            match key {\n                Field::One =&gt; {\n                    if one.is_some() {\n                        return Err(de::Error::duplicate_field(\"one\"));\n                    }\n                    one = Some(self.alloc_string(map.next_value()?));\n                }\n                Field::Two =&gt; {\n                    if two.is_some() {\n                        return Err(de::Error::duplicate_field(\"two\"));\n                    }\n                    two = Some(self.alloc_string(map.next_value()?));\n                }\n            }\n        }\n        let one = one.ok_or_else(|| de::Error::missing_field(\"one\"))?;\n        let two = two.ok_or_else(|| de::Error::missing_field(\"two\"))?;\n        Ok(Jason { one, two })\n    }\n}\n\nfn main() {\n    let j = r#\" {\"one\": \"I\", \"two\": \"II\"} \"#;\n\n    let mut arena = Arena::new();\n    let seed = ArenaSeed::new(&amp;mut arena);\n    let mut de = serde_json::Deserializer::from_str(j);\n    let jason: Jason = seed.deserialize(&amp;mut de).unwrap();\n    println!(\"{:?}\", jason);\n}\n</code></pre>\n\n<hr>\n\n<p>If arena allocation is not a strict requirement and you just need to amortize the cost of string allocation across lots of deserialized objects, <code>Deserialize::deserialize_in_place</code> is a more concise alternative.</p>\n\n<pre><code>// [dependencies]\n// serde = \"1.0\"\n// serde_derive = { version = \"1.0\", features = [\"deserialize_in_place\"] }\n// serde_json = \"1.0\"\n\n#[macro_use]\nextern crate serde_derive;\n\nextern crate serde;\nextern crate serde_json;\n\nuse serde::Deserialize;\n\n#[derive(Deserialize, Debug)]\nstruct Jason {\n    one: String,\n    two: String,\n}\n\nfn main() {\n    let j = r#\" {\"one\": \"I\", \"two\": \"II\"} \"#;\n\n    // Allocate some Strings during deserialization.\n    let mut de = serde_json::Deserializer::from_str(j);\n    let mut jason = Jason::deserialize(&amp;mut de).unwrap();\n    println!(\"{:?} {:p} {:p}\", jason, jason.one.as_str(), jason.two.as_str());\n\n    // Reuse the same String allocations for some new data.\n    // As long as the strings in the new datum are at most as long as the\n    // previous datum, the strings do not need to be reallocated and will\n    // remain at the same memory address.\n    let mut de = serde_json::Deserializer::from_str(j);\n    Jason::deserialize_in_place(&amp;mut de, &amp;mut jason).unwrap();\n    println!(\"{:?} {:p} {:p}\", jason, jason.one.as_str(), jason.two.as_str());\n\n    // Do not reuse the string allocations.\n    // The strings here will not be at the same address as above.\n    let mut de = serde_json::Deserializer::from_str(j);\n    let jason = Jason::deserialize(&amp;mut de).unwrap();\n    println!(\"{:?} {:p} {:p}\", jason, jason.one.as_str(), jason.two.as_str());\n}\n</code></pre>\n"}], "owner": {"reputation": 36975, "user_id": 94977, "user_type": "registered", "accept_rate": 69, "profile_image": "https://www.gravatar.com/avatar/8341c5bff3dcbd8ed34d9d68bd4169f2?s=128&d=identicon&r=PG", "display_name": "Jason Orendorff", "link": "https://stackoverflow.com/users/94977/jason-orendorff"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 647, "favorite_count": 2, "answer_count": 1, "score": 4, "last_activity_date": 1540836569, "creation_date": 1535035984, "last_edit_date": 1540836569, "question_id": 51988630, "link": "https://stackoverflow.com/questions/51988630/how-can-i-get-serde-to-allocate-strings-from-an-arena-during-deserialization", "title": "How can I get Serde to allocate strings from an arena during deserialization?", "body": "<p>I have a struct with string fields. I'd like to control how the memory for the strings is allocated. In particular, I'd like to allocate them using something like <a href=\"https://docs.rs/copy_arena/0.1.1/copy_arena/\" rel=\"nofollow noreferrer\"><code>copy_arena</code></a>.</p>\n\n<p>Maybe I could make a custom <code>ArenaString</code> type, but I don't see how to get a reference to the <code>Arena</code> into the deserialization code, and assuming that's possible, then I'll have to deal with the arena lifetime, right?</p>\n"}, {"tags": ["rust", "rust-tokio"], "comments": [{"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535032724, "post_id": 51987105, "comment_id": 90924621, "body": "Why not using the <code>?</code>-operator?"}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535035786, "post_id": 51987105, "comment_id": 90926684, "body": "You mean, use something like <code>hyper::rt::run(...)?;</code>... But it  <a href=\"https://docs.rs/hyper/0.12.8/hyper/rt/fn.run.html\" rel=\"nofollow noreferrer\">doesn&#39;t return an error</a>, does it?"}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 1, "creation_date": 1535035874, "post_id": 51987105, "comment_id": 90926741, "body": "You mean perhaps I can use the <code>?</code> operator inside the closure like <code>server.map_err(|e| e?)</code> or something like that? How can it work, it&#39;s inside a closure?"}], "answers": [{"comments": [{"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535111215, "post_id": 51998756, "comment_id": 90956766, "body": "How does this terminate the server?"}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "edited": false, "score": 0, "creation_date": 1535113380, "post_id": 51998756, "comment_id": 90958058, "body": "Originally, I didn&#39;t ask on how to terminate the server (the question was rephrased). But I wouldn&#39;t mind knowing how I could have the server terminated on some events (a signal, SIGTERM, for instance). But to answer that we would need to know how do we know we want to terminate the server."}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "edited": false, "score": 1, "creation_date": 1535114223, "post_id": 51998756, "comment_id": 90958667, "body": "This doesn&#39;t work, the compiler highlights the closure telling <b>closure may outlive the current function, but it borrows <code>result</code>, which is owned by the current function</b>."}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "edited": false, "score": 0, "creation_date": 1535114296, "post_id": 51998756, "comment_id": 90958734, "body": "It suggests to add <b>move</b> as in <code>server.map_err(move |e| { result = ... })</code> but then the <code>result</code> is no longer available to return the error to the caller."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "reply_to_user": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "edited": false, "score": 0, "creation_date": 1535114752, "post_id": 51998756, "comment_id": 90959055, "body": "@Mildred I rephrased the question (you can see the <a href=\"https://stackoverflow.com/posts/51987105/revisions\">edit history</a>). Exiting the server is <i>required</i> because otherwise the program execution will never continue past the call to <code>run</code>, rendering the &quot;return value&quot; impossible."}, {"owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "edited": false, "score": 0, "creation_date": 1535126861, "post_id": 51998756, "comment_id": 90966710, "body": "Ok, I was supposing that the first error would by itself terminate the server, but if not, it needs to."}, {"owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535351434, "post_id": 51998756, "comment_id": 91017334, "body": "@Shepmaster when I answered the question, it said nothing about stopping the server."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535371174, "post_id": 51998756, "comment_id": 91027918, "body": "@Jmb I understand, but if the server never stops, your line of just <code>result</code> will never be executed. Without stopping the server, nothing else matters. It also appears that the OP states your answer doesn&#39;t even compile."}], "tags": [], "owner": {"reputation": 8877, "user_id": 5397009, "user_type": "registered", "accept_rate": 89, "profile_image": "https://www.gravatar.com/avatar/7405bb106a62e8a3ea2d6d787b7261ee?s=128&d=identicon&r=PG&f=1", "display_name": "Jmb", "link": "https://stackoverflow.com/users/5397009/jmb"}, "is_accepted": false, "score": -1, "last_activity_date": 1535092541, "creation_date": 1535092541, "answer_id": 51998756, "question_id": 51987105, "link": "https://stackoverflow.com/questions/51987105/how-can-i-stop-the-hyper-http-web-server-and-return-an-error/51998756#51998756", "title": "How can I stop the hyper HTTP web server and return an error?", "body": "<p>Maybe you can store the error into a local variable and return that:</p>\n\n<pre><code>let mut result = Result::Ok(());\nhyper::rt::run(server.map_err(|e| { result = Result::Error (e); });\nresult\n</code></pre>\n"}, {"comments": [{"owner": {"reputation": 381, "user_id": 4941465, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9004e3a66327fd5a198e303f229183b5?s=128&d=identicon&r=PG&f=1", "display_name": "Blake H", "link": "https://stackoverflow.com/users/4941465/blake-h"}, "edited": false, "score": 0, "creation_date": 1543340486, "post_id": 52104558, "comment_id": 93880001, "body": "<code>block_on</code> is a blocking call. How do I move <code>server</code> into <code>rt.spawn</code>?"}, {"owner": {"reputation": 381, "user_id": 4941465, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/9004e3a66327fd5a198e303f229183b5?s=128&d=identicon&r=PG&f=1", "display_name": "Blake H", "link": "https://stackoverflow.com/users/4941465/blake-h"}, "edited": false, "score": 0, "creation_date": 1543340950, "post_id": 52104558, "comment_id": 93880248, "body": "The answer above is almost correct. <code>server</code> is <code>impl Future</code>, so you need to <code>use tokio::prelude::Future;</code> and replace the <code>block_on</code> with <code>rt.spawn(server.map_err(|_| ())</code>. You&#39;ll probably then want to use something like std::sync::mpsc::channel to provide a poison api instead of immediately shutting down"}], "tags": [], "owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "is_accepted": true, "score": 1, "last_activity_date": 1535659356, "creation_date": 1535659356, "answer_id": 52104558, "question_id": 51987105, "link": "https://stackoverflow.com/questions/51987105/how-can-i-stop-the-hyper-http-web-server-and-return-an-error/52104558#52104558", "title": "How can I stop the hyper HTTP web server and return an error?", "body": "<p>I believe I found a solution using the tokio runtime directly... It compiles. Please anyone tell me if I'm wrong here.</p>\n\n<p>The idea is to use the tokio <a href=\"https://docs.rs/tokio/0.1.8/tokio/runtime/struct.Runtime.html\" rel=\"nofollow noreferrer\">Runtime</a> directly (docs have many examples):</p>\n\n<pre><code>use tokio::runtime::Runtime;\n\n// Executes a web server. Returns a result object with an error object\n// if the server stopped unexpectedly\nfn run_and_stop_web_server(addr: std::net::SocketAddr) -&gt; Result&lt;(), Error&gt; {\n    let server_builder = Server::try_bind(&amp;addr)?;\n    let server = server_builder.serve(move || {\n        let handler: Handler = Handler::new();\n        hyper::service::service_fn(move |req| handler.serve(req))\n    });\n\n    let mut rt = Runtime::new()?;\n    rt.block_on(server)?;\n    rt.shutdown_now();\n\n    Result::Ok(())\n}\n</code></pre>\n"}], "owner": {"reputation": 373, "user_id": 6020072, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/7acfb926231c1c4e62746da7a21c5917?s=128&d=identicon&r=PG&f=1", "display_name": "Mildred", "link": "https://stackoverflow.com/users/6020072/mildred"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 714, "favorite_count": 1, "accepted_answer_id": 52104558, "answer_count": 2, "score": 1, "last_activity_date": 1535659356, "creation_date": 1535031339, "last_edit_date": 1535036366, "question_id": 51987105, "link": "https://stackoverflow.com/questions/51987105/how-can-i-stop-the-hyper-http-web-server-and-return-an-error", "title": "How can I stop the hyper HTTP web server and return an error?", "body": "<p>The <a href=\"https://docs.rs/hyper/0.12.8/hyper/\" rel=\"nofollow noreferrer\">docs for the hyper crate</a> have a simple example to start a web server:</p>\n\n<pre><code>extern crate hyper;\n\nuse hyper::service::service_fn_ok;\nuse hyper::{Body, Response, Server};\n\nfn main() {\n    // Construct our SocketAddr to listen on...\n    let addr = ([127, 0, 0, 1], 3000).into();\n\n    // And a NewService to handle each connection...\n    let new_service = || service_fn_ok(|_req| Response::new(Body::from(\"Hello World\")));\n\n    // Then bind and serve...\n    let server = Server::bind(&amp;addr).serve(new_service);\n\n    // Finally, spawn `server` onto an Executor...\n    hyper::rt::run(server.map_err(|e| {\n        eprintln!(\"server error: {}\", e);\n    }));\n}\n</code></pre>\n\n<p>I want to embed this web server in a procedure that returns an error:</p>\n\n<pre><code>// Executes a web server. Returns a result object with an error object\n// if the server stopped unexpectedly\nfn run_and_stop_web_server(addr: std::net::SocketAddr) -&gt; Result&lt;(), Error&gt; {\n    let server_builder = Server::try_bind(&amp;addr)?;\n    let server = server_builder.serve(move || {\n        let handler: Handler = Handler::new();\n        hyper::service::service_fn(move |req| handler.serve(req))\n    });\n\n    // Run the server\n    // HERE: I don't know how to handle the error so I can return it from\n    //       the run_and_stop_web_server() function\n    hyper::rt::run(server.map_err(|e| eprintln!(\"Ignored Server error: {}\", e)));\n    Result::Ok(())\n}\n</code></pre>\n\n<p>I don't know how I can handle the error. Instead of using <code>eprintln!()</code> I want to return the error from the <code>run_and_stop_web_server</code> function.</p>\n"}, {"tags": ["rust"], "comments": [{"owner": {"reputation": 20746, "user_id": 1233251, "user_type": "registered", "accept_rate": 90, "profile_image": "https://i.stack.imgur.com/cI9GF.png?s=128&g=1", "display_name": "E_net4 says don&#39;t copy that", "link": "https://stackoverflow.com/users/1233251/e-net4-says-dont-copy-that"}, "edited": false, "score": 0, "creation_date": 1535031071, "post_id": 51986710, "comment_id": 90923448, "body": "Some of your code is not very idiomatic: prefer direct iteration over collections instead of index ranges (<code>for point in &amp;mut map { }</code>)."}], "answers": [{"comments": [{"owner": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "edited": false, "score": 0, "creation_date": 1535031331, "post_id": 51986897, "comment_id": 90923657, "body": "thanks a lot. that&#39;s what I was looking for."}, {"owner": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "edited": false, "score": 0, "creation_date": 1535031390, "post_id": 51986897, "comment_id": 90923706, "body": "Is there also a workaround for non-nightly versions? Could I recast the pointer in usafe mode ?"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "edited": false, "score": 0, "creation_date": 1535032220, "post_id": 51986897, "comment_id": 90924279, "body": "Arrays of non <code>Copy</code> types in Rust are not very flexible. Maybe you can do something like <code>let mut v : Vec&lt;_&gt; = (Box::new(map) as Box&lt;[_]&gt;).into(); let b = v.pop().unwrap(); let a = v.pop().unwrap();</code>. But if you are into that, then you could use a <code>Vec</code> instead of an array in the first place!"}, {"owner": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "edited": false, "score": 0, "creation_date": 1535032505, "post_id": 51986897, "comment_id": 90924451, "body": "thanks a ton!  yeah, I might go for a Vec and pop(). This means the data is stored on the heap. Are there any performance implications due to this?"}, {"owner": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535032623, "post_id": 51986897, "comment_id": 90924536, "body": "For a stable version, you may look at <a href=\"https://doc.rust-lang.org/std/primitive.slice.html#method.split_at\" rel=\"nofollow noreferrer\">split_at</a>"}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 9345, "user_id": 1021920, "user_type": "registered", "accept_rate": 70, "profile_image": "https://i.stack.imgur.com/VukgG.jpg?s=128&g=1", "display_name": "hellow", "link": "https://stackoverflow.com/users/1021920/hellow"}, "edited": false, "score": 0, "creation_date": 1535032847, "post_id": 51986897, "comment_id": 90924720, "body": "@hellow: But <code>split_at</code> applies to slices, not to arrays, that is, they return borrowed references. The OP asks for a way to move values out of the array."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "edited": false, "score": 0, "creation_date": 1535033149, "post_id": 51986897, "comment_id": 90924908, "body": "@Stefan: Sure, there are performance issues. It depends on the length of the array, the size of the stored objects, the usage patterns... if you really care about that you should profile your program. Beware of premature optimizations!"}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535033223, "post_id": 51986897, "comment_id": 90924943, "body": "I suggest moving your good answer to the linked duplicate."}, {"owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "reply_to_user": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 0, "creation_date": 1535034578, "post_id": 51986897, "comment_id": 90925873, "body": "@Shepmaster: Done, thanks for the tip. I copied both the <i>fixed length slice pattern</i> and the <i>boxing array</i> solutions."}], "tags": [], "owner": {"reputation": 79096, "user_id": 865874, "user_type": "registered", "accept_rate": 100, "profile_image": "https://i.stack.imgur.com/ACMnN.png?s=128&g=1", "display_name": "rodrigo", "link": "https://stackoverflow.com/users/865874/rodrigo"}, "is_accepted": false, "score": 1, "last_activity_date": 1535033139, "last_edit_date": 1535033139, "creation_date": 1535030797, "answer_id": 51986897, "question_id": 51986710, "link": "https://stackoverflow.com/questions/51986710/is-there-a-way-to-move-multiple-non-copy-elements-out-of-an-array/51986897#51986897", "title": "Is there a way to move multiple non-Copy elements out of an array?", "body": "<p>You can get it to work if you use nightly Rust with the <em>non-lexical lifetimes</em> feature and a fixed-length slice pattern:</p>\n\n<pre><code>#![feature(nll)]\n\nenum Direction {\n    North,\n    East,\n    South,\n    West,\n}\n\nstruct RoadPoint {\n    direction: Direction,\n    index: i32,\n}\n\nfn printme(a: RoadPoint, b: RoadPoint) {\n    println!(\"First: {}\", a.index);\n    println!(\"Second: {}\", b.index);\n}\n\nfn main() {\n    let map: [RoadPoint; 2] = [\n        RoadPoint {\n            direction: Direction::North,\n            index: 0,\n        },\n        RoadPoint {\n            direction: Direction::North,\n            index: 0,\n        },\n    ];\n\n    let [a, b] = map;\n    printme(a, b);\n}\n</code></pre>\n\n<p>Without <code>#![feature(nll)]</code> it fails with:</p>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0382]: use of moved value: `map[..]`\n  --&gt; src/main.rs:30:13\n   |\n30 |     let [a, b] = map;\n   |          -  ^ value used here after move\n   |          |\n   |          value moved here\n   |\n   = note: move occurs because `map[..]` has type `RoadPoint`, which does not implement the `Copy` trait\n</code></pre>\n"}], "owner": {"reputation": 131, "user_id": 10264931, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/1bc7092fbf585b36ccdde72610cbeea6?s=128&d=identicon&r=PG&f=1", "display_name": "Stefan", "link": "https://stackoverflow.com/users/10264931/stefan"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 377, "favorite_count": 1, "closed_date": 1535033208, "answer_count": 1, "score": 3, "last_activity_date": 1535033139, "creation_date": 1535030202, "last_edit_date": 1535032981, "question_id": 51986710, "link": "https://stackoverflow.com/questions/51986710/is-there-a-way-to-move-multiple-non-copy-elements-out-of-an-array", "closed_reason": "Duplicate", "title": "Is there a way to move multiple non-Copy elements out of an array?", "body": "<p>Is there any way to deconstruct the array like <code>[a, b] = map</code> so the two array elements are moved into <code>a</code> and <code>b</code>, so that later <code>a</code> and <code>b</code> can be moved into another function (like <code>printme</code> in this case).</p>\n\n<pre><code>enum Direction {\n    North,\n    East,\n    South,\n    West,\n}\n\nstruct RoadPoint {\n    direction: Direction,\n    index: i32,\n}\n\nfn printme(a: RoadPoint, b: RoadPoint) {\n    println!(\"First: {}\", a.index);\n}\n\nfn main() {\n    let mut map: [RoadPoint; 2] = [\n        RoadPoint {\n            direction: Direction::North,\n            index: 0,\n        },\n        RoadPoint {\n            direction: Direction::North,\n            index: 0,\n        },\n    ];\n\n    for i in 1..3 {\n        map[i].index = 10;\n    }\n\n    //move out\n    printme(map[0], map[1])\n}\n</code></pre>\n\n<pre class=\"lang-none prettyprint-override\"><code>error[E0508]: cannot move out of type `[RoadPoint; 2]`, a non-copy array\n  --&gt; src/main.rs:34:13\n   |\n34 |     printme(map[0], map[1])\n   |             ^^^^^^ cannot move out of here\n\nerror[E0508]: cannot move out of type `[RoadPoint; 2]`, a non-copy array\n  --&gt; src/main.rs:34:21\n   |\n34 |     printme(map[0], map[1])\n   |                     ^^^^^^ cannot move out of here\n</code></pre>\n\n<p>I'm aware of the fact I could implement the <code>Copy</code> trait, but I actually don't need copy of data in this case. Hence I'm looking for a cleaner solution.</p>\n"}, {"tags": ["string", "unicode", "rust", "slice"], "comments": [{"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 2, "creation_date": 1535019028, "post_id": 51982999, "comment_id": 90916092, "body": "I think <code>chars()</code> is the way to go here: <code>text.chars().take(end).skip(start)</code>"}, {"owner": {"reputation": 884, "user_id": 7541374, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4dd9cd55e47852725f6b6fd36fb9bc34?s=128&d=identicon&r=PG&f=1", "display_name": "Sasha Tsukanov", "link": "https://stackoverflow.com/users/7541374/sasha-tsukanov"}, "reply_to_user": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "edited": false, "score": 1, "creation_date": 1535019428, "post_id": 51982999, "comment_id": 90916302, "body": "@TimDiekmann how do I convert the <code>Take&lt;Chars&gt;</code> to <code>&amp;str</code> then if the API needs it?"}, {"owner": {"reputation": 939, "user_id": 2870802, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-lHzULJklIJg/AAAAAAAAAAI/AAAAAAAABwk/_pJZF95FiAY/photo.jpg?sz=128", "display_name": "ozkriff", "link": "https://stackoverflow.com/users/2870802/ozkriff"}, "edited": false, "score": 0, "creation_date": 1535019483, "post_id": 51982999, "comment_id": 90916338, "body": "You should call <code>collect()</code>. See this question <a href=\"https://stackoverflow.com/questions/37157926/is-there-a-method-like-javascripts-substr-in-rust\" title=\"is there a method like javascripts substr in rust\">stackoverflow.com/questions/37157926/&hellip;</a>"}, {"owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "reply_to_user": {"reputation": 939, "user_id": 2870802, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-lHzULJklIJg/AAAAAAAAAAI/AAAAAAAABwk/_pJZF95FiAY/photo.jpg?sz=128", "display_name": "ozkriff", "link": "https://stackoverflow.com/users/2870802/ozkriff"}, "edited": false, "score": 2, "creation_date": 1535020294, "post_id": 51982999, "comment_id": 90916803, "body": "@ozkriff <code>collect()</code> will result in <code>String</code>, not in <code>&amp;str</code>. This is why I didn&#39;t marked this as duplicate to your linked question."}], "answers": [{"comments": [{"owner": {"reputation": 884, "user_id": 7541374, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4dd9cd55e47852725f6b6fd36fb9bc34?s=128&d=identicon&r=PG&f=1", "display_name": "Sasha Tsukanov", "link": "https://stackoverflow.com/users/7541374/sasha-tsukanov"}, "edited": false, "score": 0, "creation_date": 1535032696, "post_id": 51983601, "comment_id": 90924604, "body": "To make <code>let end = text.char_indices().map(|(i, _)| i).nth(8).unwrap();</code> work when we want to slice till the last codepoint in the string (say, with index 11) by using, say, 12 as excluded bound we need more work. One can add something like <code>let end = if end_codepoint_idx == text.chars().count() {text.len()} else { text.char_indices().map(|(i, _)| i).nth(end_codepoint_idx).unwrap();};</code>"}, {"owner": {"reputation": 478030, "user_id": 279627, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/2dceea858ad8f1577bec6ddaa0485d15?s=128&d=identicon&r=PG", "display_name": "Sven Marnach", "link": "https://stackoverflow.com/users/279627/sven-marnach"}, "edited": false, "score": 3, "creation_date": 1545225218, "post_id": 51983601, "comment_id": 94551324, "body": "The unicode-segmentation crate does not help with the <code>&quot;\ufb01re&quot;</code> example \u2013 it won&#39;t split up the ligature into two characters. (I&#39;m not saying it <i>should</i> \u2013 just clarifying, since this answer may give a different impression.)"}], "tags": [], "owner": {"reputation": 53952, "user_id": 2408867, "user_type": "registered", "accept_rate": 86, "profile_image": "https://i.stack.imgur.com/994y9.jpg?s=128&g=1", "display_name": "Lukas Kalbertodt", "link": "https://stackoverflow.com/users/2408867/lukas-kalbertodt"}, "is_accepted": true, "score": 30, "last_activity_date": 1581244260, "last_edit_date": 1581244260, "creation_date": 1535019828, "answer_id": 51983601, "question_id": 51982999, "link": "https://stackoverflow.com/questions/51982999/slice-a-string-containing-unicode-chars/51983601#51983601", "title": "Slice a string containing Unicode chars", "body": "<h2>Possible solutions to codepoint slicing</h2>\n\n<blockquote>\n  <p>I know I can use the <code>chars()</code> iterator and manually walk through the desired substring, but is there a more concise way?</p>\n</blockquote>\n\n<p>If you know the exact byte indices, you can slice a string:</p>\n\n<pre><code>let text = \"Hello \u043f\u0440\u0438\u0432\u0435\u0442\";\nprintln!(\"{}\", &amp;text[2..10]);\n</code></pre>\n\n<p>This prints \"llo \u043f\u0440\". So the problem is to find out the exact byte position. You can do that fairly easily with the <code>char_indices()</code> iterator (alternatively you could use <code>chars()</code> with <code>char::len_utf8()</code>):</p>\n\n<pre><code>let text = \"Hello \u043f\u0440\u0438\u0432\u0435\u0442\";\nlet end = text.char_indices().map(|(i, _)| i).nth(8).unwrap();\nprintln!(\"{}\", &amp;text[2..end]);\n</code></pre>\n\n<p>As another alternative, you can first collect the string into <code>Vec&lt;char&gt;</code>. Then, indexing is simple, but to print it as a string, you have to collect it again or write your own function to do it.</p>\n\n<pre><code>let text = \"Hello \u043f\u0440\u0438\u0432\u0435\u0442\";\nlet text_vec = text.chars().collect::&lt;Vec&lt;_&gt;&gt;();\nprintln!(\"{}\", text_vec[2..8].iter().cloned().collect::&lt;String&gt;());\n</code></pre>\n\n<h2>Why is this not easier?</h2>\n\n<p>As you can see, neither of these solutions is all that great. This is intentional, for two reasons:</p>\n\n<p>As <code>str</code> is a simply UTF8 buffer, indexing by unicode codepoints is an O(n) operation. Usually, people expect the <code>[]</code> operator to be a O(1) operation. Rust makes this runtime complexity explicit and doesn't try to hide it. In both solutions above you can clearly see that it's not O(1).</p>\n\n<p>But the more important reason:</p>\n\n<h2>Unicode codepoints are generally not a useful unit</h2>\n\n<p>What Python does (and what you think you want) is not all that useful. It all comes down to the complexity of language and thus the complexity of unicode. Python slices Unicode <em>codepoints</em>. This is what a Rust <code>char</code> represents. It's 32 bit big (a few fewer bits would suffice, but we round up to a power of 2).</p>\n\n<p>But what you actually want to do is slice <em>user perceived characters</em>. But this is an explicitly loosely defined term. Different cultures and languages regard different things as \"one character\". The closest approximation is a \"grapheme cluster\". Such a cluster can consist of one or more unicode codepoints. Consider this Python 3 code:</p>\n\n<pre><code>&gt;&gt;&gt; s = \"Ju\u0308rgen\"\n&gt;&gt;&gt; s[0:2]\n'Ju'\n</code></pre>\n\n<p>Surprising, right? This is because the string above is: </p>\n\n<ul>\n<li><code>0x004A</code> LATIN CAPITAL LETTER J</li>\n<li><code>0x0075</code> LATIN SMALL LETTER U</li>\n<li><code>0x0308</code> COMBINING DIAERESIS</li>\n<li>...</li>\n</ul>\n\n<p>This is an example of a combining character that is rendered as part of the previous character. Python slicing does the \"wrong\" thing here.</p>\n\n<p>Another example:</p>\n\n<pre><code>&gt;&gt;&gt; s = \"\ufb01re\"\n&gt;&gt;&gt; s[0:2]\n'\ufb01r'\n</code></pre>\n\n<p>Also not what you'd expect. This time, <code>fi</code> is actually the ligature <code>\ufb01</code>, which is one codepoint.</p>\n\n<p>There are far more examples where Unicode behaves in a surprising way. See the links at the bottom for more information and examples.</p>\n\n<p>So if you want to work with international strings that should be able to work everywhere, don't do codepoint slicing! If you really need to semantically view the string as a series of <em>characters</em>, use grapheme clusters. To do that, the crate <a href=\"https://crates.io/crates/unicode-segmentation\" rel=\"noreferrer\"><code>unicode-segmentation</code></a> is very useful.</p>\n\n<hr>\n\n<p>Further resources on this topic:</p>\n\n<ul>\n<li><a href=\"https://manishearth.github.io/blog/2017/01/14/stop-ascribing-meaning-to-unicode-code-points/\" rel=\"noreferrer\">Blogpost \"Let's stop ascribing meaning to unicode codepoints\"</a></li>\n<li><a href=\"https://manishearth.github.io/blog/2017/01/15/breaking-our-latin-1-assumptions/\" rel=\"noreferrer\">Blogpost \"Breaking our Latin-1 assumptions</a></li>\n<li><a href=\"http://utf8everywhere.org/\" rel=\"noreferrer\">http://utf8everywhere.org/</a></li>\n</ul>\n"}, {"comments": [{"owner": {"reputation": 6962, "user_id": 3271687, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/25c0a4cbbfdcc44075d2f8631ad353b9?s=128&d=identicon&r=PG&f=1", "display_name": "yolenoyer", "link": "https://stackoverflow.com/users/3271687/yolenoyer"}, "edited": false, "score": 0, "creation_date": 1589097705, "post_id": 51983649, "comment_id": 109152957, "body": "This function does not work as expected; panic example: <code>get_utf8_slice(&quot;h&#233;llo&quot;, 2, 3)</code>. Replacing the last range <code>[start_pos..end_pos]</code> by <code>[start_pos..start_pos+end_pos]</code> fixes the issue."}], "tags": [], "owner": {"reputation": 5700, "user_id": 3131852, "user_type": "registered", "accept_rate": 100, "profile_image": "https://www.gravatar.com/avatar/26365707ecfa02e221f5192aaaa29a43?s=128&d=identicon&r=PG", "display_name": "Tim Diekmann", "link": "https://stackoverflow.com/users/3131852/tim-diekmann"}, "is_accepted": false, "score": 9, "last_activity_date": 1603366757, "last_edit_date": 1603366757, "creation_date": 1535020004, "answer_id": 51983649, "question_id": 51982999, "link": "https://stackoverflow.com/questions/51982999/slice-a-string-containing-unicode-chars/51983649#51983649", "title": "Slice a string containing Unicode chars", "body": "<p>A UTF-8 encoded string may contain characters which consists of multiple bytes. In your case, <code>\u043f</code> starts at index 6 (inclusive) and ends at position 8 (exclusive) so indexing 7 is not the start of the character. This is why your error occurred.</p>\n<p>You may use <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.char_indices\" rel=\"nofollow noreferrer\"><code>str::char_indices()</code></a> for solving this (remember, that getting to a position in a UTF-8 string is <code>O(n)</code>):</p>\n<pre><code>fn get_utf8_slice(string: &amp;str, start: usize, end: usize) -&gt; Option&lt;&amp;str&gt; {\n    assert!(end &gt;= start);\n    string.char_indices().nth(start).and_then(|(start_pos, _)| {\n        string[start_pos..]\n            .char_indices()\n            .nth(end - start - 1)\n            .map(|(end_pos, _)| &amp;string[start_pos..end_pos])\n    })\n}\n</code></pre>\n<p><a href=\"https://play.rust-lang.org/?gist=8615dce4ec8a36cc1220b79d2af7751f&amp;version=stable&amp;mode=debug&amp;edition=2015\" rel=\"nofollow noreferrer\">playground</a></p>\n<p>You may use <a href=\"https://doc.rust-lang.org/std/primitive.str.html#method.chars\" rel=\"nofollow noreferrer\"><code>str::chars()</code></a> if you are fine with getting a <code>String</code>:</p>\n<pre><code>let string: String = text.chars().take(end).skip(start).collect();\n</code></pre>\n"}, {"tags": [], "owner": {"reputation": 6962, "user_id": 3271687, "user_type": "registered", "accept_rate": 82, "profile_image": "https://www.gravatar.com/avatar/25c0a4cbbfdcc44075d2f8631ad353b9?s=128&d=identicon&r=PG&f=1", "display_name": "yolenoyer", "link": "https://stackoverflow.com/users/3271687/yolenoyer"}, "is_accepted": false, "score": 1, "last_activity_date": 1590231697, "last_edit_date": 1590231697, "creation_date": 1589110707, "answer_id": 61711340, "question_id": 51982999, "link": "https://stackoverflow.com/questions/51982999/slice-a-string-containing-unicode-chars/61711340#61711340", "title": "Slice a string containing Unicode chars", "body": "<p>Here is a function which retrieves a utf8 slice, with the following pros:</p>\n\n<ul>\n<li>handle all edge cases (empty input, 0-width output ranges, out-of-scope ranges);</li>\n<li>never panics;</li>\n<li>use start-inclusive, end-exclusive ranges.</li>\n</ul>\n\n<pre><code>pub fn utf8_slice(s: &amp;str, start: usize, end: usize) -&gt; Option&lt;&amp;str&gt; {\n    let mut iter = s.char_indices()\n        .map(|(pos, _)| pos)\n        .chain(Some(s.len()))\n        .skip(start)\n        .peekable();\n    let start_pos = *iter.peek()?;\n    for _ in start..end { iter.next(); }\n    Some(&amp;s[start_pos..*iter.peek()?])\n}\n</code></pre>\n"}], "owner": {"reputation": 884, "user_id": 7541374, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/4dd9cd55e47852725f6b6fd36fb9bc34?s=128&d=identicon&r=PG&f=1", "display_name": "Sasha Tsukanov", "link": "https://stackoverflow.com/users/7541374/sasha-tsukanov"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": true, "view_count": 4025, "favorite_count": 2, "accepted_answer_id": 51983601, "answer_count": 3, "score": 20, "last_activity_date": 1603366757, "creation_date": 1535017948, "last_edit_date": 1535051765, "question_id": 51982999, "link": "https://stackoverflow.com/questions/51982999/slice-a-string-containing-unicode-chars", "title": "Slice a string containing Unicode chars", "body": "<p>I have a piece of text with characters of different bytelength.</p>\n\n<pre><code>let text = \"Hello \u043f\u0440\u0438\u0432\u0435\u0442\";\n</code></pre>\n\n<p>I need to take a slice of the string given start (included) and end (excluded) character indices. I tried this</p>\n\n<pre><code>let slice = &amp;text[start..end];\n</code></pre>\n\n<p>and got the following error</p>\n\n<pre><code>thread 'main' panicked at 'byte index 7 is not a char boundary; it is inside '\u043f' (bytes 6..8) of `Hello \u043f\u0440\u0438\u0432\u0435\u0442`'\n</code></pre>\n\n<p>I suppose it happens since Cyrillic letters are multi-byte and the <code>[..]</code> notation takes chars using <em>byte</em> indices. What can I use if I want to slice using <em>character</em> indices, like I do in Python:</p>\n\n<p><code>slice = text[start:end]</code> ?</p>\n\n<p>I know I can use the <code>chars()</code> iterator and manually walk through the desired substring, but is there a more concise way?</p>\n"}, {"tags": ["json", "mongodb", "rust", "serde"], "comments": [{"owner": {"reputation": 16936, "user_id": 7076153, "user_type": "registered", "accept_rate": 50, "profile_image": "https://i.stack.imgur.com/erPUC.png?s=128&g=1", "display_name": "Stargateur", "link": "https://stackoverflow.com/users/7076153/stargateur"}, "edited": false, "score": 2, "creation_date": 1535022278, "post_id": 51982893, "comment_id": 90917911, "body": "<a href=\"https://docs.rs/bson/0.13.0/bson/\" rel=\"nofollow noreferrer\">docs.rs/bson/0.13.0/bson</a> I let you do the &quot;rest&quot; of the search."}, {"owner": {"reputation": 269539, "user_id": 155423, "user_type": "registered", "accept_rate": 90, "profile_image": "https://www.gravatar.com/avatar/419218774d04a581476ea1887a0921e0?s=128&d=identicon&r=PG", "display_name": "Shepmaster", "link": "https://stackoverflow.com/users/155423/shepmaster"}, "edited": false, "score": 2, "creation_date": 1535032753, "post_id": 51982893, "comment_id": 90924646, "body": "I believe that asking for ways to <i>improve your code</i> are <a href=\"https://codereview.meta.stackexchange.com/questions/5777/a-guide-to-code-review-for-stack-overflow-users\">better suited for Code Review</a>."}], "owner": {"reputation": 152, "user_id": 8656476, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/945b1c30e3fef71ac52c1748e94a8555?s=128&d=identicon&r=PG", "display_name": "Quirinux", "link": "https://stackoverflow.com/users/8656476/quirinux"}, "delete_vote_count": 0, "reopen_vote_count": 0, "close_vote_count": 0, "is_answered": false, "view_count": 1693, "favorite_count": 1, "answer_count": 0, "score": 0, "last_activity_date": 1535099426, "creation_date": 1535017633, "last_edit_date": 1535032634, "question_id": 51982893, "link": "https://stackoverflow.com/questions/51982893/is-there-a-better-way-to-directly-convert-a-rust-bson-document-to-json", "title": "Is there a better way to directly convert a Rust BSON document to JSON?", "body": "<p>The idea is getting a cursor from Mongo and serializing the result set to JSON in a string. I have working code:</p>\n\n<pre><code>extern crate bson;\nextern crate mongodb;\n\nuse mongodb::db::ThreadedDatabase;\nuse mongodb::{Client, ThreadedClient};\n\nextern crate serde;\nextern crate serde_json;\n\nfn main() {\n    let client =\n        Client::connect(\"localhost\", 27017).expect(\"Failed to initialize standalone client.\");\n\n    let coll = client.db(\"foo\").collection(\"bar\");\n\n    let cursor = coll.find(None, None).ok().expect(\"Failed to execute find.\");\n\n    let docs: Vec&lt;_&gt; = cursor.map(|doc| doc.unwrap()).collect();\n\n    let serialized = serde_json::to_string(&amp;docs).unwrap();\n\n    println!(\"{}\", serialized);\n}\n</code></pre>\n\n<p>Is there a better way to do this? If not I will close this thread.</p>\n"}]